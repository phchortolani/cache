<?xml version="1.0" encoding="iso-8859-1" ?>

<project name="cache" basedir="..">

<!-- Test if any cache configuration will be necessary. The depend tests at the begining of the
     configuration file makes sure that any change or update that happens causes the scritps
     to be deleted. This in turn causes the files to be generated and then run by the system. -->
<target name="verify-cache-scripts" depends="init" >
    <!-- Cache basic configuration -->
    <condition property="missing-cache-config">
        <not>
            <available file="${buildDir}/cache-config-script_win.s"/>
        </not>
    </condition>
    <condition property="missing-cache-config">
        <not>
            <available file="${buildDir}/cache-config-script_nix.s"/>
        </not>
    </condition>

    <!-- Source control exclude list -->
    <condition property="missing-cache-exclude-list">
        <not>
            <available file="${buildDir}/cache-exclude-list_win.s"/>
        </not>
    </condition>
    <condition property="missing-cache-exclude-list">
        <not>
            <available file="${buildDir}/cache-exclude-list_nix.s"/>
        </not>
    </condition>

    <!-- Indicates the some configuration will be needed -->
    <condition property="cache-config-necessary">
        <or>
            <isset property="missing-cache-config" />
            <isset property="missing-cache-exclude-list" />
        </or>
    </condition>
    <condition property="cache-config-necessary">
        <or>
            <isset property="missing-cache-config" />
            <isset property="missing-cache-exclude-list" />
        </or>
    </condition>
</target>
<echo>Configuring Cache globals...</echo>

<!-- Configure the user globals if the user-config file was updated (because the scritps needs its values) -->
<target name="configure-cache" depends="init,verify-cache-scripts" if="cache-config-necessary">
    <if>
        <isset property="missing-cache-config" />
        <then>
            <echo>Configuring Cache globals...</echo>

            <!-- Deletes the flag that the command executed until the end -->
            <delete file="${buildDir}/cache-config-script.ok"/>

            <property name="hookClassDir" value="${basedir}${file.separator}configuration${file.separator}hooks${file.separator}src-packages${file.separator}cls${file.separator}" />

            <!-- Replace all the tokens with the correct values and copy the script to de build directory-->
            <copy file="${templateDir}/cache-config-script_win.template" toFile="${buildDir}/cache-config-script_win.s" overwrite="yes">
                <filterset>
                    <filter token="buildOptionVAR" value="${buildOptionVAR}" />
                    <filter token="buildOptionASDE" value="${buildOptionASDE}" />
                    <filter token="commonLibDir" value="${commonLibDir}" />
                    <filter token="projectDir" value="${basedir}"/>
					<filter token="productIntersystems" value="${productIntersystems}"/>
                    <filter token="namespace" value="${namespace}"/>
                    <filter token="namespaceCapitalized" value="${namespaceCapitalized}"/>          
                    <filter token="bypassAuthentication" value="${bypassAuthentication}"/>
                    <filter token="cacheUsername" value="${cacheUsername}"/>
                    <filter token="cachePassword" value="${cachePassword}"/>
                    <filter token="cacheRemoteMappingUser" value="${cacheRemoteMappingUser}"/>
                    <filter token="cacheRemoteMappingPassword" value="${cacheRemoteMappingPassword}"/>
                    <filter token="cacheRemoteMappingDir1" value="${cacheRemoteMappingDir1}"/>
                    <filter token="cacheRemoteMappingDir2" value="${cacheRemoteMappingDir2}"/>
                    <filter token="cacheRemoteMappingUnit1" value="${cacheRemoteMappingUnit1}"/>
                    <filter token="cacheRemoteMappingUnit2" value="${cacheRemoteMappingUnit2}"/>
                    <filter token="cacheLog" value="${buildDir}/cache-config-script.log"/>
                    <filter token="cspDir" value="${cspDir}"/>
                    <filter token="databaseDir" value="${databaseDir}"/>
                    <filter token="reportsRemoteWebapp" value="${reportsRemoteWebapp}"/>
                    <filter token="reportsDir" value="${reportsDir}"/>
                    <filter token="reportsRemoteDir" value="${reportsRemoteDir}"/>
                    <filter token="reportsResourceUrlPrefix" value="${reportsResourceUrlPrefix}"/>
                    <filter token="resourcesDir" value="${resourcesDir}"/>
                    <filter token="resourcesURLPrefix" value="${resourcesURLPrefix}"/>
                    <filter token="tomcatInternalAddress" value="${tomcatInternalAddress}" />
                    <filter token="tomcatInternalPort" value="${tomcatInternalPort}" />
                    <filter token="tomcatExternalAddress" value="${tomcatExternalAddress}" />
                    <filter token="tomcatExternalPort" value="${tomcatExternalPort}" />
                    <filter token="hookClassDir" value="${hookClassDir}"/>
                    <filter token="onBeforeLoadActive" value="${onBeforeLoadActive}" />
                    <filter token="deleteTmpXMLFilesActive" value="${deleteTmpXMLFilesActive}" />
                    <filter token="grantAllObjectsToUser1" value="${grantAllObjectsToUser1}" />
                    <filter token="grantAllObjectsToUser2" value="${grantAllObjectsToUser2}" />
                    <filter token="runSourceLogging" value="${runSourceLogging}"/>
                </filterset>
            </copy>
			<if>
			    <equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<!-- Run the script:  C:\InterSystems\IRIS\Bin\iristerm.exe /console=cn_iptcp:10.85.2.146[23] script.s -->
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no" timeout="20000"
						resultproperty="res">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}${file.separator}cache-config-script_win.s"/>
					</exec>
				</then>
				<else>
					<!-- Run the script:  C:\InterSystems\Cache\Bin\cterm.exe /console=cn_iptcp:10.85.2.146[23] script.s -->
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no" timeout="20000"
						resultproperty="res">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}${file.separator}cache-config-script_win.s"/>
					</exec>
				</else>
			</if>


            <!-- Replace all the tokens with the correct values and copy the script to de build directory-->
            <copy file="${templateDir}/cache-config-script_nix.template" toFile="${buildDir}/cache-config-script_nix.s" overwrite="yes">
                <filterset>
                    <filter token="buildOptionVAR" value="${buildOptionVAR}" />
                    <filter token="buildOptionASDE" value="${buildOptionASDE}" />
                    <filter token="commonLibDir" value="${commonLibDir}" />
                    <filter token="projectDir" value="${basedir}"/>
                    <filter token="namespace" value="${namespace}"/>
                    <filter token="namespaceCapitalized" value="${namespaceCapitalized}"/>          
                    <filter token="bypassAuthentication" value="${bypassAuthentication}"/>
                    <filter token="cacheUsername" value="${cacheUsername}"/>
                    <filter token="cachePassword" value="${cachePassword}"/>
                    <filter token="cacheRemoteMappingUser" value="${cacheRemoteMappingUser}"/>
                    <filter token="cacheRemoteMappingPassword" value="${cacheRemoteMappingPassword}"/>
                    <filter token="cacheRemoteMappingDir1" value="${cacheRemoteMappingDir1}"/>
                    <filter token="cacheRemoteMappingDir2" value="${cacheRemoteMappingDir2}"/>
                    <filter token="cacheRemoteMappingUnit1" value="${cacheRemoteMappingUnit1}"/>
                    <filter token="cacheRemoteMappingUnit2" value="${cacheRemoteMappingUnit2}"/>
                    <filter token="cacheLog" value="${buildDir}/cache-config-script.log"/>
                    <filter token="cspDir" value="${cspDir}"/>
                    <filter token="databaseDir" value="${databaseDir}"/>
                    <filter token="reportsRemoteWebapp" value="${reportsRemoteWebapp}"/>
                    <filter token="reportsDir" value="${reportsDir}"/>
                    <filter token="reportsRemoteDir" value="${reportsRemoteDir}"/>
                    <filter token="reportsResourceUrlPrefix" value="${reportsResourceUrlPrefix}"/>
                    <filter token="resourcesDir" value="${resourcesDir}"/>
                    <filter token="resourcesURLPrefix" value="${resourcesURLPrefix}"/>
                    <filter token="tomcatInternalAddress" value="${tomcatInternalAddress}" />
                    <filter token="tomcatInternalPort" value="${tomcatInternalPort}" />
                    <filter token="tomcatExternalAddress" value="${tomcatExternalAddress}" />
                    <filter token="tomcatExternalPort" value="${tomcatExternalPort}" />
                    <filter token="hookClassDir" value="${hookClassDir}"/>
                    <filter token="onBeforeLoadActive" value="${onBeforeLoadActive}" />
                    <filter token="deleteTmpXMLFilesActive" value="${deleteTmpXMLFilesActive}" />
                    <filter token="grantAllObjectsToUser1" value="${grantAllObjectsToUser1}" />
                    <filter token="grantAllObjectsToUser2" value="${grantAllObjectsToUser2}" />
                    <filter token="runSourceLogging" value="${runSourceLogging}"/>
                </filterset>
            </copy>

			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-config-script.log" action="start"/>
					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<!-- Run the script: /opt/ensemble/bin/irissession ENSEMBLE < script.s | tee output.log -->
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-config-script_nix.s" osfamily="unix"
								failonerror="no" timeout="20000" resultproperty="res">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<!-- Run the script: /opt/ensemble/bin/csession ENSEMBLE < script.s | tee output.log -->
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-config-script_nix.s" osfamily="unix"
								failonerror="no" timeout="20000" resultproperty="res">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-config-script.log" action="stop"/>
				</then>
			</if>

            <!-- Verifies if it executed until the end -->
            <if>
                <not>
                    <available property="fileExists" file="${buildDir}/cache-config-script.ok" />
                </not>

                <then>
                    <!-- Let's erase the script so that it will be recreated in the next run -->
                    <delete file="${buildDir}/cache-config-script.s" />

                    <fail>
                        <if>
                            <isset property="userConfigUpdated" />
                            <then>
                                <echo></echo>
                                <echo>The user-config-properties template has been updated!</echo>
                                <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                                <echo>to check the user-config.properties</echo>
                            </then>
                        </if>
Cache configuration FAILED!
1) Please take a look at the file
${buildDir}/cache-config-script.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
                    </fail>
                </then>
            </if>
        </then>
    </if>

    <if>
        <isset property="missing-cache-exclude-list" />
        <then>
            <echo>Configuring SourceControl exclusion list...</echo>

            <!-- Deletes the flag that the command executed until the end -->
            <delete file="${buildDir}/cache-exclude-list.ok"/>

            <!-- Prepare the exclusion list as a script and put it in the build directory -->
            <copy file="${templateDir}/cache-exclude-list_win.template" toFile="${buildDir}/cache-exclude-list_win.s" overwrite="yes">
                <filterset>
                    <filter token="bypassAuthentication" value="${bypassAuthentication}"/>
                    <filter token="projectDir" value="${basedir}"/>
                    <filter token="namespace" value="${namespace}"/>
                    <filter token="namespaceCapitalized" value="${namespaceCapitalized}"/>          
                    <filter token="cacheUsername" value="${cacheUsername}"/>
                    <filter token="cachePassword" value="${cachePassword}"/>
                    <filter token="cacheLog" value="${buildDir}/cache-exclude-list.log"/>
                </filterset>
            </copy>

			<if>
			    <equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<!-- Run the script:  C:\InterSystems\Iris\Bin\iristerm.exe /console=cn_iptcp:10.85.2.146[23] script.s -->
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no" timeout="15000">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}${file.separator}cache-exclude-list_win.s"/>
					</exec>
				</then>
				<else>
					<!-- Run the script:  C:\InterSystems\Cache\Bin\cterm.exe /console=cn_iptcp:10.85.2.146[23] script.s -->
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no" timeout="15000">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}${file.separator}cache-exclude-list_win.s"/>
					</exec>
				</else>
			</if>


            <!-- Prepare the exclusion list as a script and put it in the build directory -->
            <copy file="${templateDir}/cache-exclude-list_nix.template" toFile="${buildDir}/cache-exclude-list_nix.s" overwrite="yes">
                <filterset>
                    <filter token="bypassAuthentication" value="${bypassAuthentication}"/>
                    <filter token="projectDir" value="${basedir}"/>
                    <filter token="namespace" value="${namespace}"/>
                    <filter token="namespaceCapitalized" value="${namespaceCapitalized}"/>          
                    <filter token="cacheUsername" value="${cacheUsername}"/>
                    <filter token="cachePassword" value="${cachePassword}"/>
                    <filter token="cacheLog" value="${buildDir}/cache-exclude-list.log"/>
                </filterset>
            </copy>

			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-exclude-list.log" action="start"/>

					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<!-- Run the script: /opt/ensemble/bin/irissession ENSEMBLE < script.s | tee output.log -->
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-exclude-list_nix.s" osfamily="unix"
								failonerror="no" timeout="15000">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<!-- Run the script: /opt/ensemble/bin/csession ENSEMBLE < script.s | tee output.log -->
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-exclude-list_nix.s" osfamily="unix"
								failonerror="no" timeout="15000">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-exclude-list.log" action="stop"/>
				</then>
			</if>

            <!-- Verifies if it executed until the end -->
            <if>
                <not>
                    <available property="fileExists" file="${buildDir}/cache-exclude-list.ok" />
                </not>

                <then>
                    <!-- Let's erase the script so that it will be recreated in the next run -->
                    <delete file="${buildDir}/cache-exclude-list.s" />

                    <fail>
                        <if>
                            <isset property="userConfigUpdated" />
                            <then>
                                <echo></echo>
                                <echo>The user-config-properties template has been updated!</echo>
                                <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                                <echo>to check the user-config.properties</echo>
                            </then>
                        </if>
Cache exclude-list definition FAILED!
1) Please take a look at the file
${buildDir}/cache-exclude-list.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
                    </fail>
                </then>
            </if>
        </then>
    </if>
</target>

<!-- Copy resources and csp files to the correct locations, import code into Cache and compile it. -->
<target name="deploy-cache" depends="configure-cache,verify-conflicts,verify-source-control">
    <!-- Copy resources (everything that is found there) to the final destination -->
    <copy todir="${resourcesDir}">
        <fileset dir="${basedir}/web/resources" defaultexcludes="false"/>
    </copy>

    <copy todir="${databaseDir}/util" overwrite="yes">
        <fileset dir="${basedir}/configuration/util" defaultexcludes="false"/>
    </copy>

    <!-- We should copy ONLY CSP files to the csp target directory, but currently are copying everything -->
    <copy todir="${cspDir}">
        <fileset dir="${basedir}/web/csp" defaultexcludes="false"/>
    </copy>

    <!-- Clears the log of changed files -->
    <delete file="${buildDir}/last-changes.log" quiet="true" />
    <echo>
Searching for modified files...
    </echo>

    <!-- Generates a list of all files that need to be loaded into Cache that were changed after lastchanges.log -->
    <for param="file">
        <path>
            <fileset dir="${basedir}/src" defaultexcludes="false">
                <include name="**/*.cls.xml"/>
                <include name="**/*.inc.xml"/>
                <include name="**/*.mac.xml"/>
                <include name="**/*.prj.xml"/>
                <exclude name= "cls/SourceControl.*.cls.xml"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/web/csp" defaultexcludes="false">
                <include name="**/*.csp"/>
                <include name="**/*.csr"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/globals/nm" defaultexcludes="false">
                <include name="**/*.nmclass"/>
                <include name="**/*.form"/>
                <include name="**/*.help"/>
                <include name="**/*.menu"/>
                <include name="**/*.languagetext"/>
                <include name="**/*.parameters"/>
                <include name="**/*.metadata"/>
                <include name="**/*.favorites" />
				<include name="**/*.mappa" />
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/globals/nm" defaultexcludes="false">
                <include name="**/*.nmcustomclass"/>
                <include name="**/*.customform"/>
                <include name="**/*.customfavorites"/>
                <include name="**/*.customparameters"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
        </path>

        <sequential>
            <echo>@{file}</echo>
            <echo file="${buildDir}/last-changes.log" append="true">
@{file}</echo>
        </sequential>
    </for>

    <!-- If lastchanges was created (before the following touch) we know that there is something
         to load in Cache. We then execute the script. -->
    <if>
        <available property="fileExists" file="${buildDir}/last-changes.log" />

        <then>
            <!-- Deletes the flag that the command executed until the end -->
            <delete file="${buildDir}/cache-update.ok"/>

            <!-- Let's keep some backups of the cache-update.log file, to help with debugging of the enviroment -->
            <if>
                <available file="${buildDir}/cache-update.3.log" property="log3" />
                <then>
                    <move file="${buildDir}/cache-update.3.log" tofile="${buildDir}/cache-update.4.log" overwrite="true"/>
                </then>
            </if>
            <if>
                <available file="${buildDir}/cache-update.2.log" property="log2" />
                <then>
                    <move file="${buildDir}/cache-update.2.log" tofile="${buildDir}/cache-update.3.log" overwrite="true"/>
                </then>
            </if>
            <if>
                <available file="${buildDir}/cache-update.1.log" property="log1" />
                <then>
                    <move file="${buildDir}/cache-update.1.log" tofile="${buildDir}/cache-update.2.log" overwrite="true"/>
                </then>
            </if>
            <if>
                <available file="${buildDir}/cache-update.log" property="log0" />
                <then>
                    <move file="${buildDir}/cache-update.log" tofile="${buildDir}/cache-update.1.log" overwrite="true"/>
                </then>
            </if>

            <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update_win.s" append="false"><![CDATA[
; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;
logfile: ${buildDir}/cache-update.log
timer 600
on error: $ERROR
${bypassAuthentication}

multiwait for: =Username:=Usuário:
send: ${cacheUsername}<CR>

multiwait for: =Password:=Senha:
send: ${cachePassword}<CR>

; Begin script
$BEGIN:

wait for: >
send: zn "${namespaceCapitalized}"<CR>

wait for: ${namespaceCapitalized}>
send: if (##class(%Dictionary.ClassDefinition).%ExistsId("VAR.infra.services.SecondaryServicesMonitor")) do ##class(VAR.infra.services.SecondaryServicesMonitor).StopService()<CR>

wait for: ${namespaceCapitalized}>
send: if (##class(%Dictionary.ClassDefinition).%ExistsId("VAR.infra.services.PrimaryServicesMonitor")) do ##class(VAR.infra.services.PrimaryServicesMonitor).StopService()<CR>

wait for: ${namespaceCapitalized}>
send: xecute "do Stop^COMSchedule()"<CR>

wait for: ${namespaceCapitalized}>
send: do ##class(SourceControl.Importer).JobImportAll("${buildDir}${file.separator}last-changes.log","${buildDir}${file.separator}cache-update.ok")<CR>

$END:
wait for: Importing process finished
wait for: ${namespaceCapitalized}>
; If we use "closelog", the systems LOSES the last part of the log
;closelog
; Wait for the log to flush
pause: 30

send: <CR>
terminate
goto $END2

$ERROR:
send: write "An error occured during import process. Please check the log file.",!<CR>
goto $END

$END2:
]]></echo>
        
            <!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
            <echo>Loading all modified files in Cache... (see ${buildDir}/cache-update.log )</echo>
            <echo>(see ${buildDir}/cache-update.log)</echo>
            <!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
			<if>
			    <equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-update_win.s"/>
					</exec>
				</then>
				<else>
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-update_win.s"/>
					</exec>
				</else>
			</if>

            <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update_nix.s" append="false"><![CDATA[${cacheUsername}
${cachePassword}

; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;

; Begin script
zn "${namespaceCapitalized}"

if (##class(%Dictionary.ClassDefinition).%ExistsId("VAR.infra.services.SecondaryServicesMonitor")) do ##class(VAR.infra.services.SecondaryServicesMonitor).StopService()
if (##class(%Dictionary.ClassDefinition).%ExistsId("VAR.infra.services.PrimaryServicesMonitor")) do ##class(VAR.infra.services.PrimaryServicesMonitor).StopService()
xecute "do Stop^COMSchedule()"

do ##class(SourceControl.Importer).JobImportAll("${buildDir}${file.separator}last-changes.log","${buildDir}${file.separator}cache-update.ok")

halt
]]></echo>
        
			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-update.log" action="start"/>

					<!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
					<echo>Loading all modified files in Cache... (see ${buildDir}/cache-update.log )</echo>
					<echo>(see ${buildDir}/cache-update.log)</echo>
					<!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-update_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-update_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-update.log" action="stop"/>
				</then>
			</if>

    <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update-pos_win.s" append="false"><![CDATA[
; This script is automatically generated.
; This script starts all services in Cache.
;
;History:
;2011-Ago-01    Pablo  Created
;
logfile: ${buildDir}/cache-update-pos.log
timer 600
on error: $ERROR
${bypassAuthentication}

multiwait for: =Username:=Usuário:
send: ${cacheUsername}<CR>

multiwait for: =Password:=Senha:
send: ${cachePassword}<CR>

; Begin script
$BEGIN:

wait for: >
send: zn "${namespaceCapitalized}"<CR>

wait for: ${namespaceCapitalized}>
send: xecute "do Start^COMSchedule"<CR>

wait for: ${namespaceCapitalized}>
send: if ($length("${grantAllObjectsToUser1}") '= 0) do ##class(VAR.infra.cache.SQL).GrantOnAllTables("${namespaceCapitalized}", "${grantAllObjectsToUser1}", 1, 1, 1, 1, 1)<CR>

wait for: ${namespaceCapitalized}>
send: if ($length("${grantAllObjectsToUser2}") '= 0) do ##class(VAR.infra.cache.SQL).GrantOnAllTables("${namespaceCapitalized}", "${grantAllObjectsToUser2}", 1, 1, 1, 1, 1)<CR>

$END:
wait for: ${namespaceCapitalized}>
; If we use "closelog", the systems LOSES the last part of the log
;closelog
; Wait for the log to flush
pause: 30

send: <CR>
terminate
goto $END2

$ERROR:
send: write "An error occured during service starting. Please check the log file.",!<CR>
goto $END
 
$END2:
]]></echo>
        
            <!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
            <echo>Starting all services in Cache... (see ${buildDir}/cache-update-pos.log )</echo>
            <echo>(see ${buildDir}/cache-update-pos.log)</echo>
            <!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
			<if>
			    <equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-update-pos_win.s"/>
					</exec>
				</then>
				<else>
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-update-pos_win.s"/>
					</exec>
				</else>
			</if>

    <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update-pos_nix.s" append="false"><![CDATA[${cacheUsername}
${cachePassword}

; This script is automatically generated.
; This script starts all services in Cache.
;
;History:
;2011-Ago-01    Pablo  Created
;

; Begin script
zn "${namespaceCapitalized}"

xecute "do Start^COMSchedule"

if ($length("${grantAllObjectsToUser1}") '= 0) do ##class(VAR.infra.cache.SQL).GrantOnAllTables("${namespaceCapitalized}", "${grantAllObjectsToUser1}", 1, 1, 1, 1, 1)
if ($length("${grantAllObjectsToUser2}") '= 0) do ##class(VAR.infra.cache.SQL).GrantOnAllTables("${namespaceCapitalized}", "${grantAllObjectsToUser2}", 1, 1, 1, 1, 1)

halt
]]></echo>
        
			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-update-pos.log" action="start"/>

					<!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
					<echo>Starting all services files in Cache... (see ${buildDir}/cache-update-pos.log )</echo>
					<echo>(see ${buildDir}/cache-update-pos.log)</echo>
					<!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-update-pos_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-update-pos_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-update-pos.log" action="stop"/>
				</then>
			</if>

            <!-- Verifies if it executed until the end -->
            <if>
                <not>
                    <available property="fileExists" file="${buildDir}/cache-update.ok" />
                </not>

                <then>
                    <fail>
                        <if>
                            <isset property="userConfigUpdated" />
                            <then>
                                <echo></echo>
                                <echo>The user-config-properties template has been updated!</echo>
                                <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                                <echo>to check the user-config.properties</echo>
                            </then>
                        </if>
Cache update FAILED!
1) Please take a look at the file
${buildDir}/cache-update.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
4) Check that all other *.ok files are there in the
${buildDir}
                    </fail>
                </then>
            </if>
        </then>

        <else>
            <echo>No new or modified mac, inc, cls, mappa files or @nm artifacts found to load in Cache</echo>
        </else>
    </if>

    <exec dir="${binDir}" executable="${touchExecName}" resolveexecutable="${isWindows}" failonerror="yes">
        <arg line="${buildDir}/last-updated.log"/>
    </exec>


    <!-- Updating version -->
    <echo>
Updating version...
    </echo>

    <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update-version_win.s" append="false"><![CDATA[
; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;
logfile: ${buildDir}/cache-update-version.log
timer 600
on error: $ERROR
${bypassAuthentication}

multiwait for: =Username:=Usuário:
send: ${cacheUsername}<CR>

multiwait for: =Password:=Senha:
send: ${cachePassword}<CR>

; Begin script
$BEGIN:

wait for: >
send: zn "${namespaceCapitalized}"<CR>

wait for: ${namespaceCapitalized}>
send: do ##class(SourceControl.Importer).UpdateVersion("${buildDir}${file.separator}cache-update-version.ok")<CR>

$END:
wait for: Update process finished
wait for: ${namespaceCapitalized}>
; If we use "closelog", the systems LOSES the last part of the log
;closelog
; Wait for the log to flush
pause: 30

send: <CR>
terminate
goto $END2

$ERROR:
send: write "An error occured during configuration. Please check the log file.",!<CR>
goto $END

$END2:
]]></echo>

    <!-- Now we use Cache Terminal to run the script -->
	<echo>Updating version in Cache... (see ${buildDir}/cache-update-version.log )</echo>
	<echo>(see ${buildDir}/cache-update-version.log)</echo>
	<if>
		<equals arg1="${productIntersystems}" arg2="IRIS"/>
		<then>
			<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no">
				<arg value="/console=cn_iptcp:${terminalURL}"/>
				<arg value="${buildDir}/cache-update-version_win.s"/>
			</exec>
		</then>
		<else>
			<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no">
				<arg value="/console=cn_iptcp:${terminalURL}"/>
				<arg value="${buildDir}/cache-update-version_win.s"/>
			</exec>
		</else>
	</if>
    
    <if>
        <isset property="userConfigUpdated" />
        <then>
            <echo></echo>
            <echo>The user-config-properties template has been updated!</echo>
            <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
            <echo>to check the user-config.properties</echo>
        </then>
    </if>
    
    <!-- Prepare an update script. Don't change this identation! -->
<echo file="${buildDir}/cache-update-version_nix.s" append="false"><![CDATA[${cacheUsername}
${cachePassword}

; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;

; Begin script
zn "${namespaceCapitalized}"

do ##class(SourceControl.Importer).UpdateVersion("${buildDir}${file.separator}cache-update-version.ok")

halt
]]></echo>
        
	<if>
		<os family="unix"/>
		<then>
			<record name="${buildDir}/cache-update-version.log" action="start"/>

			<!-- Now we use Cache Terminal to run the script -->
			<echo>Updating version in Cache... (see ${buildDir}/cache-update-version.log )</echo>
			<echo>(see ${buildDir}/cache-update-version.log)</echo>
			<if>
				<equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<exec executable="${cacheDir}/bin/irissession"
						input="${buildDir}/cache-update-version_nix.s" osfamily="unix" failonerror="no">
						<arg value="${instanceName}"/>
					</exec>
				</then>
				<else>
					<exec executable="${cacheDir}/bin/csession"
						input="${buildDir}/cache-update-version_nix.s" osfamily="unix" failonerror="no">
						<arg value="${instanceName}"/>
					</exec>
				</else>
			</if>
            <if>
                <isset property="userConfigUpdated" />
                <then>
                    <echo></echo>
                    <echo>The user-config-properties template has been updated!</echo>
                    <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                    <echo>to check the user-config.properties</echo>
                </then>
             </if>
             
			<record name="${buildDir}/cache-update-version.log" action="stop"/>
		</then>
	</if>

	<!-- Verifies if it executed until the end -->
	<if>
		<not>
			<available property="fileExists" file="${buildDir}/cache-update-version.ok" />
		</not>

		<then>
			<fail>
                <if>
                    <isset property="userConfigUpdated" />
                    <then>
                        <echo></echo>
                        <echo>The user-config-properties template has been updated!</echo>
                        <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                        <echo>to check the user-config.properties</echo>
                    </then>
                </if>
Cache update FAILED!
1) Please take a look at the file
${buildDir}/cache-update-version.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
4) Check that all other *.ok files are there in the
${buildDir}
			</fail>
		</then>
	</if>
</target>   

<!-- Copy resources and csp files to the correct locations, import code into Cache and compile it. -->
<target name="compare-cache" depends="configure-cache">
    <echo>
Searching for modified files...
    </echo>

    <delete file="${buildDir}/last-changes-compare.log"/>

    <!-- Generates a list of all files that need to be loaded into Cache that were changed after
         last-changes-compare.log.log -->
    <for param="file">
        <path>
            <fileset dir="${basedir}/src" defaultexcludes="false">
                <include name="**/*.cls.xml"/>
                <include name="**/*.inc.xml"/>
                <include name="**/*.mac.xml"/>
                <include name="**/*.prj.xml"/>
                <exclude name= "cls/SourceControl.*.cls.xml"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/web/csp" defaultexcludes="false">
                <include name="**/*.csp"/>
                <include name="**/*.csr"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/globals/nm" defaultexcludes="false">
                <include name="**/*.nmclass"/>
                <include name="**/*.form"/>
                <include name="**/*.help"/>
                <include name="**/*.menu"/>
                <include name="**/*.languagetext"/>
                <include name="**/*.parameters"/>
                <include name="**/*.metadata"/>
                <include name="**/*.favorites" />
				<include name="**/*.mappa" />
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
            <fileset dir="${basedir}/globals/nm" defaultexcludes="false">
                <include name="**/*.nmcustomclass"/>
                <include name="**/*.customform"/>
                <include name="**/*.customfavorites"/>
                <include name="**/*.customparameters"/>
                <depend targetdir="${buildDir}">
                    <mapper type="merge" to="last-updated.log"/>
                </depend>
            </fileset>
        </path>

        <sequential>
            <echo>@{file}</echo>
            <echo file="${buildDir}/last-changes-compare.log" append="true">
@{file}</echo>
        </sequential>
    </for>

    <!-- If last-changes-compare was created (before the following touch) we know that there
         is something to compare in Cache. We then execute the script. -->
    <if>
        <available property="fileExists" file="${buildDir}/last-changes-compare.log" />

        <then>
            <!-- Deletes the flag that the command executed until the end -->
            <delete file="${buildDir}/cache-compare.ok"/>
    
            <!-- Let's keep some backups of the cache-compare.log file, to help with debugging of the enviroment -->
            <if>
                <available file="${buildDir}/cache-compare.log" property="log0" />
                <then>
                    <move file="${buildDir}/cache-compare.log" tofile="${buildDir}/cache-compare.1.log" overwrite="true"/>
                </then>
            </if>

    <!-- Prepare an compare script. Don't change this identation! -->
<echo file="${buildDir}/cache-compare_win.s" append="false"><![CDATA[
; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;
logfile: ${buildDir}/cache-compare.log
timer 600
on error: $ERROR
${bypassAuthentication}

multiwait for: =Username:=Usuário:
send: ${cacheUsername}<CR>

multiwait for: =Password:=Senha:
send: ${cachePassword}<CR>

; Begin script
$BEGIN:

wait for: >
send: zn "${namespaceCapitalized}"<CR>

wait for: ${namespaceCapitalized}>
send: do ##class(SourceControl.Importer).JobCompareAll("${buildDir}${file.separator}last-changes-compare.log","${buildDir}${file.separator}cache-compare.ok")<CR>

$END:
wait for: Comparing process finished
wait for: ${namespaceCapitalized}>
; If we use "closelog", the systems LOSES the last part of the log
;closelog
; Wait for the log to flush
pause: 30

send: <CR>
terminate
goto $END2

$ERROR:
send: w "An error occured during configuration. Please check the log file.",!<CR>
goto $END

$END2:
]]></echo>

            <!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
            <echo>Loading all modified files in Cache... (see ${buildDir}/cache-compare.log )</echo>
            <echo>(see ${buildDir}/cache-compare.log)</echo>
            <!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
			<if>
				<equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-compare_win.s"/>
					</exec>
				</then>
				<else>
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-compare_win.s"/>
					</exec>
				</else>
			</if>

    <!-- Prepare an compare script. Don't change this identation! -->
<echo file="${buildDir}/cache-compare_nix.s" append="false"><![CDATA[${cacheUsername}
${cachePassword}

; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2008-Jul-07    Soeiro  Created
;

; Begin script
zn "${namespaceCapitalized}"

do ##class(SourceControl.Importer).JobCompareAll("${buildDir}${file.separator}last-changes-compare.log","${buildDir}${file.separator}cache-compare.ok")

halt
]]></echo>

			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-compare.log" action="start"/>

					<!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
					<echo>Loading all modified files in Cache... (see ${buildDir}/cache-compare.log )</echo>
					<echo>(see ${buildDir}/cache-compare.log)</echo>
					<!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-compare_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-compare_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-compare.log" action="stop"/>
				</then>
			</if>

            <!-- Verifies if it executed until the end -->
            <if>
                <not>
                    <available property="fileExists" file="${buildDir}/cache-compare.ok" />
                </not>

                <then>
                    <fail>
                        <if>
                            <isset property="userConfigUpdated" />
                            <then>
                                <echo></echo>
                                <echo>The user-config-properties template has been updated!</echo>
                                <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                                <echo>to check the user-config.properties</echo>
                            </then>
                        </if>
Cache compare FAILED!
1) Please take a look at the file
${buildDir}/cache-compare.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
4) Check that all other *.ok files are there in the
${buildDir}
                    </fail>
                </then>
                <else>
                    <loadfile property="compare-output" srcFile="${buildDir}/cache-compare-output.txt"/>
                    <echo>${compare-output}</echo> 
                </else>
            </if>
        </then>

        <else>
            <echo>No new or modified mac, inc, cls, mappa files or @nm artifacts found to load in Caché</echo>
        </else>
    </if>
</target>  

<!-- Export all cache source files. -->
<target name="export-cache" depends="configure-cache">
    <echo>
Exporting source files...
    </echo>
    <!-- Clean ok file-->
    <delete file="${buildDir}/cache-export.ok"/>

    <!-- Prepare an export script. Don't change this identation! -->
    <!-- for windows and linux (selective run) -->
<echo file="${buildDir}/cache-export_win.s" append="false"><![CDATA[
; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2010-Oct-26    Jorge  Created
;
logfile: ${buildDir}/cache-export.log
timer 600
on error: $ERROR
${bypassAuthentication}

multiwait for: =Username:=Usuário:
send: ${cacheUsername}<CR>

multiwait for: =Password:=Senha:
send: ${cachePassword}<CR>

; Begin script
$BEGIN:

wait for: >
send: zn "${namespaceCapitalized}"<CR>

wait for: ${namespaceCapitalized}>
send: do ##class(SourceControl.Exporter).ExportAllSource("${buildDir}${file.separator}cache-export.ok")<CR>

$END:
wait for: ${namespaceCapitalized}>
; If we use "closelog", the systems LOSES the last part of the log
;closelog
; Wait for the log to flush
pause: 30

send: <CR>
terminate
goto $END2

$ERROR:
send: write "An error occured during configuration. Please check the log file.",!<CR>
goto $END

$END2:
]]></echo>

            <!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
            <echo>Loading all modified files in Cache... (see ${buildDir}/cache-export.log )</echo>
            <echo>(see ${buildDir}/cache-export.log)</echo>
            <!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
			<if>
				<equals arg1="${productIntersystems}" arg2="IRIS"/>
				<then>
					<exec executable="${cacheDir}/bin/iristerm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-export_win.s"/>
					</exec>
				</then>
				<else>
					<exec executable="${cacheDir}/bin/cterm.exe" osfamily="windows" failonerror="no">
						<arg value="/console=cn_iptcp:${terminalURL}"/>
						<arg value="${buildDir}/cache-export_win.s"/>
					</exec>
				</else>
			</if>

    <!-- Prepare an export script. Don't change this identation! -->
<echo file="${buildDir}/cache-export_nix.s" append="false"><![CDATA[${cacheUsername}
${cachePassword}

; This script is automatically generated.
; This script loads all modified artifacts into Cache.
;
;History:
;2010-Oct-26    Jorge  Created
;

; Begin script
zn "${namespaceCapitalized}"

do ##class(SourceControl.Exporter).ExportAllSource("${buildDir}${file.separator}cache-export.ok")<CR>

halt
]]></echo>

			<if>
                <os family="unix"/>
				<then>
                    <record name="${buildDir}/cache-export.log" action="start"/>

					<!-- Now we use Cache Terminal to run the script (timeout is set to 1 hour) -->
					<echo>Loading all modified files in Cache... (see ${buildDir}/cache-export.log )</echo>
					<echo>(see ${buildDir}/cache-export.log)</echo>
					<!-- Twelve-hour timeout 12*60*60*1000 miliseconds timeout="43200000" -->
					<if>
						<equals arg1="${productIntersystems}" arg2="IRIS"/>
						<then>
							<exec executable="${cacheDir}/bin/irissession"
								input="${buildDir}/cache-export_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</then>
						<else>
							<exec executable="${cacheDir}/bin/csession"
								input="${buildDir}/cache-export_nix.s" osfamily="unix" failonerror="no">
								<arg value="${instanceName}"/>
							</exec>
						</else>
					</if>

					<record name="${buildDir}/cache-export.log" action="stop"/>
				</then>
			</if>

            <!-- Verifies if it executed until the end -->
            <if>
                <not>
                    <available property="fileExists" file="${buildDir}/cache-export.ok" />
                </not>

                <then>
                    <fail>
                        <if>
                            <isset property="userConfigUpdated" />
                            <then>
                                <echo></echo>
                                <echo>The user-config-properties template has been updated!</echo>
                                <echo>The system tried to automatically copy your previous, but is highly recomended</echo>
                                <echo>to check the user-config.properties</echo>
                            </then>
                        </if>
Cache export FAILED!
1) Please take a look at the file
${buildDir}/cache-export.log for any clues;
2) Check that the username and password are correct;
3) Check that the Cache license IS INSTALLED;
4) Check that all other *.ok files are there in the
${buildDir}
                    </fail>
                </then>
            </if>
</target>  

</project>
