<!DOCTYPE html> 
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
	<script language="Cache" runat="server">
		do ^WWWVAR

		set YUSER 		= $get(%request.Data("YUSER", 1))
		set YBED 			= $get(%request.Data("YBED", 1))
		set YM 				= $get(%request.Data("YM", 1))
		set YLOCATION = $get(%request.Data("YLOCATION", 1))

		set PortCache = $get(%request.CgiEnvs("SERVER_PORT"))
		set PageURL 	= $get(%request.CgiEnvs("CACHE_URL")) 
		set PageName 	= %request.PageName
		set app 			= %request.Application
		set host 			= %request.CgiEnvs("HTTP_HOST")
		set url				= "http://"_host_app

		set URLPreparacao = "VAR.CSP.VARCadastroSalas.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"
		set URLSearch			= "User.Search.PesquisasJson.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"
		set URLLogin 			= "COMLogin.cls"
		set URLLink 			= "www.cls"

		set nomeLocal 		= YLOCATION_" - "_$$SQLGetLocationName^VARSQL(YLOCATION)

		//Verifica se a sessão
		set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
		Do ##Class(VAR.CSP.VARConfiguracaoAgendamento).InicializaConfiguracao(YBED)
		Set objRetorno = ##Class(VAR.CSP.VARConfiguracaoAgendamento).GetIntegracaoSistema()

		Set (flagIntEstoque, flagIntPEP)	= 0
		If (objRetorno.intSistEstoque = 1) Set flagIntEstoque = 1
		If (objRetorno.intSistPEPMedico = 1 || (objRetorno.intSistPEPEnfermagem = 1)) Set flagIntPEP = 1

	</script>
	<style>
	.selected-container {
		padding: 20px;
		margin-left: 20px;
		background-color: rgba(191, 191, 191, 0.15);
		font-size: 115%;
		font-weight: bold;
	}
  .first-group {
		background-color: #ffffff;
  }
  .second-group{
		padding-top: 0px !important;
		padding-bottom: 0px !important;
		padding-left: 0px !important;
		padding-right: 0px !important;
		margin-top: 3px !important;
		margin-bottom: 3px !important;
		margin-left: 3px !important;
		margin-right: 0px !important;
		background-color: rgba(1, 178, 169, 0.15);
		border-top-right-radius: 5px;
		border-top-left-radius: 5px;
		border-top: 1px solid #E0E0E0;
		border-left: 1px solid #E0E0E0;
		border-right: 1px solid #E0E0E0;
		border-bottom: 1px solid #E0E0E0;
  }
  .third-group{
		padding-top: 0px !important;
		padding-bottom: 0px !important;
		padding-left: 0px !important;
		padding-right: 0px !important;
		margin-top: 0px !important;
		margin-bottom: 0px !important;
		margin-left: 0px !important;
		margin-right: 0px !important;
		background-color: #ffffff;
		border: 0px solid #E0E0E0;
  }
  .second-group .dx-form-group-caption {
		border: 0px solid red;
		margin-left: 3px !important;
		padding-top: 3px !important;
  }	
  .second-group .dx-form-group-content {
		background-color: #ffffff;
		color: red; 
		padding-left: 5px !important;
		padding-right: 5px !important;
  }	
	</style>
		<head>

		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Cadastro de Salas de Atendimento/Coleta</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">
		<!-- Font Awesome -->
		<link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

		<!-- Custom Elements -->
		<link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
		<link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
		<link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />

		<!-- Fonts Padrão IPP -->
		<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800">

		<!-- DevExtreme themes -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.common.css" />
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.light.compact.css" />
		<!--<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.light.compact.css" />-->

		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/themes/css/alphalinc.css" id="style_color" />

	</head>
	<script type="text/javascript">

		var status = '#(status)#';
		var URLLogin = '#(URLLogin)#';
		var ygif = '#(YGIF)#'

		if (status == 0) {
			alert('Usuário não está logado ou a sessão expirou.')
			window.location.replace(URLLogin)
		}

	</script>

	<body>
		<div id="toolbar"></div>
		<div id="divForm"></div>
		<div id="divAddLeito"></div>
		<div id="divLocalConsumo"></div>
		<!-- REQUIRED JS SCRIPTS -->
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src=" #(YGIF)#global/plugins/extreme19.2.4/js/jquery.min.js"></script>

		<!-- JSZip library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/jszip.min.js"></script>

		<!-- A DevExtreme library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/dx.all.js"></script>

		<!-- DevExtreme-Intl module -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/localization/dx.messages.pt.js"></script>

		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/exceljs.min.js"></script>
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/FileSaver.min.js"></script>

		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>

		<!-- Tag para implantação da funcionalidade de importação de Arquivos --> 
		<VARImportacaoArquivo>

		<!--Definições globais e criação de funcionalidades encapsuladas-->
		<script type="text/javascript">
			//Deixando variáveis disponíveis no cliente
			var urlPreparacao = '#(URLPreparacao)#';
			var urlSearch			= '#(URLSearch)#';
			var urlLink 			= '#(URLLink)#';
			var YBED 					= '#(YBED)#';
			var YUSER 				= '#(YUSER)#';
			var YLOCATION 		= '#(YLOCATION)#';
			var nomeLocal 		= '#(nomeLocal)#';
			var flagIntEstoque= #(flagIntEstoque)#;
			var flagIntPEP		= #(flagIntPEP)#;
			var codSala 			= "";
			var codUnidade		= "";
			var codLeito			= "";
			var codLocal			= "";
			dados 						= "";

			DevExpress.config({decimalSeparator: ",",thousandsSeparator: "."});
			DevExpress.localization.locale("pt");

			objToolBar = $("#toolbar").dxToolbar({
				items: [{
					location: "after",
					widget: "dxButton",
					options: {
						icon: "save",
						hint: "Salvar os Dados",
						type: "success",
						stylingMode: "contained",
						onClick: function () {
							idSala = codSala.option("value")
							if (!idSala) idSala = ""
							var flagForm = formulario.validate().isValid;
							var flagGeral = formGeral.validate().isValid;
							if (!flagForm || !flagGeral) {
								DevExpress.ui.notify("Favor preencher os campos obrigatórios", "warning");
								return;
							}
							if (formGeral.getEditor("utilizarHorarioUnidade").option("value") == 0) {
								var pSegundaSextaInicial = formGeral.getEditor("segundaSextaInicial").option("text");
								var pSegundaSextaFinal = formGeral.getEditor("segundaSextaFinal").option("text");
								var pFuncionaSabados = formGeral.getEditor("funcionaSabados").option("value");
								var pFuncionaSabadosInicial = formGeral.getEditor("funcionaSabadosInicial").option("text");
								var pFuncionaSabadosFinal = formGeral.getEditor("funcionaSabadosFinal").option("text");
								var pFuncionaDomingos = formGeral.getEditor("funcionaDomingos").option("value");
								var pFuncionaDomingosInicial = formGeral.getEditor("funcionaDomingosInicial").option("text");
								var pFuncionaDomingosFinal = formGeral.getEditor("funcionaDomingosFinal").option("text");
								if (pFuncionaSabados) {
									if (pFuncionaSabadosInicial == "" || pFuncionaSabadosFinal == "") {
										DevExpress.ui.notify("Favor preencher os campos de horário de funcionamento aos sábados.", "warning");
										return;
									}
								}
								if (pFuncionaDomingos) {
									if (pFuncionaDomingosInicial == "" || pFuncionaDomingosFinal == "") {
										DevExpress.ui.notify("Favor preencher os campos de horário de funcionamento aos domingos.", "warning");
										return;
									}
								}
								$.get(urlPreparacao, {
									method: "ValidarHorario",
									pUnidade: formGeral.getEditor("Unidade").option("value"),
									pSala: idSala,
									pTipo: "S",	
									pSegundaSextaInicial: pSegundaSextaInicial,
									pSegundaSextaFinal: pSegundaSextaFinal,
									pFuncionaSabados: pFuncionaSabados,
									pFuncionaSabadosInicial: pFuncionaSabadosInicial,
									pFuncionaSabadosFinal: pFuncionaSabadosFinal,
									pFuncionaDomingos: pFuncionaDomingos,
									pFuncionaDomingosInicial: pFuncionaDomingosInicial,
									pFuncionaDomingosFinal: pFuncionaDomingosFinal,
									YBED: YBED
								},function(status){
									if (status != 1) {
										DevExpress.ui.notify(status, "warning");
									}else{
										$.getJSON(urlPreparacao, {
											method: "SalvarDados",
											chave: idSala,
											pSituacao: "", //formulario.getEditor("Situacao").option("value"),
											dados: JSON.stringify(formGeral.option("formData")),
											pSegundaSextaInicial: pSegundaSextaInicial,
											pSegundaSextaFinal: pSegundaSextaFinal,
											pFuncionaSabados: pFuncionaSabados,
											pFuncionaSabadosInicial: pFuncionaSabadosInicial,
											pFuncionaSabadosFinal: pFuncionaSabadosFinal,
											pFuncionaDomingos: pFuncionaDomingos,
											pFuncionaDomingosInicial: pFuncionaDomingosInicial,
											pFuncionaDomingosFinal: pFuncionaDomingosFinal,
											YBED: YBED
										}, function (retorno) {
											if (retorno.status == 1) {
												dataSourceSalas.reload()
												codSala.option("value", retorno.codigo)
												DevExpress.ui.notify("Dados Salvos com Sucesso!", "success");
											} else {
												DevExpress.ui.notify("Erro: " + retorno.status, "error");
											}
										});
									}
								});
							}else{
								var pSegundaSextaInicial = "";
								var pSegundaSextaFinal = "";
								var pFuncionaSabados = 0;
								var pFuncionaSabadosInicial = "";
								var pFuncionaSabadosFinal = "";
								var pFuncionaDomingos = 0;
								var pFuncionaDomingosInicial = "";
								var pFuncionaDomingosFinal = "";
								$.getJSON(urlPreparacao, {
									method: "SalvarDados",
									chave: idSala,
									pSituacao: "", //formulario.getEditor("Situacao").option("value"),
									dados: JSON.stringify(formGeral.option("formData")),
									pSegundaSextaInicial: pSegundaSextaInicial,
									pSegundaSextaFinal: pSegundaSextaFinal,
									pFuncionaSabados: pFuncionaSabados,
									pFuncionaSabadosInicial: pFuncionaSabadosInicial,
									pFuncionaSabadosFinal: pFuncionaSabadosFinal,
									pFuncionaDomingos: pFuncionaDomingos,
									pFuncionaDomingosInicial: pFuncionaDomingosInicial,
									pFuncionaDomingosFinal: pFuncionaDomingosFinal,
									YBED: YBED
								}, function (retorno) {
									if (retorno.status == 1) {
										dataSourceSalas.reload()
										codSala.option("value", retorno.codigo)
										DevExpress.ui.notify("Dados Salvos com Sucesso!", "success");
									} else {
										DevExpress.ui.notify("Erro: " + retorno.status, "error");
									}
								});
							}
						}
					}
				},{
					location: "after",
					widget	: "dxButton",
					options	: {
						icon	: "fas fa-file-import",
						hint	: "Importar Cadastro de Salas de Atendimento/Coleta",
						type	: "default",
						stylingMode : "contained",
						onClick	: function(){
							importarArquivo('023', "dataSourceSalas.reload();");
						}
					}
				},{
					location: "after",
					widget: "dxButton",
					options: {
						icon: "fa fa-eraser",
						hint: "Limpar os Campos",
						type: "default",
						stylingMode: "contained",
						onClick: function () {
							codSala.option("value", "");
						}
					}
				}]
			}).dxToolbar("instance")

			formulario = $("#divForm").dxForm({
				activeStateEnabled: true,
				minColWidth: 50,
				screenByWidth: function (width) { return "lg"; },
				screenByWidth: function (width) { return "lg"; },
				height: function () { return window.innerHeight - 110 },
				alignItemLabels: false,
				alignItemLabelsInAllGroups: false,
				formData: dados,
				items: [{
					colCount: 10,
					itemType: "group",
					cssClass: "first-group",
					items: [{
						colSpan: 7,
						dataField: "Sala",
						editorOptions: {
							width: "80%"
						},
						template: function (data, itemElement) {
							itemElement.append("<div id='codSala'>")
						}
					}, {colSpan: 2},{
						colSpan: 2,
						dataField: "Situacao",
						visible: false,
						label: {
							text: "Situação",
							alignment: "right"
						},
						editorType: "dxSelectBox",
						validationRules: [{
							type: "required"
						}],
						editorOptions: {
							dataSource: new DevExpress.data.DataSource({
								store: new DevExpress.data.CustomStore({
									loadMode: "raw",
									load: function () {
										return $.getJSON(urlSearch, { method: "GetWWW101", pDescParametro: "MEDPROVIDERSTA" });
									}
								})
							}),
							searchEnabled: true,
							valueExpr: "Codigo",
							displayExpr: "Descricao",
						}
					}, {}, {
						colSpan: 10,
						itemType: "tabbed",
						name: "abas",
						tabPanelOptions: {
							deferRendering: false,
						},
						tabs: [{
							title: "Geral",
							items: [{
								template: function (data, itemElement) {
									itemElement.append("<div id='geral'>")
								}
							}],
						}, {
							title: "Auditoria",
							items: [{
								template: function (data, itemElement) {
									itemElement.append("<div id='controle'>")
								}
							}]
						}]
					}]
				}]
			}).dxForm("instance");

			dataSourceSalas = new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					loadMode: "raw",
					load: function () {
						return $.getJSON(urlPreparacao, { method: "ListaSala" });
					}
				})
			});

			codSala = $("#codSala").dxSelectBox({
				dataSource: dataSourceSalas,
				width: "95%",
				valueExpr: "Codigo",
				displayExpr: "Descricao",
				showClearButton: true,
				placeholder: "+",
				onValueChanged: function (e) {
					if (!e.value) {
						formGeral.resetValues()
						formControle.resetValues()
						dataSourceLeitos.reload();
						formGeral.getEditor("Tipo").option("readOnly", 0);
						formGeral.getEditor("QtdeLeito").option("readOnly", 0);
						formGeral.getEditor("utilizarHorarioUnidade").option({"value": 1});
						return
					}
					carregarDados(e.value);
					carregarDados(e.value);
				}
			}).dxSelectBox("instance");

			dataSourceLocal = new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					loadMode: "raw",
					load: function () {
						return $.getJSON(urlPreparacao, { method: "GetLocal", pCodUnidade: codUnidade });
					}
				})
			});

			var listLocal = {
				dataField: "Local",
				editorType: "dxSelectBox",
				label: { alignment: "right" },
				colSpan: 10,
				editorType: "dxSelectBox",
				visible: false,
				editorOptions: {
					dataSource: dataSourceLocal,
					valueExpr: "Codigo",
					displayExpr: "Descricao",
					searchEnabled: true,
					value: ""
				}
			};
			if (flagIntEstoque == 1) {
				listLocal = {
					dataField: "Local",
					editorType: "dxSelectBox",
					label: { alignment: "right" },
					colSpan: 10,
					editorType: "dxSelectBox",
					visible: flagIntEstoque,
					validationRules: [{ type: "required"}],
					editorOptions: {
						dataSource: dataSourceLocal,
						valueExpr: "Codigo",
						displayExpr: "Descricao",
						searchEnabled: true,
						value: "",
						buttons: [{
							name: "adicionarLocal",
							location: "after",
							options: {
								icon: "add",
								hint: "Adicionar Local de Consumo",
								onClick: function() {
									if (formGeral.getEditor("Unidade").option("value") == "" || formGeral.getEditor("Unidade").option("value") == null) {
										DevExpress.ui.notify("Favor selecionar a unidade.","warning");
										return;
									}
									codLocal = formGeral.getEditor("Local").option("value");
									if (codLocal == null) codLocal = "";
									$.getJSON(urlPreparacao, { method: "GetObjLocal", pCodLocal: codLocal}, function(objRetorno){
										$("#divLocalConsumo").dxPopup("show");
										objFormLocalConsumo = $("#divFormLocalConsumo").dxForm("instance");
										objFormLocalConsumo.getEditor("nomeLocal").option("value",objRetorno.locationName);
										objFormLocalConsumo.getEditor("centroCusto").option("value",objRetorno.centroCusto);
									});
								}
							}
						}]						
					}
				};
			}

			formGeral = $("#geral").dxForm({
				activeStateEnabled: true,
				formData: {},
				scrollingEnabled: true,
				height: function () {
					return window.innerHeight - 150;
				},
				colCount: 9,
				items: [{
					itemType: "group",
					cssClass: "second-group",
					colCount: 10,
					colSpan: 5,
					alignItemLabels: true,
					items: [{
						colSpan: 10, template: function (data, itemElement) { itemElement.append("<div style='height:5px;border:0px solid red;text-align:right'>")}
					},{
						dataField: "Unidade",
						colSpan: 10,
						editorType: "dxSelectBox",
						label: { alignment: "right" },
						validationRules: [{ type: "required" }],
						editorOptions: {
							dataSource: new DevExpress.data.DataSource({
								store: new DevExpress.data.CustomStore({
									loadMode: "raw",
									load: function () {
										return $.get(urlSearch, {
											method: "GetLocal",
											pCodLocal: "",
											pFlagUnidadeSaude: 1,
											pFlagLocalAtivo: 1
										});
									}
								})
							}),
							valueExpr: "Location",
							displayExpr: "LocationName",
							searchEnabled: true,
							onValueChanged: function (e) {
								codUnidade = e.value;
								if (flagIntEstoque == 1) {
									formGeral.getEditor("Local").option("value", "");
								}
								dataSourceLocal.reload();
								$.getJSON(urlPreparacao, { method: "GetHorarioUnidade", 
									codUnidade: codUnidade }, function(objRetorno){
									formGeral.getEditor("utilizarHorarioUnidade").option("value", 1);
									formGeral.getEditor("segundaSextaInicial").option("value", objRetorno.segundaSextaInicial);
									formGeral.getEditor("segundaSextaFinal").option("value", objRetorno.segundaSextaFinal);
									formGeral.getEditor("funcionaSabados").option("value", objRetorno.funcionaSabados);
									formGeral.getEditor("funcionaDomingos").option("value", objRetorno.funcionaDomingos);
									formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": true, "value": objRetorno.funcionaSabadosInicial});
									formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": true, "value": objRetorno.funcionaSabadosFinal});
									formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": true, "value": objRetorno.funcionaDomingosInicial});
									formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": true, "value": objRetorno.funcionaDomingosFinal});
								});
							}
						}
					}, listLocal, {
						colSpan: 6,
						dataField: "Nome",
						label: { alignment: "right" },
						validationRules: [{ type: "required" }],
					}, {
						dataField: "Setor",
						editorType: "dxSelectBox",
						colSpan: 4,
						label: { alignment: "right" },
						editorOptions: {
							readOnly: (flagIntPEP == 0 ? 1 : 0),
							dataSource: new DevExpress.data.DataSource({
								store: new DevExpress.data.CustomStore({
									loadMode: "raw",
									load: function () {
										return $.getJSON(urlPreparacao, { method: "GetVARPARA", DescParametro: "SETOR" });
									}
								})
							}),
							valueExpr: "Codigo",
							displayExpr: "Descricao",
							value: ""
						}
					}, {
						dataField: "Tipo",
						colSpan: 3,
						label: { text: "Tipo", alignment: "right" },
						editorType: "dxSelectBox",
						editorOptions: {
							dataSource: new DevExpress.data.DataSource({
								store: new DevExpress.data.CustomStore({
									loadMode: "raw",
									load: function () {
										return $.getJSON(urlPreparacao, { method: "GetVARPARA", DescParametro: "TIPO" });
									}
								})
							}),
							onValueChanged: function (e) {
								if (e.value == "CONSULTORIO") {
									formGeral.getEditor("QtdeLeito").option({"value":1, readOnly: true});
								}else{
									formGeral.getEditor("QtdeLeito").option({"value":1, readOnly: false});
								}
							},
							valueExpr: "Codigo",
							displayExpr: "Descricao",
						},
						validationRules: [{ type: "required" }],
					}, {
						dataField: "QtdeLeito",
						colSpan: 3,
						label: { text: "Qtde.", alignment: "right" },
						editorType: "dxNumberBox",
						editorOptions: {
							max: 20,
							min: 1,
							value: 1,
							showSpinButtons: true,
						},
						validationRules: [{ type: "required" }],
					}, {
						dataField: "Ala",
						editorType: "dxSelectBox",
						colSpan: 4,
						label: { alignment: "right" },
						editorOptions: {
							dataSource: new DevExpress.data.DataSource({
								store: new DevExpress.data.CustomStore({
									loadMode: "raw",
									load: function () {
										return $.getJSON(urlPreparacao, { method: "GetVARPARA", DescParametro: "ALA" });
									}
								})
							}),
							valueExpr: "Codigo",
							displayExpr: "Descricao",
						}
					},{
						colSpan: 10, template: function (data, itemElement) { itemElement.append("<div style='height:77px;border:0px solid red;text-align:right'>")}
					}]
				}, {
					colSpan: 4,
					colCount: 3,
					itemType: "group",
					cssClass: "second-group",
					caption: "Horários de Funcionamento",
					alignItemLabels: true,
					items: [{
						colSpan: 3,
						dataField: "utilizarHorarioUnidade",
						editorType: "dxCheckBox",
						label: {
							text: "Utilizar Horário da Unidade",
							alignment: "right"
						},
						editorOptions: {
							value: true,
							onValueChanged: function (e) {
								if (e.value) {
									formGeral.getEditor("segundaSextaInicial").option("readOnly", true);
									formGeral.getEditor("segundaSextaFinal").option("readOnly", true);
									formGeral.getEditor("funcionaSabados").option("readOnly", true);
									formGeral.getEditor("funcionaDomingos").option("readOnly", true);
									if (formGeral.getEditor("funcionaSabados").option("value") == 1) {
										formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": false});
										formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": false});
									}else{
										formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": true});
										formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": true});
									}
									if (formGeral.getEditor("funcionaDomingos").option("value") == 1) {
										formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": false});
										formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": false});
									}else{
										formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": true});
										formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": true});
									}

								} else {
									formGeral.getEditor("segundaSextaInicial").option("readOnly", false);
									formGeral.getEditor("segundaSextaFinal").option("readOnly", false);
									formGeral.getEditor("funcionaSabados").option("readOnly", false);
									formGeral.getEditor("funcionaDomingos").option("readOnly", false);
									if (formGeral.getEditor("funcionaSabados").option("value") == 1) {
										formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": false});
										formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": false});
									}else{
										formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": true});
										formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": true});
									}
									if (formGeral.getEditor("funcionaDomingos").option("value") == 1) {
										formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": false});
										formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": false});
									}else{
										formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": true});
										formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": true});
									}
								}
							}
						}
					},{
						dataField: "segundaSextaInicial",
						editorType: "dxDateBox",
						label: {
							text: "Segunda a Sexta",
							alignment: "right"
						},
						editorOptions: {
							type: "time",
							pickerType: "native",
							width: 110,
							readOnly: true
						},
					}, {
						dataField: "segundaSextaFinal",
						editorType: "dxDateBox",
						label: {
							visible: false
						},
						editorOptions: {
							width: 110,
							type: "time",
							pickerType: "native",
							readOnly: true
						},
					}, {}, {
						dataField: "funcionaSabados",
						editorType: "dxCheckBox",
						label: {
							text: "Funciona aos Sábados",
							alignment: "right"
						},
						editorOptions: {
							readOnly: true,
							onValueChanged: function (e) {
								if (e.value) {
									formGeral.getEditor("funcionaSabadosInicial").option({ "readOnly": false, "value": "" });
									formGeral.getEditor("funcionaSabadosFinal").option({ "readOnly": false, "value": "" });
								} else {
									formGeral.getEditor("funcionaSabadosInicial").option({ "readOnly": true, "value": "" });
									formGeral.getEditor("funcionaSabadosFinal").option({ "readOnly": true, "value": "" });
								}
							}
						}
					}, {
						dataField: "funcionaSabadosInicial",
						editorType: "dxDateBox",
						label: {
							text: "Horário"
						},
						editorOptions: {
							type: "time",
							pickerType: "native",
							width: 90,
							readOnly: true
						},

					}, {
						dataField: "funcionaSabadosFinal",
						editorType: "dxDateBox",
						label: {
							visible: false
						},
						editorOptions: {
							width: 90,
							type: "time",
							pickerType: "native",
							readOnly: true
						},
					}, {
						dataField: "funcionaDomingos",
						editorType: "dxCheckBox",
						label: {
							text: "Funciona aos Domingos",
							alignment: "right"
						},
						editorOptions: {
							readOnly: true,
							onValueChanged: function (e) {
								if (e.value) {
									formGeral.getEditor("funcionaDomingosInicial").option({ "readOnly": false, "value": "" });
									formGeral.getEditor("funcionaDomingosFinal").option({ "readOnly": false, "value": "" });
								} else {
									formGeral.getEditor("funcionaDomingosInicial").option({ "readOnly": true, "value": "" });
									formGeral.getEditor("funcionaDomingosFinal").option({ "readOnly": true, "value": "" });
								}
							}
						}
					}, {
						dataField: "funcionaDomingosInicial",
						editorType: "dxDateBox",
						label: {
							text: "Horário",
							alignment: "right"
						},
						editorOptions: {
							type: "time",
							pickerType: "native",
							width: 90,
							readOnly: true
						},

					}, {
						dataField: "funcionaDomingosFinal",
						editorType: "dxDateBox",
						label: {
							visible: false
						},
						editorOptions: {
							width: 90,
							type: "time",
							pickerType: "native",
							readOnly: true
						},
					}]
				}, {
					colSpan: 9,
					cssClass: "second-group",
					itemType: "group",
					caption: "Horários por Cadeira/Equipamento/Leito",
					alignItemLabels: true,
					items: [{
						template: function (data, itemElement) {
							itemElement.append("<div id='divLeito'>")
						}
					}]
				}]
			}).dxForm("instance");

			/*$(".dx-form-group-caption").each(function( index ) {
			conteudoGrupo = $(this).html();
			if (conteudoGrupo.includes('Funcionamento')) {
			$(this).html(
			"&nbsp;<i class='fas fa-info' style='color:#337AB7;font-size:13px;' "+
			"title='Caso os dados não seja preenchido, o sistema ira considerar os horários da unidade' />"+
			"&nbsp; Horários de Funcionamento"
			);
			}
			});*/

			dataSourceLeitos = new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					key: "codLeito",
					loadMode: "raw",
					load: function () {
						pCodSala = codSala.option("value");
						return $.getJSON(urlPreparacao, { method: "GetLeitos", pCodSala: pCodSala })
					}
				})
			});

			gridLeito = $("#divLeito").dxDataGrid({
				loadPanel: { enabled: true },
				dataSource: dataSourceLeitos,
				columnChooser: { enabled: false },
				allowColumnReordering: false,
				columnAutoWidth: true,
				showColumnLines: true,
				showRowLines: true,
				rowAlternationEnabled: true,
				hoverStateEnabled: true,
				showBorders: true,
				searchPanel: { visible: true, width: 240, placeholder: "Pesquisar..." },
				headerFilter: { visible: false },
				grouping: { expandMode: "rowClick", autoExpandAll: true, allowCollapsing: true },
				groupPanel: { visible: true, allowColumnDragging: false },
				columnFixing: { enabled: false },
				editing: { mode: "batch", allowUpdating: false, allowDeleting: false, useIcons: false },
				columns: [
					{ dataField: "descricao", caption: "Descrição", alignment: "center" },
					//{ dataField: "situacaoDesc", caption: "Situação", width: 150, alignment: "center" },
					{
						caption: "Horários de Funcionamento", alignment: "center", columns: [
							{ dataField: "horarioSala", caption: "Horário da Sala", width: 100, alignment: "center" },
							{ dataField: "segundaSexta", caption: "Segunda a Sexta", width: 170, alignment: "center" },
							{ dataField: "funcSabados", caption: "Funciona aos Sábados", width: 170, alignment: "center" },
							{ dataField: "funcDomingos", caption: "Funciona aos Domingos", width: 170, alignment: "center" },
						]
					},
					{
						dataField: "acao", caption: "Ação", alignment: "center", width: 100,
						cellTemplate: function (contConf, optConf) {
							contConf.html("<div style='width:80px;'>" +
								"<span onClick='editarLeito(" + optConf.data.codLeito + ");'>" +
								"<i class='fas fa-pencil-alt' title='Editar Leito/Equipamento' style='color:#337AB7;green;cursor:pointer;' />" +
								"</span>" +
								"</div>");
						}
					}
				],
				onToolbarPreparing: function (e) {
					var dataGrid = e.component;
					e.toolbarOptions.items.unshift({
						location: "after",
						widget: "dxButton",
						options: {
							icon: "add",
							height: 25,
							width: 25,
							hint: "Adicionar Leito/Equipamento",
							onClick: function (e) {
								if (codSala.option("value") == "" || codSala.option("value") == null) {
									DevExpress.ui.notify("Favor selecionar a sala.", "warning", 4000);
									return;
								}
								if (formGeral.getEditor("Tipo").option("value") == "CONSULTORIO") {
									DevExpress.ui.notify("Sala de tipo consultório, não pose ser inserido Cadeira/Equipamento/Leito.", "warning", 4000);
									return;
								}
								codLeito = "";
								$("#divAddLeito").dxPopup("show");
							}
						}
					})
				},
				height: function () { 
					var xHeight = window.innerHeight - 420
					if (xHeight < 250) xHeight = 250

					return xHeight; 
				},
				export: { enabled: false },
				wordWrapEnabled: true,
			}).dxDataGrid("instance");

			function editarLeito(pCodLeito) {
				$.getJSON(urlPreparacao, {
					method: "RecuperaLeito", pCodSala: codSala.option("value"),
					pCodLeito: pCodLeito
				}, function (objRetorno) {
					codLeito = pCodLeito;
					$("#divAddLeito").dxPopup("show");
					objFormAddLeito = $("#divFormAddLeito").dxForm("instance");
					objFormAddLeito.getEditor("descricao").option("value", objRetorno.descricao);
					//objFormAddLeito.getEditor("situacao").option("value", objRetorno.situacao);
					objFormAddLeito.getEditor("segundaSextaInicial").option("value", objRetorno.horSegunda);
					objFormAddLeito.getEditor("segundaSextaFinal").option("value", objRetorno.horSexta);
					objFormAddLeito.getEditor("funcionaSabados").option("value", objRetorno.funcSabado);
					objFormAddLeito.getEditor("funcionaSabadosInicial").option("value", objRetorno.horSabadoIni);
					objFormAddLeito.getEditor("funcionaSabadosFinal").option("value", objRetorno.horSabadoFim);
					objFormAddLeito.getEditor("funcionaDomingos").option("value", objRetorno.funcDomingo);
					objFormAddLeito.getEditor("funcionaDomingosInicial").option("value", objRetorno.horDomingoIni);
					objFormAddLeito.getEditor("funcionaDomingosFinal").option("value", objRetorno.horDomingoFim);
				});
			}

			formControle = $("#controle").dxForm({
				activeStateEnabled: true,
				formData: {},
				scrollingEnabled: true,
				height: function () {
					return window.innerHeight - 150;
				},
				items: [{
					itemType: "group",
					colCount: 2,
					items: [{
						dataField: "CriadoPor",
						label: {
							alignment: "right"
						},
						disabled: true
					}, {
						dataField: "CriadoEm",
						label: {
							alignment: "right"
						},
						disabled: true
					}, {
						dataField: "AlteradoPor",
						label: {
							alignment: "right"
						},
						disabled: true
					}, {
						dataField: "AlteradoEm",
						label: {
							alignment: "right"
						},
						disabled: true
					}]
				}]
			}).dxForm("instance");

			function carregarDados(pCodSala) {
				$.getJSON(urlPreparacao, { method: "RecuperaSala", codSala: pCodSala }, function (retorno) {
					formGeral.option("formData", retorno.geral)
					if (retorno.geral.segundaSextaInicial == "") {
						$.getJSON(urlPreparacao, { method: "GetHorarioUnidade", 
							codUnidade: codUnidade }, function(objRetorno){
							formGeral.getEditor("utilizarHorarioUnidade").option("value", 1);
							formGeral.getEditor("segundaSextaInicial").option("value", objRetorno.segundaSextaInicial);
							formGeral.getEditor("segundaSextaFinal").option("value", objRetorno.segundaSextaFinal);
							formGeral.getEditor("funcionaSabados").option("value", objRetorno.funcionaSabados);
							formGeral.getEditor("funcionaDomingos").option("value", objRetorno.funcionaDomingos);
							formGeral.getEditor("funcionaSabadosInicial").option({"readOnly": true, "value": objRetorno.funcionaSabadosInicial});
							formGeral.getEditor("funcionaSabadosFinal").option({"readOnly": true, "value": objRetorno.funcionaSabadosFinal});
							formGeral.getEditor("funcionaDomingosInicial").option({"readOnly": true, "value": objRetorno.funcionaDomingosInicial});
							formGeral.getEditor("funcionaDomingosFinal").option({"readOnly": true, "value": objRetorno.funcionaDomingosFinal});
						});
					}else{
						formGeral.getEditor("utilizarHorarioUnidade").option("value", 0); 
					}
					formGeral.getEditor("Tipo").option("readOnly", 1);
					formGeral.getEditor("QtdeLeito").option("readOnly", 1);
					formControle.option("formData", retorno.controle)
					//formulario.getEditor("Situacao").option("value", retorno.situacao);
					dataSourceLeitos.reload();
				});
			}

			$("#divAddLeito").dxPopup({
				visible: false,
				title: "Leito/Equipamento",
				width: 600,
				height: 400,
				position: {
					my: "center",
					at: "center",
					of: window
				},
				dragEnabled: true,
				contentTemplate: function (e) {
					objAddLeito = $("<div id='divFormAddLeito'>").dxForm({
						readOnly: false,
						alignItemLabels: true,
						showColonAfterLabel: true,
						screenByWidth: function (width) { return "lg"; },
						labelLocation: "left",
						colCount: 2,
						items: [{
							dataField: "descricao",
							colSpan: 2,
							label: {
								text: "Descrição",
								alignment: "right"
							},
						}, {
							visible: false,
							dataField: "situacao",
							label: {
								text: "Situação",
								alignment: "right"
							},
							editorType: "dxSelectBox",
							editorOptions: {
								dataSource: new DevExpress.data.DataSource({
									store: new DevExpress.data.CustomStore({
										loadMode: "raw",
										load: function () {
											return $.getJSON(urlSearch, { method: "GetWWW101", pDescParametro: "MEDPROVIDERSTA" });
										}
									})
								}),
								searchEnabled: true,
								valueExpr: "Codigo",
								displayExpr: "Descricao",
							}
						}, {
							colSpan: 2,
							colCount: 3,
							itemType: "group",
							caption: "Horários de Funcionamento",
							alignItemLabels: true,
							items: [{
								dataField: "segundaSextaInicial",
								editorType: "dxDateBox",
								label: {
									text: "Segunda a Sexta",
									alignment: "right"
								},
								editorOptions: {
									type: "time",
									pickerType: "native",
									width: 110,
								},
							}, {
								dataField: "segundaSextaFinal",
								editorType: "dxDateBox",
								label: {
									visible: false
								},
								editorOptions: {
									width: 110,
									type: "time",
									pickerType: "native",
								},
							}, {}, {
								dataField: "funcionaSabados",
								editorType: "dxCheckBox",
								label: {
									text: "Funciona aos Sábados",
									alignment: "right"
								},
								editorOptions: {
									onValueChanged: function (e) {
										if (e.value) {
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaSabadosInicial").option({ "readOnly": false, "value": "" });
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaSabadosFinal").option({ "readOnly": false, "value": "" });
										} else {
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaSabadosInicial").option({ "readOnly": true, "value": "" });
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaSabadosFinal").option({ "readOnly": true, "value": "" });
										}
									}
								}
							}, {
								dataField: "funcionaSabadosInicial",
								editorType: "dxDateBox",
								label: {
									text: "Horário"
								},
								editorOptions: {
									type: "time",
									pickerType: "native",
									width: 90,
									readOnly: true
								},

							}, {
								dataField: "funcionaSabadosFinal",
								editorType: "dxDateBox",
								label: {
									visible: false
								},
								editorOptions: {
									width: 90,
									type: "time",
									pickerType: "native",
									readOnly: true
								},
							}, {
								dataField: "funcionaDomingos",
								editorType: "dxCheckBox",
								label: {
									text: "Funciona aos Domingos",
									alignment: "right"
								},
									editorOptions: {
									onValueChanged: function (e) {
										if (e.value) {
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaDomingosInicial").option({ "readOnly": false, "value": "" });
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaDomingosFinal").option({ "readOnly": false, "value": "" });
										} else {
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaDomingosInicial").option({ "readOnly": true, "value": "" });
											$("#divFormAddLeito").dxForm("instance").getEditor("funcionaDomingosFinal").option({ "readOnly": true, "value": "" });
										}
									}
								}
							}, {
								dataField: "funcionaDomingosInicial",
								editorType: "dxDateBox",
								label: {
									text: "Horário",
									alignment: "right"
								},
								editorOptions: {
									type: "time",
									pickerType: "native",
									width: 90,
									readOnly: true
								},

							}, {
								dataField: "funcionaDomingosFinal",
								editorType: "dxDateBox",
								label: {
									visible: false
								},
								editorOptions: {
									width: 90,
									type: "time",
									pickerType: "native",
									readOnly: true
								},
							}]
						}, {
							itemType: "button", colSpan: 3, horizontalAlignment: "right",
							buttonOptions: {
								type: "success", icon: "save", text: "Salvar",
								onClick: function () {
									objFormAddLeito = $("#divFormAddLeito").dxForm("instance");
									var pDescricao = objFormAddLeito.getEditor("descricao").option("value");
									var pSituacao = ""; //objFormAddLeito.getEditor("situacao").option("value");
									var pSegundaSextaInicial = objFormAddLeito.getEditor("segundaSextaInicial").option("text");
									var pSegundaSextaFinal = objFormAddLeito.getEditor("segundaSextaFinal").option("text");
									var pFuncionaSabados = objFormAddLeito.getEditor("funcionaSabados").option("value");
									var pFuncionaSabadosInicial = objFormAddLeito.getEditor("funcionaSabadosInicial").option("text");
									var pFuncionaSabadosFinal = objFormAddLeito.getEditor("funcionaSabadosFinal").option("text");
									var pFuncionaDomingos = objFormAddLeito.getEditor("funcionaDomingos").option("value");
									var pFuncionaDomingosInicial = objFormAddLeito.getEditor("funcionaDomingosInicial").option("text");
									var pFuncionaDomingosFinal = objFormAddLeito.getEditor("funcionaDomingosFinal").option("text");
									if (pFuncionaSabados) {
										if (pFuncionaSabadosInicial == "" || pFuncionaSabadosFinal == "") {
											DevExpress.ui.notify("Favor preencher os campos de horário de funcionamento aos sábados.", "warning");
											return;
										}
									}
									if (pFuncionaDomingos) {
										if (pFuncionaDomingosInicial == "" || pFuncionaDomingosFinal == "") {
											DevExpress.ui.notify("Favor preencher os campos de horário de funcionamento aos domingos.", "warning");
											return;
										}
									}
									$.get(urlPreparacao, {
										method: "ValidarHorario",
										pUnidade: formGeral.getEditor("Unidade").option("value"),
										pSala: codSala.option("value"),
										pTipo: "L",	
										pSegundaSextaInicial: pSegundaSextaInicial,
										pSegundaSextaFinal: pSegundaSextaFinal,
										pFuncionaSabados: pFuncionaSabados,
										pFuncionaSabadosInicial: pFuncionaSabadosInicial,
										pFuncionaSabadosFinal: pFuncionaSabadosFinal,
										pFuncionaDomingos: pFuncionaDomingos,
										pFuncionaDomingosInicial: pFuncionaDomingosInicial,
										pFuncionaDomingosFinal: pFuncionaDomingosFinal,
										YBED: YBED
									},function(status){
										if (status != 1) {
											DevExpress.ui.notify(status, "warning");
										}else{			                        
											$.getJSON(urlPreparacao, {
												method: "SalvarLeito", pCodSala: codSala.option("value"), pCodLeito: codLeito,
												pDescricao: pDescricao, pSituacao: pSituacao, pSegundaSextaInicial: pSegundaSextaInicial,
												pSegundaSextaFinal: pSegundaSextaFinal, pFuncionaSabados: pFuncionaSabados,
												pFuncionaSabadosInicial: pFuncionaSabadosInicial, pFuncionaSabadosFinal: pFuncionaSabadosFinal,
												pFuncionaDomingos: pFuncionaDomingos, pFuncionaDomingosInicial: pFuncionaDomingosInicial,
												pFuncionaDomingosFinal: pFuncionaDomingosFinal
											}, function (objRetorno) {
												if (objRetorno.status == 1) {
													$("#divFormAddLeito").dxForm("instance").resetValues();
													dataSourceLeitos.reload();
													$("#divAddLeito").dxPopup("hide");
													if (objRetorno.qtdeLeito != formGeral.getEditor("QtdeLeito").option("value")) {
														formGeral.getEditor("QtdeLeito").option("value", objRetorno.qtdeLeito);
													}
													DevExpress.ui.notify("Dados Salvos com Sucesso!", "success");
												} else {
													DevExpress.ui.notify("Erro: " + objRetorno.status, "error");
												}
											});
										}
									});
								}
							}
						}, {
							itemType: "button", colSpan: 3, horizontalAlignment: "left",
							buttonOptions: {
								type: "default", icon: "close", text: "Cancelar",
								onClick: function () {
									$("#divFormAddLeito").dxForm("instance").resetValues();
									codLeito = "";
									dataSourceLeitos.reload();
									$("#divAddLeito").dxPopup("hide");
								}
							}
						}]
					});
					e.append(objAddLeito);
				}
			});
			
			$("#divLocalConsumo").dxPopup({
				visible: false,
				title: "Cadastrar/Editar Local de Consumo",
				width: 600,
				height: 160,
				position: {
					my: "center",
					at: "center",
					of: window
				},
				dragEnabled: true,
				contentTemplate: function (e) {
					objAddLocalConsumo = $("<div id='divFormLocalConsumo'>").dxForm({
						readOnly: false,
						alignItemLabels: true,
						showColonAfterLabel: true,
						screenByWidth: function (width) { return "lg"; },
						labelLocation: "left",
						colCount: 2,
						items: [{
							colSpan: 2,
							dataField	: "nomeLocal",
							editorType	: "dxTextBox",
							label: {text:" Nome do Local", alignment: "right" },
						},{
							colSpan: 2,
							dataField: "centroCusto",
							editorType: "dxSelectBox",
							label	: { text:"Centro de Custo", alignment: "right"},
							editorOptions: {
								dataSource: new DevExpress.data.DataSource({
									store: new DevExpress.data.CustomStore({
										loadMode: "raw",
										load: function () {
											return $.getJSON(urlSearch, { method: "GetCentroCusto"});
										}
									})
								}),
								width: 250,
								valueExpr: "Codigo",
								displayExpr: "Descricao",
								value: ""
							}							
						}, {
							itemType: "button", horizontalAlignment: "right",
							buttonOptions: {
								type: "success", icon: "save", text: "Salvar",
								onClick: function () {
									objFormLocalConsumo = $("#divFormLocalConsumo").dxForm("instance");
									var pUnidade 			= formGeral.getEditor("Unidade").option("value");
									var pNomeLocal 		= objFormLocalConsumo.getEditor("nomeLocal").option("value");
									var pCentroCusto 	= objFormLocalConsumo.getEditor("centroCusto").option("value");
									if (pNomeLocal == "" ) {
										DevExpress.ui.notify("Favor preencher o campo Nome do Local.", "warning");
										return;
									}
									$.getJSON(urlPreparacao, {
										method: "SalvarLocaConsumo", pUnidade: pUnidade, pCodLocal: codLocal, 
										pNomeLocal: pNomeLocal, pCentroCusto: pCentroCusto
									}, function (objRetorno) {
										console.log(objRetorno)
										if (objRetorno.status == 1) {
											$("#divFormLocalConsumo").dxForm("instance").resetValues();
											dataSourceLocal.reload();
											formGeral.getEditor("Local").option("value", "");
											formGeral.getEditor("Local").option("value", objRetorno.codLocal);
											$("#divLocalConsumo").dxPopup("hide");
											DevExpress.ui.notify("Dados Salvos com Sucesso!", "success");
										} else {
											DevExpress.ui.notify("Erro: " + objRetorno.status, "error");
										}
									});
								}
							}
						}, {
							itemType: "button", horizontalAlignment: "left",
							buttonOptions: {
								type: "default", icon: "close", text: "Cancelar",
								onClick: function () {
									$("#divFormLocalConsumo").dxForm("instance").resetValues();
									$("#divLocalConsumo").dxPopup("hide");
								}
							}
						}]
					});
					e.append(objAddLocalConsumo);
				}
			});
		</script>
	</body>
</html>
