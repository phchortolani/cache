<!DOCTYPE html> 
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
	<script language="Cache" runat="server">
		Do ^WWWVAR

		Set YUSER 		= $Get(%request.Data("YUSER", 1))
		Set YBED 			= $Get(%request.Data("YBED", 1))
		Set YM 				= $Get(%request.Data("YM", 1))
		Set YLOCATION = $Get(%request.Data("YLOCATION", 1))

		Set PortCache = $Get(%request.CgiEnvs("SERVER_PORT"))
		Set PageURL 	= $Get(%request.CgiEnvs("CACHE_URL"))
		Set PageName 	= %request.PageName
		Set app 			= %request.Application
		Set host 			= %request.CgiEnvs("HTTP_HOST")
		Set url				= "http://"_host_app

		Set URLPreparacao = "VAR.CSP.VARAgendaMedica.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"
		Set URLSearch			= "User.Search.PesquisasJson.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"
		Set URLLogin 			= "COMLogin.cls"
		Set URLLink 			= "www.cls"

		Set nomeLocal 		= YLOCATION_" - "_$$SQLGetLocationName^VARSQL(YLOCATION)

		Set dataMinLimite	= $ZDate(+$Horolog,3)

		//Verifica se a sessão
		Set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
		Do ##Class(VAR.CSP.VARConfiguracaoAgendamento).InicializaConfiguracao(YBED)
		;
		Set codMedico = ""
		If ($Data(^MEDProviders(0,1,YBED))) {
			Set codMedico = $Order(^MEDProviders(0,1,YBED,""))
		}
		;
		Set flagPEP = 0
		If ($Data(^VARAgendamentoConf(YM, 0))) {
			Set objVARAgendamentoConf = $Get(^VARAgendamentoConf(YM, 0, 1))			
			Set flagPEP = $Piece(objVARAgendamentoConf,Y,1)
		}
		;
	</script>

	<head>

		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Agenda Médica</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">
		<!-- Font Awesome -->
		<link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

		<!-- Custom Elements -->
		<link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
		<link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
		<link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />

		<!-- Fonts Padrão IPP -->
		<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800">

		<!-- DevExtreme themes -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme20.2.4/Lib/css/dx.common.css" />
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme20.2.4/Lib/css/dx.light.compact.css" />
		<!--<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme20.2.4/Lib/css/dx.light.compact.css" />-->

    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/themes/css/alphalinc.css" id="style_color" />
	</head>
	<script type="text/javascript">

		var status = '#(status)#';
		var URLLogin = '#(URLLogin)#';
		var ygif = '#(YGIF)#'

		if (status == 0) {
			alert('Usuário não está logado ou a sessão expirou.')
			window.location.replace(URLLogin)
		}

	</script>

	<style>
	.cell-selected {
		background-color: #FFFFB9;
	}

	.dx-datagrid {
		user-select: none;
		-webkit-user-select: none;
	}		

	.dx-row2 { background-color: #F5F5F5; }
	
	#divEsquerdo{
    position: relative;
    width: 252px;
    height: 690px;
    float: left;
    background: #F0F0F0;
    padding-left: 5px;
    padding-right: 5px;
	}
	#divDireito {
		position:relative;
		border-width: 2px;
		width: calc(100% - 252px);
		float: left;
    padding-left: 5px;
    padding-right: 5px;
	}

	.dx-scheduler-navigator {  
		visibility: hidden  
	}  
	.dx-scheduler-view-switcher {  
		visibility: hidden  
	}

	</style>

	<body>
		<div id="toolbar"></div>
		<div class="group" style="margin-top:5px;">
	    <div id="divEsquerdo">
	    	<div id="divMenuConteudo"></div>
	    </div>
	    <div id="divDireito">
	    	<div id="divDadosConteudoTitulo" style='font-size:12px; border:1px solid #e0e0e0;
	 	   		text-align: left;padding-top:5px;padding-right:15px;height: 30px; color: #333333'
	 	   	>
					<span> &nbsp;<b>Legenda: &nbsp;</b></span> 
					<span style='height: 20px; background-color: #A9C8DE;border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; Horário Livre &nbsp;</span> 
					<span>&nbsp; </span>
					<span style='height: 20px; background-color: #C4FFC4;border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; Horário com Paciente &nbsp;
					</span>
					<span>&nbsp; </span>
					<span style='height: 20px; background-color: #ffcaca;border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; Ausência (Bloqueado) &nbsp;
					</span>
					<span>&nbsp; </span>
					<span style='height: 20px; border:1px solid #e0e0e0; border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; <i class='fas fa-thumbs-up' style='color:green'></i> Admitido &nbsp;
					</span>
					<span>&nbsp; </span>
					<span style='height: 20px; border:1px solid #e0e0e0; border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; <i class='fas fa-thumbs-down' style='color:red'></i> Não Compareceu &nbsp;
					</span>
					<span>&nbsp; </span>
					<span style='height: 20px; border:1px solid #e0e0e0; border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; <i class='fas fa-exclamation-triangle' style='color:black;'></i> Encaixe &nbsp;
					</span>
	    	</div>
	    	<div id="divDadosConteudoTitulo1" style='font-size:12px; border:1px solid #e0e0e0;
	 	   		text-align: left;padding-top:5px;padding-right:15px;height: 30px; color: #333333; display: none;'
	 	   	>
					<span> &nbsp;<b>Legenda: &nbsp;</b></span> 
					<span style='height: 20px; background-color: #A9C8DE;border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; Consulta &nbsp;</span> 
					<span>&nbsp; </span>
					<span style='height: 20px; background-color: #C4FFC4;border-radius: 2px;display: inline-block;vertical-align: middle;'>
						&nbsp; Procedimento &nbsp;
					</span>
	    	</div>
	    	<div id="divDadosConteudo" style='overflow: auto;'></div>
	    	<div id="divDadosConteudoRodape" style='font-size:12px; margin-top: 2px; border:1px solid #e0e0e0;
	    	text-align: right;padding-top:5px;padding-right:15px;height: 30px; color: #333333'></div>
	    </div>
		</div>
  	<div id="divRegistrarAtendimento"></div>
		<!-- REQUIRED JS SCRIPTS -->
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/jquery.min.js"></script>

		<!-- JSZip library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/jszip.min.js"></script>

		<!-- A DevExtreme library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/dx.all.js"></script>

		<!-- DevExtreme-Intl module -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/localization/dx.messages.pt.js"></script>

		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/localization/dx.messages.pt.js"></script>

		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/dx-gantt.min.js"></script>

		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
		
		<!--Definições globais e criação de funcionalidades encapsuladas-->
		<script type="text/javascript">
			//Deixando variáveis disponíveis no cliente
			var urlPreparacao 		= "#(URLPreparacao)#";
			var urlSearch					= "#(URLSearch)#";
			var urlLink 					= "#(URLLink)#";
			var YBED 							= "#(YBED)#";
			var YUSER 						= "#(YUSER)#";
			var YLOCATION 				= "#(YLOCATION)#";
			var nomeLocal 				= "#(nomeLocal)#";
			var codAgendamento		= "";
			var codMedico					= "#(codMedico)#";
			var pDataAgenda				= new Number("#(+$Horolog)#");
			var pDataAgendaForm		= "#($ZDate(+$Horolog,3))#";
			var tipoOrganizacao		= "SE";
			var flagPEP						= #(flagPEP)#;
			var codPaciente				= "";
			var numAdmissao				= "";
			var codPacientePesq		= "";
			
			var totMinutos				= 0;
			var totSegundos				= 0;
			
			hEsquerdo = (window.innerHeight - 20);
			if (hEsquerdo < 690) hEsquerdo = "690";
			$("#divEsquerdo").css("height", hEsquerdo);
			
			DevExpress.config({decimalSeparator: ",",thousandsSeparator: "."});
			DevExpress.localization.locale("pt");

			$(document).ready(function () {
				objMenuConteudo.getEditor("medico").option("value", codMedico);
				if (codMedico != "") {
					objMenuConteudo.getEditor("medico").option("readOnly", true);
				}
				objCalendario.option("value",pDataAgendaForm);
				selecionarTipoOrganizacao(tipoOrganizacao);
				listarAgenda();
			});

			objMenuConteudo = $("#divMenuConteudo").dxForm({
				activeStateEnabled: true,
				minColWidth: 50,
				screenByWidth: function(width) { return "lg"; },
				screenByWidth: function(width) { return "lg"; },
				height:function(){ 20},
				alignItemLabels: false,
				alignItemLabelsInAllGroups: false,
				labelLocation: "top",
				items: [{
					dataField: "medico",
					label: {text: "Médico"},
					editorType: "dxSelectBox",
					editorOptions: {
						dataSource: new DevExpress.data.DataSource({
        			store: new DevExpress.data.CustomStore({
            		loadMode: "raw",   
            		load: function() {
                	return $.getJSON(urlPreparacao,{method:"GetMedicos"});
            		}
        			})
    				}),
						searchEnabled: true,
						valueExpr: "codigo", 
						displayExpr: "nome",
						showClearButton: true,
						onValueChanged: function (e) {
							if (!e.value) {
								selecionarTipoOrganizacao("SE");
							}
							pDataAgenda	= new Number("#(+$Horolog)#");
							pDataAgendaForm		= "#($ZDate(+$Horolog,3))#";
							objCalendario.option("value",pDataAgendaForm);
							selecionarTipoOrganizacao(tipoOrganizacao);
							listarAgenda();
						}
					}
				},{
					itemType: "group",
					caption: "Organizar",
					items: [{
						template	: function (data, itemElement) {
							itemElement.append("<div id='divOrganizar' style='text-align:center;'></div>")
						}
					}]
				},{
					itemType: "group",
					caption: " ",
					items: [{
						template	: function (data, itemElement) {
							itemElement.append("<div style='padding-left: 5px'><div id='divCalendario'></div></div>")
						}
					}]
				},{
					itemType: "group",
					caption: "Paciente",
					items: [{
						template	: function (data, itemElement) {
							itemElement.append("<div id='divPaciente' style='text-align:center;'></div>")
						}
					},{	
						template	: function (data, itemElement) {
							itemElement.append("<div style='padding-left: 5px'><div id='divHistoricoPaciente'></div></div>")
						}
					}]
				}]
			}).dxForm("instance");
		
			$("#divOrganizar").html("<table cellspacing='0' cellpadding='0' border='0'><tr>" +
																"<td width='5px' align='center'></td>" +
																"<td width='58px' align='center'><div id='divOrgProx7'></div></td>" +
																"<td width='58px' align='center'><div id='divOrgDia'></div></td>" +
																"<td width='58px' align='center'><div id='divOrgSemana'></div></td>" +
																"<td width='58px' align='center'><div id='divOrgMes'></div></td>" +
															"</tr></table>")			
			
			
			$("#divOrgProx7").html("<div id='divTOP7' style='width:52px;min-width:52px;margin:0px;border:1px solid #cccccc;" +
																"border-top-left-radius:5px;border-top-right-radius:5px;height: 55px;background:#ffffff;" +
																"box-shadow: 3px 3px 2px #888888;text-align:center;padding-top:8px;cursor:pointer;' " +
																"onClick=selecionarTipoOrganizacao('P7');>" +
																"<i class='far fa-calendar-minus' style='font-size:17px;color:#337AB7;' />" +
																"<br><span style='font-size:9px;font-family:Open Sans; line-height: 0.7;'>Próximos<br>7 Dias</span></div>")

			$("#divOrgDia").html("<div id='divTODI' style='width:52px;min-width:52px;margin:0px;border:1px solid #cccccc;" +
																"border-top-left-radius:5px;border-top-right-radius:5px;height: 55px;background:#ffffff;" +
																"box-shadow: 3px 3px 2px #888888;text-align:center;padding-top:8px;cursor:pointer;' " +
																"onClick=selecionarTipoOrganizacao('DI');>" +
																"<i class='far fa-calendar-check' style='font-size:18px;color:#337AB7;' />" +
																"<br><span style='font-size:9px;font-family:Open Sans;'>Dia</span></div>")

			$("#divOrgSemana").html("<div id='divTOSE' style='width:52px;min-width:52px;margin:0px;border:1px solid #cccccc;" +
																"border-top-left-radius:5px;border-top-right-radius:5px;height: 55px;cursor:pointer;" +
																"box-shadow: 3px 3px 2px #888888;text-align:center;padding-top:8px;background:#ffffff' " +
																"onClick=selecionarTipoOrganizacao('SE');>" +
																"<i class='far fa-calendar-plus' style='font-size:18px;color:#337AB7;' />" +
																"<br><span style='font-size:9px;font-family:Open Sans;'>Semana</span></div>")

			$("#divOrgMes").html("<div id='divTOME' style='width:52px;min-width:52px;margin:0px;border:1px solid #cccccc;" +
																"border-top-left-radius:5px;border-top-right-radius:5px;height: 55px;cursor:pointer;" +
																"box-shadow: 3px 3px 2px #888888;text-align:center;padding-top:8px;background:#ffffff' " +
																"onClick=selecionarTipoOrganizacao('ME');>" +
																"<i class='far fa-calendar-alt' style='font-size:18px;color:#337AB7;' />" +
																"<br><span style='font-size:9px;font-family:Open Sans;'>Mês</span></div>")
			
			function selecionarTipoOrganizacao(pTipoOrfanizacao){
				var pCodProfissional = objMenuConteudo.getEditor("medico").option("value");
				if (pTipoOrfanizacao == "P7" || pTipoOrfanizacao == "ME" && (pCodProfissional == "" || pCodProfissional == null)) {
					DevExpress.ui.notify("Organizador desativado..","warning",1500);
					return false;
				}
				$("#divTO"+tipoOrganizacao).css({background: "#ffffff", border: "1px solid #cccccc;"})
				tipoOrganizacao = pTipoOrfanizacao;
				$("#divTO"+tipoOrganizacao).css({background: "#D6E6F3", border: "1px solid #337AB7;"})
      	listarAgenda();  
			}
			
			objCalendario = $("#divCalendario").dxCalendar({
				maxZoomLevel:"month",
				minZoomLevel:"month",
				dateSerializationFormat: "yyyy-MM-dd",
				onOptionChanged: function(e) {
        	if (e.name == "currentDate") {
	        	xDateDx = new Date(e.value)
	        	pData = xDateDx.getDate()+"/"+(xDateDx.getMonth()+1)+"/"+xDateDx.getFullYear();
        	}
        },
        onValueChanged: function(e) {
        	pDataAgenda = new Number(#server(VAR.CSP.VARAgendaMedica.GetDataFormatada(e.value))#);
        	listarAgenda();  
        }
			}).dxCalendar("instance");
			
			objPaciente = $("#divPaciente").dxSelectBox({
				dataSource: new DevExpress.data.DataSource({
					store: new DevExpress.data.CustomStore({
						byKey: function(args) {
							return $.getJSON(urlSearch,{
								method				:	"GetPaciente",
								pCodPaciente	: args,
							});
						},
						load: function(args) {
							return $.getJSON(urlSearch,{
								method				:	"GetPaciente",
								pSkip					:	args.skip,
								pTake					:	args.take,
								pSearchValue	:	args.searchValue,
							});
						}
					})
				}),
				searchEnabled: true,
				valueExpr: "Codigo", 
				displayExpr: "Nome",
				showClearButton: true,
				onValueChanged: function(e) {
					codPacientePesq = e.value;
					listarAgenda();
				}
			}).dxSelectBox("instance");
			
			objHistoricoPaciente = $("#divHistoricoPaciente").dxButton({
				icon: "fas fa-book",
				text: "Histórico",
				type: "default",
				width: "96%",
				disabled: flagPEP, 
				stylingMode : "contained",
				onClick	: function(){
					totMinutos	= 0;
					totSegundos	= 0;
					$("#divRegistrarAtendimento").dxPopup("show");
					objRegistrarAtendimento = $("#divFormRegistrarAtendimento").dxForm("instance");
					montarCampoPaciente(1);
					objRegistrarAtendimento.getEditor("descricao").option({"readOnly": true, value: ""});
					$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", true);
					$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", true);
					$("#divRegistrarAtendimentoTempo").html("");
				}
			}).dxButton("instance");
			
			function formatarMes(container, options){
      	color = "";
      	if (options.data[options.columnIndex+"Cor"] == "C") {
        	color = "#d0d0d0;";
      	}
        if (options.data[options.columnIndex] == "0") {
        	container.html("<div style='text-align: left; height:65px;'>" +
              							"<span style='font-size:10px;color:"+color+";'>" + options.data[options.columnIndex+"Dt"] + "</span><br>&nbsp;"+
              						"</div>").css("background-color", "#f0f0f0");	 
        }else{
          container.html("<div style='text-align: left;height:65px;cursor:pointer;'>" +
              							"<table width='100%'>" +
              								"<tr><td colspan='2'><span style='font-size:10px;color:"+color+";'><b>" + options.data[options.columnIndex+"Dt"] + "</b></span></td></tr>"+
              								"<tr><td colspan='2' height='2px'></td></tr>"+
              								"<tr style='background-color: #d9ffd9;'><td width='115px' style='text-align: right;border-left:5px solid green;'><b>Qtde. Horários:&nbsp;</b></td><td>" + options.data[options.columnIndex] + "</td></tr>"+
              								"<tr style='background-color: #d9ffd9;'><td width='115px' style='text-align: right;border-left:5px solid green;background-color: #d9ffd9;'><b>Qtde. Agendados:&nbsp;</b></td><td>" + options.data[options.columnIndex+"Ag"] + "</td></tr>"+
              								"<tr style='background-color: #d9ffd9;'><td width='115px' style='text-align: right;border-left:5px solid green;background-color: #d9ffd9;'><b>Qtde. Atendidos:&nbsp;</b></td><td>" + options.data[options.columnIndex+"Ad"] + "</td></tr>"+
              						"</div>");
        }
			}
			
			function listarAgenda() {
	
				$("#divDadosConteudoRodape").css("display", "none");
				$("#divDadosConteudoTitulo").css("display", "none");
				$("#divDadosConteudoTitulo1").css("display", "none");
				$("#divDadosConteudo").css("marginTop", "3px");
				
				if ($("#divDadosConteudoLista")) $("#divDadosConteudoLista").remove();
				$("#divDadosConteudo").html("<div id='divDadosConteudoLista'></div>");

				var pCodProfissional = objMenuConteudo.getEditor("medico").option("value");
				
				if (pCodProfissional == "" || pCodProfissional == null) {
					$("#divDadosConteudoTitulo1").css("display", "block");
					var firstDayOfWeek = 0;
					var xTipoOrganizacao = "week";
					if (tipoOrganizacao == "DI") xTipoOrganizacao = "day";
					pDataAgendaF = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(""+pDataAgenda, 3))#;
					dia = new Number(pDataAgendaF.split("-")[2]);
					mes = new Number(pDataAgendaF.split("-")[1]);
					ano = new Number(pDataAgendaF.split("-")[0]);
					$.getJSON(urlPreparacao, {method: "ListarResumo", pDataInicio: pDataAgenda, 
					pTipoOrganizacao: tipoOrganizacao}, function(objRetorno){
						for (count = 0 ; count < objRetorno.dados.length ; count ++) {
							objRetorno.dados[count].inicio =	new Date(
																									objRetorno.dados[count].Ano,
																									objRetorno.dados[count].Mes,
																									objRetorno.dados[count].Dia,
																									objRetorno.dados[count].iHr,
																									objRetorno.dados[count].iMin,
																									0	
																								);
							objRetorno.dados[count].fim =	new Date(
																							objRetorno.dados[count].Ano,
																							objRetorno.dados[count].Mes,
																							objRetorno.dados[count].Dia,
																							objRetorno.dados[count].fHr,
																							objRetorno.dados[count].fMin,
																							0	
																						);
						}
						$("#divDadosConteudoLista").dxScheduler({
							timeZone: 'America/Sao_Paulo',
							editing: false,
							cellDuration: 30,
							resources: [{
								fieldExpr: "idGrupo", 
								allowMultiple: false,
								dataSource: objRetorno.resources
							}],
							appointmentTemplate: function(model) {
								conteudo = "<span style='font-size: 10px;'><b>"+model.appointmentData.descUnidade+"</b></span><br>" +
									"<span style='font-size: 10px;'><b>"+model.appointmentData.descSala+"</b></span><br>" +
									"<span style='font-size: 10px;'>"+model.appointmentData.hrIniAtendimento+" - "+
									model.appointmentData.hrFinAtendimento+"</span><br>" + 
									"<span style='font-size: 10px;'>"+model.appointmentData.nomeProfissional+"</span><br>" + 
									"<span style='font-size: 10px;'>("+model.appointmentData.descProcedimento+")</span><br>";
								return $("<div style='text-align:center;color:black;'>" + conteudo + "</div>");
							},
							onContentReady: function(e) {
								var currentHour = new Date().getHours() - 1;
								e.component.scrollToTime(currentHour, 30, new Date());
							},
							onAppointmentClick: function(e) {
								e.cancel = true;
							},
							onAppointmentDblClick: function(e) {
								e.cancel = true;
							},
							shadeUntilCurrentTime: false,
							firstDayOfWeek: 0,
							views: [xTipoOrganizacao],
							currentView: xTipoOrganizacao,
							currentDate: new Date(ano, mes, dia),
							startDayHour: objRetorno.startDayHour,
							endDayHour: (objRetorno.endDayHour == 0 ? 23 : objRetorno.endDayHour),
							height: function() { 
								var xHeight = window.innerHeight - 85;
								return (xHeight < 628 ? 628 : xHeight); 
							},
							textExpr: "text",
							startDateExpr: "inicio",
							endDateExpr: "fim", 
							dateSerializationFormat: "yyyy-MM-ddTHH:mm:ss",
							showAllDayPanel: false,
							dataSource: objRetorno.dados,
							width: objRetorno.width
						});
					});
					return					
				}
					
				if (tipoOrganizacao == "ME") {

					$.getJSON(urlPreparacao, {method: "GetAgendaMes", pCodProfissional: pCodProfissional, 
					pDataInicio: pDataAgenda},function(objRetorno){
						objAgenda = $("#divDadosConteudoLista").dxDataGrid({
							dataSource: objRetorno.dados,
							columns: [
								{	dataField: "0", caption: "Domingo", alignment: "center", width: "10%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "1", caption: "Segunda-Feira", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "2", caption: "Terça-Feira", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "3", caption: "Quarta-Feira", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "4", caption: "Quinta-Feira", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "5", caption: "Sexta-Feira", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
								{	dataField: "6", caption: "Sábado", alignment: "center", width: "15%", minWidth: "150px", cellTemplate: formatarMes},
							],
							summary: {
	          		totalItems: [{
									name: "SelectedRowsSummary",
									showInColumn: 6,
									displayFormat: "Ocupação: {0}",
									summaryType: "custom"
	          		}],
								calculateCustomSummary: function (options) {
									options.totalValue = objRetorno.percOcupacao+"%";
								}
							},
							columnChooser: { enabled: false, mode: "dragAndDrop"},
							allowColumnReordering: false,
							editing: { mode: "popup", allowAdding: false, allowUpdating: false, allowDeleting: false, useIcons: true},
							columnAutoWidth: true,
							showColumnLines: true,
							showRowLines: true,
							rowAlternationEnabled: false,
							hoverStateEnabled: false,
							showBorders: true,
							headerFilter: { visible: false },
							grouping: { autoExpandAll: false },
							groupPanel: { visible: false, allowColumnDragging: true },
							columnFixing: { enabled: true },
							filterRow: { visible: false },
							sorting: {mode:"none"},
							export: { enabled: true },
							stateStoring: { enabled: false }, 
							wordWrapEnabled: true,
							searchPanel: { visible: false, placeholder: "Pesquisar por Paciente/Procedimento", width: 250 }, 
							paging: { enabled: false},
							onCellClick: function(e) {
								pDataAgenda = new Number(e.data[e.columnIndex+"DtI"]);
			        	selecionarTipoOrganizacao("DI");
								objCalendario.option("value",e.data[e.columnIndex+"DtF"]);
							},
    					onToolbarPreparing: function(e) {
				    		var dataGrid = e.component;
				        e.toolbarOptions.items.unshift({
									location: "before",
                  template	: function () {
										return	$("<div style='width:500px;text-align:left;'/>").append(
															$("<span>&nbsp; &nbsp;<b>"+objRetorno.mesAno+"</b></span>")
														);
                	}
								},{
									location: "after",
									widget: "dxButton",
									options: {
										icon: "chevrondoubleleft",
										hint: "Semana Anterior",
										onClick: function(e) {
											dataAtual = new Number("#(+$Horolog)#");
											if (tipoOrganizacao == "P7") {
												if ((pDataAgenda - 7) >= dataAtual) {
													pDataAgenda				= pDataAgenda - 7;
													pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}else{
													pDataAgenda				= dataAtual;
													pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada("#(+$Horolog)#", 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}
											}else if (tipoOrganizacao == "DI") {
												if ((pDataAgenda - 1) >= dataAtual) {
													pDataAgenda				= pDataAgenda - 1;
													pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}
											}else if (tipoOrganizacao == "SE") {
												if ((pDataAgenda - 7) >= dataAtual) {
													pDataAgenda				= pDataAgenda - 7;
													pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}
											}else{
												pDataAgenda				= pDataAgenda - 30;
												pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
												objCalendario.option("value",pDataAgendaForm);
												listarAgenda()
											}
										}
									}
								},{
									location: "after",
									widget: "dxButton",
									options: {
										icon: "chevrondoubleright",
										hint: "Próxima Semana",
										onClick: function(e) {
											if (tipoOrganizacao == "P7") {
												pDataAgenda	= pDataAgenda + 1;
												pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
												objCalendario.option("value",pDataAgendaForm);
												listarAgenda()
											}else if (tipoOrganizacao == "DI") {
												pDataAgenda	= pDataAgenda + 1;
												pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
												objCalendario.option("value",pDataAgendaForm);
												listarAgenda()
											}else if (tipoOrganizacao == "SE") {
												pDataAgenda	= pDataAgenda + 7;
												pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
												objCalendario.option("value",pDataAgendaForm);
												listarAgenda()
											}else{
												pDataAgenda				= pDataAgenda + 30;
												pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
												objCalendario.option("value",pDataAgendaForm);
												listarAgenda()
											}
										}
									}
								})
				    	}
						}).dxDataGrid("instance");
					});
				}else{
					$("#divDadosConteudoTitulo").css("display", "block");
					$("#divDadosConteudoRodape").css("display", "block").html("<b>Ocupação: %</b>");
					var firstDayOfWeek = 0;
					var xTipoOrganizacao = "week";
					if (tipoOrganizacao == "DI") xTipoOrganizacao = "day";
					if (tipoOrganizacao == "P7") {
						firstDayOfWeek = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(""+pDataAgenda, 2))#;
					}	
					pDataAgendaF = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(""+pDataAgenda, 3))#;
					dia = new Number(pDataAgendaF.split("-")[2]);
					mes = new Number(pDataAgendaF.split("-")[1]);
					ano = new Number(pDataAgendaF.split("-")[0]);
					
					$.getJSON(urlPreparacao, {method:	"ListarAgendaScheduler", pCodProfissional: pCodProfissional, 
					pDataInicio: pDataAgenda, pTipoOrganizacao: tipoOrganizacao, pCodPaciente: codPacientePesq},
					function(objRetorno){
					
						console.log(objRetorno)
						
						for (count = 0 ; count < objRetorno.Dados.length ; count ++) {
							objRetorno.Dados[count].inicio =	new Date(
																									objRetorno.Dados[count].Ano,
																									objRetorno.Dados[count].Mes,
																									objRetorno.Dados[count].Dia,
																									objRetorno.Dados[count].iHr,
																									objRetorno.Dados[count].iMin,
																									0	
																								);
							objRetorno.Dados[count].fim =	new Date(
																							objRetorno.Dados[count].Ano,
																							objRetorno.Dados[count].Mes,
																							objRetorno.Dados[count].Dia,
																							objRetorno.Dados[count].fHr,
																							objRetorno.Dados[count].fMin,
																							0	
																						);
						}
						$("#divDadosConteudoLista").dxScheduler({
							timeZone: 'America/Sao_Paulo',
							editing: false,
							cellDuration: 15,
							resources: [{
								fieldExpr: "idGrupo", 
								allowMultiple: false,
								dataSource: objRetorno.Resources
							}],
							appointmentTemplate: function(model) {
								if (model.appointmentData.numAdmissao == "" || model.appointmentData.numAdmissao == null) {
									conteudo = "<span style='font-size: 10px;'>"+model.appointmentData.descGrpAgend+"</span>";
								}else{
									var xIcone = "";
									if (model.appointmentData.flagIcone == 2) {
										xIcone = "<i class='fas fa-thumbs-up' title='Admitido em: "+model.appointmentData.dataHoraAdmissao+"' style='color:green'></i>";
									}else if (model.appointmentData.flagIcone == 3) {
										xIcone = "<i class='fas fa-thumbs-down' title='Não compareceu' style='color:red'></i>";
									}
									if (model.appointmentData.encaixe == 1) {
										xIcone = (xIcone = "" ? "" : "&nbsp;") + 
											"<i class='fas fa-exclamation-triangle' title='Encaixe' style='color:black;'></i>"
									}	
									conteudo = 	"<span style='font-size: 10px;'>" + (xIcone = "" ? "" : xIcone+" &nbsp;") + 
															"<b>"+model.appointmentData.nomePaciente+"</b></span>"; 
									if (model.appointmentData.telefone != "") {
										conteudo += "<br><span style='font-size: 10px;'>"+model.appointmentData.telefone+"</span>";
									}
									conteudo += "<br><span style='font-size: 10px;'>"+model.appointmentData.descProcedimento+"</span>";
								}
								return $("<div style='text-align:center;color:black;'>" + conteudo + "</div>");
							},
							onContentReady: function(e) {
								var currentHour = new Date().getHours() - 1;
								e.component.scrollToTime(currentHour, 30, new Date());
							},
							onAppointmentClick: function(e) {
								selecionarPaciente(
									e.appointmentData.dataAtendimento,
									e.appointmentData.flagIcone,
									e.appointmentData.codPaciente,
									e.appointmentData.numAdmissao
								);
								e.cancel = true;
							},
							onAppointmentDblClick: function(e) {
								e.cancel = true;
							},
							shadeUntilCurrentTime: (codPacientePesq == "" || codPacientePesq == null ? true : false),
							firstDayOfWeek: firstDayOfWeek,
							views: [xTipoOrganizacao],
							currentView: xTipoOrganizacao,
							currentDate: new Date(ano, mes, dia),
							startDayHour: objRetorno.menorTempoAtend,
							endDayHour: (objRetorno.maiorTempoAtend == 0 ? 23 : objRetorno.maiorTempoAtend),
							height: function() { 
								var xHeight = window.innerHeight - 85;
								return (xHeight < 628 ? 628 : xHeight); 
							},
							textExpr: "text",
							startDateExpr: "inicio",
							endDateExpr: "fim", 
							dateSerializationFormat: "yyyy-MM-ddTHH:mm:ss",
							showAllDayPanel: false,
							dataSource: objRetorno.Dados
						});
						$("#divDadosConteudoRodape").css("display", "block").html("<b>Ocupação: "+objRetorno.percOcupacao+"%</b>");
					});
					
					return
					$.getJSON(urlPreparacao, {method:	"ListarAgenda", pCodProfissional: pCodProfissional, 
						pDataInicio: pDataAgenda, pTipoOrganizacao: tipoOrganizacao},function(objRetorno){
							objAgenda = $("#divDadosConteudoLista").dxDataGrid({
								dataSource: objRetorno.Dados,
								columns: objRetorno.Columns,
								rowTemplate: function(container, item) {
									var data = item.data;
									var markup = "<tbody class='employee dx-row dx-row1'>" +
										"<tr>" +
											"<td align='center' style='border:1px solid #dddddd;'>" + data.horadeAtendimento + "</td>";  
							    for (count = 1; count < objRetorno.Columns.length ; count ++ ){
										if (objRetorno.Columns[count].descosid == 1) {
											markup += "<td align='center' style='border:1px solid #dddddd;'></td>";
										}else{
											for (countSeq = 0; countSeq < objRetorno.Columns[count].columns.length ; countSeq ++ ){
												var dataField = objRetorno.Columns[count].columns[countSeq].dataField;
												if (typeof data[dataField] != "undefined"){
													var backGround = data[dataField+"backGround"];
													var corBorder = "#dddddd";
													if (backGround == "#d9ffd9") var corBorder = "green";
													if (backGround == "#ddedff") var corBorder = "blue";
													if (backGround == "#ffcaca") var corBorder = "red";
													var conteudo = data[dataField];
													aConteudo = conteudo.split("~");
													if (aConteudo[0]=="") {
														var xConteudo = "";	
													}else{
														/*	flagIcone: 	0 - Sem Agendamento
													 	 								1 - Com Agendamento
													 									2 - Com Agendamento e Admitido
													 									3 - Com Agendamento e Não Admitido*/
														
														var xIcone = "";
														if (aConteudo[5] == 2) {
															xIcone = "<i class='fas fa-thumbs-up' title='Admitido em: "+aConteudo[4]+"' style='color:green'></i>";
														}else if (aConteudo[5] == 3) {
															xIcone = "<i class='fas fa-thumbs-down' title='Não compareceu' style='color:red'></i>";
														}
														var xConteudo = "<table width='100%' border=0 style='cursor:pointer;' " +
														"OnClick=selecionarPaciente('"+aConteudo[6]+"','"+aConteudo[5]+"','"+aConteudo[7]+"','"+aConteudo[0]+"');" +
														"><tr>"+
														"<td colspan='2' style='text-align:center;font-size:12px;'>"+aConteudo[1]+"</td>";
														if (aConteudo[2] != "") {
															xConteudo += "</tr><tr><td rowspan='2' style='text-align:center;font-size:10px;'>";
															xConteudo += xIcone;
															xConteudo += "</td><td style='font-size:10px;text-align:center;'>"+aConteudo[2]+"</td>";
															xConteudo += "</tr><tr><td style='font-size:10px;text-align:center;'>"+aConteudo[3]+"</td>";
														}else{
															xConteudo += "</tr><tr><td style='text-align:center;font-size:10px;'>";
															xConteudo += xIcone;
															xConteudo += "</td><td style='font-size:10px;text-align:center;'>"+aConteudo[3]+"</td>";
														}
														dFEncaixe = dataField.replace("C", "E");
														if (data[dFEncaixe] != "") {
															xConteudo += "</tr><tr><td height='10px'></td></tr></table>";
															var retorno =  #server(VAR.CSP.VARAgendaMedica.GetEncaixe(pCodProfissional, data[dFEncaixe]))#;
															if (retorno != "") {
																var arrayRet = retorno.split("~")
																var xIcone = "";
																if (arrayRet[5] == 2) {
																	xIcone = "<i class='fas fa-thumbs-up' title='Admitido em: "+arrayRet[4]+"' style='color:green'></i>";
																}else if (arrayRet[5] == 3) {
																	xIcone = "<i class='fas fa-thumbs-down' title='Não compareceu' style='color:red'></i>";
																}
																xConteudo += "<table width='100%' border=0 style='cursor:pointer;' " +
																"OnClick=selecionarPaciente('"+arrayRet[6]+"','"+arrayRet[5]+"','"+arrayRet[7]+"','"+arrayRet[0]+"');" +
																"><tr><td height='10px' colspan='2' style='border-top:1px solid #cccccc;'></td></tr><tr>"+
																"<td colspan='2' style='text-align:center;font-size:12px;'>" +
																	arrayRet[1] +
																	"&nbsp; <i class='fas fa-exclamation-triangle' title='Encaixe' style='color:black;'></i>"
																"</td>";
																if (arrayRet[2] != "") {
																	xConteudo += "</tr><tr><td rowspan='2' style='text-align:center;font-size:10px;'>";
																	xConteudo += xIcone;
																	xConteudo += "</td><td style='font-size:10px;text-align:center;'>"+arrayRet[2]+"</td>";
																	xConteudo += "</tr><tr><td style='font-size:10px;text-align:center;'>"+arrayRet[3]+"</td>";
																}else{
																	xConteudo += "</tr><tr><td style='text-align:center;font-size:10px;'>";
																	xConteudo += xIcone;
																	xConteudo += "</td><td style='font-size:10px;text-align:center;'>"+arrayRet[3]+"</td>";
																}
																xConteudo += "</tr></table>";
															} //<i class="fab fa-etsy"></i>
														}else{
															xConteudo += "</tr></table>";
														}
													}
													markup += "<td align='center' style='background:"+backGround+";" + 
													"border-top:1px solid "+corBorder+";border-left:1px solid "+corBorder+";" +
													"border-right:1px solid "+corBorder+";";
													if (data[dataField+"rowSpan"] == 1) {
														markup += "border-bottom:1px solid "+corBorder+";"
													}
													markup += "'>";
													if (data[dataField+"restricao"] != "") {
														markup += "<i class='fas fa-exclamation-circle' title='Restrição: "+data[dataField+"restricao"]+"'></i>&nbsp;"
													}
													markup += xConteudo+"</td>";
												}else{
													var backGround = data[dataField+"backGround"];
													var corBorder = "#dddddd";
													if (backGround == "#d9ffd9") var corBorder = "green";
													if (backGround == "#ddedff") var corBorder = "blue";
													if (backGround == "#ffcaca") var corBorder = "red";
													if (data[dataField+"rowSpan"] <= 0) {
														markup += "<td align='center' style='background:ffffff;" +  
														"border-left:1px solid #dddddd;;border-right:1px solid #dddddd;";
														markup += "border-top:1px solid #dddddd;"
														markup += "border-bottom:1px solid #dddddd;"
														markup += "'></td>";
													}else{
														markup += "<td align='center' style='background:"+backGround+";" +  
														"border-left:1px solid "+corBorder+";border-right:1px solid "+corBorder+";";
														if (data[dataField+"rowSpan"] == 1 && backGround == "#ffffff") {
															markup += "border-top:1px solid "+corBorder+";"
														}
														if (data[dataField+"rowSpan"] == 1) {
															markup += "border-bottom:1px solid "+corBorder+";"
														}
														markup += "'></td>";
													}
												}
											}
										}
							    }
									markup += 
										"</tr>" +
									"</tbody>";
									container.append(markup);
								},
								customizeColumns: function (columns) {
									$.each(columns, function (index, element) {
										if (element.caption.indexOf("/") != -1) {
											element.headerCellTemplate = function (header, info) {
												$('<div>').html("<span style='font-size:14px;'>" + 
												info.column.caption+"</span>").css('font-size', '16px').appendTo(header);
											};
										}else if (element.dataField != "horadeAtendimento") {
												element.headerCellTemplate = function (header, info) {
													if (element.descosid == 1 || element.dataAtual > element.dataAgend ) {
														$('<div>').html("<span style='font-size:12px;'>" + 
															info.column.caption+"</span>").css('font-size', '14px').appendTo(header);
													}else{
														conteudo = "<span style='font-size:12px;'>" + 
															info.column.caption+ "</span>";
														
														$('<div>').html(conteudo).css('font-size', '14px').appendTo(header);
													}
											};
										}									
									});
								},
								summary: {
	            		totalItems: objRetorno.Summary,
									calculateCustomSummary: function (options) {
										options.totalValue = objRetorno.PercOcupacao+"%";
									}
								},
								columnChooser: { enabled: false, mode: "dragAndDrop"},
								allowColumnReordering: false,
								editing: { mode: "popup", allowAdding: false, allowUpdating: false, allowDeleting: false, useIcons: true},
								columnAutoWidth: true,
								showColumnLines: true,
								showRowLines: true,
								rowAlternationEnabled: true,
								hoverStateEnabled: true,
								showBorders: true,
								headerFilter: { visible: false },
								grouping: { autoExpandAll: false },
								groupPanel: { visible: false, allowColumnDragging: true },
								columnFixing: { enabled: true },
								filterRow: { visible: false },
								sorting: {mode:"none"},
								height: function() { 
									var xHeight = window.innerHeight - 20;
									return (xHeight < 690 ? 690 : xHeight); 
								},
								export: { enabled: true },
								stateStoring: { enabled: false }, 
								wordWrapEnabled: true,
								searchPanel: { visible: true, placeholder: "Pesquisar por Paciente/Procedimento", width: 250 }, 
								paging: { enabled: false},
								onToolbarPreparing: function(e) {
					    		var dataGrid = e.component;
					        e.toolbarOptions.items.unshift({
										location: "before",
	                  template	: function () {
											return	$("<div style='width:500px;text-align:left;'/>").append(
																$("<span><b>Legenda: &nbsp;</b></span>" + 
																	"<span style='height: 20px; background-color: #d9ffd9;border-radius: 2px;" + 
																	"display: inline-block;vertical-align: middle;'>&nbsp; Horário Livre &nbsp;</span>" + 
																	"<span>&nbsp; <span>" +
																	"<span style='height: 20px; background-color: #ddedff;border-radius: 2px;" + 
																	"display: inline-block;vertical-align: middle;'>&nbsp; Horário com Paciente &nbsp;</span>" + 
																	"<span>&nbsp; <span>" +
																	"<span style='height: 20px; background-color: #ffcaca;border-radius: 2px;" + 
																	"display: inline-block;vertical-align: middle;'>&nbsp; Ausência (Bloqueado) &nbsp;</span>"  
																)
															);
	                	}
									},{
										location: "after",
										widget: "dxButton",
										options: {
											icon: "chevrondoubleleft",
											hint: "Semana Anterior",
											onClick: function(e) {
												dataAtual = new Number("#(+$Horolog)#");
												if (tipoOrganizacao == "P7") {
													if ((pDataAgenda - 7) >= dataAtual) {
														pDataAgenda				= pDataAgenda - 7;
														pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
														objCalendario.option("value",pDataAgendaForm);
														listarAgenda()
													}else{
														pDataAgenda				= dataAtual;
														pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada("#(+$Horolog)#", 1))#;
														objCalendario.option("value",pDataAgendaForm);
														listarAgenda()
													}
												}else if (tipoOrganizacao == "DI") {
													if ((pDataAgenda - 1) >= dataAtual) {
														pDataAgenda				= pDataAgenda - 1;
														pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
														objCalendario.option("value",pDataAgendaForm);
														listarAgenda()
													}
												}else if (tipoOrganizacao == "SE") {
													if ((pDataAgenda - 7) >= dataAtual) {
														pDataAgenda				= pDataAgenda - 7;
														pDataAgendaForm	 	= #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
														objCalendario.option("value",pDataAgendaForm);
														listarAgenda()
													}
												}else{
		
												}
											}
										}
									},{
										location: "after",
										widget: "dxButton",
										options: {
											icon: "chevrondoubleright",
											hint: "Próxima Semana",
											onClick: function(e) {
												if (tipoOrganizacao == "P7") {
													pDataAgenda	= pDataAgenda + 1;
													pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}else if (tipoOrganizacao == "DI") {
													pDataAgenda	= pDataAgenda + 1;
													pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}else if (tipoOrganizacao == "SE") {
													pDataAgenda	= pDataAgenda + 7;
													pDataAgendaForm	 = #server(VAR.CSP.VARAgendaMedica.GetDataFormatada(pDataAgenda, 1))#;
													objCalendario.option("value",pDataAgendaForm);
													listarAgenda()
												}else{
		
												}
											}
										}
									})
					    	}
							}).dxDataGrid("instance");
						}
					);
				}	
			}
			
			function selecionarPaciente(pDataAtendimento, pSituacao, pCodPaciente, pNumAdmissao){
				if (pCodPaciente == "") return
				
				codPaciente 	= pCodPaciente;
				nomePaciente	= #server(User.Search.PesquisasJson.GetPatientName(codPaciente))#;
				numAdmissao 	= pNumAdmissao;

				if (pSituacao != 2 || pDataAtendimento != "#(+$Horolog)#" || codMedico == "") {
					totMinutos	= 0;
					totSegundos	= 0;
					$("#divRegistrarAtendimento").dxPopup("show");
					objRegistrarAtendimento = $("#divFormRegistrarAtendimento").dxForm("instance");
					montarCampoPaciente(2);
					$("#divRegistrarAtendimentoPacienteCampo").dxTextBox("instance").option("value", nomePaciente);
					objRegistrarAtendimento.getEditor("descricao").option({"readOnly": true, value: ""});
					$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", true);
					$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", true);
					$("#divRegistrarAtendimentoTempo").html("");
					numAdmissao = "";
					dataSourceHistorico.reload();
				}else {
					$.getJSON(urlPreparacao,{method:"GetDescricao",pCodPaciente: codPaciente, pNumAdmissao: pNumAdmissao},
					function(objRetorno){
						if (objRetorno.finalizado != "") {
							$("#divRegistrarAtendimento").dxPopup("show");
							$("#divRegistrarAtendimentoTempo").html("");
							objRegistrarAtendimento = $("#divFormRegistrarAtendimento").dxForm("instance");
							montarCampoPaciente(2);
							$("#divRegistrarAtendimentoPacienteCampo").dxTextBox("instance").option("value", nomePaciente);
							objRegistrarAtendimento.getEditor("descricao").option({"readOnly": true, value: ""});
							$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", true);
							$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", true);
							numAdmissao = "";
							dataSourceHistorico.reload();
							return							
						}
						if (objRetorno.dtHrInicializacao != "") {
							totMinutos	= new Number(objRetorno.minutos);
							totSegundos	= new Number(objRetorno.segundos);
							if (typeof timeOut != "undefined") clearTimeout(timeOut);
							carregarTempoAtendimento();
						}
						$("#divRegistrarAtendimento").dxPopup("show");
						objRegistrarAtendimento = $("#divFormRegistrarAtendimento").dxForm("instance");
						montarCampoPaciente(2);
						$("#divRegistrarAtendimentoPacienteCampo").dxTextBox("instance").option("value", nomePaciente);
						if (objRetorno.dtHrInicializacao == "") {
							objRegistrarAtendimento.getEditor("descricao").option({"readOnly": true, value: objRetorno.descricao});
							$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", false);
							$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", true);
						}else{
							objRegistrarAtendimento.getEditor("descricao").option({"readOnly": false, value: objRetorno.descricao});
							$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", true);
							$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", false);
						}
						dataSourceHistorico.reload();
					});
				}
			}
			
			dataSourcePaciente = new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					byKey: function(args) {
						return $.getJSON(urlSearch,{
							method				:	"GetPaciente",
							pCodPaciente	: args,
						});
					},
					load: function(args) {
						return $.getJSON(urlSearch,{
							method				:	"GetPaciente",
							pSkip					:	args.skip,
							pTake					:	args.take,
							pSearchValue	:	args.searchValue,
						});
					}
				})
			});
			
			dataSourceHistorico = new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					loadMode: "raw",   
					load: function(){
						if (codPaciente == "" || codPaciente == null) return [];
	        	return $.getJSON(urlPreparacao, {method: "ListarHitorico", pCodPaciente: codPaciente,
	        	pNumAdmissao: numAdmissao});
					},
				})
			});

			$("#divRegistrarAtendimento").dxPopup({
				visible: false,
				title: "Registrar Atendimento / Histórico de Passagem",
				width: 900,
				height:  600,
				position: {
					my: "center",
					at: "center",
					of: window
				},
				dragEnabled: true,
				contentTemplate: function(e) {
					objRegistrarAtendimento = $("<div id='divFormRegistrarAtendimento'>").dxForm({
						readOnly: false,
						alignItemLabels: true,
						showColonAfterLabel: false,
						screenByWidth: function(width) { return "lg"; },
						labelLocation: "left",
						colCount: 2,
						items: [{
							colSpan: 2,
							label: { text: "Paciente:", alignment: "right"},
							template	: function (data, itemElement) {
								itemElement.append("<div id='divRegistrarAtendimentoPaciente'>")
							}
						},{
							colSpan: 2,
							dataField: "descricao", 
							label: { text: "Descrição:", alignment: "right"},
							editorType: "dxTextArea",
							editorOptions: {
								height: 70	
							}
						},{
							template	: function (data, itemElement) {
								itemElement.append("<div id='divRegistrarAtendimentoTempo'>")
							}
						},{
							template	: function (data, itemElement) {
								itemElement.append("<div id='divRegistrarAtendimentoAcao'>")
							}
						},{
							colSpan: 2,
							template	: function (data, itemElement) {
								itemElement.append("<div id='divListarResgistros'>")
							}
						}]
					});
					e.append(objRegistrarAtendimento);

					$("#divRegistrarAtendimentoAcao").html("<table width='100%'>" +
																		"<tr>" +
																			"<td align='right'>" + 
																				"<div id='divRegistrarAtendimentoInicio'/>&nbsp;" +
																			"</td><td align='right'>"  +
																				"<div id='divRegistrarAtendimentoFinalizar'/>&nbsp;" +
																			"</td><td align='right'>"  +
																				"<div id='divRegistrarAtendimentoCancelar'/>" + 
																			"</td>" +
																		"</tr>" +
																"</table>");


					objRegAtendInicio = $("#divRegistrarAtendimentoInicio").dxButton({
					  text	: "Inicializar Atendimento",
					  type	: "success",
					  stylingMode : "contained",
					  onClick	: function(){
						  $.get(urlPreparacao,{method:"InicializaHitorico",pCodPaciente: codPaciente, 
						  pNumAdmissao: numAdmissao},function(retorno){
								if (retorno ==1 ){
									DevExpress.ui.notify("Atendimento inicializado!","success");
									objRegistrarAtendimento.getEditor("descricao").option({"readOnly": false});
									$("#divRegistrarAtendimentoInicio").dxButton("instance").option("disabled", true);
									$("#divRegistrarAtendimentoFinalizar").dxButton("instance").option("disabled", false);
									if (typeof timeOut != "undefined") clearTimeout(timeOut);
									carregarTempoAtendimento();
								}else{
									DevExpress.ui.notify("Erro: "+retorno,"error");
								}
							});
					  }
					}).dxButton("instance");	

					objRegAtendFinalizar = $("#divRegistrarAtendimentoFinalizar").dxButton({
					  text	: "Finalizar Atendimento",
					  type	: "success",
					  stylingMode : "contained",
					  onClick	: function(){
						  pDescricao = objRegistrarAtendimento.getEditor("descricao").option("value");
							$.get(urlPreparacao,{method:"SalvarHitorico",pCodPaciente: codPaciente, pNumAdmissao: numAdmissao,
							pDescricao: pDescricao},function(retorno){
								if (retorno ==1 ){
									DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
									totMinutos = 0;
									totSegundos = 0;
									if (typeof timeOut != "undefined") clearTimeout(timeOut);
									$("#divRegistrarAtendimento").dxPopup("hide");	
								}else{
									DevExpress.ui.notify("Erro: "+retorno,"error");
								}
							});
					  }
					}).dxButton("instance");	

					objRegAtendCancelar = $("#divRegistrarAtendimentoCancelar").dxButton({
					  text	: "Cancelar",
					  type	: "default",
					  stylingMode : "contained",
					  onClick	: function(){
						  codPaciente	= "";
						  numAdmissao	= "";
						  if (typeof timeOut != "undefined") clearTimeout(timeOut);
							$("#divRegistrarAtendimento").dxPopup("hide");	
					  }
					}).dxButton("instance");

					objListarResgistros = $("#divListarResgistros").dxDataGrid({
						dataSource: dataSourceHistorico,
						columns: [
							{dataField: "dataHora", caption: "Data/Hora Atendimento", alignment: "center", width: "110px", minWidth: "110px"},
							{dataField: "tipoConsulta", caption: "Procedimento", alignment: "center", width: "220px", minWidth: "220px"},
							{dataField: "descricao", caption: "Descrição", alignment: "center", width: "100%"},
							{dataField: "tempoAtendimento", caption: "Tempo de Atendimento", alignment: "center", width: "90"},
						],
						columnChooser: { enabled: false, mode: "dragAndDrop"},
						allowColumnReordering: false,
						editing: { mode: "popup", allowAdding: false, allowUpdating: false, allowDeleting: false, useIcons: true},
						columnAutoWidth: true,
						showColumnLines: true,
						showRowLines: true,
						rowAlternationEnabled: true,
						hoverStateEnabled: false,
						showBorders: true,
						headerFilter: { visible: false },
						grouping: { autoExpandAll: false },
						groupPanel: { visible: false, allowColumnDragging: true },
						columnFixing: { enabled: true },
						filterRow: { visible: false },
						sorting: {mode:"none"},
						height: 390,
						export: { enabled: true },
						stateStoring: { enabled: false }, 
						wordWrapEnabled: true,
						searchPanel: { visible: true}, 
						paging: { enabled: false},
					}).dxDataGrid("instance");
				}
			});
			
			function carregarTempoAtendimento() {
				totSegundos = totSegundos + 1;
				if (totSegundos == 60) {
					totSegundos = 0
					totMinutos = totMinutos + 1;
				}
				conteudo = totMinutos+"m "+totSegundos+"s";
				$("#divRegistrarAtendimentoTempo").html("<b>Tempo de Atendimento: </b>"+conteudo+"</span>");
				timeOut = setTimeout(function(){ carregarTempoAtendimento(); }, 1000);	
			}

			function montarCampoPaciente(pTipo){
				if ($("#divRegistrarAtendimentoPacienteCampo")) $("#divRegistrarAtendimentoPacienteCampo").remove();
				$("#divRegistrarAtendimentoPaciente").html("<div id='divRegistrarAtendimentoPacienteCampo'></div>");

				if (pTipo == 1) {	
					$("#divRegistrarAtendimentoPacienteCampo").dxSelectBox({
						dataSource: dataSourcePaciente,
						searchEnabled: true,
						valueExpr: "Codigo", 
						displayExpr: "Nome",
						showClearButton: true,
						value: codPacientePesq,
		        itemTemplate: function(data) {
			        return	"<div class='custom-item'>" +
			        					"<div>" + data.Nome + "</div>" +
			        					"<div style='color:red;font-size:10px'>Dt. Nasc.: " + data.Nascimento + 
			        					" &nbsp; Prontuário: " + data.Prontuario + " &nbsp; CPF: " + data.CPF +
			        					"</div>" +
			        				"</div>";
		        },
						onValueChanged: function(e) {
							codPaciente = e.value;
							dataSourceHistorico.reload();
						}
					});
				}else{
					$("#divRegistrarAtendimentoPacienteCampo").dxTextBox({
						readOnly: true
					});				
				}
			}

   </script>

		</script>
	</body>
</html>
