<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
	<script language="Cache" runat="server">
		do ^WWWVAR
 
		set YUSER = $get(%request.Data("YUSER", 1))
		set YBED = $get(%request.Data("YBED", 1))
		set YM = $get(%request.Data("YM", 1))
		set YLOCATION = $get(%request.Data("YLOCATION", 1))
		set READONLY = $get(%request.Data("RO", 1))

		set PortCache = $get(%request.CgiEnvs("SERVER_PORT"))
		set PageURL = $get(%request.CgiEnvs("CACHE_URL"))
		set PageName = %request.PageName
		set app = %request.Application
		set host = %request.CgiEnvs("HTTP_HOST")
		set url = "http://"_host_app

		set URLPreparacao = "VAR.CSP.VARContrAtendTransfusional.cls"
		set URLPreparacaoQui = "VAR.CSP.VARContrAtendQuimioterapico.cls"
    set URLPreparacaoPEP = "VAR.CSP.VARProntuarioEletronico.cls?EP=1&YBED="_YBED_"&YUSER="_YUSER_"&YLOCATION="_YLOCATION

		set URLLogin = "COMLogin.cls"
		set URLLink = "www.cls"

		set nomeLocal = YLOCATION_" - "_$$SQLGetLocationName^VARSQL(YLOCATION)

		//Verifica se a sessão
		set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
		
		set pAdmissao 			= $get(%request.Data("pAdmissao",1)) 
		set pCodProntuario 	= $get(%request.Data("pCodProntuario",1))
		Set flagUsuarioMedico = +$$GetChecaMedico^VARSQL(YBED)
	</script>
	<head>
		<title>Prontuário Transfusional</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">

		<!-- Font Awesome -->
		<link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

		<!-- Custom Elements -->
		<link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
		<link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
		<link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />

		<!-- DevExtreme themes -->
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.light.css" />

		<style>
		*{
			font-family: Arial, Helvetica, sans-serif;
		}
		.normal {
			padding: 2px;
			border: 0px solid green;
			text-align: center;
		}
		.titulo {
			padding: 2px;
			padding-top: 5px;
			padding-right: 3px;
			border: 0px solid red;
			text-align: right;
			font-weight: bold;
		}
		.tituloNormal {
			padding: 2px;
			padding-top: 5px;
			padding-right: 3px;
			border: 0px solid red;
			text-align: left;
		}
		.tituloRadio {
			padding: 2px;
			padding-top: 5px;
			padding-right: 3px;
			border: 0px solid red;
			text-align: right;
			font-weight: bold;
		}
		.tituloRadioNormal {
			padding: 2px;
			padding-top: 3px;
			padding-right: 3px;
			border: 0px solid red;
			text-align: right;
		}
		.campo {
			padding: 2px;
			border: 0px solid blue;
		}
		.divAvatar {
		  position: absolute;
			margin-top: 10px;
			margin-left: 2px;	
		}
		.divCicleAvatar {
		  background-color: #aaa;
		  border-radius: 50%;
		  width: 100px;
		  height: 100px;
		  overflow: hidden;
		  position: relative;
	    border: 1px solid #e9e9e9;
		}
		.divAvatar img {
		  position: absolute;
		  bottom: 0;
		  width: 100%;
		  padding: 0px;
		}
		.dx-button-content {
			padding-bottom: 10px;
		}
		#selectRTBolsas .dx-button-content {
			padding: 0 !important;
		}
		
		.d-flex {
			display: flex;
		}
		.flex-align-center {
			align-items: center;
		}
		.flex-justify-between {
			justify-content: space-between;
		}
		
		
		@keyframes fa-blink {
			0% { opacity: 1; }
			50% { opacity: 0.5; }
			100% { opacity: 0; }
		}
		.fa-blink {
			color: red;
			-webkit-animation: fa-blink 2.2s linear infinite;
			-moz-animation: fa-blink 2.2s linear infinite;
			-ms-animation: fa-blink 2.2s linear infinite;
			-o-animation: fa-blink 2.2s linear infinite;
			animation: fa-blink 2.2s linear infinite;
		}	
	</style>

		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/themes/css/alphalinc.css" id="style_color" />

	</head>
	<script type="text/javascript">
	var status = "#(status)#";
	var URLLogin = "#(URLLogin)#";
	if (status == 0) {
		alert("Usuário não está logado ou a sessão expirou.")
		window.location.replace(URLLogin)
	}
	</script>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<a class="navbar-brand" href="#">Contr. Atend. Ambulatorial - Transfusional</a>
				</div>
				<CSP:IF CONDITION="'READONLY"> <!-- quando apenas leitura não exibir botões -->
					<ul class="nav navbar-nav navbar-right">
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnSalvar">
								<span class="fa fa-save"></span> Salvar
							</button>
						</li>
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnAssinar" style="display:#($Select(flagUsuarioMedico=0:"none",1:"block"))#">
								<span class="fas fa-signature" id="spAssinar"></span> <span id="spAssinarTexto">Assinar</span>
							</button>
						</li>
						<li>
							<button type="button" title="Imprimir Termo" class="btn btn-info navbar-btn" id="btnImprimirTermo">
								<span class="fa fa-exclamation-circle"></span> Termo
							</button>
						</li>
						<li>
							<button type="button" title="Imprimir" class="btn btn-info navbar-btn" id="btnImprimir">
								<span class="fa fa-print"></span> Imprimir
							</button>
						</li>
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnImprimirEtiqueta">
								<span class="fa fa-print"></span> Imp. Etiqueta &nbsp;
							</button>
						</li>
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnFinalizar">
								&nbsp; Finalizar &nbsp;
							</button>
						</li>
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnArquivos">
								&nbsp; Arquivos &nbsp;
							</button>
						</li>					
						<li>
							<button type="button" class="btn btn-info navbar-btn" id="btnFechar">
								<span class="fas fa-times"></span> Fechar
							</button>
						</li>
					</ul>
				</CSP:IF>
			</div>
		</nav>
		<div class="container-fluid" style="margin:2px; margin-top:58px;min-width: 1280px;">
			<div class="row">
				<!--<div class="col-md-1">
					<div class="row">
						<div class="col-md-12">
							<div class="divAvatar"> 
								<div class="divCicleAvatar">
									<img class="imgAvatar" src="#(YGIF)#global/assets/images/avatars/profile_girl.jpg">
								</div>
							</div>
						</div>
					</div>
				</div>-->
				<div class="col-md-7">
					<div class="row">
						<div class="col-md-2 titulo">Prontuário/Código:</div>
						<div class="col-md-2 campo"><div id="textPronturario"></div></div>
						<div class="col-md-2 titulo">Admissão:</div>
						<div class="col-md-2 campo"><div id="textAdmissao"></div></div>
						<div class="col-md-2 titulo">Data/Hora:</div>
						<div class="col-md-2 campo"><div id="textDataHora"></div></div>
					</div>
					<div class="row">
						<div class="col-md-2 titulo">Sala:</div>
						<div class="col-md-4 campo"><div id="selectSala"></div></div>
						<div class="col-md-2 titulo">Leito:</div>
						<div class="col-md-4 campo"><div id="selectLeito"></div></div>
					</div>
					<div class="row">
						<div class="col-md-2 titulo">Paciente:</div>
						<div class="col-md-10 campo"><div id="textPaciente"></div></div>
					</div>
					<div class="row">
						<div class="col-md-3 titulo">Data Nascimento:</div>
						<div class="col-md-2 campo"><div id="textDataNascimento"></div></div>
						<div class="col-md-1 titulo">Idade:</div>
						<div class="col-md-2 campo"><div id="textIdade"></div></div>
						<div class="col-md-1 titulo">Sexo:</div>
						<div class="col-md-3 campo"><div id="textSexo"></div></div>
					</div>
				</div>
				<div class="col-md-4">
					<!--div class="row">
						<div class="col-md-4 titulo">DM:</div>
						<div class="col-md-8 campo"><div id="textDM"></div></div>
					</div>-->
					<div class="row">
						<div class="col-md-4 titulo">Diagnóstico:</div>
						<div class="col-md-8 campo"><div id="textDiagnostico"></div></div>
					</div>
					<!--<div class="row">
						<div class="col-md-3 titulo">Médico:</div>
						<div class="col-md-9 campo"><div id="selectMedico"></div></div>
					</div>-->
					<div class="row">
						<div class="col-md-4 titulo">Médico Responsável:</div>
						<div class="col-md-6 campo"><div id="selectMedicoExterno"></div></div>
						<div class="col-md-2 campo"><div id="divMedicoExternoAdd"></div></div>
					</div>
					<div class="row">
						<div class="col-md-4 titulo" id="divExibirAssinaturaTitulo">&nbsp;</div>
						<div class="col-md-8 tituloNormal" id="divExibirAssinatura" style="text-align: left">&nbsp;</div>
					</div>
				</div>
				<div class="col-md-1">
					<div class="row">
						<div class="col-md-12 normal">
							<div id="divIcones"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12" style="height:5px;"></div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<div id="divAbas"></div>
				</div>
			</div>
		</div>	
		<div id="divCadastrarEtiqueta"></div>
		<div id="openPesquisaCID"></div>
		<div id="divImprimirEtiqueta"></div>
		<div id="divCadastrarMedico"></div>
		<div id="openPesquisaArquivo"></div>
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src=" #(YGIF)#global/plugins/extreme19.2.4/js/jquery.min.js"></script>

		<!-- JSZip library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/jszip.min.js"></script>

	  <!-- A DevExtreme library -->
	  <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/dx.web.js"></script>
	  
	  <!-- DevExtreme-Intl module -->
	  <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/localization/dx.messages.pt.js"></script>

		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
		
		<script type="text/javascript" src="#(YGIF)#Zebra/BrowserPrint.js/BrowserPrint-2.0.0.75.min.js"></script>

		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/exceljs.min.js"></script>
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/FileSaver.min.js"></script>


		<!--Definições globais e criação de funcionalidades encapsuladas-->
		<script type="text/javascript">
		//Deixando variáveis disponíveis no cliente
		var urlPreparacao 	 = "#(URLPreparacao)#";
		var urlPreparacaoQui = "#(URLPreparacaoQui)#";
		var urlPreparacaoPEP = "#(URLPreparacaoPEP)#";
		var urlLink 				 = "#(URLLink)#";
		var YBED 						 = "#(YBED)#";
		var YGIF						 = "#(YGIF)#";
		var YUSER 					 = "#(YUSER)#";
		var YLOCATION 			 = "#(YLOCATION)#";
		var nomeLocal 			 = "#(nomeLocal)#";
		var pAdmissao				 = "#(pAdmissao)#";
		var pCodProntuario	 = "#(pCodProntuario)#";
		var carregarTela		 = 1;
		var CategoriaAnt		= "";
		var selected_device;
		var flagUsuarioMedico = "#(flagUsuarioMedico)#";
		var READONLY 					= "#(READONLY)#";
		//
		var height = window.innerHeight - 260;
		//
		DevExpress.config({decimalSeparator: ",",thousandsSeparator: "."});
		DevExpress.localization.locale("pt");
		//
		$(document).ready(function () {
			if (pCodProntuario != "") {
				recuperaProntuario(pCodProntuario);			
			}
			if (READONLY) {fnReadOnly(); setInterval(fnReadOnly, 1000);}
		});
		
		function fnReadOnly(){
			$('.dx-toolbar-button, .dx-button, .btn').css("visibility","hidden");
			$('#divReacaoTransfusional .dx-toolbar-button').css("visibility","hidden");
			$('.aba .dx-textbox').each(function(){ try { $(this).dxTextArea('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-texteditor').each(function(){ try { $(this).dxTextBox('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-checkbox').each(function(){ try { $(this).dxCheckBox('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-selectbox').each(function(){ try { $(this).dxSelectBox('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-selectbox').each(function(){ try { $(this).dxTagBox('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-numberbox').each(function(){ try { $(this).dxNumberBox('instance').option('readOnly',true) } catch (ex) {} })
			$('.aba .dx-radiogroup').each(function(){ try { $(this).dxRadioGroup('instance').option('disabled',true) } catch (ex) {} })
			$('.aba .dx-checkbox-icon').each(function(){ try { $(this).dxCheckBox('instance').option('disabled',true) } catch (ex) {} })
			$('.aba .dx-datebox').each(function(){ try { $(this).dxDateBox('instance').option('disabled',true) } catch (ex) {} })
		}
		
		//
		dataSourceProfissional = new DevExpress.data.DataSource({
			store: new DevExpress.data.CustomStore({
				load: function(args) {
					return $.getJSON(urlPreparacaoQui,{
						method:"CarregaProfissional", 
						pFiltro: args.searchValue,
						pTake: args.take, 
						pSkip: args.skip, 
						YLOCATION: YLOCATION
					});
				},
				byKey: function(args) {
					return $.getJSON(urlPreparacaoQui,{method:"CarregaProfissional", pKey: args, YLOCATION: YLOCATION});
				}
			})
		});
		dataSourceMedico = new DevExpress.data.DataSource({
			store: new DevExpress.data.CustomStore({
				load: function(args) {
					return $.getJSON(urlPreparacaoQui,{
						method:"CarregaProfissional", 
						pFiltro: args.searchValue,
						pTake: args.take, 
						pSkip: args.skip, 
						YLOCATION: YLOCATION, 
						//pFlagExterno: "E",
						pLicenseType: "2231"
					});
				},
				byKey: function(args) {
					return $.getJSON(urlPreparacaoQui,{
						method:"CarregaProfissional", 
						pKey: args, 
						YLOCATION: YLOCATION, 
						//pFlagExterno: "E"
					});
				}
			})
		});
		campoProntuario = $("#textPronturario").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoAdmissao = $("#textAdmissao").dxTextBox({readOnly: true, height: 27, value: pAdmissao}).dxTextBox("instance");
		campoDataHora = $("#textDataHora").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoSala = $("#selectSala").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoLeito = $("#selectLeito").dxSelectBox({
			valueExpr: "Codigo", displayExpr: "Descricao", height: 27, onValueChanged: function (e) {  
				if (e.value != "" && e.value != null && carregarTela != 1) {
					$.getJSON(urlPreparacaoQui,{method:"AlteraLeito",pCodProntuario:pCodProntuario,pAdmissao:pAdmissao,
						pCodLeito:e.value},function(objeto){
							if (objeto.status==1){
								DevExpress.ui.notify("Leito alterado com Sucesso!","success");
							}else{
								DevExpress.ui.notify("Erro: "+objeto.status,"error");
							}
					});
				}
				carregarTela = "";
			}
		}).dxSelectBox("instance");
		campoPaciente = $("#textPaciente").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoDataNascimento = $("#textDataNascimento").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoIdade = $("#textIdade").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoSexo = $("#textSexo").dxTextBox({readOnly: true, height: 27}).dxTextBox("instance");
		campoDM = "" //$("#textDM").dxTextBox({height: 27}).dxTextBox("instance");
		campoDiagnostico  = $("#textDiagnostico").dxTagBox({
			//height: 90,
			valueExpr: "Codigo", 
			displayExpr: "Descricao",
			searchEnabled: true,
			buttons: [{
				name: "btnPesquisarDiagnostico",
				location: "before",
				options: {
					hint: "Pesquisar",
					icon: "fa fa-search",
					type: "normal",
					onClick: function() {
						abrePesquisaCID(campoDiagnostico, campoDiagnostico.option("value"));
					}
				}
			}],
			itemTemplate: function (data, itemIndex, element) {
				if (CategoriaAnt != data.Categoria){
					retorno = "<b><i>"+data.Categoria+"</i></b><br><br>"
					CategoriaAnt = data.Categoria
					element.append(retorno)
				}
				return element.append(data.Descricao)
      },							
			dataSource: new DevExpress.data.DataSource({
				store: new DevExpress.data.CustomStore({
					byKey: function(args) {
						return $.getJSON(urlPreparacaoQui,{
							method:"getCID",
							codigo: args
						});
					},
					load: function(args) {
						return $.getJSON(urlPreparacaoQui,{
							method:"getCID",
							usuario: YBED,
							skip:args.skip,
							take:args.take,
							searchValue:args.searchValue
						});
					}
				})
			})
		}).dxTagBox("instance");
		/*campoMedico = $("#selectMedico").dxSelectBox({
			dataSource: dataSourceProfissional,valueExpr: "CodProvider", displayExpr: "DescProvider", height: 27,searchEnabled: true,onValueChanged: function(a){
				if (a.value==""||a.value==null){
					textMedico.option("value","")
					textCRM.option("value","")
				}else{
					$.getJSON(urlPreparacaoQui,{
						method:"CarregaProfissional", 
						pKey: a.value
					},function(ret){
						if (ret.length>0){
							textMedico.option("value",ret[0].CodProvider)
							textCRM.option("value",ret[0].CRM)
						}
					});
				}
		}}
		).dxSelectBox("instance");*/
		campoMedicoExterno = $("#selectMedicoExterno").dxSelectBox({
			dataSource: dataSourceMedico,valueExpr: "CodProvider", displayExpr: "DescProvider", height: 27,searchEnabled: true}
		).dxSelectBox("instance");
		buttonAddMedico = $("#divMedicoExternoAdd").dxButton({
			icon: "add",
			hint: "Adicionar Médico",
			type: "normal",
			height: 27,
			onClick: function(){
				$("#divCadastrarMedico").dxPopup("show");
			}
		}).dxButton("instance");	
		
		//
		$("#text").find("input").css({ "background": "red" });
		//
		campoAbas = $("#divAbas").dxForm({
			showColonAfterLabel: false,
			labelLocation: "left",
			showRequiredMark: false,
			items: [{
				itemType: "tabbed",
				tabPanelOptions: {
  			  deferRendering: false, 
  			  selectedIndex: 1,
				},
				tabs: [
					/// Aba Pendentes
					{ title: "Intercorrências", name: "tabEventosAdversos", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divEventosAdversos' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					{ title: "Anamnese", name: "tabAnamnese", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divAnamnese' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					{ title: "Reação Transfusional", name: "tabReacaoTransfusional", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divReacaoTransfusional' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					{ title: "Ficha Hemoterápica", name: "tabHemoterapia", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divHemoterapia' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					{ title: "Controle Dados Vitais", name: "tabContDadosVitais", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divContDadosVitais' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					{ title: "Prescrição para Atendimento", name: "tabPrescricaoAtendimento", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divPrescricaoAtendimento' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},
					/*{ title: "Observações Médicas", name: "tabObservacoes", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divObservacoes' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},*/
					{ title: "Receituário", name: "tabReceituario", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divReceituario' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},{ title: "Talassemia", name: "tabTalassemia", items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divTalassemia' class='aba' class='aba' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]},{ title: "Relatório", name: "tabDeclaracao", visible: (flagUsuarioMedico == 0 ? false : true), items: [
						{ template: function (data, itemElement) {
								itemElement.append("<div id='divDeclaracao' style='height:"+height+"px;border:0px solid red;overflow-Y: auto;'>")
	          	}		                           	
			    	}	
					]}
					
				]
			}]
		});
		
		$("#divAnamnese").load("VARContrAtendTransfusionalAnamnese.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#");
		$("#divContDadosVitais").load("VARContrAtendTransfusionalContDadosVitais.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&pPassagem=#($GET(%request.Data("pAdmissao",1)))#");
		//$("#divObservacoes").load("VARContrAtendTransfusionalObservacoes.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#");
		$("#divEventosAdversos").load("VARContrAtendEventosAdversos.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#");
		$("#divReceituario").load("VARContrAtendReceituario.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&YGIF=#(YGIF)#");
		$("#divDeclaracao").load("VARContrAtendAtestado.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&YGIF=#(YGIF)#");
		$("#divReacaoTransfusional").load("VARContrAtendTransfusionalReacaoTransfusional.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&pPassagem=#($GET(%request.Data("pAdmissao",1)))#");
		$("#divHemoterapia").load("VARContrAtendTransfusionalHemoterapia.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&pPassagem=#($GET(%request.Data("pAdmissao",1)))#");
		$("#divPrescricaoAtendimento").load("VARContrAtendPrescricaoAtendimento.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#");
		$("#divTalassemia").load("VARContrAtendControleTransfusional.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&pPassagem=#($GET(%request.Data("pAdmissao",1)))#&pCodProntuario=#($get(%request.Data("pCodProntuario",1)))#");
		//$("#divIntercorrencias").load("VARContrAtendIntercorrencias.csp?YBED=#(YBED)#&YUSER=#(YUSER)#&YM=0&YLOCATION=#(YLOCATION)#&YGIF=#(YGIF)#");

		function recuperaProntuario(pCodProntuario){
			$.getJSON(urlPreparacao,{method:"GetProntuario",pCodProntuario:pCodProntuario},function(objeto){
				campoProntuario.option("value",objeto.codPaciente);
				campoDataHora.option("value",objeto.dataHora);
				campoSala.option("value",objeto.codSala);
				campoLeito.option({dataSource: eval(objeto.dSLeito), value: eval(objeto.codLeito)});
				campoPaciente.option("value",objeto.paciente);
				campoDataNascimento.option("value",objeto.dataNascimento);
				campoIdade.option("value",objeto.idade);
				campoSexo.option("value",objeto.sexo);
				//campoDM.option("value",objeto.dM);
				campoDiagnostico.option("value",objeto.diagnostico);
				//campoMedico.option("value",objeto.medico);
				campoMedicoExterno.option("value",objeto.medicoExterno);
				//campoPreMedicacao.option("value",objeto.preMedicacao)
				if (objeto.dataHoraAssinatura != "") {
					$("#spAssinar").css("color","green")
					$("#btnAssinar").attr("title", "PEP assinado por: "+objeto.assinatura+" ("+objeto.dataHoraAssinatura+")");
					$("#spAssinarTexto").css("color","green");
					$("#btnFinalizar").attr("bloquear","0")
					$("#btnFinalizar").attr("title", "PEP assinado por: "+objeto.assinatura+" ("+objeto.dataHoraAssinatura+")");
					$("#divExibirAssinaturaTitulo").html("PEP assinado por:");
					$("#divExibirAssinatura").html(objeto.assinatura+" ("+objeto.dataHoraAssinatura+")");
					
					//LEAN-259
					//Bloqueia todos os campos de todas as abas, somente para visualização quando PEP estiver finalizado
					$('.aba .dx-toolbar-button, .aba .dx-button').css("visibility","hidden")
					$('#divReacaoTransfusional .dx-toolbar-button').css("visibility","hidden")
					$('.aba .dx-textbox').each(function(){ try { $(this).dxTextArea('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-texteditor').each(function(){ try { $(this).dxTextBox('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-checkbox').each(function(){ try { $(this).dxCheckBox('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-selectbox').each(function(){ try { $(this).dxSelectBox('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-selectbox').each(function(){ try { $(this).dxTagBox('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-numberbox').each(function(){ try { $(this).dxNumberBox('instance').option('readOnly',true) } catch (ex) {} })
					$('.aba .dx-radiogroup').each(function(){ try { $(this).dxRadioGroup('instance').option('disabled',true) } catch (ex) {} })
					$('.aba .dx-checkbox-icon').each(function(){ try { $(this).dxCheckBox('instance').option('disabled',true) } catch (ex) {} })
					$('.aba .dx-datebox').each(function(){ try { $(this).dxDateBox('instance').option('disabled',true) } catch (ex) {} })
					
					
				}else{
					$("#spAssinar").css("color","#ffffff");
					$("#spAssinarTexto").css("color","#ffffff");
					$("#btnAssinar").attr("title", "Assinar");
					$("#btnFinalizar").css("background-color","#Cccccc")
					$("#btnFinalizar").css("border-color","#cccccc");
					$("#btnFinalizar").attr("bloquear","1")
					$("#btnFinalizar").attr("title", "Prontuário pendente de assinatura do Médico.");
					$("#divExibirAssinaturaTitulo").html("");
					$("#divExibirAssinatura").html("");
				}

				//Anamnese
				//campoMolestiaPregressas.option({"value":objeto.comorbidades});
				//campoCID.option({"value":objeto.cid});
				campoComorbidades.option({"value":objeto.comorbidades});
				campoComorbidadesDM.option("value",objeto.comorbidadesDM);
				campoComorbidadesHAS.option("value",objeto.comorbidadesHAS);
				campoComorbidadesIRC.option("value",objeto.comorbidadesIRC);
				campoComorbidadesICC.option("value",objeto.comorbidadesICC);
				campoComorbidadesAVC.option("value",objeto.comorbidadesAVC);
				campoComorbidadesCodronariopatia.option("value",objeto.comorbidadesCodronariopatia);
				campoComorbidadesOutros.option("value",objeto.comorbidadesOutros);
				campoAlergia.option("value",objeto.alergia);
				campoAlergiaAQue.option("value",objeto.alergiaAQue);
				campoInfusaoVeiaPeriferica.option("value",objeto.infusaoVeiaPeriferica);
				campoInfusaoPort.option("value",objeto.infusaoPort);
				campoInfusaoPICC.option("value",objeto.infusaoPICC);
				campoInfusao.option("value",objeto.infusao);
				campoFluxoCateter.option("value",objeto.fluxoCateter);
				campoFinalizacao.option("value",objeto.finalizacao);
				campoIncidente.option("value",objeto.incidente);
				campoIncidenteQual.option("value",objeto.incidenteQual);
				campoRiscoFlebite.option("value",objeto.riscoFlebite);
				campoNeuropsiquiatrico.option("value",objeto.neuropsiquiatrico);
				campoPadraoRespiratorio.option("value",objeto.padraoRespiratorio);
				campoRitmoCardiaco.option("value",objeto.ritmoCardiaco);
				campoPeleMucosa.option("value",objeto.peleMucosa);
				campoDor.option("value",objeto.dor);
				campoDorDescricao.option("value",objeto.dorDescricao);
				campoRedeVenoso.option("value",objeto.redeVenoso);
				campoRedeVenosoDescricao.option("value",objeto.redeVenosoDescricao);
				campoMedoApreensao.option("value",objeto.medoApreensao);
				campoMedoApreensaoDescricao.option("value",objeto.medoApreensaoDescricao);
				campoInternacaoSocial.option("value",objeto.internacaoSocial);
				campoInternacaoSocialDescricao.option("value",objeto.internacaoSocialDescricao);
				campoColocarEtiqueta.option("value",objeto.colocarEtiqueta);
				campoConferirNome.option("value",objeto.conferirNome);
				campoOrientacao.option("value",objeto.orientacao);
				//
				if (objeto.medicoOrientacoesaEnferma != "") {
					$("#textOrientacaoDataHora").html("<b>Alterado por: </b>"+objeto.medicoOrientacoesaEnferma+" - ["+objeto.dataHoraOrientacoesaEnfer+"]&nbsp;")
				}
				//
				campoPeso.option("value",objeto.peso);
				campoHb.option("value",objeto.hb);
				campoHtc.option("value",objeto.htc);
				campoPlaquetas.option("value",objeto.plaquetas);
				campoTransfusao.option("value",objeto.transfusao);
				campoCTHTCBolsa.option("value",objeto.HTCBolsa);
				campoCTTS.option("value",objeto.TipoSanguineo);
				campoCTPai.option("value",objeto.Pai);
				campoCTIAC.option("value",objeto.IAC);
				campoCTTCD.option("value",objeto.TCD);
				//Reação Transfusional
				campoRTTransfusoesAnteriores.option("value",objeto.rTTransfusoesAnteriores);
				campoRTTempoAproximado.option("value",objeto.rTTempoAproximado);
				campoRTReacao.option("value",objeto.rTReacaoTransfusionaisA);
				campoRTTipoComponente.option("value",objeto.rTTipoComponente);
				campoRTTipoReacao.option("value",objeto.rTTipoDeReacao);
				campoRTRTData.option("value",objeto.rTData);
				campoRTRTHora.option("value",objeto.rTHora);
				campoRTRTComponente.option("value",objeto.rTComponente);
				campoRTVolume.option("value",objeto.rTVolume);
				campoRTDeleucotizado.option("value",objeto.rTDeleucotizado);
				campoRTIrradiado.option("value",objeto.rTIrradiado);
				campoRTLavado.option("value",objeto.rTLavado);
//				campoRTSinaisPulsoMais.option("value",objeto.rTSinSintMaisPulso);
				campoRTSinaisFebre.option("value",objeto.rTSinSintFebre);
				campoRTSinaisVomito.option("value",objeto.rTSinSintVomito);
				campoRTSinaisDorTorax.option("value",objeto.rTSinSintDornoTorax);
				campoRTSinaisSangramentos.option("value",objeto.rTSinSintSangramentos);
				//campoRTSinaisPulsoMenos.option("value",objeto.rTSinSintMenosPulso);
				campoRTSinaisCalafrios.option("value",objeto.rTSinSintCalafrios);
				campoRTSinaisCianose.option("value",objeto.rTSinSintCianose);
				campoRTSinaisUrticaria.option("value",objeto.rTSinSintUrticaria);
				campoRTSinaisUrinaEscura.option("value",objeto.rTSinSintUrinaEscura);
//				campoRTSinaisPAMais.option("value",objeto.rTSinSintMaisPA);
				campoRTSinaisDispneia.option("value",objeto.rTSinSintDispneia);
				campoRTSinaisDorLombar.option("value",objeto.rTSinSintDorLombar);
				campoRTSinaisEritema.option("value",objeto.rTSinSintEritema);
				campoRTSinaisVolUrinario.option("value",objeto.rTSinSintMenosVolUrinario);
				//campoRTSinaisPAMenos.option("value",objeto.rTSinSintMenosPA);
				campoRTSinaisTremor.option("value",objeto.rTSinSintTremor);
				campoRTSinaisDorCabeca.option("value",objeto.rTSinSintDordeCabeca);
				campoRTSinaisPrurido.option("value",objeto.rTSinSintPrurido);
				campoRTSinaisOutros.option("value",objeto.rTSinSintOutros);
				campoRTDescricao.option("value",objeto.rTSinSintOutrosDescrica);
				//Hemoterapia
				campoHEDiabetes.option("value",objeto.hemotAntecedentesDiabete);
				campoHEHipertensao.option("value",objeto.hemotAntecedentesHiperte);
				campoHEIRC.option("value",objeto.hemotAntecedentesIRC);
				campoHEICC.option("value",objeto.hemotAntecedentesICC);
				campoHEHepatica.option("value",objeto.hemotAntecedentesHepatic);
				campoHEInsufCoronariana.option("value",objeto.hemotAntecedentesInsufCo);
				campoHEAVC.option("value",objeto.hemotAntecedentesAVC);
				campoHEOutros.option("value",objeto.hemotAntecedentesOutros);
				campoHEOutrosQuais.option("value",objeto.hemotAntecedentesOutrosQ);
				campoHEMedicacoes.option("value",objeto.hemotMedicacoes);
				campoHETransfusaoAnterior.option("value",objeto.hemotTransfusaoAnterior);
				campoHEQuando.option("value",objeto.hemotTransfusaoAnteriorQ);
				campoHEOnde.option("value",objeto.hemotTransfusaoAnteriorO);
				campoHEReacoesPrevias.option("value",objeto.hemotReacoesTranPre);
				campoHEReacoesPreviasAlergica.option("value",objeto.hemotReacoesTranPreAle);
				campoHEReacoesPreviasFebril.option("value",objeto.hemotReacoesTranPreFeb);
				campoHEReacoesPreviasHemolica.option("value",objeto.hemotReacoesTranPreHem);
				campoHEReacoesPreviasOutras.option("value",objeto.hemotReacoesTranPreOut);
				campoHEReacoesPreviasOutrasDesc.option("value",objeto.hemotReacoesTranPreOutDes);
				campoHEComponenteDeleucotizado.option("value",objeto.hemotComponenteDeleucoti);
				campoHEComponenteIrradiado.option("value",objeto.hemotComponenteIrradiado);
				campoHEComponenteLavado.option("value",objeto.hemotComponenteLavado);
				campoHEDifenidramida.option("value",objeto.hemotMedPreTranDife);
				campoHEDifenidramidaDose.option("value",objeto.hemotMedPreTranDifeDose);
				campoHEFlebocortid.option("value",objeto.hemotMedPreTranFleb);
				campoHEFlebocortidDose.option("value",objeto.hemotMedPreTranFlebDose);
				campoHEDipirona.option("value",objeto.hemotMedPreTranDipi);
				campoHEDipironaDose.option("value",objeto.hemotMedPreTranDipiDose);
				campoHEParacetamol.option("value",objeto.hemotMedPreTranPara);
				campoHEParacetamolDose.option("value",objeto.hemotMedPreTranParaDose);
				campoHEFurosemide.option("value",objeto.hemotMedPreTranFuro);
				campoHEFurosemideDose.option("value",objeto.hemotMedPreTranFuroDose);
				campoHEMedicacoesOutros.option("value",objeto.hemotMedPreTranOutr);
				campoHEMedicacoesOutrosDesc.option("value",objeto.hemotMedPreTranOutrDesc);	
				campoHEObservacoes.option("value",objeto.hemotObs);
				radioHETCLE.option("value",(objeto.hemotTCLEQuando || objeto.hemotTCLE) ? "1":"0");
				dateHETCLEQuando.option("value",objeto.hemotTCLEQuando);
				adicionaLinkTCLE(objeto.hemotTCLE);
				//
				campoRTObservacao.option("value",objeto.reacoesTransfusionaisObse);		
				//
				data = objeto.dataHora
				if (objeto.dataHora.indexOf(" ")>-1){
					data = objeto.dataHora.split(" ")[0]
				}
				textData.option("value",data);		

				//Observações
				//campoDispensacao.option("value",objeto.dispensacao);
				//campoObservadoPor.option("value",objeto.observadoPor);
				//campoIntercorrencia.option("value",objeto.intercorrencia);
				//campoIntercorrenciaQual.option("value",objeto.intercorrenciaQual);
				//campoOutrasObservacoes.option("value",objeto.outrasObservacoes);
				//
				preencherIcones();
				alertaPrescricao();
				//
				PopulaEnvendoAnamnese()
			});
		}
		
		$("#btnFechar").click(function(){
			window.opener.carregaSala();
			window.close();
		});
		
		$("#btnArquivos").click(function(){
			$("#openPesquisaArquivo").dxPopup("show");
		});
		
		$("#btnFinalizar").click(function(){
			if ($("#btnFinalizar").attr("bloquear") == "1") {
				DevExpress.ui.notify("Prontuário pendente de assinatura do Médico.","warning",1500);
				return
			}
			
			var result = DevExpress.ui.dialog.confirm("<i>Confirmar a finalização do atendimento?</i>", "Confirmação?");
			result.done(function(dialogResult) {
				if (dialogResult) {
					/*var result = DevExpress.ui.dialog.confirm("<i>Término da Requisição?</i>", "Confirmação?");
					result.done(function(dialogResult) {
						var terminoPedido = 0;
						if (dialogResult) {*/
							terminoPedido = 1;
						//}
						$.getJSON(urlPreparacao,{method:"ArmFinalizar",pCodProntuario:pCodProntuario,pAdmissao:pAdmissao,
						pTerminoPedido:terminoPedido},function(rs){
							window.opener.carregaSala();
							window.close();
						});
					//});
				}
			});
		});
		
		$("#btnImprimir").click(function(){
			$.post(urlPreparacao,{method:"Imprimir",pCodProntuario:pCodProntuario,pPassagem:pAdmissao,pTipo:"I",YBED:YBED},function(retorno){
				eval(retorno);
			})				
		});
		$("#btnImprimirTermo").click(function(){
			$.post(urlPreparacao,{method:"Imprimir",pCodProntuario:pCodProntuario,pPassagem:pAdmissao,pTipo:"T",YBED:YBED},function(retorno){
				eval(retorno);
			})				
		});		
		function PopulaEnvendoAnamnese(){ 
			$.getJSON(urlPreparacaoQui,{method:"RecuperaUltimoEventoAdverso",pAdmissao:pAdmissao},function(objRetorno){
				campoDataEventosA.option({"value":objRetorno.data});
				campoHoraEventosA.option({"value":objRetorno.hora});
				campoDescicaoEventosA.option({"value":objRetorno.descricao});
				campoCondutaEventosA.option({"value":objRetorno.conduta});
			})
		}
		$("#btnImprimirEtiqueta").click(function(){
			$("#divImprimirEtiqueta").dxPopup("show");
		});	
		$("#btnAssinar").click(function(){
			salvarDados(1);
		});
		$("#btnSalvar").click(function(p1){
			salvarDados(0);
		});		
		
		function salvarDados(flagAssinar){
			sendTCLE();
			var pCodLeito = campoLeito.option("value");
			var pDM	= ""; //campoDM.option("value");
			var pDiagnostico	= campoDiagnostico.option("value");
			var pMedico	= ""; //campoMedico.option("value");
			var pMedicoExterno	= campoMedicoExterno.option("value");
			//Anamnese
			var pCID = ""; //campoCID.option("value");
			var pComorbidades = campoComorbidades.option("value");
			var pComorbidadesDM = campoComorbidadesDM.option("value");
			var pComorbidadesHAS = campoComorbidadesHAS.option("value");
			var pComorbidadesIRC = campoComorbidadesIRC.option("value");
			var pComorbidadesICC = campoComorbidadesICC.option("value");
			var pComorbidadesAVC = campoComorbidadesAVC.option("value");
			var pComorbidadesCodronariopatia = campoComorbidadesCodronariopatia.option("value");
			var pComorbidadesOutros = campoComorbidadesOutros.option("value");
			var pAlergia = campoAlergia.option("value");
			var pAlergiaAQue = campoAlergiaAQue.option("value");
			var pInfusaoVeiaPeriferica = campoInfusaoVeiaPeriferica.option("value");
			var pInfusaoPort = campoInfusaoPort.option("value");
			var pInfusaoPICC = campoInfusaoPICC.option("value");
			var pInfusao = campoInfusao.option("value");
			var pFluxoCateter = campoFluxoCateter.option("value");
			var pFinalizacao = campoFinalizacao.option("value");
			var pIncidente = campoIncidente.option("value");
			var pIncidenteQual = campoIncidenteQual.option("value");
			var pRiscoFlebite = campoRiscoFlebite.option("value");
			var pNeuropsiquiatrico = campoNeuropsiquiatrico.option("value");
			var pPadraoRespiratorio = campoPadraoRespiratorio.option("value");
			var pRitmoCardiaco = campoRitmoCardiaco.option("value");
			var pPeleMucosa = campoPeleMucosa.option("value");
			var pDor = campoDor.option("value");
			var pDorDescricao = campoDorDescricao.option("value");
			var pRedeVenoso = campoRedeVenoso.option("value");
			var pRedeVenosoDescricao = campoRedeVenosoDescricao.option("value");
			var pMedoApreensao = campoMedoApreensao.option("value");
			var pMedoApreensaoDescricao = campoMedoApreensaoDescricao.option("value");
			var pInternacaoSocial = campoInternacaoSocial.option("value");
			var pInternacaoSocialDescricao = campoInternacaoSocialDescricao.option("value");
			var pColocarEtiqueta = campoColocarEtiqueta.option("value");
			var pConferirNome = campoConferirNome.option("value");
			var pOrientacao = campoOrientacao.option("value");
			var pPeso = campoPeso.option("value");
			var pHb = campoHb.option("value");
			var pHtc = campoHtc.option("value");
			var pPlaquetas = campoPlaquetas.option("value");
			///
			var pPreMedicacao = ""; //campoPreMedicacao.option("value");
			//Observações
			var pDispensacao = "" //campoDispensacao.option("value");
			var pObservadoPor = "" //campoObservadoPor.option("value");
			var pIntercorrencia = "" //campoIntercorrencia.option("value");
			var pIntercorrenciaQual = "" //campoIntercorrenciaQual.option("value");
			var pOutrasObservacoes = "" //campoOutrasObservacoes.option("value");
			//Reação Transfusional
			var pRTTransfusoesAnteriores = campoRTTransfusoesAnteriores.option("value");
			var pRTTempoAproximado = campoRTTempoAproximado.option("value");
			var pRTReacaoTransfusionaisA = campoRTReacao.option("value");
			var pRTTipoComponente = campoRTTipoComponente.option("value");
			var pRTTipoDeReacao = campoRTTipoReacao.option("value");
			var pRTData = campoRTRTData.option("text");
			var pRTHora = campoRTRTHora.option("value");
			var pRTComponente = campoRTRTComponente.option("value");
			var pRTVolume = campoRTVolume.option("value");
			var pRTDeleucotizado = campoRTDeleucotizado.option("value");
			var pRTIrradiado = campoRTIrradiado.option("value");
			var pRTLavado = campoRTLavado.option("value");
			var pRTSinSintMaisPulso = "";//campoRTSinaisPulsoMais.option("value");
			var pRTSinSintMenosPulso = "" //campoRTSinaisPulsoMenos.option("value");
			var pRTSinSintMaisPA = "";//campoRTSinaisPAMais.option("value");
			var pRTSinSintMenosPA = ""; //campoRTSinaisPAMenos.option("value");
			var pRTSinSintFebre = campoRTSinaisFebre.option("value");
			var pRTSinSintCalafrios = campoRTSinaisCalafrios.option("value");
			var pRTSinSintDispneia = campoRTSinaisDispneia.option("value");
			var pRTSinSintTremor = campoRTSinaisTremor.option("value");
			var pRTSinSintVomito = campoRTSinaisVomito.option("value");
			var pRTSinSintCianose = campoRTSinaisCianose.option("value");
			var pRTSinSintDorLombar = campoRTSinaisDorLombar.option("value");
			var pRTSinSintDordeCabeca = campoRTSinaisDorCabeca.option("value");
			var pRTSinSintDornoTorax = campoRTSinaisDorTorax.option("value");
			var pRTSinSintUrticaria = campoRTSinaisUrticaria.option("value");
			var pRTSinSintEritema = campoRTSinaisEritema.option("value");
			var pRTSinSintPrurido = campoRTSinaisPrurido.option("value");
			var pRTSinSintSangramentos = campoRTSinaisSangramentos.option("value");
			var pRTSinSintUrinaEscura = campoRTSinaisUrinaEscura.option("value");
			var pRTSinSintMenosVolUrinario = campoRTSinaisVolUrinario.option("value");
			var pRTSinSintOutros = campoRTSinaisOutros.option("value");
			var pRTSinSintOutrosDescrica = campoRTDescricao.option("value");
			//Hemoterapia
			var pHemotAntecedentesDiabete = campoHEDiabetes.option("value");
			var pHemotAntecedentesHiperte = campoHEHipertensao.option("value");
			var pHemotAntecedentesIRC = campoHEIRC.option("value");
			var pHemotAntecedentesICC = campoHEICC.option("value");
			var pHemotAntecedentesHepatic = campoHEHepatica.option("value");
			var pHemotAntecedentesInsufCo = campoHEInsufCoronariana.option("value");
			var pHemotAntecedentesAVC = campoHEAVC.option("value");
			var pHemotAntecedentesOutros = campoHEOutros.option("value");
			var pHemotAntecedentesOutrosQ = campoHEOutrosQuais.option("value");
			var pHemotMedicacoes = campoHEMedicacoes.option("value");
			var pHemotTransfusaoAnterior = campoHETransfusaoAnterior.option("value");
			var pHemotTransfusaoAnteriorQ = campoHEQuando.option("text");
			var pHemotTransfusaoAnteriorO = campoHEOnde.option("value");
			var pHemotReacoesTranPre = campoHEReacoesPrevias.option("value");
			var pHemotReacoesTranPreAle = campoHEReacoesPreviasAlergica.option("value");
			var pHemotReacoesTranPreFeb = campoHEReacoesPreviasFebril.option("value");
			var pHemotReacoesTranPreHem = campoHEReacoesPreviasHemolica.option("value");
			var pHemotReacoesTranPreOut = campoHEReacoesPreviasOutras.option("value");
			var pHemotReacoesTranPreOutDes = campoHEReacoesPreviasOutrasDesc.option("value");
			var pHemotComponenteDeleucoti = campoHEComponenteDeleucotizado.option("value");
			var pHemotComponenteIrradiado = campoHEComponenteIrradiado.option("value");
			var pHemotComponenteLavado = campoHEComponenteLavado.option("value");
			var pHemotMedPreTranDife = campoHEDifenidramida.option("value");
			var pHemotMedPreTranDifeDose = campoHEDifenidramidaDose.option("value");
			var pHemotMedPreTranFleb = campoHEFlebocortid.option("value");
			var pHemotMedPreTranFlebDose = campoHEFlebocortidDose.option("value");
			var pHemotMedPreTranDipi = campoHEDipirona.option("value");
			var pHemotMedPreTranDipiDose = campoHEDipironaDose.option("value");
			var pHemotMedPreTranPara = campoHEParacetamol.option("value");
			var pHemotMedPreTranParaDose = campoHEParacetamolDose.option("value");
			var pHemotMedPreTranFuro = campoHEFurosemide.option("value");
			var pHemotMedPreTranFuroDose = campoHEFurosemideDose.option("value");
			var pHemotMedPreTranOutr = campoHEMedicacoesOutros.option("value");
			var pHemotMedPreTranOutrDesc = campoHEMedicacoesOutrosDesc.option("value");
			var pHemotMedPreObs = campoHEObservacoes.option("value");
			var pHemotTCLEQuando = dateHETCLEQuando.option("text");
			var pReacoesTransfusionaisObse = campoRTObservacao.option("value");
			var pcampoTransfusao = campoTransfusao.option("value");
			var pcampoCTHTCBolsa = campoCTHTCBolsa.option("value");
			var pcampoCTTS = campoCTTS.option("value");
			var pcampoCTPai = campoCTPai.option("value");
			var pcampoCTIAC = campoCTIAC.option("value");
			var pcampoCTTCD = campoCTTCD.option("value");
			//
			if (pCID) pCID = pCID.join(",");
			//if (pComorbidades) pComorbidades = pComorbidades.join(",");
			if (pDiagnostico) pDiagnostico = pDiagnostico.join(",");
			//
			$.post(urlPreparacao,{method:"ArmProntuario",pCodProntuario:pCodProntuario,pAdmissao:pAdmissao,
				pCodLeito:pCodLeito,pDM:pDM,pDiagnostico:pDiagnostico,pMedico:pMedico,pMedicoExterno:pMedicoExterno,
				pCID:pCID,pComorbidades:pComorbidades,
				pComorbidadesDM:pComorbidadesDM,pComorbidadesHAS:pComorbidadesHAS,pComorbidadesIRC:pComorbidadesIRC,
				pComorbidadesICC:pComorbidadesICC,pComorbidadesAVC:pComorbidadesAVC,
				pComorbidadesCodronariopatia:pComorbidadesCodronariopatia,pComorbidadesOutros:pComorbidadesOutros,
				pAlergia:pAlergia,pAlergiaAQue:pAlergiaAQue,pInfusaoVeiaPeriferica:pInfusaoVeiaPeriferica,
				pInfusaoPort:pInfusaoPort,pInfusaoPICC:pInfusaoPICC,pInfusao:pInfusao,pFluxoCateter:pFluxoCateter,
				pFinalizacao:pFinalizacao,pIncidente:pIncidente,pIncidenteQual:pIncidenteQual,pRiscoFlebite:pRiscoFlebite,
				pNeuropsiquiatrico:pNeuropsiquiatrico,pPadraoRespiratorio:pPadraoRespiratorio,pRitmoCardiaco:pRitmoCardiaco,
				pPeleMucosa:pPeleMucosa,pDor:pDor,pDorDescricao:pDorDescricao,pRedeVenoso:pRedeVenoso,
				pRedeVenosoDescricao:pRedeVenosoDescricao,pMedoApreensao:pMedoApreensao,
				pMedoApreensaoDescricao:pMedoApreensaoDescricao,pInternacaoSocial:pInternacaoSocial,
				pInternacaoSocialDescricao:pInternacaoSocialDescricao,pColocarEtiqueta:pColocarEtiqueta,
				pConferirNome:pConferirNome,pOrientacao:pOrientacao,pPeso:pPeso,pHb:pHb,pHtc:pHtc,pPlaquetas:pPlaquetas,
				pDispensacao:pDispensacao,pObservadoPor:pObservadoPor,pIntercorrencia:pIntercorrencia,
				pIntercorrenciaQual:pIntercorrenciaQual,pOutrasObservacoes:pOutrasObservacoes,YBED:YBED,
				pPreMedicacao:pPreMedicacao,pAssinar: flagAssinar, pRTTransfusoesAnteriores: pRTTransfusoesAnteriores, 
				pRTTempoAproximado: pRTTempoAproximado, pRTReacaoTransfusionaisA: pRTReacaoTransfusionaisA, 
				pRTTipoComponente: pRTTipoComponente, pRTTipoDeReacao: pRTTipoDeReacao, 
				pRTData: pRTData, pRTHora: pRTHora, pRTComponente: pRTComponente, 
				pRTVolume: pRTVolume, pRTDeleucotizado: pRTDeleucotizado, pRTIrradiado: pRTIrradiado, 
				pRTLavado: pRTLavado, pRTSinSintMaisPulso: pRTSinSintMaisPulso, pRTSinSintMenosPulso: pRTSinSintMenosPulso, 
				pRTSinSintMaisPA: pRTSinSintMaisPA, pRTSinSintMenosPA: pRTSinSintMenosPA, pRTSinSintFebre: pRTSinSintFebre, 
				pRTSinSintCalafrios: pRTSinSintCalafrios, pRTSinSintDispneia: pRTSinSintDispneia, pRTSinSintTremor: pRTSinSintTremor, 
				pRTSinSintVomito: pRTSinSintVomito, pRTSinSintCianose: pRTSinSintCianose, pRTSinSintDorLombar: pRTSinSintDorLombar, 
				pRTSinSintDordeCabeca: pRTSinSintDordeCabeca, pRTSinSintDornoTorax: pRTSinSintDornoTorax, pRTSinSintUrticaria: pRTSinSintUrticaria, 
				pRTSinSintEritema: pRTSinSintEritema, pRTSinSintPrurido: pRTSinSintPrurido, pRTSinSintSangramentos: pRTSinSintSangramentos, 
				pRTSinSintUrinaEscura: pRTSinSintUrinaEscura, pRTSinSintMenosVolUrinario: pRTSinSintMenosVolUrinario, 
				pRTSinSintOutros: pRTSinSintOutros, pRTSinSintOutrosDescrica: pRTSinSintOutrosDescrica, pHemotAntecedentesDiabete: pHemotAntecedentesDiabete, 
				pHemotAntecedentesHiperte: pHemotAntecedentesHiperte, pHemotAntecedentesIRC: pHemotAntecedentesIRC, 
				pHemotAntecedentesICC: pHemotAntecedentesICC, pHemotAntecedentesHepatic: pHemotAntecedentesHepatic, 
				pHemotAntecedentesInsufCo: pHemotAntecedentesInsufCo, pHemotAntecedentesAVC: pHemotAntecedentesAVC, 
				pHemotAntecedentesOutros: pHemotAntecedentesOutros, pHemotAntecedentesOutrosQ: pHemotAntecedentesOutrosQ, 
				pHemotMedicacoes: pHemotMedicacoes, pHemotTransfusaoAnterior: pHemotTransfusaoAnterior, 
				pHemotTransfusaoAnteriorQ: pHemotTransfusaoAnteriorQ, pHemotTransfusaoAnteriorO: pHemotTransfusaoAnteriorO, 
				pHemotReacoesTranPre: pHemotReacoesTranPre, pHemotReacoesTranPreAle: pHemotReacoesTranPreAle, 
				pHemotReacoesTranPreFeb: pHemotReacoesTranPreFeb, pHemotReacoesTranPreHem: pHemotReacoesTranPreHem, 
				pHemotReacoesTranPreOut: pHemotReacoesTranPreOut, pHemotReacoesTranPreOutDes: pHemotReacoesTranPreOutDes, 
				pHemotComponenteDeleucoti: pHemotComponenteDeleucoti, pHemotComponenteIrradiado: pHemotComponenteIrradiado, 
				pHemotComponenteLavado: pHemotComponenteLavado, pHemotMedPreTranDife: pHemotMedPreTranDife, 
				pHemotMedPreTranDifeDose: pHemotMedPreTranDifeDose, pHemotMedPreTranFleb: pHemotMedPreTranFleb, 
				pHemotMedPreTranFlebDose: pHemotMedPreTranFlebDose, pHemotMedPreTranDipi: pHemotMedPreTranDipi, 
				pHemotMedPreTranDipiDose: pHemotMedPreTranDipiDose, pHemotMedPreTranPara: pHemotMedPreTranPara, 
				pHemotMedPreTranParaDose: pHemotMedPreTranParaDose, pHemotMedPreTranFuro: pHemotMedPreTranFuro, 
				pHemotMedPreTranFuroDose: pHemotMedPreTranFuroDose, pHemotMedPreTranOutr: pHemotMedPreTranOutr, 
				pHemotMedPreTranOutrDesc: pHemotMedPreTranOutrDesc, pHemotMedPreObs: pHemotMedPreObs,
				pHemotTCLEQuando: pHemotTCLEQuando, pReacoesTransfusionaisObse: pReacoesTransfusionaisObse, 
				pcampoTransfusao:pcampoTransfusao, pcampoCTHTCBolsa: pcampoCTHTCBolsa, pcampoCTTS:pcampoCTTS,
				pcampoCTPai:pcampoCTPai,pcampoCTIAC:pcampoCTIAC,pcampoCTTCD:pcampoCTTCD},function(objeto){
				if (objeto.status==1){
					if (objeto.dataHoraAssinatura != "") {
						$("#spAssinar").css("color","green")
						$("#btnAssinar").attr("title", "PEP assinado");
						$("#spAssinarTexto").css("color","green");
						$("#btnFinalizar").attr("bloquear","0")
						$("#btnFinalizar").css("background-color","")
						$("#btnFinalizar").css("border-color","");
					}else{
						$("#spAssinar").css("color","#ffffff");
						$("#spAssinarTexto").css("color","#ffffff");
						$("#btnAssinar").attr("title", "Assinar");
						$("#btnFinalizar").css("background-color","#Cccccc")
						$("#btnFinalizar").css("border-color","#cccccc");
						$("#btnFinalizar").attr("bloquear","1")
						$("#btnFinalizar").attr("title", "Prontuário pendente de assinatura do Médico.");
						$("#divExibirAssinaturaTitulo").html("");
						$("#divExibirAssinatura").html("");
					}
					DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
					preencherIcones();
					alertaPrescricao();
				}else{
					DevExpress.ui.notify("Erro: "+objeto.status,"error");
				}
			},'json');
		}
		
		dataSourceResponsavelPreparo = new DevExpress.data.DataSource({
			store: new DevExpress.data.CustomStore({
				load: function(args) {
					return $.getJSON(urlPreparacaoQui,{method:"CarregaProfissional", pFiltro: args.searchValue,
						pTake: args.take, pSkip: args.skip, YLOCATION: YLOCATION});
				},
				byKey: function(args) {
					return $.getJSON(urlPreparacaoQui,{method:"CarregaProfissional", pKey: args, YLOCATION: YLOCATION});
				}
			})
		});
		
		$("#divCadastrarEtiqueta").dxPopup({
			visible: false,
			title: "Cadastrar Bolsa",
			width: 650,
			height: 550,
			position: {
				my: "center",
				at: "center",
				of: window
			},
			dragEnabled: true,
			contentTemplate: function(e) {
				formCadastrarEtiqueta = $("<div id='formCadastrarEtiqueta'>").dxForm({
					readOnly: false,
					alignItemLabels: true,
					showColonAfterLabel: true,
					labelLocation: "top",
					colCount: 4,
					items: [
						{dataField: "Etiqueta", label: { text: "Nº da Bolsa"}, colSpan: 3},
						{dataField: "Volume", colSpan: 1, editorType: "dxNumberBox"},
						{dataField: "Hemocomponentes", colSpan: 2},
						{dataField: "NBolsa", label: { text: "Abo/RH"}, colSpan: 2},
						{dataField: "AboRHPaciente", label: { text: "Abo/RH Paciente"}, colSpan: 2},
						{dataField: "TesteComp", label: { text: "Teste de Compatibilidade"}, colSpan: 2},
						{dataField: "ResponsavelInfusao", label: { text: "Responsável pela Infusão"}, colSpan: 4, editorType: "dxSelectBox", editorOptions: 
							{
								dataSource: dataSourceProfissional, valueExpr: "CodProvider", displayExpr: "DescProvider", height: 27,searchEnabled: true
							}
						},
						{dataField: "ResponsavelPreparo", label: { text: "Responsável pelo Preparo"}, colSpan: 4},
						{dataField: "DataPreparo", label: { text: "Data Preparo"}, colSpan: 2, editorType: "dxDateBox"},
						{dataField: "HoraPreparo", label: { text: "Hora Preparo"}, colSpan: 2},
						//{dataField: "PreMedicacao", label: { text: "Pré Medicação"}, colSpan: 4, editorType: "dxTextArea"},
						{},
						{itemType: "button", horizontalAlignment: "right", buttonOptions: {
	           	text: "Salvar", icon: "save",
							onClick: function(){
								var pEtiqueta = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("Etiqueta").option("value");
								var pVolume = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("Volume").option("value");
								var pHemocomponentes = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("Hemocomponentes").option("value");
								var pNBolsa = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("NBolsa").option("value");
								var pAboRH = "" ;//$("#formCadastrarEtiqueta").dxForm("instance").getEditor("AboRH").option("value");
								var pAboRHPaciente = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("AboRHPaciente").option("value");
								var pTesteComp = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("TesteComp").option("value");
								var pResponsavelInfusao = $("#formCadastrarEtiqueta").dxForm("instance").getEditor("ResponsavelInfusao").option("value");
								var pResponsavelPreparo	= $("#formCadastrarEtiqueta").dxForm("instance").getEditor("ResponsavelPreparo").option("value");
								var pDataPreparo	= $("#formCadastrarEtiqueta").dxForm("instance").getEditor("DataPreparo").option("text");
								var pHoraPreparo	= $("#formCadastrarEtiqueta").dxForm("instance").getEditor("HoraPreparo").option("value");
								var pPreMedicacao	= ""; //$("#formCadastrarEtiqueta").dxForm("instance").getEditor("PreMedicacao").option("value");
								//pré medicaçãoPreMedicacao
								if (pEtiqueta == "" || pVolume == "" ) {
									DevExpress.ui.notify("É obrigatório preencher os campos Etiqueta e Volume.","warning",1500);
									return;
								}
								$.getJSON(urlPreparacao,{method:"ArmEtiqueta", pCodProntuario:pCodProntuario, 
									pEtiqueta:pEtiqueta, pVolume:pVolume, pHemocomponentes:pHemocomponentes, pNBolsa:pNBolsa,
									pAboRH:"", pAboRHPaciente:pAboRHPaciente, pTesteComp:pTesteComp,
									pResponsavelInfusao:pResponsavelInfusao,
									pResponsavelPreparo:pResponsavelPreparo,pDataPreparo:pDataPreparo,
									pHoraPreparo:pHoraPreparo,pPreMedicacao:pPreMedicacao},function(objeto){
									if (objeto.status==1){
										dataSourceEtiqueta.reload();
										dataSourceListBolsas.reload();
										DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
										$("#divCadastrarEtiqueta").dxPopup("hide");
								}else{
										DevExpress.ui.notify("Erro: "+objeto.status,"error");
									}
								});
							}}
						},
						{itemType: "button", horizontalAlignment: "left", buttonOptions: {
	          	text: "Fechar", icon: "close",
							onClick: function(){
								$("#divCadastrarEtiqueta").dxPopup("hide");
							}}
						}
					]
				});
				
				e.append(formCadastrarEtiqueta);
			}        		
		});
		
		function preencherIcones(){
			$.get(urlPreparacaoQui,{method:"ImprimirIcones",pCodProntuario:pCodProntuario, pCodSetor: "TRANSFUSAOSANGUE"},
			function(rs){
				$("#divIcones").html(rs);
			});
		}
		
		function alertaPrescricao(){
			var retorno = #server(VAR.CSP.VARContrAtendQuimioterapico.AlertaPrescricao(pCodProntuario))#;
			retorno = JSON.parse(retorno);
			
			$("#divAlertaPrescricao").html("&nbsp;");
			
			if (retorno.AA) {
				$("#divAlertaPrescricao").append("<div>Prescrição para Atendimento</div>");
			}
			if (retorno.CA) {
				$("#divAlertaPrescricao").append("<div>Prescrição Suspensa</div>");
			}
		}			

		function abrePesquisaCID(objRetornoCID, conteudoCampo){
			 popupOptions = {
		        width: "90%",
		        height: "90%",
		        showTitle: true,
		        title: "Pesquisa CID",
		        visible: true,
		        dragEnabled: false,
		        closeOnOutsideClick: false,
		        onHidden: function(){
							var arrayCID	= [];
							openPesquisaCIDLista.getSelectedRowsData().then(function (rowData) {
								$.each(rowData, function(count, dados) {
									arrayCID.push(dados.CodigodoCID);
								});
							}).done(function(){
				      	objRetornoCID.option("value", arrayCID)  
							});
			      }
		    
		    }		
		    if ($("#openPesquisaCID").html()!=""){
		    	openPesquisaCID.dispose()
		    	openPesquisaCIDLista.dispose()
		    }
	 			$("#openPesquisaCID").html("<div id='openPesquisaCIDLista'></div>")
				openPesquisaCID = $("#openPesquisaCID").dxPopup(popupOptions).dxPopup("instance")
				preparaPesquisaCID(conteudoCampo)
		}		
		
		function preparaPesquisaCID(pConteudoCampo){
	      openPesquisaCIDLista = $("#openPesquisaCIDLista").dxDataGrid({
				dataSource:  new DevExpress.data.DataSource({
					store: new DevExpress.data.CustomStore({
						key: "CodigodoCID",
						loadMode: "raw",
						load: function(){
		        	var d = $.Deferred();
							$.getJSON(urlPreparacaoQui, {method: "getListCID"},function(retorno){
								d.resolve(retorno);
								openPesquisaCIDLista.selectRows(pConteudoCampo, true); 
							});
							return d.promise();
						}
					})
				}),
				columns: [
					{dataField: "CodigodoCID",caption: "Código"},
					{dataField: "DescricaoResumida", caption: "Descrição"},
					{dataField: "DescCategoria",caption: "Categoria", groupIndex: 0},
				],	
				allowColumnReordering: true,
				columnAutoWidth: true,
				selection: { mode: "multiple", deferred: true },
				allowColumnResizing: true,
				height: "100%",	
				headerFilter: { visible: false },
				hoverStateEnabled: true,
				filterRow: { visible: true },
				showBorders: true,
				showRowLines: true,
				grouping: { autoExpandAll: false },
				searchPanel: { visible: false }, 
				groupPanel: { visible: false },
				export: { enabled: false },
				stateStoring: { enabled: false }, 
				columnChooser: { enabled: false, mode: "dragAndDrop" },
				sorting: { mode: "multiple" },
				rowAlternationEnabled: true,
				wordWrapEnabled:true,
				pager: {
					showPageSizeSelector: true,
					allowedPageSizes: [20, 50, 100, 150, 200],
					showInfo: true,
					showNavigationButtons: true,
					visible: true 
				},
				paging: { enabled: true, pageSize: 20 }
			}).dxDataGrid("instance")
		}
		
		$("#divCadastrarMedico").dxPopup({
			visible: false,
			title: "Cadastrar Médico",
			width: 650,
			height: 280,
			position: {
				my: "center",
				at: "center",
				of: window
			},
			dragEnabled: true,
			contentTemplate: function(e) {
				formCadastrarMedico = $("<div id='formCadastrarMedico'>").dxForm({
					readOnly: false,
					alignItemLabels: true,
					showColonAfterLabel: true,
					labelLocation: "top",
					colCount: 4,
					items: [
						{dataField: "Nome", label: { text: "Nome"}, colSpan: 4},
						{dataField: "CRMUF", label: { text: "U.F. CRM"}, colSpan: 1},
						{dataField: "CRMNumero", label: { text: "Número CRM"}, colSpan: 1, editorType: "dxNumberBox"},
						{},
						{},
						{},
						{itemType: "button", horizontalAlignment: "right", buttonOptions: {
	           	text: "Salvar", icon: "save",
							onClick: function(){
								var pNome = $("#formCadastrarMedico").dxForm("instance").getEditor("Nome").option("value");
								var pUFCRM = $("#formCadastrarMedico").dxForm("instance").getEditor("CRMUF").option("value");
								var pCRM = $("#formCadastrarMedico").dxForm("instance").getEditor("CRMNumero").option("value");
								//pré medicaçãoPreMedicacao
								if (pNome == "" || pUFCRM == "" || pCRM == "" ) {
									DevExpress.ui.notify("É obrigatório preencher todos os campos","warning",1500);
									return;
								}
								$.get(urlPreparacao,{method:"ArmMedico", pNome:pNome, 
									pUFCRM:pUFCRM, pCRM:pCRM,YBED:YBED},function(objeto){
									var array = objeto.split("|")
									if (array[0]==1){
										dataSourceMedico.reload();
										DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
										$("#divCadastrarMedico").dxPopup("hide");
										campoMedicoExterno.option("value",array[1])
								}else{
										DevExpress.ui.notify("Erro: "+array[0],"error");
									}
								});
							}}
						},
						{itemType: "button", horizontalAlignment: "left", buttonOptions: {
	          	text: "Fechar", icon: "close",
							onClick: function(){
								$("#divCadastrarMedico").dxPopup("hide");
							}}
						}
					]
				});
				
				e.append(formCadastrarMedico);
			}        		
		});
		
		var devices = [];
		var devicesCampo = [];
		BrowserPrint.getDefaultDevice("printer", function(device) {
			BrowserPrint.getLocalDevices(function(device_list){
				if (device_list.length == 0) return;
				var qtdeImpressora = device_list.length - 1;
				for(var i = 0; ; i++){
					//Add device to list of devices and to html select element
					var device = device_list[i];
					devices.push(device);
					listDevice = {"name": device.name, "uid": i}
					devicesCampo.push(listDevice);
					if (i == qtdeImpressora) return; 
				}
			}, function(){
				DevExpress.ui.notify("Erro ao obter dispositivos locais","error");
			},"printer");
		}, function(error){
			DevExpress.ui.notify("Erro ao obter dispositivos locais","error");
		})

		$("#divImprimirEtiqueta").dxPopup({
			visible: (YBED == "JULIO" ? false : false),
			title: "Imprimir Etiqueta",
			width: 650,
			height: 280,
			position: {
				my: "center",
				at: "center",
				of: window
			},
			dragEnabled: true,
			contentTemplate: function(e) {
				formImprimirEtiqueta = $("<div id='formImprimirEtiqueta'>").dxForm({
					readOnly: false,
					alignItemLabels: true,
					showColonAfterLabel: true,
					labelLocation: "top",
					colCount: 4,
					items: [
						{dataField: "Modelo", colSpan: 4, editorType: "dxSelectBox",
							editorOptions: {
								dataSource: [{id: 1, text: "Pedido Médico"},{id: 2, text: "Amostra"}], //dataSourceDrogaQuimio,
								displayExpr: "text",
								valueExpr: "id",
								value: 1,
								//showClearButton: true,
								//searchEnabled: true,
							}
						},
						{dataField: "Impressora", colSpan: 3, editorType: "dxSelectBox",
							editorOptions: {
								dataSource: devicesCampo, //dataSourceDrogaQuimio,
								displayExpr: "name",
								valueExpr: "uid",
								//showClearButton: true,
								//searchEnabled: true,
							}
						},
						{dataField: "Quantidade", colSpan: 1, editorType: "dxNumberBox",
							editorOptions: {
				        value: 1,
				        min: 1,
				        max: 20,
							}
						},
						{itemType: "button", colSpan: 2, horizontalAlignment: "right", buttonOptions: {
	           	text: "Imprimir", icon: "print",
							onClick: function(){
								writeToSelectedPrinter("");
							}}
						},
						{itemType: "button", colSpan: 2, horizontalAlignment: "left", buttonOptions: {
	          	text: "Fechar", icon: "close",
							onClick: function(){
								$("#divImprimirEtiqueta").dxPopup("hide");
							}}
						}
					]
				});
				
				e.append(formImprimirEtiqueta);
			}        		
		});

		function writeToSelectedPrinter(dataToWrite){
			
			if ($("#formImprimirEtiqueta").dxForm("instance").getEditor("Impressora").option("value") == null) {
				DevExpress.ui.notify("Selecione a impressora","warning");
				return
			}
			
			$.getJSON(urlPreparacaoQui,{method:"recuperarEtiqueta", pCodProntuario: pCodProntuario, 
			pAdmissao: pAdmissao, YBED: YBED},function(objeto){
				
				if ($("#formImprimirEtiqueta").dxForm("instance").getEditor("Modelo").option("value") == 1) {
					dataToWrite =  ""
					dataToWrite += "^XA~TA000~JSN^LT0^MNW^MTT^PON^PMN^LH0,0^JMA^PR2,2~SD30^JUS^LRN^CI0^XZ\n" //BASIC-59
					dataToWrite += "^XA\n"
					dataToWrite += "^MD20\n"			//MD - Media Darkness LEAN-75 LEAN-89
					dataToWrite += "^MMT\n"
					dataToWrite += "^PW831\n"
					dataToWrite += "^LL0220\n"
					dataToWrite += "^LS0\n"

					dataToWrite += "^FT220,55^A0N,22,22^FH\^FD"+""+objeto.paciente+"^FS\n"
					dataToWrite += "^FT220,87^A0N,20,20^FH\^FD"+"NASC.: "+objeto.dataNasc+"    PRONTUARIO: "+objeto.prontuario+"^FS\n"
					dataToWrite += "^FT220,119^A0N,20,20^FH\^FD"+"MAE: "+objeto.mae+"^FS\n"
					dataToWrite += "^FT220,152^A0N,20,20^FH\^FD"+"ADMISSAO: "+pAdmissao+" - "+objeto.dataAdm+"^FS\n"
					dataToWrite += "^PQ"+$("#formImprimirEtiqueta").dxForm("instance").getEditor("Quantidade").option("value")+",0,1,Y^XZ\n"
					
				}else{
					dataToWrite =  ""
					dataToWrite += "^XA~TA000~JSN^LT0^MNW^MTT^PON^PMN^LH0,0^JMA^PR2,2~SD30^JUS^LRN^CI0^XZ\n" //BASIC-59
					dataToWrite += "^XA\n"
					dataToWrite += "^MD20\n"			//MD - Media Darkness LEAN-75 LEAN-89
					dataToWrite += "^MMT\n"
					dataToWrite += "^PW831\n"
					dataToWrite += "^LL0220\n"
					dataToWrite += "^LS0\n"

					dataToWrite += "^FT220,42^A0N,20,20^FH\^FD"+""+objeto.paciente+"^FS\n"
					dataToWrite += "^FT220,64^A0N,18,18^FH\^FD"+"NASC.: "+objeto.dataNasc+"    PRONTUARIO: "+objeto.prontuario+"^FS\n"
					dataToWrite += "^FT220,88^A0N,18,18^FH\^FD"+"ADMISSAO: "+pAdmissao+" - "+objeto.dataAdm+"^FS\n"
					dataToWrite += "^FT210,100^A0N,16,16^FH\^FD"+"-------------------------------------------------------------"+"^FS\n"
					dataToWrite += "^FT220,116^A0N,18,18^FH\^FD"+"MEDICAMENTO: "+"^FS\n"
					dataToWrite += "^FT220,138^A0N,18,18^FH\^FD"+"SOLUCAO:"+"^FS\n"
					dataToWrite += "^FT220,160^A0N,18,18^FH\^FD"+"RESPONSAVEL: "+objeto.responsavel+"^FS\n"

					dataToWrite += "^PQ"+$("#formImprimirEtiqueta").dxForm("instance").getEditor("Quantidade").option("value")+",0,1,Y^XZ\n"
				}
			
				selected_device = devices[$("#formImprimirEtiqueta").dxForm("instance").getEditor("Impressora").option("value")];
				//selected_device = devices[0];
				selected_device.send(dataToWrite);
			});
			
		}	
		
		dataSourceArquivo = new DevExpress.data.DataSource({ 
			store: new DevExpress.data.CustomStore({
				loadMode: "raw",
				load: function(){
					return $.getJSON(urlPreparacaoQui, {method: "getArquivos", pAdmissao: pAdmissao, YGIF: #(YGIF)#},function(retorno){
					});
				},
				remove : function(args){
					#server(VAR.CSP.VARContrAtendQuimioterapico.removerArquivo(args.Arquivo))#
				}
			})
		});			
			
		$("#openPesquisaArquivo").dxPopup({
			visible: false,
			title: "Anexos",
			width: 650,
			height: 500,
			position: {
				my: "center",
				at: "center",
				of: window
			},
			dragEnabled: true,
			contentTemplate: function(e) {
				gridArquivos = $("<div id='gridArquivos'>").dxDataGrid({
					dataSource: dataSourceArquivo,
					columns: [
						{dataField: "Documento"},
						{dataField: "dataModificacao", caption: "Data"},
					],	
					editing: {
						mode: "row",
						allowDeleting: true,
						useIcons: true
					},
					allowColumnReordering: true,
					columnAutoWidth: true,
					allowColumnResizing: true,
					height: "100%",	
					headerFilter: { visible: false },
					hoverStateEnabled: true,
					filterRow: { visible: true },
					showBorders: true,
					showRowLines: true,
					grouping: { autoExpandAll: false },
					searchPanel: { visible: false }, 
					groupPanel: { visible: false },
					export: { enabled: false },
					stateStoring: { enabled: false }, 
					columnChooser: { enabled: false, mode: "dragAndDrop" },
					sorting: { mode: "multiple" },
					rowAlternationEnabled: true,
					wordWrapEnabled:true,
					onRowClick: function(e){
						if (e.rowType == "data") {
							window.open(e.key.Arquivo,"Visualizar")
						}
					},
					pager: {
						showPageSizeSelector: true,
						allowedPageSizes: [20, 50, 100, 150, 200],
						showInfo: true,
						showNavigationButtons: true,
						visible: true 
					},
					paging: { enabled: true, pageSize: 20 },
					onToolbarPreparing: function(e) {
						e.toolbarOptions.items.unshift({
							location: "after",
							widget: "dxButton",
							options: {
								icon: "fa fa-upload",
								height: 36,
								width: 36,
								hint: "Upload de Prontuário",
								onClick: function(e) {
									window.open("VARUploadArquivoPEPEnfermagem.csp?pAdmissao="+pAdmissao,"uploadArquivo","width=450,height=200,"+
									"scrollbars=0,resizable=0,menubar=0,location=0,top=100,left=100")
									//uploadExames()
								}
							}
						})
					}
				});
				
				e.append(gridArquivos);
			}        		
		});
		
		
		function _x() {
			$('.aba .dx-toolbar-button, .aba .dx-button').css("visibility","visible")
			$('#divReacaoTransfusional .dx-toolbar-button').css("visibility","visible")
			$('.aba .dx-textbox').each(function(){ try { $(this).dxTextArea('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-texteditor').each(function(){ try { $(this).dxTextBox('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-checkbox').each(function(){ try { $(this).dxCheckBox('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-selectbox').each(function(){ try { $(this).dxSelectBox('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-selectbox').each(function(){ try { $(this).dxTagBox('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-numberbox').each(function(){ try { $(this).dxNumberBox('instance').option('readOnly',false) } catch (ex) {} })
			$('.aba .dx-radiogroup').each(function(){ try { $(this).dxRadioGroup('instance').option('disabled',false) } catch (ex) {} })
			$('.aba .dx-checkbox-icon').each(function(){ try { $(this).dxCheckBox('instance').option('disabled',false) } catch (ex) {} })
			$('.aba .dx-datebox').each(function(){ try { $(this).dxDateBox('instance').option('disabled',false) } catch (ex) {} })
		}

	</script>
	</body>
</html>
