<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
	<script language="Cache" runat="server">
		do ^WWWVAR

		set YUSER 		= $get(%request.Data("YUSER", 1))
		set YBED 		= $get(%request.Data("YBED", 1))
		set YM 			= $get(%request.Data("YM", 1))
		set YLOCATION	= $get(%request.Data("YLOCATION", 1))

		set PortCache 	= $get(%request.CgiEnvs("SERVER_PORT"))
		set PageURL 	= $get(%request.CgiEnvs("CACHE_URL"))
		set PageName 	= %request.PageName
		set app 		= %request.Application
		set host 		= %request.CgiEnvs("HTTP_HOST")
		set url			= "http://"_host_app
		;
		set param="EP=1&YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&YLOCATION="_YLOCATION
		set paramEncrypt = $piece(##class(COM.fwk.ui.csp.CSPUtil).encrypt(param),"id_key=",2)
		
		set URLPreparacao			= "VAR.CSP.FATPreLote.cls"
		set URLLogin 					= "COMLogin.cls"
		Set URLPreparacaoOrc	= "VAR.CSP.VARCadOrcamento.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"

		//Verifica se a sessão
		set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
	</script>

	<head>

		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
		<title>Cadastro de Pré-Lotes</title>

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">
		<!-- Font Awesome -->
		<link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

		<!-- Custom Elements -->
		<link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
		<link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
		<link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
		<link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />

		<!-- Fonts Padrão IPP -->
		<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800">

		<!-- DevExtreme themes -->
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme20.2.4/Lib/css/dx.common.css" />
		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme20.2.4/Lib/css/dx.light.compact.css" />

		<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/ui/1.12.1/jquery-ui.css" />

	    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/themes/css/alphalincv2.css" id="style_color" />

	</head>

	<style>
		div.ui-tooltip {
		    max-width: 800px;
		}
	</style>

	<script type="text/javascript">

		var alterado = 0;
		var carregarDados = 1;
		var codRegraGlobal = "";
		var flVoltaCodigo = 0;

		var status = '#(status)#';
		var URLLogin = '#(URLLogin)#';
		var ygif = '#(YGIF)#'

		if (status == 0) {
			alert('Usuário não está logado ou a sessão expirou.')
			window.location.replace(URLLogin)
		}

	</script>

	<body>
		<div id="toolbar"></div>
		<div id="divForm"></div>
		<div id="loadpanel"></div>
		
		<!-- REQUIRED JS SCRIPTS -->
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/jquery.min.js"></script>

		<!-- JSZip library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/jszip.min.js"></script>

		<!-- A DevExtreme library -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/dx.all.js"></script>

		<!-- DevExtreme-Intl module -->
		<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme20.2.4/Lib/js/localization/dx.messages.pt.js"></script>

		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>

	    <!-- JQuery-UI -->
	    <script type="text/javascript" src=" #(YGIF)#global/plugins/ui/1.12.1/jquery-ui.js"></script>

		<!--Definições globais e criação de funcionalidades encapsuladas-->
		<script type="text/javascript">
			//Deixando variáveis disponíveis no cliente
			var urlPreparacao	= '#(URLPreparacao)#';
			var urlPreparacaoOrc = '#(URLPreparacaoOrc)#';

			$.ajaxSetup({
			  headers : {   
			    'id_key' : '#(paramEncrypt)#'
			  }
			});

			DevExpress.localization.locale("pt");

			$(document)
				.ajaxSuccess(function(jqxhr, textStatus, error) {
					loadPanel.hide();
				})
				.ajaxError(function(jqxhr, textStatus, error) {
					var err = textStatus.status + ", " + textStatus.statusText;
		    		DevExpress.ui.notify("Problema no acesso à internet. Favor verificar (code: "+err+")", "error", 4000);
					loadPanel.hide();
				});	        
			
			setInterval(function () { verificaConexao(); }, 30000);


	        $(document).ready(function () {
		        carregaDataSources()
	        	montaTela()
	        	resizeMe()
	        	carregaPreLote("")
	        })
			$(window).resize(function() {
			  resizeMe()
			});	       
			
		  	function verificaConexao(){
		  		$.getJSON(urlPreparacao,{
			  		method:"validaSessao"
			  	},function(resp){
			        if (resp.status == 0) {
			            alert(resp.mensagem)
			            window.location.replace(URLLogin)
			        }
			  	})
		  	}
			
			function resizeMe(){
				$("#divForm").dxForm("instance").option("height",window.innerHeight - 60)
				var tamanhoAbas = window.innerHeight - 140
				if (tamanhoAbas<200) tamanhoAbas = 200
				$("#divGeral").dxForm("instance").option("height",tamanhoAbas)
				$("#divControle").dxForm("instance").option("height",tamanhoAbas)
				var alturaGridFaturas = window.innerHeight - 280
				if (alturaGridFaturas<200) alturaGridFaturas = 200
				$("#divFaturas").dxDataGrid("instance").option("height",alturaGridFaturas)
			}
			
			function montaTela(){
				// Monta o LoadPanel
				loadPanel = $("#loadpanel").dxLoadPanel({
			        visible: true,
			        showIndicator: true,
			        showPane: true,
			        shading: true,
			        shadingColor:"rgba(255,255,255,.6)",
			        closeOnOutsideClick: false,
			    }).dxLoadPanel("instance");

				// Monta toolbar
				$("#toolbar").dxToolbar({
				    items: [{
				    	location: "after",
				        widget: "dxButton",
				        options: {
					        elementAttr: {
						      id: "botaoSalvar"  
					        },
				            icon: "save",
				            hint: "Salvar os Dados",
				            text: "Salvar",
				            type: "default",
				            stylingMode: "contained",
				            onClick: function () {
								salvarDados()
				            }
				        }
				    }, {
				    	location: "after",
				        widget: "dxButton",
				        options: {
				            icon: "trash",
				            hint: "Remover o Pré Lote",
				            text: "Remover",
				            type: "danger",
				            stylingMode: "contained",
				            onClick: function () {
								removerDados()
				            }
				        }
				    }, {
				    	location: "after",
				        widget: "dxButton",
				        options: {
				            icon: "fas fa-share",
				            hint: "Enviar Pré-Lote",
				            text: "Enviar",
				            type: "default",
				            stylingMode: "contained",
				            onClick: function () {
								enviarPreLote()
				            }
				        }
				    }, {
				        location: "after",
				        widget: "dxButton",
				        options: {
				            icon: "fa fa-eraser",
				            hint: "Limpar os Campos",
				            type: "default",
							text: "Limpar",
				            stylingMode: "contained",
				            onClick: function () {
								if ($("#divForm").dxForm("instance").option("formData").preLote!=undefined){
									$("#divForm").dxForm("instance").updateData("preLote","")
								}else{
					            	carregaPreLote("")
								}
				            }
				        }
				    }]
				})

				// Monta formulário principal
				$("#divForm").dxForm({
				    activeStateEnabled: true,
				    minColWidth: 50,
				    screenByWidth: function (width) {
				        return "lg";
				    },
				    height: function () {
				        return window.innerHeight - 60
				    },
				    onContentReady: function (){
						montaAbas()
					},
				    alignItemLabels: false,
				    alignItemLabelsInAllGroups: false,
				    items: [{
				        itemType: "group",
				        items: [{
	       			        cssClass: "first-group",
				            dataField: "preLote",
						    label		: {
							    alignment: "right",
							    text	: "Pré Lote"
						    },
						    editorType	: "dxSelectBox",
							editorOptions: {
								dataSource: dataSourcePreLote,
			    		        valueExpr: "codigo", 
								displayExpr: "descricao",
								searchEnabled: true,
		                        width: "470px",
		                        onValueChanged: function(e){
			                        carregaPreLote(e.value)
			                    },
			                	buttons: [{
				                    name: "search",
				                    location: "after",
				                    options: {
				                        stylingMode: "text",
				                        icon: "search",
				                        onClick: function() {
					                        abrePesquisaPreLote()
				                        }
				                    }
			                	},'dropDown']
			                }				            
				        },{
				            itemType: "tabbed",
				            cssClass	: "first-group",
				            name: "abas",
				            tabPanelOptions: {
				                deferRendering: false,
				            },
				            tabs: [{
				                title: "Geral",
				                items: [{
				                    template: function (data, itemElement) {
				                        itemElement.append("<div id='divGeral'>")
				                    }
				                }],
				            }, {
				                title: "Auditoria",
				                items: [{
				                    template: function (data, itemElement) {
				                        itemElement.append("<div id='divControle'>")
				                    }
				                }]
				            }]
				        }]
				    }]
				})
			}			
			// Abre popup para pesquisar por organizações
			function abrePesquisaPreLote(){
				 popupOptions = {
			        width: "90%",
			        height: "90%",
			        showTitle: true,
			        title: "Pesquisa Pré-Lotes",
			        visible: true,
			        dragEnabled: false,
			        closeOnOutsideClick: false
			    }	
			    $("#openPopup").remove()
			    $(document.body).append("<div id='openPopup'></div>")
	   			$("#openPopup").html("<div id='pesquisaPopup'></div>")
				$("#openPopup").dxPopup(popupOptions)
				preparaPesquisaPreLote()
			}		
			
			function preparaPesquisaPreLote(){
		        $("#pesquisaPopup").dxDataGrid({
			        columns:[{
						dataField	: "codFatura",
						caption		: "Número da Fatura"
				   	},{
						dataField	: "Atendente",
						caption		: "Atendente"
				   	},{
						dataField	: "DataHoradeInicio",
						caption		: "Data/Hora Inicial",
						dataType	: "datetime",
				   	},{
						dataField	: "DataHoraFinal",
						caption		: "Data/Hora Final",
						dataType	: "datetime",
				   	},{
						dataField	: "Status",
						caption		: "Situação"
				   	}],
					dataSource:  new DevExpress.data.CustomStore({
	            		load: function(args) {
		            		var deferred = $.Deferred()
				            $.getJSON(urlPreparacao,{
	        	            	method	:"pesquisaPreLote",
	        	            	filter	: JSON.stringify(args.filter),
	        	            	sort	: JSON.stringify(args.sort),
	        	            	take	: JSON.stringify(args.take),
	        	            	skip	: JSON.stringify(args.skip),
		        	    	},function(result){
								deferred.resolve(
									result.data, {
										totalCount: result.totalCount
									});
							});
							return deferred.promise();
	    	    		}	
	    			}),
	    			remoteOperations	: true,
		    		selection: { mode: "single" },
					filterRow: { visible: true },
					hoverStateEnabled: true,
					paging: { enabled: true, pageSize: 25 },
					pager: {
			            showPageSizeSelector: true,
	        		    allowedPageSizes: [10, 25, 50, 100],
						showInfo: true,
						showNavigationButtons: true,
	        		},				
					height: "100%",	
					showBorders: true,
					showRowLines: true,
					rowAlternationEnabled: true,
					columnFixing: {
			            enabled: true
			        },
					onSelectionChanged: function(selectedItems) {
						if (selectedItems.selectedRowsData.length>0){
							$("#divForm").dxForm("instance").updateData("preLote",selectedItems.selectedRowKeys[0].CodigodoPreLote)
							$("#openPopup").dxPopup("instance").hide()
						}
					}
				}).dxDataGrid("instance")
			}
			
			function carregaPreLote(codigo){
				if (flVoltaCodigo) {
					flVoltaCodigo=0
					return
				}
				if (alterado){
					var result = DevExpress.ui.dialog.confirm("Há dados não salvos. Deseja prosseguir?", "Dados não salvos");
				    result.done(function(dialogResult) {
				        if (!dialogResult){
					        flVoltaCodigo=1
					        $("#divForm").dxForm("instance").updateData("preLote",codRegraGlobal)
					        return
						}
						loadPanel.show()
						$.ajaxSetup({async: false});	
						setTimeout(function(){ 
							carregaPreLote2(codigo)
						},10)
				    })
				    result.fail(function(){
				        flVoltaCodigo=1
				        $("#divForm").dxForm("instance").updateData("preLote",codRegraGlobal)
				        return
					})
				}else{
					loadPanel.show()
					setTimeout(function(){ 
						$.ajaxSetup({async: false});	
						carregaPreLote2(codigo)
					},10)
				}
			}
			function carregaPreLote2(codigo){	
				
				codRegraGlobal = codigo	
				$.getJSON(urlPreparacao,{
                    method:"recPreLote",
                    codigo: codigo
                },function(retorno){
	               	formGeral = $("#divGeral").dxForm("instance")
	               	formGeral.beginUpdate()
	                if (codigo==""){
						$("#toolbar").dxToolbar("instance").option("items[0].options.disabled",false)
						$("#toolbar").dxToolbar("instance").option("items[1].options.disabled",true)
						$("#toolbar").dxToolbar("instance").option("items[2].options.disabled",true)
						formGeral.itemOption("principal.atendente","disabled",false)
						formGeral.itemOption("principal.convenio","disabled",false)
						formGeral.itemOption("principal.dataHoraInicial","disabled",false)
						formGeral.itemOption("principal.dataHoraFinal","disabled",false)
						formGeral.itemOption("faturas","visible",false)
	                }else{
						if (retorno.formGeral.codSituacao==0||retorno.formGeral.codSituacao==3){
							$("#toolbar").dxToolbar("instance").option("items[0].options.disabled",false)
							$("#toolbar").dxToolbar("instance").option("items[1].options.disabled",false)
							$("#toolbar").dxToolbar("instance").option("items[2].options.disabled",false)
		               	}else{
			            	$("#toolbar").dxToolbar("instance").option("items[0].options.disabled",true)
			            	$("#toolbar").dxToolbar("instance").option("items[1].options.disabled",true)
			            	$("#toolbar").dxToolbar("instance").option("items[2].options.disabled",true)
		               	}
						formGeral.itemOption("principal.atendente","disabled",true)
						formGeral.itemOption("principal.convenio","disabled",true)
						formGeral.itemOption("principal.dataHoraInicial","disabled",true)
						formGeral.itemOption("principal.dataHoraFinal","disabled",true)
						formGeral.itemOption("faturas","visible",true)
	                }
	                formGeral.endUpdate()
	                carregarDados = 1
	                $("#divGeral").dxForm("instance").resetValues()
	                $("#divGeral").dxForm("instance").option("formData",retorno.formGeral)
	                $("#divControle").dxForm("instance").option("formData",retorno.formControle)
					carregarDados = 0
					campoAlterado(0)
	                loadPanel.hide()
	                $.ajaxSetup({async: true});
	            });
			}
			
			function carregaDataSources(){
				dataSourcePreLote = 	new DevExpress.data.DataSource({
		            store: new DevExpress.data.CustomStore({
						loadMode: "raw",
			            load: function(args) {
		                    return $.getJSON(urlPreparacao,{
		    	            	method	:"getPreLote",
	                        	skip:args.skip,
	                        	take:args.take,
	                        	filter:JSON.stringify(args.filter),
	                        	searchValue:args.searchValue
			                });
		                }
		            })
		        })		        

				dataSourceAtendente = 	new DevExpress.data.DataSource({
		            store: new DevExpress.data.CustomStore({
			            load: function(args) {
		                    return $.getJSON(urlPreparacao,{
		    	            	method	: "getAtendente",
	                        	skip	: args.skip,
	                        	take	: args.take,
	                        	filter	: JSON.stringify(args.filter),
	                        	searchValue : args.searchValue
			                });
		                }
		            })
				})


			}
			
			// Salva os dados da abas "Geral", "Endereço", "Contato"
			function salvarDados(){
				var preLote		= $("#divForm").dxForm("instance").option("formData").preLote
				var abaGeral	= $("#divGeral").dxForm("instance")
				if (!abaGeral.validate().isValid){
		        	DevExpress.ui.notify("Há campos pendentes de preenchimento", "warning", 4000);
			        return
				}
				$.post(urlPreparacao,{
					method			: "salvar",
					preLote			: preLote,
					camposGeral		: JSON.stringify(abaGeral.option("formData"))
				},function(retorno){
					DevExpress.ui.notify(retorno.mensagem, retorno.type, 4000);
					if (retorno.status==1){
						campoAlterado(0)
						dataSourcePreLote.reload()
						dataSourcePreLote.pageIndex(0)
						if ($("#divForm").dxForm("instance").option("formData").preLote==retorno.preLote){
							carregaPreLote(retorno.preLote)
						}else{
							$("#divForm").dxForm("instance").updateData("preLote",retorno.preLote)
						}
					}
				},"json")
			}			
			
			
			// Enviar a pré-nota para validação
			function enviarPreLote(){
				var preLote		= $("#divForm").dxForm("instance").option("formData").preLote
				var result = DevExpress.ui.dialog.confirm("Confirma o envio do pré-lote?", "Envio do Pré-Lote");
			    result.done(function(dialogResult) {
					if (!dialogResult){
						return
					}
					$.post(urlPreparacao,{
						method			: "enviarPreLote",
						preLote			: preLote
					},function(retorno){
						DevExpress.ui.notify(retorno.mensagem, retorno.type, 4000);
						if (retorno.status==1){
							campoAlterado(0)
							carregaPreLote(preLote)
						}
					},"json")				
			    })
			}

			function removerDados(){
				var preLote		= $("#divForm").dxForm("instance").option("formData").preLote
				var result = DevExpress.ui.dialog.confirm("Deseja <font color=red>REMOVER</font> o pré-lote?", "Exclusão de Registro");
			    result.done(function(dialogResult) {
					if (!dialogResult){
						return
					}
					$.post(urlPreparacao,{
						method			: "removerPreLote",
						preLote			: preLote
					},function(retorno){
						DevExpress.ui.notify(retorno.mensagem, retorno.type, 4000);
						if (retorno.status==1){
							campoAlterado(0)
							$("#divForm").dxForm("instance").updateData("preLote","")
							dataSourcePreLote.reload()
							dataSourcePreLote.pageIndex(0)
						}
					},"json")				
			    })
			}

			// Monta abas - chamado automaticamente ao término da montagem do form 'divForm'
			function montaAbas(){
				montaAbaGeral()
				montaAbaControle()
			}
			
			
			// Monta aba 'Geral'
			function montaAbaGeral(){
				$("#divGeral").dxForm({
				    activeStateEnabled	: true,
				    alignItemLabels: true,
				    alignItemLabelsInAllGroups: true,
				    height: function () {
				        return window.innerHeight - 170
				    },
				    onContentReady	: function(){
					    montaGridFaturas()
				    },
				    minColWidth: 50,
				    onFieldDataChanged: function(e){
					    if (e.value==undefined) return
					    campoAlterado(1)
				    },
				    screenByWidth: function (width) {
				        return "lg";
				    },
					scrollingEnabled	: true,
				    items		: [{
					    itemType	: "group",
						colCount	: 12,    
					    cssClass	: "first-group",
					    name		: "principal",
						items 	: [{
						    colSpan		: 8,
						    dataField	:	"atendente",
						    label		: {
							    alignment: "right",
							    text	: "Atendente"
						    },
						    editorType	: "dxTagBox",
							editorOptions: {
								readOnly	: false,
								placeholder:"Todos os Atendentes",
								dataSource	: dataSourceAtendente,
			    		        valueExpr	: "codigo", 
								displayExpr	: "descricao",
								searchEnabled: true,
			                },
					    },{
						    colSpan		: 4,
						    dataField	:	"situacao",
						    label		: {
							    alignment: "right",
							    text	: "Situação"
						    },
						    editorOptions:{
						    	readOnly	: true,
						    }
					    },{
						    colSpan		: 6,
						    dataField	: "convenio",
						    label		: {
							    alignment: "right",
							    text	: "Convênio"
						    },
						    editorType	: "dxSelectBox",
						    editorOptions: {
							    readOnly	: false,
							    placeholder:"Todos os Convênio",
									dataSource: new DevExpress.data.DataSource({
										store: new DevExpress.data.CustomStore({
											byKey: function(args) {
												return $.getJSON(urlPreparacaoOrc,{
													method:	"GetConvenio",
													pCodConvenio: args
												});
											},
											load: function(args) {
												return $.getJSON(urlPreparacaoOrc,{
													method				:	"GetConvenio",
													pSkip					:	args.skip,
													pTake					:	args.take,
													pSearchValue	:	args.searchValue,
													pCodConvenio  : "",
													pParticular 	: 0,
													pFlagConvenio : 1,
													pConvenio 		: ""

												});
											}
										})
									}),
									showClearButton: true,
									displayExpr: "NomeOrganizacao",
									valueExpr: "CodOrganizacao",
									searchEnabled: true,
						    }
					    },{
						    colSpan		: 3,
						    dataField	: "dataHoraInicial",
						    validationRules: [{ type: "required" }],        
						    label		: {
							    alignment: "right",
							    text	: "Data/Hora Inicial"
						    },
						    editorType	: "dxDateBox",
						    editorOptions: {
    		                	placeholder:"Informe a data/hora inicial...",
							    type		: "datetime",
							    openOnFieldClick	: true,
							    showAnalogClock		: true,
							    showClearButton		: true,
							    onValueChanged: function (e) {
				 					var form = $("#divGeral").dxForm("instance");
				 					if (e.value == "" || e.value == null) {
            							form.getEditor("dataHoraFinal").option("min", null);
				 					}else{
            							form.getEditor("dataHoraFinal").option("min", e.value);
				 					}
        						}
						    }
					    },{
						    colSpan		: 3,
						    dataField	:	"dataHoraFinal",
						    validationRules: [{ type: "required" }],        
						    label		: {
							    alignment: "right",
							    text	: "Data/Hora Final"
						    },
						    editorType	: "dxDateBox",
						    editorOptions: {
    		                	placeholder:"Informe a data/hora final...",
							    type		: "datetime",
							    openOnFieldClick	: true,
							    showAnalogClock		: true,
							    showClearButton		: true,
							    onValueChanged: function (e) {
				 					var form = $("#divGeral").dxForm("instance");
				 					if (e.value == "" || e.value == null) {
            							form.getEditor("dataHoraInicial").option("max", null);
				 					}else{
            							form.getEditor("dataHoraInicial").option("max", e.value);
				 					}
        						}

						    }
					    }],
				    },{
					    itemType: "group",
					    caption	: "Faturas",
					    name	: "faturas",
					    cssClass: "second-group",
					    visible	: true,
					    items:[{
						    template	: "<div id='divFaturas'></div>"
					    }]
				    }]
				})
			}

			function acaoCampoInserir() {
				var pFatura = $(".txtInformarNumFatura").dxTextBox("instance").option("value");
				if (pFatura == "" || pFatura == null) {
					DevExpress.ui.notify("Informar o Número da Fatura","warning");										
					return;
				}
				inserirFatura(pFatura);
				$(".txtInformarNumFatura").dxTextBox("instance").option("value","");
				$(".txtInformarNumFatura").dxTextBox("instance").focus(); 
			}
			
			function inserirFatura(pNumFatura){
				$.get(urlPreparacao,{method: "validarFaturaPreNota", codFatura: pNumFatura,
				preLote : $("#divForm").dxForm("instance").option("formData").preLote},function(resp){
					if (resp == 0) {
						DevExpress.ui.notify("Fatura inválida.","warning");										
					}else{
						$.getJSON(urlPreparacao,{method: "insereFaturaPreNota", codFatura: pNumFatura},function(resp){
							campoAlterado(1)
							$("#divFaturas").dxDataGrid("instance").getDataSource().reload()
						},"post")
					}
				});
			}

			// Monta Grid Faturas
			function montaGridFaturas(){
				$("#divFaturas").dxDataGrid({
					columns: [{
						dataField	: "codFatura",
						caption		: "Número da Fatura"
					},{
						dataField	: "dataAbertura",
						caption		: "Data de Abertura",
						dataType	: "date",
					},{
						dataField:"paciente",
						caption:"Paciente"
					},{
						dataField:"carteirinha",
						caption:"Carteirinha"
					},{
						dataField:"convenioPlano",
						caption:"Convênio/Plano"
					},{
						dataField:"valorTotal",
						caption:"Valor Total",
						dataType	: "number",
						format		: "#,##0.00"
					},{
						dataField:"situacao",
						caption:"",
						width:"40px",
						cellTemplate: function (container, options) { 
							if (options.data.invalido){
								conteudo = "<div class='custom-item'><i class='fas fa-info-circle' style='color:red;cursor:pointer'></i></div>";
							}else{
								conteudo = "<div class='custom-item'><i class='fas fa-info-circle' style='color:green;cursor:pointer'></i></div>";
							}
							container.append(
								$("<div style='text-align: center;' />")
									.html(conteudo)
									.attr("title", options.data.regras)
								    .tooltip({content:function () {
								        	return this.getAttribute("title");
								    	}
								    })
									.appendTo(container)
							);
						}
					}],
					dataSource:  new DevExpress.data.CustomStore({
	            		load: function(args) {
		            		return $.getJSON(urlPreparacao,{
	        	            	method	:"recFaturasPreLote"
		        	    	})
	    	    		},
	    	    		remove : function(args){
		            		return $.getJSON(urlPreparacao,{
	        	            	method			:"removeFaturasPreLote",
	        	            	codFatura		: args.codFatura
		        	    	},function(){
			        	    	campoAlterado(1)
			        	    })
	    	    		}
	    			}),
	    			editing: {
		            	mode: "cell",
		            	allowDeleting: true,
                    	useIcons: true,
	    			},
		    		selection: { mode: "single" },
					filterRow: { visible: true },
					hoverStateEnabled: true,
					paging: { enabled: true, pageSize: 25 },
					pager: {
			            showPageSizeSelector: true,
	        		    allowedPageSizes: [10, 25, 50, 100],
						showInfo: true,
						showNavigationButtons: true,
	        		},				
					height: function (){
						return window.innerHeight - 280
					},	
					showBorders: true,
					showRowLines: true,
					rowAlternationEnabled: true,
					onToolbarPreparing: function(e) {
						e.toolbarOptions.items.unshift({
							location: "before",
							widget: "dxTextBox",
							options: {
								elementAttr: { class: "txtInformarNumFatura" },
								width: 250,
								placeholder: "Informar o Nº da Fatura",
								onKeyUp: function (e) {
									if (e.event.keyCode == 13) {
										acaoCampoInserir();
									}
								},
								buttons: [{
									location:"after",
									name: "readAdmissao",
									options:{
										icon: "fas fa-check",
										hint: "Admitir",
										type: "default",
										stylingMode : "contained",
										onClick	: function(e){
											acaoCampoInserir();
										}
									}
								}]								
							}
						},{
							location: "after",
							widget: "dxButton",
							options: {
								icon: "add",
								text: "Inserir Fatura",
								type: "default",
								hint: "Inserir Fatura no Pré Lote",
								onClick: function(e) {
									insereFaturaPreLote()
								}
							}
						})
					},					
				})
			}
			
			// Abre popup para pesquisar por faturas para inserção no pré-lote
			function insereFaturaPreLote(){
				 popupOptions = {
			        width: "90%",
			        height: "90%",
			        showTitle: true,
			        title: "Pesquisa Faturas",
			        visible: true,
			        dragEnabled: false,
			        closeOnOutsideClick: false
			    }	
			    $("#openPopup").remove()
			    $(document.body).append("<div id='openPopup'></div>")
	   			$("#openPopup").html("<div id='pesquisaPopup'></div>")
				$("#openPopup").dxPopup(popupOptions)
				preparaPesquisaFaturaPreLote()
			}		
			
			function preparaPesquisaFaturaPreLote(){
		        $("#pesquisaPopup").dxDataGrid({
			        columns:[{
						dataField	: "Fatura",
						caption		: "Fatura"
				   	},{
						dataField	: "CodigodoPaciente",
						caption		: "Paciente"
				   	},{
						dataField	: "DataHoraAdmissao",
						caption		: "Data/Hora de Admissão",
						dataType	: "datetime",
						sortIndex : 1,
						sortOrder : "asc"
				   	},{
						dataField	: "NumeroPreLote",
						caption		: "Consta em Pré-Lote?",
						sortIndex : 0,
						sortOrder : "desc"
				   	}],
					dataSource:  new DevExpress.data.CustomStore({
	            		load: function(args) {
		            		var deferred = $.Deferred()
				            $.getJSON(urlPreparacao,{
	        	            	method	:"pesquisaFaturaPreLote",
	        	            	preLote : $("#divForm").dxForm("instance").option("formData").preLote,
	        	            	filter	: JSON.stringify(args.filter),
	        	            	sort	: JSON.stringify(args.sort),
	        	            	take	: JSON.stringify(args.take),
	        	            	skip	: JSON.stringify(args.skip),
		        	    	},function(result){
								deferred.resolve(
									result.data, {
										totalCount: result.totalCount
									});
							});
							return deferred.promise();
	    	    		}	
	    			}),
	    			remoteOperations	: true,
		    		selection: { allowSelectAll: false, mode: "multiple" },
					filterRow: { visible: true },
					hoverStateEnabled: true,
					paging: { enabled: true, pageSize: 25 },
					pager: {
			            showPageSizeSelector: true,
	        		    allowedPageSizes: [10, 25, 50, 100],
						showInfo: true,
						showNavigationButtons: true,
	        		},				
					height: "100%",	
					showBorders: true,
					showRowLines: true,
					rowAlternationEnabled: true,
					columnFixing: {
			            enabled: true
			        },
					onSelectionChanged: function(selectedItems) {
						if (selectedItems.currentDeselectedRowKeys.length>0) {
							for (var i = 0 ; i < selectedItems.currentDeselectedRowKeys.length; i++){
								$.getJSON(urlPreparacao,{
						  		method		:"removeFaturasPreLote",
						  		codFatura	: selectedItems.currentDeselectedRowKeys[i].Fatura
						  	},function(resp){
							  	campoAlterado(1)
							  	$("#divFaturas").dxDataGrid("instance").getDataSource().reload()
								//$("#openPopup").dxPopup("instance").hide()
						  	},'post')
							}
						}else{
				  		$.getJSON(urlPreparacao,{
					  		method		:"insereFaturaPreNota",
					  		codFatura	: selectedItems.currentSelectedRowKeys[0].Fatura
					  	},function(resp){
						  	campoAlterado(1)
						  	$("#divFaturas").dxDataGrid("instance").getDataSource().reload()
							//$("#openPopup").dxPopup("instance").hide()
					  	},'post')
						}
					}
				}).dxDataGrid("instance")
			}
			
			
			// Monta aba 'Faturamento'
			function montaAbaFaturamento(){
				$("#divFaturamento").dxForm({
					scrollingEnabled	: true,
				    activeStateEnabled	: true,
				    minColWidth			: 50,
				    screenByWidth: function (width) {
				        return "lg";
				    },
				    height: function () {
				        return window.innerHeight - 170
				    },
				    alignItemLabels: true,
				    alignItemLabelsInAllGroups: true,
				    items		: [{
					    cssClass	: "first-group",
					    itemType	: "group",
					    name		: "primeiroGrupo",
					    colCount	: 12,
						items		: []
				    }]
				})
			}


			// Monta aba 'Controle'
			function montaAbaControle(){
				$("#divControle").dxForm({
					scrollingEnabled	: true,
				    activeStateEnabled: true,
				    minColWidth: 50,
				    readOnly	: true,
				    screenByWidth: function (width) {
				        return "lg";
				    },
				    height: function () {
				        return window.innerHeight - 170
				    },
				    alignItemLabels: true,
				    alignItemLabelsInAllGroups: true,
				    items		: [{
					    cssClass	: "first-group",
					    itemType	: "group",
						items		: [{
						    dataField	:	"criadoEm",
						    label		: {
							    alignment: "right",
							    text	: "Criado Em"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"criadoPor",
						    label		: {
							    alignment: "right",
							    text	: "Criado Por"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"alteradoEm",
						    label		: {
							    alignment: "right",
							    text	: "Alterado Em"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"alteradoPor",
						    label		: {
							    alignment: "right",
							    text	: "Alterado Por"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"enviadoEm",
						    label		: {
							    alignment: "right",
							    text	: "Enviado Em"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"enviadoPor",
						    label		: {
							    alignment: "right",
							    text	: "Enviado Por"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"confirmadoEm",
						    label		: {
							    alignment: "right",
							    text	: "Confirmado Em"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						},{
						    dataField	:	"confirmadoPor",
						    label		: {
							    alignment: "right",
							    text	: "Confirmado Por"
						    },
						    editorOptions: {
							    width: "300px"
						    }
						}]
				    }]
				})
			}

			function campoAlterado(flAlterado){
				if (carregarDados) return
				if (alterado != flAlterado){
					alterado = flAlterado
					if (alterado){
						$("#botaoSalvar").removeClass("dx-button-default").addClass("dx-button-success")
					}else{
						$("#botaoSalvar").removeClass("dx-button-success").addClass("dx-button-default")
					}
				}
			}
		</script>
	</body>
</html>
