<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
<script language="Cache" runat="server">
    do ^WWWVAR

	set YUSER = $get(%request.Data("YUSER", 1))
    set YBED = $get(%request.Data("YBED", 1))
    set YM = $get(%request.Data("YM", 1))
    set YLOCATION = $get(%request.Data("YLOCATION", 1))

    set codPaciente = $get(%session.Data("VARPEPPremium_paciente"))
    ;
    set bird = $$getBirdID^VARCSPUtils(YBED,YUSER)
    set token = $piece(bird,"~",1)
    set userBird = $piece(bird,"~",2)
	;
    set PortCache = $get(%request.CgiEnvs("SERVER_PORT"))
    set PageURL = $get(%request.CgiEnvs("CACHE_URL"))
    set PageName = %request.PageName
    set app = %request.Application
    set host = %request.CgiEnvs("HTTP_HOST")
    set url = "http://"_host_app
	set param="EP=1&YBED="_YBED_"&YUSER="_YUSER_"&YLOCATION="_YLOCATION
	set paramEncrypt = $piece(##class(COM.fwk.ui.csp.CSPUtil).encrypt(param),"id_key=",2)
    set URLPreparacao = "VAR.CSP.VARPEPPremium.cls"

    set URLLogin = "COMLogin.cls"
    set URLLink = "www.cls"

    set nomeLocal = YLOCATION_" - "_$$SQLGetLocationName^VARSQL(YLOCATION)
	
    //Verifica se a sessão
    set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
    // bgColor ->  Cor de Fundo do Formulário
    set temaC = $get(^VARPEPPremiumOpc(YBED,"tema"))
    set tema=2
    if temaC=1 set tema=1 
    ;
    set linhaTempo = $get(^VARPEPPremiumOpc(YBED,"linhaTempo"))
    set opcoes = $get(^VARPEPPremiumOpc(YBED,"opcoes"))
    set layout = $get(^VARPEPPremiumOpc(YBED,"layout"))+1
    set opcoes=0
    set linhaTempo = 0
    ;
    if tema=1{
	    set estiloDev = YGIF_"global/plugins/extreme19.2.4/css/dx.light.css"
	    set corFonte = "#fff"
	    set corFonteLabel = "#007Baa"
	    set corOpcoesFonteLabel = "#fff"
	    set corFonteCaixas = "#007Baa"
	    set tabColorFonte = "#007Baa"
	    set tabColorFonteSel = "#fff"
	    set corRodape = "#007B99"
	    set corT1 = "#007Baa"
	    set corT2 = "#007Bcc"
	    set corFonteButton = "#333"
	    ;
	    set corSubT = "#007Bcc"
	    set corSubT1 = "#007Bcc"
	    set corHeader="#eee"
	    set corBordaDeta = "#007Bcc"
	    set corFonteHeader="#007Baa"
	    set corMenu = "rgb(240, 240, 240)"
	    set bgColor = "rgb(255, 255, 255)"
	    set bgColorGrid = "rgb(255, 255, 255)"
	    set bgColorOpcoes = "#007Bcc"
	    set corSecundaria = "rgb(250, 250, 250)"
	    set corTextGeral = "rgb(250, 250, 250)"
	    set corTerciaria = "rgb(250, 250, 250)"
	    set corSelectBoxSel = "rgb(200, 200, 200)"
	    set corFundoText = "#fff"
	    set bgImagem = "url("_YGIF_"PEP/premium/estetoscopio_fundo.jpg)"
	    set sombra1 = "#aaa"
	    set sombra2 = "#ccc"
	    set corAlerta = "rgb(230,0,0)"
	    set corAlertaFonte = "#fff"
	    set bordaTile = "#007Baa"
	    set tabColor = "#ddd"
	    set tabColorBorda = "#fff"
	    set corSubGrupo = "#eeeeee"
	    set corSubGrupo2 = "#ffffff"
	    set corPopup2 = "#eee"
	    set corPopupBorda = "#ccc"
	    set corFonteEstadiamento = "red"
	    set corAbaSelecionada = "#007Baa"
	    set corScroll = ""
	    set corBotao1 = ""
	    set corBotao2 = ""
	    set corBotao3 = ""
	    set corBordaTexto = ""
	    set corLinha = "#007Baa"
	    set corLinhaFraca = "#007Baa"
	    set corFundoImagens="#007Baa"
	    set corBordaImagens="#007Baa"
	    set corFonteBotao = "#fff"
	    set corHints = "red"
	    set corEstadiamentoFonte = "#007Baa"
	    set corLoadPanel = "rgba(0,0,0,0.1)"
	    set detalheImagemBorda = "2px solid yellow"
	    set botaoSelecionado = "2px solid red"
	    set corHeaderRight = "#007Baa"
	    set caixaMarcada = "green"
	    set caixaDesmarcada = "red"
	    set caixaDesabilitada = "rgb(128,128,128)"
	    set caixaDefault = "rgb(128,128,128)"
	    set corDestaque1 = "#ccc"
	    set corDestaque2 = "#ddd"
	    set corDestaqueLegenda = "#007Baa"
    }
    if tema=2 {
	    set estiloDev = YGIF_"global/plugins/extreme19.2.4/css/dx.dark.css"
	    set corFonte = "#64daff"
	    set corFonteLabel = "#64daff"
	    set corOpcoesFonteLabel = "#64daff"
	    set corFonteCaixas = "#64daff"
	    set corFonteLabelDadosGerais = "#64daff" 
	    set tabColorFonteSel = "#64daff"
	    set tabColorFonte = "#64daff"
	    set corRodape = "#000"
	    set corT1 = "#000"
	    set corT2 = "#000"
	    set corFonteButton = "#dedede"
	    set corSubT = "#000"
	    set corSubT1 = "#111"
	    set corHeader="#000"
	    set corBordaDeta = "#000"
	    set corFonteHeader="#fff"
	    set bgColor = "rgb(40, 40, 40)"
	    set bgColorGrid = "rgb(70, 70, 70)"
	    set bgColorOpcoes = "rgb(40, 40, 40)"
	    set corTextGeral = "rgb(60, 60, 60)"
	    set corSecundaria = "rgb(70, 70, 70)"
	    set corTerciaria = "rgb(15, 15, 15)"
	    set corSelectBoxSel = "rgb(15, 15, 15)"
	    set corMenu = "rgb(20, 20, 20)"
	    set corFundoText = "rgb(120, 120, 120)"
	    set bgImagem = ""
	    set sombra1 = "rgb(0, 0, 0)"
	    set sombra2 = "rgb(0, 0, 0)"
	    set corAlerta = "rgb(200,0,0)"
	    set corAlertaFonte = "#fff"
	    set bordaTile = "#000"
	    set tabColor = "#666"
	    set tabColorBorda = "#000"
	    set corSubGrupo = "#111111"
	    set corSubGrupo2 = corSecundaria
	    set corPopup2 = "#444"
	    set corPopupBorda = "#333"
	    set corFonteEstadiamento = "yellow"
	    set corAbaSelecionada = "yellow"
	    set corScroll = "rgba(0, 0, 0,.3)"
	    set corBotao1 = "rgb(30, 30, 30)"
	    set corBotao2 = "rgb(40, 40, 40)"
	    set corBotao3 = "rgb(50, 50, 50)"
	    set corBordaTexto = "yellow"
	    set corLinha = "#64daff"
	    set corLinhaFraca = "rgb(0,116,132)"
	    set bordaTile = ""
	    set corFundoImagens="rgb(60, 60, 60)"
	    set corBordaImagens="rgb(40, 40, 40)"
	    set corFonteBotao = "#ffffff"
	    set corHints = "yellow"
	    set corEstadiamentoFonte = "#fff"
	    set corLoadPanel = "rgba(0,0,0,0.3)"
	    set detalheImagemBorda = "1px solid yellow"
	    set botaoSelecionado = "1px solid yellow"
	    set corHeaderRight = "rgb(30, 30, 30)"
	    set caixaMarcada = "rgb(100,255,100)"
	    set caixaDesmarcada = "rgb(255,100,100)"
	    set caixaDesabilitada = "rgb(128,128,128)"
	    set caixaDefault = "rgb(255,255,255)"
	    set corDestaque1 = "#111"
	    set corDestaque2 = "#222"
	    set corDestaqueLegenda = "#333"
	}
</script>

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>MAPPA -  Medical Analytics Platform for Precision Assistance</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

    <!-- Custom Elements -->
    <link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
    <link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
    <link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
    <link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
    <link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />


    <link type="text/css" rel="stylesheet" href="#(YGIF)#fonts/googlesans/googlesans.css">

    <!-- DevExtreme themes -->
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href="#(estiloDev)#" />

    <csp:include page="VARPEPPremiumEstilos.csp">

</head>
    <script type="text/javascript">
    	var layout = "#(layout)#"
    	var ultimoId = ""
    	var idRetorno = ""
        var status = '#(status)#';
        var URLLogin = '#(URLLogin)#';
        var ygif = '#(YGIF)#'

        if (status == 0) {
            alert('Usuário não está logado ou a sessão expirou.')
            window.location.replace(URLLogin)
        }
        
    </script>

<body scroll="no"  style="overflow: hidden">

	
	<div id="toolbar" class="toolbar"></div>
	<div id='contextMenuContainer'></div>
	<div id="divFormDadosGerais" style='position:absolute;top:46px;'></div>
	<div id="divRodapeExit" style='position:absolute;top:46px;'></div>
	<div id="divFormLinhaTempo" style='position:absolute;top:50px;left:341px;'></div>
	<div id="divFormAtendimentoClinicoAcc" style='position:absolute;left:341px;'></div>
	<div id="divFormAtendimentoClinico" style='position:absolute;left:341px;'></div>
	<div id="divFormAtendimentoClinicoRelatorios" style='position:absolute;left:341px;'></div>
	<div id="divFormAtendimentoClinicoSugestao" style='position:absolute;left:341px;'></div>
	<div id="divFormOpcoesGerais" style='position:absolute;top:-10px;'></div>
	<div id="divFormEscolhaFicha" style='position:absolute;left:341px;'></div>
	<div id="openPesquisa"></div>
	<div id="openPesquisaSub"></div>
	<div id="openPesquisa2"></div>
	<div id="openPesquisa3"></div>
	<div id="openHistorico"></div>
    <div id="loadpanel"></div>
	<div id="dvDialog"></div>    
    <div id="ttip" class='tooltips'></div>

    <!-- REQUIRED JS SCRIPTS -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src=" #(YGIF)#global/plugins/extreme19.2.4/js/jquery.min.js"></script>

	<!-- JSZip library -->
	<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/jszip.min.js"></script>

    <!-- A DevExtreme library -->
    <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/dx.all.js"></script>
    
    <!-- DevExtreme-Intl module -->
    <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/localization/dx.messages.pt.js"></script>
    
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>

    <script src=' #(YGIF)#global/plugins/d3/d3.v3.min.js'></script>


	<csp:include page="VARPEPPremiumPrimario.csp">

    <!--Definições globais e criação de funcionalidades encapsuladas-->
    <script type="text/javascript">
    	//Deixando variáveis disponíveis no cliente
        var limparfl=0
        var tempoPanel = ""
        var estadiamentoPossivel = 0
        var sairMenu = 1
        var linhaTempo = '#(linhaTempo)#'
        var ficha	 = ""
        var fichaSeq = 1
        var exibirTodos = 0
        var meuMenu = ""
        var arrayAtendimentoClinico = []
        var arrayAtendimentoClinicoDestaque = []
        var opcoesSimNao = 0
        var meuIDMenu = ""
        var alterarMult = 1
        var alteraCheck = 0
        var vetorDatas = []
        var CategoriaAnt = ""
        var agoraLinhaTempo =  ""
        var urlPreparacao = '#(URLPreparacao)#';
        var urlLink = '#(URLLink)#';
        var YBED = '#(YBED)#';
        var YUSER = '#(YUSER)#';
        var YLOCATION = '#(YLOCATION)#';
        var nomeLocal = '#(nomeLocal)#';
		var codPaciente = ""
		var codPacienteValor = ""
		var sexoPaciente = ""
		var codCID = ""
		var tamanhoToolBar = 46
		var painelAtual = ""
		var painelIndexAtual = -1
		var cancelaSelecao = 0
		var bordaYesNo = "border:1px solid yellow"
		var ygif = '#(YGIF)#'
		var dxFormulario = ""
		var corT1 = '#(corT1)#'
		var corFonte = '#(corFonte)#';
		var corAlerta = '#(corAlerta)#'
		var corAlertaFonte = '#(corAlertaFonte)#'
		var corSecundaria = '#(corSecundaria)#'
		var corHeader = '#(corHeader)#'
		var corBordaDeta = '#(corBordaDeta)#'
		var corTerciaria = '#(corTerciaria)#'
		var corLinha = '#(corLinha)#'
		var corFonteCaixas = '#(corFonteCaixas)#'
		var caixaMarcada = "#(caixaMarcada)#"
	    var caixaDesmarcada = "#(caixaDesmarcada)#"
		var caixaDesabilitada = "#(caixaDesabilitada)#"
		var caixaDefault = "#(caixaDefault)#"
		var sombra1 = "#(sombra1)#"
		var corHints = "#(corHints)#"
		var dados = ""
		var retornoPainel = ""
		var dataPEP = ""
		// Prepara o formulário

		$.ajaxSetup({
		  headers : {   
		    'id_key' : '#(paramEncrypt)#'
		  }
		});

		var prepareSearchInputs = (function () {
			preparaToolBar()
			preparaDadosGerais()
			preparaOpcoesGerais()
			setInterval(function(){ mantemSessaAberta() }, 300000);
			loadPanel.hide();
        });
		
		function mantemSessaAberta(){
			$.getJSON(urlPreparacao,{
				method:"validaSessao"
			},function(ret){
				if (ret.erro){
					alert(ret.mensagem)
				}
			})
		}
		
		function imprimir(tipo,titulo){
			if (!codPacienteValor){
				DevExpress.ui.notify("Informe o paciente", "warning", 4000);
				return
			}
			var fRemoverImprimirData = 0
			if (tipo == 2 || tipo == 3) {
				fRemoverImprimirData = pesquisaExamesSub.getEditor("removeDataHoraImpRequisicao").option("value");
			}
			fichatemp = ficha
			var result = DevExpress.ui.dialog.confirm("Confirma a impressão?", "Imprimir "+ titulo);
		    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
		    result.done(function(dialogResult) {
		        if (!dialogResult){
			        return
				}
				
				loadPanel.show();
				$.get(urlPreparacao,{
	                method			:"getImpressoes",
	                tipoImpressao 	: tipo,
	                codPaciente		: codPacienteValor,
	                codCID			: codCID,
			        ficha 			: fichatemp,
			        fichaSeq		: fichaSeq,
	                dataPEP			: dataPEP,
	                layout			: layout,
	                fRemoverImprimirData: fRemoverImprimirData
	            },function(retorno){
		            eval(retorno)
		            loadPanel.hide();
		            //loadPanel.option("message","Carregando...")
					return
		            if (retorno!=""){
						window.location.assign(retorno);
		            }else{
			            DevExpress.ui.notify("Não foi possível realizar a assinatura do documento!", "warning", 4000);
		            }
		            loadPanel.hide();

		            return
		            var b64 = btoa(retorno);
					$.getJSON(urlPreparacao,{
		                method			:"enviaAssinatura",
		                file 			: b64
					},function(ret){
						if (ret.status!=0){
							window.open(ret.result)
						}else{
							DevExpress.ui.notify("Não foi possível realizar a assinatura do documento!", "warning", 4000);
						}
						loadPanel.hide();
					})
	            })				
		    });					    
		}

		
		function preparaToolBar(){
		 	toolBar = $("#toolbar").dxToolbar({
		        items: [{
			        location: "before",
					template: function() {
                    	return $("<img src='"+ygif+"/birdID.svg' width='50' onclick='verificaBirdID()' style='cursor:pointer;#($select(token=0:"display:none",1:""))#'></img>")
                	}
                },{
			        location: "center",
					template: function() {
                    	return $("<div class='toolbar-label'><b>MAPPA -  Medical Analytics Platform for Precision Assistance</div>");
                	}
                },{
			        location: "after",
					template: function() {
                    	return $("<form id='FormTema' name='formTema'><input id='cdPaciente' name='paciente' type='hidden' value='#(codPaciente)#'><div id='divTema' class='header1' style='position:absolute;'><table border=0 cellpadding=0 cellspacing=0><tr><td align=right><font style='font-size:10px;'>Tema Claro&nbsp;<input name='tema' type='checkbox' onclick='recarregaTema()' #($select(+temaC=1:"checked",1:""))#></input></td></tr><tr><td align=right><font style='font-size:10px;'>Layout 'Menu'&nbsp;<input name='layout' type='checkbox' onclick='recarregaTema()' #($select(+layout=2:"checked",1:""))#></input></td></tr></table></div></form><i id='botaoExibeOpcoesGerais' style='font-size:20px;top:2px;left:0px;position:relative;cursor:pointer;' class='fas fa-arrow-circle-left' title='Exibir Cadastros Auxiliares Médicos:\n- Prontuário Primário\n- Prescrição de Medicamentos\n- Solicitação de Exames' onClick ='toggleOpcoes()'>")
                	}
                }]
		    }).dxToolbar("instance")
		}
		
		function recarregaTema(){
			formTema.tema.value=0
			if (formTema.tema.checked){
				formTema.tema.value=1
			}
			valor=0
			if (formTema.layout.checked){
				valor=1
			}
	        $.getJSON(urlPreparacao,{
	        	method	: "setToggle",
	        	painel	: "tema",
	        	exibir	: formTema.tema.value
	       	},function(){
		        $.getJSON(urlPreparacao,{
			        method	: "setToggle",
			        painel	: "layout",
			        exibir	: valor,
			        paciente : $("#cdPaciente").val()
			    },function(){
					location.reload()
				});
		    })			

			
		}
		function verificaBirdID(){
			$.getJSON(urlPreparacao,{
				method:"verificaBirdID"
			},function(ret){
				if (ret==2){
					return
				}
				if (ret==0){
					autenticacaoBirdID()
				}else{
					sairBirdID()
				}
			})
		}
		function sairBirdID(){
			var result = DevExpress.ui.dialog.confirm("Deseja sair do BirdID?", "Sair do BirdID?");
		    result.done(function(dialogResult) {
		        if (!dialogResult){
			        return
				}
                $.getJSON(urlPreparacao, {method: "revokeBirdID"},function(){DevExpress.ui.notify("Desconectado do BirdID com sucesso!", "success", 4000);})
		    });					    
		}
		
		function preparaDadosGerais(){
			dadosGerais = $("#divFormDadosGerais").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					//activeStateEnabled:true,
			        width:272,
			        items: [{
				        cssClass: "dadosGerais",
				        template: "<div id='linhaDadosGerais'></div>"
			        }]
	        }).dxForm("instance")
			
			formularioDadosGerais = $("#linhaDadosGerais").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				//activeStateEnabled:true,
				items: [{
						cssClass: "linhaDadosGerais"+layout,
						template: "<div id='linhaDadosGeraisExib'></div>"
				}]
			}).dxForm("instance")
			
			formularioDadosGeraisExib = $("#linhaDadosGeraisExib").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				//activeStateEnabled:true,
				onContentReady : function(){
					$("#linhaDadosGeraisExib .dx-texteditor-input[name=paciente]").attr("disabled",true)
				},
			    scrollingEnabled	: true,
			    height:function(){
					return window.innerHeight-tamanhoToolBar-21
				},
				items: [{
			        itemType: "group",
			        items: [{
			            itemType: "group",
			            items: [{
				            cssClass: "imagem",
			                template: "<center><div class='form-avatar' style='height:105px;width:105px;'></div>"
			            },{
				            dataField	: "codPaciente",
				            visible		: false,
				            editorOptions : {
								onValueChanged: function(e) {
									carregarPaciente(e.value)
								},
				            }
			            },{
		                    dataField	: "paciente",
				            editorType	: "dxTextBox",
				            editorOptions: {
						        inputAttr: {
						            id: "dvDescPaciente"
						        },
					            maxLength:1,
				                buttons: [{
				                    name: "search",
				                    location: "after",
				                    options: {
				                        stylingMode: "text",
				                        icon: "search",
				                        onClick: function() {
					                        abrePesquisaPacientes()
				                        }
				                    }
				                }]
								
				            },
		                },{
		                    dataField: "idade",
		                    label		: {
								text	: "Idade"
							},
		                    editorOptions: {
			                    height:23,
		                        readOnly: true
		                    }
		                },{
		                    dataField: "CID",
	    	                editorOptions: {
		    	                height:23,
	            	            readOnly: true
	                	    }
		                }, {
		                    dataField: "inicioTrat",
							label		: {
								text	: "Início Trat."
							},
	    	                editorOptions: {
		    	                height:23,
	            	            readOnly: true
	                	    }
		                }, {
		                    dataField: "ultimoAtend",
							label		: {
								text	: "Últ. Atend."
							},
	    	                editorOptions: {
		    	                height:23,
	            	            readOnly: true
	                	    }
		                },{
		                    template	: "<hr class='hrClass'>"
		                },{
			                itemType	: "group",
			                colCount	: 2,
			                items		: [{
			                    dataField	: "ficha",
								label		: {
									text	: "Consulta"
								},
		    	                editorOptions: {
			    	                height:23,
		            	            readOnly: true
		                	    }
			                },{
				                cssClass	: "PEPRETRO",
			                    itemType	: "button",
								horizontalAlignment: "center",
								buttonOptions : {
						            //icon: "fas fa-undo",
						            hint: "Consulta Retrospectiva",
						            text: "Consulta Retrosp.",
						            height:26,
						            width:125,
						            onClick: function() {
							            consultaRetrospectiva()
						            }
								}
			                }]
		                },{
		                    template	: "<hr class='hrClass'>"
		                },{
			                cssClass	: "PEPCHSP",
		                    itemType	: "button",
							horizontalAlignment: "center",
							buttonOptions : {
					            icon: "fas fa-notes-medical",
					            text: "PEP CHSP/Hist. Passagens",
					            height:29,
					            onClick: function() {
						            abrePEPPrimario()
					            }
							}
		                },{
		                    template	: "<hr class='hrClass'>"
		                },{
			                cssClass	: "estadiamentoAtual",
		                    template	: "<div id='lbEstadiamento'>Estadiamento</div>"
			            },{
			                itemType: "group",
			                items: [{
				                template: "<div id='divEstadiamento'></div>"
			                }]
		                }]
		            }]
				}]	
			}).dxForm("instance")
			
			function consultaRetrospectiva(){
		        if (codPacienteValor==""){
			        DevExpress.ui.notify("Informe o paciente", "warning", 4000);
			        return
		        }
			    if ($("#openPesquisaSub").html()!=""){
			    	pesquisaExamesSub.dispose()
			    	openPesquisaSub.dispose()
			    }
			    $("#openPesquisaSub").removeClass("Layout"+layout)
	   			$("#openPesquisaSub").html("<div id='pesquisaExamesSub'></div>")
				//
	            $.getJSON(urlPreparacao,{
	                method	:"getConsultaRetrospectiva",
	                paciente: codPacienteValor,
		        	ficha	: ficha
	            },function(retorno){
			    	pesquisaExamesSub = $("#pesquisaExamesSub").dxForm({
						screenByWidth: function(width) {
				            return "lg";
				        },
				    	onContentReady: function(){
		    				openPesquisaSub = $("#openPesquisaSub").dxPopup({
						        width: '420px',
						        height: '200px',
						        showTitle: true,
						        visible: true,
						        dragEnabled: false,
						        closeOnOutsideClick: false,
								toolbarItems: [{
									location:"before",
									toolbar :"top",
									html: "Confirmar Consulta Retrospectiva?"
								},{
									widget: "dxButton",
									location:"before",
									toolbar:"bottom",
									options: { 
										width	: "130px",
										type	: "default",
										icon	: "close",
				            			text	: "Fechar", 
				            			onClick : function(){
				                			openPesquisaSub.hide()
				                		}
									}
								},{
									widget: "dxButton",
									location:"after",
									toolbar:"bottom",
									options: { 
										width	: "130px",
										type	: "default",
										icon	: "check",
				            			text	: "Confirmar", 
				            			onClick : function(){
					            			confirmaConsultaRetrospectiva()
				                		}
									}
								}],			        
		    				}).dxPopup("instance")
					    },
				    	formData	: retorno.formData,
				    	items :[{
					    	dataField: "data",
				            label:{
					            text: "Data da consulta retrospectiva",
					          	alignment: "right"  
				            },
					    	editorType  : "dxDateBox",
					    	editorOptions: {
								type : "date",
								showClearButton : false,
								useMaskBehavior : true,
								openOnFieldClick : false,
								showDropDownButton : true,
								showClearButton : true,
								max : retorno.max,
					    	}
					    }]
			    	}).dxForm("instance")
	            })
	            
			}
			
			function confirmaConsultaRetrospectiva(){
				if (pesquisaExamesSub.option("formData").data==""||(pesquisaExamesSub.option("formData").data==null)){
					var result = DevExpress.ui.dialog.confirm("Confirma a alteração desta consulta para <b>consulta normal?</b>","Confirma remoção de consulta retrospectiva");
				}else{
					var result = DevExpress.ui.dialog.confirm("Confirma a alteração desta consulta para <b>consulta retrospectiva?</b>","Confirma consulta retrospectiva");
				}
			    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
			    result.done(function(dialogResult) {
			        if (!dialogResult){
				        return
					}
					$.ajaxSetup({async: true});
					loadPanel.show();
			        $.getJSON(urlPreparacao,{
			            method		 : "setConsultaRetrospectiva",
			            paciente	 : codPacienteValor,
			            cid			 : codCID,
		                ficha		 : ficha,
		                dataConsulta : JSON.stringify(pesquisaExamesSub.option("formData").data)
			        },function(retorno){
			        	DevExpress.ui.notify(retorno.mensagem, retorno.tipo, 4000);
			        	if (retorno.status==1){
				        	carregaFicha()
			        		openPesquisaSub.hide()
			        	}
			        	$.ajaxSetup({async: true});
			        	loadPanel.hide();
				    });
			    });					    
			}
			
			$("#divRodapeExit").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				width:262,
				colCount:2,
				items:[{
					cssClass: "rodapeExit"+layout,
					itemType: "button",
					horizontalAlignment: "left",
					buttonOptions : {
			            icon: "fas fa-door-closed",
			            text: "Encerrar Consulta",
			            height:27,
			            onClick: function() {
							var result = DevExpress.ui.dialog.confirm("Deseja encerrar a consulta?", "Encerrar a consulta");
						    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
						    result.done(function(dialogResult) {
						        if (!dialogResult){
							        return
								}
				                encerrarConsulta()
						    });					    
			            }
					}
				},{
					cssClass: "rodapeExit"+layout,
					itemType: "button",
					horizontalAlignment: "right",
					buttonOptions : {
			            icon: "far fa-sign-out",
			            text: "Sair",
			            height:27,
			            onClick: function() {
							var result = DevExpress.ui.dialog.confirm("Deseja sair da rotina?", "Sair da rotina?");
						    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
						    result.done(function(dialogResult) {
						        if (!dialogResult){
							        return
								}
				                window.close()
						    });					    
			            }
					}
				}]
			})
		}

		function encerrarConsulta(){
	        $.getJSON(urlPreparacao,{
	            method		: "encerrarConsulta",
	            codPaciente	: codPacienteValor,
                dataPEP		: dataPEP,
                codCID		: codCID,
	        },function(retorno){
	        	DevExpress.ui.notify(retorno.mensagem, retorno.tipo, 4000);
	        	carregarPaciente("")
	        	abrePesquisaPacientes()
		    });
		}

		function preparaOpcoesGerais(){
			opcoesGerais = $("#divFormOpcoesGerais").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
		        width:270,
		        items: [{
			        cssClass: "dadosGerais",
			        template: "<div id='linhaOpcoesGerais'></div>"
		        }]
	        }).dxForm("instance")
			
			formularioOpcoesGerais = $("#linhaOpcoesGerais").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
	            items: [{
	                itemType: "group",
	                items: [{
						cssClass: "opcoesGeraisForm",
		            	template: "<div id='linhaOpcoesGeraisExib'></div>"
	                }]
	            }]
			}).dxForm("instance")
			
			formularioOpcoesGeraisExib = $("#linhaOpcoesGeraisExib").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				items: [{
					colCount	: 2,
					itemType: "group",
					items:[{
						template: "<div id='botaoOcultaOpcoesGerais' class='opcoesGerais' style='position:absolute;left:10px;top:19px;'><i class='dx-icon dx-icon-close' style='font-size:18px;cursor:pointer;' title='Fechar Janela Lateral' style='cursor:pointer' onclick='toggleOpcoes()'></i></div>"
					},{
						cssClass: "headerRight",
						template: "&nbsp;"
					}]
				},{
					itemType: "group",
	               	
					items:[{
						itemType: "button",
						cssClass: "btnDestaque",
						buttonOptions : {
				            icon: "fas fa-notes-medical",
				            text: "Prontuário Primário",
				            width:250,
				            height:80,
				            onClick: function() {
				                abrePEPPrimario()
				            }
						}
					}]
				},{
					cssClass: "semBordas",
					template: "<hr class='hrClass'><hr class='hrClass'>"
				},{
					itemType: "group",
	               	caption:"Atestado Médico",
					items: [{
						cssClass: "opcoesGeraisForm1",
						itemType: "button",
						buttonOptions : {
				            icon: "fas fa-file-medical",
				            text: "Atestado Médico",
				            width:250,
				            onClick: function() {
				                imprimir(6,"Atestado Médico")
				            }
						}
					}]
				},{
					itemType: "group",
	               	caption:"Pedidos Médicos",
					items: [{
						cssClass: "opcoesGeraisForm1",
						itemType: "button",
						buttonOptions : {
				            icon: "fas fa-pills",
				            text: "Prescrição de Medicamentos",
				            width:250,
				            onClick: function() {
				                abrePrescricao()
				            }
						}
					},{
						cssClass: "opcoesGeraisForm1",
						itemType: "button",
						buttonOptions : {
				            icon: "fas fa-vial",
				            text: "Solicitação de Exames",
				            width:250,
				            onClick: function() {
				                abreExames(0)
				            }
						}
					}]	
				}]
			}).dxForm("instance")
		}
		
		

		function insereLinhas(caminho,campo){
			ret = dxFormulario.itemOption(caminho).items
			ret.push("")
			scrollTop = dxFormulario._scrollable.scrollTop()
            dxFormulario.itemOption(caminho, "items", getLinesOptions(ret,campo));
            //dxFormulario.repaint()
            dxFormulario._scrollable.scrollBy(scrollTop+20)

		}

		function insereLinhasExames(caminho,campo){
			ret = dxFormulario.itemOption(caminho).items
			tamanho = ret.length/2
			ret.push("")
			tamanho = tamanho + 1
            dxFormulario.itemOption(caminho, "items", getLinesOptionsExames(tamanho,campo));

		}
		
		dataSourceExames = 	new DevExpress.data.DataSource({
	            store: new DevExpress.data.CustomStore({
                byKey: function(args) {
                    return $.getJSON(urlPreparacao,{
    	            	method	:"listaExames",
    	            	tipo	: 1,
	                    codigo	: args
	                });
                },
	            load: function(args) {
                    return $.getJSON(urlPreparacao,{
    	            	method	:"listaExames",
    	            	tipo	: 1,
						searchValue:args.searchValue,
                    	skip:args.skip,
                    	take:args.take,
	                });
	                }
	            })
	        })		        
		
		function getLinesOptions(linha,campo) {
	        var options = [];
	        for (var i = 0; i < linha.length; i++){
	            options.push(generateNewLineOptions(i,campo));
	        }
	        return options;
	    }

		function getLinesOptionsExames(tamanho,campo) {
	        var options = [];
	        for (var i = 0; i < tamanho; i++){
	            options.push(generateNewLineOptionsExames(i,campo,1));
	            options.push(generateNewLineOptionsExames(i,campo,2));
	        }
	        return options;
	    }


		function generateNewLineOptions(index,campo) {
	        return {
		        cssClass : "labelDetalhes",
	            dataField: campo+"^"+index,
	            label:{
		            text: "Marcador "+(index+1),
		          	alignment: "right"  
	            },
	            editorType: "dxTextBox",
	            /*editorOptions: {
	                buttons: [{
	                    name: "trash",
	                    location: "after",
	                    options: {
	                        stylingMode: "text",
	                        icon: "trash",
	                        onClick: function() {
	                            //employee.Phones.splice(index, 1);
	                            //form.itemOption("phones-container.phones", "items", getPhonesOptions(employee.Phones));
	                        }
	                    }
	                }]
	            }*/
	        }
	    }

		function generateNewLineOptionsExames(index,campo,tipo) {
			if (tipo==1){
		        return {
			        cssClass : "labelDetalhesExames1",
		            dataField: campo+"^"+index+"^1",
		            colSpan: 3,
		            label:{
			            text: "Exame "+(index+1),
			          	alignment: "right"  
		            },
		            editorType: "dxSelectBox",
		            editorOptions: {
			            dataSource : dataSourceExames,
	    		        valueExpr: "CodExame", 
						displayExpr: "DescExame",
						searchEnabled: true,
		            }
		        }
			}else{
		        return {
			        cssClass : "labelDetalhesExames2",
		            dataField: campo+"^"+index+"^2",
		            colSpan: 3,
		            label:{
			            text: "Resultado",
			          	alignment: "right"  
		            },
		            editorType: "dxTextBox"
		        }
		   }
	    }

        function recuperaEstadiamento(codPaciente){
	        if (codPaciente==""||codPaciente==null){
		        return
	        }
	        $.ajaxSetup({async: false});
			$.getJSON(urlPreparacao,{
		        method		: "recEstadiamento",
		        paciente	: codPaciente,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP,
		        layout		: layout
		    },function(retorno){
			    if (retorno.form==""){
				    retorno.form = [{colSpan:10,template:"Sem Estadiamento Cadastrados"}]
			    }
			    descBT = "Estadiar"
			    if (retorno.horaEst!="Estadiamento"){
				    descBT = "Reestadiar"
			    }
			    $("#lbEstadiamento").html(retorno.horaEst)
			    if (retorno.form.length>0){
				    	item = {}
				    	item.colSpan= 10
				    	item.itemType= "button"
				    	item.dataField = "btReestadiamento"
           				item.horizontalAlignment= "center"
           				if (estadiamentoPossivel==1){
           					item.cssClass= "btnDestaque"
           				}else{
	           				item.cssClass= "btnDestaque corAlerta"
           				}
						buttonOptions = {}
           				buttonOptions.elementAttr = {
	           				id : "btReestadiamento"
           				}
           				if (estadiamentoPossivel==1){
			            	buttonOptions.icon	= "fas fas fa-check"
           				}else{
           					buttonOptions.icon	= "fas fa-exclamation-triangle"
           				}
			            buttonOptions.text	= descBT
			            buttonOptions.onClick = function() {
				            if ($("#tooltipEstadionamentoBT").attr("estPoss")!=1){
					            DevExpress.ui.notify("Há campos pendentes de preenchimento para poder realizar o estadiamento", "warning", 4000);
					            return
				            }
				        	loadPanel.show();
					        $.getJSON(urlPreparacao,{
					            method		: "estadiarPaciente",
					            paciente	: codPacienteValor,
				                dataPEP		: dataPEP,
				                codCID		: codCID,
				                ficha		: ficha
					        },function(retorno){
						        mensagem = retorno.mensagem
						        tipo = retorno.tipo
					        	DevExpress.ui.notify(mensagem, tipo, 4000);
					        	recuperaEstadiamento(codPacienteValor)
					        	loadPanel.hide();
						    });
			            }
						item.buttonOptions = buttonOptions
						retorno.form.push(item)
			    }
				$("#divEstadiamento").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			        onContentReady: function(){
					    $(".estadiamentoInfoI").each(function(){
						    meuId = $(this).attr("meuId")
						    texto = $(this).attr("texto")
						    nomeEst = $(this).attr("nomeEst")
							$(this).append("<div id='tooltipEstadionamento_"+meuId+"' class='tooltips'></div>")
						 	$("#tooltipEstadionamento_"+meuId).dxTooltip({
						        target: "#esta_"+meuId,
						        elementAttr : {
							        texto	: texto,
							        nomeEst	: nomeEst
						        },
						        cornerRadius: 15,
						        position :"right",
						        showEvent: "mouseenter",
						        hideEvent: "mouseleave",
						        closeOnOutsideClick: true,
								contentTemplate: function(data) {
						            texto	= $(this)[0]._options.elementAttr.texto
						            desc	= $(this)[0]._options.elementAttr.nomeEst
						            var pendentes = ""
									pendentes = "<table class='tbToolTipEsta'><tr><th colspan=3>"+desc+"</th></tr><tr><td>"+
                                    	texto+"</td></tr>"
                                    	"</table>"
						            data.html(
						            	pendentes
						            );
						        }		
						    });
						})
       	        	},
					colCount	: 10,
					formData	: retorno.dados,
					items		: retorno.form
				})
				recuperaEstadiamentoBotao(codPacienteValor)
				$.ajaxSetup({async: true});
		    })

	    }

        function recuperaEstadiamentoBotao(codPaciente){
			$.getJSON(urlPreparacao,{
		        method		: "recEstadiamento",
		        paciente	: codPaciente,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP,
		        layout		: layout,
		        opcao		: 2
		    },function(retorno){
			    if (retorno.toolEstagio==""){
				    $("#tooltipEstadionamentoBT").remove()
			    }
			    if (retorno.estadiamentoPossivel==1){
				    estadiamentoPossivel = 1
				    var formularioEsta = $("#divEstadiamento").dxForm("instance") //.getEditor("btReestadiamento");
				    formularioEsta.itemOption("btReestadiamento","cssClass","btnDestaque")
				    formularioEsta.getEditor("btReestadiamento").option("icon","fas fa-check")
			    }else{
				    estadiamentoPossivel = 0
				    var formularioEsta = $("#divEstadiamento").dxForm("instance") //.getEditor("btReestadiamento");
				    formularioEsta.itemOption("btReestadiamento","cssClass","btnDestaque corAlerta")
				    formularioEsta.getEditor("btReestadiamento").option("icon","fas fa-exclamation-triangle")
			    }
				if ($("#tooltipEstadionamentoBT").html()==undefined){
					$("body").append("<div id='tooltipEstadionamentoBT' class='tooltips'></div>")
				}
				if (retorno.toolEstagio==""||retorno.toolEstagio==null) {
					retorno.toolEstagio="Estadiamento Possivel"
				}
			 	$("#tooltipEstadionamentoBT").dxTooltip({
			        target: "#btReestadiamento",
			        elementAttr : {
				        texto	: retorno.toolEstagio,
				        estPoss	: retorno.estadiamentoPossivel

			        },
			        cornerRadius: 15,
			        position :"right",
			        showEvent: "mouseenter",
			        hideEvent: "mouseleave",
			        closeOnOutsideClick: true,
					contentTemplate: function(data) {
			            texto	= $(this)[0]._options.elementAttr.texto
			            var pendentes = ""
			            if (texto!=""){
			            	pendentes = "<table class='tbToolTipEsta'><tr><td>"+
			            	texto+"</td></tr>"
			            	"</table>"
			            }
			            data.html(
			            	pendentes
			            );
			        }		
			    });
			    //editor.option("disabled",true)
		    })
	    }
	    
		function preparaLinhaTempo(){
			formularioLinhaTempoPai = $("#divFormLinhaTempo").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
			    width: function(){
					return window.innerWidth - dadosGerais.option("width")+8;
				},
                items: [{
		            cssClass: "linhaTempoBG",
	            	template: "<div id='linhaTempoForm'></div>"
	            }]
	        }).dxForm("instance")
			//
			formularioLinhaTempo = $("#linhaTempoForm").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				//activeStateEnabled:true,
				height: 115,
			    width: "100%",
	            items: [{
	                itemType: "group",
	                items: [{
						cssClass: "headerLT"+layout,
						itemType: "group",
						colCount: 100,
						items : [{
							colSpan: 99,
							cssClass: "header1",
							//template: "<div onclick='toggleLinhaTempo()' style='cursor:pointer;'>Linha do Tempo<font id='dvLinhaTempoDesc'></font>&nbsp;<i onclick='abreLinhasTempo()' style='font-size:16px;top:0px;left:10px;position:relative;cursor:pointer;' class='fa fa-search' title='Visualizar Linhas do Tempo'></div>"
							template: "<div onclick='toggleLinhaTempo()' style='cursor:pointer;'>Linha do Tempo<font id='dvLinhaTempoDesc'></font></div>"
						},{
							cssClass: "header1",
							template: "<i id='buttonHideLT' onclick='toggleLinhaTempo()' style='font-size:"+(layout==1?16:20)+"px;top:2px;left:4px;position:relative;cursor:pointer;' class='fa "+(layout==1?'fa-chevron-up':'fa-chevron-down')+" title='Exibir Linha do Tempo'>"
						}]
					},{
						cssClass: "linhaTempoForm"+layout,
		            	template: "<div id='linhaTempoChart'></div>"
	                }]
	            }]
	        }).dxForm("instance")
	        //
	        linhaChart = $("#linhaTempoChart").dxSlider({
		        min:0,
		        max:0,
				label: {
		            visible: true,
		 			format: function(value) {
		                return "Carregando";
		            },			            
   		            position: "top"
		        },
		    }).dxSlider("instance");
            if (linhaTempo==0){
            	$("#linhaTempoChart").hide()
            	$(".linhaTempoForm"+layout).css({padding:'0px'})
            	$("#buttonHideLT").css("transform","rotate(180deg)")
            }
		}
		function preparaPainelAcc(){
			if (typeof formAtendimentoClinicoAcc!="undefined"){
				formAtendimentoClinicoAcc.expandItem(0)
			}
			var itensAcc = [{
		        	title:"Ficha Diagnóstico",
		        	id:"divFormAtendimentoClinico"
		        },{
			        visible : true,
			        title:"Tratamento / Resposta / Toxicidade",
			        id:"divFormAtendimentoClinicoSugestao",
			    },{
			        title:"Relatórios",
			        id:"divFormAtendimentoClinicoRelatorios"
			    }]
		     formAtendimentoClinicoAcc = $("#divFormAtendimentoClinicoAcc").dxAccordion({
			    repaintChangesOnly	: true,
			    deferRendering		: false,
			    activeStateEnabled	: false,
		        items: itensAcc,
		        itemTitleTemplate: function(itemData, itemIndex, itemElement){
			        itemElement.append("<div id='Title"+itemData.id+"'>"+itemData.title+"</div>");
			    },
		        itemTemplate: function (itemData, itemIndex, itemElement) {
					itemElement.append("<div id='"+itemData.id+"'>"+itemData.id+"</div>");
					if (itemData.id=="divFormAtendimentoClinico"){
						preparaAtendimentoClinico()
					}
					if (itemData.id=="divFormAtendimentoClinicoRelatorios"){
						preparaRelatorios()
						carregaAtendimentoClinico(codPacienteValor,2)
					}
					if (itemData.id=="divFormAtendimentoClinicoSugestao"){
						preparaSugestaoTerapeutica()
						carregaAtendimentoClinico(codPacienteValor,1)
					}
		        }
		    }).dxAccordion("instance");
		    
		}
	    
	    function preparaAtendimentoClinico(){
		    
			formularioAtendimentoClinico = $("#divFormAtendimentoClinico").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
				    width: function(){
						return window.innerWidth - dadosGerais.option("width")+8;
					},
		            items: [{
			            cssClass: "atendimentoBG"+layout,
		                itemType: "group",
		                items: [{
			            	template: "<div id='atendimentoClinico'></div>"
		                }]
		            }]
	        }).dxForm("instance")
				
			if (layout==1){
				atendimentoClinico = $("#atendimentoClinico").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					items: [{
						visible: layout==1?false:true,
						cssClass: "headerL"+layout,
						colCount: 1,
						itemType	: "group",
						items:[{
							cssClass: "headerSub",
							template: "<div id='boxAtendimentoTitle'>Ficha Diagnóstico</div>"
						},{
							visible:false,
							itemType: "button",
							buttonOptions : {
					            icon: "print",
					            text: "Rel. Diagnóstico",
					            height:27,
					            onClick: function() {
					                imprimir(0,"Relatório Diagnóstico")
					            }
							}
						}]
					},{
						cssClass: "atendimentoClinico",
						itemType: "group",
						items:[{
							template: "<div id='formBox'></div>"
						}]
					}]
				}).dxForm("instance")

				formBox = $("#formBox").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					scrollingEnabled	: true,
					items: [{
						itemType: "group",
						items:[{
							template: "<div id='boxAtendimento'></div>"
						}]
					}]
				}).dxForm("instance")

				
				boxAtendimento = $("#boxAtendimento").dxTileView({
					items: arrayAtendimentoClinico,
					height: "100%",
					itemMargin: 16,
					baseItemHeight:137,
					baseItemWidth:137,
				    width: "100%",
				    showScrollbar:true,
					direction: "vertical",
					noDataText: codPacienteValor==""?"":"Diagnóstico do paciente sem workflow de atendimento clínico cadastrado",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            botao="<i class='fa fa-arrow-right' style='color:#ffffff;'>"
			            trash="<i class='fas fa-trash-alt' style='color:#ffffff;' title='Excluir os dados preenchidos' onclick=limparfl=1;limparCampos('"+itemData.ID+"')>"
			            return "<div class='boxTile' id='idBoxTile"+itemData.ID+"' onclick=(limparfl==1?limparfl=0:abrePainel('"+itemData.ID+"','',0))><p>"+itemData.Caption+"</p>"+
			            	   "<div class='rodapeGauge' id='gauge_"+itemData.ID+"'></div>"+
			            	   //"<div class='rodape' style='width:100%;text-align:"+align+";padding:5px'>"+trash+"&nbsp;&nbsp;"+botao+"</div>"+
			            	   "<div class='rodape' style='width:100%;text-align:"+align+";padding:5px'>"+botao+"</div>"+
			            	   "</div>"
			        },
			    }).dxTileView("instance");
			    
			}else{
				formularioAtendimentoClinicoDetalhes = $("#divFormAtendimentoClinicoSugestao").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
		            items: [{
			            cssClass: "atendimentoBG",
		                itemType: "group",
		                items: [{
			            	template: "<div id='pesquisaExamesPre'></div>"
		                }]
		            }]
		        }).dxForm("instance")

				pesquisaExamesPre = $("#pesquisaExamesPre").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					items: [{
						cssClass: "atendimentoClinicoDeta",
						template: function(){
							return "<div id='atendimentoClinicoDeta'></div>"
						}
					}]
				}).dxForm("instance")
				
				atendimentoClinicoDeta = $("#atendimentoClinicoDeta").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
				    scrollingEnabled	: true,
				}).dxForm("instance")
				
				atendimentoClinico = $("#atendimentoClinico").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					items: [{
						cssClass: "headerL"+layout,
						colCount: 1,
						itemType	: "group",
						items:[{
							cssClass: "headerSub",
							template: "<div id='boxAtendimentoTitle'>Ficha Diagnóstico</div>"
						}]
					},{
						cssClass: "menuClinico",
						template: function(){
							return "<div id='boxAtendimentoMenu' style='z-index:10000000'></div>"
						}
					}]
				})
				
				
				boxAtendimentoMenu = $("#boxAtendimentoMenu").dxMenu({
					activeStateEnabled: true,
					showFirstSubmenuMode: {
						name: "onHover",
        				delay: { show: 0, hide: 500 }
        			},
					showSubmenuMode: {
						name: "onHover",
        				delay: { show: 0, hide: 500 }
        			},
        			onContentReady: function(e){
	        			carregaGauges()	
	        			$(".btMenu").each(function(){
		        			var type = formTema.tema.checked==true?"default":""
		        			classe="btnDestaqueMenu"
		        			if ($(this).hasClass("btFlat")){
			        			type=""
			        			classe=""
		        			}
		        			$(this).dxButton({
			        			elementAttr:{
				        			class: classe,
				        			id	 : $(this).attr("id")
			        			},
			        			type : type,
			        			width:"100%",
			        			height:"30px",
			        			icon: $(this).attr("Icon"),
			        			text: $(this).attr("Caption")
			        		})	

		        		})
	        		},
					hideSubmenuOnMouseLeave	: false,
					displayExpr				: "Caption",	
					orientation				: "vertical",
					selectByClick			: true,
					onItemClick: function(e){
        				resposta = -1
        				if (e.itemData.Edita){
	        				if ($("#"+e.itemData.ID).html()!=undefined){
		        				if ($("#"+e.itemData.ID).attr("type")=="checkbox"){
			        				if (alteraCheck){
				        				if ($("#"+e.itemData.ID).hasClass("far fa-times-circle")){
					        				resposta = 1
					        				$("#"+e.itemData.ID).css("color",caixaMarcada)
					        				$("#"+e.itemData.ID).removeClass("far fa-times-circle")
					        				$("#"+e.itemData.ID).addClass("far fa-check-circle")
				        				}else if ($("#"+e.itemData.ID).hasClass("far fa-circle")){
					        				resposta = 0
					        				$("#"+e.itemData.ID).css("color",caixaDesmarcada)
					        				$("#"+e.itemData.ID).removeClass("far fa-circle")
					        				$("#"+e.itemData.ID).addClass("far fa-times-circle")
				        				}else{
					        				resposta = 0
					        				$("#"+e.itemData.ID).css("color",caixaDesmarcada)
					        				$("#"+e.itemData.ID).removeClass("far fa-check-circle")
					        				$("#"+e.itemData.ID).addClass("far fa-times-circle")
				        				}
			        				}else{
				        				if ($("#"+e.itemData.ID).hasClass("far fa-circle")){
					        				resposta = -2
				        				}else if ($("#"+e.itemData.ID).hasClass("far fa-times-circle")){
					        				resposta = 0
				        				}else{
					        				resposta = 1
				        				}
			        				}
		        				}
	        				}
        				}
						alteraCheck = 0
        				if (e.itemData.disabled==true||resposta==-2){
	        				return
        				}
        				if (e.itemData.Tipo==4){
	        				abreTexto(e.itemData)
	        				return
        				}
        				if (e.itemData.Tipo==17){
	        				imprimir(e.itemData.opcao,"Relatório Diagnóstico")
	        				return
        				}
        				meuID = e.itemData.ID
	        			totalItems = e.itemData.items
	        			temFilhos = e.itemData.temFilhos
	        			meuIDMenu = meuID
        				abrirMenu = ""
        				abreMenuResposta = ""
	        			if (resposta==-1){
	        				if (!totalItems){
		        				if ($("#openPesquisa").html()!=""&&painelAtual!=""){
			        				abrirMenu = meuID
		        					verificaRegrasPainel(painelAtual)
		        				}else{
									abrePainel(meuID,'')
		        				}
							}else{
								boxAtendimentoMenu.repaint()
								abrePainel(meuID,'')
							}
        				}else{
	        				e.itemData.valor1 = resposta
							if (e.itemData.items) {
								boxAtendimentoMenu.beginUpdate()
								for (i=0;i<=e.itemData.items.length-1;i++){
								   idFilho = e.itemData.items[i].ID
    					   		    filho = ""
    					   		    vetor = []
								   caminho = recuperaArvore(e.component._options.items,idFilho)
								   string=""
								   for (var j =vetor.length-1;j>=0;j--){
									   if (string!=""){
										   string = string+"."
									   }
									   string = string+"items["+vetor[j]+"]"
								   }
								   string = string+".items["+filho+"].disabled"
							       boxAtendimentoMenu.option(string,!resposta);
								}
								if (!resposta){
									$("i[id='"+e.itemData.ID+"']").parent().parent().siblings().find('.dx-item.dx-menu-item').addClass("dx-state-disabled")
								}else{
									$("i[id='"+e.itemData.ID+"']").parent().parent().siblings().find('.dx-item.dx-menu-item').removeClass("dx-state-disabled")
								}
								boxAtendimentoMenu.endUpdate()
							}
							$.getJSON(urlPreparacao,{
						        method		: "salvaPainel",
						        codPaciente	: codPacienteValor,
						        dataField	: meuID,
						        valor		: resposta,
						        codCID		: codCID,
						        ficha 		: ficha,
						        fichaSeq	: fichaSeq,
						        dataPEP		: dataPEP
						    },function(){
							    carregaGauges()	
							    recuperaEstadiamento(codPacienteValor)
							    //recuperaEstadiamentoBotao(codPacienteValor)
							    //if (totalItems) {
									//boxAtendimentoMenu.repaint()
									//$("#boxAtendimentoMenu").find(".dx-menu-item").eq(vetor[vetor.length-1]).trigger("dxclick")  
							    //}
							    
		        				if (!totalItems&&temFilhos){
			        				if ($("#openPesquisa").html()!=""&&painelAtual!=""){
				        				abrirMenu = meuID
				        				abreMenuResposta = resposta
			        					verificaRegrasPainel(painelAtual)
			        				}else{
				        				abrePainel(meuID,resposta)
			        				}
								}
							})
	        				
        				}
					}
		        }).dxMenu("instance")
			}
		}

	    function preparaSugestaoTerapeutica(){
			formularioAtendimentoClinicoDestaque = $("#divFormAtendimentoClinicoSugestao").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					//activeStateEnabled:true,
				    width: function(){
						return window.innerWidth - dadosGerais.option("width")+8;
					},
		            items: [{
			            cssClass: "atendimentoClinicoTratamento",
		                itemType: "group",
		                items: [{
			            	template: "<div id='atendimentoClinicoDestaque'></div>"
		                }]
		            }]
	        }).dxForm("instance")

			atendimentoClinicoDestaque = $("#atendimentoClinicoDestaque").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				items: [{
					itemType: "group",
					items:[{
						template: "<div id='boxAtendimentoDestaque'></div>"
					}]
				}]
			}).dxForm("instance")
			
			boxAtendimentoDestaque = $("#boxAtendimentoDestaque").dxTileView({
				items: arrayAtendimentoClinicoDestaque,
				height:"1000px",
				itemMargin: 16,
				baseItemHeight:137,
				baseItemWidth:137,
			    width: "100%",
			    showScrollbar:true,
				direction: "vertical",
				noDataText: codPacienteValor==""?"":"Diagnóstico do paciente sem workflow de atendimento clínico cadastrado",
				itemTemplate: function (itemData, itemIndex, itemElement) {
		            align = "center"
		            botao="<i class='fa fa-arrow-right' style='color:#ffffff;'>"
		            return "<div class='boxTile' id='idBoxTile"+itemData.ID+"' onclick=abrePainel('"+itemData.ID+"','',0)><p>"+itemData.Caption+"</p>"+
		            	   "<div class='rodapeGauge' id='gauge_"+itemData.ID+"'></div>"+
		            	   "<div class='rodape' style='width:100%;text-align:"+align+";padding:5px'>"+botao+"</div></div>"
		        },
		    }).dxTileView("instance");	
			
		}

	    function preparaRelatorios(){
			formularioAtendimentoClinicoDestaque = $("#divFormAtendimentoClinicoRelatorios").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					//activeStateEnabled:true,
				    width: function(){
						return window.innerWidth - dadosGerais.option("width")+8;
					},
		            items: [{
			            cssClass: "atendimentoClinico",
		                itemType: "group",
		                items: [{
			            	template: "<div id='atendimentoClinicoRelatorios'></div>"
		                }]
		            }]
	        }).dxForm("instance")

			atendimentoClinicoDestaque = $("#atendimentoClinicoRelatorios").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				items: [{
					itemType: "group",
					items:[{
						template: "<div id='formBoxDestaqueRelatorios'></div>"
					}]
				}]
			}).dxForm("instance")

			formBoxDestaqueRelatorios = $("#formBoxDestaqueRelatorios").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
				scrollingEnabled	: true,
				height:"1000px",
				items: [{
					itemType: "group",
					items:[{
						template: "<div id='boxAtendimentoDestaqueRelatorios'></div>"
					}]
				}]
			}).dxForm("instance")
			
		}
	    
    
	    function recuperaArvore(arvore,id){
		    var achou = ""
		    for (var i=0;i<=arvore.length-1;i++){
			    if (arvore[i].ID==id){
				    filho = i
				    achou = 1
			    }
			    if (!achou&&arvore[i].items){
				    achou = recuperaArvore(arvore[i].items,id)
				    if (achou){
					    vetor.push(i)
				    }
			    }
		    }
			return achou
	    }

	    function recuperaArvore2(arvore,id){
		    var achou = ""
		    for (var i=0;i<=arvore.length-1;i++){
			    if (arvore[i].ID==id){
				    filho = i
				    achou = 1
				    if (arvore[i].items){
					    for (var j=0;j<arvore[i].items.length;j++){
						    vetorFilhos.push(j)
					    }
				    }
			    }
			    if (!achou&&arvore[i].items){
				    achou = recuperaArvore2(arvore[i].items,id)
				    if (achou){
					    vetor.push(i)
				    }
			    }
		    }
			return achou
	    }
	    
		function menusTemplate(a){
			if (a.Tipo==15||a.Tipo==19){
				retorno = "<div class='btMenu' id='"+a.ID+"' caption='"+a.Caption+"' icon='"+a.icon+"'></div>"
			}else if (a.Tipo==18){
				retorno = "<div class='btMenu btFlat' id='bt"+a.ID+"' caption='"+a.Caption+"' icon='"+a.icon+"'></div>"
			}else if (a.Predecessor==""){
				retorno = "<div id='gauge_"+a.ID+"' style='position:absolute;'></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.Caption+"&nbsp;&nbsp;&nbsp;&nbsp;"
			}else if (a.Tipo==4){
				if ($("#icone"+a.ID).length>0){
					return
				}
				cor = caixaDefault
				if (a.valor1!="") cor = caixaMarcada
				retorno = "<span class='dx-menu-item-text'><i id='icone"+a.ID+"' style='color:"+cor+"' class='far fa-clipboard' id='"+a.ID+"' edita='"+a.Edita+"' type=textbox></i>&nbsp;"+a.Caption+"</span>"
			}else{
				cor = caixaDesabilitada
				icone = "far fa-circle"
				if (a.valor1=="0"){
					cor = caixaDesmarcada
					icone = "far fa-times-circle"
				}
				if (a.valor1=="1"){
					cor = caixaMarcada
					icone = "far fa-check-circle"
				}
				if (!a.Edita){
					cor = caixaDesabilitada
				}
				retorno = "<span class='dx-menu-item-text'><i style='color:"+cor+"' class='"+icone+"' id='"+a.ID+"' edita='"+a.Edita+"' type=checkbox onclick='seleciona(this)'></i>&nbsp;"+a.Caption+"</span>"
			}
			if (a.items) retorno += "<span class='dx-menu-item-popout-container'><div class='dx-menu-item-popout'></div></span>"
			if (a.Predecessor==""){
				//retorno += "<span class='dx-menu-item-popout-container'><i class='fas fa-trash-alt' style='color:#ffffff;position:relative;left:25px;' title='Excluir os dados preenchidos' onclick=limparfl=1;limparCampos('"+a.ID+"')></span>"
			}
			return retorno
		}
		
		function abreTexto(obj){
			if ($("#dvTexto").html()!=undefined){
				$("#dvTexto").remove()
			}
			var myDialog = DevExpress.ui.dialog.custom({
		        width: "450",
		        title: obj.Caption,
		        messageHtml: "<div id='dvTexto'></div>",
		        buttons: [{
		            text: "Confirmar",
		            onClick: function(e) {
		                return { buttonText: e.component.option("text") }
		            }
		        },{
		            text: "Fechar",
		            onClick: function(e) {
		                return { buttonText: "" }
		            }
		        }, 
		        // ...
		        ]
		    });
		    myDialog.show().done(function(dialogResult) {
		        if (dialogResult.buttonText){
					$.getJSON(urlPreparacao,{
				        method		: "salvaPainel",
				        codPaciente	: codPacienteValor,
				        dataField	: obj.ID,
				        valor		: $("#dvTexto").dxTextArea("instance").option("value"),
				        codCID		: codCID,
				        ficha 		: ficha,
				        fichaSeq	: fichaSeq,
				        dataPEP		: dataPEP
				    },function(){
					    $("#icone"+obj.ID).css("color",caixaMarcada)
						vetor = []
						vetorFilhos = []
						filho = ""
						arvore = boxAtendimentoMenu.option("items")
						caminho = recuperaArvore2(arvore,obj.ID)
						string=""
						for (var j =vetor.length-1;j>=0;j--){
						   if (string!=""){
							   string = string+"."
						   }
						   string = string+"items["+vetor[j]+"]"
						}
						stringF = string+".items["+filho+"].valor1"
						boxAtendimentoMenu.option(stringF,$("#dvTexto").dxTextArea("instance").option("value"));
						carregaGauges()		
					    
					})
		        }
		    });
		    $("#dvTexto").dxTextArea({
				height:100,
				width:400,
				value: obj.valor1
			})
		}
		
	    function seleciona(obj){
		    alteraCheck = 1
	    }
		function abrePainel(id,subId){
	        if (codPacienteValor==""){
		        DevExpress.ui.notify("Informe o paciente", "warning", 4000);
		        return
	        }
			opcoesSimNao = 0
			loadPanel.show();
			setTimeout(function(){ 
				$.ajaxSetup({async: false});
				$.get(urlPreparacao,{
			        method		: "recPainel",
			        codPaciente	: codPacienteValor,
			        codPainel	: id,
			        codOpcaoPainel	: subId,
			        dataPEP		: dataPEP,
			        codCID		: codCID,
			        ficha 		: ficha,
			        fichaSeq	: fichaSeq,
			        layout		: layout,
			        codIDMenu	: meuIDMenu
			    },function(retorno){
				    painelIndexAtual = -1
				    if ($("#detalhesTabs").html()!=undefined){
				    	painelIndexAtual = $("#detalhesTabs").dxTabs("instance").option("selectedIndex")
				    }
				    if (retorno.indexOf("~")>-1){
					    eval(retorno.split("~")[1])
					    retorno = retorno.split("~")[0]
				    }
				    eval("retornoPainel = "+retorno);
				    if (retornoPainel.achou==0){
					    if (painelAtual==id){
						    openPesquisa.hide()
					    }
					    $.ajaxSetup({async: true});
					    loadPanel.hide();
					    return
				    }
					if (layout==2){
						boxAtendimentoMenu.repaint()
					}			    
				    painelAtual = id
				     idRetorno = retornoPainel.pai
				     if (layout==1){
						 popupOptions = {
							shading:true,
							maxHeight:"600px",
							maxWidth:"1000px",
					        width: "90%",
					        height: "90%",
					        showTitle: true,
					        visible: true,
					        onShown: function(a){
								titulo = openPesquisa.option("toolbarItems[0].html")
								openPesquisa.option("toolbarItems[0].html"," ")
								openPesquisa.option("toolbarItems[0].html",titulo)
						    },
					        onHiding: function(a){
		   				        var meuId = id
						        atualizaGauge(codPacienteValor,meuId)
						        recuperaEstadiamento(codPacienteValor)	
						        //recuperaEstadiamentoBotao(codPacienteValor)	
						        return
									        
						        if (fechaPanel){
			   				        var meuId = id
							        atualizaGauge(codPacienteValor,meuId)
							        recuperaEstadiamento(codPacienteValor)	
							        //recuperaEstadiamentoBotao(codPacienteValor)	
							        fechaPanel = false		        
							        return
						        }
						        a.cancel = true
								$.getJSON(urlPreparacao,{
							        method		: "verificaRegrasPainel",
							        codPaciente	: codPacienteValor,
							        codPainel	: painelAtual,
							        codCID		: codCID,
							        ficha 		: ficha,
							        fichaSeq	: fichaSeq,
							        dataPEP		: dataPEP
							    },function(retorno){
								    if (retorno.status!=1){
										var result = DevExpress.ui.dialog.confirm(retorno.mensagem, "Prosseguir?");
									    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
									    result.done(function(dialogResult) {
									        if (!dialogResult){
										        return
											}
											fechaPanel = true
											openPesquisa.hide()
									    });					    
								    }else{
										fechaPanel = true
										openPesquisa.hide()
								    }
							    })
						    },
					        dragEnabled: true,
					        closeOnOutsideClick: false,
							toolbarItems: [{
								location:"before",
								toolbar :"top",
							},{
								widget: "dxButtonGroup",
								location:"after",
								toolbar :"top",
								options: { 
									items:[{
										icon: "undo",
										text: "Passagens Anteriores",
										hint: "Exibir passagens anteriores do paciente"
									},{
										icon: "clear",
										text: "Limpar",
										hint: "Excluir dados preenchidos"
									}],
		                			onItemClick : function(obj){
			                			if (obj.itemIndex==0){
			                				abreHistorico()
			                			}
			                			if (obj.itemIndex==1){
			                				limparCampos("")
			                			}
			                		}
								}
							},{
								widget: "dxButton",
								location:"before",
								toolbar:"bottom",
								options: { 
									width	: "130px",
									type	: "default",
									icon	: "close",
		                			text	: "Sair", 
		                			onClick : function(){
			                			verificaRegrasPainel(idRetorno)
			                		}
								}
							},{
								widget: "dxButton",
								location:"after",
								toolbar:"bottom",
								options: { 
									visible	: false,
									width	: "130px",
									type	: "default",
									icon	: "check",
		                			text	: "Ok", 
		                			onClick : function(){
										if (painelAtual==1290){
											sairMenu = 1
				                			verificaRegrasPainel("")
				                			return
			                			}
	   								    if (opcoesSimNao<2){
										    openPesquisa.hide()
										    return
									    }

			                			verificaRegrasPainel(idRetorno)
			                		}
								}
							}],			        
					    }		
				     }else{
						 popupOptions = {
							shading:false,
					        width: "100%",
					        height: "100%",
					        position: {
						        of:$("#pesquisaExamesPre")
					        },
					        animation: {
						        hide: { type: 'slide', duration: 0, from: { position: { my: 'top', at: 'bottom', of: window } }, to: { position: { my: 'center', at: 'center', of: window } }},
						        show: { type: 'slide', duration: 0, from: { position: { my: 'top', at: 'bottom', of: window } }, to: { position: { my: 'center', at: 'center', of: window } }}
					        },
					        showTitle: true,
					        visible: true,
					        onShown: function(a){
								titulo = openPesquisa.option("toolbarItems[0].html")
								openPesquisa.option("toolbarItems[0].html"," ")
								openPesquisa.option("toolbarItems[0].html",titulo)
								$(".dx-popup-wrapper > .dx-overlay-content").css({"border-radius":"0px","border-color": corBordaDeta})
						    },
					        onHiding: function(a){
						        if (fechaPanel){
			   				        var meuId = id
							        atualizaGauge(codPacienteValor,meuId)
							        recuperaEstadiamento(codPacienteValor)	
							        //recuperaEstadiamentoBotao(codPacienteValor)	
							        fechaPanel = false	
							        painelAtual = ""	        
							        return
						        }
								if (sairMenu){
							    	fechaPanel = true
							    	painelAtual = ""
									carregaGauges()		
							    	openPesquisa.hide()
							    	return
								}
								if (painelAtual==meuIDMenu){
									$.getJSON(urlPreparacao,{
								        method		: "recPainelIrmao",
								        paciente	: codPacienteValor,
								        idPainel	: painelAtual,
								        codCID		: codCID,
								        ficha 		: ficha,
								        fichaSeq	: fichaSeq,
								        dataPEP		: dataPEP
								    },function(retorno){
								    	if (retorno.sequencia){
					        				meuID = retorno.sequencia
						        			meuIDMenu = retorno.sequencia
									    	abrePainel(meuID,"")
								    	}else{
									    	fechaPanel = true
											carregaGauges()		
									    	openPesquisa.hide()
								    	}
								    })
									return
								}
						        return
						        
								$.getJSON(urlPreparacao,{
							        method		: "verificaRegrasPainel",
							        codPaciente	: codPacienteValor,
							        codPainel	: painelAtual,
							        codCID		: codCID,
							        ficha 		: ficha,
							        fichaSeq	: fichaSeq,
							        dataPEP		: dataPEP
							    },function(retorno){
								    if (retorno.status!=1){
										var result = DevExpress.ui.dialog.confirm(retorno.mensagem, "Prosseguir?");
									    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
									    result.done(function(dialogResult) {
									        if (!dialogResult){
										        return
											}
											if (sairMenu){
										    	fechaPanel = true
												carregaGauges()		
										    	openPesquisa.hide()
										    	painelAtual = ""
										    	return
											}
											if (painelAtual==meuIDMenu){
												$.getJSON(urlPreparacao,{
											        method		: "recPainelIrmao",
											        paciente	: codPacienteValor,
											        idPainel	: painelAtual,
											        codCID		: codCID,
											        ficha 		: ficha,
											        fichaSeq	: fichaSeq,
											        dataPEP		: dataPEP
											    },function(retorno){
											    	if (retorno.sequencia){
								        				meuID = retorno.sequencia
									        			meuIDMenu = retorno.sequencia
												    	abrePainel(meuID,"")
											    	}else{
												    	fechaPanel = true
												    	painelAtual = ""
														carregaGauges()		
												    	openPesquisa.hide()
											    	}
											    })
												return
											}
									    });					    
								    }else{
											if (sairMenu){
										    	fechaPanel = true
										    	painelAtual = ""
												carregaGauges()		
										    	openPesquisa.hide()
										    	return
											}
											if (painelAtual==meuIDMenu){
												$.getJSON(urlPreparacao,{
											        method		: "recPainelIrmao",
											        paciente	: codPacienteValor,
											        idPainel	: painelAtual,
											        codCID		: codCID,
											        ficha 		: ficha,
											        fichaSeq	: fichaSeq,
											        dataPEP		: dataPEP
											    },function(retorno){
											    	if (retorno.sequencia){
								        				meuID = retorno.sequencia
									        			meuIDMenu = retorno.sequencia
												    	abrePainel(meuID,"")
											    	}else{
												    	fechaPanel = true
														carregaGauges()		
												    	openPesquisa.hide()
											    	}
											    })
												return
											}
								    }
							    })
						    },
					        dragEnabled: false,
					        closeOnOutsideClick: false,
							toolbarItems: [{
								location:"before",
								toolbar :"top",
							},{
								widget: "dxButtonGroup",
								location:"after",
								toolbar :"top",
								options: { 
				        			elementAttr:{
					        			class: "btHistLimp"
				        			},						
									height	: "25px",
									items:[{
										icon: "undo",
										text: "Passagens Anteriores",
										hint: "Exibir passagens anteriores do paciente"
									},{
										icon: "clear",
										text: "Limpar",
										hint: "Excluir dados preenchidos"
									}],
		                			onItemClick : function(obj){
			                			if (obj.itemIndex==0){
			                				abreHistorico()
			                			}
			                			if (obj.itemIndex==1){
			                				limparCampos("")
			                			}
			                		}
								}
								/*widget: "dxButton",
								location:"after",
								toolbar :"top",
								options: { 
				        			elementAttr:{
					        			class: "btLimpar"
				        			},						
									height	: "25px",
									width	: "100px",
									type	: "default",
									icon	: "clear",
									hint	: "Excluir dados preenchidos",
		                			text	: "Limpar", 
		                			onClick : function(){
			                			limparCampos("")
			                		}
								}*/
							},{
								widget: "dxButton",
								location:"before",
								toolbar:"bottom",
								options: { 
									width	: "90px",
									type	: "default",
									icon	: "close",
		                			text	: "Sair", 
		                			onClick : function(){
			                			sairMenu = 1
			                			verificaRegrasPainel(idRetorno)
			                		}
								}
							},{
								widget: "dxButton",
								location:"after",
								toolbar:"bottom",
								options: { 
									visible	: false,
									width	: "90px",
									type	: "default",
									icon	: "check",
		                			text	: "Ok", 
		                			onClick : function(){
			                			if (painelAtual==1290){
				                			sairMenu = 1
				                			verificaRegrasPainel("")
				                			return
			                			}
			                			sairMenu = 0
			                			verificaRegrasPainel(idRetorno)
			                		}
								}
							}],			        
					    }		
				     }
				    if ($("#openPesquisa").html()!=""){
				    	pesquisaExames.dispose()
				    	openPesquisa.dispose()
				    }
		   			$("#openPesquisa").addClass("Layout"+layout)
	   				$("#openPesquisa").html("<div id='pesquisaExames'></div>")
	   				openPesquisa = $("#openPesquisa").dxPopup(popupOptions).dxPopup("instance")
					preparaPainel(retornoPainel)
					fechaPanel = false
			    })
			    $.ajaxSetup({async: true});
				
			}, 5);
		}		
		var templatePositivoNegativo = function(obj){
			borda = ""
			ID = obj.editorOptions.Sequencia
			valor = obj.editorOptions.Valor
            if (valor==""){
	            borderYes = ""
	            borderNo = ""
            }else if (valor==1){
	            borderYes = bordaYesNo
	            borderNo = ""
            }else {
	            borderYes = ""
	            borderNo = bordaYesNo
            }
			return "<div id='"+ID+"Yes' class='btnPositivo' style='"+borderYes+"' onclick=respostaDetalhe('"+ID+"',1,2)></div>&nbsp;&nbsp;&nbsp;<div id='"+ID+"No' class='btnNegativo' style='"+borderNo+"' onclick=respostaDetalhe('"+ID+"',0,2,1)></div>"
		}
		
		var templateAbreAbaixo = function(e) {
			dxFormulario.itemOption(e.component._options.elementAttr.caminho,"visible",Number(e.value))
		    corrigeLayout()
			return true
		}

		var templateAbreAbaixoGrupo = function(e) {
			var altera=0
			valor = e.value
			var valoresComposicao = 0
			if (e.component._options.elementAttr.composicao){
				valorForm = dxFormulario.option("formData")
				composicao = e.component._options.elementAttr.composicao
				for (i=0;i<composicao.length;i++){
					comp = composicao[i]
					valoresComposicao = valoresComposicao + Number(valorForm[comp])
				}
				valor="0"
				if (valoresComposicao) valor="1"
			}
			caminho = eval("e.component._options.elementAttr.caminho"+valor)
			for(var nome in e.component._options.elementAttr) {
				if (nome=="composicao") continue
				if ("caminho"+valor!=nome){
					caminhoOcultar = eval("e.component._options.elementAttr."+nome)
					if (dxFormulario.itemOption(caminhoOcultar).visible!=0){
						if (!altera) dxFormulario.beginUpdate()
						altera=1
						dxFormulario.itemOption(caminhoOcultar,"visible",0)
					}
				}
			}	
			if (caminho!=undefined){
				if (!altera) dxFormulario.beginUpdate()
				dxFormulario.itemOption(caminho,"visible",1)
				altera=1
			}
			if (altera){
				lista = []
				$(".buttonsDetalhes").each(function(){
					sel = 0
					for (var i=0;i<$(this)[0].classList.length;i++){
						if ($(this)[0].classList[i]=="btnSelected"){
							sel = 1
						}
					}
					if (sel){
						lista.push($(this)[0].classList[1])
					}
				})
				scrollTop = dxFormulario._scrollable.scrollTop()
    			dxFormulario.endUpdate()
				corrigeLayout()
				$(".buttonsDetalhes").removeClass("btnSelected")
				for (var i=0;i<lista.length;i++){
					id = lista[i]
					$("."+id).addClass("btnSelected")
				}
		        dxFormulario._scrollable.scrollBy(scrollTop)

			}
			return true
		}

		var templateAbreAbaixoGrupoNovo = function(e) {
			valor = e.value
			var valoresComposicao = 0
			if (e.component._options.elementAttr.composicao){
				valorForm = dxFormulario.option("formData")
				composicao = e.component._options.elementAttr.composicao
				for (i=0;i<composicao.length;i++){
					comp = composicao[i]
					valoresComposicao = valoresComposicao + Number(valorForm[comp])
				}
				valor="0"
				if (valoresComposicao) valor="1"
			}
			caminho = eval("e.component._options.elementAttr.caminho"+valor)
			for(var nome in e.component._options.elementAttr) {
				if (nome=="composicao") continue
				if ("caminho"+valor!=nome){
					caminhoOcultar = eval("e.component._options.elementAttr."+nome)
					$("."+caminhoOcultar).hide()
				}
			}	
			if (caminho!=undefined){
				$("."+caminho).show()
			}
			corrigeLayout()
			return true
		}

		var templateAbreAbaixoGrupoDesabilita = function(e) {
			scrollTop = dxFormulario._scrollable.scrollTop()
			valor = e.value
			caminho = eval("e.component._options.elementAttr.caminho"+valor)
			for(var nome in e.component._options.elementAttr) {
				if ("caminho"+valor!=nome){
					caminhoOcultar = eval("e.component._options.elementAttr."+nome)
					if (dxFormulario.itemOption(caminhoOcultar).disabled!=1){
						dxFormulario.itemOption(caminhoOcultar,"disabled",1)
					}
				}
			}	
			if (caminho!=undefined){
				dxFormulario.itemOption(caminho,"disabled",0)
			}

			

			return true
		}
		
		var templatePositivoNegativoTexto = function(obj,obj2){
			borda = ""
			ID = obj.editorOptions.Sequencia
			valor = obj.editorOptions.Valor
            if (valor==""){
	            borderYes = ""
	            borderNo = ""
            }else if (valor==1){
	            borderYes = bordaYesNo
	            borderNo = ""
            }else {
	            borderYes = ""
	            borderNo = bordaYesNo
            }
			return "<div id='"+ID+"Yes' class='btnPositivo' style='"+borderYes+"' onclick=respostaDetalhe('"+ID+"',1,2)></div>&nbsp;&nbsp;&nbsp;<div id='"+ID+"No' class='btnNegativo' style='"+borderNo+"' onclick=respostaDetalhe('"+ID+"',0,2,1)></div>"
		}
		
		function abreHistorico(){
		    if ($("#openHistorico").html()!=""){
		    	formHistorico.dispose()
		    	openHistorico.dispose()
		    }
			$("#openHistorico").html("<div id='headerHistorico' class='header1' style='height:30px'></div><div id='formHistorico'></div>")
			openHistorico = $("#openHistorico").dxPopup({
		        width: '95%',
		        height: '90%',
		        showTitle: true,
		        title: "Exibir Passagens Anteriores do Paciente",
		        visible: true,
		        dragEnabled: false,
		        closeOnOutsideClick: false,
				toolbarItems: [{
					location:"before",
					toolbar :"top",
				},{
					widget: "dxButton",
					location:"before",
					toolbar:"bottom",
					options: { 
						width	: "130px",
						type	: "default",
						icon	: "close",
            			text	: "Fechar", 
            			onClick : function(){
                			openHistorico.hide()
                		}
					}
				}],			        
			}).dxPopup("instance")			
			listaResultadosExames()
		}
		function limparCampos(painelLimp){
			if (painelLimp==""){
				var painelAberto = 1
				painelLimp = painelAtual
			}
			$.getJSON(urlPreparacao,{
		        method		: "recPainelName",
		        paciente	: codPacienteValor,
		        idPainel	: painelLimp,
		        codCID		: codCID,
		        abas		: $("#detalhesTabs").length
		    },function(retorno){
				var result = DevExpress.ui.dialog.confirm("Deseja excluir os dados referente a '"+retorno.descricao+"'?", "Confirma exclusão de dados?");
			    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
			    result.done(function(dialogResult) {
			        if (!dialogResult){
				        return
					}
					$.getJSON(urlPreparacao,{
				        method		: "limpaPainel",
				        paciente	: codPacienteValor,
				        idPainel	: painelLimp,
				        codCID		: codCID,
				        ficha 		: ficha,
				        fichaSeq	: fichaSeq,
				        dataPEP		: dataPEP,
				        abas		: $("#detalhesTabs").length
				    },function(retorno){
					    if (retorno.erro){
						    DevExpress.ui.notify(retorno.mensagem, "warning", 4000);
					    }else{
						    if (painelAberto==1){
							    tabbed = $("#detalhesTabs").length
						    	abrePainelSub(painelAtual,"",retornoPainel.formul.length,tabbed)
						    }else{
						        atualizaGauge(codPacienteValor,painelLimp)
						        recuperaEstadiamento(codPacienteValor)	
						    }
					    }
				    })
			    })
		    })
		}
		function atualizaGauge(codPacienteValor,meuId){
			$.getJSON(urlPreparacao,{
		        method		: "recPercentual",
		        paciente	: codPacienteValor,
		        idPainel	: meuId,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP
		    },function(retorno){
			    if (retorno.alerta==1){
				    montaAlerta(meuId,retorno.alertaTexto)
			    }else{
				    removeAlerta(meuId)
			    }
				//
				montaToolTipGauge(meuId,retorno.pendentes,retorno.percentual)
				//
			    var cor = calculaCor(retorno.percentual)
			    $("#gauge_"+meuId).dxCircularGauge({
				    value : retorno.percentual,
				    rangeContainer:{
					    ranges: [
				    		{ startValue: 0, endValue: retorno.percentual, color: cor },
				    		{ startValue: retorno.percentual, endValue: 100, color: "#FFf" }
				    	]
				    }
				})
				loadPanel.hide();
		    })
		}
		
		function montaToolTipGauge(meuId,pendentes,percentual){
			//
			var cor = calculaCor(percentual)
			if ($("#gaugeTxt_"+meuId).html()!=undefined){
				$("#gaugeTxt_"+meuId).html("<p>"+Number(percentual).toFixed(0)+"%</p>")
			}else{
			    $("#gauge_"+meuId).append("<div id='gaugeTxt_"+meuId+"' class='legendGauge"+layout+"'><p>"+Number(percentual).toFixed(0)+"%</p></div>")	    
			    $("#gauge_"+meuId).append("<div id='tooltipG_"+meuId+"' class='tooltips'></div>")
			}
			//
		 	$("#tooltipG_"+meuId).dxTooltip({
		        target: "#gaugeTxt_"+meuId,
		        elementAttr : {
			        id 		: "tooltipG_"+meuId,
			        texto	: pendentes,
			        perc	: percentual,
		        },
		        cornerRadius: 15,
		        position :"top",
		        showEvent: "mouseenter",
		        hideEvent: "mouseleave",
		        closeOnOutsideClick: true,
				contentTemplate: function(data) {
		            var cor = calculaCor($(this)[0]._options.elementAttr.perc)
		            var pendentes = ""
		            if ($(this)[0]._options.elementAttr.texto!=""){
		            	pendentes = "<table class='tbToolTip'><tr><th>Informações Pendentes de Preenchimento:</th></tr>"+
		            	$(this)[0]._options.elementAttr.texto+
		            	"</table>"
		            }
		            data.html(
		            	"<div class='ToolTip' style='color:"+cor+"'>Percentual Concluído (Geral): "+$(this)[0]._options.elementAttr.perc + "%</div>"+pendentes+""
		            	
		            );
		        }		
		    });
		    //			
		}

		function montaAlerta(meuId,texto){
		    if ($("#alert_"+meuId).html()==undefined){
		    	$("#idBoxTile"+meuId).css("background","linear-gradient(180deg,"+corAlerta+","+corAlerta+" 80%,"+corT1+" 51%)")
		    	$("#idBoxTile"+meuId).css("color",corAlertaFonte)
		    	$("#idBoxTile"+meuId).append("<i id='tooltipAlert_"+meuId+"' class='tooltips'></div>")
		    }
		 	$("#tooltipAlert_"+meuId).dxTooltip({
		        target: "#idBoxTile"+meuId,
		        elementAttr : {
			        id 		: "tooltipAlert_"+meuId,
			        texto	: texto
		        },
		        cornerRadius: 15,
		        position :"left",
		        showEvent: "mouseenter",
		        hideEvent: "mouseleave",
		        closeOnOutsideClick: true,
				contentTemplate: function(data) {
		            var pendentes = ""
		            if ($(this)[0]._options.elementAttr.texto!=""){
		            	pendentes = "<table class='tbToolTip'><tr><th colspan=3>Campos de Atenção:</th></tr>"+
		            	$(this)[0]._options.elementAttr.texto+
		            	"</table>"
		            }
		            data.html(
		            	pendentes
		            	
		            );
		        }		
		    });
		}
		
		function removeAlerta(meuId){
	    	$("#idBoxTile"+meuId).css("background","linear-gradient(180deg,"+corTerciaria+","+corTerciaria+" 80%,"+corT1+" 51%)")
	    	$("#idBoxTile"+meuId).css("color",corFonteCaixas)
		    if ($("#tooltipAlert_"+meuId).html()!=undefined){
		    	$("#tooltipAlert_"+meuId).remove()
		    }
		}
		
		function calculaCor(perc){
		    var cor = "#03c04a"
		    if (Number(perc)<80) {
			    cor = "rgb(215,215,0)"
		    }
		    if (Number(perc)<20) {
			    cor = "red"
		    }
		    return cor
		}
		function preparaPainel(objeto,tabbed){
			sairMenu = 1
			if (!tabbed){
		        pesquisaExames = $("#pesquisaExames").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			        width				: "100%",
			        height				: "100%",
				    scrollingEnabled	: true,
			        items: [{
				        template: "<div id='detalhes'></div>"
			        }]
		        }).dxForm("instance")
			}
			if (layout==2){
				$("#detalhes").empty()
			}
	        imagem=0
			if (objeto.formul.length>0) {
				$("#detalhes").append("<div id='detalhesFormulario' class='formularioDetalhe'>")
		        colCount = 1
   		        if (objeto.formul.dividir==1&&objeto.formul.length>10){
		        	colCount = 2
		        }
		        dxFormulario = $("#detalhesFormulario").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			        activeStateEnabled	: true,
			        formData			: objeto.formulDados,
			        width				: "100%",
				    scrollingEnabled	: true,
				    focusStateEnabled	: true,
				    onContentReady		: function(e){
			          e.element.dxScrollable("instance").option("useNative", true);  
			          e.element.dxScrollable("instance").option("showScrollbar","always");
					    /*e.element.find("input[type='text'],textarea").each(function(){
						    var objId = $(this).parent().parent().parent().find("input")[0]
						    var idobj = $(objId).attr("name")
						    var ret = eval("objeto.formulTooltip.tt"+idobj)
						    if (!ret) return
						    var string = ""
						    if (ret[0].valor==undefined){
							    string += "<tr><th colspan=3>"
							    string += ret[0]
							    string += "</th></tr>"
						    }else{
							    string += "<tr><th colspan=3>Histórico de Alterações:</th></tr><tr><td>"
								string +="<ul class='tbToolTipEsta'>"
								for (var i=0;i<ret.length;i++){
								    string +="<li>Valor: "+ret[i].valor+" (registrado em "+ret[i].data+" por "+ret[i].usuario+")</li>"
							    }
								string +="</ul>"
								string +="</tr></td>"
						    }
							$(this)[0].onmouseover = function(){
								$("#ttip").dxTooltip({
									target: $(this),
									visible:true,
							        position: "right",
									contentTemplate: function (contentElement) {
							            contentElement.append("<table class='tbToolTipEsta'>"+string+"</table>")
							        }
								})
							}
							$(this)[0].onmouseout = function(){
								$("#ttip").dxTooltip({
									visible:false
								})
							}
						 });*/
					    $(".subGrupos.invisivel").each(function(){
							$(this).hide()
						})
					    e.component._scrollable.option("showScrollbar", "always");  
					    corrigeLayout()
				    },
				    alignItemLabels	: true,
				    alignItemLabelsInAllGroups : true,
			        items				: [{
				        itemType	: "group",
				        colCount	: colCount,
				        cssClass	: "formularios"+layout,
				        items		: objeto.formul,
			        }],
   					onFieldDataChanged	: function(obj){
	   					if (alterarMult==0) {
		   					alterarMult = 1
		   					return
	   					}
	   					campo = obj.dataField
	   					if (obj.dataField.indexOf("mult_")>=0){
		   					if (obj.value==undefined){
			   					return
		   					}
	   						separado = obj.dataField.split("_")
	   						for (var i=0;i<=100;i++){
		   						if (typeof dxFormulario.getEditor("mult_"+i+"_"+separado[2])=="undefined"){
			   						break
		   						}
		   						if (i!=separado[1]) {
			   						alterarMult = 0
		   							dxFormulario.getEditor("mult_"+i+"_"+separado[2]).option("value","")
		   						}
	   						}
	   						campo = separado[2]
	   						alterarMult = 1
	   					}
	   					if (obj.value!=""){
							if (obj.value==true) obj.value=1
							if (obj.value==false) obj.value=0
	   					}
						$.getJSON(urlPreparacao,{
					        method		: "salvaPainel",
					        codPaciente	: codPacienteValor,
					        dataField	: campo,
					        valor		: JSON.stringify(obj.value),
					        codCID		: codCID,
					        ficha 		: ficha,
					        fichaSeq	: fichaSeq,
					        dataPEP		: dataPEP
					    },function(retorno){
						    /*if ($("#divResultadosExamesPEP").html()!=undefined){
							    $("#divResultadosExamesPEP").dxDataGrid("instance").getDataSource().reload()
						    }*/
						})
   					}

			    }).dxForm("instance")
			    $(".dvPosNegTexto").dxTextArea({
					width: '100%',
					height: '30px'
					
				})
				$(".btnPositivo").dxButton({
					width	: "130px",
					type	: "success",
					icon	: "check",
        			text	: "Positivo", 
				})										            
				$(".btnNegativo").dxButton({
					width	: "130px",
					type	: "danger",
					icon	: "clear",
        			text	: "Negativo", 
				})	
				$(".btnSim").dxButton({
					icon	: "check",
        			text	: "Sim", 
				})										            
				$(".btnNao").dxButton({
					icon	: "clear",
        			text	: "Não", 
				})	
				$(".helpBt").each(function(){
					var id = $(this).attr("id")
				 	$("#"+id+"Div").dxTooltip({
				        target: "#"+id,
				        cornerRadius: 15,
				        position :"right",
				        showEvent: "mouseenter",
				        hideEvent: "mouseleave",
				        closeOnOutsideClick: true,
				    });
				})
				var botoes = $(".btnSimF").length
				if (botoes>opcoesSimNao){
					opcoesSimNao = botoes
				}
				/*if (objeto.exames){
					listaResultadosExames()
				}*/
			}
	        if (objeto.imagem.length>0) {
				opcoesSimNao = 2
		        baseHeight = 40
		        itemMargin = 5,
		        tamanho=295
		        widthDeta = $("#detalhes")[0].scrollWidth
		        altImagem = $("#pesquisaExames").height()-50
		        if (widthDeta<600){
			        tamanho = 100
		        }
		        padding=0
		        tamanhoImagem = ((((widthDeta-(tamanho*2)))/2)+tamanho-90)
		        if (widthDeta<600){
			        tamanhoImagem = tamanhoImagem + 70
		        }
				$("#detalhes").append("<div id='detalhesBlocoLeft' style='padding-top:"+padding+"px;border:0px;position:absolute;top:0px;width:"+tamanho+"px'></div><div id='divMPCorpo' style='border:0px solid blue;position:absolute;top:0px;width:180px;left:"+(tamanhoImagem)+"px;z-index:-1;'><img id='imgCorpo' src='"+ygif+"PEP/premium/mapeamentos/1.png' height='"+(altImagem)+"'></div><div id='detalhesBlocoRight' style='position:absolute;top:0px;width:"+tamanho+"px;left:"+(widthDeta - tamanho-10)+"px;border:0px;padding-top:"+padding+"px;'></div>")
				var stringA = ""
				var stringB = ""
				for (var cont=0;cont<objeto.imagem.length;cont++){
		            align = "center"
		            var borda = ""
		            classeTela = "boxTileDetalheImagem"
		            if (objeto.imagem[cont].Tipo=="7"){
			            if (objeto.imagem[cont].Valor=="1"){
				            classeTela = "boxTileDetalheImagemBorda"
			            }
		            }
		            if (objeto.imagem[cont].lado==1){
			            stringA = stringA+"<div id='divMP"+objeto.imagem[cont].ID+"' class='"+classeTela+"' style='width:220px;' onclick=respostaDetalhe('"+objeto.imagem[cont].ID+"',-1,"+objeto.formul.length+")>"+objeto.imagem[cont].Caption+"</div><div style='height:12px' />"
		            }else{
						stringB = stringB+"<div id='divMP"+objeto.imagem[cont].ID+"' class='"+classeTela+"' style='width:220px;' onclick=respostaDetalhe('"+objeto.imagem[cont].ID+"',-1,"+objeto.formul.length+")>"+objeto.imagem[cont].Caption+"</div><div style='height:12px' />"
		            }
				}
				for (var cont=0;cont<objeto.blocos.length;cont++){
					stringB = stringB+"<div id='divMP"+objeto.blocos[cont].ID+"' class='"+classeTela+"' style='"+borda+";width:220px;' onclick=respostaDetalhe('"+objeto.blocos[cont].ID+"',1,"+objeto.formul.length+")>"+objeto.blocos[cont].Caption+"</div><br>"
				}
				
				$("#detalhesBlocoLeft").html(stringA)
				$("#detalhesBlocoRight").html(stringB)
				imagem = 1
	        }else{
		        baseHeight = 50
		        itemMargin = 20,
		        classeTela = "boxTileDetalheSubGrupo"
		        if (objeto.blocosL.length>0){
					$("#detalhes").append("<table width=100%><tr><td><div id='detalhesBlocoLeft'></div></td><td><div id='detalhesBlocoRight'></div></td></tr></table>")
			    }
	        }
			if (objeto.blocosL.length>0){
		        $("#detalhesBlocoLeft").dxTileView({
			        items			:	objeto.blocosL,
			        height			: 	$("#pesquisaExames").height(),
					baseItemHeight	:   baseHeight,
					itemMargin		:   itemMargin,
					baseItemWidth	: 	$("#detalhesBlocoLeft").width()-50,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            var borda = ""
			            if (itemData.Tipo=="8"){
				            if (itemData.Valor=="1"){
					            borda = "border:2px solid yellow"
				            }
			            }
		            	retorno = "<div id='divMP"+itemData.ID+"' class='"+classeTela+"' style='"+borda+"' onclick=respostaDetalhe('"+itemData.ID+"',-1,"+objeto.formul.length+")><p>"+itemData.Caption;
			            return retorno
			        },
			    }).dxTileView("instance");
			}
			if (objeto.blocosR.length>0){
		        $("#detalhesBlocoRight").dxTileView({
			        items			:	objeto.blocosR,
			        height			: 	$("#pesquisaExames").height(),
					itemMargin		:   itemMargin,
					baseItemWidth	: 	$("#detalhesBlocoRight").width()-50,
					baseItemHeight	:   baseHeight,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            var borda = ""
			            if (itemData.Tipo=="8"){
				            if (itemData.Valor=="1"){
					            borda = "border:2px solid yellow"
				            }
			            }
		            	retorno = "<div id='divMP"+itemData.ID+"' class='"+classeTela+"' style='"+borda+"' onclick=respostaDetalhe('"+itemData.ID+"',-1,"+objeto.formul.length+")><p>"+itemData.Caption;
			            return retorno
			        },
			    }).dxTileView("instance");
			}
			if (objeto.imagem.length==0&&objeto.blocos.length>0) {
				$("#detalhes").append("<div id='detalhesBloco'>")
		        $("#detalhesBloco").dxTileView({
			        items			:	objeto.blocos,
				    height			: 	"100%",
				    width			: 	"100%",
					itemMargin		: 	20,
					baseItemHeight	: 	78,
					baseItemWidth	: 	$("#pesquisaExames").width()-50,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            if (itemData.Tipo=="2"){
				            if (itemData.Valor==""){
      				            borderYes = ""
					            borderNo = ""
				            }else if (itemData.Valor==1){
					            borderYes = bordaYesNo
					            borderNo = ""
				            }else {
					            borderYes = ""
					            borderNo = bordaYesNo
				            }
				            retorno = "<div class='boxTileDetalheSN'><p>"+itemData.Caption;
				            botao="<div id='"+itemData.ID+"Yes' class='btnSim' style='"+borderYes+"' onclick=respostaDetalhe('"+itemData.ID+"',1,"+objeto.formul.length+",1)></div>&nbsp;&nbsp;&nbsp;<div id='"+itemData.ID+"No' class='btnNao' style='"+borderNo+"' onclick=respostaDetalhe('"+itemData.ID+"',0,"+objeto.formul.length+",1)></div>"
				            retorno = retorno+"<div class='rodape' style='width:100%;text-align:"+align+";padding:5px'>"+botao+"</div></p></div>"
			            }else{
			            	retorno = "<div class='boxTileDetalhe' onclick=verificaRegrasPainel('"+itemData.ID+"')><p>"+itemData.Caption;
			            }
			            
			            return retorno
			        },
			    }).dxTileView("instance");
				$(".btnSim").dxButton({
					width	: "130px",
					height	: "35px",
					type	: "success",
					icon	: "check",
        			text	: "Sim", 
				})										            
				$(".btnNao").dxButton({
					width	: "130px",
					height	: "35px",
					type	: "danger",
					icon	: "clear",
        			text	: "Não", 
				})	
			}
			if (objeto.tabs.length>0) {
				$("<div id='tabs'>").insertBefore("#detalhes")
				$("#tabs").append("<div id='detalhesTabs'>")
				$("#detalhes").css("height",$("#pesquisaExames").height()-50)
				$("#pesquisaExames").addClass("bordaFormularioPrincipal")
				cancelaSelecao=1
				$("#detalhesTabs").dxTabs({
					dataSource: objeto.tabs,
					selectedIndex: 0,
					onOptionChanged: function(e){
						if (e.name!="selectedItem"){
							return
						}
						/*if (cancelaSelecao==1) {
							return
						}*/
						verificaRegrasPainel(e.value.id,"",1,1)
					}
				})
				verificaRegrasPainel(objeto.tabs[0].id,"",1,1)

			}
			if ($("#detalhesTabs").html()==undefined){
				$("#pesquisaExames").removeClass("bordaFormularioPrincipal")
			}
		    idRetorno = objeto.pai
			if ($("#detalhesTabs").html()!=undefined){
			    idRetorno = ""
			}
			if (layout==2&&meuIDMenu==painelAtual){
				idRetorno = ""
			}
		    if (idRetorno==""){
			    openPesquisa.option("toolbarItems[2].options.icon","close")
		    	openPesquisa.option("toolbarItems[2].options.text","Sair")
		    }else{
			    openPesquisa.option("toolbarItems[2].options.icon","back")
			    openPesquisa.option("toolbarItems[2].options.text","Voltar")
		    }
		    if (objeto.formul.length>0||$(".btnSim").length>1||objeto.imagem.length>0){
			    openPesquisa.option("toolbarItems[3].options.visible",true)
		    }else{
			    openPesquisa.option("toolbarItems[3].options.visible",false)
		    }
		    openPesquisa.option("toolbarItems[0].html",objeto.titulo)
		    //
		    if (imagem==1){
				if ($("#btnRodape").html()!=undefined){
		    		$("#btnRodape").dxButton("instance").dispose()
				}
   			    $("#detalhes").after("<div id='btnRodape' style='position:absolute;left:40px;'></div>")
			    desenhar(objeto.imagem);
				$("#btnRodape").dxButton({
					icon	: "menu",
        			text	: "Resumo das Informações",
        			hint	: "Clique para exibir o resumo das informações inseridas", 
        			onClick : function(e){
	        			exibeDiagnosticoImagem()
            		}
				})   			    
		    }
		    loadPanel.hide();

		}
	    
	    function exibeDiagnosticoImagem(){
		    if ($("#openHistorico").html()!=""){
		    	formHistorico.dispose()
		    	openHistorico.dispose()
		    }
			$("#openHistorico").html("<div id='formHistorico'></div>")
			openHistorico = $("#openHistorico").dxPopup({
		        width: '750px',
		        height: '500px',
		        showTitle: true,
		        title: "Resumo das Informações Inseridas",
		        visible: true,
		        dragEnabled: false,
		        closeOnOutsideClick: false,
				toolbarItems: [{
					location:"before",
					toolbar :"top",
				},{
					widget: "dxButton",
					location:"before",
					toolbar:"bottom",
					options: { 
						width	: "130px",
						type	: "default",
						icon	: "close",
            			text	: "Fechar", 
            			onClick : function(){
                			openHistorico.hide()
                		}
					}
				}],			        
			}).dxPopup("instance")
			//
			$.getJSON(urlPreparacao,{
				method		:"listaResultadosImagem",
				paciente	: codPacienteValor,
				codCID		: codCID,
				painelAtual : painelAtual,
				ficha 		: ficha
			},function(retorno){
				formHistorico = $("#formHistorico").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			        width				: "100%",
			        height				: "100%",
				    scrollingEnabled	: true,
			        items: [{
				        template: "<div id='detalhesTratamento'>"+retorno.dados+"</div>"
			        }]

				}).dxForm("instance")
			})
		}
	    function corrigeLayout(){
		    $("#detalhesFormulario .dx-field-item-label-text").each(function(){
		    	texto = $(this)[0].innerText
		    	$(this)[0].innerHTML = texto
		    })
		    $("#detalhesFormulario .dx-field-item-help-text").each(function(){
				tamanhoCampo = $(this).prev()[0].children[0].offsetWidth
				topPai = Number($(this).prev()["0"].offsetTop)
				leftPai = Number($(this).prev()["0"].offsetLeft)
				left = Number($(this)["0"].offsetLeft)
				altura = Number($(this)["0"].offsetTop)
				$(this)[0].style.position="absolute"
				$(this)[0].style.left=leftPai+tamanhoCampo+5+"px"
				$(this)[0].style.top=topPai+3+"px"
			})
	    }
	    
	    function listaResultadosExames(){
		    selectedCampo = 0
			formHistorico = $("#formHistorico").dxDataGrid({
				dataSource: new DevExpress.data.DataSource({
					store: new DevExpress.data.CustomStore({
						load: function(args) {
				        	var d = $.Deferred();
							$.getJSON(urlPreparacao,{
								method		:"listaResultadosPEPPremium",
								paciente	: codPacienteValor,
								codCID		: codCID,
								ficha 		: ficha,
								painelAtual : painelAtual
							},function(retorno){
								d.resolve(retorno.dataGrid);
								$("#headerHistorico").html("Passagens Anteriores: "+retorno.header)
								$("#formHistorico").dxDataGrid("instance").option("columns",retorno.columns)
								$("#formHistorico").dxDataGrid("instance").repaint()
							});
							return d.promise();
						}					
					})
				}),
				onContentReady: function(){
					selectedCampo=0
					$(".selecionaResultado").each(function(){
						meuId = $(this).attr("id")
						texto = $(this).attr("texto")
						$(this).dxButton({
					        elementAttr : {
						        meuId	: meuId,
						        texto   : texto
					        },
							height	: "22px",
							width	: "40px",
							icon	: "check",
	            			hint	: "Clique para utilizar o resultado de exame mais recente do paciente no preenchimento do prontuário", 
	            			onClick : function(e){
								meuId = e.component._options.elementAttr.meuId
								texto = e.component._options.elementAttr.texto
		            			importaResultadoExame(meuId,texto)
		            		}
						})
					})
				},
    			onCellPrepared: function(e) {
		            if(e.rowType === "header") {
			            if (e.cellElement[0].innerText.indexOf("||")>-1){
				            texto = e.cellElement[0].innerText.split("||")[0]
				            valor = e.column.dataField
				            e.cellElement[0].innerHTML = texto+" <div id='"+valor+"' texto='"+texto+"' class='selecionaResultado'></div>"
			            }
		            }
					if (e.rowType=="data"&&e.column.dataType=="string"){
						e.cellElement[0].innerHTML = e.text
					}
		        },
				sorting:{mode:'none'},
        		allowColumnResizing	: true,
				cellHintEnabled		: true,
				//columnAutoWidth		: true,
				//columnMinWidth		: "200px",
				filterRow: { visible: false },
				hoverStateEnabled: true,
				headerFilter: {
					visible:false
				},		
				filterRow:{
					visible:false
				},
				groupPanel: {
					visible: false
				},
				width: "99%",
				height: "99%",
				paging: { enabled: false },
				showBorders: true,
				showRowLines: true,
				columnChooser: {
					enabled: false
				},
				scrolling:{
					showScrollbar: 'always',
					useNative : false
				},
				rowAlternationEnabled: true,
				wordWrapEnabled:true
			}).dxDataGrid("instance")
		}
	    
	    function templateSimNaoForm(campo,valor){
		    align = "center"
	        if (valor==""){
	            borderYes = ""
	            borderNo = ""
	        }else if (valor==1){
	            borderYes = bordaYesNo
	            borderNo = ""
	        }else {
	            borderYes = ""
	            borderNo = bordaYesNo
	        }
	        return "<div id='"+campo+"Yes' class='btnSim'  style='"+borderYes+"' onclick=respostaDetalhe('"+campo+"',1,'',1)></div>&nbsp;"+
	        	   "<div id='"+campo+"No' class='btnNao' style='"+borderNo+"' onclick=respostaDetalhe('"+campo+"',0,'',1)></div>"
		}
	    
	    function desenhar(objeto){
		    if ($("#imgCorpo").width()==0){
		    	setTimeout(function(){ desenhar(objeto); }, 100);
		    	return
		    }
			var myDIVs = [];
			var myLink = [];
			var item = {}
			item.name = "divMPCorpo"
			myDIVs.push(item)
			tamanhoCorpo = $("#imgCorpo").height()
			larguraCorpo = $("#imgCorpo").width()
			for (var cont=0;cont<objeto.length;cont++){
				var coorX = objeto[cont].CoordenadaX
				var coorY = objeto[cont].CoordenadaY
				ncoorY = tamanhoCorpo*coorY/1000
				//
				calcCorpo = larguraCorpo*1000/tamanhoCorpo
				//
				ncoorX = larguraCorpo*coorX/calcCorpo
				var item = {}
				item.name = "divMP"+objeto[cont].ID+":"+(ncoorX)+";"+(ncoorY)
				myDIVs.push(item)
				var link = {}
				link.source = cont+1
				link.target = 0
				myLink.push(link)
			}
		
	        if (layout==1){
		        altImagem = $("#pesquisaExames").height()-10
		        largura = $("#pesquisaExames").width()
	        }else{
		        altImagem = $("#atendimentoClinicoDeta").height()-100
		        largura = $("#atendimentoClinicoDeta").width()
	        }
		    $("#btnRodape").css("top",altImagem-40)
		     var nodes = myDIVs,
		      links = myLink;
   		    var svg = d3.select('#detalhes').append('svg')
			      .attr('width', largura)
			      .attr('height', altImagem);
				defs = svg.append('defs')
				marker = defs.append('marker')
				.attr('id','arrow')
				.attr('viewBox','0 0 10 10')
				.attr('refX','10')
				.attr('refY','5')
				.attr('markerUnits','strokeWidth')
				.attr('markerWidth','3')
				.attr('markerHeight','3')
				.attr('orient','auto');
				path = marker.append('path')
				.attr('d','M 0 0 L 10 5 L 0 10 z')
				.attr('fill',corLinha)
				
			    var force = d3.layout.force()
			      .nodes(nodes)
			      .links(links)

			    var link = svg.selectAll('.link')
			      .data(links)
			      .enter().append('line')
			      .attr('class', 'link')
			      .attr('marker-end',"url(#arrow)");

			    var node = d3.selectAll('div')
			      .data(nodes)
			    force.on('end', function() {
			      	link
			      	.attr('x1', function(d) {
				      nome = d.source.name.split(":")[0]
				      leftPai = $("#"+nome).parent()["0"].offsetLeft
				      leftFilho = $("#"+nome)["0"].offsetLeft
				      widthFilho = $("#"+nome)["0"].offsetWidth
			          left = leftPai + leftFilho
			          if (leftPai==0){
				      	left = left + widthFilho
			          }
			          return left
			        })
			        .attr('y1', function(d) {
				        nome = d.source.name.split(":")[0]
				        topFilho = $("#"+nome)["0"].offsetTop
				        heightFilho = $("#"+nome)["0"].offsetHeight
				        topCalc = topFilho + (heightFilho/2)
			          return topCalc
			        })
			        .attr('x2', function(d) {
				      	leftOrigem = Number($("#"+d.target.name)["0"].offsetLeft)+Number($("#"+d.target.name)["0"].clientLeft)
				      	mapeamento = d.source.name.split(":")[1]
				      	mapLeft = Number(mapeamento.split(";")[0])
				      	leftCalc = leftOrigem + mapLeft
			          return leftCalc
			        })
			        .attr('y2', function(d) {
				      	topOrigem = Number($("#"+d.target.name)["0"].offsetTop)+Number($("#"+d.target.name)["0"].clientTop)
				      	mapeamento = d.source.name.split(":")[1]
				      	mapTop = Number(mapeamento.split(";")[1])
				      	topCalc = topOrigem + mapTop
			          return topCalc
			        });
			    });
			    
			    force.start();
			    for (var i = 0; i < 100; ++i) force.tick();
			    force.stop();	
		   	 	svg.selectAll("line").sort(function (a, b) { // select the parent and sort the path's
      				return 10;                             // a is the hovered element, bring "a" to the front
  				});
		}

	    
	    
	    function respostaDetalhe(id,resp,formulario,duplaOpcao){
		    if (formulario==""&&retornoPainel.formul){
			    formulario = retornoPainel.formul.length
		    }
		    if (resp==-1){
			    if (duplaOpcao){
				    verificaRegrasPainel(id,1,formulario)
			    }else{
					verificaRegrasPainel(id,"",formulario)
			    }
			    return
		    }
			$.getJSON(urlPreparacao,{
		        method		: "salvaPainel",
		        codPaciente	: codPacienteValor,
		        dataField	: id,
		        valor		: resp,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP
		    })
		    if (resp==1){
		    	$("#"+id+"Yes").css("border",bordaYesNo.split(":")[1])
		    	$("#"+id+"No").css("border","")
		    }else{
			    $("#"+id+"Yes").css("border","")
				$("#"+id+"No").css("border",bordaYesNo.split(":")[1])		    
		    }
		    if (resp==1){
			    if (duplaOpcao){
				    verificaRegrasPainel(id,1,formulario)
			    }else{
					verificaRegrasPainel(id,"",formulario)
			    }
		    }else{
				if ($(".btnSim").length==1&&formulario<1){
				    if (layout==2){
						carregaAtendimentoClinico(codPacienteValor,0)
				    }
					openPesquisa.hide()
				}
		    }
	    }


	    function respostaDetalheForm(id,resp,duplaOpcao){
		    formulario = retornoPainel.formul.length
		    if (resp==-1){
			    verificaRegrasPainel(id,1,formulario)
			    return
		    }
			$.getJSON(urlPreparacao,{
		        method		: "salvaPainel",
		        codPaciente	: codPacienteValor,
		        dataField	: id,
		        valor		: resp,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP
		    })
		    if (resp==1){
		    	$(".btn"+id+"Yes").addClass("btnSelected")
		    	$(".btn"+id+"No").removeClass("btnSelected")
		    }else{
			    $(".btn"+id+"Yes").removeClass("btnSelected")
			    $(".btn"+id+"No").addClass("btnSelected")
		    }
		    verificaRegrasPainel(id,resp,formulario)
		    return
		    if (resp==1){
			    verificaRegrasPainel(id,1,formulario)
		    }else{
			    verificaRegrasPainel(id,0,formulario)
				if ($(".btnSimF").length==1&&formulario<2){
				    if (layout==2){
						carregaAtendimentoClinico(codPacienteValor,0)
				    }
					openPesquisa.hide()
				}
		    }
	    }

		function verificaRegrasPainel(id,subId,formulario,tabbed){
			// regra removida temporariamente
			//
		    if (layout==2){
			    recuperaEstadiamento(codPacienteValor)	
			    //recuperaEstadiamentoBotao(codPacienteValor)
		    }
		    if (id==""){
		    	openPesquisa.hide()
		    	return
		    }
			if (layout==2){
				if (abrirMenu!=""){
					abrePainel(abrirMenu,abreMenuResposta)
					abreMenuResposta = ""
					abrirMenu = ""
					return
				}
				abrePainelSub(id,subId,formulario,tabbed)
				return
				if (id!=meuIDMenu){
				}
				if (painelAtual==meuIDMenu){
					$.getJSON(urlPreparacao,{
				        method		: "recPainelIrmao",
				        paciente	: codPacienteValor,
				        idPainel	: painelAtual,
				        codCID		: codCID,
				        ficha 		: ficha,
				        fichaSeq	: fichaSeq,
				        dataPEP		: dataPEP
				    },function(retorno){
				    	if (retorno.sequencia){
	        				meuID = retorno.sequencia
		        			meuIDMenu = retorno.sequencia
					    	abrePainel(meuID,"")
				    	}else{
					    	openPesquisa.hide()
				    	}
				    })
					return
				}
			    if (opcoesSimNao<2){
				    openPesquisa.hide()
				    return
			    }
			    return
			}
			abrePainelSub(id,subId,formulario,tabbed)
			return
			//
		    if (layout==2){
			    recuperaEstadiamento(codPacienteValor)	
			    //recuperaEstadiamentoBotao(codPacienteValor)
		    }
		    if (id==""){
		    	openPesquisa.hide()
		    	return
		    }
			cancelaSelecao=0
			if (painelAtual!=""){
				$.getJSON(urlPreparacao,{
			        method		: "verificaRegrasPainel",
			        codPaciente	: codPacienteValor,
			        codPainel	: painelAtual,
			        subCodPainel: subId,
			        codCID		: codCID,
			        ficha 		: ficha,
			        fichaSeq	: fichaSeq,
			        dataPEP		: dataPEP
			    },function(retorno){
				    if (retorno.status!=1){
						var result = DevExpress.ui.dialog.confirm(retorno.mensagem, "Prosseguir?");
					    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
						result.fail(function(dialogResult) {
							if (painelIndexAtual>=0&&$("#detalhesTabs").dxTabs("instance").option("selectedIndex")!=painelIndexAtual){
								cancelaSelecao = 1
								$("#detalhesTabs").dxTabs("instance").option("selectedIndex",painelIndexAtual)
								cancelaSelecao=0
							}					        
						})
					    result.done(function(dialogResult) {
					        if (dialogResult){
								if (layout==2){
									if (abrirMenu!=""){
										abrePainel(abrirMenu,abreMenuResposta)
										abrirMenu = ""
										abreMenuResposta = ""
										return
									}
									if (id!=painelAtual){
										abrePainelSub(id,subId,formulario,tabbed)
										return
									}
									if (painelAtual==meuIDMenu){
										$.getJSON(urlPreparacao,{
									        method		: "recPainelIrmao",
									        paciente	: codPacienteValor,
									        idPainel	: painelAtual,
									        codCID		: codCID,
									        ficha 		: ficha,
									        fichaSeq	: fichaSeq,
									        dataPEP		: dataPEP
									    },function(retorno){
									    	if (retorno.sequencia){
						        				meuID = retorno.sequencia
							        			meuIDMenu = retorno.sequencia
										    	abrePainel(meuID,"")
									    	}else{
										    	openPesquisa.hide()
									    	}
									    })
										return
									}
								    if (opcoesSimNao<2){
									    openPesquisa.hide()
									    return
								    }
								    return
								}
						        
						        abrePainelSub(id,subId,formulario,tabbed)
					        }else{
								if (painelIndexAtual>=0&&$("#detalhesTabs").dxTabs("instance").option("selectedIndex")!=painelIndexAtual){
									cancelaSelecao = 1
									$("#detalhesTabs").dxTabs("instance").option("selectedIndex",painelIndexAtual)
									cancelaSelecao=0
								}					        
							}
					    });					    
				    }else{
						if (layout==2){
							if (abrirMenu!=""){
								abrePainel(abrirMenu,abreMenuResposta)
								abrirMenu = ""
								abreMenuResposta = ""
								return
							}
							if (id!=painelAtual){
								abrePainelSub(id,subId,formulario,tabbed)
								return
							}
							
							if (painelAtual==meuIDMenu){
								$.getJSON(urlPreparacao,{
							        method		: "recPainelIrmao",
							        paciente	: codPacienteValor,
							        idPainel	: painelAtual,
							        codCID		: codCID,
							        ficha 		: ficha,
							        fichaSeq	: fichaSeq,
							        dataPEP		: dataPEP
							    },function(retorno){
							    	if (retorno.sequencia){
				        				meuID = retorno.sequencia
					        			meuIDMenu = retorno.sequencia
								    	abrePainel(meuID,"")
							    	}else{
								    	openPesquisa.hide()
							    	}
							    })
								return
							}
						    if (opcoesSimNao<2){
							    openPesquisa.hide()
							    return
						    }
						    return
						}
						abrePainelSub(id,subId,formulario,tabbed)
				    }
			    })
			}else{
				if (layout==2){
					if (abrirMenu!=""){
						abrePainel(abrirMenu,abreMenuResposta)
						abreMenuResposta = ""
						abrirMenu = ""
						return
					}
					if (id!=meuIDMenu){
						abrePainelSub(id,subId,formulario,tabbed)
						return
					}
					if (painelAtual==meuIDMenu){
						$.getJSON(urlPreparacao,{
					        method		: "recPainelIrmao",
					        paciente	: codPacienteValor,
					        idPainel	: painelAtual,
					        codCID		: codCID,
					        ficha 		: ficha,
					        fichaSeq	: fichaSeq,
					        dataPEP		: dataPEP
					    },function(retorno){
					    	if (retorno.sequencia){
		        				meuID = retorno.sequencia
			        			meuIDMenu = retorno.sequencia
						    	abrePainel(meuID,"")
					    	}else{
						    	openPesquisa.hide()
					    	}
					    })
						return
					}
				    if (opcoesSimNao<2){
					    openPesquisa.hide()
					    return
				    }
				    return
				}
				
				abrePainelSub(id,subId,formulario,tabbed)
			}
		}
	    
	    function abrePainelSub(id,subId,formulario,tabbed){
		    opcoesSimNao = 0
		    id = id;
		    subId = subId;
		    formulario = formulario
		    tabbed = tabbed;
		    loadPanel.show();
   			if (id==1349) {
				id = 1319
			}

			$.get(urlPreparacao,{
		        method		: "recPainel",
		        codPaciente	: codPacienteValor,
		        codPainel	: id,
		        codOpcaoPainel		: subId,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP,
		        layout		: layout,
		        codIDMenu	: meuIDMenu
		        
		    },function(retorno){
			    painelAtual = id
			    painelIndexAtual = -1
			    if ($("#detalhesTabs").html()!=undefined){
			    	painelIndexAtual = $("#detalhesTabs").dxTabs("instance").option("selectedIndex")
			    }
			    if (retorno.indexOf("~")>-1){
				    eval(retorno.split("~")[1])
				    retorno = retorno.split("~")[0]
			    }
			    retornoPainelAnt = retornoPainel
			    eval("retornoPainel = "+retorno);
			    if (retornoPainel.achou==0){
					if ($(".btnSimF").length>1||(retornoPainelAnt.formul.length>2)){
						retornoPainel = retornoPainelAnt
						loadPanel.hide();
					    return
					}
					if ($(".btnSimF").length<2){
						openPesquisa.hide()
					}
				    if (painelAtual==id){
					    openPesquisa.hide()
				    }
				    loadPanel.hide();
				    return
			    }
			    if (retornoPainel.blocos.length<1&&retornoPainel.formul.length<1&&retornoPainel.imagem.length<1&&retornoPainel.blocosL.length<1&&retornoPainel.tabs.length<1){
				    loadPanel.hide();
			    	return
			    }
			    idRetorno = retornoPainel.pai
				preparaPainel(retornoPainel,tabbed)
		    })
		}
	    
	    function carregarPaciente(paciente){
			if (paciente==null||paciente==""){
				codPacienteValor = ""
				sexoPaciente = ""
				codCID = ""
				painelAtual = ""
			    $("#cdPaciente").val("")
			    $(".form-avatar").css("background-image","")
			    formularioDadosGeraisExib.resetValues()
			    formularioDadosGeraisExib.updateData("codPaciente","")
		        carregaFicha()
				return
			}
   	        loadPanel.show();
			$.getJSON(urlPreparacao,{
		        method:"recPaciente",
		        codPaciente:paciente
		    },function(retorno){
			    if (retorno.erro){
				    DevExpress.ui.notify("Paciente inválido", "warning", 4000);
		            loadPanel.hide();
				    return
			    }
			    if (formularioDadosGeraisExib.option("formData").codPaciente==paciente){
		            loadPanel.hide();
		            return
	            }
			    sexoPaciente = retorno.sexo
			    if (retorno.CodCID==""){
					var result = DevExpress.ui.dialog.confirm("Paciente não possuí diagnóstico cadastrado. Deseja abrir o prontuário primário do paciente?", "Abrir PEP Primário?");
				    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
					result.fail(function(dialogResult) {
						paciente = ""
						carregarPaciente("")
					})
				    result.done(function(dialogResult) {
				        if (!dialogResult){
					        paciente = ""
					        carregarPaciente("")
					        return
						}
						codPacienteValor = paciente
					    ficha=1
						abrePEPPrimario()
						openPesquisa.hide()
				    })
				    return
			    }
	            $("#cdPaciente").val(paciente)
	            codPacienteValor = paciente
			    codCID = retorno.CodCID
			    ficha = retorno.ficha
				formularioDadosGeraisExib.option("formData", retorno)
			    $(".form-avatar").css("background-image","url("+retorno.ImageSRC+")")
			    loadPanel.hide();
			    carregaFicha()
		    })
	    }
		
		function carregaFicha(){
			preparaLinhaTempo()
			if (layout==1){
				preparaPainelAcc()
			}else{
				preparaAtendimentoClinico()
			}
			resizeMe()
		    carregaLinhaTempo(codPacienteValor)
	    	carregaAtendimentoClinico(codPacienteValor,0)
		    recuperaEstadiamento(codPacienteValor)
   	        loadPanel.hide();
		}
		
		function carregaLinhaTempo(paciente){
            $.getJSON(urlPreparacao,{
            	method	:"carregaLinhaTempo",
            	paciente: paciente,
            	codCID	: codCID,
	    	},function(result){
		    	vetorDatas = result.datas
		    	dias = result.dias
		        linhaChart = $("#linhaTempoChart").dxSlider({
			        min:0,
			        max:Number(dias)-1,
					label: {
			            visible: true,
			 			format: function(value) {
			                return vetorDatas[value].data;
			            },			            
	   		            position: "top"
			        },
					tooltip: {
			            enabled: true,
			            format: function (value) {
				            if (vetorDatas[value]==undefined) return
			                return vetorDatas[value].data;
			            },
			        },
			        onValueChanged: function(e){
				        agoraLinhaTempo = Date.now()
				        dataPEP = vetorDatas[e.value].valorOriginal
				        ficha = vetorDatas[e.value].fichaOriginal
				        $("#dvLinhaTempoDesc").html(": "+vetorDatas[e.value].valorExibicao)
			            if (e.value==0||e.value==linhaChart.option("max")){
				            linhaChart.option("tooltip.showMode","onHover")
			            }else{
				            linhaChart.option("tooltip.showMode","always")
			            }
				        if (ficha!=formularioDadosGeraisExib.option("formData").ficha){
					        formularioDadosGeraisExib.updateData("ficha",ficha)
                    		loadPanel.show()
		       	            setTimeout(function () { 
				                atualizaTempo()
		        		    }, 5);
				        }
				    },
			    	step:1,
			    	value:Number(result.dias)-1
			    }).dxSlider("instance");
		    	return
		    	linhaChart.option("scrollBar","visible",false)
		    	if (result.length>10){
			    	linhaChart.option("scrollBar","visible",true)
		    	}
				linhaChart.option("dataSource",result)
	    	})
		}
		
		function atualizaTempo(){
			if (agoraLinhaTempo=="") return
			if (Date.now() - agoraLinhaTempo>200){
				agoraLinhaTempo = ""
			    //carregaAtendimentoClinico(codPacienteValor)
			    if (layout==1){
				    carregaGauges()		
			    }
			    recuperaEstadiamento(codPacienteValor)
			    if (layout==2){
				    carregaAtendimentoClinico(codPacienteValor,0)
				    if ($("#openPesquisa").css("display")=="block"&&painelAtual){
				    	setTimeout(function(){loadPanel.show();abrePainel(painelAtual,'',0)},100)
				    }else{
					    loadPanel.hide();
				    }
			    }else{
			    	loadPanel.hide();
			    }
				return
			}
	        setTimeout(function () { 
	            atualizaTempo()
		    }, 100);
			
		}
		
		function carregaAtendimentoClinico(paciente,tipo){
            $.get(urlPreparacao,{
            	method	:"carregaAtendimento",
            	paciente: paciente,
            	dataPEP	: dataPEP,
            	codCID	: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
            	layout	: layout,
	    	},function(result){
		    	eval("result = "+result);
		    	arrayAtendimentoClinico = result.array
		    	arrayAtendimentoClinicoDestaque = result.arrayDestaque
		    	tituloWindow = "Ficha de Atendimento - "+result.titulo
		    	if (result.titulo==undefined){
			    	tituloWindow = "Ficha de Atendimento"
		    	}
		    	$("#boxAtendimentoTitle").html(tituloWindow)
				if (layout==1){
					if (tipo==0||tipo==1){
						$("#TitledivFormAtendimentoClinico").html(tituloWindow)
						boxAtendimento.option("items",result.array)
					}
					if (tipo==0||tipo==2){
						$("#boxAtendimentoDestaqueRelatorios").empty()
						if (result.arrayBaixo){
							for (var i=0;i<result.arrayBaixo.length;i++){
								linha = result.arrayBaixo[i]
								$("#boxAtendimentoDestaqueRelatorios").addClass("atendimentoDestaque")
								$("#boxAtendimentoDestaqueRelatorios").append("<div id='"+linha.dataField+"'></div>")
								$("#"+linha.dataField).dxButton({
							        elementAttr : {
								        tipoImp	: linha.tipoImp,
							        },
									width	: "200px",
									height	: "60px",
									icon	: linha.buttonOptions.icon,
			            			text	: linha.buttonOptions.text, 
			            			onClick : function(e){
				            			tipoImp = e.component._options.elementAttr.tipoImp
				            			imprimir(tipoImp,"Relatório Diagnóstico")
				            		}
								})
							}
						}
					}
					if (tipo==0||tipo==3){		
						if (typeof boxAtendimentoDestaque!="undefined"){
							boxAtendimentoDestaque.option("items",result.arrayDestaque)							
						}
					}
					carregaGauges()		
				}else{
					boxAtendimentoMenu.option("items",result.array)
					resizeMe()
				}
	    	})
		}

		function carregaTratamento(campo,opcao){
			
			abrePainelTratamento(campo,opcao)
			return
            $.get(urlPreparacao,{
            	method	:"carregaTratamento",
            	paciente: paciente,
            	dataPEP	: dataPEP,
            	codCID	: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
            	layout	: layout
	    	},function(result){
		    	eval("result = "+result);
		    	arrayAtendimentoClinicoDestaque = result.arrayDestaque
				if (tipo==0||tipo==2){
					$("#boxAtendimentoDestaqueRelatorios").empty()
					if (result.arrayBaixo){
						for (var i=0;i<result.arrayBaixo.length;i++){
							linha = result.arrayBaixo[i]
							$("#boxAtendimentoDestaqueRelatorios").addClass("atendimentoDestaque")
							$("#boxAtendimentoDestaqueRelatorios").append("<div id='"+linha.dataField+"'></div>")
							$("#"+linha.dataField).dxButton({
						        elementAttr : {
							        tipoImp	: linha.tipoImp,
						        },
								width	: "200px",
								height	: "60px",
								icon	: linha.buttonOptions.icon,
		            			text	: linha.buttonOptions.text, 
		            			onClick : function(e){
			            			tipoImp = e.component._options.elementAttr.tipoImp
			            			imprimir(tipoImp,"Relatório DIagnóstico")
			            		}
							})
						}
					}
				}
	    	})
		}

		function abrePainelTratamento(id,subId){
	        if (codPacienteValor==""){
		        DevExpress.ui.notify("Informe o paciente", "warning", 4000);
		        return
	        }
			opcoesSimNao = 0
			$.get(urlPreparacao,{
		        method		: "recPainel",
		        codPaciente	: codPacienteValor,
		        codPainel	: id,
		        codOpcaoPainel	: subId,
		        dataPEP		: dataPEP,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        layout		: layout,
		        codIDMenu	: meuIDMenu
		    },function(retorno){
			    painelIndexAtual = -1
			    if ($("#detalhesTabs").html()!=undefined){
			    	painelIndexAtual = $("#detalhesTabs").dxTabs("instance").option("selectedIndex")
			    }
			    if (retorno.indexOf("~")>-1){
				    eval(retorno.split("~")[1])
				    retorno = retorno.split("~")[0]
			    }
			    eval("retornoPainel = "+retorno);
			    painelAtual = id
		     	idRetorno = retornoPainel.pai
				preparaPainelTratamento(retornoPainel)
				fechaPanel = false
				$("#boxAtendimentoDestaqueCorpo").addClass("Layout"+layout)
				//boxAtendimentoDestaque
		    })
		}		
		
		function preparaPainelTratamento(objeto,tabbed){
			opcoesSimNao = 0
			if (!tabbed){
		        pesquisaExamesTratamento = $("#boxAtendimentoDestaqueCorpo").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			        width				: "100%",
			        height				: "100%",
				    scrollingEnabled	: true,
			        items: [{
				        cssClass: "linhaDadosTratamento",
				        template: "<div id='detalhesTratamento'></div>"
			        }]
		        }).dxForm("instance")
			}
			$("#detalhesTratamento").empty()
	        imagem=0
			if (objeto.formul.length>0) {
				$("#detalhesTratamento").append("<div id='detalhesFormulario' class='formularioDetalhe'>")
		        colCount = 1
		        if (objeto.formul.dividir==1&&objeto.formul.length>10){
		        	colCount = 2
		        }
		        dxFormulario = $("#detalhesFormulario").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
					screenByWidth: function(width) {
			            return "lg";
			        },
			        activeStateEnabled	: true,
			        formData			: objeto.formulDados,
			        width				: "100%",
				    scrollingEnabled	: true,
				    focusStateEnabled	: true,
				    onContentReady		: function(e){
					    /*e.element.find("input[type='text'],textarea").each(function(){
						    var objId = $(this).parent().parent().parent().find("input")[0]
						    var idobj = $(objId).attr("name")
						    var ret = eval("objeto.formulTooltip.tt"+idobj)
						    if (!ret) return
						    var string = ""
						    if (ret[0].valor==undefined){
							    string += "<tr><th colspan=3>"
							    string += ret[0]
							    string += "</th></tr>"
						    }else{
							    string += "<tr><th colspan=3>Histórico de Alterações:</th></tr><tr><td>"
								string +="<ul class='tbToolTipEsta'>"
								for (var i=0;i<ret.length;i++){
								    string +="<li>Valor: "+ret[i].valor+" (registrado em "+ret[i].data+" por "+ret[i].usuario+")</li>"
							    }
								string +="</ul>"
								string +="</tr></td>"
						    }
							$(this)[0].onmouseover = function(){
								$("#ttip").dxTooltip({
									target: $(this),
									visible:true,
							        position: "right",
									contentTemplate: function (contentElement) {
							            contentElement.append("<table class='tbToolTipEsta'>"+string+"</table>")
							        }
								})
							}
							$(this)[0].onmouseout = function(){
								$("#ttip").dxTooltip({
									visible:false
								})
							}
						 });*/
					    $(".subGrupos.invisivel").each(function(){
							$(this).hide()
						})
					    e.component._scrollable.option("showScrollbar", "always");  
					    corrigeLayout()
				    },
				    alignItemLabels	: true,
				    alignItemLabelsInAllGroups : true,
			        items				: [{
				        itemType	: "group",
				        colCount	: colCount,
				        cssClass	: "formularios"+layout,
				        items		: objeto.formul,
			        }],
   					onFieldDataChanged	: function(obj){
	   					if (alterarMult==0) {
		   					alterarMult = 1
		   					return
	   					}
	   					campo = obj.dataField
	   					if (obj.dataField.indexOf("mult_")>=0){
		   					if (obj.value==undefined){
			   					return
		   					}
	   						separado = obj.dataField.split("_")
	   						for (var i=1;i<=100;i++){
		   						if (typeof dxFormulario.getEditor("mult_"+i+"_"+separado[2])=="undefined"){
			   						break
		   						}
		   						if (i!=separado[1]) {
			   						alterarMult = 0
		   							dxFormulario.getEditor("mult_"+i+"_"+separado[2]).option("value","")
		   						}
	   						}
	   						campo = separado[2]
	   						alterarMult = 1
	   					}
						if (obj.value!=""){
							if (obj.value==true) obj.value=1
							if (obj.value==false) obj.value=0
						}
						$.getJSON(urlPreparacao,{
					        method		: "salvaPainel",
					        codPaciente	: codPacienteValor,
					        dataField	: campo,
					        valor		: JSON.stringify(obj.value),
					        codCID		: codCID,
					        ficha 		: ficha,
					        fichaSeq	: fichaSeq,
					        dataPEP		: dataPEP
					    })
   					}

			    }).dxForm("instance")
			    $(".dvPosNegTexto").dxTextArea({
					width: '100%',
					height: '30px'
					
				})
				$(".btnPositivo").dxButton({
					width	: "130px",
					type	: "success",
					icon	: "check",
        			text	: "Positivo", 
				})										            
				$(".btnNegativo").dxButton({
					width	: "130px",
					type	: "danger",
					icon	: "clear",
        			text	: "Negativo", 
				})	
				$(".btnSim").dxButton({
					icon	: "check",
        			text	: "Sim", 
				})										            
				$(".btnNao").dxButton({
					icon	: "clear",
        			text	: "Não", 
				})	
				$(".helpBt").each(function(){
					var id = $(this).attr("id")
				 	$("#"+id+"Div").dxTooltip({
				        target: "#"+id,
				        cornerRadius: 15,
				        position :"right",
				        showEvent: "mouseenter",
				        hideEvent: "mouseleave",
				        closeOnOutsideClick: true,
				    });
				})
				var botoes = $(".btnSimF").length
				if (botoes>opcoesSimNao){
					opcoesSimNao = botoes
				}
			}
	        if (objeto.imagem.length>0) {
				opcoesSimNao = 2
		        baseHeight = 40
		        itemMargin = 5,
		        tamanho=325
		        widthDeta = $("#detalhesTratamento")[0].scrollWidth
		        altImagem = $("#pesquisaExamesTratamento").height()-10
		        padding=0
		        tamanhoImagem = ((((widthDeta-(tamanho*2)))/2)+tamanho-90)
				$("#detalhesTratamento").append("<div id='detalhesBlocoLeft' style='padding-top:"+padding+"px;border:0px;position:absolute;top:0px;width:"+tamanho+"px'></div><div id='divMPCorpo' style='border:0px solid blue;position:absolute;top:0px;width:180px;left:"+(tamanhoImagem)+"px;z-index:-1;'><img id='imgCorpo' src='"+ygif+"PEP/premium/mapeamentos/1.png' height='"+(altImagem)+"'></div><div id='detalhesBlocoRight' style='position:absolute;top:0px;width:"+tamanho+"px;left:"+(widthDeta - tamanho-10)+"px;border:0px;padding-top:"+padding+"px;'></div>")
				var stringA = ""
				var stringB = ""
				for (var cont=0;cont<objeto.imagem.length;cont++){
		            align = "center"
		            var borda = ""
		            classeTela = "boxTileDetalheImagem"
		            if (objeto.imagem[cont].Tipo=="7"){
			            if (objeto.imagem[cont].Valor=="1"){
				            classeTela = "boxTileDetalheImagemBorda"
			            }
		            }
		            if (objeto.imagem[cont].lado==1){
			            stringA = stringA+"<div id='divMP"+objeto.imagem[cont].ID+"' class='"+classeTela+"' style='width:220px;' onclick=respostaDetalhe('"+objeto.imagem[cont].ID+"',-1,"+objeto.formul.length+")>"+objeto.imagem[cont].Caption+"</div><div style='height:12px' />"
		            }else{
						stringB = stringB+"<div id='divMP"+objeto.imagem[cont].ID+"' class='"+classeTela+"' style='width:220px;' onclick=respostaDetalhe('"+objeto.imagem[cont].ID+"',-1,"+objeto.formul.length+")>"+objeto.imagem[cont].Caption+"</div><div style='height:12px' />"
		            }
				}
				for (var cont=0;cont<objeto.blocos.length;cont++){
					stringB = stringB+"<div id='divMP"+objeto.blocos[cont].ID+"' class='"+classeTela+"' style='"+borda+";width:220px;' onclick=respostaDetalhe('"+objeto.blocos[cont].ID+"',1,"+objeto.formul.length+")>"+objeto.blocos[cont].Caption+"</div><br>"
				}
				
				$("#detalhesBlocoLeft").html(stringA)
				$("#detalhesBlocoRight").html(stringB)
				imagem = 1
	        }else{
		        baseHeight = 50
		        itemMargin = 20,
		        classeTela = "boxTileDetalheSubGrupo"
		        if (objeto.blocosL.length>0){
					$("#detalhesTratamento").append("<table width=100%><tr><td><div id='detalhesBlocoLeft'></div></td><td><div id='detalhesBlocoRight'></div></td></tr></table>")
			    }
	        }
			if (objeto.blocosL.length>0){
		        $("#detalhesBlocoLeft").dxTileView({
			        items			:	objeto.blocosL,
			        height			: 	$("#pesquisaExamesTratamento").height(),
					baseItemHeight	:   baseHeight,
					itemMargin		:   itemMargin,
					baseItemWidth	: 	$("#detalhesBlocoLeft").width()-50,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            var borda = ""
			            if (itemData.Tipo=="8"){
				            if (itemData.Valor=="1"){
					            borda = "border:2px solid yellow"
				            }
			            }
		            	retorno = "<div id='divMP"+itemData.ID+"' class='"+classeTela+"' style='"+borda+"' onclick=respostaDetalhe('"+itemData.ID+"',-1,"+objeto.formul.length+")><p>"+itemData.Caption;
			            return retorno
			        },
			    }).dxTileView("instance");
			}
			if (objeto.blocosR.length>0){
		        $("#detalhesBlocoRight").dxTileView({
			        items			:	objeto.blocosR,
			        height			: 	$("#pesquisaExamesTratamento").height(),
					itemMargin		:   itemMargin,
					baseItemWidth	: 	$("#detalhesBlocoRight").width()-50,
					baseItemHeight	:   baseHeight,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            var borda = ""
			            if (itemData.Tipo=="8"){
				            if (itemData.Valor=="1"){
					            borda = "border:2px solid yellow"
				            }
			            }
		            	retorno = "<div id='divMP"+itemData.ID+"' class='"+classeTela+"' style='"+borda+"' onclick=respostaDetalhe('"+itemData.ID+"',-1,"+objeto.formul.length+")><p>"+itemData.Caption;
			            return retorno
			        },
			    }).dxTileView("instance");
			}
			if (objeto.imagem.length==0&&objeto.blocos.length>0) {
				$("#detalhesTratamento").append("<div id='detalhesBloco'>")
		        $("#detalhesBloco").dxTileView({
			        items			:	objeto.blocos,
				    height			: 	"100%",
				    width			: 	"100%",
					itemMargin		: 	20,
					baseItemHeight	: 	78,
					baseItemWidth	: 	$("#pesquisaExamesTratamento").width()-50,
				    showScrollbar	: 	true,
					direction		: 	"vertical",
					itemTemplate: function (itemData, itemIndex, itemElement) {
			            align = "center"
			            if (itemData.Tipo=="2"){
				            if (itemData.Valor==""){
      				            borderYes = ""
					            borderNo = ""
				            }else if (itemData.Valor==1){
					            borderYes = bordaYesNo
					            borderNo = ""
				            }else {
					            borderYes = ""
					            borderNo = bordaYesNo
				            }
				            retorno = "<div class='boxTileDetalheSN'><p>"+itemData.Caption;
				            botao="<div id='"+itemData.ID+"Yes' class='btnSim' style='"+borderYes+"' onclick=respostaDetalhe('"+itemData.ID+"',1,"+objeto.formul.length+",1)></div>&nbsp;&nbsp;&nbsp;<div id='"+itemData.ID+"No' class='btnNao' style='"+borderNo+"' onclick=respostaDetalhe('"+itemData.ID+"',0,"+objeto.formul.length+",1)></div>"
				            retorno = retorno+"<div class='rodape' style='width:100%;text-align:"+align+";padding:5px'>"+botao+"</div></p></div>"
			            }else{
			            	retorno = "<div class='boxTileDetalhe' onclick=verificaRegrasPainel('"+itemData.ID+"')><p>"+itemData.Caption;
			            }
			            
			            return retorno
			        },
			    }).dxTileView("instance");
				$(".btnSim").dxButton({
					width	: "130px",
					height	: "35px",
					type	: "success",
					icon	: "check",
        			text	: "Sim", 
				})										            
				$(".btnNao").dxButton({
					width	: "130px",
					height	: "35px",
					type	: "danger",
					icon	: "clear",
        			text	: "Não", 
				})	
			}
			if (objeto.tabs.length>0) {
				$("<div id='tabs'>").insertBefore("#detalhesTratamento")
				$("#tabs").append("<div id='detalhesTabs'>")
				$("#detalhesTratamento").css("height",$("#pesquisaExamesTratamento").height()-50)
				$("#pesquisaExamesTratamento").addClass("bordaFormularioPrincipal")
				cancelaSelecao=1
				$("#detalhesTabs").dxTabs({
					dataSource: objeto.tabs,
					selectedIndex: 0,
					onOptionChanged: function(e){
						if (e.name!="selectedItem"){
							return
						}
						if (cancelaSelecao==1) {
							return
						}
						verificaRegrasPainel(e.value.id,"",1,1)
					}
				})
				verificaRegrasPainel(objeto.tabs[0].id,"",1,1)

			}
			if ($("#detalhesTabs").html()==undefined){
				$("#pesquisaExamesTratamento").removeClass("bordaFormularioPrincipal")
			}
		    idRetorno = objeto.pai
			if ($("#detalhesTabs").html()!=undefined){
			    idRetorno = ""
			}
			if (layout==2&&meuIDMenu==painelAtual){
				//idRetorno = ""
			}
		    if (imagem==1){
			    desenhar(objeto.imagem);
		    }
		    loadPanel.hide();

		}
		
		
		function carregaGauges(){
			$.getJSON(urlPreparacao,{
		        method		: "recPercentual",
		        paciente	: codPacienteValor,
		        codCID		: codCID,
		        ficha 		: ficha,
		        fichaSeq	: fichaSeq,
		        dataPEP		: dataPEP
		    },function(retorno){
			    for (var cont=0;cont<retorno.length;cont++){
				    meuId = retorno[cont].idPainel
				    alerta = retorno[cont].alerta
				    alertaTexto = retorno[cont].alertaTexto
					//
				    percentual = Number(retorno[cont].percentual)
				    pendentes = retorno[cont].pendentes
				    //
				    if (alerta==1){
						montaAlerta(meuId,alertaTexto)
				    }
				    var cor = calculaCor(percentual)
				    //
				    montaToolTipGauge(meuId,pendentes,percentual)
				    //
				    $("#gauge_"+meuId).dxCircularGauge({
					    size: {
					    	height:layout==1?28:20,
					    	width:layout==1?28:26
					    },
				        rangeContainer: {
					        offset:10,
				            ranges: [
				                { startValue: 0, endValue: percentual, color: cor },
				                { startValue: percentual, endValue: 100, color: "#FFf" }
				            ],
				            width:3
				        },
				        valueIndicator: {
					        color: "black",
				        	type:"triangleMarker",
				        	horizontalOrientation:"left",
				        	length	: 0,
				        	width	: 0,
				        	size	: 0,
				        	verticalOrientation:"bottom",
				    	},
				        label:{
					        visible:false
				        },
				        scale:{
					        label:{
						        visible:false
					        },
					        tick:{
						        visible:false
					        }
				        },
				        tooltip:{
					        enabled:false
				        }
					});
			    }
			})
		}
		
		function abrePesquisaPacientes(){
			 popupOptions = {
		        width: "90%",
		        height: "90%",
		        showTitle: true,
		        title: "Pesquisa Pacientes",
		        visible: true,
		        dragEnabled: false,
		        closeOnOutsideClick: false,
				toolbarItems: [{
						location:"before",
						toolbar :"top",
					},{
						widget: "dxButton",
						location:"before",
						toolbar:"bottom",
						options: { 
							width	: "130px",
							type	: "default",
							icon	: "close",
                			text	: "Sair", 
                			onClick : function(){
	                			openPesquisa.hide()
	                		}
						}
					},{
						widget: "dxButton",
						location:"after",
						toolbar:"bottom",
						options: { 
							width	: "190px",
							type	: "default",
							icon	: "fas fa-users",
                			text	: "Novo Paciente", 
                			onClick : function(){
	                			cadastraPaciente("")
                			}
						}
					}],			        
		    }		
		    if ($("#openPesquisa").html()!=""){
		    	pesquisaExames.dispose()
		    	openPesquisa.dispose()
		    }
		    $("#openPesquisa").removeClass("Layout"+layout)
   			$("#openPesquisa").html("<div id='pesquisaExames'></div>")
			openPesquisa = $("#openPesquisa").dxPopup(popupOptions).dxPopup("instance")
			preparaPesquisaPacientes()
		}		
		
		function cadastraPaciente(paciente){
			loadPanel.show();
		    if ($("#openPesquisaSub").html()!=""){
		    	pesquisaExamesSub.dispose()
		    	openPesquisaSub.dispose()
		    }
		    $("#openPesquisaSub").removeClass("Layout"+layout)
   			$("#openPesquisaSub").html("<div id='pesquisaExamesSub'></div>")
			preparaCadastraPaciente(paciente)
			
		}
		
		function preparaCadastraPaciente(paciente){
	        $.getJSON(urlPreparacao,{
	            method:"getPacienteCadastro",
	            codigo: paciente
	        },function(retorno){
			    if (retorno.erro){
				    DevExpress.ui.notify("Paciente inválido", "warning", 4000);
			    }
		    	pesquisaExamesSub = $("#pesquisaExamesSub").dxForm({
					screenByWidth: function(width) {
			            return "lg";
			        },
			    	formData	: retorno,
			    	onContentReady: function(){
	    				openPesquisaSub = $("#openPesquisaSub").dxPopup({
					        width: '95%',
					        height: '90%',
					        showTitle: true,
					        title: "Cadastra Pacientes",
					        visible: true,
					        dragEnabled: false,
					        closeOnOutsideClick: false,
							toolbarItems: [{
								location:"before",
								toolbar :"top",
							},{
								widget: "dxButton",
								location:"before",
								toolbar:"bottom",
								options: { 
									width	: "130px",
									type	: "default",
									icon	: "close",
			            			text	: "Fechar", 
			            			onClick : function(){
			                			openPesquisaSub.hide()
			                		}
								}
							},{
								widget: "dxButton",
								location:"after",
								toolbar:"bottom",
								options: { 
									width	: "130px",
									type	: "default",
									icon	: "check",
			            			text	: "Salvar", 
			            			onClick : function(){
			                			salvarPaciente()
			                		}
								}
							}],			        

	    				}).dxPopup("instance")
	    				loadPanel.hide();

				    },
					scrollingEnabled	: true,
			        items: [{
			            itemType: "group",
			            cssClass: "first-group",
			            items: [{
					        itemType: "group",
				            items: [{
				            	itemType: "group",
					            colCount: 5,
				            	items:[{
					            		cssClass: "imagem",
			                			template: "<center><div class='form-avatar-cad' style='height:125px;width:125px;'></div><div id=carregaPhoto name=carregaPhoto style='position:relative;left:26px;'></div></center>"
									},{
										itemType: "group",
										colSpan : 4,
										colCount:4,
										items:[{
								            dataField	: "Nome",
								            colSpan		: 2,
											validationRules: [{
							                    type: "required"
							                }],				            
								        },{
								            dataField: "Sexo",
			                                editorType: "dxSelectBox",
								            colSpan		: 2,
											validationRules: [{
							                    type: "required"
							                }],				            
											editorOptions: {
					            		        valueExpr: "Codigo", 
												displayExpr: "Descricao",
						                        items: [{"Codigo":1,"Descricao":"Masculino"},{"Codigo":2,"Descricao":"Feminino"}]
						                    }
								        },{
								            dataField	: "DataDeNascimento",
								            editorType	: "dxDateBox",
								            editorOptions: {
									            useMaskBehavior: true
								            },
											validationRules: [{
							                    type: "required"
							                }],				            
								            colSpan		: 2
								        },{
								            dataField	: "NãoInformada",
								            editorType	: "dxCheckBox",
								            colSpan		: 2
								        },{
								            dataField: "CPF",
								            colSpan		: 2
								        },{
								            dataField: "RG",
								            colSpan		: 2
								        },{
								            dataField: "CNS",
								            colSpan		: 2
								    	},{
								            dataField: "Prontuário",
								            colSpan		: 2
								        },{
									        colSpan		: 2,
								            dataField	: "Classificação",
							    	        editorType	: "dxSelectBox",
							        	    editorOptions: {
						  						items: [{
													"codigo":"1",
													"descricao":"Início de Tratamento"
												},{
													"codigo":"2",
													"descricao":"Em Tratamento"
												},{
													"codigo":"3",
													"descricao":"Óbito"
												}],										        
												valueExpr: "codigo", 
												displayExpr: "descricao",
							        	    },
											validationRules: [{
							                    type: "required"
							                }],				            
							        	},{
								            dataField	: "Alergias",
							    	        editorType	: "dxTextArea",
							        	    colSpan		: 2
							        	}]
							      }]
					        }]
		                },{
					        itemType: "group",
		                    caption: "Dados da Mãe do Paciente",
				            colCount: 3,
				            items: [{
					            dataField	: "NomeDaMãe",
					            colSpan		: 2,
					        },{
					            dataField	: "DataDeNasc",
					            editorType	: "dxDateBox",
					            editorOptions: {
						            useMaskBehavior: true
					            }
					        }]
					    },{
					        itemType: "group",
		                    caption: "Contato",
				            colCount: 3,
				            items: [{
					            dataField	: "Telefone1"
					        },{
					            dataField	: "Telefone2"
					        },{
					            dataField	: "PerdaDeContato",
					            editorType	: "dxCheckBox",
					        },{
					            dataField	: "Email",
					            colSpan		: 3
					            
					        }]
					    },{
					        itemType: "group",
		                    caption: "Endereço",
	   			            colCount: 2,

				            items: [{
					            dataField	: "Logradouro"
					        },{
					            dataField	: "Número"
					        },{
					            dataField	: "Complemento"
					        },{
					            dataField	: "Bairro"
					        },{
					            dataField	: "CEP"
					        },{
					            dataField	: "Cidade"
					        },{
					            dataField	: "Estado",
								editorType	: "dxSelectBox",
					            editorOptions: {
		            		        valueExpr: "Codigo", 
									displayExpr: "Descricao",
									searchEnabled: true,
									dataSource: new DevExpress.data.DataSource({
							            store: new DevExpress.data.CustomStore({
						                byKey: function(args) {
						                    return $.getJSON(urlPreparacao,{
							                    method:"GetUFs",
							                    codigo: args
							                });
						                },
							            load: function(args) {
							                    return $.getJSON(urlPreparacao,{
								                    method:"GetUFs",
						                        	usuario: YBED,
						                        	skip:args.skip,
						                        	take:args.take,
						                        	searchValue:args.searchValue
								                });
							                }
							            })
							        }),
			                        value: ""
					            },				            
					        }]
					    }
		             ]
			        }]
		    	}).dxForm("instance")
		    	$("#carregaPhoto").dxFileUploader({
					selectButtonText: "Selecione a foto",
			        labelText: "",
			        accept: "image/*",
			        uploadMode: "instantly"	,
			        uploadUrl: urlPreparacao+"&method=uploadPhoto",
					onUploaded: function(e) {
						openFotoAvatar()
			        }			        
		    	})
				openFotoAvatar()
		    });
					
		}
		
		function openFotoAvatar(){
	        $.getJSON(urlPreparacao,{
	            method		:"recPhotoTemp",
	        },function(retorno){
				$(".form-avatar-cad").css("background-image","url("+retorno.ImageSRC+")")
	        })
		}
		
		function salvarPaciente(){
	        if (!pesquisaExamesSub.validate().isValid){
		        DevExpress.ui.notify("Favor preencher os campos obrigatórios","warning");
		        return
	        }
	        $.getJSON(urlPreparacao,{
	            method		:"salvaPaciente",
	            dados		: JSON.stringify(pesquisaExamesSub.option("formData"))
	        },function(retorno){
	            if (retorno.status==1){
	            	DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
	            	carregarPaciente(retorno.codigo)
	            	//formularioDadosGeraisExib.updateData("codPaciente",retorno.codigo)
	            	openPesquisaSub.hide()
	            	openPesquisa.hide()
	            }else{
					DevExpress.ui.notify("Erro: "+retorno.status,"error");
		        }
	        })
		}
		
		function preparaPesquisaPacientes(){
			exibirTodos = 0
	        pesquisaExames = $("#pesquisaExames").dxDataGrid({
				dataSource:  new DevExpress.data.CustomStore({
            		load: function(args) {
	            		var deferred = $.Deferred()
			            $.getJSON(urlPreparacao,{
        	            	method	:"pesquisaPacientes",
        	            	exTodos	: exibirTodos,
        	            	filter	: JSON.stringify(args.filter),
        	            	sort	: JSON.stringify(args.sort),
        	            	take	: JSON.stringify(args.take),
        	            	skip	: JSON.stringify(args.skip),
	        	    	},function(result){
							deferred.resolve(
								result.data, {
									totalCount: result.totalCount
								});
						});
						return deferred.promise();
    	    		}	
    			}),
		        allowColumnResizing: true,
    			remoteOperations	: true,
    			columns:[{
	    				dataField : "PatientID",
	    				caption   : "Código",
	    				width	  : "100px"
	    			},{
		    			dataField : "Name",
		    			caption   : "Nome",
	    			},{
		    			dataField : "CID",
		    			caption   : "Diagnóstico",
	    			},{
		    			dataField : "DOB",
		    			caption   : "Data Nasc.",
		    			width	  : "100px",
		    			dataType  : "date"
	    			},{
		    			dataField : "Gender",
		    			caption   : "Sexo",
		    			width	  : "100px"
	    			},{
		    			dataField : "Classificacao",
		    			caption   : "Classificação",
		    			width	  : "200px"
	    			},{
		    			dataField : "Email",
		    			caption   : "E-mail",
		    			width	  : "200px"
	    			},{
		    			dataField : "Editar",
		    			caption   : "Editar",
		    			width	  : "55px",
		    			disabled	: true,
						cellTemplate: function (container, options) {
		                    $("<div style='cursor:pointer' onclick=cancelaSelecao=1;cadastraPaciente('"+options.data.PatientID+"')>")
		                        .append($("<center><i class='fas fa-user-edit'></i>"))
		                        .appendTo(container);
		                }		    			
	    			}
	    		],
	    		selection: { mode: "single" },
				filterRow: { visible: true },
				hoverStateEnabled: true,
				paging: { enabled: true },
				height: "100%",	
				showBorders: true,
				showRowLines: true,
				rowAlternationEnabled: true,
				columnFixing: {
		            enabled: true
		        },
				onSelectionChanged: function(selectedItems) {
					if (cancelaSelecao==1){
						cancelaSelecao=0
						pesquisaExames.clearSelection()
						return
					}
					if (selectedItems.selectedRowsData.length>0){
						codPaciente = selectedItems.selectedRowKeys[0].PatientID
						if (selectedItems.selectedRowKeys[0].CID==""){
							var result = DevExpress.ui.dialog.confirm("Paciente não possuí diagnóstico cadastrado. Deseja abrir o prontuário primário do paciente?", "Abrir PEP Primário?");
						    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
							result.fail(function(dialogResult) {
								codPaciente = ""
							})
						    result.done(function(dialogResult) {
						        if (!dialogResult){
							        codPaciente = ""
							        return
								}
								codPacienteValor = codPaciente
								ficha=1
								abrePEPPrimario()
								openPesquisa.hide()
						    })
						    return
						}else{
							carregarPaciente(codPaciente)
						}
						openPesquisa.hide()
					}
				},				onToolbarPreparing: function(e) {
					e.toolbarOptions.items.unshift({
						location: "after",
						widget: "dxCheckBox",
						options: {
							text: "Exibir Todos os Paciente",
							hint: "Exibir Todos os Paciente",
							onValueChanged: function(e) {
								exibirTodos = e.value==true?1:0
								pesquisaExames.getDataSource().reload()
							}
						}
					})
				}				

			}).dxDataGrid("instance")
		}
		function importaResultadoExame(meuId,texto){
			var result = DevExpress.ui.dialog.confirm("Deseja utilizar os resultados do dia "+texto+" nesta consulta?", "Importar resultados");
		    $(".dx-overlay-content.dx-popup-normal.dx-popup-draggable.dx-resizable.dx-popup-inherit-height").css("z-index","100000")
		    result.done(function(dialogResult) {
		        if (!dialogResult){
			        return
				}
		        $.getJSON(urlPreparacao,{
			        method		: "importarResultado",
			        meuId		: meuId,
	            	paciente	: codPacienteValor,
	            	dataPEP		: dataPEP,
	            	codCID		: codCID,
			        ficha 		: ficha,
			        fichaSeq	: fichaSeq,
			        painelAtual : painelAtual
			    },function(retorno){
				    if (retorno.erro){
					    DevExpress.ui.notify(retorno.mensagem, "warning", 4000);
				    }else{
					    DevExpress.ui.notify(retorno.mensagem, "success", 4000);
					    tabbed = $("#detalhesTabs").length
				    	abrePainelSub(painelAtual,"",retornoPainel.formul.length,tabbed)
				    	openHistorico.hide()
				    }
				});
		    });					    
			
			
		}
		
		function toggleLinhaTempo(){
	        widthDadosGerais = dadosGerais.option("width")
	        widthOpcoesGerais = opcoesGerais.option("width")
		    widthJanela = window.innerWidth
		    heightJanela = window.innerHeight
		    if (widthJanela<900) widthJanela = 900
		    if (heightJanela<500) heightJanela = 500
	        
	        if ($("#linhaTempoChart").css("display")=="none"){
		        $.getJSON(urlPreparacao,{
			        method	: "setToggle",
			        painel	: "linhaTempo",
			        exibir	: 1
			    });
		        $("#linhaTempoChart").animate({height:'show'})
		        $(".linhaTempoForm"+layout).animate({padding:'10px'})
				var altDestaque = 0
				if (layout==1){
				    altDestaque = 95
		        	$("#divFormAtendimentoClinicoAcc").animate({top:"140px"})
				}
				$("#buttonHideLT").css("transition","transform .5s")
				$("#buttonHideLT").css("transform","rotate(0deg)")
				if (layout==2){
				    $("#divFormLinhaTempo").animate({top:heightJanela-89+"px"})
				    $("#pesquisaExamesPre").css("height",heightJanela-tamanhoToolBar-formularioLinhaTempo.option("height")+22+"px")
				    $("#atendimentoClinicoDeta").css("height",heightJanela-tamanhoToolBar-formularioLinhaTempo.option("height")+13+"px")
					openPesquisa.repaint()
					
				}else{
					setTimeout(function(){ 
						formAtendimentoClinicoAcc.option("height",heightJanela-tamanhoToolBar-formularioLinhaTempo.option("height")+18)
						formBox.option("height",heightJanela-tamanhoToolBar-formularioLinhaTempo.option("height")-65)
						//carregaGauges();
					},200)
				}
	        }else{
		        $.getJSON(urlPreparacao,{
			        method	: "setToggle",
			        painel	: "linhaTempo",
			        exibir	: 0
			    });
	        	$("#linhaTempoChart").animate({height:'hide'})
		        $(".linhaTempoForm"+layout).animate({padding:'0px'})
				var altDestaque = 0
				if (layout==1){
				    altDestaque = 95
					$("#divFormAtendimentoClinicoAcc").animate({top:"76px"})
				}
				$("#buttonHideLT").css("transition","transform .5s")
				$("#buttonHideLT").css("transform","rotate(180deg)")
				if (layout==2){
					$("#divFormLinhaTempo").animate({top:heightJanela-26+"px"})
					$("#pesquisaExamesPre").css("height",heightJanela-tamanhoToolBar-30+"px")
					$("#atendimentoClinicoDeta").css("height",heightJanela-tamanhoToolBar-39+"px")
					if ($("#openPesquisa").html()!=""){
						setTimeout(function(){openPesquisa.repaint()}, 500);
					}
				}else{
					formAtendimentoClinicoAcc.option("height",heightJanela-tamanhoToolBar-33)
					formBox.option("height",heightJanela-tamanhoToolBar-120)
					//carregaGauges();
				}
	        }
		}


		function toggleOpcoes(){
	        widthDadosGerais = dadosGerais.option("width")
	        widthOpcoesGerais = opcoesGerais.option("width")
		    widthJanela = window.innerWidth
		    heightJanela = window.innerHeight
		    if (widthJanela<900) widthJanela = 900
		    if (heightJanela<500) heightJanela = 500
	        
	        if ($("#divFormOpcoesGerais").css("display")=="none"){
		        $.getJSON(urlPreparacao,{
			        method	: "setToggle",
			        painel	: "opcoes",
			        exibir	: 1
			    });
		        $("#botaoExibeOpcoesGerais").animate({width:'hide'})
				$("#divFormOpcoesGerais").animate({width:'show',left:widthJanela-widthOpcoesGerais+10})
	        	$("#divTema").animate({left:-325})
	        }else{
		        $.getJSON(urlPreparacao,{
			        method	: "setToggle",
			        painel	: "opcoes",
			        exibir	: 0
			    });
		        $("#botaoExibeOpcoesGerais").animate({width:'show'})
				$("#divFormOpcoesGerais").animate({width:'hide',left:window.innerWidth})
	        	$("#divTema").animate({left:-75})
	        }
		}
		
		function itemTemplateRecTerapeutica(itemData, _, itemElement){
            itemElement
                .parent().addClass("conteudoRadioGroup")
                .html(itemData.Name+(itemData.Recomendado==1?"<font color='"+corHints+"'> *</font>":""));
		}
		
	    function resizeMe(){
		    widthJanela = window.innerWidth
		    heightJanela = window.innerHeight
		    if (widthJanela<900) widthJanela = 900
		    if (heightJanela<500) heightJanela = 500
		    if (layout==1){
			    widthOpcoesGerais = opcoesGerais.option("width")
			    leftTema = -325
			    if ($("#divFormOpcoesGerais").css("display")=="none"){
			    	widthOpcoesGerais = 12
			    	leftTema = -75
			    }
			    var altLinhaTempo=0
			    if (typeof formularioLinhaTempo!="undefined"){
			    	altLinhaTempo = formularioLinhaTempo.option("height")-5 
			    }
			    topLinhaTempo = 97
			    if ($("#linhaTempoChart").css("display")=="none"){
					altLinhaTempo = 49
					topLinhaTempo = 36
			    }
			    altDestaque = 106
			    widthDadosGerais = dadosGerais.option("width")
			    left = widthDadosGerais -10
			    
			    $("#divTema").css({left:leftTema,top:-5})
			    
			    $("#divFormOpcoesGerais").css("left",widthJanela-widthOpcoesGerais+10)
			    formularioOpcoesGeraisExib.option("height",heightJanela+10)
			    
			    $("#divFormLinhaTempo").css("left",left)
			    $("#divFormLinhaTempo").css("width",widthJanela - widthDadosGerais - 12 + 25)
			    //
			    alturaBox = heightJanela-tamanhoToolBar - altLinhaTempo-altDestaque-18
			    //
			    $("#divFormAtendimentoClinicoAcc").css("top",topLinhaTempo+tamanhoToolBar-5)
			    $("#divFormAtendimentoClinicoAcc").css("left",left+9)
			    $("#divFormAtendimentoClinicoAcc").css("width",widthJanela - widthDadosGerais - 12 + 10)
			    //
			    if (typeof boxEscolhaFicha!="undefined"){
				    boxEscolhaFicha.option("height",alturaBox + 85)
			    }
			    //
		    	if (typeof formAtendimentoClinicoAcc!="undefined"){
		    		formAtendimentoClinicoAcc.option("height",heightJanela-tamanhoToolBar - altLinhaTempo+15)
		    	}
		    	if (typeof formBox!="undefined"){
		    		formBox.option("height",alturaBox + 52)
		    	}
			    formularioDadosGeraisExib.option("height",heightJanela-tamanhoToolBar - 21)
				$("#divRodapeExit").css("top",(heightJanela - 37))
				$("#divRodapeExit").css("left",4)
			    
		    }else{
			    //widthOpcoesGerais = opcoesGerais.option("width")
			    widthDadosGerais = dadosGerais.option("width")
			    widthMenu = 300
			    if ($("#boxAtendimentoMenu .dx-menu-item-content").length){
			    	widthMenu = $("#boxAtendimentoMenu .dx-menu-item-content")[0].scrollWidth+18
			    }
			    if (widthMenu>400) widthMenu = 300
			    leftTema = -325
			    if ($("#divFormOpcoesGerais").css("display")=="none"){
			    	widthOpcoesGerais = 12
			    	leftTema = -75
			    }
			    altLinhaTempo = 0
			    if (typeof formularioLinhaTempo!="undefined"){
			    	altLinhaTempo = formularioLinhaTempo.option("height")-5 
			    }
			    
			    topLinhaTempo = 105
			    if ($("#linhaTempoChart").css("display")=="none"){
					altLinhaTempo = 48
					topLinhaTempo = 44
			    }
			    widthDadosGerais = dadosGerais.option("width")
			    left = widthDadosGerais -10
			    
			    $("#divTema").css({left:leftTema,top:-5})
			    
			    $("#divFormOpcoesGerais").css("left",widthJanela-widthOpcoesGerais+10)
			    formularioOpcoesGeraisExib.option("height",heightJanela+10)
			    
			    formularioDadosGeraisExib.option("height",heightJanela-tamanhoToolBar-50)
				$("#divFormDadosGerais").css("left",widthJanela-widthDadosGerais+12)
				$("#divRodapeExit").css("top",(heightJanela-36))
				$("#divRodapeExit").css("left",widthJanela-widthDadosGerais+16)
				$("#divRodapeExit").css("width",257)

			    $("#divFormLinhaTempo").css("top",(heightJanela- altLinhaTempo+22))
			    $("#divFormLinhaTempo").css("left",widthMenu-26)
			    $("#divFormLinhaTempo").css("width",widthJanela - widthDadosGerais -widthMenu + 50)
			    
			    $("#divFormAtendimentoClinico").css("top",tamanhoToolBar+4)
			    $("#divFormAtendimentoClinico").css("left",-10)
			    $("#divFormAtendimentoClinico").css("width",widthMenu)
			    if (typeof boxAtendimentoMenu!="undefined"){
			    	boxAtendimentoMenu.option("height",heightJanela-tamanhoToolBar -43)
			    }
			    //
			    $("#divFormAtendimentoClinicoSugestao").css("top",tamanhoToolBar+3)
			    $("#divFormAtendimentoClinicoSugestao").css("left",widthMenu-27)
			    $("#divFormAtendimentoClinicoSugestao").css("width",widthJanela-widthDadosGerais-widthMenu+51)
			    if (typeof atendimentoClinicoDeta!="undefined"){
			    	atendimentoClinicoDeta.option("height",heightJanela-tamanhoToolBar-altLinhaTempo-8)
			    }
			    //
				$("#pesquisaExamesPre").css("height",heightJanela-tamanhoToolBar-altLinhaTempo+18+"px")
				$("#atendimentoClinicoDeta").css("height",heightJanela-tamanhoToolBar-altLinhaTempo-19+"px")
		    }
		    if ($("#detalhesBlocoLeft").html()){
			    setTimeout(function () { 
			    	abrePainel(painelAtual,"")
			    },1000)
		    }
		}

        DevExpress.localization.locale("pt");
        
		loadPanel = $("#loadpanel").dxLoadPanel({
	        shadingColor: '#(corLoadPanel)#',
	        visible: true,
	        showIndicator: true,
	        showPane: true,
	        shading: true,
	        closeOnOutsideClick: false,
			onShown: function(){
				clearTimeout(tempoPanel)
	             tempoPanel = setTimeout(function () { 
	                 loadPanel.hide();          
	             }, 10000);
	         }	        
	    }).dxLoadPanel("instance");

		
		function autenticacaoBirdID(){
		    if ($("#openPesquisa").html()!=""){
		    	pesquisaExames.dispose()
		    	openPesquisa.dispose()
		    }
		    $("#openPesquisa").removeClass("Layout"+layout)
   			$("#openPesquisa").html("<div id='pesquisaExames'></div>")
			openPesquisa = $("#openPesquisa").dxPopup({
		        width: '450px',
		        height: '300px',
		        showTitle: true,
		        title: "Autenticar no BirdID?",
		        visible: true,
		        dragEnabled: true,
		        closeOnOutsideClick: false,
		        onHidden: function(){
			        if ($("#cdPaciente").val()==""){
			    		abrePesquisaPacientes()
			        }
			    },
				toolbarItems: [
				{
					location:"before",
					toolbar :"top",
				},{
					widget: "dxButton",
					location:"before",
					toolbar:"bottom",
					options: { 
						width	: "130px",
						type	: "default",
						icon	: "close",
            			text	: "Fechar", 
            			onClick : function(){
                			openPesquisaSub.hide()
                		}
					}
				},{
					widget: "dxButton",
					location:"after",
					toolbar:"bottom",
					options: { 
						width	: "130px",
						type	: "default",
						icon	: "check",
            			text	: "Autenticar", 
            			onClick : function(){
							if (!pesquisaExames.validate().isValid){
								DevExpress.ui.notify("Há campos inválidos", "warning", 4000);
								return
							}
							loadPanel.show();
					        $.getJSON(urlPreparacao,{
						        method	: "authBirdID",
						        username: pesquisaExames.option("formData")["Usuário"],
						        password: pesquisaExames.option("formData")["Código atual (OTP)"]
		    				},function(ret){
			    				loadPanel.hide();
			    				if (ret.status==1){
				    				openPesquisa.hide()
				    				DevExpress.ui.notify(ret.mensagem, "success", 4000);
				    				return
			    				}
			    				DevExpress.ui.notify(ret.mensagem, "warning", 4000);
			    			});
                		}
					}
				}]		        
			}).dxPopup("instance")
			
			pesquisaExames = $("#pesquisaExames").dxForm({
				screenByWidth: function(width) {
		            return "lg";
		        },
		        width:"100%",
		        colCount:10,
		        items: [{
			        template: "<img src='"+ygif+"/birdID.svg' width='100'></img>"
		        },{
			        colSpan:9,
			        template: "Para autorizar MAPPA a fazer uma assinatura utilizando o seu Bird ID, preencha os campos abaixo:<br><br>"
		        },{
			        colSpan:10,
			        dataField	: "Usuário",
			        editorOptions:{
			        	value	: '#(userBird)#',
			        },
					validationRules: [{
	                    type: "required"
	                }],				            
		        },{
			        colSpan:10,
			        dataField	: "Código atual (OTP)",
			        editorType	: "dxTextBox",
			        editorOptions	: {
				        mode	: "password"
			        },
					validationRules: [{
	                    type: "required"
	                }],				            
		        }]
			}).dxForm("instance")
			loadPanel.hide();
		}
		       
        $(document).ready(function () {
            prepareSearchInputs();
            if ("#(+opcoes)#"=="0"){
  				$("#divFormOpcoesGerais").hide()
            }
            resizeMe()
            if ("#(codPaciente)#"==""){
		        if ('#(token)#'==''){
			        autenticacaoBirdID()
		        }else{
			        abrePesquisaPacientes()
		        }
            }else{
           		carregarPaciente("#(codPaciente)#")
            }
        });
		window.onbeforeunload = function() {
	        $.getJSON(urlPreparacao,{
		        method	: "limpaTemporarias"
		    });
		};
        
		$(window).resize(function() {
		  resizeMe()
		});	       

		
    </script>
</body>

</html>