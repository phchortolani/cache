<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">
<script language="Cache" runat="server">
    do ^WWWVAR

	set YUSER = $get(%request.Data("YUSER", 1))
    set YBED = $get(%request.Data("YBED", 1))
    set YM = $get(%request.Data("YM", 1))
    set YLOCATION = $get(%request.Data("YLOCATION", 1))

    set PortCache = $get(%request.CgiEnvs("SERVER_PORT"))
    set PageURL = $get(%request.CgiEnvs("CACHE_URL"))
    set PageName = %request.PageName
    set app = %request.Application
    set host = %request.CgiEnvs("HTTP_HOST")
    set url = "http://"_host_app

    set URLPreparacao = "VAR.CSP.VARPatient.cls?YM="_YM_"&YBED="_YBED_"&YUSER="_YUSER_"&EP=1"
    set URLLogin = "COMLogin.cls"
    set URLLink = "www.cls"

    set nomeLocal = YLOCATION_" - "_$$SQLGetLocationName^VARSQL(YLOCATION)

    //Verifica se a sessão
    set status = $$VerifySession^VARCSPUtils(YBED, YUSER, url)
</script>

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Cadastro de Pacientes</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link href=" #(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" rel="stylesheet" type="text/css">

    <!-- Custom Elements -->
    <link href=" #(YGIF)#global/css/components-rounded.css" rel="stylesheet" id="style_components" type="text/css" />
    <link href=" #(YGIF)#global/css/plugins.css" rel="stylesheet" type="text/css" />
    <link href=" #(YGIF)#global/css/layout.css" rel="stylesheet" type="text/css" />
    <link href=" #(YGIF)#global/css/themes/light.css" rel="stylesheet" type="text/css" id="style_color" />
    <link href=" #(YGIF)#global/css/custom.min.css" rel="stylesheet" type="text/css" />

    <!-- Fonts Padrão IPP -->
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800">

    <!-- DevExtreme themes -->
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.common.css" />
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.light.css" />
    
    <link rel="stylesheet" type="text/css" href=" #(YGIF)#global/themes/css/alphalinc.css" id="style_color" />

    
    
    <!--<link rel="stylesheet" type="text/css" href=" #(YGIF)#global/plugins/extreme19.2.4/css/dx.light.compact.css" />-->

    <style>
    
.first-group,
.second-group {
    padding: 0px;
}

.form-avatar {
    height: 120px;
    width: 120px;
    margin-right: 10px;
    border: 1px solid #d2d3d5;
    border-radius: 50%;
    background-size: 100%;
    background-repeat: no-repeat;
    background-position: center;
}
.dx-fa-button-icon, .dx-fa-button-icon-close {
    text-align: center;
}
 
#app-container {
    height: 360px;
    width: 320px;
}
p {
    text-align: center;
}
</style>

</head>
    <script type="text/javascript">

        var status = '#(status)#';
        var URLLogin = '#(URLLogin)#';
        var ygif = '#(YGIF)#'

        if (status == 0) {
            alert('Usuário não está logado ou a sessão expirou.')
            window.location.replace(URLLogin)
        }

    </script>

<body>
    <div id="action-save"></div>
        <div class="col-md-12" style="margin-top:10px">
            <!-- Inicio do painel de filtros -->
            
			<div class="panel-group" id="accordion">
				<div class="panel panel-default">
					<div id="collapse1"  class="panel-collapse collapse in">
						<div class="panel-body">
							<div class="column">
								<div class="row">
									<div class="col-md-12">
										<div class="form-group">
											<div id="divForm"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="openPesquisa"></div>
		<div id="transcription" style="display:none;"></div>
    <!-- REQUIRED JS SCRIPTS -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src=" #(YGIF)#global/plugins/extreme19.2.4/js/jquery.min.js"></script>

	<!-- JSZip library -->
	<script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/jszip.min.js"></script>

    <!-- A DevExtreme library -->
    <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/dx.all.js"></script>
    
    <!-- DevExtreme-Intl module -->
    <script type="text/javascript" src=" #(YGIF)#global/plugins/extreme19.2.4/js/localization/dx.messages.pt.js"></script>
    
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src=" #(YGIF)#global/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>

    <!--Definições globais e criação de funcionalidades encapsuladas-->
    <script type="text/javascript">
        //Deixando variáveis disponíveis no cliente
        var urlPreparacao = '#(URLPreparacao)#';
        var urlLink = '#(URLLink)#';
        var YBED = '#(YBED)#';
        var YUSER = '#(YUSER)#';
        var YLOCATION = '#(YLOCATION)#';
        var nomeLocal = '#(nomeLocal)#';
		var tamanhoForm = 305
		var codPaciente = ""
		var gridAdmissoesAbertas = ""
		var gridHistorico = ""
		var histPassagem = ""
 
		var prepareSearchInputs = (function () {
			// Prepara o formulário
			dados = ""
			 $("#action-save").dxSpeedDialAction({
		        hint: "Salvar",
		        icon: "fas fa-save",
		        onClick: function() {
			        paciente = codPaciente.option("value")
			        if (!paciente) paciente=""
			        if (!formGeral.validate().isValid){
				        DevExpress.ui.notify("Favor preencher os campos obrigatórios","warning");
				        return
			        }
			        $.getJSON(urlPreparacao,{
	                    method		:"salvarDados",
	                    chave		: paciente,
	                    dados		: JSON.stringify(formGeral.option("formData"))
		            },function(retorno){
			            if (retorno.status==1){
				            carregaPacientes()
				            codPaciente.option("value",retorno.codigo)
			            	DevExpress.ui.notify("Dados Salvos com Sucesso!","success");
			            }else{
							DevExpress.ui.notify("Erro: "+retorno.status,"error");
				        }
		            })
		        }
		    });
		 
			formulario = $("#divForm").dxForm({
				activeStateEnabled:true,
		        formData: dados,
		        items: [{
		            itemType: "group",
		            cssClass: "first-group",
		            items: [{
	                    dataField	: "Paciente",
						editorOptions: {
	                        width: "80%"
	                    },            
	                    template	: function (data, itemElement) {
		                	itemElement.append("<div id='codPaciente'>")
	                    }
	                }]
		        },{
			        cssClass: "second-group",
					itemType: "tabbed",
	                name 	: "abas",
					tabPanelOptions: {
						deferRendering: false,
			   		},		
					tabs:[{
						title	: "Geral",
						items: [{
		                    template	: function (data, itemElement) {
			                	itemElement.append("<div id='geral'>")
                   		}}],
					},{
						title	: "Controle",
						items: [{
		                    template	: function (data, itemElement) {
			                	itemElement.append("<div id='controle'>")
                   		}}],
					}]
				}]
	        }).dxForm("instance")
	        
	        //
        });


        function carregaPacientes(){
	      	if (codPaciente){
		      	codPaciente.dispose()
	      	}			
			codPaciente = $("#codPaciente").dxSelectBox({
				dataSource: new DevExpress.data.DataSource({
		            store: new DevExpress.data.CustomStore({
	                byKey: function(args) {
	                    return $.getJSON(urlPreparacao,{
		                    method:"GetPacientes",
		                    codigo: args
		                });
	                },
		            load: function(args) {
		                    return $.getJSON(urlPreparacao,{
			                    method:"GetPacientes",
	                        	usuario: YBED,
	                        	skip:args.skip,
	                        	take:args.take,
	                        	searchValue:args.searchValue
			                });
		                }
		            })
		        }),
		        width:"95%",
		        valueExpr: "Codigo", 
				displayExpr: "Descricao",
				showClearButton: true,
				searchEnabled: true,
				placeholder		: "+",
				onValueChanged: function(e) {
					if (!e.value){
						formGeral.resetValues()
						formControle.resetValues()
						return
					}
					$.getJSON(urlPreparacao,{
				        method:"recPaciente",
				        codPaciente:e.value
				    },function(retorno){
						formGeral.option("formData", retorno.geral)
						formControle.option("formData", retorno.controle)
					})
				}
			}).dxSelectBox("instance")
	    }
		function carregaGeral(){
			formGeral = $("#geral").dxForm({
				activeStateEnabled:true,
		        formData: "",
				scrollingEnabled	: true,
		    	height	:function() {
					return window.innerHeight - 210;
				},
		        items: [{
		            itemType: "group",
		            cssClass: "first-group",
		            items: [{
				        itemType: "group",
	                    caption: "Paciente",
			            items: [{
			            	itemType: "group",
				            colCount: 4,
			            	items:[{
						            dataField	: "Nome",
						            colSpan		: 2,
									validationRules: [{
					                    type: "required"
					                }],				            
						            
						        },{
						            dataField: "Sexo",
	                                editorType: "dxSelectBox",
						            colSpan		: 2,
									validationRules: [{
					                    type: "required"
					                }],				            
									editorOptions: {
			            		        valueExpr: "Codigo", 
										displayExpr: "Descricao",
				                        items: [{"Codigo":"1","Descricao":"Masculino"},{"Codigo":"2","Descricao":"Feminino"}],
				                        value: ""
				                    }
						        },{
						            dataField	: "DataDeNascimento",
						            editorType	: "dxDateBox",
						            editorOptions: {
							            useMaskBehavior: true
						            },
									validationRules: [{
					                    type: "required"
					                }],				            
						            colSpan		: 2
						        },{
						            dataField	: "NãoInformada",
						            editorType	: "dxCheckBox",
						            colSpan		: 2
						        },{
						            dataField: "CPF",
						            colSpan		: 2
						        },{
						            dataField: "RG",
						            colSpan		: 2
						        },{
						            dataField: "CNS",
						            colSpan		: 2
						        },{
						            dataField: "Prontuário",
						            colSpan		: 1
						        },{
						            dataField	: "Óbito",
						            editorType	: "dxCheckBox",
						            colSpan		: 1
						        },{
						            dataField	: "Alergias",
						            editorType	: "dxTextArea",
						            colSpan		: 4
						        },{
						            dataField	: "MedicoResponsavel",
						            label:{
							            text: "Médico Responsável"
						            },						            
						            editorType	: "dxSelectBox",
						            colSpan		: 4,
									validationRules: [{
					                    type: "required"
					                }],							            
									editorOptions: {
			            		        valueExpr: "Codigo", 
										displayExpr: "Descricao",
										searchEnabled: true,
										dataSource: new DevExpress.data.DataSource({
								            store: new DevExpress.data.CustomStore({
							                byKey: function(args) {
							                    return $.getJSON(urlPreparacao,{
								                    method:"GetMedicos",
								                    codigo: args
								                });
							                },
								            load: function(args) {
								                    return $.getJSON(urlPreparacao,{
									                    method:"GetMedicos",
							                        	usuario: YBED,
							                        	skip:args.skip,
							                        	take:args.take,
							                        	searchValue:args.searchValue
									                });
								                }
								            })
								        }),
						            	value: ""
						            }
					            
						        }]
				        }]
	                },{
				        itemType: "group",
	                    caption: "Dados da Mãe do Paciente",
			            colCount: 3,
			            items: [{
				            dataField	: "NomeDaMãe",
				            colSpan		: 2,
				        },{
				            dataField	: "DataDeNasc",
				            editorType	: "dxDateBox",
				            editorOptions: {
					            useMaskBehavior: true
				            }
				        }]
				    },{
				        itemType: "group",
	                    caption: "Contato",
			            colCount: 3,
			            items: [{
				            dataField	: "Telefone1"
				        },{
				            dataField	: "Telefone2"
				        },{
				            dataField	: "PerdaDeContato",
				            editorType	: "dxCheckBox",
				        },{
				            dataField	: "Email",
				            colSpan		: 3
				            
				        }]
				    },{
				        itemType: "group",
	                    caption: "Endereço",
   			            colCount: 2,

			            items: [{
				            dataField	: "Logradouro"
				        },{
				            dataField	: "Número"
				        },{
				            dataField	: "Complemento"
				        },{
				            dataField	: "Bairro"
				        },{
				            dataField	: "CEP"
				        },{
				            dataField	: "Cidade"
				        },{
				            dataField	: "Estado",
							editorType	: "dxSelectBox",
				            editorOptions: {
	            		        valueExpr: "Codigo", 
								displayExpr: "Descricao",
								searchEnabled: true,
								dataSource: new DevExpress.data.DataSource({
						            store: new DevExpress.data.CustomStore({
					                byKey: function(args) {
					                    return $.getJSON(urlPreparacao,{
						                    method:"GetUFs",
						                    codigo: args
						                });
					                },
						            load: function(args) {
						                    return $.getJSON(urlPreparacao,{
							                    method:"GetUFs",
					                        	usuario: YBED,
					                        	skip:args.skip,
					                        	take:args.take,
					                        	searchValue:args.searchValue
							                });
						                }
						            })
						        }),
		                        value: ""
				            },				            
				        }]
				    }
	             ]
		        }]
			}).dxForm("instance")
		}

		function carregaControle(){
			formControle = $("#controle").dxForm({
				activeStateEnabled:true,
		        formData: "",
				scrollingEnabled	: true,
		    	height	:function() {
					return window.innerHeight - 210;
				},
		        items: [{
	            	itemType: "group",
	            	colCount: 2,
		           	items:[{
			            dataField	: "CriadoPor",
			            disabled	: true
			        },{
			            dataField	: "CriadoEm",
			            editorType	: "dxDateBox",
			            disabled	: true
			        },{
			            dataField	: "AlteradoPor",
			            disabled	: true
			        },{
			            dataField	: "AlteradoEm",
			            editorType	: "dxDateBox",
			            disabled	: true
			        }]
		        }]
			}).dxForm("instance")
		}
        DevExpress.localization.locale("pt");
		DevExpress.config({
	        floatingActionButtonConfig: {
	            icon: "fas fa-save",
	            position: {
	                my: "right top",
	                at: "right top",
	                of: "#action-add",
	                offset: "-25 +20"
	            }
	        }
	    })
        $(document).ready(function () {
            prepareSearchInputs();
            carregaGeral()
            carregaControle()
	        carregaPacientes()
	        codPaciente.option("value","+")

        });


    </script>
</body>
</html>
