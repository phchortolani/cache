<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INANGKOST" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INANGKOST(AUFTRAG,POSITION)
#include COMSYS
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		ANGEBOTSSELBSTKOSTEN
	;	DIESES PROGRAMM ERRECHNET DIE SELBSTKOSTEN EINER AUFTRAGSPOSITION AUS
	;	   PRODUKTION UND EK
	;	total production costs unit out of production & Planned Cost 
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 30-Aug-2006	GRF		SR12027: Identify INARTK fields; objINVORG; quits
	; 08-Aug-2005	GRF		SR13142 : use /3600
	; 24-Jun-2005	GRF		Fix argument validation - missing return value;
	; 						Add objINARTK
	; 05.10.2000	DT
	;-------------------------------------------------------------------------------
	new DAUER,EINHEIT,EINHEIT1,GEWICHT,KOST,KOST1,KOST2,KOST3,LIEF,MASCHINE,MENGE
	new objINARTK,objINVORG,PERSONEN,RUEST,RWERT,SELBSTKOST,SKOST,WG,YFELD,YKALK
	
	SET SELBSTKOST = 0  ;RUESTWERT
	SET RWERT      = 0  ;RÜSTWERT
	
	; These quit commands need to return a value ;<GRF>
	QUIT:$GET(AUFTRAG)="" SELBSTKOST
	QUIT:$GET(POSITION)="" SELBSTKOST
	
	set objINVORG = $get(^INVORG(YM,YM,1))          ; 30-Aug-2006
	
	SET YFELD=$GET(^INANGP(YM,AUFTRAG,POSITION,1))   ;ARTIKEL DATENSATZ ;item data record 
	IF YFELD="" QUIT SELBSTKOST
	
	SET EINHEIT=$PIECE(YFELD,Y,40)
	
	SET MENGE=+$PIECE(YFELD,Y,5)  ;MENGE WEGEN RÜSTZEIT ;quantity quibble setup time 
	IF MENGE=0 SET MENGE=1
	IF $DATA(^INANGPT(YM,AUFTRAG,POSITION)) {
		IF EINHEIT=2  SET MENGE=1                 ; Hours
		IF EINHEIT=10 SET MENGE=1                 ; Minutes
		IF EINHEIT=11 SET MENGE=1                 ; Industry Minutes
	}
	;SET EINHEIT1=""
	;IF EINHEIT'="" SET EINHEIT1=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,EINHEIT,1)),Y,1)
	;IF $FIND(EINHEIT1,"/") IF +$PIECE(EINHEIT1,"/",2)'=0 IF MENGE>1 SET MENGE=$JUSTIFY(MENGE/$PIECE(EINHEIT1,"/",2),0,0)  ;WENN Z.B. MENGENEINHEIT= /100 ;when e.g. 
	;IF '$FIND(EINHEIT1,"/") IF +$PIECE(YFELD,Y,138)'=0 IF MENGE>1 SET MENGE=$JUSTIFY(MENGE/$PIECE(YFELD,Y,138),0,0)  ;WENN Z.B. PEISEINHEIT JE 100  ;TYBD 15.09.2002 ;when e.g. once 
	
	;KALKULATIONSVORGABEN AUS BETRIEBSDATEI SUCHEN ;out of seek 
	SET BETR=$PIECE($GET(^INANG(YM,AUFTRAG,1)),Y,6)   ;BETRIEB
	IF BETR="" SET BETR=$GET(YLOCATION)
	IF $GET(BETR)="" SET BETR=$ORDER(^INKALK(YM,""))   ;VORGABE BETIEB ;default 
	
	;WARENGRUPPE SUCHEN ;Item group
	SET WG=$PIECE(YFELD,Y,30)
	IF WG="" SET WG=$$$INVORGDefaultItemGroup(objINVORG)
	IF WG'="" IF '$DATA(^INKALK(YM,BETR,WG)) SET WG=$$$INVORGDefaultItemGroup(objINVORG)   ;DFLT WARENGRUPPE = 1.
	
	SET YKALK=""
	IF BETR'="" IF WG'="" SET YKALK=$GET(^INKALK(YM,BETR,WG,1))  ;KALKULATION AUS WG ;cost estimating out of IG 
	
	IF BETR'="" IF $PIECE(YFELD,Y,4)'="" IF $DATA(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4))) DO  ;ULM, 26.06.02
	. SET YKALK=$GET(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4),1))  ;KALKULATION AUS ARTIKEL ;cost estimating out of item 
	
	SET PERSONEN=+$PIECE(YFELD,Y,49)  ;ANZAHL DER PERSONEN DIE PRODUZIEREN ;Number the who produce 
	IF PERSONEN=0 SET PERSONEN=1
	
	SET KOST  = 0
	SET KOST1 = 0
	SET KOST2 = 0
	SET KOST3 = 0
	
	SET RUEST   = $PIECE(YFELD,Y,70)
	SET RUEST   = $$^INARTRUEST($PIECE(YFELD,Y,4))
	SET GEWICHT = $PIECE(YFELD,Y,43)
	SET DAUER   = $PIECE(YFELD,Y,45)
	SET ARTIKEL = $PIECE(YFELD,Y,4)
	
	IF '$DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  ;ERRECHNEN SELBSTKOSTEN ;total production costs 
	. NEW YI,TEIL,EK,ZEIT,WERT,POSITION1
	. ;KALKULIEREN DER ZEITEN UND DES MASCHINENEINSATZES ;calculate the And 
	. ;
	. SET MASCHINE=$PIECE(YFELD,Y,57)
	. IF MASCHINE'="" DO
	. . SET WERT=$PIECE($GET(^INMASCH(YM,MASCHINE,1)),Y,2)/3600  ;WERT IN SEKUNDE ;value within second 
	. . SET ZEIT=$PIECE(YFELD,Y,45)  ;FERTIGUNGSZEIT
	. . SET KOST=KOST+($JUSTIFY(WERT*ZEIT,0,2)*MENGE*PERSONEN)  ;SEKUNDENKOSTEN*SEKUNDENDAUER*MENGE
	. ;
	. IF MASCHINE="" DO
	. . SET WERT=$PIECE(YKALK,Y,1)/3600
	. . SET ZEIT=$PIECE(YFELD,Y,45)  ;FERTIGUNGSZEIT
	. . SET KOST=KOST+($JUSTIFY(WERT*ZEIT,0,2)*MENGE*PERSONEN)  ;SEKUNDENKOSTEN*SEKUNDENDAUER*MENGE
	/*
	. ; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	. ;IF $PIECE(YFELD,Y,70)'="" DO  ;RÜSTZEIT       
	. ;. SET WERT=$PIECE(YKALK,Y,1)/3600
	. ;. SET KOST=KOST+(WERT*$PIECE(YFELD,Y,70)*PERSONEN)
	. ;IF $PIECE(YFELD,Y,73)'="" DO  ;RUHEZEIT
	. ;. SET WERT=$PIECE(YKALK,Y,1)/3600
	. ;. SET KOST=KOST+(WERT*$PIECE(YFELD,Y,73)*MENGE*PERSONEN)
	. ;IF $PIECE(YFELD,Y,74)'="" DO  ;WERKZEUGKOSTEN
	. ;. SET WERT=$PIECE(YFELD,Y,74)
	. ;. SET KOST=KOST+(WERT*MENGE)
	. ;IF $PIECE(YFELD,Y,75)'="" DO  ;EXTRAKOSTEN
	. ;. SET WERT=$PIECE(YFELD,Y,75)
	. ;. SET KOST=KOST+(WERT*MENGE)
	. ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END  */
	
	;I +KOST=0 SET KOST=$PIECE(YFELD,Y,47)   ;NORMALE KOSTEN
	IF +KOST=0 IF $PIECE(YFELD,Y,4)'="" SET KOST=$$^INARTKOST($PIECE(YFELD,Y,4))-$PIECE($GET(^INART(YM,$PIECE(YFELD,Y,4),1)),Y,74)-$PIECE($GET(^INART(YM,$PIECE(YFELD,Y,4),1)),Y,75)*(MENGE/$$^INQTYUNIT($PIECE(YFELD,Y,4)))  ;AUS ARTIKELDATEN ;out of 
	
	SET KOST1=0  ;SELBSTKOSTEN AUS BESTELLUNG ;total production costs out of sales order 
	
	IF '$DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  IF KOST1'=9999999999 SET KOST1=KOST1*MENGE/$$^INQTYUNIT($PIECE(YFELD,Y,4)) SET KOST2=KOST2*MENGE/$$^INQTYUNIT($PIECE(YFELD,Y,4))   ;SONDER EK DES LIEFERANTEN ;Planned Cost 
	. NEW BIS,EK,OHNESKTO,ARTIKEL
	. SET OHNESKTO=+$$$INVORGManufacturingCostWithoutD(objINVORG)   ;OHNE SKONTO ;without discount payment
	. SET ARTIKEL=$PIECE(YFELD,Y,4)
	. SET LIEF(1)=""   ;BESTER LIEFERANT ;supplier 
	. SET KOST1=9999999999
	. QUIT:ARTIKEL=""
	. SET ARTIKEL1=$GET(^INART(YM,ARTIKEL,1))
	. ;
	. ;NIEDRIGSTEM KOSTEN ;taste 
	. SET LIEF=""
	. FOR  SET LIEF=$ORDER(^INARTK(YM,ARTIKEL,LIEF)) QUIT:LIEF=""  DO
	. . set objINARTK = $GET(^INARTK(YM,ARTIKEL,LIEF,1))
	. . SET BIS   = $$$INARTKPriceValidUntil(objINARTK) IF BIS'="" IF BIS<$HOROLOG QUIT  ;NICHT MEHR GÜLTIG ;Not more valuable 
	. . SET EK(1) = $$$INARTKNetPurchasePrice(objINARTK)
	. . IF OHNESKTO=$$$YES SET EK(1)=$JUSTIFY(EK(1)*100/(100-$$$INARTKDealersDiscount(objINARTK)),0,2)   ;OHNE SKONTO
	. . IF +$$$INARTKConversionFactor(objINARTK)'=0 SET EK(1)=EK(1)*$$$INARTKConversionFactor(objINARTK)
	. . IF +EK(1)'=0 IF EK(1)<KOST1 SET KOST1=EK(1) SET LIEF(1)=LIEF
	. ;
	. IF KOST1=9999999999 SET LIEF="" FOR  SET LIEF=$ORDER(^INARTK(YM,ARTIKEL,LIEF)) QUIT:LIEF=""  DO
	. . set objINARTK = $GET(^INARTK(YM,ARTIKEL,LIEF,1))
	. . SET EK(1) = $$$INARTKNetPurchasePrice(objINARTK)
	. . IF OHNESKTO=$$$YES SET EK(1)=$JUSTIFY(EK(1)*100/(100-$$$INARTKDealersDiscount(objINARTK)),0,2)   ;OHNE SKONTO
	. . IF +$$$INARTKConversionFactor(objINARTK)'=0 SET EK(1)=EK(1)*$$$INARTKConversionFactor(objINARTK)
	. . IF +EK(1)'=0 IF EK(1)<KOST1 SET KOST1=EK(1) SET LIEF(1)=LIEF
	. ;
	. IF KOST1=9999999999 SET KOST1=0  ;KEINEN GEFUNDEN
	. ;HÖCHSTEN KOSTEN ;taste 
	. SET KOST2=0
	. SET LIEF=""
	. FOR  SET LIEF=$ORDER(^INARTK(YM,ARTIKEL,LIEF)) QUIT:LIEF=""  DO
	. . set objINARTK = $GET(^INARTK(YM,ARTIKEL,LIEF,1))
	. . SET BIS   = $$$INARTKPriceValidUntil(objINARTK) IF BIS'="" IF BIS<$HOROLOG QUIT  ;NICHT MEHR GÜLTIG ;Not more valuable 
	. . SET EK(1) = $$$INARTKNetPurchasePrice(objINARTK)
	. . IF OHNESKTO=$$$YES SET EK(1)=$JUSTIFY(EK(1)*100/(100-$$$INARTKDealersDiscount(objINARTK)),0,2)   ;OHNE SKONTO
	. . IF +$$$INARTKConversionFactor(objINARTK)'=0 SET EK(1)=EK(1)*$$$INARTKConversionFactor(objINARTK)
	. . IF +EK(1)'=0 IF EK(1)>KOST2 SET KOST2=EK(1) SET LIEF(2)=LIEF
	. ;
	. IF KOST2=0 SET LIEF="" FOR  SET LIEF=$ORDER(^INARTK(YM,ARTIKEL,LIEF)) QUIT:LIEF=""  DO
	. . set objINARTK = $GET(^INARTK(YM,ARTIKEL,LIEF,1))
	. . SET EK(1) = $$$INARTKNetPurchasePrice(objINARTK)
	. . IF OHNESKTO=$$$YES SET EK(1)=$JUSTIFY(EK(1)*100/(100-$$$INARTKDealersDiscount(objINARTK)),0,2)   ;OHNE SKONTO
	. . IF +$$$INARTKConversionFactor(objINARTK)'=0 SET EK(1)=EK(1)*$$$INARTKConversionFactor(objINARTK)
	. . IF +EK(1)'=0 IF EK(1)<KOST2 SET KOST1=EK(1) SET LIEF(2)=LIEF
	
	IF '$DATA(^INANGPT(YM,AUFTRAG,POSITION)) IF $DATA(^INANGPK(YM,AUFTRAG,POSITION,1)) DO    ;EK DES LIEFERANTEN AUS ARTIKELANLAGE ;Planned Cost
	. SET KOST1=9999999999
	. DO
	. . SET EK(1)=$PIECE($GET(^INANGPK(YM,AUFTRAG,POSITION,1)),Y,13)
	. . IF +EK(1)'=0 SET KOST1=EK(1)*MENGE/$$^INQTYUNIT($PIECE(YFELD,Y,4))
	. ;
	. IF KOST1=9999999999 SET KOST1=0  ;KEINEN GEFUNDEN
	
	SET SKOST=+$$$INVORGDefaultCostType(objINVORG)
	IF SKOST=0 SET SKOST=1
	
	IF '$DATA(^INANGPT(YM,AUFTRAG,POSITION)) IF SKOST=5 IF ARTIKEL'="" DO  ;EK AUS LAGERBESTAND WENN KEINE TEILE ;Planned Cost 
	. NEW BET,LAP,WED,WEN
	. SET BET=""
	. FOR  SET BET=$ORDER(^INWE(YM,ARTIKEL,BET)) QUIT:BET=""  DO     ;BETRIEB
	. . SET LAP=""
	. . FOR  SET LAP=$ORDER(^INWE(YM,ARTIKEL,BET,LAP)) QUIT:LAP=""  DO     ;LAGERPLATZ ;stock locn 
	. . . SET WED=""
	. . . FOR  SET WED=$ORDER(^INWE(YM,ARTIKEL,BET,LAP,WED)) QUIT:WED=""  DO    ;WEDATUM
	. . . . SET WEN=$GET(^INWE(YM,ARTIKEL,BET,LAP,WED,1))
	. . . . IF $PIECE(WEN,Y,8)>KOST3 SET KOST3=$PIECE(WEN,Y,8)
	. ;
	. SET KOST3=KOST3*MENGE/$$^INQTYUNIT($PIECE(YFELD,Y,4))
	. IF KOST3>KOST2 SET KOST2=KOST3  ;WENN WARE TEUER, DANN ÜBERTRAGEN
	
	DO
	. IF +KOST'=0 IF +KOST1=0                                QUIT  ;NUR EIGENFERTIGUNG VORHANDEN ;only on hand 
	. IF SKOST=1                              SET KOST=KOST1 QUIT  ;WERT NACH BESTELLWARE HIER IST NIEDRIGSTEM WERT VON LIEF
	. IF SKOST=2 IF +KOST=0 IF +KOST1'=0      SET KOST=KOST1 QUIT  ;WERT NACH EIGENFERTIGUNG, ABER NUR BESTELLWARE VORHANDEN
	. IF SKOST=2                                             QUIT  ;WERT NACH EIGENFERTIGUNG
	. IF SKOST=3 IF KOST>KOST1                SET KOST=KOST1 QUIT  ;NACH NIEDRIGSTEM WERT
	. IF (SKOST=4) || (SKOST=5) IF KOST<KOST2 SET KOST=KOST2 QUIT  ;NACH HÖCHSTEM WERT SET LIEF(1)=LIEF(2)
	; BEIDE GLEICH ;both without delay 
	
	
	IF $DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  ;ERRECHNEN SELBSTKOSTEN ;total production costs 
	. NEW YI,TEIL,EK,ZEIT,WERT,POSITION1,TEILT
	. SET KOST=0,RUEST=0,DAUER=0,GEWICHT=0  ;ERRECHNEN AUS TEILE ;out of 
	. ;SELBSTKOSTEN DER TEILE ;total production costs the 
	. SET TEIL=""
	. FOR  SET TEIL=$ORDER(^INANGPT(YM,AUFTRAG,POSITION,TEIL)) QUIT:TEIL=""  IF $PIECE(TEIL,".",2)="" DO
	. . SET POSITION1=$GET(^INANGPT(YM,AUFTRAG,POSITION,TEIL,1))  ;ARTIKELTEILEINFO
	. . SET KOST=KOST+($PIECE(POSITION1,Y,47)*MENGE)              ;WERT DES TEILS ;value of parts
	. . ;
	. . SET RUEST=RUEST+$PIECE(POSITION1,Y,70)              ;RUESTZEIT
	. . SET GEWICHT=GEWICHT+($PIECE(POSITION1,Y,43)*MENGE)  ;GEWICHT ;wt. 
	. . SET DAUER=DAUER+($PIECE(POSITION1,Y,45)*MENGE)      ;DAUER ;duration 
	
	DO  ;ZUSATZKOSTEN ;additional costs 
	. IF $PIECE(YFELD,Y,74)'="" DO  ;WERKZEUGKOSTEN
	. . SET WERT=$PIECE(YFELD,Y,74)
	. . ;SET KOST=KOST+(WERT*MENGE) 
	. . SET KOST=KOST+WERT
	. ;
	. IF $PIECE(YFELD,Y,75)'="" DO  ;EXTRAKOSTEN
	. . SET WERT=$PIECE(YFELD,Y,75)
	. . ;SET KOST=KOST+(WERT*MENGE) 
	. . SET KOST=KOST+WERT
	
	DO  ;RUESTZEITEN
	. SET RUEST=RUEST*$$^INPROLOS($PIECE(YFELD,Y,4),MENGE)
	. IF +RUEST'=0 SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,70)=RUEST
	. SET RWERT=0
	. DO
	. . NEW WG,BETR,STDWERT
	. . SET BETR=$GET(YLOCATION)
	. . IF BETR="" SET BETR=$ORDER(^INKALK(YM,""))
	. . IF BETR="" SET BETR=$ORDER(^WWW0121(0,YM,""))
	. . IF BETR="" SET BETR=1
	. . SET WG=$$$INVORGDefaultItemGroup(objINVORG)
	. . IF WG="" SET WG=$ORDER(^INKALK(YM,BETR,""))
	. . IF WG="" SET WG=0
	. . SET STDWERT=$PIECE($GET(^INKALK(YM,BETR,WG,1)),Y,1)/3600
	. . IF $PIECE(YFELD,Y,4)'="" IF $DATA(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4))) DO
	. . . SET STDWERT=$PIECE($GET(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4),1)),Y,1)/3600
	. . SET RWERT=$JUSTIFY(RUEST*STDWERT,0,2)
	. ;
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,71)=RWERT
	. SET $PIECE(YFELD,Y,71)=RWERT
	
	SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,45)=DAUER  ;DAUER DES ARTIKELS ;permanence 
	;SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,43)=GEWICHT  ;GEWICHT DES ARTIKELS
	IF $PIECE(YFELD,Y,4)'="" IF $PIECE($GET(^INART(YM,$PIECE(YFELD,Y,4),1)),Y,255)'=1 SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,43)=GEWICHT  ;GEWICHT DES ARTIKELS ;wt. 
	
	IF EINHEIT=10 IF $DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  ;MINUTEN 
	. IF +DAUER=0 QUIT
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,5)=DAUER\60
	
	IF EINHEIT=11 IF $DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  ;INDUSTRIE MINUTEN  ;industry minute
	. IF +DAUER=0 QUIT
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,5)=DAUER\100
	
	IF EINHEIT=2 IF $DATA(^INANGPT(YM,AUFTRAG,POSITION)) DO  ;STUNDEN ;hours
	. IF +DAUER=0 QUIT
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,5)=DAUER\3600
	
	SET SELBSTKOST=$JUSTIFY(SELBSTKOST+KOST,0,2)  ;SELBSTKOSTEN ;total production costs  ;total production costs whole 
	
	DO KALK   ;NEU NACHRECHNEN NICHT
	;--> AUSGESCHALTET AM 14.09.04;FIS;26184;VK NICHT NEU RECHNEN
	;     (HAT OFFENBAR NIE FUNKTIONIERT, DENN ES WURDE NUR GERECHNET, WENN VK=0. DANN IST ABER DER AUFSCHLAG -100
	;     UND DER VK WIRD WIEDER MIT 0 BERECHNET, ALSO KEINE ÄNDERUNG)
	;--> WIEDER EINGESCHALTET AM 04.02.05;FIS;27283;VK NEU RECHNEN
	;     (WENN DER AUFSCHLAG FIX IST, DANN SOLL DER VK NEU ERRECHNET WERDEN)
	
	QUIT SELBSTKOST
	
KALK
	;-------------------------------------------------------------------------------
	; NEURECHNEN DER KAA UND ODER PREISE ;  -> AUCH EINSPRUNG AUS INAUFPD120 !!!
	; RE-CALCULATE THE KAA AND OR PRICES; - > ALSO RE-ENTRY POINT FROM INAUFPD120!!! 
	; 
	; Params:
	;
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 07-Dec-2006	JW		SR15274: Added price plan check.
	;-------------------------------------------------------------------------------
	NEW BETR,EK,objINVORG,VK,WG,YKALK
	
	set objINVORG = $get(^INVORG(YM,YM,1))          ; 30-Aug-2006
	
	;KALKULATIONSVORGABEN AUS BETRIEBSDATEI SUCHEN ;out of seek 
	SET BETR=$GET(YLOCATION)
	IF BETR="" SET BETR=$ORDER(^INKALK(YM,""))
	IF BETR="" SET BETR=1
	
	;WARENGRUPPE SUCHEN ;item group 
	SET WG=$PIECE(YFELD,Y,30)
	IF WG="" SET WG=$$$INVORGDefaultItemGroup(objINVORG)
	IF WG="" SET WG=$ORDER(^INKALK(YM,BETR,""))
	SET $PIECE(YFELD,Y,30)=WG  ;SETZEN STANDARDWARENGRUPPE IN AUFTRAG ;set item group within order 
	
	IF WG'="" IF '$DATA(^INKALK(YM,BETR,WG)) SET WG=$$$INVORGDefaultItemGroup(objINVORG)   ;DFLT WARENGRUPPE = 1.
	
	SET YKALK=""
	
	IF BETR'="" IF WG'="" SET YKALK=$GET(^INKALK(YM,BETR,WG,1))
	IF BETR'="" IF $PIECE(YFELD,Y,4)'="" IF $DATA(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4))) DO
	. SET YKALK=$GET(^INKALKART(YM,BETR,$PIECE(YFELD,Y,4),1))
	
	NEW PRICE,PKZ,KUNDE,DAT
	
	SET PKZ   = $PIECE(YFELD,Y,120)
	SET KUNDE = $PIECE($GET(^INANG(YM,AUFTRAG,1)),Y,1)
	SET DAT   = $PIECE($GET(^INANG(YM,AUFTRAG,1)),Y,4)
	IF $GET(MENGE)="" SET MENGE=$PIECE(YFELD,Y,5)
	IF $GET(SELBSTKOST)="" SET SELBSTKOST=$PIECE(YFELD,Y,47)  ;HK
	SET PRICE=$$^INSALESPRICE($PIECE(YFELD,Y,4),MENGE,$GET(BETR),PKZ,KUNDE,DAT,,,1)    ;BEC;26184;16.08.04;PRICE AUS INSALESPRICE
	
	//IF YKALK'="" DO  ;VORGABEN ÜBERTRAGEN		SR15274
	if '$$$INVORGPricePlan(objINVORG) IF YKALK'="" DO
	. NEW PRKZ,ARTIKEL1
	. QUIT:$PIECE(YFELD,Y,199)=1  ;KEINE NEUBERECHNUNG
	. ;
	. IF $PIECE(PRICE,Y,3)=1 DO  QUIT        ;BEC;26184;16.08.04;WENN BETRIEBSABHÄNIGER PREIS
	. . SET PRKZ=$PIECE(PRICE,Y,4)
	. . SET $PIECE(YFELD,Y,116)=""  ;AUFSCHLAG
	. . SET $PIECE(YFELD,Y,118)=$PIECE(PRICE,Y,1)  ;EINZELPREIS
	. . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)
	. ;
	. SET $PIECE(YFELD,Y,118)=$PIECE(PRICE,Y,1)  ;DFLT EINZELPREIS;FIS;04.02.05;27283
	. IF $PIECE(YFELD,Y,120)=$PIECE(YKALK,Y,16) QUIT:$PIECE(YKALK,Y,34)'=1  ;PKZ 1 NICHT FIX ;FIS;04.02.05;27283
	. IF $PIECE(YFELD,Y,120)=$PIECE(YKALK,Y,17) QUIT:$PIECE(YKALK,Y,35)'=1  ;PKZ 2 NICHT FIX ;FIS;04.02.05;27283
	. IF $PIECE(YFELD,Y,120)=$PIECE(YKALK,Y,18) QUIT:$PIECE(YKALK,Y,36)'=1  ;PKZ 3 NICHT FIX ;FIS;04.02.05;27283
	. IF $PIECE(YFELD,Y,120)=$PIECE(YKALK,Y,19) QUIT:$PIECE(YKALK,Y,37)'=1  ;PKZ 4 NICHT FIX ;FIS;04.02.05;27283
	. ;
	. IF $PIECE(YKALK,Y,25)=1 DO  ;IMMER NEU BERECHNEN! 1.PREIS ;constantly recent 
	. . SET PRKZ=$PIECE(YFELD,Y,120)
	. . IF PRKZ="" DO  QUIT  ;KEIN PKZ
	. . . SET $PIECE(YFELD,Y,116)=$PIECE(YKALK,Y,11)  ;AUFSCHLAG
	. . . SET $PIECE(YFELD,Y,118)=""  ;EINZELPREIS
	. . . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . ;
	. . IF $PIECE(YKALK,Y,16)=PRKZ DO  ;PKZ 1
	. . . SET $PIECE(YFELD,Y,116)=$PIECE(YKALK,Y,11)  ;AUFSCHLAG
	. . . SET $PIECE(YFELD,Y,118)=""  ;EINZELPREIS
	. . . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)
	. ;
	. IF $PIECE(YKALK,Y,26)=1 DO  ;IMMER NEU BERECHNEN! 2.PREIS ;constantly recent 
	. . SET PRKZ=$PIECE(YFELD,Y,120)
	. . IF $PIECE(YKALK,Y,17)=PRKZ DO  ;PKZ 2
	. . . SET $PIECE(YFELD,Y,116)=$PIECE(YKALK,Y,12)  ;AUFSCHLAG
	. . . SET $PIECE(YFELD,Y,118)=""  ;EINZELPREIS
	. . . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)
	. ;
	. IF $PIECE(YKALK,Y,27)=1 DO  ;IMMER NEU BERECHNEN! 3.PREIS ;constantly recent 
	. . SET PRKZ=$PIECE(YFELD,Y,120)
	. . IF $PIECE(YKALK,Y,18)=PRKZ DO  ;PKZ 3
	. . . SET $PIECE(YFELD,Y,116)=$PIECE(YKALK,Y,13)  ;AUFSCHLAG
	. . . SET $PIECE(YFELD,Y,118)=""  ;EINZELPREIS
	. . . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)
	. ;
	. IF $PIECE(YKALK,Y,28)=1 DO  ;IMMER NEU BERECHNEN! 4.PREIS ;constantly recent 
	. . SET PRKZ=$PIECE(YFELD,Y,120)
	. . IF $PIECE(YKALK,Y,19)=PRKZ DO  ;PKZ 4
	. . . SET $PIECE(YFELD,Y,116)=$PIECE(YKALK,Y,14)  ;AUFSCHLAG
	. . . SET $PIECE(YFELD,Y,118)=""  ;EINZELPREIS
	. . . SET $PIECE(YFELD,Y,119)=""  ;GESAMT-VK (WIRD SPÄTER BERECHNET)
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)
	
	;PREISE UND AUFSCHLAG ;And overcharge 
	IF $PIECE(PRICE,Y,3)'=1 DO  ;NUR WENN KEIN BETRIEBSABHÄNIGER PREIS;BEC;26184;16.04.04
	. NEW AUFSCHLAG,VK
	. IF +$PIECE(YFELD,Y,116)=0 IF +$PIECE(YFELD,Y,119)=0 QUIT   ;KEIN AUFSCHLAG UND KEIN VK ;no overcharge And no Sale 
	. IF +$PIECE(YFELD,Y,119)=0 IF +$PIECE(YFELD,Y,116)'=0 DO   ;AUFSCHLAG UND KEIN VK ;overcharge And no Sale 
	. . SET AUFSCHLAG=$PIECE(YFELD,Y,116)     ;AUFSCHLAG ;overcharge 
	. . SET EK=SELBSTKOST+$PIECE(YFELD,Y,71)  ;FINDEN ARTIKEL-EK AUS HERSTELLUNGSKOSTEN + RUESTKOSTEN ;find out of manufacturing cost 
	. . SET VK=0
	. . IF +EK'=0 DO
	. . . SET VK=$JUSTIFY(EK*((100+AUFSCHLAG)/100),0,2)
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,119)=VK  ;GESAMTPREIS
	. . . SET $PIECE(YFELD,Y,119)=VK  ;GESAMTPREIS
	. . IF +MENGE'=0 DO
	. . . SET VK=$JUSTIFY($PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,119)/MENGE*$$^INQTYUNIT(,AUFTRAG,POSITION),0,2)
	. . . SET RUNDUNG=+$$$INVORGRoundUpOfPrice(objINVORG)
	. . . IF RUNDUNG'=0 DO
	. . . . SET VK=$JUSTIFY(VK,0,0)
	. . . . IF RUNDUNG=2 IF VK>10   SET VK=$JUSTIFY(VK/10,0,0)*10     QUIT
	. . . . IF RUNDUNG=4 IF VK>100  SET VK=$JUSTIFY(VK/100,0,0)*100   QUIT
	. . . . IF RUNDUNG=5 IF VK>1000 SET VK=$JUSTIFY(VK/1000,0,0)*1000 QUIT
	. . . ;
	. . . IF +VK'=0 DO
	. . . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,118)=VK  ;tybd 13.06.2002 nur wenn vk'=0 ;solely when 
	. . . . SET $PIECE(YFELD,Y,118)=VK  ;EINZEL-VK
	. . . ;
	. . . SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,119)=VK*MENGE  ;GESAMTPREIS
	. . . SET $PIECE(YFELD,Y,119)=VK  ;GESAMTPREIS
	
	IF +$PIECE(YFELD,Y,118)'=0 DO   ;AUFSCHLAG NACHRECHNEN ;overcharge 
	. QUIT:$PIECE(YFELD,Y,199)=1  ;KEINE NEUBERECHNUNG;TYBD;29,7,2004;26172;PREIS NICHT MEHR NEU RECHNEN
	. DO EH^INBRUTTONETTO                  ; Updates YFELD ByRef
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,116)=$PIECE(YFELD,Y,116)  ;AUFSCHLAG ;overcharge 
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,118)=$PIECE(YFELD,Y,118)  ;VK
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,119)=$PIECE(YFELD,Y,119)  ;VK TOTAL
	. SET $PIECE(^INANGP(YM,AUFTRAG,POSITION,1),Y,123)=$PIECE(YFELD,Y,123)  ;VK NETTO
	
	QUIT
	
]]></Routine>
</Export>