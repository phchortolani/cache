<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INFIBBUCH1" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INFIBBUCH1(BUCHUNG,YFPARA,BUCHART,KEY)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BUCHEN IN ABACUS FIBU
	;	VORGABE=BUCHUNG
	;	S BUCHUNG=^INFIBBUCH(YM,BTR,DAT,VOR,1)
	;	S BUCHUNG=";DATUM $H;BETRAG;SOLL;HABEN;STEUER;BELEGNR.;TEXT"
	;
	; Inputs : 
	;	BUCHART ""=ALLE (S+H) 1=SOLL 1. 2=SOLL FOLGE 3=HABEN 1. 4=HABEN FOLGE 
	;	KEY=VORDATEI
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 05-Feb-2007	GRF		SR15424: Naked References - use of KOND; doco; quits
	; 15.07.2000	DT
	;-------------------------------------------------------------------------------
	NEW YRETURN,MAN,UCI,DATUM,BUCH,IDNR,LIEF,KUND,KOND,BTR,ZAEHL,SPRACHE
	
	SET SPRACHE="DE"
	SET BUCHART=$GET(BUCHART)
	SET KEY=$GET(KEY)
	SET YRETURN=""
	SET MAN=0 
	IF $PIECE(YFPARA,Y,2)'="" SET MAN=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAN="" YRETURN
	
	IF $PIECE(YFPARA,Y,3)'="" SET BTR=$PIECE(YFPARA,Y,3)  ;BETRIEB IN FIBU ;location within 
	IF $GET(BTR)="" SET BTR=1
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	IF '$DATA(^|UCI|FABUDAT(MAN)) SET ^|UCI|FABUDAT(MAN)=""
	set SPRACHE="DE"
	SET DATUM=$$^WWWDATE($PIECE(BUCHUNG,Y,2))
	SET BUCH=$EXTRACT(DATUM,7,10)_$EXTRACT(DATUM,4,5)     ;BUCHUNGSZEITRAUM JJJJMM
	SET DATUM=BUCH_$EXTRACT(DATUM,1,2)                    ;BUCHUNGSDATUM
	QUIT:BUCH="" YRETURN                                  ;KEIN BUCHUNGSZEITRAUM ;no 
	
	SET ZAEHL=$$^WWWNEXT("FABUDAT")  ;WENN KEIN PARAMETER ;when no parameter 
	IF KEY="" SET KEY="ABCDEF."_$JOB_"."_$TRANSLATE($HOROLOG,",",".")  ;WENN KEIN PARAMETER ;when no parameter 
	;SOLL BUCHUNG
	SET KONTOS=$PIECE(BUCHUNG,Y,4)  ;KONTO SOLL ;acct. 
	QUIT:KONTOS="" YRETURN          ;KEIN SOLL ;no 
	QUIT:$PIECE(BUCHUNG,Y,5)="" YRETURN     ;KEIN HABEN ;no have got 
	IF +$PIECE(BUCHUNG,Y,3)=0 QUIT YRETURN  ;BETRAG=NULL
	
	SET $PIECE(BUCHUNG,Y,3)=$JUSTIFY($PIECE(BUCHUNG,Y,3),0,2)  ;BETRAG ;Sum 
	LOCK +^|UCI|FABUDAT:120
	SET LIEF=$PIECE(BUCHUNG,Y,4)
	SET KUND=$PIECE(BUCHUNG,Y,4)
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)  ;STEUERID     ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID     ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;SKONTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" DO
	. . SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. ;
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))     ; SR15424
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE     ; SR15424
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))     ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))     ; SR15424
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'=""  SET KONTOA=7
	SET SACH=""
	IF $LENGTH($PIECE(BUCHUNG,Y,4))>5 SET SACH="S"
	IF (BUCHART="")!(BUCHART=1) SET SATZ(1)=Y_YBED_Y_1_Y_0_Y_Y_Y_Y_Y
	IF BUCHART=2 SET SATZ(1)=Y_YBED_Y_Y_0_Y_Y_Y_Y_Y
	SET SATZ(2)=Y_Y
	SET:$PIECE(BUCHUNG,Y,7)="" $PIECE(BUCHUNG,Y,7)=12345 ;SONST FEHLER ;otherwise shortcoming 
	SET $PIECE(SATZ(2),Y,6)=$PIECE(BUCHUNG,Y,13)
	SET $PIECE(SATZ(2),Y,7)=$JUSTIFY($PIECE(BUCHUNG,Y,14),0,2)
	SET $PIECE(SATZ(2),Y,8)=$PIECE(BUCHUNG,Y,15)
	SET $PIECE(SATZ(2),Y,12)=$PIECE(BUCHUNG,Y,23)                ;BELEGNUMMER DES KREDITOR
	SET $PIECE(SATZ(2),Y,13)=$PIECE(BUCHUNG,Y,24)                ;ZAHLUNGSART
	IF $PIECE(SATZ(2),Y,13)="" SET $PIECE(SATZ(2),Y,13)=5        ;ZAHLUNGSART
	SET $PIECE(SATZ(1),Y,5)=DATUM                                ;DATUM ;Date
	SET $PIECE(SATZ(1),Y,7)=$JUSTIFY($PIECE(BUCHUNG,Y,3),0,2)    ;BETRAG ;Sum 
	SET $PIECE(SATZ(1),Y,9)=$GET(KONTOA)_$GET(BTR)_$GET(KONTOS)  ;KONTO ;acct. 
	IF $PIECE(YFPARA,Y,8)=1 DO                                   ;KOSTENSTELLE ;cost centre 
	. IF KONTOA=1 SET $PIECE(SATZ(1),Y,10)=$PIECE(BUCHUNG,Y,12)  ;KOSTENSTELLE ;cost centre 
	. IF KONTOA=1,$PIECE(BUCHUNG,Y,12)="",$PIECE(SATZ(1),Y,10)="" SET $PIECE(SATZ(1),Y,10)="7777"   ;DFLT
	
	IF KONTOA'=1 SET $PIECE(SATZ(1),Y,10)=""
	SET $PIECE(SATZ(1),Y,12)=$PIECE(BUCHUNG,Y,7)  ;BELEG ;proof 
	SET $PIECE(SATZ(1),Y,13)=$EXTRACT($PIECE(BUCHUNG,Y,8),1,23)  ;TEXT
	SET $PIECE(SATZ(1),Y,8)=$PIECE(BUCHUNG,Y,6)  ;STEUER ;tax 
	IF SACH="S" SET $PIECE(SATZ(1),Y,41)=IDNR    ;STEUER ID ;tax ID 
	IF $PIECE(BUCHUNG,Y,18)'="" SET $PIECE(SATZ(1),Y,41)=$PIECE(BUCHUNG,Y,18)
	IF $PIECE(BUCHUNG,Y,5)'=""  SET $PIECE(SATZ(1),Y,14)=$GET(BTR)_"."_$PIECE(BUCHUNG,Y,5)
	;IF $G(YWHR)="EUR"  ;TYBD; IMMER EURO ;26635;26,10,2004
	SET $PIECE(SATZ(1),Y,15)=1  ;EURO BUCHUNG ;Euro- 
	IF (BUCHART=1)!(BUCHART=2)!(BUCHART="") SET ^|UCI|FABUDAT(MAN,KEY,ZAEHL,1)=$TRANSLATE(SATZ(1),Y,"; ")
	;OP SOLL
	IF SACH="S",$PIECE(BUCHUNG,Y,4)'="" SET $PIECE(SATZ(1),Y,14)=$GET(BTR)_"."_$PIECE(BUCHUNG,Y,4)
	IF (BUCHART=1)!(BUCHART=2)!(BUCHART="") IF SACH="S" SET ^|UCI|FABUDAT(MAN,KEY,ZAEHL,2)=$TRANSLATE(SATZ(2),Y,";")
	;HABEN BUCHUNG ;have got 
	SET KONTOH=$PIECE(BUCHUNG,Y,5)  ;KONTO HABEN ;acct. have got 
	SET LIEF=$PIECE(BUCHUNG,Y,5)
	SET KUND=$PIECE(BUCHUNG,Y,5)
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)   ;STEUERID ; tax ID     ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID              ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;SKONTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))     ; SR15424
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE     ; SR15424
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))     ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))     ; SR15424
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'=""  SET KONTOA=7
	;SET SACH=""
	IF $LENGTH($PIECE(BUCHUNG,Y,5))>5 SET SACH="H"
	SET SATZ(1)=Y_YBED_Y_Y_1_Y_Y
	IF BUCHART=3 SET SATZ(1)=Y_YBED_Y_1_Y_Y   ;1.SATZ=HABEN
	SET SATZ(2)=Y_Y
	SET $PIECE(SATZ(2),Y,6)=$PIECE(BUCHUNG,Y,13)
	SET $PIECE(SATZ(2),Y,7)=$JUSTIFY($PIECE(BUCHUNG,Y,14),0,2)
	SET $PIECE(SATZ(2),Y,8)=$PIECE(BUCHUNG,Y,15)
	SET $PIECE(SATZ(2),Y,12)=$PIECE(BUCHUNG,Y,23)  ;BELEGNUMMER DES KREDITOR
	SET $PIECE(SATZ(2),Y,13)=$PIECE(BUCHUNG,Y,24)  ;ZAHLUNGSART
	IF $PIECE(SATZ(2),Y,13)="" SET $PIECE(SATZ(2),Y,13)=5  ;ZAHLUNGSART
	SET $PIECE(SATZ(1),Y,5)=DATUM                                ;DATUM ;Date 
	SET $PIECE(SATZ(1),Y,7)=$JUSTIFY($PIECE(BUCHUNG,Y,3),0,2)    ;BETRAG ;Sum 
	SET $PIECE(SATZ(1),Y,13)=$EXTRACT($PIECE(BUCHUNG,Y,8),1,23)  ;TEXT
	SET $PIECE(SATZ(1),Y,9)=KONTOA_BTR_KONTOH                    ;KONTO ;acct. 
	IF $PIECE(YFPARA,Y,8)=1 DO                                   ;KOSTENSTELLE ;cost centre 
	. IF KONTOA=1 SET $PIECE(SATZ(1),Y,10)=$PIECE(BUCHUNG,Y,12)  ;KOSTENSTELLE ;cost centre 
	. IF KONTOA=1,$PIECE(BUCHUNG,Y,12)="",$PIECE(SATZ(1),Y,10)="" SET $PIECE(SATZ(1),Y,10)="7777"   ;DFLT
	
	IF KONTOA'=1 SET $PIECE(SATZ(1),Y,10)=""
	IF $PIECE(BUCHUNG,Y,24)'="" SET $PIECE(SATZ(2),Y,13)=$PIECE(BUCHUNG,Y,24)
	SET $PIECE(SATZ(1),Y,12)=$PIECE(BUCHUNG,Y,7)  ;BELEG ;proof 
	SET $PIECE(SATZ(1),Y,8)=$PIECE(BUCHUNG,Y,6)   ;STEUER ;tax 
	IF SACH="H" SET $PIECE(SATZ(1),Y,41)=IDNR     ;STEUER ID ;tax ID 
	IF $PIECE(BUCHUNG,Y,18)'="" SET $PIECE(SATZ(1),Y,41)=$PIECE(BUCHUNG,Y,18)
	SET ZAEHL=$$^WWWNEXT("FABUDAT")
	IF $PIECE(BUCHUNG,Y,4)'="" SET $PIECE(SATZ(1),Y,14)=BTR_"."_$PIECE(BUCHUNG,Y,4)
	;IF $G(YWHR)="EUR" ;IMMER EURO;TYBD;4,1,2005
	SET $PIECE(SATZ(1),Y,15)=1  ;EURO BUCHUNG ;Euro- 
	IF (BUCHART=3)!(BUCHART=4)!(BUCHART="") SET ^|UCI|FABUDAT(MAN,KEY,ZAEHL,1)=$TRANSLATE(SATZ(1),Y,";")
	;OP HABEN ;have got 
	IF SACH="H",$PIECE(BUCHUNG,Y,4)'="" SET $PIECE(SATZ(1),Y,14)=BTR_"."_$PIECE(BUCHUNG,Y,4)
	IF BUCHART=3!(BUCHART=4)!(BUCHART="") IF SACH="H" SET ^|UCI|FABUDAT(MAN,KEY,ZAEHL,2)=$TRANSLATE(SATZ(2),Y,";")
	LOCK -^|UCI|FABUDAT
	SET YRETURN=KEY
	QUIT YRETURN
]]></Routine>
</Export>