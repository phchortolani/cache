<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INVORKALK1" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INVORKALK1(YKEY)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		ANZEIGEN VORKALKULATION
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 31-May-2006	GRF		Doco
	; 02.07.2004	FAN		25888,25794  alphanumerische Aufträge ;
	; 23.07.2002	FIS		Created
	;-------------------------------------------------------------------------------
	NEW AUFTRAG,POS1,SUCH,AUF,POS
	
	SET AUF=$PIECE($GET(YKEY),",",1)     	QUIT:AUF=""
	SET POS=$PIECE($GET(YKEY),",",2)    	QUIT:POS=""
	
	DO ^INVORKALK(AUF,POS)
	SET AUFTRAG=1                                                  ;KALKULATION VON AUFTRAG ;cost estimating order 
	SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	IF POS1="" SET AUFTRAG=0 SET POS1=$GET(^INANGP(YM,AUF,POS,1))  ;KALKULATION VON ANGEBOT ;cost estimating proposition 
	QUIT:$PIECE(POS1,Y,4)=""
	KILL ^WWWSOR(YUSER)
	DO SORT
	DO DRUCK
	KILL ^WWWSOR(YUSER)
	QUIT
	
SORT   ;SUCHEN ARTIKELTEILE LT. ANGEBOTSPOSITION ;seek 
	NEW TEIL,YEBENE,YDATEI,YFELD
	
	SET YEBENE=0  ;TEILE-EBENE
	SET ^WWWSOR(YUSER,1,YEBENE,0,$PIECE(POS1,Y,4))=POS1  ;DATENSATZ ;data record 
	
	;ARTIKELTEILE
	SET YDATEI="^INAUFPXL("_""""_YM_""""_","_""""_AUF_""""_","_POS_")"
	IF AUFTRAG=0 SET YDATEI="^INANGPXL("_""""_YM_""""_","_""""_AUF_""""_","_POS_")"
	IF $DATA(@YDATEI) DO
	. FOR  DO  QUIT:YDATEI=""
	. . SET YDATEI=$QUERY(@YDATEI)
	. . ;IF $PIECE(YDATEI,",",2)'=AUF SET YDATEI="" QUIT                  ;02.07.2004;FAN;alphanumerische Aufträge ;25888  ;25794
	. . IF $TRANSLATE($PIECE(YDATEI,",",2),"""")'=AUF SET YDATEI="" QUIT
	. . IF $PIECE(YDATEI,",",3)'=POS SET YDATEI="" QUIT
	. . SET YFELD=@YDATEI
	. . QUIT:$PIECE(YFELD,Y,4)=""  ;ARTIKEL ;item 
	. . SET TEIL=$PIECE(YDATEI,",",4,99)
	. . SET TEIL=$TRANSLATE(TEIL,",)","..")
	. . ;SET YEBENE=$LENGTH(TEIL,".")-1
	. . SET YEBENE=0
	. . SET ^WWWSOR(YUSER,1,YEBENE,TEIL,$PIECE(YFELD,Y,4))=YFELD  ;EBENE,TEILEKEY,ARTIKEL
	
	QUIT
	
DRUCK   ;DRUCKEN PREISE ;print 
	NEW ART,YEBENE,TEIL,YFELD,YI,YDDSATZ,GESAMT,KOSTENART
	
	DO ^WWWUP(0)
	DO ^WWWBACK
	DO KOPF
	SET YDDSATZ=0
	SET YEBENE=""
	FOR  SET YEBENE=$ORDER(^WWWSOR(YUSER,1,YEBENE)) QUIT:YEBENE=""  DO
	. SET TEIL=""
	. FOR  SET TEIL=$ORDER(^WWWSOR(YUSER,1,YEBENE,TEIL)) QUIT:TEIL=""  DO
	. . SET ART=""
	. . FOR  SET ART=$ORDER(^WWWSOR(YUSER,1,YEBENE,TEIL,ART)) QUIT:ART=""  DO
	. . . SET YFELD=$GET(^WWWSOR(YUSER,1,YEBENE,TEIL,ART))
	. . . ;
	. . . DO NL^WWWTAB
	. . . ;
	. . . ;TEILESTRUKTUR
	. . . DO NF^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0  WRITE "-"   ;HAUPTTEIL
	. . . IF TEIL'=0 WRITE TEIL  ;TEILESTRUKTUR
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;ARTIKEL ;item 
	. . . DO NF^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . WRITE ART 
	. . . WRITE "&nbsp;"
	. . . WRITE $EXTRACT($PIECE(YFELD,Y,1),1,25)  ;BEZEICHNUNG ;notation 
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;MENGE ;quantity 
	. . . DO NFR^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . IF $PIECE(YFELD,Y,40)'="" DO
	. . . . ;IF +$PIECE(YFELD,Y,39)=0 SET $PIECE(YFELD,Y,39)=$PIECE(YFELD,Y,5) 
	. . . . ;IF '$FIND(",2,10,11,",","_$PIECE(YFELD,Y,40)_",") WRITE $$^WWWZAHL($PIECE(YFELD,Y,39),0,$LENGTH($PIECE($PIECE(YFELD,Y,39),".",2)))  ;MENGE
	. . . . IF '$FIND(",2,10,11,",","_$PIECE(YFELD,Y,40)_",") WRITE $$^WWWZAHL($PIECE(YFELD,Y,5),0,$LENGTH($PIECE($PIECE(YFELD,Y,5),".",2)))  ;MENGE ;quantity 
	. . . . IF $FIND(",2,10,11,",","_$PIECE(YFELD,Y,40)_",")  WRITE $$^WWWTIME(+$PIECE(YFELD,Y,45)) QUIT  ;DAUER ;time
	. . . . WRITE " "_$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(YFELD,Y,40),1)),Y,1)  ;EINHEIT ;unit
	. . . ;
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;HÖCHSTE HERSTELLKOSTEN
	. . . DO NFR^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . IF +$PIECE(YFELD,Y,270)'=0 WRITE $$^WWWZAHL($PIECE(YFELD,Y,270))  ;PREIS ;price 
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;WARENHERKUNFT HÖCHSTE HERSTELLKOSTEN
	. . . DO NFL^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . IF $PIECE(YFELD,Y,272)'="" WRITE $PIECE($GET(^WWW101(0,"WARENHERKUNFT",SPRACHE,$PIECE(YFELD,Y,272),1)),Y,1)  ;WARENHERKUFT
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;NIEDRIGSTE HERSTELLKOSTEN
	. . . DO NFR^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . IF +$PIECE(YFELD,Y,269)'=0 WRITE $$^WWWZAHL($PIECE(YFELD,Y,269))  ;PREIS ;price 
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . ;WARENHERKUNFT NIEDRIGSTE HERSTELLKOSTEN
	. . . DO NFL^WWWTAB
	. . . WRITE "<FONT SIZE=2>"
	. . . IF TEIL=0 WRITE "<B>"
	. . . IF $PIECE(YFELD,Y,271)'="" WRITE $PIECE($GET(^WWW101(0,"WARENHERKUNFT",SPRACHE,$PIECE(YFELD,Y,271),1)),Y,1)  ;WARENHERKUFT
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . ;
	. . . DO EL^WWWTAB
	
	DO STOP^WWWTAB
	DO ^WWWUP(1)
	QUIT
	
KOPF   ;TABELLENÜBERSCHRIFT
	WRITE "<CENTER>"
	DO START00^WWWTAB
	DO NL^WWWTAB
	DO NHWO^WWWTAB
	WRITE "<FONT SIZE=3>"
	WRITE "<B>"
	WRITE "<NOBR>"
	WRITE $$^WWWTEXT(32864)  ;VORKALKULATION ;preliminary costing 
	WRITE "</FONT>",YCR
	WRITE "</NOBR>"
	WRITE "</FONT>",YCR
	WRITE "</B>"
	DO EH^WWWTAB
	DO EL^WWWTAB
	DO STOP^WWWTAB
	WRITE "</CENTER>"
	WRITE "<BR>"
	
	DO START100^WWWTAB  ;STARTEN DER ÜBERSCHRIFT (TABELLENANFANG) ;launching the superscription 
	WRITE "<THEAD>"
	WRITE "<TR>"
	
	WRITE YCR,"<TH NOWRAP ALIGN=LEFT"
	WRITE " COLSPAN=3"
	WRITE " BGCOLOR="_YDARKGRAY
	WRITE ">"
	WRITE YCR,"<FONT SIZE=2>"
	WRITE YCR,"<B> "
	IF AUFTRAG=1 WRITE $$^WWWTEXT(32047)                       ; "Order"
	IF AUFTRAG=0 WRITE $$^WWWTEXT(32178)                       ; "Offer"
	WRITE ": "_AUF_"-"_POS_"</B>"  ;warenherkunft der unterteile ;who 
	WRITE " ("_$$^WWWDATE(+$H)_")"
	WRITE YCR,"</TH>"
	
	WRITE YCR,"<TH NOWRAP ALIGN=CENTER"
	WRITE " COLSPAN=2"
	WRITE " BGCOLOR="_YDARKGRAY
	WRITE ">"
	WRITE YCR,"<FONT SIZE=2>"
	WRITE YCR,"<B> "_$$^WWWTEXT(33079)_" </B>"  ;TEUERSTE HK/EK   ; "Highest Cost"
	WRITE YCR,"</TH>"
	WRITE YCR,"<TH NOWRAP ALIGN=CENTER"
	WRITE " COLSPAN=2"
	WRITE " BGCOLOR="_YDARKGRAY
	WRITE ">"
	WRITE YCR,"<FONT SIZE=2>"
	WRITE YCR,"<B> "_$$^WWWTEXT(33080)_" </B>"  ;NIEDRIGSTE HK/EK ; "Lowest Cost"
	WRITE YCR,"</TH>"
	
	WRITE YCR,"</TR>"
	
	DO NL^WWWTAB
	DO NH^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32085)  ;TEILESTRUKTUR     ; "Level Structure"
	WRITE "&nbsp;"  ;LEERZEICHEN
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32024)  ;ARTIKEL ; "Item"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(31407)  ;MENGE   ; "Quantity"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32325)  ;WERT    ; "Value"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32088)  ;WARENHERKUNFT ; "Source Of Items"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32325)  ;WERT    ; "Value"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO NHW^WWWTAB
	WRITE "<FONT SIZE=2>"
	WRITE $$^WWWTEXT(32088)  ;WARENHERKUNFT ; "Source Of Items"
	WRITE "&nbsp;"
	DO EH^WWWTAB
	
	DO EL^WWWTAB
	WRITE "</THEAD>"
	QUIT
]]></Routine>
</Export>