<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWGEB" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWGEB
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		AUTOMATISCHE EMAIL MIT GEBURTSTAGEN
	;	hintergrundprogramm auto email ; Background Automatic E-Mail 
	;	SOLLTE AUS WWWTAG GESTARTET WERDEN ;out of will 
	;
	; Inputs : 
	;
	; ByRef :
	;
	; Returns :
	;
	; History :
	; 07-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1 (DMY) &
	;							for WWWDATE (IntToDMY)
	; 02-Sep-2005	JW		SR12966: WWWTAG/WWWGEB are not shared
	; 26.01.2000	DT
	;-------------------------------------------------------------------------------
	NEW SCHEMA
	
	IF '$DATA(^WWWGEB(YM,"WWWGEBM",1)) SET ^WWWGEB(YM,"WWWGEBM",1)="WWWGEBM"_Y_1_Y_0_Y_Y_Y_Y_Y_1_Y_Y_Y_8
	QUIT:'$DATA(^WWWGEB(YM))    ;KEINE VORGABEN ;no 
	LOCK +^WWWGEB(YM):0 QUIT:'$TEST   ;SCHON IN BEARBEITUNG ;yet within adaptation 
	
	; FIXME : Missing FOR in following line - only process first SCHEMA & skip if none? <GRF>
	
	SET SCHEMA="" SET SCHEMA=$ORDER(^WWWGEB(YM,SCHEMA)) QUIT:SCHEMA=""  DO  ;SUCHEN LETZES SENDE DATUM  ;seek Date 
	. SET SCHEMA(1)=$PIECE($GET(^WWWGEB(YM,SCHEMA,1)),Y,19)
	. IF SCHEMA(1)=+$HOROLOG QUIT  ;HEUTE SCHON GEPRÜFT ;today yet 
	. SET $PIECE(^WWWGEB(YM,SCHEMA,1),Y,19)=+$HOROLOG  ;HEUTE BEARBEITET ;today 
	. SET SCHEMA(3)="",SCHEMA(4)=""
	. FOR  SET SCHEMA(4)=$ORDER(^WWWTAG(YM,SCHEMA(4))) QUIT:SCHEMA(4)=""  DO   ;SUCHEN IN TAGESAUTOMATIGDATEI ;seek within 
	. . IF $FIND($GET(^WWWTAG(YM,SCHEMA(4),1)),"WWWGEB") SET SCHEMA(3)=1
	. ;
	. IF SCHEMA(3)=1  DO START(YM) QUIT   ;IST IN AUTOMATISCHEM JOB ;within 
	. IF SCHEMA(3)'=1 JOB START^WWWGEB(YM)::1    ;JOB STARTEN NICHT IN AUTOMATIC JOB ;launching Not within 
	
	LOCK -^WWWGEB(YM)
	QUIT
	
	
START(YMAN) ;STARTEN VERARBEITUNG ;launching processing 
	DO ^WWWVAR
	IF $GET(YMAN)'="" SET YM=YMAN
	LOCK +^WWWGEB(YM):4 QUIT:'$TEST   ;SCHON IN BEARBEITUNG ;yet within adaptation 
	DO ^WWWVAR ;SR13942. reversed
	SET YUSER="GMAIL"
	KILL ^WWWSOR(YUSER)
	DO
	. SET YQ=0
	. SET YSCHEMA="" FOR  SET YSCHEMA=$ORDER(^WWWGEB(YM,YSCHEMA)) QUIT:YSCHEMA=""  DO  ;durchsuchen SCHEMA ;scour scheme 
	. . SET YGEB=$GET(^WWWGEB(YM,YSCHEMA,1))  ;DATEN AUS SCHEMAVORGABE ;out of 
	. . SET YDATEI=$PIECE(YGEB,Y,1)
	. . IF YDATEI="" QUIT   ;KEINE DATEI ;no data file 
	. . SET YDATUM=+$PIECE(YGEB,Y,2)
	. . IF YDATUM="" QUIT  ;KEIN DATUMSFELD ;no 
	. . SET YVORSCH=$PIECE(YGEB,Y,11)
	. . IF +YVORSCH=0 SET YVORSCH=8   ;ANZAHL DER TAGEIM VORSCHAU ;Number the preview 
	. . SET SUBJECT=$PIECE(YGEB,Y,5)  ;BETREFF
	. . SET YFELDER=$TRANSLATE($PIECE(YGEB,Y,8),";",",")  ;DATENFELDER AUF MAILING
	. . SET YJUBIL=+$PIECE(YGEB,Y,10)  ;NUR ALLE 5-10 JAHRE ;only 
	. . SET YSENDEN=$TRANSLATE($PIECE(YGEB,Y,4),";",",")  ;AN WEN SENDEN
	. . SET YTAGE=7  ;ALLE 8 TAGE
	. . IF +$PIECE(YGEB,Y,3)=0 SET YTAGE=1  ;JEDEN TAG PRÜFEN UND SENDEN ;TAG sift And transmit 
	. . IF YTAGE=7 SET YZEIT=$TRANSLATE($PIECE(YGEB,Y,3),";",",") IF +YZEIT'=0 IF '$FIND(","_YZEIT_",",","_$$^WWWDAY($HOROLOG)_",") QUIT  ;NICHT FÜR DIESEN TAG
	. . SET YLAST=$PIECE($GET(^WWWGEB(YM,YSCHEMA,1)),Y,20)
	. . SET $PIECE(^WWWGEB(YM,YSCHEMA,1),Y,20)=+$HOROLOG   ;MAIL SENDEN AM ;transmit to the 
	. . DO READ  ;LESEN DATEIEN
	. . DO SEND   ;ZUSAMMESTELLEN UND SENDEN ;And transmit 
	. . HANG 60 ;WARTEN 60 SEKUNDEN ;wait for 
	
	KILL ^WWWSOR(YUSER)
	QUIT
	
READ ;SUCHEN FORGABEN ,LESEN EMAIL
	KILL ^WWWSOR(YUSER)
	DO ^WWWSOR(YDATEI,"","",0,0,0,1,"")
	
	SET YA(2)=""
	FOR  SET YA(2)=$ORDER(^WWWSOR(YUSER,"KEY",YA(2))) QUIT:YA(2)=""  DO
	. SET YKEY=""
	. FOR  SET YKEY=$ORDER(^WWWSOR(YUSER,"KEY",YA(2),YKEY)) QUIT:YKEY=""  DO
	. . SET YA=$GET(^WWWSOR(YUSER,"KEY",YA(2),YKEY))
	. . DO SATZ
	
	KILL ^WWWSOR(YUSER,"KEY")
	KILL ^WWWSOR(YUSER,"SEL")
	QUIT
	
SATZ ;EINZELSAETZE
	SET YFELD=$$^WWWSETL(YA)
	
	SET YDATE=+$PIECE(YFELD,Y,YDATUM)  ;DATUMSFELD UNTERSUCHEN ;examine 
	IF YDATUM=0 SET YDATE=+$PIECE(YA,",",2)  ;PRIMÄRSCHLÜSSEL
	IF YDATEI="WWWGEBM" SET YDATE=+$PIECE(YA,",",3)  ;2.PRIM BEI BEI DATEI WWWGEBM ;next to next to data file 
	IF +YDATE=0 QUIT  ;KEIN DATUM ;no Date 
	;SET YDATE1=$$^WWWDATE(YDATE,"DE")           ; SR17146 : FIXME : YDATE1 is not used here - may be passed back elsewhere
	;IF $FIND(YDATE1,"/") SET YDATE1=$PIECE(YDATE1,"/",2)_"."_$PIECE(YDATE1,"/",1)_"."_$PIECE(YDATE1,"/",3)
	SET YDATE1=$$IntToDMY^WWWDATE(YDATE)   ; as "DD.MM.YYYY"
	SET YEAR1=$$^WWWYEAR(YDATE)
	SET YEAR2=$$^WWWYEAR(+$HOROLOG)
	IF YJUBIL=1 IF (YEAR2-YEAR1)#5'=0 QUIT  ;KEIN RUNDES DATUM 5/10 JAHRE ;no Date 
	SET YDATE = $$DMY^WWWDATE1($$^WWWDAY(YDATE)_"."_$$^WWWMONTH(YDATE)_"."_YEAR2)  ;SETZEN AUF DIESES JAHR ;typeset upon this year ; SR17146
	
	IF YDATE<$HOROLOG QUIT   ;SCHON VORBEI ;yet straight past 
	SET YDATE=YDATE-YVORSCH  ;X TAGE SCHAUEN ;X look at 
	IF YDATE>$HOROLOG QUIT   ;NOCH NICHT ;yet Not 
	SET Q=0
	SET YDATE=YDATE+YVORSCH
	SET YEXE=$PIECE(YGEB,Y,6) IF YEXE'="" XECUTE YEXE   ;MANUELLER EXEUTE( Q=1 = PRUEFUNG NEGATIV) YDATE=DATUM
	QUIT:Q=1   ;MANUELLES PROGRAMM ENDE ;programme termination 
	SET ^WWWSOR(YUSER,YUSER,YA)=YFELD   ;SPEICHERN DES DATENSATZES ;Save 
	QUIT
	
SEND ;E-MAIL ZUSAMMENSTELLEN
	;YZEILE=LFD ZEILE
	;TEXT(YZEILE)=SENDETEXT
	;SUBJECT=BETREFF
	IF YDATEI="WWWGEBM" DO GEBM QUIT   ;AN MITARBEITER PERSÖNLICH ;upon personal 
	
	QUIT:'$DATA(^WWWSOR(YUSER,YUSER))  ;KEINE MAILS ;no 
	KILL TEXT,TXT
	NEW YZEILE
	SET YZEILE=0
	
	;TEXT1
	SET YANT=$PIECE(YGEB,Y,7)
	IF YANT'="" DO   ;TEXT VOR LISTE ;Text pre- list 
	. FOR YLINE=1:1 QUIT:$PIECE(YANT,"|",YLINE,9999)=""  DO
	. . SET YZEILE=YZEILE+1
	. . SET TEXT(YZEILE)=$PIECE(YANT,"|",YLINE)
	
	;GEBUTSTAGE LISTEN
	SET YA=""
	FOR  SET YA=$ORDER(^WWWSOR(YUSER,YUSER,YA)) QUIT:YA=""  DO
	. SET YFELD=$GET(^WWWSOR(YUSER,YUSER,YA))
	. SET YZEILE=YZEILE+1
	. SET TEXT(YZEILE)="    "
	. SET YZEILE=YZEILE+1
	. SET YDATE=$PIECE(YFELD,Y,YDATUM)  ;DATUMSFELD UNTERSUCHEN ;examine 
	. SET YEAR1=$$^WWWYEAR(YDATE)
	. SET YEAR2=$$^WWWYEAR(+$HOROLOG)
	.;SET TEXT(YZEILE)="    "_(YEAR2-YEAR1)_".  "_$EXTRACT($$^WWWDATE(YDATE),1,6)_$$^WWWYEAR($HOROLOG)   ; SR17146
	. SET TEXT(YZEILE)="    "_(YEAR2-YEAR1)_".  "_$EXTRACT($$IntToDMY^WWWDATE(YDATE),1,6)_$$^WWWYEAR($HOROLOG)  ; FIXME : as DD.MM.YYYY regardless of preferred format
	. FOR YI=1:1 QUIT:$PIECE(YFELDER,",",YI)=""  DO
	. . SET TEXT(YZEILE)=TEXT(YZEILE)_" "_$PIECE(YFELD,Y,$PIECE(YFELDER,",",YI))  ;ZUSAMMENBAU DER ANZEIGEFELDER ;the 
	
	;TEXT2
	SET YANT=$PIECE(YGEB,Y,9)
	IF YANT'="" DO   ;TEXT NACH LISTE ;Text within list 
	. FOR YLINE=1:1 QUIT:$PIECE(YANT,"|",YLINE,9999)=""  DO
	. . SET YZEILE=YZEILE+1
	. . SET TEXT(YZEILE)=$PIECE(YANT,"|",YLINE)
	
	DO SENDEN
	
	KILL ^WWWSOR(YUSER)
	
	QUIT  ;NEXT EMAILSCHEMA
	
GEBM ;SENDESCHEMA 1. KEY=EMPFÄNGER (PERSÖNLICHE MAIL)
	QUIT:'$DATA(^WWWSOR(YUSER,YUSER))  ;KEINE MAILS ;no
	 
	SET YA=""
	FOR  SET YA=$ORDER(^WWWSOR(YUSER,YUSER,YA)) QUIT:YA=""  DO
	. SET YSENDEN=$TRANSLATE($PIECE(YA,",",2),"""")  ;MITARBEITER = PRIMÄRSCHLÜSSEL
	. DO GEBM1   ;SENDEN MAIL ;transmit 
	
	KILL ^WWWSOR(YUSER)
	
	QUIT
	
GEBM1 ;ZUSAMMENSTELLEN TEXT
	KILL TEXT,TXT
	NEW YZEILE
	
	SET YZEILE=0
	
	;TEXT1
	SET YANT=$PIECE(YGEB,Y,7)
	IF YANT'="" DO   ;TEXT VOR LISTE ;Text pre- list 
	. FOR YLINE=1:1 QUIT:$PIECE(YANT,"|",YLINE,9999)=""  DO
	. . SET YZEILE=YZEILE+1
	. . SET TEXT(YZEILE)=$PIECE(YANT,"|",YLINE)
	
	;GEBUTSTAGE LISTEN
	DO
	. SET YFELD=$GET(^WWWSOR(YUSER,YUSER,YA))
	. SET YZEILE=YZEILE+1
	. SET TEXT(YZEILE)="    "
	. SET YZEILE=YZEILE+1
	. SET YDATE=$PIECE(YA,",",3)  ;DATUMSFELD UNTERSUCHEN ;examine 
	. SET YEAR1=$$^WWWYEAR(YDATE)
	. SET YEAR2=$$^WWWYEAR(+$HOROLOG)
	. SET TEXT(YZEILE)="    "_(YEAR2-YEAR1)_".  "_$EXTRACT($$IntToDMY^WWWDATE(YDATE),1,6)_$$^WWWYEAR($HOROLOG)  ; as DD.MM.YYYY
	. FOR YI=1:1 QUIT:$PIECE(YFELDER,",",YI)=""  DO
	. . SET TEXT(YZEILE)=TEXT(YZEILE)_" "_$PIECE(YFELD,Y,$PIECE(YFELDER,",",YI))  ;ZUSAMMENBAU DER ANZEIGEFELDER ;the 
	
	;TEXT2
	SET YANT=$PIECE(YGEB,Y,9)
	IF YANT'="" DO   ;TEXT NACH LISTE ;Text within list 
	. FOR YLINE=1:1 QUIT:$PIECE(YANT,"|",YLINE,9999)=""  DO
	. . SET YZEILE=YZEILE+1
	. . SET TEXT(YZEILE)=$PIECE(YANT,"|",YLINE)
	
	DO SENDEN
	
	QUIT  ;NEXT MITARBEITER
	
	
SENDEN ;SENDEN DES EMAILS ;transmit 
	SET TCP=$PIECE($GET(^WWW012(0,YM,1)),Y,40)  ;z.B. 172.16.2.19 ;e.g. 
	IF TCP="" SET TCP="127.0.0.1"
	SET DOM=$PIECE($GET(^WWW012(0,YM,1)),Y,43)  ;z.B. intraprend.de ;e.g. 
	IF DOM="" SET DOM="t-online.de"
	SET FROM="postmaster@"_DOM   ;MAIL VOM POSTMASTER
	IF $PIECE($GET(^WWW012(0,YM,1)),Y,84)'="" DO
	. SET FROM=$PIECE($GET(^WWW012(0,YM,1)),Y,84)
	. SET PASSW=$PIECE($GET(^WWW012(0,YM,1)),Y,85)
	
	FOR YII=1:1 SET ANUSER=$PIECE(YSENDEN,",",YII) QUIT:ANUSER=""  DO   ;AN WEN SENDEN? ;upon who 
	. SET UUSER=$PIECE($GET(^WWW013(0,ANUSER,1)),Y,9)  ;EMAILANSCHRIFT
	. QUIT:UUSER=""  ;KEINE EMAILANSCHRIFT DES BEDIENERS ENDER ;no 
	. ;
	. SET BETR=SUBJECT  ;BETREFF SETZEN ;typeset 
	. IF BETR="" SET BETR=" "
	. SET TXT="TEXT"
	. ;
	. SET OKSEND=$$^WWWMAILS(TCP,FROM,UUSER,BETR,TXT)   ;SENDEN E-MAIL ;transmit 
	
	QUIT
	
]]></Routine>
</Export>