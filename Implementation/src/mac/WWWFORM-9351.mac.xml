<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="Cache" ts="2001-01-01 00:00:00">
<Routine name="WWWFORM" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[WWWFORM
	
#include COMSYS
#include WWWConst
	
#define LOGWWWBENCH(%i) 
#;define LOGWWWBENCH(%i) if ($get(^SysSetup(14864,1)))&&($get(YSTARTTIME)'="")&&($get(YSTARTTIME1)'="")&&($get(YFORM)'="")&&($get(YBED)'="") set ^LogWWWBENCH(0,+$horolog,YSTARTTIME1,YFORM,YBED,$increment(^LogWWWBENCH(0,+$horolog,YSTARTTIME1,YFORM,YBED)),%i,1) = ($zhorolog - YSTARTTIME)_"~"_##class(alSYS.SYSTEM.Process).LinesExecuted($job)_"~"_$get(YDATEI)_"~"_$get(YUSER)_"~"_$get(YKEY)_"~"_$job_"~"_$select($stack(-1)>=0:$stack($stack(-1),"PLACE"),1:"")_"~"_$select($stack(-1)>=1:$stack($stack(-1)-1,"PLACE"),1:"")_"~"_$select($stack(-1)>=2:$stack($stack(-1)-2,"PLACE"),1:"")_"~"_$select($stack(-1)>=3:$stack($stack(-1)-3,"PLACE"),1:"")
	
#define jsMarker(%1)
#;define jsMarker(%1) 	write YCR,YCR,"<!-- ************************* ",%1," (WWWFORM)************************* -->",YCR,YCR
	
#define LogR(%1,%2) 	;
#define LogRx(%1)		;
#define LogRm(%1)		;
#;define LogR(%1,%2) 	$$$JournalOff s ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))= %1_"^WWWFORM("_%2_") : "_$zh $$$JournalOn
#;define LogRx(%1)		$$$JournalOff s ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))=%1 $$$JournalOn
#;define LogRm(%1)		$$$JournalOff m ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))=%1 $$$JournalOn
	
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		AUFRUF FORMULARE	- FORM CALLS  ; 
	;	THIS ROUTINE IS THE MAIN ROUTINE, WHICH STEERS IN THE STRUCTURE OF FORMS.
	;	         The CALL TAKES PLACE VIA URL WITH THE VARIABLES
	;	DIESE ROUTINE IST DIE HAUPTROUTINE, DIE IN DEN AUFBAU VON FORMULAREN STEUERT.
	;	         DER AUFRUF ERFOLGT VIA URL MIT DEN VARIABLEN
	; 
	; Inputs : 
	;	 EP		= WWWFORM     ;STARTET DIESE ROUTIENE
	;	 YFORM	= FORMULANAME
	;	 YKEY	= SCHLUESSEL
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 31-Jan-2014	shobby	HEVA-788: Corrected customisation test for access.
	; 30-Jan-2014	shobby	CORE-307: Preserve YOPTION
	; 18-Dec-2013	shobby	CORE-291: YUSENAME
	; 03-Sep-2013	shobby	CORE-86: Until this has proven reliable it is restricted to only the INReceipt form..
	; 21-Aug-2013	shobby	CORE-86: Clean out all WWWDATEN when changing tabs.
	; 13-Nov-2012	shobby	SR18183: Previous change extended to MEDPrescriptionSol form.
	; 08-Nov-2012	shobby	SR18182: Various changes to try and fix malformed HTML particularly
	;								 nested FORM to better control positioning of objects.
	;							     Bit risky so initially it is limited to only the
	;								 MEDPrescriptionHosp form.
	; 12-Apr-2012	shobby	SR17998: WWWBENCH now has an index.
	; 03-May-2010	GRF		SR15961: use dteToday for efficiency; Old comments cleanup
	; 23-Dec-2009	GRF		SR17095: Allow
	; 19-Nov-2009	shobby	SR17032: Disabled 'NumberOfHits' functionality.
	; 15-Jan-2009	GRF		SR15853: Pass audit string to NewUserSession
	; 20-Oct-2008	FIS		SR15824: force lock kill when form gets called from menu
    ; 08-Oct-2008	FIS		SR15947: load old record after delete failed
    ; 30-Sep-2008	FIS		SR15947: Changed WWWTransactionTable into WWWTransactionLine
    ; 26-Sep-2008	FIS		SR15947: Implement Transaction Wrappers for "Execute
    ; 							After Save" (form type 5), "Execute After Data
    ; 							Fields", and "Execute After Primary Key"
    ; 18-Sep-2008	shobby	BR014966: Use standard method to get form name
	; 27-Aug-2008	FIS		SR15824: if record is in-use, don't set lock at paging
	; 22-Aug-2008	FIS		SR15828: new WWWDATEN record (,4) (snapshot after form
	; 							creation) to compare before save WWWDATEN ,3
	; 							inactivated as it might not be required (only
	; 							commented out - just in case)
	; 19-Aug-2008	FIS		SR15853: create session in common routine
	; 12-Aug-2008	FIS		SR15828: new WWWDATEN record (,3) (snapshot before form
	; 							creation) to compare before save
	; 25-Jul-2008	GRF		SRBR014954: Doco only - renumber execute sequence;
	; 							remove 'new' entries from START
	; 19-Jun-2008	shobby	SRBR014955: Leave a bread crumb if the form was found to
	; 							be readonly so that customisation rules will be
	; 							prevented from running.
	; 18-Jun-2008	shobby	SRBR014954: Moved the OnBeforeEditAccess call to before
	; 							the call to WWWFORM8.  Otherwise if a form is
	; 							disabled here then the F12 key will still be active
	; 							(and records can still be saved)
	; 22-Jan-2008	GRF		SR15624: disable logging code - data location is being
	; 							repeatedly checked for need to log, probably slowing
	; 							form operation.
	; 07-Nov-2007	shobby	SRBR014769: New callout to OnBeforeFormConstruction to
	; 							adjust variables such as YKOPF and YVOR i.e. INWEINVD
	; 							can be changed from a 'Manual Form' to a 'Standard
	; 							Form' based on the condition of YPARA.
	; 01-Nov-2007	shobby	SRBR014748: Standard password check - $$CHECK^WWWPWDCHECK
	; 25-Oct-2007	FIS		SRBR014734: removed change into WWW0131WB
	; 04-Oct-2007	shobby	SRBR014734: If opening a new record clear the last
	; 							opened record key WWW126
	; 05-Jul-2007	GRF		Doco; once know WWW120 record has a non-null value don't
	; 							need $get; reuese macro
	; 02-May-2007	GRF		SR15509: YVOR will not be defined if YFORM is null; YEXEC
	; 							being newed incorrectly - move code to ExecButton.
	; 03-Apr-2007	GRF		SR15492: TerminationBy => TerminationOn
	; 13-Mar-2007	GRF		SR12505: Naked references
	; 09-Mar-2007	GRF		SR12505: use objFormKey; doco
	; 13-Nov-2006	GM		BR014107: Form name changes with customisation on Form screen
	; 13-Nov-2006	JW		SR14550: Pass in form to CalculateString
	; 19-Oct-2006	Steve S	BR014293: Construct redirect data/macro usage
	; 18-Sep-2006	PO		SR14864: Added greater detail to log
	; 13-Sep-2006	PO		SR14864: Added logging
	; 26-Apr-2006	SC		SR14414: Check for VARHooks error msg, and display if found.
	; 13-Apr-2006	JW		Removed + from user id's in lock check
    ; 29-Nov-2005	JW		SR13195: Keep data if only changing tabs
	; 21-Nov-2005	GRF		Correct dot levels
	; 16-Nov-2005	GRF		SR12505 : Doco
	; 19-Oct-2005	JW		SR13581 : If just changing tabs, keep grid info
	; 07-Jul-2005	shobby	SR12892 : WWW126 is no longer shared.
	; 30-May-2005	RobertW	SR12056 : Attempt at Performance Increase
	; 05.Aug.1997	DT		(C) BY DITMAR TYBUSSEK
	;-------------------------------------------------------------------------------
	new (%request,%session,%KEY,%,%ZCS,%CGIEVAR,NOKILL)
	$$$LogR("","")
	;+++++++++++++++++++++++++++++++++++++++
	;	YVORB		objWWW013	Users
	;+++++++++++++++++++++++++++++++++++++++
	set YSTARTTIME  = $zhorolog   ;STARTZEIT DES FORMULARS
	set YSTARTTIME1 = $piece($horolog,",",2)

	do ^WWWVAR                    ;VORGABEN SETZEN ; set default values
	;
	if $$MenuType^WWW013()=14{
		set objCompany = $get(^WWW012(0,YM,1))
		;
		set idColor = $$$WWW012FontColor(objCompany)
		set FONTCOLOR = ""
		if idColor'="" set FONTCOLOR = $$$SysEnum("FARBE",idColor)
		if FONTCOLOR="" set FONTCOLOR = "black"
		;
		set idColor = $$$WWW012FieldsetFrameColor(objCompany)
		set BORDERCOLOR = ""
		if idColor'="" set BORDERCOLOR = $$$SysEnum("FARBE",idColor)
		if BORDERCOLOR="" set BORDERCOLOR = "black"
		;
		set idColor = $$$WWW012BackgroundColor(objCompany)
		set BGCOLOR = ""
		if idColor'="" set BGCOLOR = $$$SysEnum("FARBE",idColor)
		;		
		&html<
		    <link type="text/css" rel="stylesheet" href="#(YGIF)#global/plugins/fontawesome/5.4.1/css/all.css" />
			<link type="text/css" rel="stylesheet" href="#(YGIF)#global/plugins/bootstrap-4.3.1/css/bootstrap.custom.css">
			<link type="text/css" rel="stylesheet" href="#(YGIF)#fonts/googlesans/googlesans.css">
			<style>
				font{
					font-family:Google Sans, Arial !important;
					size:11px;
				}
				input,select,textarea{
					font-family:Google Sans, Arial !important;
					font-size:14px;
					border-radius: 4px;
					border: 1px solid #(FONTCOLOR)#;
					color: #(FONTCOLOR)#;
				}
				input:read-only{
 					background-color: #e0e0e0;
 				}
 				textarea:read-only{
 					background-color: #e0e0e0;
 				}
 				select:disabled{
 					background-color: #e0e0e0 !important;
 				}
				.inputCab{
		            box-shadow:  2px 2px 3px 0px gray;
				}
				.btn {
					font-family:Google Sans, Arial;
		            box-shadow:  2px 2px 3px 0px gray;
		            font-size:12px;
		            padding: 5px 5px 5px 5px;
				}	
				fieldset {
					border-radius: 6px;
				    padding: 5px 5px 5px 5px !important;
				    margin: 0 0 10px 0 !important;
		            box-shadow:  3px 3px 5px 0px lightgray;
				}
				.tabDIVInner {
					border-radius: 8px 8px 0px 0px;
					border-top:1px solid #(FONTCOLOR)#;
					border-right:1px solid #(FONTCOLOR)#;
					border-left:1px solid #(FONTCOLOR)#;
				}
				.tabDIVInner.selected {
				    box-shadow:  3px -2px 2px 0px #424242;
				}
				.tabTexto {
				    box-shadow:  3px 3px 3px 0px #424242;
				}
				#WWW2 {
					border:1px solid #(BGCOLOR)#;
				}
				#WWW2 table {
					padding: 2px;
				}
		</style>
 		<script language='javascript'>
 			corCampoObrigatorio = "#($piece($get(^WWW100(0,"FARBE",SPRACHE,$piece(objCompany,Y,64),1)),Y,1))#"
			voltarRotina = "#(YFORM)#"
			parent.voltarRotina = "#(YFORM)#"
 		</script>		
		>
		if YMENUROT="1",YFORM'="WWWPARA"{
			do Body^WWWMenuSideBar()
			quit
		}
		
		&html<
			<script language='javascript'>
				var c = parent.document.getElementById("spCabecalho")
				
				if(c != null && c != undefined){
					parent.document.getElementById("spCabecalho").innerHTML = "#($$^WWWFORMNAME(YFORM))#";
				}
				
			</script>
		>
	}else{
		&html<
			<script language='javascript'>
				corCampoObrigatorio = "#fff"
			</script>		
		>
	}

	;
	;
	;if YOPEN'=2 if YFORM'="WWWPARA" if YFORM'="COMViewSearch" kill ^WWWDATEN(YM,+$h,YUSER) ;CORE-86
	if YOPEN'=2 if YFORM="INReceipt" kill ^WWWDATEN(YM,+$h,YUSER) ;CORE-86
	
	if +$get(%(YQUERY,"YFORMWAIT"))'=0 hang %(YQUERY,"YFORMWAIT")  ;TYBD;WARTEN VOR DEM START  ;wait for pre- take-off 
	if $get(%(YQUERY,"YSTARTFORM"))'="" if YFORM="WWWBLANK" set YFORM = %(YQUERY,"YSTARTFORM")  ;FIS;08.07.04;VORGEBEN STARTFORMULAR ;purport 
	
	set YTABLEANZ = 0
	set YHTMFORM  = "WWW"
	
	$$$LOGWWWBENCH(1)
	set dteToday = +$horolog    ; SR15961
	xecute $get(^SysSetup("TrackExecute","WWWFORM"))
	if $get(^SysSetup("WWWEVENT","Watch","Session"))=$get(YUSER) {
		set xxIO=$io
		set xxFileLog=$get(^SysSetup("WWWEVENT","Watch","LogFile"))
		if $zu(68,40,1)
		open xxFileLog:"asw"
		use xxFileLog
		write !
		write !,$zdt($h,3)
		write !,"New Form ",YFORM
		write !,"**************************************************************************************",!
		if '$get(^SysSetup("WWWEVENT","Watch","LogForm")) { ; log Form
			use xxIO
			close xxFileLog
		} else {
			set xxFile=$get(^SysSetup("WWWEVENT","Watch","TempFile"))
			open xxFile:"nsw"
			use xxFile

		}
	}
	;+++++++++++++++++++++++++++++++++++++++
	;  Form Substitution   *** EXECUTE 1 ***
	;+++++++++++++++++++++++++++++++++++++++
	if ($get(YFORM)'="") && ($$$WWW120AlternativeFormName($get(^WWW120(0,YFORM,1)))'="") {
		if $$$WWW120WhenTermInTrue(^WWW120(0,YFORM,1))'="" {
			xecute $$$WWW120WhenTermInTrue(^WWW120(0,YFORM,1)) 
			if $test set YFORM=$$$WWW120AlternativeFormName(^WWW120(0,YFORM,1)) set %(YQUERY,"YFORM")=YFORM
		}
	}
	;SR17998 if ($get(YBED)'="") && ($get(YFORM)'="") set ^WWWBENCH(0,dteToday,YSTARTTIME1,YFORM,YBED,1)=""  ;SAVE BENCHMARK
	if ($get(YBED)'="") && (YFORM'="") new strStatus set strStatus=$$Save^COMUtils("WWWBENCH",dteToday_","_YSTARTTIME1_","_YFORM_","_YBED,"",1)  ;SAVE BENCHMARK ;SR17998 
	;START EINSPRUNG VON AUSSEN ;take-off 
	set $ztrap="^WWWERROR"
	if $get(SPRACHE)="" set SPRACHE="DE"                ; FIXME : "EN" ?
	;------------------------------------------------------------------------
	;WENN ZEITABHÄNGIGE ERFASSUNG ;when logging 
	set YTIMEFORM=""
	if (YKILL=1) || (YKILL=2) if $get(%(YQUERY,"YTIMEFORM"))=1 set YTIMEFORM = 1  ;KILL IN TIMEFORMULAR;FIS:19.08.04 ;within 
	if ($get(YFORM)'="") && ($extract(YFORM,$length(YFORM))="t") {
		if $data(^WWW120(0,$extract(YFORM,1,$length(YFORM)-1))) {
			set YFORM     = $extract(YFORM,1,$length(YFORM)-1)
			set YTIMEFORM = 1
		}
	}
	;------------------------------------------------------------------------
	;WENN MENUESTRUKTUR ;when 
	if $get(YFORM)="WWWEXPLORER" do  quit                                ; ***   EARLY EXIT   ***
	. new YVOR
	. set YFORM = $get(%(YQUERY,"YFORM"))
	. quit:YFORM=""                                         ; YVOR will not be defined if YFORM is null.
	. ;
	. if YFORM'="" set YVOR = $get(^WWW120(0,YFORM,1))
	. set %(YQUERY,"FIX")	  = $get(%(YQUERY,"YFORM"))                  ;MENUENAME
	. set %(YQUERY,"OFFSET1") = $get(%(YQUERY,"YFORM"))                  ;MENUENAME
	. set %(YQUERY,"PWD")	  = $translate($get(%(YQUERY,"YPARA")),"~")  ;PARAMETER AUS MENU=PASSWORT ;parameter out of 
	. set %(YQUERY,"FILE")	  = "WWWEXPLORE"                             ;VERZEICHNIS NAME ;tabulation Name 
	. set %(YQUERY,"HEAD")	  = $$$WWW120FormHeaderOrImageFile(YVOR)     ;NAME DES VERZEICHNISSES
	. set %(YQUERY,"TARGET")  = $$$WWW120TargetNameForOutput(YVOR)       ;TARGET
	. do ^WWWEXPLORER  ;EXPLORER MENUESTRUKTUR
	;------------------------------------------------------------------------
	if (YKILL=1) && ($get(NOKILL)=1) set YKILL="" kill NOKILL  ;KEIN LÖSCHEN ;no Delete 
	
	do ExecButton(YFORM,$get(YBUTTON),YOPEN)        ; *** EXECUTE 2 ***
	
	;------------------------------------------------------------------------
	; NEUER USER NACH ANMELDUNG ;within registration 
	set (YBUTTON,YNUMMER,YMAXKEY) = ""
	if (YUSER="") && (YBED'="") {  
		set YUSER = $$NewUserSession^WWWUSER("WWWFORM")
		set ^WWWUSER(0,YUSER,1) = $$$UPPER(YPWD)_Y_YBED_Y_dteToday_Y_$piece($horolog,",",2)
		set %("VAR","YUSER")    = YUSER
	}
	;------------------------------------------------------------------------
	; ALTEN DATENSATZ ZURÜCKHOLEN ;data record 
	if (YUSER'="") && (YFORM'="") && ($data(^WWWUSE(0,YUSER,YFORM,"P",1))) {
		set FFKEY  = $get(^WWWUSE(0,YUSER,YFORM,"P",1))
		set YKEY   = FFKEY
		set FMFELD = $get(^WWWUSE(0,YUSER,YFORM,"M",1))
		set FFFELD = $get(^WWWUSE(0,YUSER,YFORM,"D",1))
		set FFFORM = YFORM                               ;TYBD;24.11.2003; WACH: MANUELLER EINPRUNG
		set YOPEN  = "OLD"
		kill ^WWWUSE(0,YUSER)
	}
	;------------------------------------------------------------------------
	;VORGABEN AUS ALTEM DATENSATZ ;out of data record 
	if YOPEN="OLD" {
		set YYFELD = "",YYKEY = "",YMFELD = "" 
		if ($get(FFFORM)'="") && (FFFORM=YFORM) {
			set YYFELD = $get(FFFELD)
			set YYKEY  = $get(FFKEY)
			set YMFELD = $get(FMFELD)
		}
	}
	
	;---------------------------------------
	; Fixed Inputs for Hidden Keys
	; - Load Keys for sub-form from calling form
	; - Set to specified value
	; - Set to value of @variable
	;---------------------------------------
	set YII = 1
	if (YFORM'="") && ($$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,2,1)))'="") {
		set YII = 2    ; Find number of primary keys YII
		if $$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,3,1)))'="" set YII=3
		if $$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,4,1)))'="" set YII=4
		if $$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,5,1)))'="" set YII=5
		if $$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,6,1)))'="" set YII=6
		if $$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,7,1)))'="" set YII=7
	}
	
	for YI=1:1:YII if (YKILL="") && (YRICHT="") && (YFORM'="") do  ;PRUEFEN PRIM-KEY, WENN KEIN PRIM DANN ALTES PROGRAMM LADEN  ;TYBD 14.02.2002/20.02.2002
	. new fixedInput,objFormKey
	. set objFormKey = $get(^WWW121(0,YFORM,YI,1))
	. set fixedInput = $$$WWW121FixedInputForHiddenField(objFormKey)
	. quit:fixedInput=""         ;KEIN FIXKEY ;no 
	. ;
	. ;------------------------------------- When YKEY has a non-null value for this key
	. ;
	. if ($piece(YKEY,",",YI)'="") && (fixedInput=0) && ($piece(YFKEY,",",$$$WWW121DefaultVariableInput(objFormKey))="") do  quit
	. . set $piece(YFKEY,",",fixedInput) = $piece(YKEY,",",YI)
	. . ; FIXME : fixedInput=0 !!! Should this be copying the YI piece to the YI piece? <GRF>
	. ;
	. if ($piece(YKEY,",",YI)'="") && (+fixedInput'=0) do  quit 
	. . if $piece(YFKEY,",",fixedInput)="" set $piece(YFKEY,",",fixedInput) = $piece(YKEY,",",YI)
	. ;
	. quit:$piece(YFKEY,",",YI)'=""
	. ;
	. ;------------------------------------- When YKEY has a null value for this key
	. ;
	. if $$$WWW121DefaultVariableInput(objFormKey)'="" do  quit  ;SETZEN FIXKEY ;typeset 
	. . new YINH]]><![CDATA[ALT
	. . set YINHALT = $$$WWW121DefaultVariableInput(objFormKey)    ;VORGABE ;default 
	. . set $piece(YFKEY,",",YI) = YINHALT
	. . if +YINHALT=0 do
	. . . set $piece(YFKEY,",",YI)=YINHALT
	. . . ; FIXME JW - this will cause a syntax error. Should be calling CalculateString^WWWFORMD
	. . . if ($extract(YINHALT)="@") && $data(@($extract(YINHALT,2,99))) do
	. . . . set YINHALT = @($extract(YINHALT,2,99))
	. . . . set $piece(YFKEY,",",YI) = YINHALT
	. . . . set $piece(YKEY,",",YI)  = YINHALT
	. ;
	. ;------------------------------------- ELSE case for previous IF test
	. ;
	. ;AUFBAU RÜCKBUTTON NUR BEIM 1. ;only 
	. set YBACK1 = $piece(YBACK,",",$length(YBACK,",")-1)
	. set YBACK2 = $piece(YBACK,",",1,$length(YBACK,",")-2)_","
	. set %("VAR","YFORM") = YBACK1
	. set %("VAR","YBACK") = YBACK2
	. set YFORM = YBACK1
	. set YBACK = YBACK2
	
	;--------------------------------------- vvvvv  EARLY EXIT BLOCK
	; User Validation
	;---------------------------------------
	if YUSER=""                                         do ^WWWINFO($$^WWWTEXT(5)) quit   ; "Access Denied!"   FALSCHER USER
	if $$$WWWUSERUser1($get(^WWWUSER(0,YUSER,1)))'=YBED do ^WWWINFO($$^WWWTEXT(5)) quit
	if '$data(^WWW013(0,YBED)) set YUSER=""             do ^WWWINFO($$^WWWTEXT(5)) quit
	
	set YVORB = $get(^WWW013(0,YBED,1))   ;User Defaults
	if '$$CHECK^WWWPWDCHECK($$$WWWUSERUser1(YVORB),YPWD) set YUSER="" do ^WWWINFO($$^WWWTEXT(5)) quit
	if $$$WWW013TerminationOn(YVORB)'="" if $$$WWW013EmployeeCategory(YVORB)'=999 if $horolog>$$$WWW013TerminationOn(YVORB) do ^WWWINFO($$^WWWTEXT(5)) quit  ;GEKÜNDIGT  ;TYBD;3,12,2003 ; SR15492
	if YUSER="" do ^WWWINFO($$^WWWTEXT(5)) quit
	
	;------------------------------------------------------------------------
	;USER @net Manager
	if $extract(YFORM,1,3)="WWW" if YFORM'="WWW128" if $find("WWW00,WWW12,WWW13",$extract(YFORM,1,5)) if $$^WWWKEY($get(YIPADDR))=0 do ^WWWINFO($$^WWWTEXT(412)) quit  ;KEINE LIZENZ ;no licence 
	
	;--------------------------------------- ^^^^^  EARLY EXIT BLOCK
	
	;------------------------------------------------------------------------
	
	set YBER  = $$$WWW013UserAccess(YVORB)
	set YMOD  = $$$WWW013Module1(YVORB)
	
	; Use or update last form used by user     ;LETZTE FORM DES USER
	if YFORM="" set YFORM = $$$WWW013LastFormUsed(YVORB)
	
	if YFORM="WWW120" {      ; FIXME : Should not be updating user masterfile with Audit log details <GRF>
		set $$$WWW013LastFormUsed(^WWW013(0,YBED,1)) = $piece($get(YKEY),",",1)
	} else {
		set $$$WWW013LastFormUsed(^WWW013(0,YBED,1)) = YFORM
	}
	
	if YFORM=""                 do ^WWWINFO($$^WWWTEXT(35)_"()")           quit    ;KEINE FORM   ; "No Form Default"
	if '$data(^WWW120(0,YFORM)) do ^WWWINFO($$^WWWTEXT(35)_" ("_YFORM_")") quit    ;FALSCHE FORM ; bad form 
	
	set YI = $get(^WWW1205(0,YFORM,dteToday,1))+1
	set ^WWW1205(0,YFORM,dteToday,1) = YI                           ;ANZAHL DER ZUGRIFFE PER DATUM ;Number the Date 
	
	;BEC;24415;28.10.03;SETZTEN ZUGRIFF PRO USER 
	set YI = $get(^WWW1205B(0,YFORM,YBED,dteToday,1))+1
	set ^WWW1205B(0,YFORM,YBED,dteToday,1) = YI  ;ANZAHL DER ZUGRIFFE PER DATUM/YBED ;Number the 
	
	;------------------------------------------------------------------------
	do ^WWWFORMX        ; Set Form Values from Company Defaults
	;+++++++++++++++++++++++++++++++++++++++
	; Returns
	;	YVOR		objWWW120		Form details (with Company Defaults)
	;	YVOR1		objWWW012		Company details
	;	YVORB		objWWW013		Users
	;+++++++++++++++++++++++++++++++++++++++
	
	if $data(YAENBER) if +YAENBER'=0 set $$$WWW120AuthorizationToModifyData(YVOR) = YAENBER  ;AENDERUNGSBERECHTIGUNG
	
	;SPEZIALVARIABLE ZUGANG FÜR BETRIEBE;TYBD;23957;28.07.2003
	;	D104	$$$WWW013AllowedLocations()
	;	D32		$$$WWW012VariableNameForLocationCh() [eck]
	if $$$WWW012VariableNameForLocationCh(YVOR1)'="" if $translate($piece(YVORB,Y,104),";,")'="" if $get(@($piece(YVOR1,Y,32)))'="" if $data(^WWW0121(0,0,@($piece(YVOR1,Y,32)))) if '$find(","_$translate($piece(YVORB,Y,104),";",",")_",",","_@($piece(YVOR1,Y,32))_",") do ^WWWINFO($$^WWWTEXT(5)) quit
	; "Access Denied!"
	
	;------------------------------------------------------------------------
	;MODULE/BERECHTIGUNG
	;HEVA-788 if $$^WWWACCESS($$$WWW120UserAccess(YVOR),$$$WWW120Modules(YVOR))'=1 if '$data(^WWWUSE(0,YUSER,YFORM,"A",1)) do ^WWWINFO($$^WWWTEXT(5)) quit
	;HEVA-788 if $$^WWWACCESS($$$WWW120DUserAccess($get(^WWW120D(0,YFORM,0,1))),$$$WWW120Modules(YVOR))'=1 if '$data(^WWWUSE(0,YUSER,YFORM,"A",1)) do ^WWWINFO($$^WWWTEXT(5)) quit
	if $$^WWWACCESS($$$WWW120UserAccess(YVOR)_";"_$$$WWW120DUserAccess($get(^WWW120D(0,YFORM,0,1))),$$$WWW120Modules(YVOR))'=1 if '$data(^WWWUSE(0,YUSER,YFORM,"A",1)) do ^WWWINFO($$^WWWTEXT(5)) quit ;HEVA-788
	; "Access Denied!"
	;------------------------------------------------------------------------
	
	// Definition of: YKOPF, YNAME, YFOART, YDATEI
	
	if $get(YUSENAME) set YMENUNAME=$get(YNAME) ;CORE-291
	set YKOPF = $$^WWWFORMNAME(YFORM)
	
	set YNAME = YKOPF
	set objWWW120D = $get(^WWW120D(0,YFORM,0,1))
	if $$$WWW120OnBeforeFormConstruction(YVOR)'="" {
		xecute $$$WWW120OnBeforeFormConstruction(YVOR)          ;*** EXECUTE 2a ***
		set YNAME = YKOPF
	}
	if $$$WWW120DOnBeforeFormConstruction(objWWW120D)'="" {
		//$$$Alert($$$WWW120DOnBeforeFormConstruction(objWWW120D))
		set ^zzDebug = $$$WWW120DOnBeforeFormConstruction(objWWW120D)
		xecute $$$WWW120DOnBeforeFormConstruction(objWWW120D)   ;*** EXECUTE 2b ***
		set YNAME = YKOPF
	}
	if YNAME="" set YNAME = YKOPF
	
	set YFOART = $$$WWW120FormType(YVOR)         ;FORMULARART
	if YFOART="" set YFOART=2                  ;DFLT
	
	set YDATEI = $$$WWW120ClassUsedInForm(YVOR) 
	
	;+++++++++++++++++++++++++++++++++++++++
	; YFOART	Form Type		(SysApp "FORMULARART")
	;
	;   1 : Standard Form					*Class
	;   2 : List Generator				
	;   3 : Grid Form						*Class
	;   4 : Manual Input (with Button)		
	;   5 : Manual Input (without Button)	
	;   6 : Menu Input Type					
	;   7 : Search Engine	
	;   8 : Wizard							
	;   9 : BitMap Search					
	;  10 : Gantt Chart						
	;  11 : Edit Table						
	;  12 : Grid Edit Only					?Class?
	;+++++++++++++++++++++++++++++++++++++++

	; FIXME : Should test type 12 too?
	if (YFOART=1) || (YFOART=3) if YDATEI="" do ^WWWINFO($$^WWWTEXT(33)) quit  ; "No Class Defined"   FALSCHE FORGABE
	
	set YFELD = ""
	
	;------------------------------------------------------------------------
	;WENN LOESCHEN EINES DATENSATZES ;when deleting a record
	set strStatus  = $$$OK
	set strOldYKEY = YKEY
	
	if YDATEI'="" {
		set YMAXKEY = +$order(^WWW002(0,YDATEI,""),-1)
		if YMAXKEY=0 set YMAXKEY = 1
		
		if (YKILL=1) && (YKEY'="") {
			set strStatus = $$^WWWKILL(YDATEI,YKEY)
			if $get(YTIMEFORM)'=1 {
				if YFOART'=3 {
					set YKEY  = ""
					set YFELD = ""
					if YFKEY'="" {
						set YKEY=YFKEY
					}
				} else {             ; Grid Form
					new YXKEY               ; note: this works differently to NEW in original dot syntax - should be as subroutine to match
					set YXKEY = YKEY
					set YKEY  = ""
					set YFELD = ""
					if YFKEY'="" set YKEY = YFKEY
					if $piece(YXKEY,",",YMAXKEY)'="" set YKEY = $piece(YXKEY,",",1,YMAXKEY-1)
				}
				kill ^WWW126(0,YFORM,YBED)
				kill ^WWW126(0,YFORM,YUSER)
			} 
		}
	}
	
	if $$$ISERR(strStatus) {
		if (strStatus = $$$NO) {  //no error text
			set YKEY = strOldYKEY
		} else {
			$$$Error(strStatus)
			quit                                 ; *** EARLY EXIT ***
		}
	}
	
	; New Form On Deletion -> Quit
	if ($get(YFORM)'="") && (YKILL=1) {
		set objWWW120 = $get(^WWW120(0,YFORM,1))
		set idNewForm = $$$WWW120NewFormOnDeletion(objWWW120)
		if (idNewForm'="") {
			if $$$WWW120NewFormKey(objWWW120)'="" {
				set strNewKey = $$CalculateString^WWWFORMD($$$WWW120NewFormKey(objWWW120),YFORM)
			} else {
				set strNewKey = ""	
			}
			set NOKILL = $$$YES
			set YFORM  = ""
			do GoToForm^COMUtilForm(idNewForm,strNewKey)
			quit                                 ; *** EARLY EXIT ***
		}	
	}
	
	;------------------------------------------------------------------------
	;WENN NEUE RICHTUNG (NEXT,LAST, FIRST,...)
	set $$$WWWUSERYOPTION(^WWWUSER(0,YUSER,1))=$get(YOPTION) ;CORE-307
	if (YKILL'=1) && (YRICHT'="") {
		set $$$WWWUSERLastFormfield(^WWWUSER(0,YUSER,1))=""
		do ^WWWFORMS  ;NEXT DATENSATZ ;data record
	}
	
	
	$$$LOGWWWBENCH(2)
	
	;------------------------------------------------------------------------
	;ALTE LOCK DATEIEN AUFHEBEN  WENN KEINE UNTERFORM ;repeal when no 
	;
	;  Form WWWPARA : Parameter Selection - calls Routine ^WWWPARA and from there
	;  can access form COMViewSearch and subroutine AfterDataFields^COMViewFilter.
	;------------------------------------------------------------------------
	
	if ($extract(YFORM,1,7)'="WWWPARA") && (YFKEY="") set YA = "" for  set YA = $order(^WWW006(0,YA)) quit:YA=""  do
	. if +YA'=dteToday kill ^WWW006(0,YA) kill ^WWW0061(0,YA) quit  ;LÖSCHEN ALTE LOCKFILE;FIS;19.04.04;LÖSCHEN LOCK RÜCKHOLINFO
	. new YA1  ;LOSCHEN ALLE EINTRÄGE WENN LEERES FELD ;when field 
	. if $get(YDATEI)'="" do
	. if $get(YDATEI)'="" || ($get(YLOCKKILL)=1) do  ;SR15824 ;force lock kill
	. . set YA1 = ""
	. . for  set YA1 = $order(^WWW006(0,dteToday,YA1)) quit:YA1=""  set YA(1) = $get(^WWW006(0,dteToday,YA1,1)) do
	. . . if $piece(YA(1),Y,1)=YUSER do
	. . . . if $piece($get(^WWWUSER(0,YUSER,1)),Y,25)'="" set ^WWW0061(0,dteToday,YA1,$piece($get(^WWWUSER(0,YUSER,1)),Y,25),1) = $get(^WWW006(0,dteToday,YA1,1))
	. . . . kill ^WWW006(0,dteToday,YA1)
	
	if $piece($get(^WWWUSER(0,YUSER,1)),Y,25)'="" do  ;RÜCKHOLEN LETZTER LOCK;FIS;19.04.04;25534
	. new YTRAKTOLD,YA1,YA
	. set YTRAKTOLD = $piece($get(^WWWUSER(0,YUSER,1)),Y,25)
	. ;SPEICHERN LOCK FALLS NICHT OBEN PASSIERT (WENN YFKEY'="")
	. set YA1 = ""
	. for  set YA1 = $order(^WWW006(0,dteToday,YA1)) quit:YA1=""  set YA(1) = $get(^WWW006(0,dteToday,YA1,1)) do
	. . if $piece(YA(1),Y,1)=YUSER set ^WWW0061(0,dteToday,YA1,YTRAKTOLD,1) = $get(^WWW006(0,dteToday,YA1,1))
	. ;
	. set YA1 = ""
	. for  set YA1 = $order(^WWW0061(0,dteToday,YA1)) quit:YA1=""  do
	. . if $data(^WWW0061(0,dteToday,YA1,YTRAKTOLD)) do
	. . . set YA(1) = $get(^WWW0061(0,dteToday,YA1,YTRAKTOLD,1))
	. . . if $piece(YA(1),Y,1)=YUSER if ($piece(YA(1),Y,2)+300)>$piece($horolog,",",2) do  quit  ;PRÜFEN OB NOCH GÜLTIG (MAX. 5 MINUTEN) ;sift whether yet valuable 
	. . . . if '$data(^WWW006(0,dteToday,YA1)) set ^WWW006(0,dteToday,YA1,1) = $get(^WWW0061(0,dteToday,YA1,YTRAKTOLD,1))  ;LOCK ZURÜCKSETZTEN
	. . . ;
	. . . kill ^WWW0061(0,dteToday)  ;LÖSCHEN WENN UNGÜLTIG ;Delete when 
	. . . set $piece(^WWWUSER(0,YUSER,1),Y,25) = ""
	
	$$$LOGWWWBENCH(3)

	;------------------------------------------------------------------------	SETS YBEARB -------
	set YBEARB=1  ;BEARBEITUNGSTATUS NEUER DATENSATZ ;data record 
	if YTRAKT0=1 set YBEARB=7   ;UNERLAUBTER RUECKSPRUNG
	
	;---------------------------------------
	;   Manage Keys
	;---------------------------------------
	
	;------------------------------------------------------------------------   *** EXECUTE 3 ***
	;DATENSATZ LESEN/PRUEFEN U. LOESCHEN WENN FEHLERERFASSUNG ;data record when 
	if YOPEN'="OLD" if $$$WWW121DefaultVariableInput($get(^WWW121(0,YFORM,1,1)))'="" do   ;VORGABE DES KEY ;default KEY 
	. if '$data(^WWW121(0,YFORM,2,1)) do
	. . quit:+$$$WWW121FixedInputForHiddenField($get(^WWW121(0,YFORM,1,1)))'=0
	. . set YKEY = $$$WWW121DefaultVariableInput($get(^WWW121(0,YFORM,1,1)))
	. . if $extract(YKEY)="@" if $extract(YKEY,2)'="$" set YKEY = $get(@($extract($$$WWW121DefaultVariableInput($get(^WWW121(0,YFORM,1,1))),2,99)))
	. . if $extract(YKEY)="@" if $extract(YKEY,2)="$"  xecute "SET YKEY="_$extract(YKEY,2,99)
	
	;------------------------------------------------------------------------
	;WER AUS SORTKEYSUCHE MANUELLES DATENFELD; SUCHE IN DATENFELD, SAVE UND NEUE ANZEIGE
	if $data(^WWWSOR("SORTKEY",dteToday,YUSER,YFORM,1)) {
		set YKEY = ^WWWSOR("SORTKEY",dteToday,YUSER,YFORM,1)
		kill ^WWWSOR("SORTKEY",dteToday,YUSER,YFORM,1)            ;VORGABE AUS WWWEVENT ;default out of 
	}
	
	;------------------------------------------------------------------------
	;WERTE VON VORHERIGER  - Previous Values
	if YMAXKEY'=0 if YDATEI'="" if YRICHT="" if $get(YRETURN)=1 if $data(^WWW126(0,YFORM,YUSER)) do  
	. new YI
	. for YI=1:1:YMAXKEY if $get(^WWW126(0,YFORM,YUSER,YI,1))'="" set $piece(YKEY,",",YI) = ^WWW126(0,YFORM,YUSER,YI,1)
	
	;---------------------------------------
	;   Record Storage (WWWDATEN)
	;---------------------------------------
	
	;---------------------------------------
	; FIXME : <GRF> Should the second $h test be (YI+1)'=+$h or YI'=($h-1) instead?
	;         If a record is created shortly before midnight on 60001 then it will be
	;         ^WWWDATEN(0,60001).  Comparing against $h will check firstly when
	;         60001'=60001 before midnight and 60001'=60002 after midnight.
	;         In the latter case we might also wish to check it hasn't got yesterday's
	;         date i.e. 60001'=(60002-1), instead we are looking at 60000'=60002.
	;         This is a general clean up.
	;---------------------------------------
	
	set YI = $order(^WWWDATEN(0,"")) if (YI'="") && (YI'=dteToday) && (YI-1'=dteToday) kill ^WWWDATEN(0,YI)
	
	; Save all data if only changing tabs
	if YOPEN'=2 {
		new objMSave
		set objMSave = $get(^WWWDATEN(0,dteToday,YUSER,YFORM,"M",2))
		kill ^WWWDATEN(0,dteToday,YUSER,YFORM)
		kill ^WWWDATEN(0,dteToday,YUSER,"RECORDEXIST")  ;TYBD;5,8,2004
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"M",2) = objMSave
		kill ^WWWSOR(YUSER,dteToday,"M","SAVE",2)
		set ^WWWDATEN(0,dteToday,YUSER,"RECORDEXISTS",YFORM,1)=0   //SR13195
	} else {
		kill ^WWWDATEN(0,dteToday,YUSER,YFORM,"LOCK")
	}
	
	if YTIMEFORM=1 set ^WWWDATEN(0,dteToday,YUSER,YFORM,"V","YTIMEFORM",1) = YTIMEFORM  ;DATEN ZUR PRUEFUNG;TYBD;3,11,2003;
	
	;+++++++++++++++++++++++++++++++++++++++
	;	YFELD		objWWWUSE		form backward step class
	;+++++++++++++++++++++++++++++++++++++++
	
	;------------------------------------------------------------------------
	if (YDATEI'="") && (YKEY'="") && (+YMAXKEY'=0) do   ;WENN DATEN VORHANDEN ABER KEINE OLD WERTE VORHANDEN;WAC;NUR WENN NEU NICHT WENN OPEN=OLD;28.11.2001
	. if $get(YTIMEFORM)'=1            set YKEY = $piece(YKEY,",",1,YMAXKEY)
	. if $get(YTIMEFORM)=1 if YKILL=1  set YKEY = $piece(YKEY,",",1,YMAXKEY)  ;LÖSCHEN ZEITABHÄNGIGES FORMULAR;26751;FIS;15.02.05
	. if $get(YTIMEFORM)=1 if YKILL'=1 set YKEY = $piece(YKEY,",",1,YMAXKEY+1) 
	. do ^WWWLESE(YDATEI,YKEY,1)   ;MIT TEST;TYBD;30.04.2003 ;by means of Test 
	. if $data(^WWWUSETMP(0,YUSER,YFORM)) do  ;DATEN AUS TEMP FILE ANSTELLE ORIGINAL DATEN;FIS;03.03.05;TEL.HERR WACH
	. . new YTEMP,YI
	. . set YTEMP = "^WWWUSETMP(0,"""_YUSER_""","""_YFORM_""""
	. . for YI=1:1  quit:$piece(YKEY,",",YI,99)=""  set YTEMP = YTEMP_","""_$translate($piece(YKEY,",",YI),"""")_""""
	. . set YTEMP = YTEMP_")"
	. . if $data(@YTEMP) set YFELD = @YTEMP,YYFELD = YFELD kill @YTEMP
	. ;
	. if (YKILL=2) || (YKILL=3) if YFELD="" do  quit
	. . set YFELD = $get(^WWWUSE(0,YUSER,YFORM,"D",1))
	. . set YYFELD = YFELD,YYKEY = YKEY
	. . set YOPEN  = "OLD"
	. . set YBEARB = 5
	. ;
	. if YFELD="" set YBEARB = 1 quit   ;WENN KEIN DATENSATZ VORHANDEN;DIETMAR WACH ;when no data record on hand open-eyed 
	. ;
	. set FFFELD = $get(YFELD),FFKEY = $get(YKEY),FMFELD = "",FFFORM = YFORM   ;TYBD;05.12.2001;16.05.2002
	. set YSAVEDDATA = 1  ;FLAGG = DATENDATZ GESPEICHERT
	. if YKILL'=1 do  ;WEIL DATEN NUR HALB ERFASST ;since only semi- 
	. . if YKILL=2 do ^WWWKILL(YDATEI,YKEY)
	. . set YYKEY = YKEY,YYFELD=YFELD
	. . if YKILL=2 set YBEARB = 5  ;FALSCHE ERFASSUNG ;logging 
	
	kill ^WWWUSETMP(0,YUSER)  ;TEMP FILE LÖSCHEN;FIS;25.06.04;25998

	;------------------------------------------------------------------------
	;;SEITENWECHSEL
	if $data(^WWWDUMMY(YUSER,"D")) || $data(^WWWDUMMY(YUSER,"M")) do  
	. new YI,oldStatus
	. set YBEARB = $get(^WWWDATEN(0,dteToday,YUSER,YFORM,"STATUS",1),YBEARB)
	. ;
	. set YFELD  = $get(^WWWDUMMY(YUSER,"D"))  ;ZWISCHENDATEI BEI SEITEWECHSEL OHNE SCHLÜSSEL ;BUFFER FILE WITH PAGE CHANGE WITHOUT KEYS 
	. set YMFELD = $get(^WWWDUMMY(YUSER,"M"))
	. set YI     = $get(^WWWDUMMY(YUSER,"P"))
	. set YKEY   = ""
	. for YI(1)=1:1 quit:$piece(YI,",",YI(1))=""  set:YKEY'="" YKEY = YKEY_"," set YKEY = $get(YKEY)_$piece(YI,",",YI(1))
	. new SCHLUESSEL,MAXYKEY,Q
	. set SCHLUESSEL = ""
	. if YDATEI'="" do
	. . set MAXYKEY = +$order(^WWW002(0,YDATEI,""),-1)
	. . if MAXYKEY'=]]><![CDATA[0 do
	. . . set Q = 0
	. . . if +]]><![CDATA[$get(YTIMEFORM)'=1 set YKEY = $piece(YKEY,",",1,YMAXKEY)   set SCHLUESSEL = "^"_YDATEI_"("_$$^WWWYM(YDATEI,1)   ;tybd 01.11.01
	. . . if +$get(YTIMEFORM)=1  set YKEY = $piece(YKEY,",",1,YMAXKEY+1) set SCHLUESSEL = "^"_YDATEI_"t("_$$^WWWYM(YDATEI,1)  ;tybd 01.11.01
	. . . ;
	. . . set YDATA = $get(^WWW001(0,YDATEI,1))
	. . . if $piece(YDATA,Y,12)'="" if $piece(YDATA,Y,13)'="" do  ;UCI UND VOL ;UCI And 
	. . . . quit:$find(SCHLUESSEL,"^[")
	. . . . set SCHLUESSEL = "^["""_$piece(YDATA,Y,12)_""","""_$piece(YDATA,Y,13)_"""]"_$piece(SCHLUESSEL,"^",2,999)
	. . . ;
	. . . for I=1:1:MAXYKEY set XYKEY=$translate($piece(YKEY,",",I),"""") set SCHLUESSEL = SCHLUESSEL_""""_XYKEY_"""," if (XYKEY="") || (XYKEY="+") set Q = 1 quit
	. . . if $piece(YDATA,Y,8)'=4 set SCHLUESSEL=SCHLUESSEL_"1"
	. . . if $piece(YDATA,Y,8)=4 if $extract(SCHLUESSEL,$length(SCHLUESSEL))="," set SCHLUESSEL=$extract(SCHLUESSEL,1,$length(SCHLUESSEL)-1)
	. . . set SCHLUESSEL=SCHLUESSEL_")"
	. . . if Q=0 if $data(@(SCHLUESSEL)) set YSAVEDDATA=1
	. . . if Q=0 do
	. . . . new strKEY
	. . . . set YLOCK=+$piece($get(^WWW001(0,YDATEI,1)),Y,6)
	. . . . set strKEY = $translate(SCHLUESSEL,",()""",".//")
	. . . . if YLOCK'=0 if $data(^WWW006(0,dteToday,strKEY,1)) do
	. . . . . set YA(1)=^WWW006(0,dteToday,strKEY,1)
	. . . . . if YUSER'=$piece(YA(1),Y,1) if ($piece(YA(1),Y,2)+YLOCK)>$piece($horolog,",",2) set Q=1 set YBEARB=4  ;IN USE  ;W $$^WWWTEXT(256)  ;UNERLAUBE AENDER
	. . . . ;
	. . . . if Q=0 set ^WWW006(0,dteToday,strKEY,1)=YUSER_Y_$piece($horolog,",",2)
	. . . . if YBEARB'=4 set ^WWWDATEN(0,dteToday,YUSER,YFORM,"LOCK",1)="^WWW006(0,"_dteToday_","""_strKEY_""",1)"  ; (YBEARB could be 4 from previous page -> stay readonly, don't lock)
	
	;------------------------------------------------------------------------
	;NEU ;recent 
	if $get(YKEY)="" kill ^WWWPAGE(0,YUSER)
	if +YSEITE=0 if YFELD'="" if $data(^WWWPAGE(0,YUSER,YFORM,1)) do     ;WERTE AUS VORHERIGEN DATEN ;out of 
	. set YSEITE   = $piece($get(^WWWPAGE(0,YUSER,YFORM,1)),Y,1)         ;SEITE ;tab 
	. set YINSEITE = $piece($get(^WWWPAGE(0,YUSER,YFORM,1)),Y,2)         ;UNTERSEITE
	
	if +YSEITE=0 set YSEITE=1    ;MINDESTENS DIE SEITE 1 ;who side 
	if $data(^WWW122(0,YFORM)) if '$data(^WWW122s(0,1,YSEITE,YFORM)) if '$data(^WWW1203(0,YFORM,SPRACHE,YSEITE)) set YSEITE=1   ;WENN SEITE AUS VORDATEI GRÖßER DANN ERSTE SEITE  ;ODER WWW1203(0,YFORM,... TYBD; 16,12,2003
	
	;+++++++++++++++++++++++++++++++++++++++
	;	YDATA		objWWW001		Data Dictionary
	;+++++++++++++++++++++++++++++++++++++++ 
	;------------------------------------------------------------------------
	;NUR LESEBERECHTIGUNG ;only 
	if $$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly set YBEARB=8
	set YKILL=""
	if YOPEN="OLD" set YKEY=YYKEY,YFELD=YYFELD do  ;ALTE WERTE
	. new SCHLUESSEL,MAXYKEY,Q
	. set SCHLUESSEL=""
	. if YDATEI'="" do
	. . set MAXYKEY = +$order(^WWW002(0,YDATEI,""),-1)
	. . if MAXYKEY'=0 do
	. . . set Q=0
	. . . set SCHLUESSEL="^"_YDATEI_"("_$$^WWWYM(YDATEI,1)
	. . . set YDATA=$get(^WWW001(0,YDATEI,1))
	. . . if $piece(YDATA,Y,12)'="" if $piece(YDATA,Y,13)'="" do  ;UCI UND VOL ;UCI And 
	. . . . quit:$find(SCHLUESSEL,"^[")
	. . . . set SCHLUESSEL="^["""_$piece(YDATA,Y,12)_""","""_$piece(YDATA,Y,13)_"""]"_$piece(SCHLUESSEL,"^",2,999)
	. . . ;
	. . . for I=1:1:MAXYKEY set XYKEY=$translate($piece(YKEY,",",I),"""") set SCHLUESSEL=SCHLUESSEL_""""_XYKEY_"""," if XYKEY="" set Q=1 quit
	. . . if $piece(YDATA,Y,8)'=4 set SCHLUESSEL=SCHLUESSEL_"1"
	. . . if $piece(YDATA,Y,8)=4 if $extract(SCHLUESSEL,$length(SCHLUESSEL))="," set SCHLUESSEL=$extract(SCHLUESSEL,1,$length(SCHLUESSEL)-1)
	. . . set SCHLUESSEL=SCHLUESSEL_")"
	. . . if Q=0 if $data(@(SCHLUESSEL)) set YSAVEDDATA=1
	. . . if Q=0 do
	. . . . new strKEY
	. . . . set YLOCK=+$piece($get(^WWW001(0,YDATEI,1)),Y,6)
	. . . . set strKEY = $translate(SCHLUESSEL,",()""",".//")
	. . . . if YLOCK'=0 if $data(^WWW006(0,dteToday,strKEY,1)) do
	. . . . . set YA(1)=^WWW006(0,dteToday,strKEY,1)
	. . . . . if YUSER'=$piece(YA(1),Y,1) if ($piece(YA(1),Y,2)+YLOCK)>$piece($horolog,",",2) set Q=1 set YBEARB=4
	. . . . ;
	. . . . if Q=0 set ^WWW006(0,dteToday,strKEY,1) = YUSER_Y_$piece($horolog,",",2)
	. . . . set ^WWWDATEN(0,dteToday,YUSER,YFORM,"LOCK",1) = "^WWW006(0,"_dteToday_","""_strKEY_""",1)"
	
	;------------------------------------------------------------------------
	// WWWDATEN is populated - if not changing tabs
	
	set KEYKEY   = $translate(YKEY,"""")
	set FELDFELD = YFELD
	
	if (YOPEN'=2) {	//SR13195
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"P",1) = $get(YKEY)   ;Defaults
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"P",2) = $get(YKEY)
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"D",1) = $get(YFELD)  ;snapshot of data (working record to save any user or program changes before saving)
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"D",2) = $get(YFELD)  ;snapshot of data (backup record to undo changes. Caution: gets changed in WWWFORM9 to include default data changes during form load)
	;	set ^WWWDATEN(0,dteToday,YUSER,YFORM,"D",3) = $get(objStoredData,$get(YFELD))  ;SR15828: snapshot of data before form load and before any executes (calls)
		set ^WWWDATEN(0,dteToday,YUSER,YFORM,"M",1) = $get(YMFELD)
	}
	
	;------------------------------------------------------------------------
	;AUFRUF KEINE ÄNDERUNG, WENN DATENFELD BELEGT (RECHNUNGSNUMMER=KEINE ÄNDERUNG MEHR)
	if $$$WWW120ReadOnlyWhenDataFieldIsIn(YVOR)'="" do
	. new NICHTFELD,YI
	. set NICHTFELD = $translate($$$WWW120ReadOnlyWhenDataFieldIsIn(YVOR),";",",")
	. for YI=1:1 quit:$piece(NICHTFELD,",",YI)=""  do
	. . quit:$translate($piece(YFELD,Y,$piece(NICHTFELD,",",YI))," "_$char(0))=""  ;DATENFELD=LEER;TYBD;4,2,2005
	. . set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly
	
	;------------------------------------------------------------------------
	;AUFRUF KEINE ÄNDERUNG, WENN MITARBEITER EIN BESTIMMTES MODUL HAT
	set objWWW120D = $get(^WWW120D(0,YFORM,0,1))
	
	if $$$WWW120ReadOnlyAccessForModules(YVOR)'="" && $length($$$WWW120DReadOnlyAccessForModules(objWWW120D))=0 do
	. new MODUL,MODUL1,YI
	. set MODUL = $$^WWWBEDMOD(YBED)
	. quit:MODUL=""
	. quit:+$$^WWWBEDBER(YBED)=1     
	. set MODUL1 = $translate($$$WWW120ReadOnlyAccessForModules(YVOR),";",",")
	. if $extract(MODUL1)="," set MODUL1 = $extract(MODUL1,2,999)  ;tybd;1.9.2003
	. if $extract(MODUL1)="," set MODUL1 = $extract(MODUL1,2,999)
	. for YI=1:1 quit:$piece(MODUL1,",",YI)=""  do
	. . quit:$piece(MODUL1,",",YI)=""
	. . if $find(","_MODUL_",",","_$piece(MODUL1,",",YI)_",") set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly
	
	if $$$WWW120DReadOnlyAccessForModules(objWWW120D)'="" do
	. new MODUL,MODUL1,YI
	. set MODUL = $$^WWWBEDMOD(YBED)
	. quit:MODUL=""
	. quit:+$$^WWWBEDBER(YBED)=1     
	. set MODUL1 = $translate($$$WWW120DReadOnlyAccessForModules(objWWW120D),";",",")
	. if $extract(MODUL1)="," set MODUL1 = $extract(MODUL1,2,999)  
	. if $extract(MODUL1)="," set MODUL1 = $extract(MODUL1,2,999)
	. for YI=1:1 quit:$piece(MODUL1,",",YI)=""  do
	. . quit:$piece(MODUL1,",",YI)=""
	. . if $find(","_MODUL_",",","_$piece(MODUL1,",",YI)_",") set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly

	;; Acesso somente leitura no perfil de acesso
	if $$$WWW120ViewAccess(YVOR)'="" && $length($$$WWW120DViewAccess(objWWW120D))=0 do
	. new PERFIL,PERFIL1,YI
	. set PERFIL = $$^WWWBEDBER(YBED)
	. quit:PERFIL=""
	. quit:+$$^WWWBEDBER(YBED)=1     
	. set PERFIL1 = $translate($$$WWW120ViewAccess(YVOR),";",",")
	. if $extract(PERFIL1)="," set PERFIL1 = $extract(PERFIL1,2,999)  ;tybd;1.9.2003
	. if $extract(PERFIL1)="," set PERFIL1 = $extract(PERFIL1,2,999)
	. for YI=1:1 quit:$piece(PERFIL1,",",YI)=""  do
	. . quit:$piece(PERFIL1,",",YI)=""
	. . if $find(","_PERFIL_",",","_$piece(PERFIL1,",",YI)_",") set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly
	
	;; Acesso somente leitura no perfil de acesso
	if $$$WWW120DViewAccess(YVOR)'="" do
	. new PERFIL,PERFIL1,YI
	. set PERFIL = $$^WWWBEDBER(YBED)
	. quit:PERFIL=""
	. quit:+$$^WWWBEDBER(YBED)=1     
	. set PERFIL1 = $translate($$$WWW120DViewAccess(YVOR),";",",")
	. if $extract(PERFIL1)="," set PERFIL1 = $extract(PERFIL1,2,999)  ;tybd;1.9.2003
	. if $extract(PERFIL1)="," set PERFIL1 = $extract(PERFIL1,2,999)
	. for YI=1:1 quit:$piece(PERFIL1,",",YI)=""  do
	. . quit:$piece(PERFIL1,",",YI)=""
	. . if $find(","_PERFIL_",",","_$piece(PERFIL1,",",YI)_",") set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly

	
	;+++++++++++++++++++++++++++++++++++++++
	;	SONDERFUNKTION EXECUTE ANSTELLE FORMULARAUFBAU   *** EXECUTE 4 ***
	;	
	;	Execute special function instead of normal form layout
	;------------------------------------------------------------------------
	set strExec = $$$WWW120ExecuteAfterButtonLine(YVOR)
	
	if $extract(strExec)="#" do  quit  ;Manual call
	. xecute $extract(strExec,2,99)  ;EXECUTE VOR FORMULAR ;EXECUTE pre- form 
	
	;	SONDERFUNKTION EXECUTE FOR FORMULARAUFBAU  ;FIS;27442;03.03.05
	;------------------------------------------------------------------------
	if $extract(strExec)="*" new Q do  quit:$get(Q)=1      ;MANUELLER AUFRUF
	. xecute $extract(strExec,2,99)                        ;EXECUTE VOR FORMULAR
	. if $get(Q)=1 set %("VAR","YKEY")="" do ^WWWFORM      ;NEU LADEN

	;+++++++++++++++++++++++++++++++++++++++
	; Form Type *NOT*
	;  2 : List Generator
	;  5 : Manual Input (without Button)
	;  8 : Wizard
	;+++++++++++++++++++++++++++++++++++++++
	;	D66		$$$WWW120PositioningOfButtonLine()
	;	D123	$$$WWW120SaveServerdata()
	;+++++++++++++++++++++++++++++++++++++++
	;START HTML ;take-off HTML 
	;------------------------------------------------------------------------
	if (YFOART'=2) && (YFOART'=6) && (YFOART'=8) && (+$$$WWW120SaveServerdata(YVOR)=$$$YES) do
	. if +$$$WWW120PositioningOfButtonLine(YVOR)'=1 set YHTMFORM="WWW2"  ;2. FORM FÜR FAST SAVE  NUR WENNKEIN BUTTON UNTEN ;shape to next only underneath 
	
	$$$LOGWWWBENCH(4)
	
	
	;+++++++++++++++++++++++++++++++++++++++
	; 10 : GANTT CHART
	;+++++++++++++++++++++++++++++++++++++++    ; ***   EARLY EXIT   ***
	if YFOART=10 do  quit
	. do ^WWWDRAGDROP(YFORM)
	. do OPEN^WWWSTART
	. write "</FONT>",YCR
	. do ^WWWSTOP
	
	set ^WWWSOR(YUSER)=""
	;***************************************
	lock +^WWWSOR(YUSER):3           ;NUR EIN JOB ;only uni- 
	;***************************************
	do ^WWWSTART(YNAME,1,$$$WWW120RefreshSeconds(YVOR))
	
	;---------------------------------------
	;   *** EXECUTE 5ab - 6ab ***
	;---------------------------------------
	set strHookStatus = $$ExecuteHook^WWW001Hook(YDATEI,$$$EnumWWWEVENTTYPEOnBeforeEditAccess,YKEY,$get(YFELD),YFORM)
	if $$$ISOK(strHookStatus) if '$$$NoKey(YKEY) set strHookStatus = $$ExecuteHook^WWW001Hook(YDATEI,$$$EnumWWWEVENTTYPEOnFilter,YKEY,$get(YFELD),YFORM)  ;BR014726
	if $$$ISERR(strHookStatus) set $$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly 
	set ^WWWDATEN(0,dteToday,YUSER,YFORM,"V","AUTHORISATION",1) = $$$WWW120AuthorizationToModifyData(YVOR) ;BR014955
	
	do ^WWWFORM8                ;JAVA
	do ^WWWBODY(1,"NOPRINT")    ;BODY TAG
	set YREFRKEY = $get(YKEY)   ;KEY FÜR REFRESH PRÜFUNG;FIS;24.08.04 ;KEY to REFRESH check
	do START                                ; *** EXECUTES ***
	
	;***************************************
	lock -^WWWSOR(YUSER)
	;***************************************
	do STOP
	; snapshot of saved data after form load and after all executes (calls)
	if ($get(YDATEI)'="") && ($get(YKEY)'="") {
		xecute "set objStoredData=$get(^"_YDATEI_"("""_$$^WWWYM(YDATEI)_""","_$$^WWWKEYBUILD(YKEY)_",1))"
	}
	set ^WWWDATEN(0,dteToday,YUSER,YFORM,"D",4) = $get(objStoredData,$get(YFELD))
	
	if $get(YMOUSETR)=$$$YES do BODY^WWWTRAIL

	$$$LOGWWWBENCH(5)
	
	if $get(^SysSetup("WWWEVENT","Watch","Session"))=YUSER && $get(^SysSetup("WWWEVENT","Watch","LogForm")) {
		set xxIO=^SysSetup("WWWEVENT","Watch","io")
		set xxFile=$get(^SysSetup("WWWEVENT","Watch","TempFile"))
		set xxFileLog=$get(^SysSetup("WWWEVENT","Watch","LogFile"))
		if $zu(68,40,1)
		open xxFileLog:"asw"
		use xxFileLog
		close xxFile

		open xxFile:"rs" 
		for { 
			use xxFile 
			read *x 
			quit:$zeof  
			use xxIO 
			write *x
			use xxFileLog 
			write *x
			write:x=59 !
		}
		use xxIO 
		close xxFile
		close xxFileLog
	}
	
	;SR17998 if ($get(YBED)'="") && (YFORM'="") set ^WWWBENCH(0,dteToday,YSTARTTIME1,YFORM,YBED,1) = $zhorolog-YSTARTTIME  ;SAVE BENCHMARK
	if ($get(YBED)'="") && (YFORM'="") new strStatus set strStatus=$$Save^COMUtils("WWWBENCH",dteToday_","_YSTARTTIME1_","_YFORM_","_YBED,$zhorolog-YSTARTTIME,0)  ;SAVE BENCHMARK ;SR17998 
	quit
	
	
ExecButton(YFORM,YBUTTON,YOPEN) private
	;-------------------------------------------------------------------------------
	;
	; History:
	; 05-Jul-2007	GRF		YEXEC *must* be non-null so no need to re-test.
	; 02-May-2007	GRF		SR15509: YEXEC being newed incorrectly - move code to
	; 							ExecButton.
	;-------------------------------------------------------------------------------
	new YEXEC
	
	;   *** EXECUTE 2 ***
	
	if (YFORM'="") && (YBUTTON'="") {
		set YEXEC = $$$WWW124ExecuteAfterBackwardStep($get(^WWW124(0,YFORM,SPRACHE,YBUTTON,1)))
		if YEXEC="" set YEXEC = "d ^WWWSBUR"                       ;AUTORÜCKSPRUNG    ;AutoReturn
		if YOPEN'="OLD" xecute YEXEC               ;05-Jul-2007
	}
	quit
	
	
START
	;-------------------------------------------------------------------------------
	; START FORM  (ACHTUNG EINSPRUNG) ;take-off shape
	;              ANZEIGEN DES FORMS ERST NACH DEM ENDE
	; 
	; Called By: ^WWWFORM, FORM^WWWHPR, FORM^WWWHPR1
	; 
	; History:
	; 13-Mar-2014	shobby	CHROME: Corrected issue with Form display
	; 11-Jun-2013	shobby	CORE-108.3: Save data into WWW1265
	; 07-Jun-2013	shobby	CORE-116.3: Scrollbar fix suggested by Thiago and Lucas
	; 29-May-2013	shobby	CORE-115: Can't get Opacity working in IE8
	; 28-May-2013	shobby	CORE-115: Animated GIF will SaveLayer is active.
	; 02-Dec-2009	shobby	SR16943: Give an id to the div used with the FixedHeader
	;							so it can be used later to determine the position of
	;							the popup help message.
	; 01-Dec-2009	shobby	SR17065: If there are no fields on the form don't call
	;							out to WWWFORMH.  This just screws up the
	;							positioning of any forms drawn in OnAfterDataFields
	;							as a table is closed without being opened. 
	; 23-Oct-2008	shobby	SR15878: Removed DEVMODE condition
	; 01-Sep-2008	FIS		SR15878: layer to disable form after save click
	; 18-Jan-2008	GRF		SR15619: boolean macros and tidy parentheses
	; 14-Jan-2008	FIS 	SR15619: replaced it again -> new: set grid form always
	;							to "show frame"
	; 14-Jan-2008	GRF		SR15619: brace rather than dot syntax
	; 10-Jan-2008	FIS		SR15619: also start table if "framed forms" is set to NO
	; 02-Oct-2007	shobby	SRBR014726: Callback OnFilter may optionally either
	; 							specify that 1) a record can not be viewed.
	; 							Or 2) That it can be viewed but readonly.
	; 							When opening it from the normal form.
    ; 27-Sep-2007	GRF		SR15603: Macro change
	; 02-May-2007	GRF		SR15509: Consider null & zero when testing for Boolean.
	; 22-Mar-2007	JW		SR15453: Cache YOPTION, YOPTION1
	; 14-Dec-2006	Steve S	SR15316: Hook Status Check
	; 05-Dec-2006	Steve S	BR014333: If a record's in use, lock the entire form.
	; 09-Nov-2006	Steve S	SR14710: Pass in YFELD/YKEY to var hooks
	; 26-Sep-2006	PO		SR14864: Added logging
	; 11-Sep-2006	Steve S	SR14286: Use $$DrawTabs, not subscript "2" check.
	; 06-Jul-2006	SC		SR14710: Added OnBeforeEditAccess VARHook check.
	; 05.Aug.1997	DT		DITMAR TYBUSSEK: Created
	;-------------------------------------------------------------------------------
	new strExec
	
	$$$LogR("START",$get(YFORM)_"<"_$get(YPARA)_"<")
	
	;#######################################
	;if $get(YFIXHEADER)'=1 do
	;. write "<TABLE BORDER=0 cellspacing=0 cellpadding=0 WIDTH=""100%""><TR><TD>" 
	;. set YTABLEANZ=$get(YTABLEANZ)+1
	
	if $get(YFIXHEADER)=$$$YES {
		set YTABLEANZ = $get(YTABLEANZ)+1
		write "<TABLE id='xxx' cellspacing=0 style='BORDER:0px; padding:0px; height:99%; WIDTH:100%;'><TR height=""4px"" width=""100%""><TD>" ;CHROME
	}
	;#######################################
	
	if YKEY'="" set YFKEY = "" set YLFN = "" for  set YLFN = $order(^WWW121(0,YFORM,YLFN)) quit:YLFN=""  do   ;DEF FIXKEY
	. if $piece($get(^WWW121(0,YFORM,YLFN,1)),Y,16)="" set YLFN="ZZZZZ" quit
	. set $piece(YFKEY,",",YLFN) = $trans]]><![CDATA[late($piece(YKEY,",",YLFN),"""")
	
	;------------------------------------------------------------------------
	do ^WWWHIDD   ; Start <FORM> & preserve variables as hidden <INPUT> fields
	
	$$$LOGWWWBENCH(10)
	
	if (+$$$WWW120PicturesAsButtons(YVOR)=$$$YES) {  //SR15878; layer to disable form  D45
		;CORE-115 vvvvvv
		write "<div id='HideButtons' style='"
		write " top:-100px;"
		write "width:100%; position:absolute; overflow:none; z-index:9999999999999999; visibility:hidden; "
		write "'>"
				
		write "<DIV style='"
		write "width:100%; height:100%; position:absolute; "  ;SR17481 ****
		if $get(%CGIEVAR("HTTP_USER_AGENT"))'["MSIE 8.0" {
			write " background-color:darkgray; "_$$Opacity^WWWFORMCrossBrowserSupportVisual(50)_" "
		}
		write "'>"
		write "</div>"
		
		write "<DIV style='"
		write "width:100%; height:100%; position:absolute; "  ;SR17481 ****
		;write " background:url("_YGIF_"loading2.gif); "
		write " background:url("_YGIF_"circle_loading1.gif); "
		write " background-position:center; background-repeat:no-repeat;"
		write "'>"
		write "</DIV>" ;SRAAAAA

		write "</div>"
		;CORE-115 ^^^^^
	}
	
	;---------------------------------------
	; Display Heading
	;---------------------------------------
	
	;##### vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
	if $$$WWW120FormCentered(YVOR)=$$$YES write "<CENTER>"
	;##### ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
	
	if '$find($translate(YKOPF,"gif","GIF"),".GIF") do
	. if $data(^WWW00441s(0,3,YFORM)) do  ;NEUER Name
	. . new YBER,YPROG
	. . set YBER  = $order(^WWW00441s(0,3,YFORM,""))       quit:YBER=""
	. . set YPROG = $order(^WWW00441s(0,3,YFORM,YBER,""))  quit:YPROG=""
	. . if $piece($get(^WWW00441(0,YBER,YPROG,1)),Y,1)'="" set YKOPF = $piece($get(^WWW00441(0,YBER,YPROG,1)),Y,1) set YNAME=YKOPF
	. ;
	. do ^WWWKOPF(YKOPF)
 	
 	; SET START ANCHOR
	;---------------------------------------
	if $$$WWW120DoNOTDisplayFormHeader(YVOR)=$$$YES do ^WWWUP($$$NO)     ; FIXME : also in WWWKOPF?
	
	; IMAGE RATHER THAN FORM NAME IN HEADING
	;---------------------------------------
	if (YKOPF'="") && $find($translate(YKOPF,"gif","GIF"),".GIF") do  
	. new YI,YKOPF1
	.;write "<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR>"
	. write "<TABLE id=""wfimage"" BORDER=0 CELLSPACING=0 CELLPADDING=0><TR>"
	. set YTABLEANZ = $get(YTABLEANZ)+1
	. for YI=1:1 set YKOPF1=$piece(YKOPF,";",YI) quit:YKOPF1=""  do
	. . write YCR,"<TD><IMG SRC="""_YGIF_YKOPF1_""" hspace=0 TITLE="""_YKOPF1_""" border=0></A></TD>"
	. ;
	. write "</TR></TABLE>"
	. set YTABLEANZ = $get(YTABLEANZ)-1
	
	;##### vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
	if $$$WWW120FormCentered(YVOR)=$$$YES write "</CENTER>"
	;##### ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
	
	;------------------------------------------------------------------------ On FORM CONSTRUCTION   *** EXECUTE 7 ***
	; SR15603 vvv
	set strExec = $$$WWW012ExecuteOnFormConstruct($get(^WWW012(0,0,1)))
	if strExec'="" {
		$$$jsMarker("Execute On Form Construction :"_strExec)
		
		xecute strExec
		
		$$$jsMarker("End Execute On Form Construction")
	}
	
	$$$LOGWWWBENCH(11)
	
	;------------------------------------------------------------------------ BEFORE BUTTONLINE      *** EXECUTE 8 ***
	set strExec = $$$WWW120ExecuteBeforeButtonline(YVOR)
	if (strExec'="") || ($$EXIST^%R("Y"_YFORM_"onPageLoad.OBJ",$get(YUCI))) {
		$$$jsMarker("Execute Before Button Line :"_strExec)
		
		if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=1) write "<PRE>"
		if $extract(strExec)="#" set $extract(strExec)=""
		//$$$Alert(strExec)
		if strExec'="" xecute strExec
		
		;   *** EXECUTE 9 ***
		if $$EXIST^%R("Y"_YFORM_"onPageLoad.OBJ",$get(YUCI)) xecute "do ^Y"_YFORM_"onPageLoad"
		if $get(YOPTION1)'="" write YCR,"<INPUT TYPE=HIDDEN NAME=""YOPTION1"" VALUE="""_YOPTION1_""">"
		if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=1) write "</PRE>"
		
		$$$jsMarker("End Execute Before Button Line")
	}
	
	if $get(YBEARB)=4 { // in use
		set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly
	}
	
	if (YUSER'="") && ($$$WWWUSERHTMLStarted(^WWWUSER(0,YUSER,1))=$$$NO) quit  ;STOP DURCH SONDERPROGRAMM ; *** EARLY EXIT *** <<<<< 
	
	if (YANZ="") && ($$$WWW012MenuType($get(^WWW012(0,0,1)))=6) {
		do ^WWWMENU7  ;MENUEART MENUE ANZEIGEN ;display 
	}
	
	
	;------------------------------------------------------------------------
	; 0 Buttons Above   1 Button Down   2 Text Border Left   3 Selection
	;------------------------------------------------------------------------
	if $$$Contains((0,2,3),+$$$WWW120PositioningOfButtonLine(YVOR)) {

		do ^WWWFORM1	;BUTTONS                                     ; *** EXECUTE 10-13 ***
	}
	
	$$$LOGWWWBENCH(12)
	
	;#######################################
	if $get(YFIXHEADER)=$$$YES {
		write "</td></tr><tr><td>"
		;CORE-116.3 write "<div id='divFixedHeader' style=""width: 100%; height: 100%; overflow: auto; "">"		;SR16943
        write "<div id='divFixedHeader' style=""width: 100%; height: 100%; float:left; overflow: auto; "">"         ;CORE-116.3
	}
	;#######################################
	
	;------------------------------------------------------------------------
	$$$jsMarker("Button Line")
	if +$$$WWW120PositioningOfButtonLine(YVOR)=2 {   ;BUTTON AN DER LINKEN SEITE ;upon the side 
	;	write "<TABLE BORDER=0>"
		write "<TABLE id=""wfsidebut"" BORDER=0>"
		set YTABLEANZ = $get(YTABLEANZ)+1
		write "<TR><TD NOWRAP ALIGN=LEFT VALIGN=TOP BGCOLOR="_YWHITE_">"
		do ^WWWFORMC1   ;BUTTONS AN DER SEITE ;upon the side           ; *** EXECUTE 14 ***
		write "</TD><TD ALIGN=LEFT VALIGN=TOP>"
	}
	
	;+++++++++++++++++++++++++++++++++++++++
	;  7 : Search Engine
	;+++++++++++++++++++++++++++++++++++++++
	if YFOART=7 set $$$WWW120DisplayFrames(YVOR) = $$$YES  ;IMMER FORMATIERT/RAHMEN ;constantly 
	
	set YTABX  = 100  ;TABINDEX
	set YZEIPO = 1    ;IST ZEILE-POSITION
	set YZEILE = 0    ;SOLL ZEILE
	
	;---------------------------------------   Index 6 = P1 Form Name, D80 Header Position
	;                                             Displays fields above button line so can be
	;                                             seen over multiple tabs without repeating.
	; FIXME : Note - Doesn't distinguish between forms INABC and INAbc
	; SR17065 vvvv
	if $data(^WWW122(0,YFORM))                                          &&
	   ($order(^WWW122s(0,6,$$^WWWUMLAU(YFORM,1),""))'=" ")             &&
	   ((YOPTION'="") || ( (YOPTION="") && '$data(^WWW1210(0,YFORM)) ))    {  ;DATENFELDER ALS HEADER ;when 
		
		do ^WWWFORMH   ;HEADER MIT DATEN ;by means of                  ; *** EXECUTE 15-20 ***
	}
	
	$$$LOGWWWBENCH(13)
	
	;+++++++++++++++++++++++++++++++++++++++
	;  1 : Standard Form
	;  4 : Manual Input (with Button)
	;+++++++++++++++++++++++++++++++++++++++
	;IF YFOART=1||(YFOART=4) IF $DATA(^WWW122s(0,1,2,YFORM))||($DATA(^WWW1203(0,YFORM,SPRACHE,2))) IF (YOPTION'="") || ((YOPTION=""&('$DATA(^WWW1210(0,YFORM))))) DO    ;TYBD;16,12,2003; WWW1203(0,YFORM...
	//	SR14286: Can't simply check for subscript "2".
	if (YFOART=1) || (YFOART=4) if $data(^WWW122s(0,1,2,YFORM)) || $$DrawTabs(YFORM) if (YOPTION'="") || ( (YOPTION="") && '$data(^WWW1210(0,YFORM)) ) do    ;TYBD;16,12,2003; WWW1203(0,YFORM...
	. if +$$$WWW120DisplayFrames(YVOR)=$$$YES do
	. .;write YCR,"<TABLE BORDER=0"
	. . write YCR,"<TABLE id=""wffrtab"" BORDER=0"
	. . if ($$$WWW120InnerFrameSize(YVOR)=0) || ($$$WWW120InnerFrameSize(YVOR)=100) write " width=100%"
	. . write " style='border:1px solid "_$piece($get(^WWW100(0,"FARBE","EN",$$$WWW012BackgroundColor(YVOR1),1)),Y,1)_"'"
	. . write " cellspacing=0><TR><TD>"  ;GERAHMT
	. . set YTABLEANZ = $get(YTABLEANZ)+1
	. ;
	. do ^WWWFORM6  ;SEITENREITER                               ; *** EXECUTE 21 ***
	. write YCR
	
	;------------------------------------------------------------------------
	if YFORM="WWWBLANK" set $$$WWW120DisplayFrames(YVOR) = $$$NO
	if YFOART=3         set $$$WWW120DisplayFrames(YVOR) = $$$YES  ; always start a new table for Grid Form ;SR15619 
	
	if +$$$WWW120DisplayFrames(YVOR)=$$$YES do  ;RAHMEN INNEN ;framework 
	. new YFRBR
	. set YFRBR=2
	. ;SR17862 do ^WWWFRAME(YFRBR,,1)  ;INNEN FRAME OHNE % ;without      ; 0 or 2 or 3 => START^WWWFRAME opens <TABLE>  ; FIXME : add param 4 YID?
    . ;SR17871 TODO
	. if $$$WWW120InnerFrameSize(YVOR)'="" set YFRBR = $$$WWW120InnerFrameSize(YVOR)
	. if YFRBR'=0 if +YFRBR=0  set YFRBR=2
	. do ^WWWFRAME(YFRBR,,1,,,$$$NO)  ;INNEN FRAME OHNE % ;without      ; 0 or 2 or 3 => START^WWWFRAME opens <TABLE>  ; FIXME : add param 4 YID?
	. write "<TR><TD style='vertical-align:top;'>" ;SR18182
	
	$$$LOGWWWBENCH(14)
	
	;------------------------------------------------------------------------  AFTER BUTTONLINE   *** EXECUTE 22a ***
	set $$$WWWUSERHTMLStarted(^WWWUSER(0,YUSER,1))=$$$YES
	set strExec = $$$WWW120ExecuteAfterButtonLine(YVOR)
	set blnTUnit = $$$NO
	
	;+++++++++++++++++++++++++++++++++++++++                    ; *** EXECUTE 22b ***
	;  5 : Manual Input (without Button)  -  On After Save Data
	;+++++++++++++++++++++++++++++++++++++++        ; SR15603 vvv
	if (YFOART=5) && (strExec="") && '$data(^WWW122(0,YFORM)) {
		if ($$$WWW120ExecuteOnAfterSaveData(YVOR)'="") {
			set strExec = $$$WWW120ExecuteOnAfterSaveData(YVOR)  ;VORGABE FELD ;default field
		}
		if ($data(^WWWTransactionLine(0,YFORM,"ExecuteAfterSave"))) {  ;SR15947
			set blnTUnit = $$$YES
		}
	}
	;IF (strExec'="") || ($$EXIST^%R("Y"_YFORM_"onPageStart.OBJ",$get(YUCI))) DO
	if (strExec'="") || (blnTUnit=$$$YES) || ($$EXIST^%R("Y"_YFORM_"onPageStart.OBJ",$get(YUCI))) do  ;SR15947
	. if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=$$$YES) write "<PRE>"
	. $$$jsMarker("After Save or After Button Line :"_strExec)
	. if $extract(strExec)="#" set strExec = $extract(strExec,2,999)
	. ;
	. ; FIXME : <GRF> Should we NOT perform onPageStart routine if
	. ;               the ExecuteAfterSavingData starts with "*"? (What does "*" mean here anyway?)
	. ;               Will also leave opening <PRE> without a closing </PRE>
	. if $extract(strExec)="*" quit                                       ;FIS;27442;03.03.05
	. if strExec'="" xecute strExec                                       ;EXECUTE VOR FORMULAR ;EXECUTE pre- form 
	. ;
	. if blnTUnit=$$$YES set strTStatus = $$TransactionUnit^COMTransaction(YFORM,"ExecuteAfterSave")  ;SR15947
	. ;
	. ;   *** EXECUTE 23 ***
	. ;   
	. if $$EXIST^%R("Y"_YFORM_"onPageStart.OBJ",$get(YUCI)) xecute "DO ^Y"_YFORM_"onPageStart"  ;CUSTOMIZED EXECUTE;FIS;24947;10.01.04
	. if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=$$$YES) write "</PRE>"
	. $$$jsMarker("End After Save or After Button Line")
	
	if YUSER'="" if +$$$WWWUSERHTMLStarted(^WWWUSER(0,YUSER,1))=$$$NO quit  ; ***   EARLY EXIT   ***   ; STOP DURCH SONDERPROGRAMM ;SR15509
	
	$$$LOGWWWBENCH(15)
 	set ^CacheTempForm(YUCI,YUSER,YFORM,"YOPTION") 	= $get(YOPTION)		//SR15453
 	set ^CacheTempForm(YUCI,YUSER,YFORM,"YOPTION1")	= $get(YOPTION1)
 	set ^CacheTempForm(YUCI,YUSER,YFORM,"YPARA")	= $get(YPARA)  ; Can be used by the OnFilter CallBack
 	do 
 	. new YNUMM,objWWW1265,strURL
 	. set YNUMM=$$^WWWNEXT("WWW1265")
 	. set $piece(objWWW1265,Y,1)=$get(YANZ)
 	. set $piece(objWWW1265,Y,2)=$get(YLOCKKILL)
 	. set $piece(objWWW1265,Y,3)=$get(YNAME)
 	. set $piece(objWWW1265,Y,4)=$get(YKEY)
 	. set $piece(objWWW1265,Y,5)=$get(YUSENAME) ;CORE-291
 	. set $piece(objWWW1265,Y,20)=$get(%KEY("YPARA")) ;Carefull! YPARA may have multiple pieces. YPARA variable seems to be one screen behind.
 	. set ^WWW1265(YM,YBED,YFORM,YNUMM,1)=objWWW1265
	do RUECK
	quit
	
	
RUECK
	;-------------------------------------------------------------------------------
	; RUECKSPRUNG AUS EXECUTE NACH BUTTONLEISTE AUS MANUELLEN PROGRAMM
	; Return to execute off button bar of manual program 
	;
	; Params:
	;
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 15-Mar-2013	shobby	HEVA-885: Removed a change from SR18182 which could fail in Firefox.
	; 16-Jun-2008	GRF		Doco only
	; 03-Aug-2007	GRF		SR15509: handle leading spaces in pieces (strSearchClass)
	; 02-May-2007	GRF		SR15509: create and call DisplayTables.
	; 05-Jan-2006	PO		SR15351: Dynamic Table hook
	; 13-Sep-2006	PO		SR14864: Changed logging
	; 11-Sep-2006	PO		SR14864: LOGGING
	; 25-Jun-2006	shobby	SRBR014072: Consider customisations when looking at tabs.
	;-------------------------------------------------------------------------------
	new strSearchFunction
	
	$$$LogR("RUECK",$get(YFORM)_"<"_$get(YFOART))
	
	
	; FIXME : <GRF> A problem can be seen in the HTML source for form INCALL2 where
	;               the following structures overlap.  Similar problems may exist for
	;               other forms and only be obscured by MSIE leniency.
	; 
	;	FORM
	;	...
	;	
	;			FONT + CENTER					Data Point 1 (RUECK)
	;					TABLE + TR + TD			Data Point 2 (RUECK)
	;	/FORM									Data Point 3 (RUECK)
	;	FORM
	;	                /TD + /TR + /TABLE      Data Point 4 (RUECK) - possibly 3 levels
	;			/CENTER + /FONT					Data Point 5 (RUECK)
	;					/TD + /TR + /TABLE		Data Point 6 (STOP)
	;	/FORM									Data Point 7 (STOP)
	;           [  /div /TD + /TR + /TABLE ]
	;           [       /TD + /TR + /TABLE ]
	
	
	;%%%%%
	;
	; Data Point 1 <FONT><CENTRE>
	;
	;%%%%%
	
	if SPRACHE="" set SPRACHE="DE"
	
	$$$jsMarker("Data Point 1")
	
	write "<FONT"
	if $$$WWW120FontFace(YVOR)'="" write " FACE="""_$piece($get(^WWW100(0,"SCHRIFTART",SPRACHE,$$$WWW120FontFace(YVOR),1)),Y,1)_""""
	if $$$WWW120FontSize(YVOR)'="" write " SIZE="""_$$$WWW120FontSize(YVOR)_""""
	if $$$WWW120FontColor(YVOR)'=""  {
	;	IF $LENGTH($piece(YVOR,Y,6))=6 write " COLOR=""#"_$piece(YVOR,Y,6)_""""
		write " COLOR="""_$piece($get(^WWW100(0,"FARBE",SPRACHE,$$$WWW120FontColor(YVOR),1)),Y,1)_""""
	}
	write ">"
	
	$$$LOGWWWBENCH(6)
	
	if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=$$$YES) write "<PRE>"
	if $find($$$WWW120FontStyle(YVOR),1)   write "<B>"
	if $find($$$WWW120FontStyle(YVOR),2)   write "<U>"
	if $find($$$WWW120FontStyle(YVOR),3)   write "<I>"
	if $find($$$WWW120FontStyle(YVOR),4)   write "<STRIKE>"
	if $find($$$WWW120FontStyle(YVOR),5)   write "<BLINK>"
	if $$$WWW120FormCentered(YVOR)=$$$YES  write "<CENTER>"
	
	
	
	
	;%%%%%
	;
	; Data Point 2 <TABLE><TR><TD>
	; This is the wrapper table around the Keys and Data Fields of a single tab page for a form.
	;
	;%%%%%
	
	if (YFOART'=3) && (YFOART'=6) {    ; Not (old) Grid and not Menu
		$$$jsMarker("Data Point 2")
		
	;	write YCR,"<TABLE cellspacing=0 BORDER=0>"
		write YCR,"<TABLE id=""wfdp2"" cellspacing=0 BORDER=0 style='border:1px solid "_$piece($get(^WWW100(0,"FARBE","EN",$$$WWW012BackgroundColor(YVOR1),1)),Y,1)_"'>"
		set YTABLEANZ = $get(YTABLEANZ)+1
		write "<TR><TD>"                    ;Immer tr und td für mozilla;TYBD;26,7,2004;26159;
	}
	
	write YCR
	set YSPALTE = 1  ;FORMULARSPALTE
	set YHIDDSE = 0  ;HIDDEN MERKER FÜR SEITENWEISE VORGANG  ;to 
	set YZEIPO  = 1  ;IST ZEILE-POSITION
	set YZEILE  = 0  ;SOLL ZEILE
	
	;+++++++++++++++++++++++++++++++++++++++
	;  8 : WIZARD                  HELP^WWWFORMW includes </TABLE>
	;+++++++++++++++++++++++++++++++++++++++
	if YFOART=8 do ^WWWFORMW if +$$$WWW120PositioningOfButtonLine(YVOR)'=0 do ^WWWFORM1
	
	;+++++++++++++++++++++++++++++++++++++++
	
	; Option List Class  (e.g. INReq : Edit/Cancel/Reject/...)
	;---------------------------------------
	if (YOPTION="") && $data(^WWW1210(0,YFORM)) do
	. new YHTMFORM
	. set YHTMFORM="WWW"
	. do ^WWWFORMO
	
	
	
	;------------------------------------------------------------------------
	;%%%%%
	;
	; Data Point 3 </FORM><FORM>
	;
	;%%%%%
	if YHTMFORM="WWW2" {  ;FAST SAVE ;next 
		write YCR,"<INPUT TYPE=HIDDEN NAME=""YEND"" VALUE=1>",YCR  ;ENDE WENN OK ;termination when     ; FIXME : Also in Data Point 4
		write "</FORM>",YCR
		
		$$$jsMarker("Data Point 3")
		;HEVA-885if ((YFORM="MEDPrescriptionHosp")||(YFORM="MEDPrescriptionSol"))&&(YSEITE=1) {
		;HEVA-885	write "<DIV NAME="""_YHTMFORM_""" id="""_YHTMFORM_""">",YCR
		;HEVA-885} else {
			write "<FORM NAME="""_YHTMFORM_""" id="""_YHTMFORM_""">",YCR
		;HEVA-885}
	}
	
	;FELD FÜR COMBO-BOXEN;FIS;05.01.04 ;field to 
	write YCR,"<input name=""COMBO"_YFORM_""" type=""hidden"" value=""""/>"
	
	// FORM - Main form - keys and fields.
	
	$$$LOGWWWBENCH(7)
	
	if (YOPTION'="") || ((YOPTION="") && '$data(^WWW1210(0,YFORM))) {
		;
		;   *** EXECUTE ? ***
		;
		set strExec = $$$WWW120ExecuteAfterPrimaryKey(YVOR)
		if (YFOART=1) || (YFOART=3) {
			if $data(^WWW12]]><![CDATA[1(0,YFORM)) {
				$$$LOGWWWBENCH(]]><![CDATA[7.1)
				do ^WWWFORMP                      ;PRIMÄRSCHLÜSSEL
				$$$LOGWWWBENCH(7.2)
			}
		//	if ((strExec'="") && '$find(strExec,",,,") && ($get(YTIMEFORM)'=1) {  ;SR15947
			if ( $data(^WWWTransactionLine(0,YFORM,"ExecuteAfterPrimaryKey")) || ((strExec'="") && '$find(strExec,",,,")) ) && ($get(YTIMEFORM)'=1) {
				$$$LOGWWWBENCH(7.3)
				xecute strExec                    ;EXE NACH KEY ;within KEY
				set strTStatus = $$TransactionUnit^COMTransaction(YFORM,"ExecuteAfterPrimaryKey")  ;SR15947
				$$$LOGWWWBENCH(7.4)
			}
		}
		
		set YZEIPO=0 ;ZEILE-POSITION
		
		//IF (YFOART=5) && ($LENGTH($translate(strExec," ,-.|"))>3) {  ;SR15947
		if (YFOART=5) && (($length($translate(strExec," ,-.|"))>3) || $data(^WWWTransactionLine(0,YFORM,"ExecuteAfterPrimaryKey"))) {
			$$$LOGWWWBENCH(7.5)
			xecute strExec                      ;EXECUTE NACH KEY WENN OHNE BUTTON ;EXECUTE within KEY when without 
			set strTStatus = $$TransactionUnit^COMTransaction(YFORM,"ExecuteAfterPrimaryKey")  ;SR15947
			$$$LOGWWWBENCH(7.6)
		}
		
		if (YFOART'=6) && (YFOART'=8) {
			$$$LOGWWWBENCH(7.7)
			do ^WWWFORMD  	                    ; Manual and Data Fields
			$$$LOGWWWBENCH(7.8)
		}
		
		if (YFOART=2) {
			$$$LOGWWWBENCH(7.9)
			do ^WWWFORML                        ; LISTGENERATOR
			$$$LOGWWWBENCH(7.10)
		}
		
		//IF YFOART=4 && ($translate(strExec," ")'="") {
		if (YFOART=4) && (($translate(strExec," ")'="") || $data(^WWWTransactionLine(0,YFORM,"ExecuteAfterPrimaryKey"))) {  ;SR15947
			$$$LOGWWWBENCH(7.11)
			xecute strExec                      ;EXECUTE NACH KEY WENN MIT BUTTON ;EXECUTE within KEY when by means of 
			set strTStatus = $$TransactionUnit^COMTransaction(YFORM,"ExecuteAfterPrimaryKey")  ;SR15947
			$$$LOGWWWBENCH(7.12)
		}
		
		if YFOART=6 {
			$$$LOGWWWBENCH(7.13)
			do ^WWWGEDT                         ;FOLDER MENU
			$$$LOGWWWBENCH(7.14)
		}
		
		if YFOART=7 {
			$$$LOGWWWBENCH(7.15)
			do ^WWWSMA                          ;SUCHMASCHINE
			$$$LOGWWWBENCH(7.16)
		}
		
		if YFOART=9 {
			$$$LOGWWWBENCH(7.17)
			do ^WWWFORMBIT                      ;BITMAP SUCHFORMULAR;FIS;24502;14.04.04
			$$$LOGWWWBENCH(7.18)
		}
	}
	
	$$$LOGWWWBENCH(8)
	
	;------------------------------------------------------------------------
	;%%%%%
	;
	; Data Point 4 </TABLE>  -  Possibly 3 levels?
	;
	;%%%%%
	
	
	if ((YFORM="MEDPrescriptionHosp")||(YFORM="MEDPrescriptionSol"))&&(YSEITE=1) goto label
		write YCR
		if +$$$WWW120DisplayFrames(YVOR)=$$$YES {
			write "</TD></TR>"
			write "</TABLE>"  ;ENDE INNEN RAHMEN ;termination framework 
			set YTABLEANZ = $get(YTABLEANZ)-1
		
			$$$jsMarker("Data Point 4")
		}
		;+++++++++++++++++++++++++++++++++++++++
		;  1 : Standard Form
		;+++++++++++++++++++++++++++++++++++++++
		write YCR
		if (YFOART=1) && ($data(^WWW122s(0,1,2,YFORM)) || $data(^WWW1203(0,YFORM,SPRACHE,2))) do   ;TYBD;16,12,2003     ;SEITENREITER
		. if +$$$WWW120DisplayFrames(YVOR)=$$$YES do 
		. . write "</TD></TR>" 
		. . do ^WWWFRAME(1)    ; => STOP^WWWFRAME </TABLE> & YTABLEANZ-1
		. write YCR
	
		;------------------------------------------------------------------------
		if +$$$WWW120PositioningOfButtonLine(YVOR)=2 do   ;ENDE BUTTON AN DER LINKEN SEITE ;termination upon the side 
		. write YCR
		. write "</TD></TR></TABLE>"
		. set YTABLEANZ = $get(YTABLEANZ)-1
label
	
	; --- AFTER DATA FIELDS ---
	;+++++++++++++++++++++++++++++++++++++++
	; *NOT*
	;  8 : Wizard
	;+++++++++++++++++++++++++++++++++++++++
	if (YFOART'=8) && (+$$$WWW120PositioningOfButtonLine(YVOR)=1) do ^WWWFORM1   ;BUTTONS
	
	;   *** EXECUTE ? ***
	set strExec = $$$WWW120ExecuteAfterDataFields(YVOR)
	
	if (YFOART'=8) && (YTIMEFORM'=1) do OnAfterDataFields^COMGridEdit31Display(YFORM,$get(YKEY),$get(YFELD)) ;SR17245
	
	if (YFOART'=8) && ((strExec'="") || $$EXIST^%R("Y"_YFORM_"onPageEnd.OBJ",$get(YUCI)) || $data(^WWWTransactionLine(0,YFORM,"ExecuteAfterDataFields"))) do
	. $$$jsMarker("Execute After Data Field :"_strExec)
	. new YSTOP																 ;SR18091
	. set YSTOP=0															 ;SR18091
	. do ExecuteAfterDataFields^WWW120D(YFORM,$get(YKEY),$get(YFELD),.YSTOP) ;SR18091
	. if 'YSTOP do
	. . if $get(YTIMEFORM)'=1 do
	. . . if strExec'="" xecute strExec                                ;EXE NACH DATENFELD ;within data item
	. . . set strTStatus = $$TransactionUnit^COMTransaction(YFORM,"ExecuteAfterDataFields")
	. . . ;
	. . . ;   *** EXECUTE ? ***
	. . . if $$EXIST^%R("Y"_YFORM_"onPageEnd.OBJ",$get(YUCI)) xecute "DO ^Y"_YFORM_"onPageEnd" write "<br>" ;CUSTOMIZED EXECUTE;FIS;24947;10.01.04
	. $$$jsMarker("End Execute After Data Field")
	
	do DynamicTableHook(YFORM,YSEITE,YKEY) // SR15351
 	
	;------------------------------------------------------------------------
	; Search Function for Data Field       ; SUCHE NACH DATENFELDER
	; 	D4		$$$WWW1203DataFieldSearchFunction()
	; 				$$$WWW1203DDataFieldSearchFunction()   
	; 	D58		$$$WWW120DataFieldSearchFunction()
	; 	
	; 	D7		$$$WWW124NewFormOnClick()
	; 
	; Function merges Tab Customisation with Tab - if the Tab has search forms
	; defined, over-ride the form setting.
	; If Search Forms are now specified for the form, check to see if any of the
	; form's buttons link to that form and if the user does not have access to that
	; new form remove it from the Search Forms so it is not displayed.
	;
	; FIXME : <GRF> Shouldn't call function twice - combines WWW1203/WWW1203D twice.
	;               May have similar situations with WWW122
	;------------------------------------------------------------------------
	;IF YFORM'="" IF $piece($get(^WWW1203(0,YFORM,SPRACHE,+YSEITE,1)),Y,4)'="" SET $piece(YVOR,Y,58)=$piece(^(1),Y,4)  ;WENN SEITENBEZOGENE ANZEIGE  ;when Show 
	if YFORM'="" if $piece($$GET^WWW1203(YFORM,SPRACHE,+YSEITE),Y,4)'="" set $piece(YVOR,Y,58)=$piece($$GET^WWW1203(YFORM,SPRACHE,+YSEITE),Y,4)  ;WENN SEITENBEZOGENE ANZEIGE  ;when Show ;SRBR014072
	if YFORM'="" if $piece(YVOR,Y,58)'="" if $data(^WWW124(0,YFORM,SPRACHE)) do  ;FIS;31.08.04;BUTTONBERECHTIGUNG FÜR SUCHANZEIGE PRÜFEN;26349
	. new YNR,YA
	. set YNR=""
	. for  set YNR = $order(^WWW124(0,YFORM,SPRACHE,YNR)) quit:YNR=""  do  quit:$piece(YVOR,Y,58)=""
	. . set YA=$get(^WWW124(0,YFORM,SPRACHE,YNR,1))
	. . if $piece(YA,Y,7)=$piece(YVOR,Y,58) if $$^WWWACCESS($piece(YA,Y,22),$piece(YA,Y,23))'=1 set $piece(YVOR,Y,58)=""  ;KEIN ZUGANG ;no 
	
	; TODO : <GRF> The following line of code                           vvvvv
	;do DisplayTables($$$WWW120DataFieldSearchFunction(YVOR),$get(YKEY),$get(YMAXKEY))     ; SR15509
	
	; was developed to replace this block of code but not implemented   vvvvv
	
	if $$$WWW120DataFieldSearchFunction(YVOR)'="" do
	. quit:$get(YTIMEFORM)=1  ;NICHT, WENN DATEN IN ZUKUNFT ERFASST WERDEN
	. if +$piece($piece(YVOR,Y,58),",",1)'=0 set:+YSEITE=0 YSEITE=1 quit:+YSEITE'=+$piece($piece(YVOR,Y,58),",",1)  set $piece(YVOR,Y,58)=$piece($piece(YVOR,Y,58),",",2,99)
	. new YA,YYYMAXKEY,YYYKEY,YTOOLTIP,YPRINT,strSearchClass
	. set YYYMAXKEY = $get(YMAXKEY)
	. set YYYKEY    = $get(YKEY)
	. set YTOOLTIP  = $piece($piece(YVOR,Y,58),";",2)  ;INFO FÜR ANZEIGE
	. set YA(1)=$piece($piece(YVOR,Y,58),";",1)
	. ;FOR YA=1:1 quit:$piece(YA(1),",",YA)=""  SET $piece(YVOR,Y,58)=$piece($piece(YA(1),",",YA)," ",1) DO   ; SR15509 vvv
	. for YA=1:1 quit:$piece(YA(1),",",YA)=""  do
	. . set strSearchClass = $zstrip($piece(YA(1),",",YA),"<W")
	. . set $piece(YVOR,Y,58) = $piece(strSearchClass," ",1)
	. . ;                                                                                                       SR15509 ^^^
	. . new YA,YHEADONLY,YWSAVE
	. . set YMAXKEY=YYYMAXKEY
	. . set YKEY=YYYKEY
	. . if YFORM'=$piece(YVOR,Y,58) if +YMAXKEY'=0 if $piece(YKEY,",",YMAXKEY)="" set YHEADONLY = $$$YES   ;WENN KEIN KEY ERFASST DANN NUR HEADER; TYBD 6.2.2003
	. . do  ;PRUEFEN O ;oh 
	. . . new YSUCH
	. . . set YSUCH=""
	. . . if $data(^WWW123(0,$piece(YVOR,Y,58),1,1)) set YSUCH=$get(^WWW123(0,$piece(YVOR,Y,58),1,1))
	. . . quit:YSUCH=""
	. . . set YWSAVE=""
	. . . if $piece(YSUCH,Y,23)=1 set YWSAVE=YFORM_Y_YKEY  ;MIT SAVE;TYBD;20,10,2003;
	. . . if YFORM=$piece(YVOR,Y,58) if $piece(YSUCH,Y,3)'="" if $piece(YSUCH,Y,17)'="" do
	. . . . if +YMAXKEY'=0 if $piece(YKEY,",",YMAXKEY)="" set YHEADONLY = $$$YES  ;KEINE ANZEIGE , DA KEIN KEY
	. . ; 
	. . set YNOSORT=1  ;KEIN SORT / SONST ANZEIGE IN SUCHFUNKTION ;no otherwise Show within 
	. . do ^WWWSUCH9                               ; *** EXECUTE (see) ***
	. ;
	. set $piece(YVOR,Y,58) = YA(1)
	. set YMAXKEY = YYYMAXKEY
	. set YKEY    = YYYKEY
	
	; end block SR15509                                    ^^^^^
	
	; SR15509 ^^^
	
	
	;------------------------------------------------------------------------
	;QUERY NACH DATENFELDER ;within 
	if $$$WWW120QueryForDataFields(YVOR)'="" do
	. quit:$get(YTIMEFORM)=1  ;NICHT, WENN DATEN IN ZUKUNFT ERFASST WERDEN 
	. if +$piece($piece(YVOR,Y,111),",",1)'=0 set:+YSEITE=0 YSEITE=1 quit:+YSEITE'=+$piece($piece(YVOR,Y,111),",",1)  set $piece(YVOR,Y,111)=$piece($piece(YVOR,Y,111),",",2,99)
	. new YA,YYYMAXKEY,YYYKEY,YTOOLTIP,YPRINT,YCLASS,YQUERY,YPARAX,intPos,strD111
	. set YYYMAXKEY = YMAXKEY
	. set YYYKEY	= YKEY
	. set strD111   = $piece(YVOR,Y,111)
	. set YCLASS	= $piece(strD111,",",1)
	. set YQUERY	= $piece(strD111,",",2)
	. set YPARAX	= $piece(strD111,",",3,999)
	. set intPos	= $find($zconvert(strD111,"U"),"SELECT")
	. if 'intPos quit:(YCLASS="")||(YQUERY="")                  ;KEIN QUERY ;no 
	. if intPos  set YQUERY = $translate($piece(YVOR,Y,111),"|"," ") set YCLASS="",YPARAX=""  ;MANUELLES QUERY
	. do ^WWWQUERY(YCLASS,YQUERY,YPARAX)                        ;QUERY STARTEN ;launching 
	. ;
	. set YMAXKEY = YYYMAXKEY
	. set YKEY    = YYYKEY
	
	;+++++++++++++++++++++++++++++++++++++++
	;  7 : Search Engine       ;SUCHMASCHINE
	;+++++++++++++++++++++++++++++++++++++++
	if YFOART=7 do
	. do SUCH^WWWSMA
	. ;SONDERPROGRAMM AUFRUF NACH SUCHMASCHINE WUNSCH WACH;TYBD;26,11,2003
	. ;
	. ;   *** EXECUTE ? ***
	. if $$EXIST^%R("Y"_YFORM_".OBJ",$get(YUCI)) xecute "DO ^Y"_YFORM      ;Bec;05.12.03;24774;CHECK IF COMPLED ROUTINE EXIST.
	. ;
	. ;   *** EXECUTE ? ***
	. if $$EXIST^%R("Y"_YFORM_"onSearch.OBJ",$get(YUCI)) xecute "DO ^Y"_YFORM_"onSearch"  ;CUSTOMIZED EXECUTE;FIS;24947;10.01.04
	
	$$$jsMarker("Final Format")
	
	;+++++++++++++++++++++++++++++++++++++++
	;  3 : Grid Form
	;+++++++++++++++++++++++++++++++++++++++
	
	
	
	;%%%%%
	;
	; Data Point 5 </CENTER></FONT>
	;
	;%%%%%
	if ($$$WWW120FormCentered(YVOR)=$$$YES) || (YFOART=3) write YCR,"</CENTER>"
	if $find($$$WWW120FontStyle(YVOR),5) write "</BLINK>"
	if $find($$$WWW120FontStyle(YVOR),4) write "</STRIKE>"
	if $find($$$WWW120FontStyle(YVOR),3) write "</I>"
	if $find($$$WWW120FontStyle(YVOR),2) write "</U>"
	if $find($$$WWW120FontStyle(YVOR),1) write "</B>"
	if ($$$WWW120FontFace(YVOR)="") || ($$$WWW120PreFormatted(YVOR)=1) write "</PRE>"
	
	if ((YFORM'="MEDPrescriptionHosp")&&(YFORM'="MEDPrescriptionSol"))||(YSEITE'=1) {			;SR18182
		write "</FONT>",YCR
	}															;SR18182
	
	$$$jsMarker("Data Point 5")
	write "<INPUT TYPE=HIDDEN NAME=""YEND"" VALUE=1>"  ;ENDE WENN OK ;termination when     ; FIXME : Also in Data Point 3
	
	if $$$WWW120FormInformation(YVOR)'="" write YCR,"<FONT SIZE=2><B>",$$$WWW120FormInformation(YVOR),"</B></FONT>"
	
	;+++++++++++++++++++++++++++++++++++++++
	;  4 : Manual Input (with Button)
	;+++++++++++++++++++++++++++++++++++++++
	if YFOART=4 {
		write YCR,"</TD></TR></TABLE>"
		set YTABLEANZ=$get(YTABLEANZ)+1
	}
	if (YSEITE=1) { 												;SR18183
		if (YFORM="MEDPrescriptionHosp") {
			write "</DIV></TD></TR></TBODY></TABLE></FONT></TD>" 	;SR18182
			set YTABLEANZ=$get(YTABLEANZ)+1							;SR18182
			write "<TD style='vertical-align:top;'>"				;SR18182
			do OnAfterDataFields1^MEDPrescriptionHosp(YMFELD)		;SR18182
			write "</TD>"											;SR18182
		} elseif (YFORM="MEDPrescriptionSol") {						;SR18182
			write "</DIV></TD></TR></TBODY></TABLE></FONT></TD>" 	;SR18183
			set YTABLEANZ=$get(YTABLEANZ)+1							;SR18183
			write "<TD style='vertical-align:top;'>"				;SR18183
			do OnAfterDataFields1^MEDPrescriptionSol(YKEY,YFELD)	;SR18183
			write "</TD>"											;SR18183
		}															;SR18182
	}
	$$$LOGWWWBENCH(9)
	
	quit
	
	
	;------------------------------------------------------------------------------- 
	;  NOT IMPLEMENTED - Brace version of dot syntax code in RUECK
	;------------------------------------------------------------------------------- 
DisplayTables(pstrTableInfo,pidKEY,pidMAXKEY) private
	;------------------------------------------------------------------------------- 
	; Display table of data below form
	; 
	; [Tab#,]Form[,Form...][;ToolTip]
	; 
	; 1.  If initial characters are numeric - assumed to be Tab# followed by comma and data.
	;   a.  Tab# present :
	;         If current tab doesn't match Tab# in this case, table is not displayed.
	;         If current tab does match Tab#, Tab# is stripped from string.
	;   b.  Tab# not present, Continue
	; 2.  Extract each form to be displayed in turn
	; 3.  Check if all keys have data
	;   a.  If not, flag to only show header
	; 
	; ByRef :
	;	YSEITE		Current Tab Number
	;	YTIMEFORM
	; 
	; History:
	; 02-May-2007	GRF		SR15509: Extracted from RUECK to fix subscript error
	; 							with brace format and variable cleanup.
	;-------------------------------------------------------------------------------
	new idForm,idTabNo,loop,objSearch,strFormList,YHEADONLY,YKEY,YMAXKEY,YPRINT,YTOOLTIP,YWSAVE,YNOSORT
	
	quit:pstrTableInfo=""
	quit:$get(YTIMEFORM)=1                   ;NICHT, WENN DATEN IN ZUKUNFT ERFASST WERDEN
	
	set:+$get(YSEITE)=0 YSEITE=1
	set idTabNo = +pstrTableInfo
	if idTabNo {
		set pstrTableInfo = $piece(pstrTableInfo,",",2,99)
	}
	
	if (idTabNo=0) || (YSEITE=idTabNo) {
		set YTOOLTIP    = $piece(pstrTableInfo,";",2)  ;INFO FÜR ANZEIGE
		set strFormList = $piece(pstrTableInfo,";",1)
		for loop=1:1:$length(strFormList,$$$COMMA) {
			set idForm = $piece(strFormList,$$$COMMA,loop)
			set idForm = $piece(idForm," ",1)                    ; ignore anything after a space
			
			if idForm'="" {
				set YKEY      = pidKEY
				set YMAXKEY   = pidMAXKEY
				set YHEADONLY = $$$NO
				if YFORM'=idForm {
					if (+YMAXKEY'=0) && ($piece(YKEY,",",YMAXKEY)="") set YHEADONLY = $$$YES
				}
				set objSearch=$get(^WWW123(0,idForm,1,1))
				if objSearch'="" {
					set YWSAVE=""
					if $piece(objSearch,Y,23)=$$$YES set YWSAVE = YFORM_Y_YKEY    ; With Automatic Storing
					;  3 : Fixed Index Key 
					; 17 : Fixed Specification For Sort Keys
					if (YFORM=idForm) && ($piece(objSearch,Y,3)'="") && ($piece(objSearch,Y,17)'="") {
						if (+YMAXKEY'=0) && ($piece(YKEY,",",YMAXKEY)="") set YHEADONLY = $$$YES
					}
				}
				set YNOSORT = $$$YES
				set $piece(YVOR,Y,58) = idForm             ; required for ^WWWSUCH9
				do ^WWWSUCH9                               ; *** EXECUTE ***
			;			ByRef ? YFORM, YVOR, YTOOLTIP, YHEADONLY, YWSAVE, YNOSORT, [YKEY, YMAXKEY] 
			}
		}
	;	set $piece(YVOR,Y,58) = strFormList
	;	set YMAXKEY=YYYMAXKEY
	;	set YKEY=YYYKEY
	}
	quit
	
	
STOP
	;-------------------------------------------------------------------------------
	;	ENDE FORM (ACHTUNG EINSPRUNG) ;termination shape 
	; 
	; History:
	; 03-May-2010	GRF		-: Old comment cleanup; dots to braces
	; 09-Dec-2005	JW		SR13195: Use IsNewRecord to determine.
	; 07-Jul-2005	shobby	SR12892: WWW1261 is no longer shared.
	;-------------------------------------------------------------------------------
	
	$$$LogR("STOP",$get(YFORM))
	
	;%%%%%
	;
	; Data Point 6 </TD></TR></TABLE>
	;
	;%%%%%
	if $get(YFIXHEADER)'=$$$YES {
		write YCR,"</TD></TR></TABLE>"
		set YTABLEANZ=$get(YTABLEANZ)-1
	}
	
	$$$jsMarker("Data Point 6")
	
	if $get(YGJUMP)'="" write "<A NAME="""_YGJUMP_""">"

	if (YFIXHEADER'=$$$YES) && (YFOART'=5) do ^WWWUP($$$YES)
	
	if YFIXHEADER'=$$$YES if YHTMFORM'="WWW2" if $get(YFORM)'="" if $get(YFOART)=1 if +$$$WWW120SaveButtonAtTheBottomFrom($get(YVOR))'=0 if $get(YZEIPO)>$$$WWW120SaveButtonAtTheBottomFrom($get(YVOR)) do
	. if $get(YBEARB)'=4 if $get(YBEARB)'=8 if ($$$WWW120AuthorizationToModifyData(YVOR)'=$$$EnumReadOnly)  if +$$$WWW120PicturesAsButtons($get(YVOR))=1 do
	. . write "&nbsp;"
	. . write "<INPUT TYPE=""IMAGE"""
	. . if $$$WWW120AuthorizationToModifyData($get(YVOR))<4 write " SRC="""_YGIF_"save.gif"" "_YWIDTH_" "_YHEIGHT_" TITLE="""_$$^WWWUML($$^WWWTEXT(165))  ; "Save"
	. . if $$$WWW120AuthorizationToModifyData($get(YVOR))>]]><![CDATA[3 write " SRC="""_YGIF_"save.gif"" "_YWIDTH_" "_YHEIGHT_" TITLE=""OK"
	. . write """ border=0>" ; SPEICHERN ;Save 
	
	;------------------------------------------------------------------------
	do EVENT
	do EVENTCHECKUP  ;EVENT PRÜFUNG;25774;FIS;16.07.04
	;------------------------------------------------------------------------
	;%%%%%
	;
	; Data Point 7 </FORM>
	;
	;%%%%%
	write "</FORM>"
	
	$$$jsMarker("Data Point 7")
	
	;ENDE=ANZEIGEN DES FORMS
	if $get(YFIXHEADER)=$$$YES {
		write "</div><!-- end divFixedHeader -->"
		write YCR,"</TD></TR></TABLE>"
		set YTABLEANZ = $get(YTABLEANZ)-1
	}
	if $get(YTABLEANZ)>0 {   ; FIXME : Should we repeat until YTABLEANZ is zero?
		write YCR,"</TD></TR></TABLE>"
		set YTABLEANZ = $get(YTABLEANZ)-1
	}
	if YFORM="WWWCHAT" {
		$$$StartScript()
		write YCR,"window.setTimeout(""chat()"",2000);"
		$$$EndScript()
	}
	
	;------------------------------------------------------------------------
	set %KEY = YKEY
	
	if $$IsNewRecord^WWWFORMStatus() {
		if '$data(^WWWDUMMY(YUSER)) set ^WWW1261(0,YFORM,1) = $get(YFELD)
	}  ;DATENSATZ BEI NEU ZUR PRÜFUNG OB SAVE ERLAUBT ;data record next to recent query whether permissive 
	
	kill ^WWWDUMMY(YUSER)
	do ^WWWFORM2
	do ^WWWSTOP
	set $$$WWWUSERHTMLStarted(^WWWUSER(0,YUSER,1)) = $$$NO  ;HTML AUS ;HTML out of 
	quit
	
	
EVENT
	;-------------------------------------------------------------------------------
	;	EVENTBROKER LADEN  (ACHTUNG EINSPRUNG ZB AUS WWWMENU) ;charge out of 
	;-------------------------------------------------------------------------------
	if +$get(YHYPER)=0 do
	. $$$jsMarker("Applet Eventbroker")
	. new TCP
	. set TCP = $get(%CGIEVAR("SERVER_NAME"))
	. if $get(%KEY("MGWEBP"))="" set %KEY("MGWEBP") = 7001
	. write YCR
	. write YCR_"<div style=""display:none; visibility:hidden;"">"
	. write YCR,"<APPLET NAME=WebLink CODEBASE=/ CODE=mgw.class WIDTH=2 HEIGHT=2>"
	. write YCR,"<PARAM NAME=WebEventBrokerPort VALUE="""_$get(%KEY("MGWEBP"))_""">"
	. if TCP'="" write YCR,"<PARAM NAME=WebServerIPAddress VALUE="""_TCP_""">"
	. ;
	. if $get(%KEY("MGWLIB"))'="" do
	. . write YCR,"<PARAM NAME=Mode VALUE=10>"
	. . write YCR,"<PARAM NAME=ScriptName VALUE="""_$get(%KEY("MGWLIB"))_""">"
	. write YCR,"</APPLET>"
	. write YCR_"</div>",YCR
	
	;------------------------------------------------------------------------
	
	if (+$get(YHYPER)=1) && '$get(%(YQUERY,"XMLHTTPREQ")) {
		$$$jsMarker("Applet Hyperevent")
		write "<APPLET NAME=""CacheCSPBroker"" ARCHIVE=""cspbroker.jar"" CODEBASE=""/csp/broker"" CODE=""cspbroker.class"" WIDTH=0 HEIGHT=0 ALIGN=RIGHT>"
		write YCR,"</APPLET>",YCR
	}
	quit
	
	
EVENTCHECKUP  ;EVENT PRÜFUNG;25774;FIS;16.07.04
	new LOCKCHCK,TIMEOUT,YKEY
	
	;	D162	$$$WWW012AutoEventRequestInBackgro()
	;				"Disable Auto Event Request In Background" - disabled or enabled? Check timeout if set
	;	D163	$$$WWW012RequestEverySeconds()
	if +$piece(YVOR1,Y,162)=$$$YES do
	. set TIMEOUT = +$piece(YVOR1,Y,163)  ;ALLE WIEVIEL SEKUNDEN ;how much 
	. if +TIMEOUT<5 set TIMEOUT = 20      ;DFLT. 20
	. set LOCKCHCK = 1
	. set YKEY     = $get(YREFRKEY)
	. if YKEY="" set YKEY = $get(%(YQUERY,"YKEY"))
	. do  //INKL. LOCKPRÜFUNG JA/NEIN
	. . if YFOART'=1           set LOCKCHCK = 0  ;NUR STD. FORMULAR ;only form 
	. . if $get(YBEARB)=4      set LOCKCHCK = 0  ;READONLY
	. . if ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) set LOCKCHCK = 0
	. ;
	. $$$StartScript()
	. if (LOCKCHCK=1) && (YBEARB'=1) && ($get(YKEY)'="") && '$find(YKEY,"+") write YCR,"window.setTimeout(""RefreshCheck()"",200);"
	. write YCR,"window.setTimeout(""EventCheckup()"","_(30*1000)_");"  ; Check Every Minute  (30 sec?)
	. ;
	. write YCR,"function EventCheckup() {"
	. write YCR,"  retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""WWWEVENT4"","""_LOCKCHCK_""",""6"",""EventRequest"");"
	. write YCR,"  if (retval == 'REFRESH') { "
	. write YCR,"    window.history.go(0);"
	. write YCR,"  }"
	. ;
	. write YCR,"  else if (retval == 'RELOAD') {"
	. write YCR,"    if (confirm('"_$$^WWWTEXT(33931,,1)_"')) {"  ; "Another user has changed this record. Do you want to load the new version?"
	. write YCR,"      retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""WWWEVENT4"","""_LOCKCHCK_""",""6"",""DataRequest"");"
	. write YCR,"    }"
	. write YCR,"    else {"
	. write YCR,"      alert('"_$$^WWWTEXT(33932,,1)_"');"        ; "Info! Changed Data Will Not Been Saved."
	. write YCR,"      retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""WWWEVENT4"","""_LOCKCHCK_""",""6"",""DeleteLock"");"
	. write YCR,"    }"
	. write YCR,"    window.setTimeout(""EventCheckup()"","_(TIMEOUT*1000)_");"  ; Check Again every x seconds
	. write YCR,"  }"
	. ;
	. write YCR,"  else if (retval == 'INVALID') { "
	. ;            "Another User has changed the data record. Please Refresh This Page. Save is not possible."
	. write YCR,"    if (confirm('"_$$^WWWTEXT(392,,1)_"')) {"
	. write YCR,"      window.history.go(0);"
	. write YCR,"    }"
	. write YCR,"  }"
	. ;
	. write YCR,"  else {"
	. write YCR,"   window.setTimeout(""EventCheckup()"","_(TIMEOUT*1000)_");"  ; Check Again every x seconds
	. write YCR,"  }"
	. write YCR,"}"
	. ;
	. if (LOCKCHCK=1) && (YBEARB'=1) && ($get(YKEY)'="") && '$find(YKEY,"+") do
	. . write YCR,"function RefreshCheck() {"
	. . write YCR,"  var dkey = '"_$translate(YKEY,"][\}{|~ ,;:'()@#$%^&*_=+<>?/"_$char(128)_"""")_"';"	;W3C
	. . write YCR,"  var retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""WWWEVENT4"",dkey,""6"",""RefreshCheck"");" ;W3C
	. . write YCR,"  if (retval !='' && retval == dkey) { "   ; Check Key Again - Changed during event call?
	. . write YCR,"      alert('"_$$^WWWTEXT(33960,,1)_"');"  ; "This Page Is No Longer Valid!"
	. . write YCR,"      window.history.go(0);"
	. . write YCR,"  }"
	. . write YCR,"}"
	. ;
	. $$$EndScript()
	
	quit
	
	
DrawTabs(pidForm)
	;-------------------------------------------------------------------------------
	; Determines whether or not we are drawing tabs for this form.
	; (Original code was just doing $data check on subscript "2", which doesn't
	; always work if you have "holes" in the tab numbering).
	;
	; Params: pidForm		: The form ID.
	;
	; ByRefs:
	;
	; Returns: blnDrawTabs
	;
	; History:
	; 11-Sep-2006	SteveS	SR14286: Created
	;-------------------------------------------------------------------------------
	new blnDrawTabs,intCount,idTab
 	
	set blnDrawTabs = $$$NO
	
	if ($get(pidForm)'="") {
		set intCount = 0
		set idTab    = ""
		for {
			set idTab = $order(^WWW1203(0,pidForm,SPRACHE,idTab))
			quit:(idTab="")||(intCount>=2)
			
			set intCount = intCount+1
		}
		set blnDrawTabs = (intCount>=2)
	}
	quit blnDrawTabs
	
	
DynamicTableHook(pidForm,pintPage,pidKey)
	;-------------------------------------------------------------------------------
	; Create Dynamic Table function and call it if AfterDataFields function created
	;
	; Params:
	; pidForm - Form Id
	; pintPage - Page Id
	; pidKey - Key
	;
	; Returns: Nothing
	;
	; History:
	; 05-Jan-2007	PO		SR15351: Created
	;-------------------------------------------------------------------------------
	new idGridForm,blnCompleteKey,idKeyPart,arrTables,idTable,loop
	
 	if $data(^WWW120DynTable(0,YFORM)) {
 		set idGridForm     = $$$GRIDName
 		set blnCompleteKey = $$$YES
		
	 	if idGridForm = "" {
		 	write "<div id='DynamicArea'></div>"
	 		do CreateDynTableCall^WWW120DynTable(pidForm,idGridForm,pintPage,.arrTables)           ; *** EXECUTE ??? ***
	 	}
		
		for loop=1:1:$length(pidKey,$$$COMMA) {
			set idKeyPart = $piece(pidKey,$$$COMMA,loop)
			if $$$NoKey(idKeyPart) set blnCompleteKey = $$$NO
		}
		
		set idTable = ""
		for {
			set idTable = $order(arrTables(idTable))
			quit:idTable=""
			
		 	if blnCompleteKey || '$$$WWW120DynTableRequireRecord(arrTables(idTable)) {
			 	$$$StartScript()
			 	write "if (typeof(DrawDynTable_AfterDataFields) != 'undefined') DrawDynTable_AfterDataFields('"_$$$EnumWWWDYNTABLEAfterDataFields_"','"_pidKey_"');"
			 	$$$EndScript()
		 	}
		}
 	}
	quit
	
	
ReadOnly(pstrBack) 
	;-------------------------------------------------------------------------------
	; Users are not allowed to modify data in EN	
	; 
	; Params: strBack = name of the last form 
	; 
	; ByRefs: YBACK, YKEY
	;
	; History:
	; 06-Jul-2007	GM		SRBR014572: Created
	;-------------------------------------------------------------------------------
	if $piece($get(YBACK),",",$length($get(YBACK),",")-1)=pstrBack {	
		if $$$KEY2(YKEY) = "EN" { 
			set $$$WWW120AuthorizationToModifyData(YVOR) = $$$EnumReadOnly
		}
	}
	quit]]></Routine>
</Export>