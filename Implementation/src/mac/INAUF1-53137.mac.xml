<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUF1" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUF1
#include COMSYS
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BERECHNEN KOSTEN UND SETZEN PARAMETER
	;
	; Called by : form INAUF when saving data
	;	
	; Inputs : 
	;	YKEY
	;	YKUNDE		Customer Number
	;	YOPTION		Order Type
	;	BETRIEB		Site Location
	;	
	;	From routine INAUFNEU1
	;	YFELD		equivalent to objINAUF (temp reused as objINAUF1)
	;	VORG(1)		Item No. or Search Name Entry field (M104/F104)   e.g. idItem+Quantity
	;	VORG(10)	Requisition						(y/n)
	;	
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 11-Jul-2007	GRF		SR15558: Doco; Macros; remove unnecessary do level; use
	; 							braces for clarity; mark disabled block; if/else
	; 							braces replaces dot code
	; 19-Dec-2006	GRF		long lines => do level
	; 10-Nov-2006	GRF		FIXME; Naked References
	; 21-SEP-2006	FAN		SR14746 Sales statistics incorrect
	; 07-Aug-2006	GRF		doco
	; 27-Jul-2006	GRF		Doco; quits
	; 02-Sep-2005	JW		SR12966: INVORGB is not shared
	; 01-Sep-2005	JW		SR13151: Reverted SR12609
	; 23-Jul-2005	GRF		SR13024: Doco
	; 14-Jun-2005	Steve S	SR12609: Store cost override/Use WWWSPEI
	; 07-Sep-2004	PPP		LOCATION DEFAULT ON THE LINE
	; 08.02.2000	DT		Created
	;-------------------------------------------------------------------------------
	NEW KM,KUNDE,objLine,POSITION,YA
		
	;+++++++++++++++++++++++++++++++++++++++
	; YFELD			objINAUF		Order
	; 			and	objINAUF1	(localised use)
	; POS1			objINAUFP		Order Line
	;+++++++++++++++++++++++++++++++++++++++
	
	SET VORG(1)="#"_$GET(VORG(1))  ;SUCHE Artikel ;search Item
	SET %("VAR","YBACK")    = "INAUFNEU,"
	
	//Gustavo Fiuza, 22-Dez-07----------------------------------
	//Tive que comentar essas duas linhas abaixo para funcionar.	
	SET %("VAR","YAUSWAHL") = VORG(1)_"*SEARCH*"_VORG(10)       ;SUCHSTRATEGIE;FAN;26348;03.09.04
	SET %("VAR","YFORM")    = "INAUF"
	//------------------------------------------------------------
		
	;set ^CacheTempCostOverride(YUSER)=+$piece($get(VORG(1)),"+",3) ;SR12609	//SR13151
	
	SET YAUFTRAG = $$$KEY1($GET(YKEY))
	QUIT:YAUFTRAG=""
	IF '$DATA(^INAUF(YM,YAUFTRAG,1)) QUIT  ;NICHT SPEICHERN ;Not Save
	
	;---------------------------------------
	; D169 Complaint/Spare Part-Order  =>  D170 Inter-Info For Complaint/Spare Part-Order
	; REKLAMERKER
	SET YREKLA = $$$NO
	; $data(^INAUF) already tested above
	;IF $DATA(^INAUFP(YM,YAUFTRAG)) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,170)'="" SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,169)=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,170)  ;REKLA ALT
	IF $DATA(^INAUF(YM,YAUFTRAG,1)) SET YREKLA=+$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,169) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,170)=YREKLA
	;---------------------------------------
	
	;IF YREKLA=$$$YES DO
	DO
	. QUIT:YAUFTRAG=""      ; already tested above
	. NEW YPOS
	. SET YPOS = ""
	. FOR  SET YPOS = $ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . set objLine = $get(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . ;
	. . ; FIXME : The following field is based on an application parameter
	. . ;         yet YREKLA is a boolean.  What if the line was already
	. . ;         set to one of the other values (layby/consignment/etc.)?
	. . ;         Was original test for "1" correct?       <GRF> - Defect notification 10-Nov-2006
	. . ;         
	. . set $$$INAUFPComplaintSparePart(objLine) = +YREKLA
	. . do Save^COMUtils("INAUFP",YAUFTRAG_","_YPOS,objLine,1)
	. . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,YPOS,1),Y,169)=+YREKLA
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;	INVORGB	D2		Return Stock Location
	;---------------------------------------
	;IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,2)=0 DO   ;AUFTRAGSART=KUNDE   ;WEM;24673;24.11.2003;AUTOMATISCHES SETZEN DES RETOURENLAGERPLATZES (BETRIEB) WENN POSITION EINE MINUSMENGE IST
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . IF $PIECE(^INAUFP(YM,YAUFTRAG,YPOS,1),Y,223)="" DO   ;NOCH KEIN RETOURENLAGER EINGETRAGEN ;yet no regd. 
	. . . NEW DATE
	. . . SET DATE=$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,22)  ;ERFASSUNGSDATUM
	. . . SET DATE=$PIECE(DATE,",",1)
	. . . IF +$HOROLOG=DATE  IF $PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,5)<0 DO   ;ERFASSUNGSDATUM=AKTUELLES DATUM UND MENGE KLEINER 0 ;Date And quantity lesser 
	. . . . set objLine=$get(^INAUFP(YM,YAUFTRAG,YPOS,1)) ;Steve S, use WWWSPEI
	. . . . set $piece(objLine,Y,223)=$PIECE($GET(^INVORGB(YM,YM,YLOCATION,1)),Y,2)   ;RETOURENLAGERPLATZ
	. . . . set $piece(objLine,Y,224)=1
	. . . . do Save^COMUtils("INAUFP",YAUFTRAG_","_YPOS,objLine,1)
	. . . . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,YPOS,1),Y,223)=$PIECE($GET(^INVORGB(0,YM,YLOCATION,1)),Y,2)   ;RETOURENLAGERPLATZ
	. . . . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,YPOS,1),Y,224)=1   ;WARE SOLL VON KUNDE ZURÜCK ;wares customer back 
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	;---------------------------------------
	; Requisition
	;---------------------------------------
	;	D2		$$$INAUFOrderType()
	;	D12		$$$INAUFSupplierNumber()
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,2)=5 IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,12)'="" DO  ;REQUISITION UMWANDELN;FIS;04.04.05 ;transmute 
	. NEW YVOR,YFORM,YOK,POS1
	. QUIT:$GET(YFELD)=""
	. IF $PIECE(YFELD,Y,265)=1 SET $PIECE(YFELD,Y,12)="" DO  QUIT   ;VIE EINKAUFSMODUL
	. . SET YOK=$$^WWWSPEI("INAUF",YAUFTRAG,YFELD,1)
	. ;
	. SET $PIECE(YFELD,Y,2)=2   ;REQUISITION IN BESTELLUNG TAUSCHEN ;within sales order barter 
	. SET YOK=$$^WWWSPEI("INAUF",YAUFTRAG,YFELD,1)
	. DO  ;25931;TYBD;18,6,2004;BITMAP FÜR INAUF1
	. . NEW YFORM,YVOR,YFELD
	. . SET YFELD=$GET(^INAUF1(YM,YAUFTRAG,1))
	. . SET $PIECE(YFELD,Y,2)=2 
	. . SET YA=$$^WWWSPEI("INAUF1",YAUFTRAG,YFELD,1)   ;ZWISCHENDATEI SETZTEN
	. . ;SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,2)=2   ;SETZEN FELD
	. ;
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . SET $PIECE(POS1,Y,12) = $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,12)
	. . SET $PIECE(POS1,Y,6)  = $PIECE(POS1,Y,5)  ;SOURCED
	. . SET $PIECE(POS1,Y,7)  = 1                 ;BESTELLUNG ;sales order 
	. . NEW YVOR,YFORM,YOK
	. . SET YOK=$$^WWWSPEI("INAUFP",YAUFTRAG_","_YPOS,POS1,1)
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	;---------------------------------------
	;	D178	$$$INAUFCalculatePackage()					$$$INAUF1InterLocation
	;	D179	$$$INAUFCalculateFreight()					$$$INAUF1InterLocation1
	;	D180	$$$INAUFCalculateInsurance()				$$$INAUF1InterLocation2
	;	D181	$$$INAUFCalculateDistance()					$$$INAUF1InterLocation3
	;	D303	$$$INAUFReCalculateSpecialSurcha[ge]()		$$$INAUF1TemporaryField1
	;---------------------------------------
	;NEUE BERECHNUNG J/N DER KM/VP/...
	;FOR YA=178,179,180,181 {                           ;NEU BERECHNEN IN ZWISCHESPEICHER
	FOR YA=178,179,180,181,303 {                        ;BEC;03.02.04;24591;FELD 303 HINZUGEFÜGT  ;11-Jul-2007
		IF $PIECE($GET(^INAUF1(YM,YAUFTRAG,1)),Y,YA)=$$$YES {
			SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,YA)  = $$$YES
			SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,YA) = $$$NO    ; original 0 not "" retained
		}
	}
	
	;---------------------------------------
	;	D1		$$$INAUFCustomerNumber
	;	D2		$$$INAUFOrderType			0 : Cust Order, 1 : Mfg Order, 2 Purch Order, ...
	;	D12		$$$INAUFSupplierNumber
	;	D13		$$$INAUFShortName					D1		$$$INAUF1OrderText
	;---------------------------------------
	IF +$$$INAUFOrderCompleted(YFELD)=$$$NO DO                       ; 11-Jul-2007
	. QUIT:'$DATA(^INAUFP(YM,YAUFTRAG))  ;KEINE POSITION ;no order lines
	. IF '$DATA(^INAUF1(YM,YAUFTRAG,1)) DO
	. . DO  ;25931;TYBD;18,6,2004;BITMAP FÜR INAUF1
	. . . NEW YFORM,YVOR
	. . . SET YA=$$^WWWSPEI("INAUF1",YAUFTRAG,Y_$PIECE(YFELD,Y,2)_Y_Y_$PIECE(YFELD,Y,4),1)
	. . . ;SET ^INAUF1(YM,YAUFTRAG,1)=Y_$PIECE(YFELD,Y,2)_Y_Y_$PIECE(YFELD,Y,4)  ;NOCH NICHT ERLEDIGT
	. . ;
	. . IF $PIECE(YFELD,Y,2)=1 SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1)=$$^WWWTEXT(32037)  ; "Manufacturing Order"  ;EIGEN ;personal 
	. . ;
	. . IF $PIECE(YFELD,Y,2)=0 IF $PIECE(YFELD,Y,1)'=""  do
	. . . SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1) = $PIECE($GET(^INKUNDE(YM,$PIECE(YFELD,Y,1),1)),Y,8)  ;KUNDE     ;customer
	. . ;
	. . IF $PIECE(YFELD,Y,2)=2 IF $PIECE(YFELD,Y,12)'="" do
	. . . SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1) = $PIECE($GET(^INLIEF(YM,$PIECE(YFELD,Y,12),1)),Y,8)  ;LIEFERANT ;supplier
	. . IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,2)'=1 DO ^INAUF1SEL()  ;NEUER AUFTRAG IN ZWISCHENDATEI ;company within 
	. ;
	. IF $DATA(^INAUF1(YM,YAUFTRAG,1)) DO
	. . IF $PIECE(YFELD,Y,2)=1 do
	. . . SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1)=$$^WWWTEXT(32037)   ; "Manufacturing Order"
	. . . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,13)=$$^WWWTEXT(32037)   ;EIGEN ;personal 
	. . ;
	. . IF $PIECE(YFELD,Y,2)=0 IF $PIECE(YFELD,Y,1)'=""  do
	. . . SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1) = $PIECE($GET(^INKUNDE(YM,$PIECE(YFELD,Y,1),1)),Y,8)
	. . . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,13) = $PIECE($GET(^INKUNDE(YM,$PIECE(YFELD,Y,1),1)),Y,8)  ;KUNDE     ;customer
	. . ;
	. . IF $PIECE(YFELD,Y,2)=2 IF $PIECE(YFELD,Y,12)'="" do
	. . . SET $PIECE(^INAUF1(YM,YAUFTRAG,1),Y,1) = $PIECE($GET(^INLIEF(YM,$PIECE(YFELD,Y,12),1)),Y,8)
	. . . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,13) = $PIECE($GET(^INLIEF(YM,$PIECE(YFELD,Y,12),1)),Y,8)  ;LIEFERANT ;supplier
	
	; vvvvv SR15558
	;AUFTRAGSSPERRE FREI ;unreserved 
	; User/Date
	if $$$INAUFBlockPurchaseOrder(^INAUF(YM,YAUFTRAG,1))=$$$YES {
		set $$$INAUFReleasedThrough(^INAUF(YM,YAUFTRAG,1)) = ""
		set $$$INAUFReleasedThrough(YFELD)                 = ""
		set $$$INAUFReleasedOn(^INAUF(YM,YAUFTRAG,1))      = ""
		set $$$INAUFReleasedOn(YFELD)                      = ""
		
	} else {
		set $$$INAUFReleasedThrough(^INAUF(YM,YAUFTRAG,1)) = YBED
		set $$$INAUFReleasedThrough(YFELD)                 = YBED
		set $$$INAUFReleasedOn(^INAUF(YM,YAUFTRAG,1))      = $horolog
		set $$$INAUFReleasedOn(YFELD)                      = $horolog
		
	}
	
	/* replaces
	IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,38)=0 DO   ;KEINE SPERRE=FREIGEGEBEN
	. IF $PIECE(YFELD,Y,39)="" SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,39)=YBED      ;MITARBEITER ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,39)="" SET $PIECE(YFELD,Y,39)=YBED                                   ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,40)="" SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,40)=$HOROLOG  ;DATUM       ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,40)="" SET $PIECE(YFELD,Y,40)=$HOROLOG                               ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. ;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	. ;SET POSITION="" FOR  SET POSITION=$ORDER(^INAUFP(YM,YAUFTRAG,POSITION)) QUIT:POSITION=""  DO
	. . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,205)=0   ;SPERRE ;suspension // SR14746
	. . ;IF $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,206)="" SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,206)=YBED   ;MITARBEITER  ;15.06.04;25860;NUR WENN KEINE DATEN DA IST
	. . ;IF $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,207)="" SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,207)=$HOROLOG   ;DATUM   ;15.06.04;25860;NUR WENN KEINE DATEN DA IST
	. ;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END
	
	;AUFTRAGSSPERRE EIN ;uni- 
	IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,38)=1 DO   ;KEINE SPERRE=FREIGEGEBEN ;no 
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,39)=""   ;MITARBEITER
	. SET $PIECE(YFELD,Y,39)=""
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,40)=""   ;DATUM ;Date 
	. SET $PIECE(YFELD,Y,40)=""
	. ;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	. ;SET POSITION="" FOR  SET POSITION=$ORDER(^INAUFP(YM,YAUFTRAG,POSITION)) QUIT:POSITION=""  DO
	. . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,205)=1    ;SPERRE ;suspension   // SR14746
	. . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,206)=""   ;MITARBEITER
	. . ;SET $PIECE(^INAUFP(YM,YAUFTRAG,POSITION,1),Y,207)=""   ;DATUM ;Date
	. ;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END
	;^^^^^ */
	
	
	;---------------------------------------
	;	D16		$$$INAUFShipVia()
	;	D95		$$$INAUFPShipping()
	;---------------------------------------
	;VERSAND VIA EINFÜGEN   ;WEM;25450;01.04.2004;KOPIEREN VON VERSAND VIA IN POS FÜR VERSANDPLANUNG
	IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,16)'="" DO
	. NEW POS,POS1,YKEY,YVOR
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . SET $PIECE(POS1,Y,95)=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,16)
	. . SET YKEY=YAUFTRAG_","_POS
	. . NEW YOK,YFORM,YVOR
	. . SET YOK=$$^WWWSPEI("INAUFP",YKEY,POS1,1)
	
	;---------------------------------------
	;	D6		$$$INAUFLocation()
	;	D363	$$$INAUFPWorkflow()
	;---------------------------------------
	; LOCATION DEFAULT ON THE LINE PP 07-Sep-2004
	; FIXME : <GRF> D363 is *NOT* a location field - it uses the relation INWF rather than WWW0121
	;               Possibly should be D443 "Source Location" but not clear what use is applied as the
	;               help message for D6 refers to company rather than site location.
	IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,6)'="" DO
	. NEW POS,POS1,YKEY,YVOR
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . quit:$PIECE(POS1,Y,363)'=""
	. . SET $PIECE(POS1,Y,363)=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,6)
	. . SET YKEY=YAUFTRAG_","_POS
	. . NEW YOK,YFORM,YVOR
	. . SET YOK=$$^WWWSPEI("INAUFP",YKEY,POS1,1)
	
	;VEREINBARTER LIEFERTERMIN IN DIE VERSANDPLANUNG ÜBERTRAGEN ;time of delivery within who transport 
	;	INVORG	D74		$$$INVORGTransferDeliveryDate()	Transfer Date Of Delivering In Tracking Plan
	;			D19		$$$INAUFPRequiredDeliveryDate()
	;			D76		$$$INAUFPDeliveryDate()
	;---------------------------------------
	IF $PIECE($GET(^INVORG(YM,YM,1)),Y,74) = $$$YES DO    
	. NEW TERM,POS,POS1,YKEY,YVOR,YFORM,YOK  ;TYBD;YVOR NEW
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . QUIT:$PIECE(POS1,Y,76)'=""  ;VERSAND BEREITS GEPLANT ;shipping yet ; Planned Delivery Date
	. . SET TERM=$PIECE(POS1,Y,19)  ;TERMIN AUFTRAGSPOSITION ; Required Delivery Date
	. . IF TERM="" SET TERM=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,19)  ;TERMIN AUFTRAG ;mandate ; Required Delivery Date
	. . IF TERM'="" DO ; if there is a required delivery date on either the order line or the order header
	. . . SET $PIECE(POS1,Y,76)=TERM
	. . . SET YKEY=YAUFTRAG_","_POS
	. . . SET YOK=$$^WWWSPEI("INAUFP",YKEY,POS1,1)
	. . . DO ^INAUFTO1  ;SPEICHERN TOUR-PLANUNG ;Save 
	
	//VEREINBARTER LIEFERTERMIN IN ALLE POSITIONEN ÜBERTRAGEN;FIS;26074;12.07.04
	;---------------------------------------
	;	D19		$$$INAUFRequiredDeliveryDate()
	;	D19		$$$INAUFPRequiredDeliveryDate()
	;---------------------------------------
	IF $PIECE(YFELD,Y,19)'="" DO ; if there is a required delivery date on order header
	. NEW TERM,POS,POS1,YKEY,YVOR,YOK,YFORM
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . IF $PIECE(POS1,Y,19)="" DO                  //TERMIN NOCH OFFEN ; if there is no required delivery date on the order line
	. . . SET $PIECE(POS1,Y,19)=$PIECE(YFELD,Y,19)  //TERMIN AUFTRAGSPOSITION
	. . . NEW YFORM,YVOR,YOK
	. . . SET YOK=$$^WWWSPEI("INAUFP",YAUFTRAG_","_POS,POS1,1)
	. . . DO ^INAUFTO1  //SPEICHERN TOUR-PLANUNG
	
	//GEÄNDERTES AUFTRAGSDATUM IN ALLE POSITIONEN ÜBERTRAGEN;FIS;03.03.05
	;---------------------------------------
	;	D4		$$$INAUFOrderDate()
	;	D193	$$$INAUFPOrderDate()
	;---------------------------------------
	IF $PIECE(YFELD,Y,4)'=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,4) DO
	. NEW POS
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . DO
	. . . SET $PIECE(POS1,Y,193)=$PIECE(YFELD,Y,4)
	. . . NEW YFORM,YVOR,YOK
	. . . SET YOK=$$^WWWSPEI("INAUFP",YAUFTRAG_","_POS,POS1,1)
	
	//POSITIONSRABATT IN ALLE POSITIONEN ÜBERTRAGEN;FIS;27.07.04;26150
	;---------------------------------------
	;	D70		$$$INAUFDiscountPerLineItem()
	;	D122	$$$INAUFPLineItemDiscount()
	;---------------------------------------
	IF +$PIECE(YFELD,Y,70)'=0 DO
	. NEW TERM,POS,POS1,YKEY,YVOR,YOK,YFORM
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . IF $PIECE(POS1,Y,122)'=$PIECE(YFELD,Y,70) DO  //RABATT IN POSITION
	. . . SET $PIECE(POS1,Y,122)=$PIECE(YFELD,Y,70)
	. . . DO
	. . . . NEW YFELD
	. . . . SET YFELD=POS1
	. . . . DO EH^INBRUTTONETTO                  ; Updates YFELD ByRef
	. . . . SET POS1=YFELD
	. . . ;
	. . . SET YOK=$$^WWWSPEI("INAUFP",YAUFTRAG_","_POS,POS1,1)
	
	;---------------------------------------
	;	D1		$$$INAUFCustomerNumber()
	;	D2		$$$INAUFOrderType()
	;	D12		$$$INAUFSupplierNumber()
	;---------------------------------------
	
	;IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,2)="" DO         ;KEINE AUFTRAGSART     ;no order type
	;. IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)'="" DO      ;KUNDE                 ;have a customer
	;. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,2)=0 DO     // SR14746;AUFTRAGSART KUNDE     ;set to customer order 
	;. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,12)="" DO   // SR14746;AUFTRAGSART LIEFERANT ;clear supplier (?)
	;. ; 
	;. IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,12)'="" DO     ;LIEF                  ;have a supplier
	;. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,2)=2 DO     // SR14746;AUFTRAGSART LIEFERANT ;set to supplier order
	;. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)="" DO    // SR14746;AUFTRAGSART KUNDE     ;clear customer (?) 
	
	; Determine order type from presense of Customer or Supplier - can only have one
 	IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,2)=""  DO                   // SR14746
 	. NEW SATZ
 	. SET SATZ=$GET(^INAUF(YM,YAUFTRAG,1))
 	. IF $PIECE(SATZ,Y,1)'=""  SET $PIECE(SATZ,Y,2)=0 SET $PIECE(SATZ,Y,12) = ""
 	. IF $PIECE(SATZ,Y,12)'="" SET $PIECE(SATZ,Y,2)=2 SET $PIECE(SATZ,Y,1)  = ""
 	. ;DO SAVE^WWWSPEI("INAUF",YAUFTRAG,SATZ,1)     // SR14746
 	. set strStatus=$$$Save("INAUF",YAUFTRAG,SATZ,$$$YES) // SR14746
	
	;KEIN BETRIEB GEWÄHLT ;no BETRIEB 
	;---------------------------------------
	;	D6		$$$INAUFLocation()
	;	D44		$$$WWW013HomeLocation()
	;---------------------------------------
	IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,6)="" DO
	. new idResponsible
	. set idResponsible = $$$INAUFResponsible($GET(^INAUF(YM,YAUFTRAG,1)))
	. IF idResponsible'="" IF $PIECE($GET(^WWW013(0,idResponsible,1)),Y,44)'="" DO  QUIT  ;BETRIEB DES ZUST. MITARBEITERS
	. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,6) = $PIECE($GET(^WWW013(0,idResponsible,1)),Y,44)
	. ;
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,6) = $GET(YLOCATION)  ;BETRIEB DES AKTUELLEN BENUTZERS
	
	DO ZUSATZ()
	
	QUIT
	
ZUSATZ(YRECH1,YRECHF1)
	;-------------------------------------------------------------------------------
	;	NEURECHNEN ZUSATZKOSTEN  -> EINSPRUNG AUS INAUFP;FIS;02.02.05;27220
	;	RECALCULATE ADDITIONAL CHARGES (e.g. FREIGHT, PACKAGING, INSURANCE)
	;
	;YAUFTRAG	AUFTRAGSNUMMER
	;YFELD		AUFTRAG DATENSATZ      (objINAUF from call by INAUF)
	;YRECH		1 = AUTOMATISCH NEURECHNEN
	;YRECHF		1 = NUR FÄLLIGE (LIEFERFÄHIG/GELIEFERT) POSITIONEN FÜR DIE BERECHNUNG HERANZIEHEN
	;
	;	INVORG	D209		Constant Recalculation Of Additional Costs In Order		$$$INVORGRecalcAdditionalCosts()      bln
	;			D215		Constant Calculation Of Additional Costs In Line Item	$$$INVORGCalcAdditionalCostsInLine()  bln
	;-------------------------------------------------------------------------------
	NEW YRECH,YRECHF
	
	SET YRECH=+$PIECE($GET(^INVORG(YM,YM,1)),Y,209)  ;ZUSATZKOSTEN IMMER NEU RECHNEN;FIS;02.02.05;27220
	IF $GET(YRECH1)=1 SET YRECH = $$$YES
	SET YRECHF=""                              ;NUR POSITIONEN BERÜCKSICHTIGEN, DIE FÄLLIG SIND;FIS;02.02.05;27220
	IF $GET(YRECHF1)=1 SET YRECHF=1
	
	IF $PIECE($GET(^INVORG(YM,YM,1)),Y,215) = $$$YES IF $DATA(^INAUFPIMPACT(YM,YAUFTRAG)) DO  ;ZUSATZKOSTEN JE POSITION;07.03.05;27445
	. NEW POS,LFN,SATZ
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFPIMPACT(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET LFN=""
	. . FOR  SET LFN=$ORDER(^INAUFPIMPACT(YM,YAUFTRAG,POS,LFN)) QUIT:LFN=""  DO
	. . . NEW YKEY,YFELD
	. . . SET YKEY=YAUFTRAG_","_POS_","_LFN
	. . . SET YFELD=$GET(^INAUFPIMPACT(YM,YAUFTRAG,POS,LFN,1))
	. . . DO ^INAUFPIMPACT
	
	;+++++++++++++++++++++++++++++++++++++++
	;ENTFERNUNGSPAUSCHALE RECHNEN ;estimated distance calculation(?) 
	;+++++++++++++++++++++++++++++++++++++++
	
	;		D28			$$$INVORGAmountPerKilometre
	;		D150		$$$INVORGInvoiceDeliverySlipOnlyWh()  : "VERSANDSTATUS"
	SET KUNDE = $PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)                         ;KUNDE ;customer
	SET KM    = $PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	IF KUNDE'="" IF +KM=0 SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	IF +KM'=0 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)=KM
	IF (YRECH=1) || (+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,181)=$$$YES) DO   ;ERRECHNEN PAUSCHALE
	. IF YRECH=1 IF YRECHF'=1 IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,245)=$$$YES QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,181)'=$$$YES  ;NUR WENN NOCH NICHT BERECHNET;FIS;02.02.05;27220
	. NEW KMGELD,YQ,YPOS,YPOS1
	. QUIT:KUNDE=""                                   ;KEIN KUNDE ;no customer 
	. SET KMGELD=$PIECE($GET(^INVORG(YM,YM,1)),Y,28)  ;KMPAUSCHALSATZ BETRAG ;Sum 
	. QUIT:+KMGELD=0                                  ;KEIN KMGELD ;no 
	. SET KM=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	. QUIT:+KM=0
	. ;
	. SET YQ=0
	. IF YRECHF=1 DO  ;NUR WENN POSITIONEN, DIE FÄLLIG SIND;FIS;02.02.05;27220
	. . SET YQ=1
	. . SET YPOS = ""
	. . FOR  SET YPOS = $ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . . SET YPOS1 = $GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . . QUIT:$PIECE(YPOS1,Y,26)=2                         ;KEIN TRANSPORT BEI LEISTUNG ;not for Services
	. . . IF $PIECE(YPOS1,Y,97)'="" QUIT                    ;BEREITS BERECHNET;FIS;02.02.05;27220
	. . . IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=1 IF '$PIECE(YPOS1,Y,90)   QUIT   ;NUR AUSLIEFERUNGSFÄHIGE;FIS;02.02.05;27220
	. . . IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=2 IF $PIECE(YPOS1,Y,92)="" QUIT   ;NUR GELIEFERTE;FIS;02.02.05;27220
	. . . SET YQ=0
	. ;
	. QUIT:YQ=1
	. IF YRECHF=1 QUIT:+(KMGELD*KM)=0 
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,187) = KM
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,185) = KMGELD*KM   ;KILOMETERGELD
	. SET $PIECE(YFELD,Y,185)                 = KMGELD*KM 
	. IF YRECHF=1 IF +(KMGELD*KM)'=0 DO  ;ALS NOCH NICHT BERECHNET SPEICHERN;FIS;02.02.05;27220
	. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,245)=""     ; FIXME : $$$INAUFInvoiced3 - boolean so why distance calculation?
	. . SET $PIECE(YFELD,Y,245)=KMGELD*KM
	
	;+++++++++++++++++++++++++++++++++++++++
	;FRACHTKOSTEN RECHNEN ;freight calculation
	;+++++++++++++++++++++++++++++++++++++++
	
	IF (YRECH=1) || ($PIECE(^INAUF(YM,YAUFTRAG,1),Y,179)) DO   ;ERRECHNEN FRACHTKOSTEN
	. IF YRECH=1 IF YRECHF'=1 IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,243) QUIT:'$PIECE(^INAUF(YM,YAUFTRAG,1),Y,179)  ;NUR WENN NOCH NICHT BERECHNET;FIS;02.02.05;27220
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,FRACHTFREI,VOLUMEN,GEWICHT,YPOS1
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0   ;GESAMTBETRAG
	. SET GEWICHT = 0   ;GESAMTBETRAG
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL
	. SET YPOS    = ""
	. FOR  SET YPOS = $ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . SET YPOS1 = $GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . QUIT:$PIECE(YPOS1,Y,26)=2                        ;KEIN TRANSPORT BEI LEISTUNG ;not for Services
	. . IF YRECHF=1 IF $PIECE(YPOS1,Y,97)'=""                                          QUIT   ;BEREITS BERECHNET;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=1 IF '$PIECE(YPOS1,Y,90)   QUIT   ;NUR AUSLIEFERUNGSFÄHIGE;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=2 IF $PIECE(YPOS1,Y,92)="" QUIT   ;NUR GELIEFERTE;FIS;02.02.05;27220
	. . SET BETRAG  = BETRAG +$PIECE(YPOS1,Y,123)   ;NETTOVERKAUFSPREIS
	. . SET VOLUMEN = VOLUMEN+$PIECE(YPOS1,Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT+$PIECE(YPOS1,Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK +$PIECE(YPOS1,Y,5)     ;STUECK
	. ;
	. IF +KOSTEN=0 DO
	. . SET KUNDE      = $PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)  ;KUNDE ;customer 
	. . SET FRACHTFREI = 0
	. . IF KUNDE'="" SET FRACHTFREI=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,42)  ;FRACHTFREI AB ;Confirm. 
	. . IF (+FRACHTFREI=0) || (FRACHTFREI>BETRAG) DO   ;NICHTFRACHTFREI=BERECHNEN
	. . . NEW AB,VERSAND
	. . . SET VERSAND=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,16)  ;WIE TRANSPORTIEREN? ;such as 
	. . . QUIT:VERSAND=""
	. . . ;
	. . . ;FESTER BETRAG ;Sum 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND+0.1,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,5,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . QUIT:+KOSTEN'=0
	. . . ;
	. . . ;KG
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,2,+GEWICHT+.01),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,2,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . QUIT:+KOSTEN'=0
	. . . ;
	. . . ;VOLUMEN ;volume 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,3,+VOLUMEN+.01),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,3,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . QUIT:+KOSTEN'=0
	. . . ;
	. . . ;BETRAG ;Sum 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,1,+BETRAG+.01),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,1,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . QUIT:+KOSTEN'=0
	. . . ;
	. . . DO
	. . . . SET KM=0
	. . . . IF KUNDE'="" SET KM = $PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . . IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)'=0 SET KM = $PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	. . . . QUIT:+KM=0
	. . . . ;
	. . . . ;KG
	. . . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,4,+KM+.01),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,4,AB,1))
	. . . . . IF +$PIECE(KOSTEN1,Y,1)'=0 IF AB=1 SET KOSTEN = $PIECE(KOSTEN1,Y,1)*KM QUIT
	. . . . . IF +$PIECE(KOSTEN1,Y,1)'=0         SET KOSTEN = $PIECE(KOSTEN1,Y,1)    QUIT
	. . . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN = $JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . QUIT:+KOSTEN'=0
	. . . ;
	. . . ;STUECK
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,6,+STUECK+1),-1)  ;BERECHNUNG AB STUECK ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH STUECK ;within 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,6,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN = $PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN = $JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. IF YRECHF=1 QUIT:+KOSTEN=0 
	. SET $$$INAUFFreightAmount(^INAUF(YM,YAUFTRAG,1)) = KOSTEN   ;VERSANDKOSTEN
	. SET $$$INAUFFreightAmount(YFELD)                 = KOSTEN
	. IF YRECHF=1 IF +KOSTEN'=0 DO  ;ALS NOCH NICHT BERECHNET SPEICHERN;FIS;02.02.05;27220
	. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,243) = ""     ; FIXME : $$$INAUFInvoiced1 - boolean so why cost?
	. . SET $PIECE(YFELD,Y,243)                 = KOSTEN
	
	
	;+++++++++++++++++++++++++++++++++++++++
	; Packaging calculation       ;VERPACKUNG BERECHNEN
	;+++++++++++++++++++++++++++++++++++++++
	
	IF (YRECH=1)||(+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,178)=1) DO   ;ERRECHNEN VERPACKUNGSKOSTEN ;packing expenses 
	. IF YRECH=1 IF YRECHF'=1 IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,242)=1 QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,178)'=1  ;NUR WENN NOCH NICHT BERECHNET;FIS;02.02.05;27220
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,YPOS1
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0   ;GESAMTBETRAG
	. SET GEWICHT = 0   ;GESAMTBETRAG
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL
	. SET YPOS    = ""
	. FOR  SET YPOS = $ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . SET YPOS1 = $GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . QUIT:$PIECE(YPOS1,Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;not for Services
	. . ;
	. . IF YRECHF=1 IF $PIECE(YPOS1,Y,97)'=""                                          QUIT   ;BEREITS BERECHNET;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=1 IF '$PIECE(YPOS1,Y,90)   QUIT   ;NUR AUSLIEFERUNGSFÄHIGE;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=2 IF $PIECE(YPOS1,Y,92)="" QUIT   ;NUR GELIEFERTE;FIS;02.02.05;27220
	. . SET BETRAG  = BETRAG  + $PIECE(YPOS1,Y,123)   ;NETTOVERKAUFSPREIS
	. . SET VOLUMEN = VOLUMEN + $PIECE(YPOS1,Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT + $PIECE(YPOS1,Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK  + $PIECE(YPOS1,Y,5)     ;STUECK
	. . ;QUIT:$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;no transport next to performance 
	. . ;SET BETRAG=BETRAG+$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,123)  ;NETTOVERKAUFSPREIS
	. . ;SET VOLUMEN=VOLUMEN+$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,44)  ;VOLUMEN ;volume 
	. . ;SET GEWICHT=GEWICHT+$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,43)  ;GEWICHT ;wt. 
	. . ;SET STUECK=STUECK+$PIECE($GET(^INAUFP(YM,YAUFTRAG,YPOS,1)),Y,5)     ;STUECK
	. ;
	. IF +KOSTEN=0 DO   ;VERPACKUNG ;wrapping 
	. . QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,186)=""    ;KEINE VERPACKUNG ANGEGEBEN ;no wrapping 
	. . NEW AB,VERPACK
	. . SET VERPACK=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,186)  ;WIE VERPACKEN? ;such as 
	. . QUIT:VERPACK=""
	. . ;
	. . ;FESTER BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,5,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;KG
	. . ;SET AB=+GEWICHT ;table-mat 
	. . ;IF '$DATA(^INVERPACK(YM,VERPACK,2,+GEWICHT)) SET AB=$ORDER(^INVERPACK(YM,VERPACK,2,+GEWICHT),-1)  ;BERECHNUNG AB GEWICHT
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,2,+GEWICHT+.01),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,2,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;VOLUMEN ;volume 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,3,+VOLUMEN+.01),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,3,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,1,+BETRAG+.01),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,1,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . DO
	. . . SET KM=0
	. . . QUIT:+KOSTEN'=0
	. . . SET KUNDE=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)  ;KUNDE ;customer 
	. . . QUIT:KUNDE=""   ;KEIN KUNDE ;no customer 
	. . . SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)'=0 SET KM=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	. . . QUIT:+KM=0
	. . . ;
	. . . ;KG
	. . . SET AB=$ORDER(^INVERPACK(YM,VERPACK,4,+KM+.01),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within worthy 
	. . . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,4,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,]]><![CDATA[1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;STUECK
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,6,+STUECK+1),-1)  ;BERECHNUNG AB STUECK ;Confirm. 
	. . IF AB'="" DO   ;BERECHNUNG NACH STUECK ;within 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,6,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. IF YRECHF=1 QUIT:+KOSTEN=0 
	. SET $$$INAUFPackageAmount(^INAUF(YM,YAUFTRAG,1))=KOSTEN   ;VERPACKKOSTEN
	. SET $$$INAUFPackageAmount(YFELD)=KOSTEN
	. IF YRECHF=1 IF +KOSTEN'=0 DO  ;ALS NOCH NICHT BERECHNET SPEICHERN;FIS;02.02.05;27220
	. . SET $$$INAUFInvoiced(^INAUF(YM,YAUFTRAG,1))=""     ; FIXME : $$$INAUFInvoiced - boolean so why cost?
	. . SET $$$INAUFInvoiced(YFELD)=KOSTEN
	
	;+++++++++++++++++++++++++++++++++++++++
	;VERSICHERUNG BERECHNEN ;insurance calculate 
	;+++++++++++++++++++++++++++++++++++++++
	
	IF (YRECH=1)||(+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,180)=1) DO   ;ERRECHNEN VERSICHERUNGGSKOSTEN
	. IF YRECH=1 IF YRECHF'=1 IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,244)=1 QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,180)'=1  ;NUR WENN NOCH NICHT BERECHNET;FIS;02.02.05;27220
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,YPOS1
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0   ;GESAMTBETRAG
	. SET GEWICHT = 0   ;GESAMTBETRAG
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . SET YPOS1=$GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . QUIT:$PIECE(YPOS1,Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;no transport next to performance
	. . ;
	. . IF YRECHF=1 IF $PIECE(YPOS1,Y,97)'=""                                          QUIT  ;BEREITS BERECHNET;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=1 IF '$PIECE(YPOS1,Y,90)   QUIT  ;NUR AUSLIEFERUNGSFÄHIGE;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=2 IF $PIECE(YPOS1,Y,92)="" QUIT  ;NUR GELIEFERTE;FIS;02.02.05;27220
	. . SET BETRAG  =BETRAG  + $PIECE(YPOS1,Y,123)   ;NETTOVERKAUFSPREIS
	. . SET VOLUMEN =VOLUMEN + $PIECE(YPOS1,Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT =GEWICHT + $PIECE(YPOS1,Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  =STUECK  + $PIECE(YPOS1,Y,5)     ;STUECK
	. ;
	. ;IF +KOSTEN'=0 DO   ;VERSICHERUNG    ;BEC;28.01.04;
	. IF +KOSTEN=0 DO   ;VERSICHERUNG ;insurance 
	. . QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,26)=""    ;KEINE VERSICHERUNG ANGEGEBEN ;no insurance 
	. . NEW AB,VERSICH
	. . SET VERSICH=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,26)  ;WIE VERSICHERN? ;such as 
	. . QUIT:VERSICH=""
	. . ;
	. . ;FESTER BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,5,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;KG
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,2,+GEWICHT+.01),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,2,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;VOLUMEN ;volume 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,3,+VOLUMEN+.01),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,3,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,1,+BETRAG+.01),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,1,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . DO
	. . . SET KM=0
	. . . SET KUNDE=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)  ;KUNDE ;customer 
	. . . QUIT:KUNDE=""   ;KEIN KUNDE ;no customer 
	. . . SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM
	. . . IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)'=0 SET KM=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	. . . QUIT:+KM=0
	. . . ;
	. . . ;KG
	. . . SET AB=$ORDER(^INVERSICH(YM,VERSICH,4,+KM+.01),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value
	. . . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,4,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;STUECK
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,6,+STUECK+1),-1)  ;BERECHNUNG AB STUECK ;Confirm. 
	. . IF AB'="" DO   ;BERECHNUNG NACH STUECK ;within 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,6,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. IF YRECHF=1 QUIT:+KOSTEN=0 
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,184)=KOSTEN   ;VERSICHKOSTEN
	. SET $PIECE(YFELD,Y,184)=KOSTEN
	. IF YRECHF=1 IF +KOSTEN'=0 DO  ;ALS NOCH NICHT BERECHNET SPEICHERN;FIS;02.02.05;27220
	. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,244) = ""     ; FIXME : $$$INAUFInvoiced2 - boolean so why cost?
	. . SET $PIECE(YFELD,Y,244)                 = KOSTEN
	
	;+++++++++++++++++++++++++++++++++++++++
	;SPEZIALZUSCHLAG RECHNEN ;special extras 
	;+++++++++++++++++++++++++++++++++++++++
	
	;IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,210)'="" DO   ;ERRECHNEN SPEZIALZUSCHLAG
	IF (YRECH=1)||(+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,303)=1) DO
	. IF YRECH=1 IF YRECHF'=1 IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,246)=1 QUIT:$PIECE(^INAUF(YM,YAUFTRAG,1),Y,303)'=1  ;NUR WENN NOCH NICHT BERECHNET;FIS;02.02.05;27220
	. QUIT:$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,210)=""    ;ERRECHNEN SPEZIALZUSCHLAG
	. ;QUIT:+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,211)'=0  ;BETRAG BEREITS MANUELL ERFASST
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,ZUSCHLAG,YPOS1
	. SET ZUSCHLAG=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,210)
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0   ;GESAMTBETRAG
	. SET GEWICHT = 0   ;GESAMTBETRAG
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INAUFP(YM,YAUFTRAG,YPOS)) QUIT:YPOS=""  DO
	. . SET YPOS1=$GET(^INAUFP(YM,YAUFTRAG,YPOS,1))
	. . IF YRECHF=1 IF $PIECE(YPOS1,Y,97)'=""                                          QUIT  ;BEREITS BERECHNET;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=1 IF '$PIECE(YPOS1,Y,90)   QUIT  ;NUR AUSLIEFERUNGSFÄHIGE;FIS;02.02.05;27220
	. . IF YRECHF=1 IF $PIECE($GET(^INVORG(YM,YM,1)),Y,150)=2 IF $PIECE(YPOS1,Y,92)="" QUIT  ;NUR GELIEFERTE;FIS;02.02.05;27220
	. . SET BETRAG  = BETRAG  + $PIECE(YPOS1,Y,123)   ;NETTOVERKAUFSPREIS
	. . SET VOLUMEN = VOLUMEN + $PIECE(YPOS1,Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT + $PIECE(YPOS1,Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK  + $PIECE(YPOS1,Y,5)     ;STUECK
	. ;
	. DO
	. . ;FESTER BETRAG ;Sum 
	. . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,5,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;KG
	. . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,2,+GEWICHT+.01),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,2,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;VOLUMEN ;volume 
	. . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,3,+VOLUMEN+.01),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,3,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;AUFTRAGSWERT
	. . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,1,+BETRAG+.01),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,1,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;KM
	. . DO
	. . . SET KM=0
	. . . SET KUNDE=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,1)  ;KUNDE ;customer 
	. . . IF KUNDE'="" SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . IF +$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)'=0 SET KM=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,187)
	. . . QUIT:+KM=0
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,4,+KM+.01),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,4,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . QUIT:+KOSTEN'=0
	. . ;
	. . ;STUECK
	. . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,6,+STUECK+1),-1)  ;BERECHNUNG AB STUECK ;Confirm. 
	. . IF AB'="" DO   ;BERECHNUNG NACH STUECK ;within 
	. . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,6,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. ; <GRF> Marker for SR15183
	. ;
	. IF YRECHF=1 QUIT:+KOSTEN=0 
	. SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,211)=KOSTEN   ;BETRAG SPEZIALZUSCHLAG ;Sum 
	. SET $PIECE(YFELD,Y,211)=KOSTEN
	. IF YRECHF=1 IF +KOSTEN'=0 DO  ;ALS NOCH NICHT BERECHNET SPEICHERN;FIS;02.02.05;27220
	. . SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,246) = ""     ; FIXME : $$$INAUFInvoiced4 - boolean so why cost?
	. . SET $PIECE(YFELD,Y,246)                 = KOSTEN
	
	;+++++++++++++++++++++++++++++++++++++++
	
	IF YRECH=1 DO  QUIT  ;FIS;02.02.05;27220
	. IF ($PIECE(YFELD,Y,242)'=1) && (YRECHF'=1) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,178) = $$$YES
	. IF ($PIECE(YFELD,Y,242)=1)  || (YRECHF=1)  SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,178) = $$$NO
	. IF ($PIECE(YFELD,Y,243)'=1) && (YRECHF'=1) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,179) = $$$YES
	. IF ($PIECE(YFELD,Y,243)=1)  || (YRECHF=1)  SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,179) = $$$NO
	. IF ($PIECE(YFELD,Y,244)'=1) && (YRECHF'=1) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,180) = $$$YES
	. IF ($PIECE(YFELD,Y,244)=1)  || (YRECHF=1)  SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,180) = $$$NO
	. IF ($PIECE(YFELD,Y,245)'=1) && (YRECHF'=1) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,181) = $$$YES
	. IF ($PIECE(YFELD,Y,245)=1)  || (YRECHF=1)  SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,181) = $$$NO
	. IF ($PIECE(YFELD,Y,246)'=1) && (YRECHF'=1) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,303) = $$$YES
	. IF ($PIECE(YFELD,Y,246)=1)  || (YRECHF=1)  SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,303) = $$$NO
	
	;IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,2)'=1 DO ^INAUF1SEL()  ;NEUER AUFTRAG IN ZWISCHENDATEI
	SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,178) = $$$NO
	SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,179) = $$$NO
	SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,180) = $$$NO
	SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,181) = $$$NO
	SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,303) = $$$NO      ;BEC;24591;03.04.02
	
	QUIT
	
	
SOND ;SONDERPRUEFUNG ; without check (?)
	;-------------------------------------------------------------------------------
	;
	;
	; Inputs:
	;
	; Returns:
	;
	; History:
	; 17-Nov-2009	shobby		SR17032: Don't pass in YFELD to SetSupplierConversionRate
	;------------------------------------------------------------------------------
	NEW YAUFTRAG
	
	SET YAUFTRAG=$PIECE($GET(YKEY),",",1)
	QUIT:YAUFTRAG=""

	if ((+$$$WWWClientParamCoreChangesSESPE($get(^WWWClientParam(YM,YM,1)))) ||
	   (+$$$WWWClientParamCoreChangesSESDF($get(^WWWClientParam(YM,YM,1))))) {
 		if $get(YFORM)="INAUF" do GoToForm^COMUtilForm("VARCompra",YKEY)
 	}	
 	
	; FIXME : These fields in INAUF1 are "Inter-Location#" or "Temporary Field" not boolean
	
	;FOR YA=178,179,180,181 {   ;bec;03.02.04;24591;feld 303 Spezialzuschlag hinzugefügt
	FOR YA=178,179,180,181,303 {
		IF $PIECE($GET(^INAUF1(YM,YAUFTRAG,1)),Y,YA)=1 {  ;NEU BERECHNEN IN ZWISCHESPEICHER
			SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,YA) = $$$YES
			SET $PIECE(YFELD,Y,YA)                 = $$$YES 
		}
	}
	
	;26495;Aufträge in Projektlaufzeiten;04.01.05;FAN
	;QUIT:'$PIECE($GET(^INVORG(YM,YM,1)),Y,103)       ;KEIN START ;don't Start Service Automatically 
	;DO AUTO^INPRODAUER($GET(YAUFTRAG),3,$GET(YBED))  ;STARTEN ;launching 
	do SetSupplierConversionRate^INAUFDISC(YKEY)		;SR17032
	QUIT
	
	
]]></Routine>
</Export>