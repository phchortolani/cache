<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INSALDO" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INSALDO(KONT)  ;INSALDO;DT;KONTEN SALDEN ERMITTELN;21.01.2000  ; Compiled March 1, 2005 13:40:05
#include COMSYS
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		KONTEN SALDEN ERMITTELN
	;		Determine account balance
	;	FUNKTIONS AUFRUF = S A=$$^INSALDO(KONT)
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 16-Jan-2006	Steve S	Doco
	; 21.01.2000	DT
	;-------------------------------------------------------------------------------
	; INFIBPAR: General Ledger Parameters
	; 
	; D15	Attached GL
	; D41 	Calculate Accounts Receivable Without GL
	;+++++++++++++++++++++++++++++++++++++++
	NEW SYSTEM,BET,MAN,UCI,FDAT,SOLLHABEN,YDATA,SALDO
	
	SET SALDO=""
	SET BET=$ORDER(^INFIBPAR(0,YM,""))
	QUIT:BET="" SALDO
	
	SET YFPARA=$GET(^INFIBPAR(0,YM,BET,1))
	
	;IF KONT=3 DO SIMBA QUIT SALDO  ;TEST !!
	;------------------------------------------------------------------------
	IF +$PIECE(YFPARA,Y,41)=1 DO MANU QUIT SALDO  ;WEM;25214;ERRECHNUNG DES SALDOS OHNE FIBU;05.03.2004
	IF $PIECE(YFPARA,Y,15)=4 DO DISC     ;DISC
	IF $PIECE(YFPARA,Y,15)=1 DO ABACUS   ;ABACUS
	IF $PIECE(YFPARA,Y,15)=5 DO SIMBA    ;SIMBA VERSION K 2.4.100 MIT CACHE 4.1.16  ;FIS;26128;13.08.04
	;
	;------------------------------------------------------------------------
	QUIT SALDO 
	
	
DISC ;DISC
	SET FDAT=""
	IF $DATA(^INLIEFs(YM,4,KONT))  SET FDAT="FKR02"  ;KREDITOR
	IF $DATA(^INKUNDEs(YM,4,KONT)) SET FDAT="FDE02"  ;DEBITOR
	
	SET SALDO=$PIECE($GET(^INFIBBALANCE(YM,KONT,1)),Y,1)
	SET SOLLHABEN="S"
	IF SPRACHE'="DE" SET SOLLHABEN="D"
	IF FDAT="FKR02" IF SALDO>0 SET SOLLHABEN="H" IF SPRACHE'="DE" SET SOLLHABEN="K"
	IF FDAT="FDE02" IF SALDO<0 SET SOLLHABEN="H" IF SPRACHE'="DE" SET SOLLHABEN="K"
	IF +SALDO=0 SET SOLLHABEN=""
	IF SALDO<0  SET SALDO=SALDO*-1  ;NUR POSITIVE ZAHL ;only numeral 
	SET SALDO=$JUSTIFY(SALDO,0,2)_" "_SOLLHABEN
	QUIT
	
	;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv THE FOLLOWING CODE IS NOT IN USE
	NEW YACCOUNT,YID,BAL
	SET MAN=0
	IF $PIECE(YFPARA,Y,2)'="" SET MAN=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAN=""
	IF $PIECE(YFPARA,Y,3)'="" SET BET=$PIECE(YFPARA,Y,3)  ;BETRIEB IN FIBU ;location within 
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	DO
	. ZNSPACE UCI    ;$PIECE(YFPARA,Y,1)
	. SET YID=##class(User.LedAccount).GetAccount(KONT)
	. IF +YID'=0 DO
	. . SET BAL=##class(%Library.ResultSet).%New()
	. . SET BAL.ClassName="LedAccountTotal"
	. . SET BAL.QueryName="GetLedBALAccTotal"
	. . DO BAL.Execute(YID)
	. . QUIT:'BAL.Next() 
	. . ;DO BAL.Next()
	. . SET YID(1)=BAL.GetData(1)
	. . IF YID(1)'="" SET SALDO=$LIST($GET(^ooLedAccountTotalD(YID(1))),2)
	. . DO BAL.Close()
	. . DO BAL.%Close()
	
	ZNSPACE YUCI
	;
	SET FDAT=""
	IF $DATA(^INLIEFs(YM,4,KONT))  SET FDAT="FKR02"  ;KREDITOR
	IF $DATA(^INKUNDEs(YM,4,KONT)) SET FDAT="FDE02"  ;DEBITOR
	IF FDAT="" QUIT 
	SET SOLLHABEN="S"
	I SPRACHE'="DE" S SOLLHABEN="D"
	IF FDAT="FKR02" IF SALDO>0 SET SOLLHABEN="H" I SPRACHE'="DE" S SOLLHABEN="K"
	IF FDAT="FDE02" IF SALDO<0 SET SOLLHABEN="H" I SPRACHE'="DE" S SOLLHABEN="K"
	IF +SALDO=0 SET SOLLHABEN=""
	IF SALDO<0 SET SALDO=SALDO*-1  ;NUR POSITIVE ZAHL ;only numeral 
	SET SALDO=$JUSTIFY(SALDO,0,2)_" "_SOLLHABEN
	QUIT
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ NOT IN USE
	
ABACUS ;ABACUS
	SET MAN=0
	IF $PIECE(YFPARA,Y,2)'="" SET MAN=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAN=""
	IF $PIECE(YFPARA,Y,3)'="" SET BET=$PIECE(YFPARA,Y,3)  ;BETRIEB IN FIBU ;location within 
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	
	SET FDAT=""
	IF $DATA(^INLIEFs(YM,4,KONT))  SET FDAT="FKR02"  ;KREDITOR
	IF $DATA(^INKUNDEs(YM,4,KONT)) SET FDAT="FDE02"  ;DEBITOR
	IF FDAT="" QUIT
	SET SYSTEM=""
	DO SALDO^%YABAF3(FDAT,MAN,BET,KONT,$$^WWWYEAR($HOROLOG),UCI,SYSTEM,.SALDO)
	SET SOLLHABEN="S"
	IF FDAT="FKR02" IF SALDO>0 SET SOLLHABEN="H"
	IF FDAT="FDE02" IF SALDO<0 SET SOLLHABEN="H"
	IF +SALDO=0 SET SOLLHABEN=""
	IF SALDO<0  SET SALDO=SALDO*-1  ;NUR POSITIVE ZAHL ;only numeral 
	SET SALDO=$JUSTIFY(SALDO,0,2)_" "_SOLLHABEN
	QUIT
	
	
SIMBA
	;-------------------------------------------------------------------------------
	;	SIMBA
	;
	; History :
	; 11-Feb-2008	GRF		SR15627: Use $$$save instead of direct set; objCustomer
	; 02.12.2004	FIS		26128
	;-------------------------------------------------------------------------------
	NEW PV,PVX,MAND,UCI,FILE,TTMMJJJJ,VERZ,YBSZ,LFN,REC,BETRAG,SOLLHABEN,FDAT,YEOFILE,LOCAL
	new objCustomer,objSupplier,strStatus
	
	SET MAND=YM
	IF $PIECE(YFPARA,Y,2)'="" SET MAND=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAND=""
	
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	
	DO
	. IF $GET(SIMSALDO)'="" SET SALDO=SIMSALDO QUIT  ;EINSPRUNG AUS INBUANZ !
	. DO  QUIT
	. . SET SALDO=0  ;DAUERT SONST ZU LANGE
	. . IF $DATA(^INLIEFs(YM,4,KONT)) DO
	. . . SET KONT(1)=$ORDER(^INLIEFs(YM,4,KONT,""))
	. . . IF KONT(1)'="" SET SALDO=$PIECE($GET(^INLIEF(YM,KONT(1),1)),Y,242)
	. . ;
	. . IF $DATA(^INKUNDEs(YM,4,KONT)) DO
	. . . SET KONT(1)=$ORDER(^INKUNDEs(YM,4,KONT,""))
	. . . IF KONT(1)'="" SET SALDO=$PIECE($GET(^INKUNDE(YM,KONT(1),1)),Y,242)
	. ;
	. NEW SIMSALDO
	. SET SIMSALDO="X"
	. DO SIMBA^INBUANZ
	. SET SALDO=SIMSALDO
	
	SET FDAT=""
	IF $DATA(^INLIEFs(YM,4,KONT)) DO
	. SET FDAT="FKR02"  ;KREDITOR
	. QUIT:+SALDO=0
	. SET KONT(1)=$ORDER(^INLIEFs(YM,4,KONT,""))  ;FIS;09.12.04;26705;SPEICHERN SALDO
	. IF KONT(1)'="" IF $DATA(^INLIEF(YM,KONT(1))) do
	. .;SET $PIECE(^INLIEF(YM,KONT(1),1),Y,242)=SALDO     ; SR15627
	. . set objSupplier = $get(^INLIEF(YM,KONT(1),1))
	. . set $$$INLIEFBalance(objSupplier) = SALDO         ; D242
	. . set strStatus=$$$Save("INLIEF",KONT(1),objSupplier,$$$YES)
	
	IF $DATA(^INKUNDEs(YM,4,KONT)) DO
	. SET FDAT="FDE02"  ;DEBITOR
	. QUIT:+SALDO=0
	. SET KONT(1)=$ORDER(^INKUNDEs(YM,4,KONT,""))  ;FIS;09.12.04;26705;SPEICHERN SALDO
	. IF KONT(1)'="" IF $DATA(^INKUNDE(YM,KONT(1))) do
	. .;SET $PIECE(^INKUNDE(YM,KONT(1),1),Y,242)=SALDO     ; SR15627
	. . set objCustomer = $get(^INKUNDE(YM,KONT(1),1))
	. . set $$$INKUNDEBalance(objCustomer) = SALDO         ; D242
	. . set strStatus=$$$Save("INKUNDE",KONT(1),objCustomer,$$$YES)
 
	
	SET SOLLHABEN="S"
	IF SPRACHE'="DE" SET SOLLHABEN="D"
	IF FDAT="FKR02" IF SALDO>0 SET SOLLHABEN="H" IF SPRACHE'="DE" SET SOLLHABEN="K"
	IF FDAT="FDE02" IF SALDO<0 SET SOLLHABEN="H" IF SPRACHE'="DE" SET SOLLHABEN="K"
	IF +SALDO=0 SET SOLLHABEN=""
	IF SALDO<0  SET SALDO=SALDO*-1  ;NUR POSITIVE ZAHL ;only numeral 
	SET SALDO=$JUSTIFY(SALDO,0,2)_" "_SOLLHABEN
	QUIT
	
	;SALDO=SALDO
	;SALDO(1)=SALDO JANUAR ;January 
	;SALDO(12)=SALDO DEZ
	
MANU   ; MANUELLE ERMITTLUNG DES SALDOS IF (YFPARA,Y,41)=1
	NEW DAT,TIME,CUS,TCUS,SATZ,SATZ1,SUM,AUF,DAT,KONT1,BUCHUNG,DATUM,DATX,FDAT,SOLLHABEN,RB,RE,BELEG
	
	SET FDAT=""
	IF $DATA(^INLIEFs(YM,4,KONT))  SET FDAT="FKR02"  ;KREDITOR
	IF $DATA(^INKUNDEs(YM,4,KONT)) SET FDAT="FDE02"  ;DEBITOR
	IF FDAT="" QUIT 
	
	SET KONT1=$$^WWWUMLAU($GET(KONT),1)  ; KUNDE ;customer 
	SET DAT=""
	FOR  SET DAT=$ORDER(^INREBUCHs(YM,5," ",KONT1,DAT)) QUIT:DAT=""  DO
	. SET TIME=""
	. FOR  SET TIME=$ORDER(^INREBUCHs(YM,5," ",KONT1,DAT,TIME)) QUIT:TIME=""  DO
	. . SET CUS=""
	. . FOR  SET CUS=$ORDER(^INREBUCHs(YM,5," ",KONT1,DAT,TIME,CUS)) QUIT:CUS=""  DO
	. . . SET SATZ=$GET(^INREBUCH(YM,DAT,TIME,CUS,1))
	. . . ;
	. . . SET AUF =$PIECE(SATZ,Y,7)
	. . . ;
	. . . SET SUM("S")=$GET(SUM("S"))+$PIECE(SATZ,Y,6)  ;GESAMTER AUFTRAGSRECHNUNGSBETRAG
	. . . IF AUF'="" DO
	. . . . SET DATX=""
	. . . . FOR  SET DATX=$ORDER(^INAUFPZ(YM,AUF,DATX)) QUIT:DATX=""  DO
	. . . . . SET SATZ1=$GET(^INAUFPZ(YM,AUF,DATX,1))
	. . . . . QUIT:$PIECE(SATZ1,Y,25)=""  ;KEINE ZAHLUNG SONDERN NUR ZAHLUNGSAUFFORDERUNG ;no payment only 
	. . . . . SET SUM("H")=$GET(SUM("H"))+$PIECE(SATZ,Y,2)  ;GESAMTEBEZAHLT 
	
	SET KONT1=$$^WWWUMLAU($ORDER(^INLIEFs(YM,4,KONT,"")),1)
	IF KONT1'="" FOR RB=0," " DO   ; LIEFERANT ;supplier 
	. SET BELEG=""
	. FOR  SET BELEG=$ORDER(^INERECHs(YM,8,RB,KONT1,BELEG)) QUIT:BELEG=""  DO
	. . SET RE=""
	. . FOR  SET RE=$ORDER(^INERECHs(YM,8,RB,KONT1,BELEG,RE)) QUIT:RE=""  DO
	. . . SET SATZ=$GET(^INERECH(YM,KONT1,BELEG,RE,1))
	. . . SET SUM("H")=$GET(SUM("H"))+$PIECE(SATZ,Y,10)   ; ZU ZAHLENDER BETRAG ;within Sum 
	
	SET SALDO=$GET(SUM("S"))-$GET(SUM("H"))
	SET SOLLHABEN="S"
	IF SALDO<0  SET SOLLHABEN="H"
	IF +SALDO=0 SET SOLLHABEN=""
	IF SALDO<0  SET SALDO=SALDO*-1  ;NUR POSITIVE ZAHL ;only numeral 
	SET SALDO=$JUSTIFY(SALDO,0,2)_" "_SOLLHABEN
	
	QUIT
]]></Routine>
</Export>