<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDMSLETTER" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDMSLETTER(YNR) ;INDMSLETTER;FAN;ERSTELLEN BRIEFE ;02.06.2004;23265
	;
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		ERSTELLEN BRIEFE 
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;|
	;| FAN	02.06.2004
	;|
	;\------------------------------------------------------------------/
	;
	;^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)=YKEY  ;KEY
	;^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",2)=ADR   ;ADRESSE KEY
	;^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",3)=ANSP  ;ANSPRECHPARTNER
 
	NEW KEY
	SET KEY=$GET(%(YQUERY,"YKEY"))
	QUIT:YNR=""
	IF YNR=1  SET %("VAR","YFORM")="INAUFBRIEF"
	IF YNR=2  SET %("VAR","YFORM")="INANGBRIEF"
	IF YNR=3  SET %("VAR","YFORM")="INKUNDEBRIEF"
	IF YNR=4  SET %("VAR","YFORM")="INLIEFBRIEF"
	IF YNR=5  SET %("VAR","YFORM")="INWERBBRIEF"
	IF YNR=6  SET %("VAR","YFORM")="INCALLBRIEF"
	IF YNR=7  SET %("VAR","YFORM")="INKUNDEANFRBRIEF"
	IF YNR=8  SET %("VAR","YFORM")="INDABRIEF"
	IF YNR=9  SET %("VAR","YFORM")="INDAKONBRIEF"
	SET %("VAR","YPARA")=KEY
	DO ^WWWFORM
	QUIT
	
KEY(YNR) 
	NEW YKEY,YDATEI,ADR1
	
	SET YKEY=$GET(%(YQUERY,"YPARA"))
	QUIT:YKEY=""
	
	SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)=$PIECE(YKEY,",",1)
	DO BELEG(YNR)    ; ADRESSE HOLEN ;address send for 
	SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",2)=ADR
	WRITE "<TABLE><TR>"
	WRITE "<TD WIDTH=78></TD>"
	WRITE "<TD>"
	WRITE "<FONT SIZE=2>"
	WRITE YKEY
	WRITE "&nbsp;&nbsp;"
	WRITE $PIECE(ADR1,Y,8)_", "_$PIECE(ADR1,Y,16)
	WRITE "</TR><TD></TABLE>"
	WRITE "<HR>"
	SET $PIECE(^INUSER(YM,YBED,1),Y,25)=""
	QUIT
	
ANSP   ;Execute bei onBlur VON VORG(8) ANSPRECHPARTNER  ;Execute next to OnBlur 
	NEW ANSP1,ADR
	
	QUIT:$GET(YINHALT)=""
	SET ADR=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",2))
	SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",3)=YINHALT
	QUIT:ADR=""
	
	IF $DATA(^INPARTN(YM,ADR,YINHALT,1)) SET ANSP1=^(1) DO
	. SET %TXT(1)="#Y"_YFORM_"M8~"
	. IF $PIECE(ANSP1,Y,1)'="" SET %TXT(1)=%TXT(1)_$PIECE($GET(^INPARA(YM,"ANREDE",SPRACHE,$PIECE(ANSP1,Y,1),1)),Y,1)_" "
	. IF $PIECE(ANSP1,Y,3)'="" SET %TXT(1)=%TXT(1)_$PIECE(ANSP1,Y,3)_" "
	. IF $PIECE(ANSP1,Y,2)'="" SET %TXT(1)=%TXT(1)_$PIECE(ANSP1,Y,2)
	. SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"M10~"_$PIECE(ANSP1,Y,8)
	. SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"M11~"_$PIECE(ANSP1,Y,7)
	
	QUIT
	
ANSPVOR   ;ANSPRECHPARTNER VORHER TRAGEN VON VORDATEI; FÜR SERVICEAUFTRAG AUTOMATISCH EINTRAGEN
	QUIT:YKEY=""
	SET YINHALT=$PIECE($GET(^INCALL(YM,YKEY,1)),Y,12)
	SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",3)=$PIECE($GET(^INCALL(YM,YKEY,1)),Y,14)
	QUIT
	
START(YNR) ;GENERIEREN TEXT
	NEW ADR,ADR1,YDATEI,MAIL,FAXNR,ANSP,CALL1,CALLNR,ANSP,ANSP1,YLAYOUT,YLAYOUT1
	
	;VORG(1)=FORMBIEF;   VORG(2)=VERSANDART;   VORG(3)=BRIEFTEXT
	;VORG(4)=NUR VORSCHAU;    VORG(5)=ANLAGE;   VORG(6)=UNTERSCHRIFT MITARBEITER;  VORG(7)=UNTERSCHRIFT JA/NEIN
	;VORG(8)=ANSPRACHEN PARTNER   ;VORG(9)=ARTIKEL ;pard 
	SET YKEY=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)) ;DATENSATZ ;data record 
	IF YKEY="" SET %TXT(1)="!"_$$^WWWTEXT(32292,,1) QUIT  ;KEIN KEY ;no KEY 
	IF YNR=1 IF $PIECE($GET(^INAUF(YM,YKEY,1)),Y,2)=1 SET %TXT(1)="!"_$$^WWWTEXT(32292,,1) QUIT  ;EIGENAUFTRAG PITTE PRÜFEN ;sift 
	SET YFELD=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"M",1))  ;DATENFELDER
	SET VORG(1)=$PIECE(YFELD,Y,1)  ;FORMBIEF
	SET VORG(2)=$PIECE(YFELD,Y,2)  ;VERSANDART
	SET VORG(9)=$PIECE(YFELD,Y,9)  ;ARTIKEL ;item 
	QUIT:VORG(1)=""
	QUIT:VORG(2)="" 
	
	SET YLAYOUT=$PIECE($GET(^INBRIEF(YM,VORG(1),1)),Y,25)           ;---------PARAMETER  ;FAN;17.02.04;24294
	IF YLAYOUT=""        SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	IF YLAYOUT'=""       SET YLAYOUT1=$GET(^INDMSLAYOUT(YM,YLAYOUT,1))  
	IF $GET(YLAYOUT1)="" SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	
	IF $PIECE(YLAYOUT1,Y,6)="" SET $PIECE(YLAYOUT1,Y,6)=1
	IF $PIECE(YLAYOUT1,Y,7)="" SET $PIECE(YLAYOUT1,Y,7)=1
	IF $PIECE(YLAYOUT1,Y,8)="" SET $PIECE(YLAYOUT1,Y,8)=1
	IF $PIECE(YLAYOUT1,Y,9)="" SET $PIECE(YLAYOUT1,Y,9)=1
	IF +$PIECE(YLAYOUT1,Y,6)<0!(+$PIECE(YLAYOUT1,Y,6)>20) SET $PIECE(YLAYOUT1,Y,6)=1   ;Anzahl Zeilen von Adresse bis Betreff   ;Number from address To Subject 
	IF +$PIECE(YLAYOUT1,Y,7)<0!(+$PIECE(YLAYOUT1,Y,7)>20) SET $PIECE(YLAYOUT1,Y,7)=1   ;Anzahl Zeilen von BETREFF bis ANREDE  ;Number from To salutation 
	IF +$PIECE(YLAYOUT1,Y,8)<0!(+$PIECE(YLAYOUT1,Y,8)>20) SET $PIECE(YLAYOUT1,Y,8)=1   ;Anzahl Zeilen von ANREDE bis BERIEF ;Number from salutation To 
	IF +$PIECE(YLAYOUT1,Y,9)<0!(+$PIECE(YLAYOUT1,Y,9)>20) SET $PIECE(YLAYOUT1,Y,9)=1   ;Anzahl Zeilen von berief bis unterschrift ;Number from To 
	
	SET %TXT(1)=""
	SET TEXT=" |"
	SET VORG(8)=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",3))
	;SET VORG(8)=$P($PIECE(YFELD,Y,8)," - ",1)  ;Z.B.   ANSPRECHPARTNER  "2 - FRAU LASA MEYER" ANGETRAGEN
	IF YNR=1 DO
	. SET VORG(9)=""
	. IF YKEY'="" DO
	. . NEW YPOS
	. . SET YPOS=""
	. . FOR  SET YPOS=$ORDER(^INAUFP(YM,YKEY,YPOS)) QUIT:YPOS=""  DO
	. . . SET VORG(9)=VORG(9)_$PIECE($GET(^INAUFP(YM,YKEY,YPOS,1)),Y,4)_":"_$PIECE($GET(^INAUFP(YM,YKEY,YPOS,1)),Y,5)_","
	. ;
	. SET VORG(9)=VORG(9)_$PIECE(YFELD,Y,9)
	
	SET BRIEF=""
	;IF VORG(1)'="" IF $DATA(^INDABRIEF(YM,VORG(1),1)) SET BRIEF=$GET(^INDABRIEF(YM,VORG(1),1))
	IF VORG(1)'="" IF $DATA(^INBRIEF(YM,VORG(1),1)) SET BRIEF=$GET(^INBRIEF(YM,VORG(1),1))
	DO BELEG(YNR)
	SET ANSP1=""
	IF VORG(8)'="" IF $DATA(^INPARTN(YM,ADR,VORG(8),1))  SET ANSP1=$GET(^(1))
	IF VORG(8)'="" IF '$DATA(^INPARTN(YM,ADR,VORG(8),1))  SET VORG(8)=""
	DO VERSANDART
	DO ANSCHR(ADR1,$GET(VORG(8)))
	DO BETREFF($PIECE(BRIEF,Y,2))
	;IF VORG(8)="" DO ANREDE($PIECE(ADR1,Y,19))
	IF VORG(8)="" IF YNR=6  DO ANREDE($PIECE($GET(ADR1),Y,31))     ;BRIEF ANREDE;BEC;24.06.04;25954
	IF VORG(8)="" IF YNR'=6 DO ANREDE($PIECE(ADR1,Y,19))           ;BRIEF ANREDE  ;BEC;24.06.04;25954
	IF VORG(8)'=""          DO ANREDE($PIECE($GET(ANSP1),Y,31))    ;BRIEF ANREDE ;letter salutation 
	IF YNR'=6 DO BRIEF($GET(VORG(1)),$GET(VORG(9)))                ;BRIEFTEXT UND ARTIKEL ;And item 
	IF YNR=6  DO BRIEFCALL
	;DO UNTER($PIECE(BRIEF,Y,21),$PIECE(BRIEF,Y,20))    ;UNTERSCHRIFT
	SET TEXT=$TRANSLATE(TEXT,"|",$CHAR(13))
	SET %TXT(1)=%TXT(1)_"#Y"_YFORM_YART_3_"~"_TEXT     ;BRIEFTEXT
	SET $PIECE(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,YART,1),Y,3)=TEXT
	IF $PIECE(BRIEF,Y,20)=1   SET %TXT(1)=%TXT(1)_"#Y"_YFORM_YART_7_"~"_"CHECKED"    ;DRUCKEN UNTERSCHRIFT JA/NEIN ;print signature 
	IF $PIECE(BRIEF,Y,20)'=1  SET %TXT(1)=%TXT(1)_"#Y"_YFORM_YART_7_"~"_"UNCHECKED"    ;DRUCKEN UNTERSCHRIFT JA/NEIN ;print signature 
	IF $PIECE(BRIEF,Y,21)'="" SET %TXT(1)=%TXT(1)_"#Y"_YFORM_YART_6_"~"_$PIECE(BRIEF,Y,21)_"#DUMMY"_YART_6_"~"_$PIECE($GET(^WWW013(0,$PIECE(BRIEF,Y,21),1)),Y,1)    ;UNTERSCHRIFT MITARBEITER ;signature 
	IF $PIECE(BRIEF,Y,21)'="" SET $PIECE(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,YART,1),Y,6)=$PIECE(BRIEF,Y,21)
	IF $PIECE(BRIEF,Y,21)=""  SET %TXT(1)=%TXT(1)_"#Y"_YFORM_YART_6_"~"_YBED_"#DUMMY"_YART_6_"~"_$PIECE($GET(^WWW013(0,YBED,1)),Y,1)    ;UNTERSCHRIFT MITARBEITER SELBST ;signature self 
	IF $PIECE(BRIEF,Y,21)=""  SET $PIECE(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,YART,1),Y,6)=YBED
	SET $PIECE(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,YART,1),Y,7)=$PIECE(BRIEF,Y,20)
	QUIT
	
BELEG(YNR) ; BELEGE
	;YNR=YKEY AUS DATEI :  1=AUFTRAG  2=ANGEBOT  3=KUNDE  4=LIEFERANT  5=WERBEADRESSE 6=ANFRAGE ;out of data file 
	NEW YTEMP
	
	SET YTEMP=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"M",1))
	SET ADR1=""
	SET ADR=""
	IF YNR=1 DO
	. SET YDATEI="INKUNDE"
	. NEW AUF1
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE($GET(^INAUF(YM,$PIECE(YKEY,",",1),1)),Y,1)  ;KUNDE ;lore  ;customer 
	. IF ADR="" IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE($GET(^INAUF(YM,$PIECE(YKEY,",",1),1)),Y,12) SET YDATEI="INLIEF"  ;LIEFERANT ;purveyor  ;supplier 
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF ADR'="" SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YKEY,",",1)'="" DO
	. . SET AUF1=$GET(^INAUF(YM,$PIECE(YKEY,",",1),1))
	. . IF $PIECE(AUF1,Y,308)'="" SET $PIECE(ADR1,Y,24)=$PIECE(AUF1,Y,308)   ;BEC;25788;25.05.04;AUS AUFTRAG
	. . IF $PIECE(AUF1,Y,307)'="" SET $PIECE(ADR1,Y,22)=$PIECE(AUF1,Y,307)    ;BEC;25788;25.05.04;AUS AUFTRAG
	. ;
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	. QUIT
	IF YNR=2 DO
	. SET YDATEI="INKUNDE"
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE($GET(^INANG(YM,$PIECE(YKEY,",",1),1)),Y,1)  ;KUNDE ;lore  ;customer 
	. IF ADR="" IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE($GET(^INANG(YM,$PIECE(YKEY,",",1),1)),Y,12) SET YDATEI="INLIEF"  ;LIEFERANT ;purveyor  ;supplier 
	. IF YDATEI="INKUNDE" IF '$DATA(^INKUNDE(YM,ADR)) IF $DATA(^INWERBADR(YM,ADR)) SET YDATEI="INWERBADR"
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF $GET(ADR)'="" SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	IF YNR=3 DO
	. SET YDATEI="INKUNDE"
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE(YKEY,",",1)  ;KUNDE ;lore  ;customer 
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF $GET(ADR)'="" SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	IF YNR=4 DO
	. SET YDATEI="INLIEF"
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE(YKEY,",",1)  ;LIEFERANT ;purveyor  ;supplier 
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF $GET(ADR)'="" SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	IF YNR=5 DO
	. SET YDATEI="INWERBADR"
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE(YKEY,",",1)  ;WERBEADRESSE
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF $GET(ADR)'=""          SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	IF YNR=6 DO    ;SERVICE AUFTRAG ;order 
	. SET YDATEI="INKUNDE"
	. SET CALL1=$GET(^INCALL(YM,YKEY,1))
	. SET ADR=$PIECE(CALL1,Y,5)  ;KUNDE ;lore  ;customer 
	. ;SET VORG(8)=$PIECE(CALL1,Y,14)   ;ANSPRECHENPARTNER KEY
	. SET CALLNR=$PIECE(YKEY,",",1)    ;FÜR BEREFF;FAN;22917;05.06.03;CALLNUMMER HINZUGEFÜGT
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF ADR'="" SET ADR1=$GET(@ADR(1))
	. DO      ;MAIL UND FAX ;BEC;25788;25.05.04
	. . IF $PIECE(CALL1,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(CALL1,Y,10)     ;AUS SERVICELISTE ;out of 
	. . IF $PIECE(CALL1,Y,9)'=""  SET $PIECE(ADR1,Y,22)=$PIECE(CALL1,Y,9)       ;AUS SERVICELISTE; ;out of 
	. . IF $PIECE(CALL1,Y,12)'="" SET $PIECE(ADR1,Y,31)=$PIECE(CALL1,Y,12)     ;AUS SERVICELISTE; ANSPRECHPARTNER;BEC;25954;24.06.04
	. . ;
	. . IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS ANSPRECHPARTNERDATEN ;out of 
	. . IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	IF YNR=7 DO
	. SET YDATEI="INKUNDE"
	. IF $PIECE(YKEY,",",1)'="" SET ADR=$PIECE($GET(^INKUNDEANFR(YM,$PIECE(YKEY,",",1),1)),Y,5)  ;KUNDE ;lore  ;customer 
	. SET ADR(1)="^"_YDATEI_"(YM,ADR,1)"  ;DATEIVORGABE
	. IF $GET(ADR)'="" SET ADR1=$GET(@ADR(1))
	. IF $PIECE(YTEMP,Y,10)'="" SET $PIECE(ADR1,Y,24)=$PIECE(YTEMP,Y,10)      ;EMAIL AUS SNSPRECHPARTNERDATEN ;out of 
	. IF $PIECE(YTEMP,Y,11)'="" SET $PIECE(ADR1,Y,22)=$PIECE(YTEMP,Y,11)      ;fax
	
	QUIT
	
VERSANDART
	IF VORG(2)=1 DO
	. ;S MAIL=""
	. ;IF ADR'="" SET MAIL=$PIECE(ADR1,Y,24)   
	. SET MAIL=$PIECE($G(ADR1),Y,24)         ;BEC;30.06.04;25954;
	. SET TEXT=" @@E-MAIL "_MAIL_" @@|"_TEXT
	
	IF VORG(2)=2 DO
	. ;SET FAXNR=""
	. ;IF ADR'="" SET FAXNR=$PIECE(ADR1,Y,22)
	. SET FAXNR=$PIECE($G(ADR1),Y,22)     ;BEC;30.06.04;25954;
	. SET TEXT=" @@NUMMER "_FAXNR_"@@|"_TEXT
	
	QUIT
	
	; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK STARTS
	
	;ERWEITERUNG FÜR ZUSÄTZLICHE VERSANDARTEN, ULM 19.08.2002
	IF VORG(2)=3 DO  ;VERSAND VIA XML ;shipping via XML 
	. SET FAXNR=""
	. IF ADR'="" SET FAXNR=$PIECE(ADR1,Y,22)
	. SET TEXT=" @@NUMMER "_FAXNR_"@@|"_TEXT
	
	IF VORG(2)=4 DO  ;VERSAND VIA EDI ;shipping via EDI 
	. SET FAXNR=""
	. IF ADR'="" SET FAXNR=$PIECE(ADR1,Y,22)
	. SET TEXT=" @@NUMMER "_FAXNR_"@@|"_TEXT
	
	IF VORG(2)=5 DO  ;VERSAND VIA FTP ;shipping via 
	. NEW YADR
	. SET YADR=YKUNDE
	. IF YKUNDE="" SET YADR=YLIEFER
	. SET BETR=$PIECE(YBELEG1,Y,23)_" "_YAUFTRAG  ;BETREFF SETZEN ;typeset 
	. SET OK=$$^INFTP(YREF,YADR,BETR)
	. IF OK=1 SET TEXT="FTP-BEREIT"_TEXT QUIT
	. SET TEXT="FTP-FEHLER "_OK_TEXT
	
	QUIT
	
ANSCHR(ADRESSE,ANSP)  ;ANSCHRIFT
	;ADRESSE= STRING DER GESAMTEN ADRESSE ;the address 
	;ANSP=DIE ANSPRECHPARTNERNUMMER (KONTAKTNUMMER)
	IF ANSP'="" SET ANSP1=$GET(^INPARTN(YM,ADR,ANSP,1))
	IF VORG(2)=1 IF $PIECE(BRIEF,Y,23)'=1 QUIT      ;Formbrief als E-mail senden mit Adresse   ;Serial Letter when E-Mail transmit by means of address 
	NEW ANSCH
	
	SET ANSCH=""
	DO
	. NEW PLZ,ORT,PF
	. SET PF=0  ;KEINE POSTFÄCHER ;no 
	. SET NUM=0
	. IF SPRACHE="DE" IF $PIECE(ADRESSE,Y,11)'="" IF '$FIND($PIECE(ADRESSE,Y,11),"Post") SET $PIECE(ADRESSE,Y,11)="Postfach "_$PIECE(ADRESSE,Y,11)
	. IF $PIECE(ADRESSE,Y,4)'="" SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,4)
	. IF $PIECE(ADRESSE,Y,6)'="" SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,6)
	. IF $PIECE(ADRESSE,Y,7)'="" SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,7)
	. IF $GET(ANSP)'="" DO
	. . IF $PIECE(ADRESSE,Y,101)'="" SET LANDSPRACHE=$PIECE(ADRESSE,Y,101)   ;BELEGE SPRACHE ;Language 
	. . IF $PIECE(ADRESSE,Y,101)=""  SET LANDSPRACHE=SPRACHE
	. . SET NUM=NUM+1
	. . SET $PIECE(ANSCH,Y,NUM)=""
	. . IF $PIECE(ANSP1,Y,1)'=""   SET $PIECE(ANSCH,Y,NUM)=$PIECE($GET(^INPARA(YM,"ANREDE",LANDSPRACHE,$PIECE(ANSP1,Y,1),1)),Y,1)_" "
	. . IF $PIECE(ANSP1,Y,3)'=""   SET $PIECE(ANSCH,Y,NUM)=$PIECE(ANSCH,Y,NUM)_$PIECE(ANSP1,Y,3)_" "
	. . IF $PIECE(ANSP1,Y,2)'=""   SET $PIECE(ANSCH,Y,NUM)=$PIECE(ANSCH,Y,NUM)_$PIECE(ANSP1,Y,2)_" "
	. . IF $PIECE(ANSCH,Y,NUM)'="" SET $PIECE(ANSCH,Y,NUM)=$$^WWWTEXT(32226,,,LANDSPRACHE)_" "_$PIECE(ANSCH,Y,NUM)
	. ;
	. SET PLZ=$PIECE(ADRESSE,Y,12)
	. IF PF=1 DO   ;OHNE POSTFACH ;without 
	. . IF $PIECE(ADRESSE,Y,10)'="" SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,10)
	. . IF $PIECE(ADRESSE,Y,12)'="" SET PLZ=$PIECE(ADRESSE,Y,12)
	. ;
	. IF PF=0 DO   ;MIT POSTFACH ;by means of 
	. . IF $PIECE(ADRESSE,Y,11)'="" SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,11)
	. . IF $PIECE(ADRESSE,Y,11)=""  SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,10)
	. . IF $PIECE(ADRESSE,Y,13)'="" SET PLZ=$PIECE(ADRESSE,Y,13)
	. ;
	. IF $PIECE($GET(^INVORG(YM,YM,1)),Y,50)'=1 IF PLZ'="" SET NUM=NUM+2 SET $PIECE(ANSCH,Y,NUM)=PLZ_" "_$PIECE(ADRESSE,Y,16)
	. IF $PIECE($GET(^INVORG(YM,YM,1)),Y,50)'=1 IF PLZ=""  SET NUM=NUM+2 SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,16)            ;FAN 16.01.2002 ;buff 
	. IF $PIECE($GET(^INVORG(YM,YM,1)),Y,50)=1 DO
	. . SET NUM=NUM+2
	. . IF $PIECE($GET(^INVORG(YM,YM,1)),Y,95)=1 IF $PIECE(ADRESSE,Y,14)'="" SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,16)_", "_$PIECE(ADRESSE,Y,14)_" "_PLZ QUIT
	. . SET $PIECE(ANSCH,Y,NUM)=$PIECE(ADRESSE,Y,16)_" "_PLZ
	. ;
	. IF $PIECE(ADRESSE,Y,17)'="" IF $PIECE(ADRESSE,Y,17)'=$GET(YCOUNTRY) SET NUM=NUM+1 SET $PIECE(ANSCH,Y,NUM)=$PIECE($GET(^WWW100(0,"LAND",SPRACHE,$PIECE(ADRESSE,Y,17),1)),Y,1)
	
	DO  ;DRUCKEN ANSCHRIFT ;print 
	. NEW YI,YII
	. FOR YI=1:1:NUM DO
	. . SET TEXT=$GET(TEXT)_$EXTRACT($PIECE(ANSCH,Y,YI),1,40)_"|"
	
	QUIT
	
BETREFF(BETREFF) ;BETREFF DES BRIEFES
	DO
	. NEW YII
	. FOR YII=1:1:(+$PIECE(YLAYOUT1,Y,6)) DO           ;Anzahl Zeilen von Adresse bis Betreff;FAN;17.02.04;24294
	. . SET TEXT=TEXT_ "|"
	
	SET BETREFF=$GET(BETREFF)
	SET TEXT=TEXT_"<font size="_""""_3_""""_" face="_""""_"courier"_""""_">"_"|                                                          "_"</font>"
	SET YDATE=+$HOROLOG
	SET TEXT=TEXT_$$^WWWDATE(YDATE)   ;DATUM ;Date  ;Date Date 
	DO
	. IF $FIND(BETREFF,"<BELEGNUMMER>") IF $FIND(BETREFF,"</BELEGNUMMER>") DO   ;BELEGNUMMER
	. . SET BETREFF=$PIECE(X,"<BELEGNUMMER>",1)_$$^WWWNEXT("BELEGNUMMER")_$PIECE(BETREFF,"</BELEGNUMMER>",2)
	
	DO         ;BEC;22917;20.05.03;CALLNUMMER HINZUGEFÜGT
	. IF $FIND(BETREFF,"<NR>") IF $FIND(BETREFF,"</NR>") DO   ;NUMMER ;numeral 
	. . SET BETREFF=$PIECE(BETREFF,"<NR>",1)_$GET(CALLNR)_$PIECE(BETREFF,"</NR>",2)
	
	SET TEXT=TEXT_"|<b>"_BETREFF_"</b>"
	QUIT
	
ANREDE(ANREDE)   ;BRIEFTEXT
	DO
	. NEW YII
	. ;FOR YII=1:1:(+$PIECE(YLAYOUT1,Y,7)+1) DO            ;Anzahl Zeilen von BETREFF bis ANREDE;FAN;17.02.04;24294
	. I $PIECE(YLAYOUT1,Y,7)="" S $PIECE(YLAYOUT1,Y,7)=1    ;BEC;25732;27.05.04; DMIT IMMER EINE ZEILE LOMMT
	. FOR YII=0:1:(+$PIECE(YLAYOUT1,Y,7)) DO               ;BEC;25732;27.05.04; DMIT KEINE WEITERE LEERZEILE
	. . SET TEXT=TEXT_ "|"
	
	;SET TEXT=TEXT_$GET(ANREDE)_","
	SET TEXT=TEXT_$GET(ANREDE)
	IF $EXTRACT($RE(TEXT))'="," SET TEXT=TEXT_","      ;BEC;25732;26.05.04
	DO
	. NEW YII
	. ;FOR YII=1:1:(+$PIECE(YLAYOUT1,Y,8)+1) DO             ;Anzahl Zeilen von ANREDE bis BEBIEF;FAN;17.02.04;24294
	. I $PIECE(YLAYOUT1,Y,8)="" S $PIECE(YLAYOUT1,Y,8)=1    ;BEC;25732;27.05.04; DMIT IMMER EINE ZEILE LOMMT
	. FOR YII=0:1:(+$PIECE(YLAYOUT1,Y,8)) DO                ;BEC;25732;26.05.04
	. . SET TEXT=TEXT_ "|"
	
	QUIT
	
BRIEF(BRIEFTEXT,ARTIKEL)   ;BRIEFTEXT UND ARTIKEL ;And item 
	;SET TEXT=TEXT_"|"_BRIEFTEXT
	;SET TEXT=TEXT_"|"
	DO HTML(VORG(1),$GET(ARTIKEL))
	QUIT
	
HTML(X,ARTIKEL) ;KAS;DRUCKEN EINER HTML-SEITE;11APR2001; ;print unit 
	;AB HIER NEUE VERSION (VORSCHLAG) VON H.KASTEN ;Confirm. here is 
	QUIT:X=""
	QUIT:$GET(^INBRIEF(YM,X,1))=""
	
	NEW A,IA,IB,IE,IT,L,P
	
	IF $EXTRACT($PIECE(^(1),Y,2),1,2)="@@" XECUTE $TRANSLATE($PIECE(^(1),Y,5),"|") SET TEXT="|" SET YQ=1 QUIT
	SET X=$PIECE(^(1),Y,5)
	DO
	. IF $FIND(X,"<ARTIKEL>") IF $FIND(X,"</ARTIKEL>") DO   ;EINBAUEN ARTIKELNUMMER
	. . NEW ART1,ART,YI,ARTX,ARTM
	. . SET ARTX=""
	. . SET ARTIKEL=$TRANSLATE(ARTIKEL,";",",")
	. . FOR YI=1:1 QUIT:$PIECE(ARTIKEL,",",YI)=""  SET ART=$PIECE(ARTIKEL,",",YI) DO
	. . . SET ARTM=+$PIECE(ART,":",2)
	. . . IF ARTM=0 SET ARTM=1
	. . . SET ART=$PIECE(ART,":",1)
	. . . IF $GET(ART)="" QUIT
	. . . IF '$DATA(^INART(YM,ART,1)) QUIT
	. . . SET ART1=$GET(^INART(YM,ART,1))
	. . . IF $PIECE(ART1,Y,40)'="" SET $PIECE(ART1,Y,40)=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(ART1,Y,40),1)),Y,1)
	. . . SET ARTX=ARTX_$$^WWWZAHL(ARTM,4,$LENGTH($PIECE(ARTM,".",2)))_" "_$EXTRACT($PIECE(ART1,Y,40)_"                          ",1,10)_" ("_ART_") "_$PIECE(ART1,Y,1)_"|"
	. . . ;I $P(ART1,Y,ZEICHNUNGSNUMMER) S ARTX=ARTX_"                                                 "_$P(ART,Y,ZEICHNUNGNUMMER)_"|"
	. . ;
	. . SET X=$PIECE(X,"<ARTIKEL>",1)_ARTX_$PIECE(X,"</ARTIKEL>",2)
	
	DO
	. IF $FIND(X,"<BESTELLUNG>") IF $FIND(X,"</BESTELLUNG>") DO  ;EINBAUEN ARTIKELNUMMER
	. . NEW ART1,ART,YI,ARTX,ARTM
	. . SET ARTX=""
	. . SET ARTIKEL=$TRANSLATE(ARTIKEL,";",",")
	. . FOR YI=1:1 QUIT:$PIECE(ARTIKEL,",",YI)=""  SET ART=$PIECE(ARTIKEL,",",YI) DO
	. . . SET ARTM=+$PIECE(ART,":",2)
	. . . IF ARTM=0 SET ARTM=1
	. . . SET ART=$PIECE(ART,":",1)
	. . . IF $GET(ART)="" QUIT
	. . . IF '$DATA(^INART(YM,ART,1)) QUIT
	. . . SET ART1=$GET(^INART(YM,ART,1))
	. . . IF $PIECE(ART1,Y,40)'="" SET $PIECE(ART1,Y,40)=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(ART1,Y,40),1)),Y,1)
	. . . SET ARTX=ARTX_$$^WWWZAHL(ARTM,4,$LENGTH($PIECE(ARTM,".",2)))_" "_$EXTRACT($PIECE(ART1,Y,40)_"                          ",1,10)_" ("_ART_") "_$PIECE(ART1,Y,1)_"|"
	. . . ;I $P(ART1,Y,ZEICHNUNGSNUMMER) S ARTX=ARTX_"                                                 "_$P(ART,Y,ZEICHNUNGNUMMER)_"|"
	. . ;
	. . SET X=$PIECE(X,"<BESTELLUNG>",1)_ARTX_$PIECE(X,"</BESTELLUNG>",2)
	
	DO
	. IF $FIND(X,"<BELEGNUMMER>") IF $FIND(X,"</BELEGNUMMER>") DO   ;BELEGNUMMER
	. . SET X=$PIECE(X,"<BELEGNUMMER>",1)_$$^WWWNEXT("BELEGNUMMER")_$PIECE(X,"</BELEGNUMMER>",2)
	
	SET IA=0 
	FOR  SET IA=$FIND(X,"|",IA) QUIT:'IA  SET $EXTRACT(X,IA-1)="|"
	SET P=1
	FOR  DO  QUIT:'IA
	. SET IA=$FIND(X,"$",P) IF IA DO  QUIT
	. . SET A="" 
	. . FOR L=IA:1:IA+63 QUIT:$LENGTH(X)<L  IF $DATA(^INBRIEF(YM,$EXTRACT(X,IA,L),1)) SET A=$EXTRACT(X,IA,L),IA=IA-1 QUIT
	. . SET TEXT=TEXT_$EXTRACT(X,P,IA-1) 
	. . SET P=IA
	. . IF A'="" DO HTML(A) SET P=P+$LENGTH(A)+1
	. ;
	. SET IA=$FIND(X,"<",P),IB=$FIND(X,">",IA)
	. IF ('IA)!('IB) SET TEXT=TEXT_$EXTRACT(X,P,$LENGTH(X)) QUIT
	. SET IT=$EXTRACT(X,IA,IB-2)
	. IF IT="" SET TEXT=TEXT_$EXTRACT(X,P,IB) SET P=IB+1 QUIT  ; <> DURCHREICHEN
	. IF $LENGTH(IT)>64 SET TEXT=TEXT_$EXTRACT(X,P,IB) SET P=IB+1 QUIT  ; <NAME...> AUSDRUCK ZU LANG: DURCHREICHEN
	. IF $GET(^INBRIEF(YM,IT,1))="" SET TEXT=TEXT_$EXTRACT(X,P,IB) SET P=IB+1 QUIT  ; <NAME> NICHT ANGELEGT: DURCHREICHEN ;Not 
	. SET IE=$FIND(X,"</"_IT_">",IB)
	. IF 'IE SET TEXT=TEXT_$EXTRACT(X,P,IB) SET P=IB+1 QUIT  ; </NAME> NICHT GEFUNDEN: <NAME> DURCHREICHEN ;Not 
	. SET TEXT=TEXT_$EXTRACT(X,P,IA-2) DO HTML(IT) SET P=IE
	
	QUIT
	
	
	
	;ALTE VERSION vvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	QUIT:X=""
	QUIT:$GET(^INBRIEF(YM,X,1))=""
	NEW A,I,L,P
	IF $EXTRACT(X,1,2)="@@" SET A="" XECUTE $TRANSLATE($PIECE(^INBRIEF(YM,X,1),Y,5),"|") SET TEXT=TEXT_A SET YQ=1 QUIT
	SET X=$PIECE(^INBRIEF(YM,X,1),Y,5)
	SET I=0 
	FOR  SET I=$FIND(X,"|",I) QUIT:'I  SET $EXTRACT(X,I-1)="|"
	SET P=1 
	FOR  DO  QUIT:'I
	. SET I=$FIND(X,"$",P) 
	. IF 'I SET TEXT=TEXT_$EXTRACT(X,P,$LENGTH(X)) QUIT
	. SET A="" 
	. FOR L=I:1:I+31 QUIT:$LENGTH(X)<L  IF $DATA(^INBRIEF(YM,$EXTRACT(X,I,L),1)) SET A=$EXTRACT(X,I,L),I=I-1 QUIT
	. SET TEXT=TEXT_$EXTRACT(X,P,I-1) 
	. SET P=I
	. IF A'="" DO HTML(A) SET P=P+$LENGTH(A)+1
	
	QUIT
	
BRIEFCALL   ;
	NEW PRIO,KZ,INFO
	
	QUIT:$GET(CALLNR)=""
	SET YFELD=$GET(^INCALL(YM,CALLNR,1))
	SET HTML=$PIECE(BRIEF,Y,5)
	QUIT:$GET(HTML)=""
	
	FOR YI1=1:1:1200 SET YI(1)=$PIECE(HTML,$CHAR(9),YI1) DO  QUIT:$FIND(YI(1),"<END>")  ;LESEN HTML-CODE ;read 
	. ;SET YI(1)=$PIECE(YI(1)," VALUE="_""""_"""",1)_$PIECE(YI(1)," VALUE="_""""_"""",2)   ;VALUE=FALSCH
	. ;
	. IF $FIND(YI(1),"<BETREFF>") DO 
	. . SET BETREFF=$PIECE(YFELD,Y,20)
	. . IF BETREFF'="" SET YI(1)=$PIECE(YI(1),"<BETREFF>",1)_" ("_BETREFF_")"_$PIECE(YI(1),"</BETREFF>",2)
	. . IF BETREFF=""  SET YI(1)=$PIECE(YI(1),"<BETREFF>",1)_" "_$PIECE(YI(1),"</BETREFF>",2)
	. ;
	. IF $FIND(YI(1),"<NR>") DO 
	. . SET YI(1)=$PIECE(YI(1),"<NR>",1)_CALLNR_$PIECE(YI(1),"</NR>",2)
	. ;
	. IF $FIND(YI(1),"<PRIO>") DO 
	. . SET PRIO=$PIECE(YFELD,Y,18)
	. . IF PRIO'="" SET PRIO=$PIECE($GET(^WWW101(0,"PRIO",SPRACHE,PRIO,1)),Y,1)
	. . SET YI(1)=$PIECE(YI(1),"<PRIO>",1)_PRIO_$PIECE(YI(1),"</PRIO>",2)
	. ;
	. IF $FIND(YI(1),"<PRIOKD>") DO           ;BEC;25954;23.06.04;CUSTOMER PRIO
	. . SET PRIO=$PIECE(YFELD,Y,39)
	. . IF PRIO'="" SET PRIO=$PIECE($GET(^INPARA(YM,"PRIOKD",SPRACHE,PRIO,1)),Y,1)
	. . SET YI(1)=$PIECE(YI(1),"<PRIOKD>",1)_PRIO_$PIECE(YI(1),"</PRIOKD>",2)
	. ;
	. IF $FIND(YI(1),"<KENNZEICHEN>") DO 
	. . SET KZ=$PIECE(YFELD,Y,15)
	. . IF KZ'="" SET KZ=$PIECE($GET(^INPARA(YM,"SERVICEKENNZEICHEN",SPRACHE,KZ,1)),Y,1)
	. . SET YI(1)=$PIECE(YI(1),"<KENNZEICHEN>",1)_KZ_$PIECE(YI(1),"</KENNZEICHEN>",2)
	. ;
	. IF $FIND(YI(1),"<STATUS>") DO     ;BEC;26445;28.09.04
	. . SET KZ=$PIECE(YFELD,Y,84)
	. . IF KZ'="" SET KZ=$PIECE($GET(^INPARA(YM,"BEARBEITUNGSSTATUS",SPRACHE,KZ,1)),Y,1)
	. . SET YI(1)=$PIECE(YI(1),"<STATUS>",1)_KZ_$PIECE(YI(1),"</STATUS>",2)
	. ;
	. ;----------------WRITE
	. WRITE YCR
	. DO
	. . NEW I,YZWS,YII
	. . FOR YII=1:1 SET YZWS=$PIECE(YI(1),"|",YII) QUIT:$PIECE(YI(1),"|",YII,999)=""  DO
	. . . SET TEXT=TEXT_$CHAR(13)_YZWS
	. . . IF $PIECE(YI(1),"|",YII+1,999)'="" WRITE $CHAR(13)_$CHAR(10)
	
	QUIT:$GET(VORG(4))=1 
	
	SET INFO=$$^WWWTEXT(32870)
	IF $GET(VORG(1))'="" SET INFO=INFO_" "_""""_$PIECE($GET(^INBRIEF(YM,VORG(1),1)),Y,1)_""""  
	SET INFO=INFO_" "_$$^WWWTEXT(32549)_" "_$$^WWWDATE(+$HOROLOG)_" / "_$GET(YBED)_"|"_$PIECE($GET(^INCALL(YM,CALLNR,1)),Y,26)
	SET $PIECE(^INCALL(YM,CALLNR,1),Y,26)=INFO
	QUIT
	
DRUCK(YNR) ;
	NEW ADR,ADR1,FAXNR,MAIL,YDATEI,YKEY
	
	SET YKEY=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1))
	SET BRIEF=""
	IF VORG(1)'="" IF $DATA(^INDABRIEF(YM,VORG(1),1)) SET BRIEF=$GET(^INDABRIEF(YM,VORG(1),1))
	IF VORG(1)'="" IF $DATA(^INBRIEF(YM,VORG(1),1))   SET BRIEF=$GET(^INBRIEF(YM,VORG(1),1))
	DO KOPF($PIECE(BRIEF,Y,10))   ;DRUCKT FONT UND BRIEFKOPF ;And letterhead 
	;DO BELEG(YNR)   ;ADR HOLEN ;send for 
	;DO VERSANDART   ;VERSANDART IN VORG(3) EINBAU ;within in-built 
	DO UNTER($GET(VORG(6)),$GET(VORG(7)),BRIEF)  ;UNTERSCHRIFT IN VORG(3) EINBAU ;signature within in-built 
	DO ^INBRIEFDMS(YKEY,VORG(3),VORG(1),VORG(2),$GET(VORG(4)),$GET(VORG(5)),$GET(VORG(8)),$GET(VORG(15)),$PIECE(BRIEF,Y,11),$PIECE(BRIEF,Y,25),$PIECE(BRIEF,Y,2))
	QUIT
	
KOPF(GIF)  ;DRUCKT DEN BRIEFKOPF ;letterhead 
	NEW FONT,SIZE,YFAUS,BILD,YLAYOUT
	
	SET YLAYOUT=$PIECE(BRIEF,Y,25)           ;---------PARAMETER  ;FAN;17.02.04;24294
	IF YLAYOUT=""        SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	IF YLAYOUT'=""       SET YLAYOUT1=$GET(^INDMSLAYOUT(YM,YLAYOUT,1))  
	IF $GET(YLAYOUT1)="" SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	
	SET YFAUS="RIGHT"
	SET BRIEF=$GET(BRIEF)
	SET GIF=$GET(GIF)
	IF $PIECE(BRIEF,Y,26)'="" DO      ;BEC;25632;10.05.04;VARABLE GIF GRÖSSE UND POSITION
	. IF $PIECE(BRIEF,Y,26)=1 SET YFAUS="LEFT"
	. IF $PIECE(BRIEF,Y,26)=2 SET YFAUS="CENTER"
	. IF $PIECE(BRIEF,Y,26)=3 SET YFAUS="RIGHT"
	
	SET FONT=$PIECE($GET(BRIEF),Y,11)
	IF FONT'="" SET FONT=$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,FONT,1)),Y,1)
	IF FONT=""  SET FONT="Arial"
	SET SIZE=$PIECE($GET(BRIEF),Y,12)
	IF SIZE="" SET SIZE=3
	SET VORG(3)="<FONT FACE="_""""_FONT_""""_" SIZE="_""""_SIZE_""""_">"_""_VORG(3)
	QUIT:GIF=""
	IF GIF'="" SET VORG(15)=0      ;WENN GIF ALS HEADER DANN KEINE LEERZEILEN ;when when no 
	;SET VORG(3)="|"_"<DIV ALIGN=RIGHT>"_"<IMG SRC="_YGIF1_GIF_">"_"</DIV>"_"|"_VORG(3)    ;BEC;25632;10.05.04;VARABLE GIF GRÖSSE UND POSITION
	SET BILD="<DIV ALIGN="_YFAUS_">"
	;SET BILD=BILD_"<IMG SRC="_YGIF1_GIF         ;BEC;25788;28.05.04
	SET BILD=BILD_"<IMG SRC="
	IF $piece($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"M",1)),Y,2)=1 SET BILD=BILD_YURL
	SET BILD=BILD_YGIF1_GIF
	IF $PIECE(BRIEF,Y,27)'="" SET BILD=BILD_" height="_+$PIECE(BRIEF,Y,27)      ;HEIGTH IN PX ;within 
	SET BILD=BILD_">"_"</DIV>"
	DO
	. NEW YII
	. FOR YII=1:1:$PIECE(YLAYOUT1,Y,2) DO           ;Anzahl Zeilen von Adresse bis Betreff;FAN;17.02.04;24294
	. . SET BILD=BILD_ "|"
	
	SET VORG(3)=BILD_VORG(3)
	QUIT
	
UNTER(BED,JA,BRIEF)   ;UNTERSCHRIFT ;signature 
	IF +$GET(JA)=0 SET VORG(3)=VORG(3)_"</font>" QUIT
	NEW NAME,YLAYOUT,YLAYOUT1
	SET YLAYOUT=$PIECE(BRIEF,Y,25)           ;---------PARAMETER  ;FAN;17.02.04;24294
	IF YLAYOUT=""        SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	IF YLAYOUT'=""       SET YLAYOUT1=$GET(^INDMSLAYOUT(YM,YLAYOUT,1))  
	IF $GET(YLAYOUT1)="" SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_1_Y_1_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	IF $PIECE(YLAYOUT1,Y,9)="" SET $PIECE(YLAYOUT1,Y,9)=1
	IF +$PIECE(YLAYOUT1,Y,9)<0!(+$PIECE(YLAYOUT1,Y,9)>20) SET $PIECE(YLAYOUT1,Y,9)=1   ;Anzahl Zeilen von berief bis unterschrift ;Number from To 
	DO
	. NEW YII
	. FOR YII=1:1:$PIECE(YLAYOUT1,Y,9) DO           ;Anzahl Zeilen von Adresse bis Betreff;FAN;17.02.04;24294
	. . SET VORG(3)=VORG(3)_ "|"
	
	QUIT:BED=""
	
	WRITE YCR
	IF $PIECE($GET(^WWW013(0,BED,1)),Y,58)'="" SET VORG(3)=VORG(3)_$PIECE($GET(^WWW013(0,BED,1)),Y,58)_" "
	IF '$FIND($PIECE($GET(^WWW013(0,BED,1)),Y,1),",") DO
	. SET VORG(3)=VORG(3)_$PIECE($GET(^WWW013(0,BED,1)),Y,1)
	
	IF $FIND($PIECE($GET(^WWW013(0,BED,1)),Y,1),",") DO
	. SET NAME=$PIECE($PIECE($GET(^WWW013(0,BED,1)),Y,1),",",2,99)
	. IF $EXTRACT(NAME,1)=" " SET $EXTRACT(NAME,1)=""
	. SET VORG(3)=VORG(3)_NAME
	. SET VORG(3)=VORG(3)_" "
	. SET VORG(3)=VORG(3)_$PIECE($PIECE($GET(^WWW013(0,BED,1)),Y,1),",",1)
	
	SET VORG(3)=VORG(3)_" </font>"
	QUIT
	
]]></Routine>
</Export>