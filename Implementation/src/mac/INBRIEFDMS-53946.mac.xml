<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INBRIEFDMS" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INBRIEFDMS(YKEY,YTEXT,YBESCHR,YVERSAND,YVORSCHAU,YANLAGEN,YPARTNER,YABZEILE,YFONT,YLAYOUT,YBETRMAIL) ;INBRIEFDMS;FIS;DRUCKEN UND SPEICHERN VON BRIEFEN;17.04.2001
	;
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		DRUCKEN UND SPEICHERN VON BRIEFEN
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;| 05-May-2005		Paul K		Normalised Directory
	;| FIS	17.04.2001
	;|
	;\------------------------------------------------------------------/
	;
	NEW KEY,YFELD,ADR,ADRESSE,ANSCH,YREF,LFN,LFZ,ZANZ,BRIEFTEXT,ABSENDER
	IF $GET(YLAYOUT)'="" SET YLAYOUT1=$GET(^INDMSLAYOUT(YM,YLAYOUT,1))  ;PARAMETER  ;FAN;09.12.03;24294
	IF $GET(YLAYOUT1)="" SET YLAYOUT1="NORM"_Y_7_Y_53_Y_83_Y_1_Y_1_Y_2_Y_1  ;WENN NICHT ANGELEGT ODER FALSCH ;when Not Or wrong 
	IF +$PIECE(YLAYOUT1,Y,3)<10 SET $PIECE(YLAYOUT1,Y,3)=20   ;Anzahl Zeilen des Briefes   ;Number 
	IF +$PIECE(YLAYOUT1,Y,4)<10 SET $PIECE(YLAYOUT1,Y,4)=20   ;Breite des Textes   ;Width 
	SET YANLAGEN=$TRANSLATE($GET(YANLAGEN),";",",")          ;BEC;25788;26.05.04
	SET KEY=YKEY
	QUIT:KEY=""
	SET BRIEFTEXT=YTEXT
	SET BRIEFTEXT=$TRANSLATE($GET(BRIEFTEXT),$CHAR(13)_$CHAR(10),"|")
	IF $TRANSLATE(BRIEFTEXT,"|"_" "_"""")="" QUIT  ;KEIN TEXT ;no Text 
	SET YFAX=""
	SET YEMAIL=""
	SET YBRIEF1=""
	IF $GET(YBESCHR)'="" SET YBRIEF1=$GET(^INBRIEF(YM,YBESCHR,1))           ;BEC;25788;28.05.04;FORMBRIEF
	SET ABSENDER=$PIECE(YBRIEF1,Y,30)                                       ;BEC;25788;26.05.04
	SET YNOFOOT=1
	IF $GET(YVORSCHAU)=1 DO VORSCHAU QUIT
	DO SPEI
	DO DRUCK
	QUIT
	
SPEI ;BRIEF IN INDMS-DATEI SPEICHERN ;letter within Save 
	NEW ZEILE,SEITE,TEXT,SATZ
	SET LFZ=$PIECE(YLAYOUT1,Y,2)  ;ZEILEN VON OBEN BIS ADRESSE ;upstairs until address 
	IF $GET(YABZEILE)'="" SET LFZ=+$GET(YABZEILE)
	;I +LFZ=0 SET LFZ=1 ;table-mat 
	SET ZANZ=LFZ
	SET YREF=KEY_"."_$$^WWWNEXT("INDRPARA")
	IF $EXTRACT($REVERSE(YREF))=0 FOR  QUIT:$EXTRACT($REVERSE(YREF))'=0  DO
	. SET YREF=KEY_"."_$$^WWWNEXT("INDRPARA")
	. QUIT
	IF YBESCHR'="" IF $DATA(^INBRIEF(YM,YBESCHR,1)) SET YBESCHR=YBESCHR_" - "_$PIECE($GET(^(1)),Y,1)
	IF $DATA(^WWW101(0,"MEDIUM1",SPRACHE,+YVERSAND,1)) SET YVERSAND=$PIECE($GET(^(1)),Y,1)
	;REFERENZDATZEI SPEICHERN ;Save 
	SET SATZ=""
	SET $PIECE(SATZ,Y,1)=+$HOROLOG  ;DRUCKDATUM
	SET $PIECE(SATZ,Y,2)=YBED  ;MITARBEITER
	SET $PIECE(SATZ,Y,3)=YBESCHR  ;INHALT ;purport 
	SET $PIECE(SATZ,Y,4)=YVERSAND  ;VERSANDART
	SET $PIECE(SATZ,Y,6)=$PIECE($GET(^INVORG(YM,YM,1)),Y,46)  ;E-MAIL EMPFÃ„NGER DOKUMENTENMANAGEMENT ;recipient 
	SET $PIECE(SATZ,Y,7)=$PIECE($GET(^INVORG(YM,YM,1)),Y,47)  ;URL DOKUMENTENABRUF
	SET $PIECE(SATZ,Y,8)=3  ;FORMBRIEFE
	SET $PIECE(SATZ,Y,9)=$GET(YANLAGEN)  ;FORMBRIEFE
	SET $PIECE(SATZ,Y,10)=KEY_","_$GET(YPARTNER)  ;ANSPRECHPARTNER
	SET $PIECE(SATZ,Y,12)=KEY   ;AUFTRAGSNUMMER ZUR SUCHE ;search 
	DO
	. NEW YFELD,YVOR
	. DO ^WWWSPEI("INDMSA",YREF,SATZ,1)
	. QUIT
	SET ZEILE=""
	SET SEITE=1
	DO BRIEF(BRIEFTEXT)
	;DO FF^WWWW()
	QUIT
	
BRIEF(TEXT)  ;BRIEFTEXT
	NEW ZEILE0
	SET YI=1
	SET ZEILE=""
	FOR LFN=1:1  QUIT:$PIECE(TEXT,"|",LFN,9999)=""  SET ZEILE=$PIECE(TEXT,"|",LFN) DO
	. IF $FIND(ZEILE,"@@E-MAIL") SET $PIECE(YEMAIL,Y,LFN)=$PIECE($TRANSLATE($PIECE(ZEILE,"@@E-MAIL",2),"|/ =,;:?\#"),"@@",1)  QUIT  ;E-MAIL
	. IF $FIND(ZEILE,"@@NUMMER") SET $PIECE(YFAX,Y,LFN)=$TRANSLATE($PIECE(ZEILE,"@@NUMMER",2),"|/- =.,;:_?\+#@")  QUIT  ;FAX
	. ;
	. IF '$FIND(ZEILE,"                                ") IF $LENGTH(ZEILE)>$PIECE(YLAYOUT1,Y,4) DO  QUIT
	. . SET ZEILE0=""
	. . FOR YA=1:1 QUIT:$PIECE(ZEILE," ",YA,999)=""  SET ZEILE0=ZEILE0_$PIECE(ZEILE," ",YA)_" " DO
	. . . IF $LENGTH(ZEILE0)>$PIECE(YLAYOUT1,Y,4) DO   ;BEREIT DER BRIEF ;willingly the letter 
	. . . . SET LFZ=LFZ+1
	. . . . SET ZANZ=ZANZ+1
	. . . . SET ^INDMS(YM,YREF,SEITE,LFZ,1)=ZEILE0
	. . . . IF LFZ>$PIECE(YLAYOUT1,Y,3) DO
	. . . . . QUIT:+$PIECE(YLAYOUT1,Y,5)=1 
	. . . . . SET SEITE=SEITE+1 SET LFZ=5 SET ZANZ=ZANZ+LFZ  ;NEUE SEITE ;side 
	. . . . . QUIT
	. . . . SET ZEILE0=""
	. . . . QUIT
	. . . QUIT
	. . IF ZEILE0'="" DO
	. . . SET LFZ=LFZ+1
	. . . SET ZANZ=ZANZ+1
	. . . SET ^INDMS(YM,YREF,SEITE,LFZ,1)=ZEILE0
	. . . QUIT
	. . QUIT
	. ;
	. SET LFZ=LFZ+1
	. SET ZANZ=ZANZ+1
	. SET ^INDMS(YM,YREF,SEITE,LFZ,1)=ZEILE
	. DO
	. . NEW A,LFN
	. . SET A="<PRE>"
	. . IF $GET(YVOR)'="" DO
	. . . SET YFACE=$PIECE(YVOR,Y,9)
	. . . S YSIZE=$P(YBRIEF1,Y,12)                 ;BEC;25788;28.05.04
	. . . I YSIZE="" SET YSIZE=$PIECE(YVOR,Y,7)
	. . . IF YFACE'="" DO
	. . . . SET A=A_"<FONT"
	. . . . ;SET A=A_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . . . IF $GET(YFONT)'="" SET A=A_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . . . IF YSIZE'="" SET A=A_" SIZE="_""""_YSIZE_""""
	. . . . SET A=A_">"
	. . . . QUIT
	. . . QUIT
	. . SET LFN=0
	. . SET ^INDMS(YM,YREF,YSEITE,LFN,1)=A
	. . SET A=""
	. . QUIT
	. IF LFZ>$PIECE(YLAYOUT1,Y,3) DO
	. . QUIT:+$PIECE(YLAYOUT1,Y,5)=1  
	. . SET SEITE=SEITE+1 SET LFZ=5 SET ZANZ=ZANZ+LFZ  ;NEUE SEITE ;side 
	. . QUIT
	. QUIT
	;SPEICHERN IN DOKUMENTENMANAGEMENT/INTERNET VIA E-MAIL ;Save within via 
	IF $PIECE(SATZ,Y,6)'="" DO   ;E-MAIL
	. SET OK=$$^INMAILSEND(YREF,$PIECE(SATZ,Y,6),YREF,0,1)  ;INDMS-KEY,E-MAIL ADRESSE,BETREFF,OHNE BILDER,HTML-FORMAT)
	. IF OK'=1 SET $PIECE(^INDMSA(YM,YREF,1),Y,7)=""
	. QUIT
	QUIT
	
DRUCK ;BRIEF DRUCKEN / SENDEN ;letter print transmit 
	IF $GET(YVERSAND)=1 IF $GET(YEMAIL)="" SET YEMAIL=" "    ;BEC;25788;25.05.04; DAMIT EINE FEHLERMELDUNG KOMMT
	DO
	. IF YEMAIL="" IF YFAX="" DO  QUIT
	. . SET $Y=0
	. . DO ^INDMS(YREF)
	. . QUIT
	. ;
	. ;VORG(1)=FAXNUMMER
	. IF YFAX'="" DO  ;FAX
	. . NEW VORG,LFN1,SEITE1
	. . FOR YI(2)=1:1 QUIT:$PIECE(YFAX,Y,YI(2),999)=""  SET VORG(1)=$PIECE(YFAX,Y,YI(2)) DO
	. . . SET VORG(2)=""
	. . . SET SEITE1="" FOR  SET SEITE1=$ORDER(^INDMS(YM,YREF,SEITE1)) QUIT:SEITE1=""  DO
	. . . . FOR LFN1=1:1:ZANZ DO  ;$PIECE(YBELEG1,Y,3) DO
	. . . . . IF '$DATA(^INDMS(YM,YREF,SEITE1,LFN1,1)) SET ^(1)=""
	. . . . . SET VORG(2)=VORG(2)_$GET(^INDMS(YM,YREF,SEITE1,LFN1,1))_" |"
	. . . . . QUIT
	. . . . DO ^WWWFAX
	. . . . WRITE $$^WWWTEXT(32499)_" "_$$^WWWTEXT(366)_" ! "_VORG(1)  ;FAX GESENDET !
	. . . . DO ^INDMS(YREF)
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. ;
	. IF YEMAIL'="" DO  ;E-MAIL
	. . NEW YATTACH,YBETR2
	. . SET YATTACH=""
	. . IF $GET(YANLAGEN)'="" DO        ;BEC;25788;26.05.04
	. . . NEW YI,PATH,PATH1
	. . . SET PATH=##Class(%File).NormalizeDirectory($PIECE($GET(^WWW012(0,YM,1)),Y,49))                 ;PFAD AUS DEN MANDANTENPARAMETERN ;track out of 
	. . . SET PATH=$PIECE(PATH,$TRANSLATE($PIECE($GET(^WWW012(0,YM,1)),Y,47),"/","\"))
	. . . SET PATH1=$TRANSLATE(YGIF1,"/","\")
	. . . IF $EXTRACT(PATH,$LENGTH(PATH))'="\" IF $EXTRACT(PATH1)'="\" SET PATH=PATH_"\"  ;WENN KEIN VERZEICHNIS GESETZT ;when no tabulation staid 
	. . . SET PATH=PATH_PATH1
	. . . FOR YI=1:1 QUIT:$PIECE(YANLAGEN,",",YI,99)=""  DO
	. . . . QUIT:$PIECE(YANLAGEN,",",YI)=""
	. . . . SET YATTACH=$GET(YATTACH)_PATH_$PIECE($GET(^INPARA(YM,"BRIEFANLAGEN",SPRACHE,$PIECE(YANLAGEN,",",YI),1)),Y,1)_"|"
	. . . . QUIT
	. . . QUIT
	. . FOR YI(1)=1:1 QUIT:$PIECE(YEMAIL,Y,YI(1),999)=""  SET YMAIL=$PIECE(YEMAIL,Y,YI(1)) DO
	. . . ;SET OK=$$^INMAILSEND(YREF,YMAIL,YREF,1,2)  ;INDMS-KEY,E-MAIL ADRESSE,BETREFF;HTML-TEXT
	. . . ;QUIT:YMAIL=""     ;DAMIT AUCH EINE FEHLERMELDUNG KOMMT
	. . . SET YBETR2=$PIECE($GET(YBESCHR),"-",2)_" "_YREF
	. . . IF $GET(YBETRMAIL)'="" SET YBETR2=$GET(YBETRMAIL)
	. . . IF $FIND(YBETR2,"<NR>") DO 
	. . . . SET YBETR2=$PIECE(YBETR2,"<NR>",1)_$PIECE(YREF,".",1)_$PIECE(YBETR2,"</NR>",2)
	. . . . QUIT
	. . . SET YBETR2=$TRANSLATE(YBETR2,"|")
	. . . FOR YI="<B>","</B>","<b>","</b>","<u>","</u>","<U>","</U>" SET YBETR2=$$^WWWTRANSLATE(YBETR2,YI)
	. . . QUIT
	. . SET YOK=""
	. . IF $GET(YMAIL)'="" SET OK=$$^INMAILSEND(YREF,YMAIL,YBETR2,1,2,$GET(ABSENDER),$GET(YATTACH))  ;INDMS-KEY,E-MAIL ADRESSE,BETREFF;HTML-TEXT ;BEC;22917
	. . IF $GET(OK)'=1 WRITE "<FONT COLOR="_YRED_">"_$$^WWWTEXT(33029)_": "    ;  - Fehler  ;Error 
	. . IF $TRANSLATE(YMAIL," ")=""  WRITE $$^WWWTEXT(33882)    ;keine E-Mail adresse vorhanden ;None E-Mail on hand 
	. . WRITE YMAIL_" : "
	. . IF $GET(OK)=1 WRITE $$^WWWTEXT(32413)_" "_$$^WWWTEXT(32046)_" "_$$^WWWTEXT(32293)
	. . IF $GET(OK)'=1 WRITE $$^WWWTEXT(32413)_" "_$$^WWWTEXT(32046)_" "_$$^WWWTEXT(144)_"</FONT>"
	. . WRITE "<BR>"
	. . DO ^INDMS(YREF)
	. . SET YSEND=0
	. . QUIT
	. ;
	. QUIT
	QUIT
	
VORSCHAU ;
	NEW LFZ,LFN,ZEILE,ZEILE0,SEITE
	SET ZEILE=""
	SET SEITE=1
	SET LFZ=$PIECE(YLAYOUT1,Y,2)  ;ZEILEN VON OBEN BIS ADRESSE ;upstairs until address 
	WRITE "<HTML>",YCR
	WRITE "<BODY>",YCR
	WRITE "<PRE>",YCR
	WRITE "<CENTER><FONT SIZE=5 COLOR="_YRED_"><B>"_$$^WWWTEXT(32416)_"</B></FONT></center>"
	FOR YI=1:1:LFZ WRITE " ",YCR
	FOR LFN=1:1 QUIT:$PIECE(BRIEFTEXT,"|",LFN,9999)=""  SET ZEILE=$PIECE(BRIEFTEXT,"|",LFN) DO
	. IF $FIND(ZEILE,"@@E-MAIL") QUIT  ;E-MAIL
	. IF $FIND(ZEILE,"@@NUMMER") QUIT  ;FAX
	. IF $LENGTH(ZEILE)>$PIECE(YLAYOUT1,Y,4) DO  QUIT
	. . SET ZEILE0=""
	. . FOR YA=1:1 QUIT:$PIECE(ZEILE," ",YA,999)=""  SET ZEILE0=ZEILE0_$PIECE(ZEILE," ",YA)_" " DO
	. . . IF $LENGTH(ZEILE0)>$PIECE(YLAYOUT1,Y,4) DO
	. . . . WRITE ZEILE0,YCR
	. . . . SET LFZ=LFZ+1
	. . . . SET ZEILE0=""
	. . . . QUIT
	. . . QUIT
	. . IF ZEILE0'="" DO
	. . . WRITE ZEILE0,YCR
	. . . SET LFZ=LFZ+1
	. . . SET ZEILE0=""
	. . . QUIT
	. . QUIT
	. ;
	. WRITE ZEILE,YCR
	. SET LFZ=LFZ+1
	. IF LFZ>$PIECE(YLAYOUT1,Y,3) DO  ;NEUE SEITE ;side 
	. . QUIT:+$PIECE(YLAYOUT1,Y,5)=1 
	. . WRITE "<HR SIZE=1 COLOR=YELLOW>"
	. . DO FF^WWWW()
	. . SET LFZ=5
	. . FOR YI=1:1:LFZ WRITE " ",YCR
	. . QUIT
	. QUIT
	WRITE "</PRE>",YCR
	WRITE "</BODY>",YCR
	WRITE "</HTML>",YCR
	QUIT
]]></Routine>
</Export>