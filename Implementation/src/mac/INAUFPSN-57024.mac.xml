<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUFPSN" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUFPSN ;INAUFPSN;FIS;SERIENNUMMER DER AUFTRAGSPOSITION ANZEIGEN;25.06.2001
	;
#include COMSYS   // SR14746
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		SERIENNUMMER DER AUFTRAGSPOSITION ANZEIGEN
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;|
	; 21-SEP-2006 FAN SR14746 Sales statistics incorrect
 
	;| FIS	25.06.2001
	;|
	;\------------------------------------------------------------------/
	;
	NEW AUF,POS,SN,SNALT
	SET YKEY=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1))
	SET AUF=$PIECE(YKEY,",",1)
	QUIT:AUF=""
	SET POS=$PIECE(YKEY,",",2)
	QUIT:POS=""
	SET SN=""
	IF $DATA(^INWEAUFS(YM,AUF,POS)) DO
	. NEW BET,LAP,WE,SN0
	. SET BET="" FOR  SET BET=$ORDER(^INWEAUFS(YM,AUF,POS,BET)) QUIT:BET=""  DO
	. . SET LAP="" FOR  SET LAP=$ORDER(^INWEAUFS(YM,AUF,POS,BET,LAP)) QUIT:LAP=""  DO
	. . . SET WE="" FOR  SET WE=$ORDER(^INWEAUFS(YM,AUF,POS,BET,LAP,WE)) QUIT:WE=""  DO
	. . . . SET SN0="" FOR  SET SN0=$ORDER(^INWEAUFS(YM,AUF,POS,BET,LAP,WE,SN0)) QUIT:SN0=""  DO
	. . . . . SET SN=SN_";"_SN0
	. . . . . QUIT
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. QUIT
	IF $DATA(^INWEAUFALTS(YM,AUF,POS)) DO
	. NEW BET,LAP,WE,SN0
	. SET BET="" FOR  SET BET=$ORDER(^INWEAUFALTS(YM,AUF,POS,BET)) QUIT:BET=""  DO
	. . SET LAP="" FOR  SET LAP=$ORDER(^INWEAUFALTS(YM,AUF,POS,BET,LAP)) QUIT:LAP=""  DO
	. . . SET WE="" FOR  SET WE=$ORDER(^INWEAUFALTS(YM,AUF,POS,BET,LAP,WE)) QUIT:WE=""  DO
	. . . . SET SN0="" FOR  SET SN0=$ORDER(^INWEAUFALTS(YM,AUF,POS,BET,LAP,WE,SN0)) QUIT:SN0=""  DO
	. . . . . SET SN=SN_";"_SN0
	. . . . . QUIT
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. QUIT
	QUIT:$TRANSLATE(SN,";")=""  ;KEINE SN VORHANDEN
	IF $EXTRACT(SN)=";" SET SN=$EXTRACT(SN,2,999)
	SET YINHALT=SN
	;LÖSCHEN MANUELLE SERIENNUMMER ;Delete 
	SET SNALT=$TRANSLATE($PIECE($GET(^INAUFP(YM,AUF,POS,1)),Y,56),";",",")
	IF SNALT'="" DO
	. FOR YI=1:1  QUIT:$PIECE(SNALT,",",YI,999)=""  DO
	. . QUIT:$PIECE(SNALT,",",YI)=""
	. . ;QUIT:$DATA(^INWEAUFSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUF,POS))  ;KEINE MANUELLE SN
	. . ;QUIT:$DATA(^INWEAUFALTSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUF,POS))
	. . QUIT:$FIND(","_YINHALT_",",","_$PIECE(SNALT,",",YI)_",")
	. . DO HIST^INSNHIST($PIECE(SNALT,",",YI),$$^WWWTEXT(32116)_" "_$$^WWWTEXT(42)_" "_AUF_"-"_POS,$PIECE($GET(^INAUFP(YM,AUF,POS,1)),Y,4),AUF,POS)  ;SN GELÖSCHT
	. . QUIT
	. ;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,56)=YINHALT  // SR14746;AUCH IN DATEI LÖSCHEN;25.02.04;FIS ;too within data file Delete 
	. DO 
	. . NEW SATZ
	. . SET SATZ=$GET(^INAUFP(YM,AUF,POS,1))
	. . SET $PIECE(SATZ,Y,56)=YINHALT
	. . SET strStatus=$$$Save("INAUFP",AUF_","_POS,SATZ,$$$YES) // SR14746
	. QUIT
	QUIT
	
MANUSN ;MANUELLE SERIENNUMMER
	NEW AUFTAG,POSITION,SNALT
	QUIT:$GET(YKEY)=""
	QUIT:$GET(YFELD)=""
	
	
	
	SET AUFTRAG=$PIECE(YKEY,",",1)
	SET POSITION=$PIECE(YKEY,",",2)
	SET SNALT=$TRANSLATE($PIECE($GET(^INAUFP(YM,AUFTRAG,POSITION,1)),Y,56),";",",")
	IF $PIECE(YFELD,Y,56)'="" DO
	. NEW YI
	. SET $PIECE(YFELD,Y,56)=$TRANSLATE($PIECE(YFELD,Y,56),";",",")
	. FOR YI=1:1  QUIT:$PIECE($PIECE(YFELD,Y,56),",",YI,999)=""  DO
	. . QUIT:$PIECE($PIECE(YFELD,Y,56),",",YI)=""
	. . QUIT:$FIND(","_SNALT_",",","_$PIECE($PIECE(YFELD,Y,56),",",YI)_",")
	. . QUIT:$DATA(^INWEAUFSs(YM,1,$$^WWWUMLAU($PIECE($PIECE(YFELD,Y,56),",",YI),1),AUFTRAG,POSITION))  ;KEINE MANUELLE SN ;no 
	. . QUIT:$DATA(^INWEAUFALTSs(YM,1,$$^WWWUMLAU($PIECE($PIECE(YFELD,Y,56),",",YI),1),AUFTRAG,POSITION))
	. . DO HIST^INSNHIST($PIECE($PIECE(YFELD,Y,56),",",YI),$$^WWWTEXT(58)_" / "_$$^WWWTEXT(32047)_" "_AUFTRAG_"-"_POSITION,$PIECE(YFELD,Y,4),AUFTRAG,POSITION)  ;NEUANLAGE
	. . QUIT
	. FOR YI=1:1  QUIT:$PIECE(SNALT,",",YI,999)=""  DO
	. . QUIT:$PIECE(SNALT,",",YI)=""
	. . QUIT:$FIND(","_$PIECE(YFELD,Y,56)_",",","_$PIECE(SNALT,",",YI)_",")
	. . QUIT:$DATA(^INWEAUFSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUFTRAG,POSITION))  ;KEINE MANUELLE SN ;no 
	. . QUIT:$DATA(^INWEAUFALTSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUFTRAG,POSITION))
	. . DO HIST^INSNHIST($PIECE(SNALT,",",YI),$$^WWWTEXT(32116)_" "_$$^WWWTEXT(42)_" "_AUFTRAG_"-"_POSITION,$PIECE(YFELD,Y,4),AUFTRAG,POSITION)  ;SN GELÖSCHT
	. . QUIT
	. QUIT
	IF $PIECE(YFELD,Y,56)="" DO
	. NEW YI
	. FOR YI=1:1  QUIT:$PIECE(SNALT,",",YI,999)=""  DO
	. . QUIT:$PIECE(SNALT,",",YI)=""
	. . QUIT:$DATA(^INWEAUFSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUFTRAG,POSITION))  ;KEINE MANUELLE SN ;no 
	. . QUIT:$DATA(^INWEAUFALTSs(YM,1,$$^WWWUMLAU($PIECE(SNALT,",",YI),1),AUFTRAG,POSITION))
	. . DO HIST^INSNHIST($PIECE(SNALT,",",YI),$$^WWWTEXT(32116)_" "_$$^WWWTEXT(42)_" "_AUFTRAG_"-"_POSITION,$PIECE(YFELD,Y,4),AUFTRAG,POSITION)  ;SN GELÖSCHT
	. . QUIT
	. QUIT
	QUIT
]]></Routine>
</Export>