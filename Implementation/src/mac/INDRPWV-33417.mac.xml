<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRPWV" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRPWV(TEXT,MIT,YTYP,YID,YART,PRIO)
#include COMSYS
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		GENERIEREN VON DRP-WIEDERVORLAGEN
	;
	; Inputs : 
	;   TEXT= WIEDERVORLAGENTEXT;MESSAGE TEXT
	;   MIT = AN WELCHEN MITARBEITER ;CONSIGNEE 
	;   YTYP= MELDUNGSGRUND 1=ORDER CREATED ... 5=DEMAND DELETED ... ETC.
	;   YID = ID-NUMBER
	;   YART= ARTIKELNUMMER  ;ITEM NO.
	;   PRIO= PRIORITÄT ;priority
	;
	;
	; ByRef :
	;
	;
	; Returns : nothing
	;
	; History :
	; 18-Mar-2009	GRF		specific $$$KEY macros; Doco
	; 15.06.2005	FIS		REBUILT
	; 03.12.2001	FIS
	;-------------------------------------------------------------------------------
	;DRP MESSAGES GETS CREATED IN:
	;INDRPRUN   - IF STATUS IS OVER DUE
	;INDRPRUN12 - WHEN AN ORDER HAS BEEN CREATED
	;INDRPRUN8  - WHEN MANUAL DEMAND HAS CLOSED OR DELTED
	NEW BET,SATZ,KEY,FORM,DAT,XSPRACHE,YI
	
	SET BET  = $GET(BETRIEB)
	IF BET="" SET BET=YLOCATION                            ;LOCATION
	QUIT:BET=""
	SET TEXT = $GET(TEXT)     IF TEXT="" SET TEXT="???"    ;TEXT
	SET MIT  = $GET(MIT)
	IF MIT="" SET MIT=YBED  IF (MIT="UNKNOWN") || (MIT=$PIECE($GET(^INVORG(YM,YM,1)),Y,79)) || (MIT="") QUIT    ;PLANNER
	SET YID  = $GET(YID)       IF YID=""  SET YID=" "      ;ID-NUMBER
	SET YTYP = $GET(YTYP)     IF YTYP="" SET YTYP=" "      ;MESSAGE TYPE
	SET YART = $GET(YART)     IF YART="" SET YART=" "      ;ARTIKEL
	SET PRIO = $GET(PRIO)                                  ;PRIORITÄT ;priority 
	
	;NEW VERSION;FIS;27.05.05;27207/SR12356
	;======================================
	SET KEY=""
	SET $$$KEY1(KEY) = BET                  ; LOCATION
	SET $$$KEY2(KEY) = MIT                  ; CONSIGNEE
	SET $$$KEY3(KEY) =+$HOROLOG             ; DATE
	SET $$$KEY4(KEY) = YTYP                 ; MESSAGE TYPE
	SET $$$KEY5(KEY) = YART                 ; LOCATION
	SET $$$KEY6(KEY) = YID                  ; ID NUMMER
	;
	SET SATZ=""
	SET $PIECE(SATZ,Y,1)=TEXT  ;MESSAGE
	IF $FIND(YID,"-") SET $PIECE(SATZ,Y,6)=YID
	IF '$FIND(YID,"-") DO
	. IF $DATA(^INDRPDEMAND(YM,BET,YID,1)) SET $PIECE(SATZ,Y,2)=YID,$PIECE(SATZ,Y,6)=$PIECE(^INDRPDEMAND(YM,BET,YID,1),Y,2) QUIT  ;DEMAND NO.
	. IF $DATA(^INDRPSUPPLY(YM,BET,YID,1)) SET $PIECE(SATZ,Y,3)=YID,$PIECE(SATZ,Y,6)=$PIECE(^INDRPSUPPLY(YM,BET,YID,1),Y,2)       ;SUPPLY NO.
	
	SET $PIECE(SATZ,Y,7)  = PRIO                      ;PRIORITY
	SET $PIECE(SATZ,Y,9)  = +$HOROLOG                 ;CREATED DATE
	SET $PIECE(SATZ,Y,10) = $PIECE($HOROLOG,",",2)    ;CREATED TIME
	SET $PIECE(SATZ,Y,11) = YBED                      ;CREATED BY
	
	;LÖSCHEN ALTE WV ;Delete OLD MESSAGES
	FOR YI=0:1:30  SET DAT=(+$HOROLOG-YI) DO
	. IF $DATA(^INDRPWV(YM,BET,MIT,DAT,YTYP,YART,YID)) DO
	. . DO ^WWWSKILL("INDRPWV",BET_","_MIT_","_DAT_","_YTYP_","_YART_","_YID)
	;. . KILL ^INDRPWV(YM,BET,MIT,DAT,YTYP,YART,YID)
	;. . KILL ^INDRPWVs(YM,1,$$^WWWUMLAU(YID,1),BET,MIT,DAT,YTYP,YART,YID)
	
	;SPEICHERN WIEDERVORLAGE ;Save NEW MESSAGES
	SET ^INDRPWV(YM,BET,MIT,+$HOROLOG,YTYP,YART,YID,1)=SATZ
	SET ^INDRPWVs(YM,1,$$^WWWUMLAU(YID,1),BET,MIT,+$HOROLOG,YTYP,YART,YID,1)=""  ;SORTKEY MANUELL, AUS PERFORMANCE GRÜNDEN
	
	DO ^INDRPMESPROT(MIT,TEXT,PRIO,$GET(RUNID))  ;WIEDERVORLAGEN-PROTOKOLL
	
	QUIT
	
	
	/*
	;OLD VERSION;FIS;27.05.05;27207
	;===============================
	SET SATZ=""
	SET $PIECE(SATZ,Y,1)=+$HOROLOG  ;ERFASSUNGSDATUM
	SET $PIECE(SATZ,Y,2)=$PIECE($HOROLOG,",",2)  ;UHRZEIT
	SET $PIECE(SATZ,Y,3)=YBED
	SET $PIECE(SATZ,Y,4)=TEXT  ;MELDETEXT
	SET $PIECE(SATZ,Y,5)=PRIO  ;PRIORITÄT ;priority 
	
	SET FORM="INDRPRUN"
	SET KEY="!"_YART  ;ACHTUNG BEI ÄNDERUNG ! (SIEHE: KEY^INDRPRUN)
	SET DAT(1)=+$HOROLOG
	SET DAT(2)=$TRANSLATE($PIECE($HOROLOG,",",2),"0")  ;OHNE NULL, DAMIT KEIN STRING
	
	;WENN KEY BEREITS VORHANDEN ;when KEY yet on hand 
	IF $DATA(^WWWWV(YM,MIT,DAT(1)_"."_DAT(2))) FOR  QUIT:'$DATA(^WWWWV(YM,MIT,DAT(1)_"."_DAT(2)))  DO
	. SET DAT(2)=DAT(2)+1
	. IF $EXTRACT($REVERSE(DAT(2)),1)=0 SET DAT(2)=DAT(2)+1
	
	;LÖSCHEN ALTE WV ;Delete 
	IF YID'="" IF $DATA(^INDRPWV(YM,BET,YTYP,YID,MIT)) DO
	. NEW DATUM,XKEY
	. SET DATUM=""
	. FOR  SET DATUM=$ORDER(^INDRPWV(YM,BET,YTYP,YID,MIT,DATUM)) QUIT:DATUM=""  DO
	. . SET XKEY=$GET(^INDRPWV(YM,BET,YTYP,YID,MIT,DATUM,1))
	. . IF $DATA(^WWWWV(YM,$PIECE(XKEY,Y,1),$PIECE(XKEY,Y,2),$PIECE(XKEY,Y,3),$PIECE(XKEY,Y,4))) DO
	. . . DO ^WWWSKILL("WWWWV",$PIECE(XKEY,Y,1)_","_$PIECE(XKEY,Y,2)_","_$PIECE(XKEY,Y,3)_","_$PIECE(XKEY,Y,4))
	. . ;
	. . DO ^WWWSKILL("INDRPWV",BET_","_YTYP_","_YID_","_MIT_","_DATUM)
	
	
	;SPEICHERN WIEDERVORLAGE ;Save 
	SET ^WWWWV(YM,MIT,DAT(1)_"."_DAT(2),FORM,KEY,1)=SATZ
	IF YID'="" SET ^INDRPWV(YM,BET,YTYP,YID,MIT,DAT(1)_"."_DAT(2),1)=MIT_Y_DAT(1)_"."_DAT(2)_Y_FORM_Y_KEY
	
	DO ^INDRPMESPROT(MIT,TEXT,PRIO,$GET(RUNID))  ;WIEDERVORLAGEN-PROTOKOLL
	
	;DO ^INDRPRUNPROT($$^WWWTEXT(32818)_" ("_MIT_")",BET,$GET(RUNID),$GET(ART))  ;PROTOKOLL: WIEDERVORLAGE GENERIERT
	QUIT
	*/
]]></Routine>
</Export>