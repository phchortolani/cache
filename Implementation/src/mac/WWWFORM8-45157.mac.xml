<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWFORM8" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWFORM8
#include WWWConst
 
	;-------------------------------------------------------------------------------
	; BUILD JAVASCRIPT/VBSCRIPT      ; EINBAUEN
	;
	; Returns:
	;
	; History:
	; 23-Oct-2014	FrankF	IPIRANGA-250: New Multiple FAT Search control.
	; 05-Sep-2014	FrankF	IPIRANGA-267: A pop up window from the form 'Plano de Suprimentos' keeps
	;						refreshing forever. The new test to detect if a new window has been created(core-357)
	;						is not working properly. The property window.opener will work fine if we have a
	;						pop up window from a clicked button that is called using window.open()
	; 08-Apr-2014	shobby	CORE-378: Don't create a new YUSER if showing a popup calendar form.
	; 20-Mar-2014	shobby	CORE-357: Test to detect if a new window has been created doesn't work in more
	;                                   recent browsers.  Use Use window.history.length.
	; 06-May-2013	shobby	CORE-70.2: Some forms such as WWWPARA and COMViewSearch will react badly
	;								   to this redirection, but can generally be assumed that they were
	;									called from a button press rather than a right-click/new window.
	; 23-Apr-2013	shobby	CORE-80.1: Use $$$JSText to convert the href before assigning.
	; 10-Apr-2013	shobby	CORE-70: Function NewSession, creates a new YUSER if the screen is loaded
	;								 by right clicking on a tab. CORE-70
	; 18-Oct-2012	shobby	SR18145: Only setfocus to a control if it is present.
	; 17-Oct-2012	shobby	SR18066: doBlur function
	; 28-Jun-2012	shobby	SR17790: Removed the 900 sec minimum, let cache settings determine
	;							the minimum.
	; 27-Jun-2012	shobby	SR17790: Ensure that Alphalinc times out before cache session.
	; 19-Jun-2012	shobby	SR17790: Changes so that logout won't be stopped if a
	;							modal form is present.
	; 03-Nov-2011	shobby	SR17725: New type of control FATSearch
	; 27-Jan-2011	shobby	SR17086: Called out to WWWFORMHOTKEY to allow
	;							configuration of hot keys.
	; 07-Oct-2010	shobby	SR17564: Create javascript for inheritable checkboxes.
	; 23-Apr-2010	shobby	SR17267: Script to support popup warning messages.
	; 13-Apr-2010	shobby	Function pruef wasn't being found by KeyEvent probably
	; 							because of different scoping of $$$StartScript/
	; 							$$$EndScript
	; 24-Jun-2009	GRF		Doco
	; 30-Mar-2009	shobby	SR16459: SRBR014794 code restoration from SES/DEV merge
	; 30-Mar-2009	GRF		Doco
	; 07-Feb-2008	shobby	SRBR014794: Check YFELD exists before calling JSInitializingMasking
	; 04-Jan-2008	heber	SRBR014794: Add call new funtion which loads mask variables
    ; 19-Sep-2007	shobby	SRBR014721: Don't use disabled for textarea controls,
    ; 							they become hard to read.
	; 16-Jul-2007	HeberB	SRBR014502:Add JS for masking 
    ; 07-May-2007	GRF		SRBR014310: Doco; quits
	; 23-Aug-2006	shobby	SR14969: Redirect to the specified form (could be login)
	; 							on timeout.
	; 06-Jul-2006   FIS		SR14800: Use XMLHttpRequest only
	; 02-May-2006	SS		SR14592: NewPage function
	; 01-Jun-2005	RPW		SR12056: Attempt at Performance Increase
	; 30-May-2005	shobby	SR11027: Enabled faster piece function.
	; 12-May-2005	FIS		SR11027: new version - function piece
	; 22-Mar-2005	Paul K	Changed to check for existance of COMViewSetup routine
	; 							before calling COMView (SR#11912)
	; 13.11.1997	DT
	;-------------------------------------------------------------------------------
	new YLF,YON,YFU,YTX,YI,YTX1
	
	do JSMaskFunction() ; always print the code to apply mask

	; need to check YFELD here it may not exist in such forms as INTOURCHART
	if $data(YFELD) do JSInitializingMasking(YFELD,YFORM) ; create mask variables and load into initial mask values

	do Setup^WWWFORM7FATMulticombobox() ;IPIRANGA-250
	
	$$$StartScript()
	write "function NewPage(pobjForm) {"
	write "		document.getElementById('MASTER').style.display=""none"";"
	write "}"
	write !
	do Setup^WWWFORMCrossBrowserSupport()			;SR17253
	do Setup^WWWFORMButtonScript()					;SR17253
	do Javascript^WWWFORM7InheritableCheckBox()		;SR17564
	do Javascript^WWWFORM7FATSearch()				;SR17725
	
	;SR17267 vvvvvv
	write "var Warning;",!
	write "function SetupWarning(pObject,pstrWarning) {",!
	write "  Warning=pstrWarning;",!
	write "	 var obj = document.createElement('img');",!
	write "	 obj.src=FilePath+'warning.ico';",!
	write "  obj.style.cursor='pointer';",!
	write "  obj.attachEvent('onclick',ShowWarning);",!
	write "  doInsertAdjacentElement(pObject,'AfterEnd',obj);",!
	write "	}",!
	write "function ShowWarning() {",!
	write "  CallBackNow('Show^WWWPopupMessage',Warning,'"_$$$JSText($$$Text("Com00179"))_"');"  ; "Warning"
	write "}" 
	;SR17267 ^^^^^

	;SR18145 vvvvv
	&js<
	
		function ControlSetFocus(pidControl) {
			var objcontrol=document.getElementById(pidControl);
			if (objcontrol!=undefined) {
				if(!objcontrol.readOnly && objcontrol.type!='hidden' && !objcontrol.disabled) {objcontrol.focus();}
			} else {
				//alert(pidControl+' is missing');
			}
		}
		function doBlur(pthis,selval) {		//18066		
			var value;
		  	if (selval==undefined) {
		    	value=pthis.value;
		  	} else {
		    	value=selval;
		  	}
		  	if (!pthis.readOnly) {
		    	if (value!=pthis.getAttribute('_oldValue')) {
		      		pthis.setAttribute('_oldValue',value);
		      		return true;
		    	}
		  	}
		    return false;
		}
	>
	Write "		function newSession() { //CORE-70",!

	if 1 {
		; If the user has opened a page by right-clicking then the YUSER will be the same as the original window.  Here we
		; detect if there was a previous window and redirect to the same form but using a different YUSER.
		new YUSER
		set YUSER=""
		Write "			var YUSER",!
		Write "			if (window.opener!=undefined) {",! ;CORE-70.2
		write "             var idForm=document.getElementById('YFORM').value;" ;CORE-378
		write "			    if ((idForm!='WWWPARA')&&(idForm!='COMViewSearch')&&(idForm!='WWWCAL')&&(idForm!='WWWCAL2')&&('"_$g(YPOPUP)_"'!='1')) {"
		;		Need a better test here to determine if it is a popup window.
		Write "					var href=window.location.href;",!
		Write "					var YUSER=href.split('&YUSER=')[1].split('&')[0];",!
		;Write "				retval=EventValue('"_(YUCI)_"',YUSER,'"_(YFORM)_"','FIX','CreateChildUser^WWWUSER',YUSER,'6',YUSER);",!
		Write "					retval=EventValue('"_(YUCI)_"',YUSER,'"_(YFORM)_"','FIX','NewUser^WWWUSER',YUSER,6,YUSER);",!
		Write "					if (retval!='') {",!
		Write "						var href='"_$$$JSText((YAKTION_"&EP=WWWFORM&YFORM="_YFORM_$$WWWCGI2^WWWCGI()_"&YUSER="))_"'+retval;",! ;CORE-70.1
		write "						window.opener=null;"
		Write "						window.location.href=href;",!
		Write "					}",!
		Write "				}",!
		Write "			}",!
	}
	Write "		}	",!
	$$$EndScript()
	
	if $get(YMOUSETR)=1 do SCRIPT^WWWTRAIL   ;MOUSETRAIL START 
	set YTX=""
	if YFORM'="" set YTX=$piece($get(^WWW120(0,YFORM,1)),Y,92)  ;MANUELLER SCRIPT
	if +$get(^SysSetup("js debug"))'=0 do jsDebugFunction()
	if YTX'="" {
	;	IF YBEDBER=1 WRITE YCR,YCR,",<!-- ************************* EVENT BROKER (WWWFORM8)************************* -->",YCR,YCR
		for YLF=1:1 {
			quit:$piece(YTX,"|",YLF,999)=""
			
			write $piece(YTX,"|",YLF)
		}
	}
	
	; SR17086 vvvvvvvvvvvvvvvvvvvvvvvv
	do JS^WWWFORMHOTKEY()
	/*
	;+++++++++++++++++++++++++++++++++++++++
	;	YVOR			objWWW120
	;		D2				$$$WWW120FormType()
	;		D94				$$$WWW120DoNOTDisplayStandardButto()
	;+++++++++++++++++++++++++++++++++++++++
	
	; js : pruef()  : Check certain key presses - includes testing for disabled Standard Buttons
	;---------------------------------------
	;   Button         Key  wert
	;                   F5  (116)  Note : IE refresh overrides
	;                   F6  (117)  Note : Also performs IE operation (shift between frames and URL field)
	;  11 Prev Record   F7  (118)
	;  12 Next Record   F8  (119)
	;   9 Search        F9  (120)
	;   3 Save          F12 (123)  Note : Conflict with IE8
	;---------------------------------------
	;MIT DIESER FUNKTION RUF DIE FUNKTIONSTASTE F12 DEN SUBMIT AUF ;by means of this rumour who function key upon 
	;IF $GET(YNOEVENTKEY)'=1 DO  ;FIS;19.09.03;AUSSCHALTEN ONKEY-PRÜFUNG FÜR MANUELLE HTML-DATEIEN
	IF $GET(YNOEVENTKEY)'=1 IF $PIECE($GET(YVOR),Y,2)'=11 IF $PIECE($GET(YVOR),Y,2)'=9 DO  ;24502;FIS;20.04.04;NICHT BEI FORMULARARTEN EDIT TABLE/BITMAP
	. IF YFORM'="" IF $PIECE($GET(^WWW120(0,YFORM,1)),Y,134) = $$$YES QUIT   ; NO EVENTKEY - Form      ;BEC;26976;10.12.04
	. IF $PIECE($GET(^WWW012(0,0,1)),Y,169) = $$$YES                  QUIT   ; NO EVENTKEY - General   ;BEC;26976;10.12.04
	. ;
	. $$$StartScript("for=document event='onkeyup()'")
	. ;
	. ; SR17086
	. ;WRITE "if (navigator.appName.indexOf('Microsoft Internet Explorer') != -1)"  ;tybd;26,07,2004;26159;mozilla
	. WRITE "if (document.all)"                    ;bec;28,07,2004;26159;mozilla
	. WRITE "{"
	. WRITE " {pruef(window.event.keyCode)}"       ;bec;28,07,2004;26159;mozilla
	. WRITE "}"
	. WRITE " function pruef(wert)"
	. WRITE " { "
	. WRITE "  if (wert == 117) {window.history.back();}"
	. ;WRITE "    if (wert == 116) {document.WWW.YOPEN.value='SAVEHELP'; SAVENOW();}"
	. ;WRITE "    if (wert == 116) {document.WWW.YOPEN.value='SAVEHELP'; window.setTimeout('SAVENOW()',100);}"  ;FIS;25245;F12 SAVE ZU SCHNELL FÜR FIELDVALIDATION
	. WRITE "    if (wert == 116) { window.setTimeout('SAVENOW(""SAVEHELP"");',100); }"  // SR13195 - JW FIXME - this doesn't actually work. Refresh overrides it.
	. ;
	. IF $GET(YBEARB)'=4 IF ($$$WWW120AuthorizationToModifyData(YVOR)'=$$$EnumReadOnly) IF '$FIND(","_$TRANSLATE($PIECE($GET(YVOR),Y,94),";",",")_",",",3,") DO
	. .;WRITE "    if (wert == 123) {window.focus();document.WWW.YBUTTON.value='';document.WWW.YOPEN.value='0'; SAVENOW();}"  ;TYBD;4,2,2004;YBUTTON
	. . WRITE "    if (wert == 123) {window.focus();document.WWW.YBUTTON.value='';document.WWW.YOPEN.value='0'; window.setTimeout('SAVENOW()',100);}" QUIT  ;FIS;25245;F12 SAVE ZU SCHNELL FÜR FIELDVALIDATION
	. IF ($GET(YBEARB)=4) || ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) || ($FIND(","_$TRANSLATE($PIECE($GET(YVOR),Y,94),";",",")_",",",3,")) DO
	. . WRITE "    if (wert == 123) {window.alert(""F12 "_$$^WWWTEXT(144,,1)_"!"");}"   ; "Not Possible"   ; NICHT MÖGLICH
	. ;
	. IF YFORM'="" IF ($$$WWW120FormType($GET(YVOR))=1) || ($$$WWW120FormType($GET(YVOR))=3) DO
	. . ;IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",9,") WRITE "    if (wert == 120) {document.WWW.YOPEN.value=""SAVESEAR""; SAVENOW();}"
	. . ;IF $$$WWW120FormType($GET(YVOR))=1 DO
	. . ;. IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",12,") IF +$GET(YTIMEFORM)=0 WRITE "    if (wert == 118) {document.WWW.YRICHT1.value=""BACK"";document.WWW.YBUTTON.value='';document.WWW.YOPEN.value='0';SAVENOW();}"  ;TYBD,4,2,2004	
	. . ;. IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",11,") IF +$GET(YTIMEFORM)=0 WRITE "    if (wert == 119) {document.WWW.YRICHT1.value=""NEXT"";document.WWW.YBUTTON.value='';document.WWW.YOPEN.value='0';SAVENOW();}"  ;TYBD,4,2,2004	
	. . ;
	. . IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",9,") WRITE "    if (wert == 120) { ShowSearch(); }"		// COMView now always used.
	. . IF $$$WWW120FormType($GET(YVOR))=1 DO    ; Standard Form
	. . . IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",12,") IF +$GET(YTIMEFORM)=0 WRITE "    if (wert == 118) { window.location='" do DirectionURL^WWWFORMF("BACK") write "'; }"  ;TYBD,4,2,2004	
	. . . IF '$FIND(","_$TRANSLATE($PIECE(YVOR,Y,94),";",",")_",",",11,") IF +$GET(YTIMEFORM)=0 WRITE "    if (wert == 119) { window.location='" do DirectionURL^WWWFORMF("NEXT") write "'; }"  ;TYBD,4,2,2004	
	. ; 
	. WRITE " }"
	. ;WRITE "}"           ;BEC;28,07,2004;26159;mozilla
	. ;SR17253 $$$EndScript()
	
	
	. ;SR17253 ; js : keyEvent()
	. ;SR17253 ;---------------------------------------
	. ;SR17253 IF $GET(YNOEVENTKEY)'=1 IF $PIECE($GET(YVOR),Y,2)'=11 IF $PIECE($GET(YVOR),Y,2)'=9 DO   ;BEC;28,07,2004;26159;mozilla
	. ;SR17253 $$$StartScript()
	. WRITE " function keyEvent(e) {"
	. WRITE "   if (!(document.all)) {pruef(e.which)}"
	. WRITE "   return true;"
	. WRITE " }"
	. WRITE " document.onkeyup = keyEvent;" 
	. $$$EndScript()
	*/
	; SR17086 ^^^^^^^^^^^^^^^^^^^^^^^^^^

	; js : CSPstartClock()
	;---------------------------------------

	if +$get(YHYPER)=1 do                       ;TIMEOUT ;SR14969 VVV
	. new TIMEOUT,objWWW012,strHTM
	. set objWWW012 = $get(^WWW012(0,0,1))
	. $$$StartScript()				;CORE-70
	. write "var CSPEnding=false;"  ;CORE-70
	. $$$EndScript()				;CORE-70
	. if +$$$WWW012AutoEventRequestInBackgro(objWWW012)=1 quit  ;NO TIMEOUT;TYBD;14,11,2004
	. set TIMEOUT=$select($isobject(%session):%session.AppTimeout,1:900)
	. ;if TIMEOUT<900 set TIMEOUT=900
	. do 
	. . ;SR17790 This ensures that cache session hasn't timed out before Alphalinc timeout.
	. . ;set TIMEOUT=TIMEOUT-(1.5*$$$WWW012RequestEverySeconds(objWWW012))
	. . set TIMEOUT=TIMEOUT-10
	. $$$StartScript()
	. ; SR17790 vvvvvvv
	. write "var mycounter=0;"
	. ;
	. write "function CSPstartClock(timeout,towhere,whatdoc) { "
	. write " if(mycounter!=0) { clearTimeout(mycounter);}"
	. write " if(timeout==null) { timeout="_TIMEOUT_"}"
	. write " mycounter = setTimeout(function() { CSPCallLogout()}, (timeout*1000)); "
	. write "}"
	. write "function CSPLogout() {"
	. write " CSPEnding=true;"
	. write " var whatdoc='"_$select(+$$$WWW012RedirectToFullScreen(objWWW012):"top.",1:"")_"document.location.href';"
	. set strHTM=$$$WWW012RedirectToOnTimeout(objWWW012)
	. if strHTM="" set strHTM="BLANK.HTM"
	. if $extract($reverse(strHTM),1,3)="MTH" set strHTM=YGIF_"/"_strHTM
	. write " var towhere='"_strHTM_"';"
	. write " eval(whatdoc+'=""'+towhere+'""');"
	. write "}"
	. ;
	. write "CSPstartClock();"
	. write "function CSPCallLogout() {"
	. write "   CSPEnding=true;"
	. write "   top.window.returnValue='## timeout ##';"
	. write "   window.close();"
	. write "   window.setTimeout('CSPLogout()',1000);"
	. write "}"
	. ; SR17790 ^^^^^^
	. $$$EndScript()
	
	set YEVENT = $piece($get(^WWW012(0,0,1)),Y,82)  ;flag für eventbroker ; $$$WWW012EventBrokerOn()
	if YHTMFORM="WWW2" set YEVENT = $$$YES           ;IMMER EINGESCHALTET ;constantly 
	
	;+++++++++++++++++++++++++++++++++++++++
	;  Drop Through to EVENTCALL
	;+++++++++++++++++++++++++++++++++++++++
	
EVENTCALL  ;EINSPRUNG AUS WWWTABLE1 ;out of 
    ;-------------------------------------------------------------------------------
    ; History:
    ; 15-Jul-2014	shobby	HEVA-1565: MenuType should also consider WWW012
    ; 06-Jun-2014	shobby	CORE-385.13: Assume that we will always be using COMView
	; 31-Jul-2012	shobby	SR18075: Preserve SPRACHE in new field
    ; 16-Aug-2011	shobby	SR17784: getParent moved from COMGridEdit31JSort.
    ; 24-Aug-2010	shobby	SR17518: Corrected a problem with making fields readonly.
    ; 11-May-2010	shobby	SR17291: Another attempt at an update of UpdateFieldFormat
    ; 10-May-2010	shobby	SR17291: Reverted UpdateFieldFormat javascript function.
    ; 05-May-2010	GRF		SR17286: dot to brace with optimisation (if/else);
    ; 							activate SR17253 change
	; 28-Jul-2009	shobby	SR16751: Define the retval variable
    ; 23-Mar-2009	shobby	SR16427:	Subroutined setup of cspxmlhttp
    ; 31-May-2007	shobby	SRBR014409: Same thing for checkboxes
    ; 31-May-2007	shobby	SRBR014409: workaround to disable textarea controls
    ; 							because readOnly property doesn't seem to work.
    ; 14-May-2007	GRF		Check ^Development as macro not ^DEVELOPMENT
    ; 08-May-2007	RPW		SR15513: Rewrote the *Format routines to nicely start
    ; 							to handle the grid.
    ; 07-May-2007	RPW		SRBR014310: Fixed the boolean level javascript.
    ; 02-May-2007	GRF		SR15508: Make sure showing js errors doesn't cause an error.
    ; 27-Apr-2007	RPW		SRBR014310: Make the updating of fields totally client based
    ; 19-Dec-2006	JW		BR014262: Use EndScript. Was causing errors.
    ; 08-Dec-2006	PO		SR15276: Changed name of EventBroker to JSLibraries
    ; 24-Aug-2006	JW		SR14939: Translate for linux as well.
    ; 21-Aug-2006	FrankF	SRBR014066: Passing the page number to the server.
    ; 10-Aug-2006	JW		SR13594: Translate ` to '
	; 02-Jun-2006	JW		SR14697: Always use eventbrokeren1.js
    ; 22-Jul-2005	JW		SR12615: Added UpdateFieldFormat / ResetFieldFormat
    ; 31-Oct-2003	FIS		JavaScript Error Handlers
    ;-------------------------------------------------------------------------------
	
	$$$StartScript()
	
	if '$$$DEVMODE {
		write "window.onerror=eventfehler;"  ;JAVASCRIPT ERRORHANDLER (INTERNET EXPLORER)
		write "window.onError=eventfehler;"  ;JAVASCRIPT ERRORHANDLER (NETSCAPE)
	}
	
	write "function EventValue(Namespace,User,Form,Fixkey,Field,Value,Funct,LocalVar,Tab) {",YCR
	
	;---------------------------------------
	; FIXME : check validity of the following nesting
	;         YEVENT = 1
	;         		function EventValue() {
	;         			...  ; version 1
	;         			function UpdateFieldFormat, PrepareUpdate, ResetFieldFormat
	;         		}
	;         		
	;         YEVENT = 0
	;         		function EventValue() {
	;         			...  ; version 0
	;         		}
	;         		function UpdateFieldFormat, PrepareUpdate, ResetFieldFormat
	;
	;         should YEVENT = 0 case be an else with the other 3 functions also positioned
	;         outside the EventValue function?  <GRF>
	;---------------------------------------
	
	;======================================= vvv
	if $get(YEVENT)=1 {  ;FUNKTION FÜR EVENTBROKER ;to 
		write "  var retval;"
		if $find($zversion,"Windows") {               ;only for Windows, not for LINUX 
			write "  var von = /"_$char(128)_"/g;"
			write "  var nach = ""&euro;"";"        ; euro in eurozeichen umwandeln bei csp
			write "  if (Value != false) { if (Value != true) Value=Value.replace(von,nach);}"
		}
		if +$get(YHYPER)=0 {           ; eventbroker
			;SR18075 write "  retval = document.WebLink.CacheMethod("""_$get(%KEY("MGWCHD"))_""", Namespace + ""."" + User + ""."" + Form + ""."" + Field + ""."" + Funct + ""."" + Fixkey +""."" + LocalVar, Value);"
			write "  retval = document.WebLink.CacheMethod("""_$get(%KEY("MGWCHD"))_""", Namespace + ""."" + User + ""."" + Form + ""."" + Field + ""."" + Funct + ""."" + Fixkey + "".""  + """_SPRACHE_""" + ""."" + LocalVar, Value);"  ;SR18075 
		} elseif +$get(YHYPER)=1 {     ; HyperEvent
			;SR18075 write "  Para=Namespace + ""."" + User + ""."" + Form + ""."" + Field + ""."" + Funct + ""."" + Fixkey + ""."" + LocalVar +""."" ;"  ;SR18075
			write "  Para=Namespace + ""."" + User + ""."" + Form + ""."" + Field + ""."" + Funct + ""."" + Fixkey + ""."" + """_SPRACHE_""" +""."" + LocalVar  ;"  ;SR18075
			write "  retval = "_$get(%(YQUERY,"HYPER"))_";"  
		}
		write "  if (retval != null) { "
		write "    retval=retval.replace(/'/g,String.fromCharCode(10,13));"
		write "    retval=retval.replace(/`/g,'\'');"
		write "  } "
		
		write "  var htmform = '"_YHTMFORM_"';"
		write "  if (retval != null) retval=retvalcheck(retval,Value,Funct,Field,htmform);"
		write "  return(retval);"
		write "}"
	}
	
	;======================================= ^^^ vvv
	
	;; SR17253 vvv
	;write "function UpdateFieldFormat(pstrObject,pstrPropertyName,pstrValue) {"
	;write "   if (pstrValue=='true' || pstrValue=='false') {"
	;write "     pstrValue=pstrValue==""true""?true:false;"
	;write "   }"
	;write "   eval(pstrObject+'.'+pstrPropertyName+""='""+pstrValue+""'"");"
	;write "}"
		
	;SR17XXX	
	;write "window.CSSHover=(function(){var m=/(^|\s)((([^a]([^ ]+)?)|(a([^#.][^ ]+)+)):(hover|active|focus))/i;var n=/(.*?)\:(hover|active|focus)/i;var o=/[^:]+:([a-z\-]+).*/i;var p=/(\.([a-z0-9_\-]+):[a-z]+)|(:[a-z]+)/gi;var q=/\.([a-z0-9_\-]*on(hover|active|focus))/i;var s=/msie (5|6|7)/i;var t=/backcompat/i;var u={index:0,list:['text-kashida','text-kashida-space','text-justify'],get:function(){return this.list[(this.index++)%this.list.length]}};var v=function(c){return c.replace(/-(.)/mg,function(a,b){return b.toUpperCase()})};var w={elements:[],callbacks:{},init:function(){if(!s.test(navigator.userAgent)&&!t.test(window.document.compatMode)){return}var a=window.document.styleSheets,l=a.length;for(var i=0;i<l;i++){this.parseStylesheet(a[i])}},parseStylesheet:function(a){if(a.imports){try{var b=a.imports;var l=b.length;for(var i=0;i<l;i++){this.parseStylesheet(a.imports[i])}}catch(securityException){}}try{var c=a.rules;var r=c.length;for(var j=0;j<r;j++){this.parseCSSRule(c[j],a)}}catch(someException){}},parseCSSRule:function(a,b){var c=a.selectorText;if(m.test(c)){var d=a.style.cssText;var e=n.exec(c)[1];var f=c.replace(o,'on$1');var g=c.replace(p,'.$2'+f);var h=q.exec(g)[1];var i=e+h;if(!this.callbacks[i]){var j=u.get();var k=v(j);b.addRule(e,j+':expression(CSSHover(this, ""'+f+'"", ""'+h+'"", ""'+k+'""))');this.callbacks[i]=true}b.addRule(g,d)}},patch:function(a,b,c,d){try{var f=a.parentNode.currentStyle[d];a.style[d]=f}catch(e){a.runtimeStyle[d]=''}if(!a.csshover){a.csshover=[]}if(!a.csshover[c]){a.csshover[c]=true;var g=new CSSHoverElement(a,b,c);this.elements.push(g)}return b},unload:function(){try{var l=this.elements.length;for(var i=0;i<l;i++){this.elements[i].unload()}this.elements=[];this.callbacks={}}catch(e){}}};var x={onhover:{activator:'onmouseenter',deactivator:'onmouseleave'},onactive:{activator:'onmousedown',deactivator:'onmouseup'},onfocus:{activator:'onfocus',deactivator:'onblur'}};function CSSHoverElement(a,b,c){this.node=a;this.type=b;var d=new RegExp('(^|\\s)'+c+'(\\s|$)','g');this.activator=function(){a.className+=' '+c};this.deactivator=function(){a.className=a.className.replace(d,' ')};a.attachEvent(x[b].activator,this.activator);a.attachEvent(x[b].deactivator,this.deactivator)}CSSHoverElement.prototype={unload:function(){this.node.detachEvent(x[this.type].activator,this.activator);this.node.detachEvent(x[this.type].deactivator,this.deactivator);this.activator=null;this.deactivator=null;this.node=null;this.type=null}};window.attachEvent('onbeforeunload',function(){w.unload()});return function(a,b,c,d){if(a){return w.patch(a,b,c,d)}else{w.init()}}})();"
	
	;SR17784 vvvvvv
	write "function getParent(el, pTagName) {",YCR
	write " if (el == null) return null;",YCR
	write " else if (el.nodeType == 1 && el.tagName.toLowerCase() == pTagName.toLowerCase())"_" // Gecko bug, supposed to be uppercase",YCR
	write "  return el;",YCR
	write " else",YCR
	write "  return getParent(el.parentNode, pTagName);",YCR
	write "}",YCR
	;SR17784 ^^^^^^^
	
	; SR17291 rewrite vvvvvv
	write "function UpdateFieldFormat(pstrObject,pstrPropertyName,pstrValue) {"
	write "  var arrObject=pstrObject.split('.');"
	write "  var intLength=arrObject.length;"
	write "  var strObjectName=arrObject[intLength-1];"
	write "  var strType='';"
	write "  var strEval;"
	write "  if (strObjectName=='style') {"
	write "    strType=strObjectName;"
	write "    strObjectName=arrObject[intLength-2];"
	write "  }"
	write "  if (document.getElementById(strObjectName)) {"
	write "    strEval='document.getElementById(""'+strObjectName+'"")';"
	write "    if (strType!='') strEval=strEval+'.'+strType;"
	write "    strEval=strEval+'.'+pstrPropertyName;"
	write "    eval(strEval+""='""+pstrValue+""'"");"
	write "  }"
	write "}"	
	
	; SR17291 removed vvvvvv
	;write "function UpdateFieldFormat(pstrObject,pstrPropertyName,pstrValue) {"
	;write "  var arrObject=pstrObject.split('.');"
	;write "  var intLength=arrObject.length;"
	;write "  var strObjectName=arrObject[intLength-1];"
	;write "  var strType;"
	;write "  if (strObjectName=='style') {"
	;write "    strType=strObjectName;"
	;write "    strObjectName=arrObject[intLength-2];"
    ;write "  }"
	;write "  var strOldProperty=pstrPropertyName+'old';"
	;write "  var objCurrent = document.getElementById(strObjectName);"
	;write "  if (objCurrent) {"
	;write "    if (strType) {"
	;write "      objCurrent=objCurrent.getAttribute(strType);"
	;write "    };"
	;write "    if (objCurrent) {"
	;write "      if (objCurrent.getAttribute(strOldProperty)==null) {"
	;write "        objCurrent.setAttribute(strOldProperty,objCurrent.getAttribute(pstrPropertyName));"
	;write "      }"
	;write "      if (pstrValue=='true' || pstrValue=='false') {"
	;write "        pstrValue=pstrValue==""true""?true:false;"
	;write "      }"
	;write "      objCurrent.setAttribute(pstrPropertyName,pstrValue);"
	;write "      if (pstrValue=='white') {pstrValue=''} ;"
	;;	write "      eval(pstrObject+'.'+pstrPropertyName+""='""+pstrValue+""'"");"
	;write "    }"
	;write "  }"
	;write "}"
	   ; SR17253 ^^^
	
	;---------------------------------------
	
	write "function PrepareUpdate(pstrForm,pstrObjectName,pstrPropertyName,pstrValue) {"
	write "	 var objField=document.getElementById(pstrObjectName.split('.')[0]);"
	write "	 if (objField) {"
	write "	   if (pstrValue=='true' || pstrValue=='false') {"
	write "      eval(objField+'.'+pstrPropertyName+'='+pstrValue==""true""?true:false);"
	
	;  	**** Work Around IE bug.  Something happening where setting the readOnly property
	;        on a text area control oesn't seem to work
	write "      if (pstrPropertyName=='readOnly') {"
	write "        document.getElementById(objField.id).readOnly=(pstrValue==""true""?true:false);"  ;SR17518
	write "        if ((objField.type=='checkbox')||(objField.type=='select-one')) {"
	write "           objField.disabled=(pstrValue==""true""?true:false);"
	write "        } else if (objField.type=='textarea') {"
	write "           objField.readOnly=(pstrValue==""true""?true:false);"
	write "        }"
	write "      }"
	
	write "    } else {"
	; Why was the following commands put here?  It will give checkboxes a white halo.
	;write "      if (pstrPropertyName=='backgroundColor') {"
	;write "        if (pstrValue=='') {"
	;write "          pstrValue='white';"				;SR17291
	;write "        }"
	;write "      }"
	write "      UpdateFieldFormat('document.'+pstrForm+'.'+pstrObjectName,pstrPropertyName,pstrValue);"
	write "    }"
	write "  }"
	write "}"
	
	;write "function PrepareUpdate(pstrForm,pstrObjectName,pstrPropertyName,pstrValue) {"
	;write "  var objField=document.getElementById(pstrObjectName.split('.')[0]);"
	;write "  if (objField) {"
	;write "    if (pstrValue=='true' || pstrValue=='false') {"
	;write "      objField.setAttribute(pstrPropertyName,pstrValue==""true""?true:false);"
	;;             	**** Work Around IE bug.  Something happening where setting the readOnly property on a text area control
	;;             	Doesn't seem to work
	;write "      if (pstrPropertyName=='readOnly') {"
	;write "        if ((objField.type=='checkbox')||(objField.type=='select-one')) {"
	;write "          objField.setAttribute('disabled',pstrValue==""true""?true:false);"
	;write "        } else if (objField.type=='textarea') {"
	;write "          objField.setAttribute('readOnly',pstrValue==""true""?true:false);"
	;write "        }"
	;write "      }"
	;write "    } else {"
	;write "      UpdateFieldFormat('document.'+pstrForm+'.'+pstrObjectName,pstrPropertyName,pstrValue);"
	;write "    }"
	;write "  }"
	;write "}"
	
	;---------------------------------------
	
	;-------------------------------------------------------------------------------
	; Called by COMUtils with pstrObject = document."_YHTMFORM_"."_pstrObjectName
	; Other calls may differ.
	;-------------------------------------------------------------------------------
	write !!,"function ResetFieldFormat(pstrObject,pstrPropertyName) {"
	write "  var arrObject=pstrObject.split('.');"
	write "  var intLength=arrObject.length;"
	write "  var strObjectName=arrObject[intLength-1];"
	write "  var strType;"
	
	write "  if (strObjectName=='style') {"
	write "    strType=strObjectName;"
	write "    strObjectName=arrObject[intLength-2];"
    write "  }"
	
	write !,"  var strOldProperty=pstrPropertyName+'old';"
	write !,"  var objCurrent = document.getElementById(strObjectName);"
	write !,"  if (strType) {"
	write "    objCurrent=objCurrent.getAttribute(strType);"
	write "  };"
	
	write !,"  if (objCurrent) {"
	write "    if (objCurrent.getAttribute(strOldProperty)!=null) {"
	write "       objCurrent.setAttribute(pstrPropertyName,objCurrent.getAttribute(strOldProperty));"
	write "    }"
	write "  }"
	write "}",!!
	

	;write "function ResetFieldFormat(pstrObject,pstrPropertyName) {"
	;write "  if (eval('typeof '+pstrObject)!='undefined') { "
	;write "    var pstrPropertyName = pstrObject+'.'+pstrPropertyName; "
	;write "    var strOldProperty = pstrPropertyName+'old' ; "
	;write "    if (eval('typeof '+strOldProperty)!='undefined') { "
	;write "      eval(pstrPropertyName+' = '+strOldProperty);"
	;write "    } "
	;write "  } "
	;write "}"
	
	;======================================= ^^^ vvv
	
	; Function EventValue - alternative
	if $get(YEVENT)'=1 {  ;FUNKTION Kein EVENTBROKER   
		write "  retval = """";"
		write "  return(retval);"
		write "}"
	}
	
	;======================================= ^^^
	
	if YFORM="WWWCHAT" {
		write "function chat() {"
		write "  retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""Y"_YFORM_"M1"","""_1_""","""_2_""",""NOVALUE"");"
		write "  if (retval != """") document."_YHTMFORM_".Y"_YFORM_"M1.value = retval;"
		write "  window.setTimeout(""chat()"",10000);"
		write "}"
	}
	
	;JAVASCRIPT ERROR HANDLER
	write "function eventfehler(msg, url, line) {"
	if ($$$WWW012DisplayJavaScriptError($get(^WWW012(0,0,1)))=$$$YES) || (+$$^WWWBEDBER()=1) {
	;	write "  if (navigator.appName.indexOf('Microsoft Internet Explorer') != -1)"  ;tybd;26,07,2004;26159;mozilla
		write "  if (document.all) {" 
		write "    var code;"
	; INTERNAL ERROR - Make sure showing js errors doesn't cause an error.
		write "    code="""_$$^WWWTEXT(387)_""";"                  ; "An INTERNAL Error Has Occurred In Your Application."
		write "    code+=""\n\n("_$$^WWWTEXT(179)_": ""+line;"     ; "Line"
		write "    code+="") ""+msg;"
	;	write "    code+=""\n\nUrl:\n""+url;"
		write "    alert(code);"
		write "  }"
	}
	write "  return true;"
	write "}"
	
	$$$EndScript()
	
	;---------------------------------------
	
	quit:$get(YEINSPRUNG)=1
	
	if $$SR16427^WWWFORMJavascript() {
		write $$Cspxml^WWWFORMJavascript(YQUERY)
	
	} else {
		if $get(%(YQUERY,"XMLHTTPREQ"))=1 {
			write "<script type='text/javascript' src=""/csp/broker/cspxmlhttp.js""></script>"
		}
	}
	do JSLibraries()
	
	if $get(YHYPER)=1 {
		write "<SCRIPT LANGUAGE=JavaScript SRC=""/csp/broker/cspbroker.js""></SCRIPT>"
	}
	
	if '$get(YTIMEFORM) {  ;&& ($piece($get(^COMViewConfig(0,0,1)),Y,9)=1) ;CORE-385.13
		do Setup^COMViewSetup()
	}
	
	;---------------------------------------
	
	;IF YBEDBER=1 WRITE YCR,YCR,"<!-- ************************* JAVASCRIPT (WWWFORM8)************************* -->",YCR,YCR
	
	$$$StartScript()
	
	; Popup Menu - set at either the system or the user level
	;---------------------------------------
	; FIXME : are we unable to over-ride a system POPUP setting with some other user setting?
	
	if $$$WWW012MenuType($get(^WWW012(0,0,1)))=7 {   ; System setting
		write "function formHandler(form) {"
		write "  var URL = document.WWW.site.options[document.WWW.site.selectedIndex].value;"
		write "  if (URL != """") window.location.href = URL;"
		write "}"
		
	} elseif ($get(YBED)'="") && (+$$MenuType^WWW013()=7) {   ; User setting ;HEVA-1565
		;HEVA-1565 } elseif ($get(YBED)'="") && (+$$$WWW013MenuType($get(^WWW013(0,YBED,1)))=7) {   ; User setting
		write "function formHandler(form) {"
		write "  var URL = document.WWW.site.options[document.WWW.site.selectedIndex].value;"
		write "  if (URL != """") window.location.href = URL;"
		write "}"
	}
	
	if $get(YFORM)="" $$$EndScript() quit                             ; *** EARLY EXIT ***
	
	; JavaScript in Meta-data
	;---------------------------------------
	
	;FUNKTIONEN AUS DEN PRIMÄRSCHLÜSSELFELDERN ;out of 
	set YLF = ""
	for  set YLF = $order(^WWW129(0,YFORM,YLF)) quit:YLF=""  do
	. set YON=""
	. for  set YON = $order(^WWW129(0,YFORM,YLF,YON)) quit:YON=""  do
	. . set YFU=""
	. . for  set YFU = $order(^WWW129(0,YFORM,YLF,YON,YFU)) quit:YFU=""  do
	. . . set YTX = $piece($$^WWWSETL("^WWW129(0,"""_YFORM_""","""_YLF_""","""_YON_""","""_YFU_""",1)"),Y,1)
	. . . if $translate(YTX,"| ")'="" do
	. . . . write "function "_$piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_")"
	. . . . write " {"
	. . . . if $extract(YTX,1,3)="D ^" set YTX = $translate(YTX,"|") xecute YTX write "    }" quit
	. . . . for YI=1:1 set YTX1 = $piece(YTX,"|",YI) quit:$piece(YTX,"|",YI,99999)=""  do
	. . . . . quit:$translate(YTX1," ")=""
	. . . . . write "   "_$translate(YTX1,Y,";")
	. . . . ;
	. . . . write " }"

	;FUNKTIONEN AUS DEN DATENFELDER ;out of 
	set YLF = ""
	for  set YLF = $order(^WWW1291(0,YFORM,YLF)) quit:YLF=""  do
	. set YON = ""
	. for  set YON = $order(^WWW1291(0,YFORM,YLF,YON)) quit:YON=""  do
	. . set YFU = ""
	. . for  set YFU = $order(^WWW1291(0,YFORM,YLF]]><![CDATA[,YON,YFU)) quit:YFU=""  do
	. . . set YTX = $piece($$^WWWSETL("^WWW1291(0,"""_YFORM_""","""_YLF_""","""_YON_""","""_YFU_""",1)"),Y,1)
	. . . if $translate(YTX,"| ")'="" do
	. . . . write "function "_$piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_")"
	. . . . write " {"
	. . . . if $extract(YTX,1,3)="D ^" set YTX = $translate(YTX,"|"," ") xecute YTX write "    }" quit    ; if/else
	. . . . for YI=1:1 set YTX1 = $piece(YTX,"|",YI) quit:$piece(YTX,"|",YI,99999)=""  do
	. . . . . quit:$translate(YTX1," ")=""
	. . . . . write "  "_$translate(YTX1,Y,";")
	. . . . ;
	. . . . write " }"
	
	$$$EndScript()
	
	;---------------------------------------
	
	write "<SCRIPT LANGUAGE=VBScript>"
	write "<!--"
	
	;VB AUS PRIMÄRSCHLÜSSELN ;out of 
	set YLF = ""
	for  set YLF = $order(^WWW129(0,YFORM,YLF)) quit:YLF=""  do
	. set YON = ""
	. for  set YON = $order(^WWW129(0,YFORM,YLF,YON)) quit:YON=""  do
	. . set YFU = ""
	. . for  set YFU = $order(^WWW129(0,YFORM,YLF,YON,YFU)) quit:YFU=""  do
	. . . set YTX = $piece($$^WWWSETL("^WWW129(0,"""_YFORM_""","""_YLF_""","""_YON_""","""_YFU_""",1)"),Y,2)
	. . . if $translate(YTX,"| ")'="" do
	. . . . write " function "_$piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_")"
	. . . . if $extract(YTX,1,3)="D ^" set YTX = $translate(YTX,"|"," ") xecute YTX quit
	. . . . for YI=1:1 set YTX1 = $piece(YTX,"|",YI) quit:$piece(YTX,"|",YI,99999)=""  do
	. . . . . quit:$translate(YTX1," ")=""
	. . . . . write " "_$translate(YTX1,Y,";")
	
	;VB AUS DATENFELDERN ;out of 
	set YLF = ""
	for  set YLF = $order(^WWW1291(0,YFORM,YLF)) quit:YLF=""  do
	. set YON = ""
	. for  set YON = $order(^WWW1291(0,YFORM,YLF,YON)) quit:YON=""  do
	. . set YFU = ""
	. . for  set YFU = $order(^WWW1291(0,YFORM,YLF,YON,YFU)) quit:YFU=""  do
	. . . set YTX = $piece($$^WWWSETL("^WWW1291(0,"""_YFORM_""","""_YLF_""","""_YON_""","""_YFU_""",1)"),Y,2)
	. . . if $translate(YTX,"| ")'="" do
	. . . . write " function "_$piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_")"
	. . . . if $extract(YTX,1,3)="D ^" set YTX = $translate(YTX,"|"," ") xecute YTX quit
	. . . . for YI=1:1 set YTX1 = $piece(YTX,"|",YI) quit:$piece(YTX,"|",YI,99999)=""  do
	. . . . . quit:$translate(YTX1," ")=""
	. . . . . write "  "_$translate(YTX1,Y,";")
	
	write "//-->"
	write "</SCRIPT>"
	
	quit
		
	
JSLibraries()
	;-------------------------------------------------------------------------------
	; Encapsulate EventBroker Call
	;
	; Params:
	;
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 02-Aug-2010	shobby	SR17481: gradient.js redundant.
	; 21-Apr-2010	shobby	SR17253: Some support for cross browser color transition.
	; 08-Dec-2006	PO		SR15276: Renamed function to JSLibaries, was EventBroker.
	; 							Added commonfunctions.js
	; 02-Jun-2006	JW		SR14697: Created
	;-------------------------------------------------------------------------------
	if ($get(YHYPER)=0) || ($get(YHYPER)=1) { // Don't believe YHYPER is anything other than 0 or 1, so will not need this check
		write "<SCRIPT type='text/javascript' SRC="""_YGIF_"eventbrokeren1.js""></SCRIPT>",!
		write "<script type='text/javascript' src='"_YGIF_"commonfunctions.js'></script>",!
		;SR17481 write "<script type='text/javascript' src='"_YGIF_"gradient.js'></script>",!     ; SR17253
	}
	quit
	
	
JAVA ;FUNKTIONSAUFRUFE DER EINZELFELDER ;the  
    ;-------------------------------------------------------------------------------
    ; History:
    ;  9-Dec-2005	JW		SR13195: Don't call BEARB here.
    ; 16-Aug-2005	JW		SR12290: Added check for readonly
    ;-------------------------------------------------------------------------------
	new BEARB
	
	if YBBN="" set YBBN=YLFN
	quit:$$$WWW120StandardSubmit(YVOR)'=""		// This is only used for form WWWBARCODE
	
	if YART="D" || (YART="M") {
		set YON = "" 
		for {
			set YON = $order(^WWW1291(0,YFORM,YBBN,YON))
			quit:YON=""
			
			set YFU = ""
			for {
				set YFU = $order(^WWW1291(0,YFORM,YBBN,YON,YFU))
				quit:YFU=""
 
				write " "_$$$WWW100Text($get(^WWW100(0,"EVENT",SPRACHE,YON,1)))_"='"
				write $piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_");'"
			}
		}
		
	} elseif YART="P" {
		set YON = "" 
		for {
			set YON = $order(^WWW129(0,YFORM,YBBN,YON))
			quit:YON=""
			
			set YFU = ""
			for {
				set YFU = $order(^WWW129(0,YFORM,YBBN,YON,YFU))
				quit:YFU=""
				
				write " "_$$$WWW100Text($get(^WWW100(0,"EVENT",SPRACHE,YON,1)))_"='"
				write $piece(YFU,".",1)_"("_$translate($piece(YFU,".",2,99),".",",")_");'"
			}
		}
	}
	
	quit
	
	
PIECE ;$P
	;IF YBEDBER=1 WRITE YCR,YCR,"<!-- ************************* DATUMSPRÜFUNG (WWWFORM8)************************* -->",YCR,YCR
	write "<SCRIPT LANGUAGE=JavaScript>"
	write "<!--"
	
	write " function piece(txt,tr,nr)"
	write "  {"
	write "   txt = txt + tr;"
	write "   var array = txt.split(tr);"
	write "   fpiece=array[nr-1];"
	write "   if (!(fpiece)) return('');"
	write "   return(fpiece);"
	write " }"
	
	write "//-->"
	write "</SCRIPT>"
	quit
	
DATE
	write "<SCRIPT LANGUAGE=JavaScript>"
	if SPRACHE="DE" do
	. write "<!--"
	. write "  function checkdate1(input)"
	. write "    {"
	. write "      dd = piece(input,""."",1);"
	. write "      mm = piece(input,""."",2);"
	. write "      yy = piece(input,""."",3);"
	. write "      if (dd.length > 2 || !dd.length) return false;"
	. write "      if (mm.length > 2 || !mm.length) return false;"
	. write "      if (yy.length > 4 || !yy.length) return false;"
	. write "      if (yy.length < 2 || !yy.length) return false;"
	. write "      if (dd>31) return false;"
	. write "      if (mm>12) return false;"
	. write "      if (mm==2 && dd>29) return false;"
	. write "      if (dd==31 && ((mm==4) || (mm==6) || (mm==9) || (mm==11))) return false;"
	. write "      datum = new Date(yy,mm-1,dd);"
	. write "      return true;"
	. write " }"
	
	if SPRACHE'="DE" do
	. write "<!--"
	. write "  function checkdate1(input)"
	. write "    {"
	. write "      dd = piece(input,""/"",2);"
	. write "      mm = piece(input,""/"",1);"
	. write "      yy = piece(input,""/"",3);"
	. write "      if (dd.length > 2 || !dd.length) return false;"
	. write "      if (mm.length > 2 || !mm.length) return false;"
	. write "      if (yy.length > 4 || !yy.length) return false;"
	. write "      if (yy.length < 2 || !yy.length) return false;"
	. write "      if (dd>31) return false;"
	. write "      if (mm>12) return false;"
	. write "      if (mm==2 && dd>29) return false;"
	. write "      if (dd==31 && ((mm==4) || (mm==6) || (mm==9) || (mm==11))) return false;"
	. write "      datum = new Date(yy,mm-1,dd);"
	. write "      return true;"
	. write " }"
	
	; FIXME : Base on date format, not language
	write "function checkdate(input)"
	write "{"
	write "             OK = true;"
	write "             heute = new Date();"
	write "             if (input == """") return input;"
	if SPRACHE="DE" do
	. write "             if (input == ""."" || input== "","" )"
	. write "                           input=heute.getDate() + ""."" + (heute.getMonth()+1) + ""."" + heute.getYear();"
	. write "             if (piece(input,""."",2)=="""")"
	. write "                            input=piece(input,""."",1)+"".""+(heute.getMonth()+1);"
	. write "             if (piece(input,""."",3)=="""")"
	. write "                            input=piece(input,""."",1)+"".""+piece(input,""."",2)+"".""+(heute.getYear());"
	
	if SPRACHE'="DE" do
	. write "             if (input == ""."")"
	. write "                           input=(heute.getMonth()+1) + ""/"" + heute.getDate() + ""/"" + heute.getYear();"
	. write "             if (piece(input,""/"",2)=="""")"
	. write "                            input=+(heute.getMonth()+1)+""/""+piece(input,""/"",1);"
	. write "             if (piece(input,""/"",3)=="""")"
	. write "                            input=piece(input,""/"",1)+""/""+piece(input,""/"",2)+""/""+(heute.getYear());"
	
	write "             OK = checkdate1(input);"
	write "             if (!OK) alert("""_$$^WWWTEXT(272)_" (""+input+"")"");"        ; "Wrong Date Format"
	write "             return input;"
	write "    }"
	write "//-->"
	write "</SCRIPT>"
	quit
	
VISABLE ;UNTESCHIEDLICHE HELLIGKEITEN
	write "<SCRIPT LANGUAGE=JavaScript>"
	do
	. write "  function makevisible(cur,which)"
	. write "    {"
	. write "      if (which==0)"
	. write "      cur.filters.alpha.opacity=100"
	. write "      else "
	. write "      cur.filters.alpha.opacity=60"
	. write " }"
	
	write "</SCRIPT>"
	;in den forms: ;within 
	;I +$P(YVOR,Y,45)=1 W YCR,"<IMG SRC="""_YGIF_"new.gif"" style=""filter:alpha(opacity=80)"" onMouseover=""makevisible(this,0)""onMouseout=""makevisible(this,1)"" "_YHEIGHT_" "_YWIDTH_" ALT="""_$$^WWWTEXT(130)_""" border=0></A>"
	quit
	
	
HYPER ; STARTEN MANUELLE HYPEREVENT FÜR FORMS
	set %KEY("XMLHTTPREQ") = 1
	set %KEY("HYPER") = ##class(User.www).HyperEventCall("User.www.HyperEvent","Para,Value",0)
	set YHYPEREVENT   = %KEY("HYPER")
	set YXMLHTTPREQ   = %KEY("XMLHTTPREQ")
	quit
	
	
jsDebugFunction()
    ;-------------------------------------------------------------------------------
    ; javascript debug function used to call function actual function that writes content into debug frame.
    ;
    ; Note: This could all be made part of the debugMsg macro.
    ;
    ; Returns: Nothing
    ;
    ; History:
    ; 23-Jun-2005	PO		Created SR12765
    ;-------------------------------------------------------------------------------
    $$$StartScript()
	write "function debugMsg(strDebugMessage) {"
	write "if (document.frames && typeof(document.frames.top)=='object' && typeof(document.frames.top.writeDebugMessage)=='function' && typeof(strDebugMessage)=='string') {"
	write "document.frames.top.writeDebugMessage(strDebugMessage);"
 
	write "}"
	write "}"
	$$$EndScript()
	quit
	
	
JSMaskFunction()
    ;-------------------------------------------------------------------------------
    ; Javascript masking function, parses the mask and applies it to the field
    ; Chars out of range are removed (controls, special chars, symbols..)
    ; Chars valid but not compliant to Mask, are ignored
    ; Follows a subset of Cache Pattern Match Syntax
    ; <number of occurrences><code>
    ; <number of occurrences>"<string>"
    ; 
    ; code: 
    ; A(characters)          : "A-ZÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇa-záàãâéèêíìîóòõôúùûç"
	; N(numbers)             : "0-9"
	; E(characters & numbers): "A-ZÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇa-záàãâéèêíìîóòõôúùûç0-9"
	; <string> between ""    : any characters
    ; 
    ; Returns: Nothing
    ;
    ; History:
		; 01-Abr-2019	Julio 	Alteração metodo busca Data | Jquery Datepicker
		; 30-Mar-2009	shobby	SR16459: SRBR014794 code restoration from SES/DEV merge
    ; 07-Apr-2008	heber	SRBR014794b: Fied mask algorithm
    ; 04-Jan-2008	heber	SRBR014794: Changed doMasking, field value comparison
    ; 							not here anymore 
    ; 27-Jul-2007	HeberB	SRBR014502: Fixed if = clauses; Fixed wrong JS substr; 
    ; 							Applied coding standards to JS var names;
    ; 							Changed from 334008 to WWW00074
    ; 12-Jul-2007	HeberB	SRBR014502:Created 
    ;-------------------------------------------------------------------------------

	; Jquery Datepicker
	&html<
	    <link href="#(YGIF)#global/plugins/alerts/messagebox.css" rel="stylesheet" type="text/css">
	>
	$$$StartScript("src='"_YGIF_"js/jquery-1.8.3.min.js'") $$$EndScript()
	$$$StartScript("src='"_YGIF_"global/plugins/alerts/jquery-1.11.2.min.js'") $$$EndScript()
	$$$StartScript("src='"_YGIF_"js/datepicker-pt-BR.js'") $$$EndScript()
	$$$StartScript("src='"_YGIF_"global/plugins/alerts/messagebox.js'") $$$EndScript()
	$$$StartScript()
		write "$(document).ready(function() {"
			write "$.datepicker.setDefaults(regional);"
			write "$("_$char(34)_"[type*='NewDate']"_$char(34)_").datepicker({"
				write "dateFormat: 'dd-mm-yyyy',"
				write "beforeShow: function(campoData) { "
					write "if ($(campoData).attr('readonly')) { return false; }"
				write "},"
				write "onClose: function(dataSelecionada, campoData){"
					write "dataSelecionada = dataSelecionada.substring(0, 10); idCampo = campoData.id;"
					write "$('#'+idCampo).val(dataSelecionada).blur();"
				write "}"
			write "});"	
		write "});"

	write "function applyMask(_m,_v) {"
	write "	 var strValue = _v, strMask = _m;"
	write "	 var loop, loop2, loop3, strNumberToken, strStringToken, intState, blnError;"
	write "	 var strRule = ""ANE"", arrRuleTest = [], arrMaskTable = [],"
	write "	     arrRegexDef = {""A"": ""A-ZÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇa-záàãâéèêíìîóòõôúùûç"", ""N"": ""0-9"", ""E"": ""A-ZÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇa-záàãâéèêíìîóòõôúùûç0-9"" },"
	write "	 	strNewValue = """", blnIsRule , strMaskChar, intValueBegin = 0, intMaskTableSize = 0;"
	
	write "	 strValue = strValue.replace(new RegExp(""[^"" + arrRegexDef[""E""] + ""]"", ""gi""), """");"
	write "	 intState = 1;"
	write "	 blnError = 0;"
	write "	 for(loop=0; loop < strMask.length; loop++ ){"
	write "	 	strMaskChar = strMask.charAt(loop);"
	write "	 	switch(intState) {"
	write "			case 1:"
	write "				  if ((strMaskChar >= ""0"")&&(strMaskChar <= ""9"")) {"
	write "					strNumberToken = strMaskChar;"
	write "					intState = 2;"
	write "				  } else {"
	write "					blnError =1;"
	write "				  }"
	write "				break;"
	
	write "			case 2:"
	write "				if ((strMaskChar >= ""0"")&&(strMaskChar <= ""9"")) {"
	write "					strNumberToken += strMaskChar;"
	write "				} else {"
	write "					if (strRule.indexOf(strMaskChar) > -1) {"
	write "						intState = 1;"
	write "						for(loop2=0;loop2<strNumberToken;loop2++) {"
	write "							arrRuleTest[arrRuleTest.length] = ""["" + arrRegexDef[strMaskChar] + ""]"";"
	write "							arrMaskTable[arrMaskTable.length] = { ""chr"": strMaskChar, ""mask"": 1 };"
	write "						}"
	write "					} else { "
	write "					    if (strMaskChar == '""') {"
	write "							strStringToken = '';"
	write "							intState = 4;"
	write "						} else {"
	write "							blnError =1;"
	write "						}"
	write "					}"
	write "				}"
	write "				break;"
	
	write "			case 3:"
	write "				if (strMaskChar == '""') {"
	write "					intState = 1;"
	write "					for(loop2=0;loop2<strNumberToken;loop2++) {"
	write "						for (loop3=0;loop3<strStringToken.length;loop3++) {"
	write "							arrMaskTable[arrMaskTable.length] = { ""chr"": strStringToken.substring(loop3,loop3+1), ""mask"": 0 };"
	write "							arrRuleTest[arrRuleTest.length] = ""["" + arrRegexDef[strMaskChar] + ""]"";"
	write "						}"
	write "					}"
	write "				} else {"
	write "					strStringToken += strMaskChar;"
	write "				}"
	write "				break;"
	
	write "			case 4:"
	write "				strStringToken = strMaskChar;"
	write "				intState = 3;"
	write "				break;"
	write "		}"
	write "		if (blnError==1) {"
	write "			loop=99999;"
	write "		}"
	write "	 }"
	write "	 strNewValue = """";"
	write "	 intValueBegin = 0;"
	write "	 if (blnError==1) {"
	write "	 	alert("""_$$^WWWTEXT("WWW00074")_""");"              ; "Invalid Mask"
	write "	 	strNewValue = strValue;"
	write "	 } else {"
	write "		 if( strValue.length > 0) {"
	write "			loop=0;"
	write "			while(loop < arrMaskTable.length){"
	write "				if( arrMaskTable[loop].mask ){"
	write "					while( strValue.length > 0 && !(new RegExp(arrRuleTest[loop])).test(strValue.charAt(intValueBegin)) ) strValue = (strValue.length == 1) ? '' : strValue.substring(1);"
	write "					if( strValue.length > 0 ){"
	write "						strNewValue += strValue.charAt(intValueBegin);"
	write "						loop++;"
	write "						intValueBegin++;"
	write "					}"
	write "				} else {"
	write "					strNewValue += arrMaskTable[loop].chr;"
	write "					if( strValue.charAt(intValueBegin)==arrMaskTable[loop].chr ){"
	write "						intValueBegin++;"
	write "					}"
	write "					loop++;"
	write "				}"
	write "				if (intValueBegin > strValue.length) break;"
	write "				if (strValue.length == 0) break;"	
	write "			}"
	write "		 }"
	write "	}"
	write "	return strNewValue;"
	write "}"
	
	write "function doMasking(pstrMask, pstrThisValue, pintEventKeyCode) {"
	write "		var strResult;"
	write "		strResult = pstrThisValue;"
	write "		if (pstrMask != '') {"
	write "			if (pintEventKeyCode > 47) {"
	write "     			strResult = applyMask(pstrMask,pstrThisValue);"
	write "			}" 
	write "		}" 
	write "		return strResult;" 
	write "}" 
	
	$$$EndScript()
 	quit
	
	;********************************************************
	
ApplyMask(pstrValue, pstrMask)
    ;-------------------------------------------------------------------------------
    ; Cache equivalent of ApplyMask Javascript masking function above
    ; 
    ; Returns: strValue after mask applied
    ;
    ; History:
    ; 13-Apr-2008	HeberB	SRBR014932: Created based on JSMaskingFunction
    ;-------------------------------------------------------------------------------
	new arrRuleTest,arrMaskTable,arrRegexDef,blnError,blnIsRule,intArrMaskTableLength
	new intArrRuleTestLength,intMaskLength,intState,intStringTokenLength,intValueBegin
	new loop,loop2,loop3,strMaskChar,strNewValue,strNumberToken,strRule,strStringToken
	
	quit:(pstrMask = "") pstrValue
	
	set strRule = "ANE"
	set arrRegexDef("A") = "ABCDEFGHIJKLMNOPQRSTUVXYWZÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇabcdefghijklmnopqrstuvxywzáàãâéèêíìîóòõôúùûç"
	set arrRegexDef("N") = "0123456789"
	set arrRegexDef("E") = arrRegexDef("A") _ arrRegexDef("N")
	
	set strNewValue   = ""
	set intValueBegin = 0
	
	set intArrRuleTestLength  = 0
	set intArrMaskTableLength = 0
	
	set intState = 1
	set blnError = $$$NO
 
	set intMaskLength = $length(pstrMask)
	
	for loop=1:1:intMaskLength {
		set strMaskChar = $extract(pstrMask,loop)
		if (intState = 1) {
			if ($isvalidnum(strMaskChar)) {
				set strNumberToken = strMaskChar
				set intState = 2
			} else {
				set blnError = $$$YES
			}
		
		} elseif (intState = 2) {
			if ($isvalidnum(strMaskChar)) {
				set strNumberToken = strNumberToken _ strMaskChar
			} else {
				if ($find(strRule,strMaskChar)) {
					set intState = 1
					for loop2=1:1:strNumberToken {
						set intArrRuleTestLength = intArrRuleTestLength + 1
						set arrRuleTest(intArrRuleTestLength) = arrRegexDef(strMaskChar)
						
						set intArrMaskTableLength = intArrMaskTableLength + 1
						set arrMaskTable(intArrMaskTableLength, "chr" ) = strMaskChar
						set arrMaskTable(intArrMaskTableLength, "mask" )  = 1 
						
					}
				} else { 
					if (strMaskChar = """") {
						set strStringToken = ""
						set intState = 4
					} else {
						set blnError = $$$YES
					}
				}
			}
		
		} elseif (intState = 3) {
			if (strMaskChar = """") {
				set intState = 1
				set intStringTokenLength = $length(strStringToken)
				for loop2=1:1:strNumberToken {
					for loop3=1:1:intStringTokenLength {
						set intArrMaskTableLength = intArrMaskTableLength + 1
						set arrMaskTable(intArrMaskTableLength, "chr") = $extract(strStringToken,loop3)
						set arrMaskTable(intArrMaskTableLength, "mask") = 0
						
						set intArrRuleTestLength = intArrRuleTestLength + 1
						set arrRuleTest(intArrRuleTestLength) = ""
						
					}
				}
			} else {
				set strStringToken = strStringToken _ strMaskChar
			}
		
		} elseif (intState = 4) {
			set strStringToken = strMaskChar
			set intState = 3
		}
		
		if (blnError=$$$YES) {
			set loop = 99999
		}
	}
	set strNewValue = ""
	set intValueBegin = 1
	if (blnError=$$$YES) {
	 	quit pstrValue                       ; *** EARLY EXIT ***
	} 
		 
	quit:($length(pstrValue)<=0) pstrValue
		
	for loop=1:1:intArrMaskTableLength {
		if (arrMaskTable(loop,"mask") = 1 ) {
			while( ($length(pstrValue) > 0) && '( $find( arrRuleTest(loop),$extract(pstrValue,intValueBegin)) ) ) {
				set pstrValue = $select( ($length(pstrValue) = 0):"",1:$extract(pstrValue,2,999))
			}
			if ( $length(pstrValue) > 0 ) {
				set strNewValue = strNewValue _ $extract(pstrValue,intValueBegin)
				set intValueBegin = intValueBegin + 1
			}
		} else {
			set strNewValue = strNewValue _ arrMaskTable(loop,"chr")
			if ( $extract(pstrValue,intValueBegin) = arrMaskTable(loop,"chr") ) {
				set intValueBegin = intValueBegin + 1
			}
		}
	
		if (intValueBegin > $length(pstrValue)) quit
		if ($length(pstrValue) = 0) quit
	}
	quit strNewValue
	
 
ApplyCoreMasking(pintRow,pYFORM,&pYFELD)
	;
	; FIXME : Doesn't permit a custom mask if no core mask exists - See CheckRules^WWWEVENT as well though for custom masks
	;         ? May be generated separately as part of Core Rules & Custom Rules ?
	;-------------------------------------------------------------------------------
	; Apply core masking to grid fields.
	;
	; Params:
	; pintRow: selected Row number 
	; pYFORM : form id.
	; pYFELD:  data contents.
	;
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 28-May-2009	shobby	SR16534:	Replaced repeated code with a common routine.
	; 13-Apr-2008	heber	SRBR014932: Created
	;-------------------------------------------------------------------------------
	new idField,idSeqNumber,objWWW122,strMask

 	// Applies core mask to each form field 
 	// if there is not a customized mask
 	set idField = ""
 	for {
	 	set idField = $order(^WWW122(0,pYFORM,idField))
	 	quit:idField=""
 		
	;SR17701 set objWWW122=$get(^WWW122(0,pYFORM,idField,1))
		set objWWW122 = $$Get^WWW122(pYFORM,idField)                 ;SR17701
 		continue:($$$WWW122Mask(objWWW122) = "")  ; no core mask to be applied to the field
 												  ; SR17701 ... or customisation mask.
		
 		; if no custom mask is defined, apply core mask (SR17701 Actually if no 'rules')
 		if ('$$IsMaskable(pYFORM,idField,YM)) {	; check if there is a custom mask
	 		set idSeqNumber = $$$WWW122SequenceNumber(objWWW122)
	;SR17701 set strMask    = $$GetCoreMask^WWWFORM7(pYFELD,"",objWWW122)
	 		set strMask     = $$$WWW122Mask(objWWW122)               ;SR17701
			set $piece(pYFELD,Y,idSeqNumber) = $$ApplyMask^WWWFORM8($piece(pYFELD,Y,idSeqNumber),strMask)
 		}
 	}
	quit
	
	
JSInitializingMasking(pstrYFELD,pidYFORM)
    ;-------------------------------------------------------------------------------
    ; Create and load initial mask variables using javascript.
    ; If a field can eventually be maskable, the mask variable is created.
    ; 
    ; Parameters: 
    ; 
    ; Returns: 
    ;
    ; History:
    ; 15-Apr-2011	shobby	SR17701: Use $$Get^WWW122 to include customisation.
    ; 22-Oct-2010	GRF		SR17514: Incorrect parentheses placement in IF test
	; 28-May-2009	shobby	SR16534: Replaced repeated code with a common routine.
    ; 30-May-2008	heber	SRBR014945: enable date masking on manual forms
    ; 22-Jan-2008	heber	SRBR014794: test whether general date masking is to be
    ; 							applied, get obj WWW012
    ; 21-Jan-2008	GRF		SRBR014794:date issue; newed variables
    ; 04-Jan-2008	HeberB	SRBR014794:Created 
    ;-------------------------------------------------------------------------------
	new blnHidden,blnMandatory,blnReadOnly,blnToMask,blnUseValueOfDataField
	new idClass,idData,idYBBN,ind,intColour,objWWW003,objWWW012,objWWW122
 	new strChar,strDate,strDateMask,strJSMaskedFieldName,strMask
 	new strNewFieldColor,strRelationClass,strRelationKeys,strRuleField
	
	set objWWW012 = $get(^WWW012(0,0,1))
	
 	; Use this temp global to hold which fields are maskable. Later is
 	; used to include call to doMasking javascript function on OnKeyUp event
	kill ^CacheTempMasking(YUSER,YUCI,pidYFORM)
	
	set intColour = ""
	set idClass = $$$WWW120ClassUsedInForm($get(^WWW120(0,pidYFORM,1)))
	$$$StartScript() 
	set idYBBN = ""

	for {
		set idYBBN = $order(^WWW122(0,pidYFORM,idYBBN))
		quit:idYBBN=""
	
		set ^CacheTempMasking(YUSER,YUCI,pidYFORM,idYBBN)= $$$NO
		
		;-----------------------------------
		;  Only mask...
		;    "D" fields		if Text or Date type
		;    "M" fields     if Text or Date type
		;-----------------------------------
		set objWWW003 = ""
	; SR17701 set objWWW122 = $get(^WWW122(0,pidYFORM,idYBBN,1))
		set objWWW122=$$Get^WWW122(pidYFORM,idYBBN)		;SR17701
		set blnToMask = $$$NO
		set idData    = $$$WWW122SequenceNumber(objWWW122)
		
		if (idData '= "") {
			set objWWW003 = $get(^WWW003(0,idClass,idData,1))
			set blnToMask = $$$IsToMask("D",$$$WWW003InputType(objWWW003))
		
		} else {
			set blnToMask = ($$$WWW122DataInputType(objWWW122) = 1)
			; apply mask also if date or text manual field
			if 'blnToMask && ($$$WWW122InputType(objWWW122) '= "") {
				set blnToMask = (($$$WWW122InputType(objWWW122) = 1) || ($$$WWW122InputType(objWWW122) = 6))
			}
		}
		continue:'(blnToMask)
		
		;-----------------------------------
		
 		; A field is maskable if is date type or has fields WWW122Mask or WWW122D2ApplyMask filled
		
		;-----------------------------------
 		; Check if masked on form : WWW122
		;-----------------------------------
 		set strMask   = ""
	;SR17701 set blnToMask = $$$NO
		
		set strMask   = $$$WWW122Mask(objWWW122)      ;SR17701
		set blnToMask = (strMask'="")                 ;SR17701 
	;SR17701 if ($$$WWW122Mask(objWWW122) '= "") {
	;SR17701 ; 2nd parameter blank since this is initial form loading, so there
	;SR17701 ; is no values on manual fields....except if default loading
	;SR17701 set strMask   = $$GetCoreMask^WWWFORM7(pstrYFELD,"",objWWW122)	
	;SR17701 set blnToMask = $$$YES
	;SR17701 }
 
		; Get 'rules' mask ;SR17701 
		if ($$IsMaskable(pidYFORM,idYBBN,YM)) {
			set strMask = "" 
			do CheckRules^WWWFORMD(pidYFORM,idYBBN,.pstrYFELD,.blnHidden,.blnReadOnly,
		                   	.intColour,.blnMandatory,$$$YES,.strNewFieldColor,.strRelationClass,
						 	.strRelationKeys,.blnUseValueOfDataField,.strRuleField,.strMask)
			set blnToMask = $$$YES
		}
 		
		;-----------------------------------
		;  1. Do we have an explicit mask for DATE data?
		;       - use specified mask.
		;  2. If not, is the Apply General Date Masking switch set?
		;       - will apply a mask based on the user's literal format.
		;  3. If still not,
		;       - interpret special codes such as "." for today, "+int" and "-int"
		;         and the ability to skip leading zeros in the day or month or the
		;         ability to enter a two digit date.  (e.g. 1/5/08 => 01/05/2008)
		;-----------------------------------
		; testing date mask on manual forms
	;	if (('blnToMask) && ($$$WWW003InputType(objWWW003) = 1)) {	
	;	if (('blnToMask) && ( ($$$WWW003InputType(objWWW003) = 1))||($$$WWW122InputType(objWWW122) = 1) ) {  ; SR17514
		if 'blnToMask &&
		   (($$$WWW003InputType(objWWW003) = 1) || ($$$WWW122InputType(objWWW122) = 1)) {
			
			if ($$$WWW012ApplyGeneralDateMasking(objWWW012)) {
				set blnToMask = $$$YES
				set strMask = $$GetDateMask()
			}
		}
 		
		// If a defined mask was found
		if blnToMask {
	 		set strJSMaskedFieldName = $$GetMaskVarName(pidYFORM, idYBBN)
 			; if there field is maskable, its var mask must be declared, even if current mask is empty
	 		write "var "_strJSMaskedFieldName_";"	
			write strJSMaskedFieldName_" = """_$zconvert(strMask,"O","JS")_""";"
		; hold field information to later use - include call to do masking onKeyUp
			set ^CacheTempMasking(YUSER,YUCI,pidYFORM,idYBBN)= $$$YES
		}
	}
	
 	$$$EndScript()
	quit 
	
	
IsMaskable(pYFORM,pidField,pYM)
	;-------------------------------------------------------------------------------
	; Replaced repeated code with a common routine.
	;
	; Params:
	;
	; Returns:
	;
	; History:
	; 28-May-2009	shobby	SR16534: Created
	;-------------------------------------------------------------------------------
	new arrRules,blnMaskable,idRule,objRule
	
	do GetRules^WWWFORMD(.arrRules,pYFORM,pidField,pYM)
	set blnMaskable = $$$NO
	set idRule = ""
	for {
		set idRule = $order(arrRules(idRule))
		quit:idRule=""
		
		set objRule = $get(arrRules(idRule,1)) 
		if ($$$WWW122D2ApplyMask(objRule) '= "") {
			set blnMaskable = $$$YES
		}
	}
	quit blnMaskable
	
	
GetDateMask()
    ;-------------------------------------------------------------------------------
    ; Return date format as a mask
    ; 
    ; Parameters: 
    ; 
    ; Returns: 
    ;
    ; History:
    ; 30-May-2008	heber	SRBR014945: Created
    ;-------------------------------------------------------------------------------
	new loop,strChar,strDate,strDateMask
	
	set strDateMask = ""
	set strDate = $$^WWWDATE("1")	; get example date
	for loop = 1:1 {
		set strChar = $extract(strDate,loop)
		quit:(strChar = "")
					
		// add a number 
		if ($find("0123456789",strChar) > 0) {
			set strDateMask = strDateMask _ "1N"
			// add a fixed char
		} else {
			set strDateMask = strDateMask_"1"_""""_strChar_""""
		}
	}
	quit strDateMask	
	
	
GetMaskVarName(pidYFORM,pidYBBN)
    ;-------------------------------------------------------------------------------
    ; Return mask variable name based on field definition
    ; 
    ; Parameters: 
    ; 
    ; Returns: mask variable name
    ;
    ; History:
    ; 04-Jan-2008	HeberB	SRBR014794: Created 
    ;-------------------------------------------------------------------------------
	new objWWW122,strVarName
	
	set objWWW122 = $get(^WWW122(0,pidYFORM,pidYBBN,1))
	
	if ($$$WWW122SequenceNumber(objWWW122) = "") {         ; manual field
		set strVarName = "Y"_pidYFORM_"M"_pidYBBN_"mask"
		
	} else {                                               ; data field
		set strVarName = "Y"_pidYFORM_"D"_pidYBBN_"mask"
	}
	quit strVarName
	
	
GetFieldName(pidYFORM,pidYBBN)
    ;-------------------------------------------------------------------------------
    ; Return field name based on field definition
    ; 
    ; Parameters: 
    ; 
    ; Returns: Bollean indicating the JS Masking code is to be added
    ;
    ; History:
    ; 29-Jun-2008	shobby	SRBR014794:For data fields should use the SequenceNumber
    ; 04-Jan-2008	HeberB	SRBR014794:Created 
    ;-------------------------------------------------------------------------------
	new objWWW122,strVarName
	
	set objWWW122 = $get(^WWW122(0,pidYFORM,pidYBBN,1))
	
	if ($$$WWW122SequenceNumber(objWWW122) = "") {              ; manual field
		set strVarName = "document.WWW2.Y"_pidYFORM_"M"_pidYBBN
		
	} else {                                                    ; data field
		set strVarName = "document.WWW2.Y"_pidYFORM_"D"_$$$WWW122SequenceNumber(objWWW122)
	}
	quit strVarName
	
]]></Routine>
</Export>