<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCK" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRUCK
#include COMSYS
#include INConst
	/*------------------------------------------------------------------------------
	; Description of Function :
	;		DRUCKVORGABEN FUER BELEGDRUCK
	;
	;		Updates General Ledger through FIBU^INFIBBUCH called by
	;		INDRUCK71 & INDRUCK72 from INDRUCK7
	;
	; Inputs : 
	;
	; ByRef :
	;	YAUFTRAG		=AUFTRAGS/LAGER-NUMMER
	;	YAUFTRAG(N)		=POSITIONSNUMMER
	;	YBETRIEB		=BETRIEB
	;	YBELEG			=BELEGART AUS WWW101(0,"BELEG",SPRACHE..
	;					(1=ANGEBOT, 2=AB, 3=BESTELLUNG,  5=LIEFERAVISE, 6=LIEFERSCHEIN,
	;					 7=RECHNG (Invoice), 9 BEREITSTELLUNG, 12=TEILZAHLUNGSRECHUNG,
	;					 10=ANFRAGE, 17=GUTSCHRIFT)
	;	YDATE			=DATUM
	;	YCOPY			=GESAMT/WIEDERH.  0=GES,1=WIEDERH.
	;	YLIEFER			=LIEFERANT  (NUR BEI BESTELLUNGEN) ;next to 
	;	YSEND			=VERSANDART
	;					(0=BILDSCHIRM,1=EMAIL,2=FAX,3=XML,4=EDIFACT,5=FTP,6=EDIPRO,7=FTP,9=STD.INTERFACE)
	;	YTEST			Test Mode Indicator (boolean)		TESTAURUF
	;	YTESTSPR		Test Mode - Language to use
	;	YADRES			=ANSCHRIFT
	;	YVERBAND		=VERBAND ($P(YVERBAND1,Y,71)= 0=KEINE RECHNUNG 1=RECHNUNG 2=RECHNUNGSKOPIE)
	;	YREGUL			=RECHNUNG IN ZENTRALREGULIERUNGSDATEI GESPEICHERT JA/NEIN ;within 
	;	YSAMMEL			= SAMMELRECHNUNGSNUMMER
	;	YSENDART		FÜR ABBRUCH WENN NICHT DIE RICHTIGE SENDART
	;					(0=BILDSCHIRM,1=EMAIL,2=FAX,3=XML,4=EDIFACT,5=FTP,6=EDIPRO,7=FTP,9=STD.INTERFACE)           
	;	DATEIAUSWAHL FÜR XML ;to XML 
	;	YGESTSENDART	=1 ONLY CHECK HOW TO SEND ? YGESTSENDART = SENDART
	;	YSUMINVOICE		=1 ; IF SUM OF ALL INVOICES ORDERS=^WWWSOR(YUSER,"SUMINVOICE",ORDER,LINEITEM)=""
	;
	; Returns :
	;
	; FIXME: if +$GET(YSEND)'=""     <GRF>
	;
	;
	; History :
	; 05-Oct-2007	GRF		SR15605: Default site location assumed to be numeric
	; 06-Dec-2006	GRF		SR15272: Doco; blnComplaint; Naked References
	; 13-Jun-2006	Steve S	SR14723: Produce meaningful error messages
	; 28-Mar-2006	JW		SR14486: Rewrote. Don't count balance twice.
	; 17-Feb-2006	JW		SR14206: Corrected lock checks for lines
	; 17-Feb-2006	JW		Added language text, created ^WWW006
	; 23-Jan-2006	GRF		SR14105: Use string for padding text; correct dot levels; doco
	; 09-Jan-2006	SC		SR13997: Updated error message when customer on credit
	; 						hold. More meaningful message at client's request.
	; 19-Aug-2005	GRF		SR13526 : Doco
	; 06-Sep-2005	JW		SR13415: Temporarily disable printing tax inclusive.
	; 02-Sep-2005	JW		SR12966: WWW128 is not shared 
	; 29-Aug-2005	Steve S	SR13107: Omit non-delivered/non-sourced items on invoice
	;  3-Aug-2005	JW		SR12988: Don't include surcharge as an additional charge
	; 30-May-2005	RobertW	SR12056: Attempt at Performance Increase
	; 15-Feb-2000 	DT		Created
	;-----------------------------------------------------------------------------*/
	new BETNR,blnComplaint,DRUCK,DRUCKSTOP,GESAMT,NETTOWW,POS,POS1,PROT
	new Q,RABATTEXIST,RABATTSEITE,RABATTZEILE,SPERRE,XUSER,XPROT
	new YA,YADRES,YANZAHLTEMP,YAUFTRAG1,YBELEG1,YDATEI,YEXTRA,YFAX,YFELDPZ,YFRACHT
	new YHTML,YHTMLSEND,YIII,YKMGELD,YKUNDE1,YMAIL,YPOSEXTRA,YREGUL
	new YSTDIF,YVERBAND,YVERBAND1,YVERSICH,YWHR1,YZUABSCHLAG,YZUSCHLAG,strLineLock
	
	; FIXME : Inconsistent use of $get with YBELEG - either needed or not <GRF>
	
	/*-------------------------------------- Data structures used
	;	AUF1			objINAUF
	;	BRIEF1			objINBRIEF
	;	POS1			objINANGP			.
	;	POS1			objINAUFP			.
	;	SATZ			objINDMSA			   .
	;	SATZ			objINMAILJOB		   .
	;	YADRES			objINWERBADR		      .
	;	YADRES			objINKUNDE			      .
	;	YADRES			objINLIEF			      .
	;	YAUFTRAG1		objINAUF			.
	;	YAUFTRAG1		objINAUFCHECK		.
	;	YAUFTRAG1		objINANG			.
	;	YBELEG1			objINDRPARA			   .
	;	YBELEG1			objINDRPARAB		   .
	;	YFELD			objINAUFP
	;	YFELDPZ			objINAUFPZ
	;	YVERBAND1		objINVERBAND
	;--------------------------------------- */
	
	SET YDATEI="INAUF,INAUFP,INAUFA,INKUNDE,INAUFPT,INAUFPREL"
	IF $GET(YBELEG)=3  SET YDATEI="INAUF,INAUFP,INAUFA,INLIEF,INAUFPT,INAUFPREL"     ; Purchase Order
	IF $GET(YBELEG)=13 SET YDATEI="INAUF,INAUFP,INAUFA,INLIEF,INAUFPT,INAUFPREL"     ; Order Cancel
	IF $GET(YBELEG)=1  SET YDATEI="INANG,INANGP,INANGA,INKUNDE,INANGPT,INANGPREL"    ; Offer
	IF $GET(YBELEG)=10 SET YDATEI="INANG,INANGP,INANGA,INLIEF,INAUFPT,INAUFPREL"     ; Inquiries
	
	SET YHTML   = 0  ;DRUCK MIT HTML-VORLAGE ;printing by means of 
	SET YSTDIF  = 0  ;DRUCK ÃBER STANDARD INTERFACE (Z.B. SEEBURGER SCHNITTSTELLE) ;printing via 
	SET YSAMMEL = $GET(YSAMMEL)
	SET YNOFOOT = $$$YES      ;==> KEINE FUSSNOTE
	
	IF $GET(YTEST)=$$$YES DO   ;WEM;25073;11.02.2004;ANZEIGEN EINES VORDEFINIERTEN AUFTRAG/ANGEBOT STATT DES LETZTEN
	. ;IF $GET(BELEGSPRACHE)'="" 
	. SET YAUFTRAG=135632   ; DEUTSCHER AUF/AN
	. IF $GET(BELEGSPRACHE)'="DE" SET YAUFTRAG=135633                                        ; ENGLISCHER AUF/AN
	. SET YLIEFER=$ORDER(^INLIEF(YM,""),-1)   ;LIEFERANTENBESTELLUNGSTEST
	. NEW POS
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFPCHECK(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET YAUFTRAG(POS)=""
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF $GET(YTEST)=1 DO   ; WEM;11.02.2004;ALTE ZEILEN VOR #25073
	. IF $GET(YBELEG)=1!($GET(YBELEG)=10) SET YAUFTRAG=$ORDER(^INANG1(YM,""),-1) QUIT:YAUFTRAG'=""   ;ANGEBOT ;proposition 
	. DO
	. . NEW AUFTRAG
	. . SET YAUFTRAG=""
	. . ;SET AUFTRAG="" FOR  SET AUFTRAG=$ORDER(^INAUF1(YM,AUFTRAG),-1) QUIT:AUFTRAG=""  QUIT:$PIECE($GET(^INAUF(YM,AUFTRAG,1)),Y,2)=0  ;AUFTRAG
	. . ;SET YAUFTRAG=AUFTRAG ;table-mat 
	. . SET AUFTRAG=""
	. . FOR  SET AUFTRAG=$ORDER(^INAUF1(YM,AUFTRAG),-1) QUIT:AUFTRAG=""  DO  QUIT:YAUFTRAG'=""  ;FIS;03.11.03;24524;OFFENEN AUFTRAG SUCHEN
	. . . IF YBELEG=3!(YBELEG=10)!(YBELEG=13) QUIT:$PIECE($GET(^INAUF(YM,AUFTRAG,1)),Y,2)'=2  ;AUFTRAG ;order 
	. . . IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 QUIT:$PIECE($GET(^INAUF(YM,AUFTRAG,1)),Y,2)'=0  ;AUFTRAG ;order 
	. . . SET YAUFTRAG=AUFTRAG
	. IF YAUFTRAG="" IF $GET(YBELEG)'=1 IF $GET(YBELEG)'=10 SET YAUFTRAG=$ORDER(^INAUF(YM,""),-1)
	. IF YAUFTRAG="" IF $GET(YBELEG)=1!($GET(YBELEG)=10) SET YAUFTRAG=$ORDER(^INANG(YM,""),-1)
	. SET YLIEFER=$ORDER(^INLIEF(YM,""),-1)   ;LIEFERANTENBESTELLUNGSTEST
	. QUIT:YLIEFER=""
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	IF $GET(YTEST)=$$$YES IF $GET(YTESTSPR)'="" NEW SPRACHE SET SPRACHE=YTESTSPR  ;FIS;03.11.03;24524;TEST BELEGE IN SPRACHEN
	
	;IF $ORDER(^WWWSOR(YUSER,"SUMINVOICE",""))'="" SET YSUMINVOICE=1 IF $GET(YAUFTRAG)="" SET YAUFTRAG=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",""))  ;TYBD;29,1,2005;SAMMELRECHUNG; SUM
	IF $ORDER(^WWWSOR(YUSER,"SUMINVOICE",""))'="" SET YSUMINVOICE=1 KILL YAUFTRAG SET YAUFTRAG=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",""))  ;TYBD;29,1,2005;SAMMELRECHUNG; SUM;TYBD;212.2.2005
	
	;IF $GET(YAUFTRAG)="" WRITE "Funktion nicht möglich, da noch kein Auftrag angelegt ist! / Function not possible. No Orders yet!"  DO FF^WWWW() QUIT  ;TESTLAUF OHNE AUFTRAG ;without order 
	IF $GET(YAUFTRAG)="" WRITE $$$Text("IN00394")  DO FF^WWWW() QUIT		; 17-Feb-2006
	
	IF $GET(YTEST)'=$$$YES do CleanUpLocks^WWW006(YUSER,$$$YES)
	
	;SICHERN / LOCK SETZTEN ;safeguard 
	IF '$DATA(^WWW128(YM,"INAUF7P",1)) SET ^WWW128(YM,"INAUF7P",1)="0"
	
	// FIXME: If YSEND>3, gain locks automatically ??????
	
	FOR  SET XUSER=$RANDOM(10000000) QUIT:'$DATA(^WWWUSER(0,XUSER)) // Need to create a WWWUSER record otherwise CleanUpLocks could remove lock during processing
	
	/* SR14924
	if ($get(YTEST) '= 1) && ($get(YPROFORMA) '= 1) {
		set ^WWWUSER(0,XUSER,1) = "" // Ought to use $$$Save and note not atomic
		if (YBELEG = 1) || (YBELEG = 10) {
			merge ^CacheTempWWW006SubRecords(XUSER,"INANGP") = YAUFTRAG
			set arrSubClass("INANGP") = ""
			if $$$ISERR($$LockTree^WWW006("INANG",YUAFTRAG,XUSER,,.arrSubClass)) {
				set DRUCKSTOP = 1
			}
		} else {
			set objOrder = $get(^INAUF(YM,YAUFTRAG,1))
			set idOrder = $$$INAUFToComlaintOrder(objOrder) // Order Id of Guarantee order
			if $$$INAUFToComlaintOrder(objOrder) '= "" {
				set ^CacheTempWWW006Records(XUSER,"INAUF",idOrder) = ""
			}
			set idOrder = $$$INAUFComlaintFromOrderNo(objOrder) // Order Id of Original order
			if idOrder '= "" {
				set ^CacheTempWWW006Records(XUSER,"INAUF",idOrder) = ""
			}
 
			merge ^CacheTempWWW006SubRecords(XUSER,"INAUFP") = YAUFTRAG
			set arrSubClass("INAUFP") = ""
			if $$$ISERR($$LockTree^WWW006("INAUF",YUAFTRAG,XUSER,,.arrSubClass)) {
				set DRUCKSTOP = 1
			}
		}
		if $get(DRUCKSTOP) {
			write $$$Text(32047)_" "_YAUFTRAG_" "_$$$Text(32172)
			do FF^WWWW()
		}
	}
	*/
	
	IF $GET(YTEST)'=$$$YES IF (YBELEG'=1) && (YBELEG'=10) DO  ;KEIN ANGEBOT ;no proposition 
	. NEW YPOS
	. QUIT:$GET(YPROFORMA)=1  ;PROFORMARECHNUNG ;proforma invoice 
	. SET PROT = $ORDER(^WWW006(0,+$HOROLOG,"^INAUF/"_YM_"."_YAUFTRAG))
	. SET PROT(1)="^INAUF/"_YM_"."_YAUFTRAG_".1/"
	. ; "Order ### Record In Use. Please Try Later."
	. IF $GET(YSEND)<3 IF PROT=PROT(1) WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=$$$YES QUIT
	. SET PROT = $ORDER(^WWW006(0,+$HOROLOG,"^INAUFP/"_YM_"."_YAUFTRAG))
	.
	. //IF $GET(YSEND)<3 IF $EXTRACT(PROT,1,$LENGTH(PROT(1)))=PROT(1) WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=1 QUIT  ;DATENSATZ IN USE ;data record within 
	. SET strLineLock = "^INAUFP/"_YM_"."_YAUFTRAG_"."		//SR14206
	. IF $GET(YSEND)<3 IF $EXTRACT(PROT,1,$LENGTH(strLineLock))=strLineLock WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=$$$YES QUIT  ;DATENSATZ IN USE ;data record within 
	. ;
	. SET ^WWW006(0,+$HOROLOG,PROT(1),1)=XUSER_Y_$PIECE($HOROLOG,",",2)   ;SICHERN ;safeguard 
	. SET XPROT(PROT(1))=""  ;MERKEN
	. ;
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(YAUFTRAG(YPOS)) QUIT:YPOS=""  DO   ;POS
	. . SET PROT(3)="^INAUFP/"_YM_"."_YAUFTRAG_"."_YPOS_".1/" 
	. . SET ^WWW006(0,+$HOROLOG,PROT(3),1)=XUSER_Y_$PIECE($HOROLOG,",",2)   ;SICHERN POSITION ;safeguard 
	. . SET XPROT(PROT(3))=""  ;MERKEN
	
	IF $GET(YTEST)'=$$$YES IF (YBELEG=1) || (YBELEG=10) DO  ;ANGEBOT/ANFRAGE
	. NEW YPOS
	. QUIT:$GET(YPROFORMA)=1  ;PROFORMARECHNUNG ;proforma invoice 
	. SET PROT=$ORDER(^WWW006(0,+$HOROLOG,"^INANG/"_YM_"."_YAUFTRAG))
	. SET PROT(1)="^INANG/"_YM_"."_YAUFTRAG_".1/"
	. ; "Order ### Record In Use. Please Try Later."
	. IF $GET(YSEND)<3 IF PROT=PROT(1) WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=$$$YES QUIT
	. SET PROT=$ORDER(^WWW006(0,+$HOROLOG,"^INANGP/"_YM_"."_YAUFTRAG))
	. 
	. //IF $GET(YSEND)<3 IF $EXTRACT(PROT,1,$LENGTH(PROT(1)))=PROT(1) WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=1 QUIT  ;DATENSATZ IN USE  ;data record within 
	. SET strLineLock = "^INANGP/"_YM_"."_YAUFTRAG_"."		// SR14206
	. IF $GET(YSEND)<3 IF $EXTRACT(PROT,1,$LENGTH(strLineLock))=strLineLock WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32172) DO FF^WWWW() SET DRUCKSTOP=$$$YES QUIT  ;DATENSATZ IN USE  ;data record within 
	. ;
	. SET ^WWW006(0,+$HOROLOG,PROT(1),1)=XUSER_Y_$PIECE($HOROLOG,",",2)   ;SICHERN ;safeguard 
	. SET XPROT(PROT(1))=""  ;MERKEN
	. ;
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(YAUFTRAG(YPOS)) QUIT:YPOS=""  DO   ;POS
	. . SET PROT(3)="^INANGP/"_YM_"."_YAUFTRAG_"."_YPOS_".1/" 
	. . SET ^WWW006(0,+$HOROLOG,PROT(3),1)=XUSER_Y_$PIECE($HOROLOG,",",2)   ;SICHERN POSITION ;safeguard 
	. . SET XPROT(PROT(3))=""  ;MERKEN
	
	KILL PROT
	
	;PRÜFEN AUFTRAGSSPERRE ;check
	; "Order/Offer Is Item Closed!"
	IF $GET(YAUFTRAG)'="" IF YBELEG'=1 IF YBELEG'=10   IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,38)=$$$YES WRITE $$^WWWTEXT(32047)_" "_YAUFTRAG_" "_$$^WWWTEXT(32285)_" "_$$^WWWTEXT(10004)_"!" DO FF^WWWW() DO UNLOCK QUIT  ;AUFTRAG GESPERRT ;order DISABLED 
	IF $GET(YAUFTRAG)'="" IF (YBELEG=1) || (YBELEG=10) IF $PIECE($GET(^INANG(YM,YAUFTRAG,1)),Y,38)=$$$YES WRITE $$^WWWTEXT(32178)_" "_YAUFTRAG_" "_$$^WWWTEXT(32285)_" "_$$^WWWTEXT(10004)_"!" DO FF^WWWW() DO UNLOCK QUIT  ;ANGEBOT GESPERRT ;proposition DISABLED 
	IF $GET(YAUFTRAG)'="" IF YBELEG'=1 IF YBELEG'=7 IF YBELEG'=12 IF YBELEG'=17 IF YBELEG'=6 IF YBELEG'=10 IF $$$INAUFOrderCompleted($GET(^INAUF(YM,YAUFTRAG,1)))=1 WRITE $$$Text($ListBuild("IN00387",YAUFTRAG)),! DO FF^WWWW() DO UNLOCK QUIT  ; "Order %1 is closed."
	
	; "Planned Order Date ######"
	IF $GET(YAUFTRAG)'="" IF YBELEG=3 IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,248)'="" IF $PIECE(^INAUF(YM,YAUFTRAG,1),Y,248)>($HOROLOG) WRITE $$^WWWTEXT(32931)_": "_$$^WWWDATE(+$PIECE(^INAUF(YM,YAUFTRAG,1),Y,248)) DO FF^WWWW() DO UNLOCK QUIT  ;BESTELLUNG GEPLANT FÜR ;sales order to
	
	;Berechtigungen ;Entitlements 
	;	D31		$$$INVORGModuleForOrderPrint()
	set blnComplaint = +$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,169)
	IF ($GET(YBELEG)=3) || (YBELEG=13)  IF $$^WWWACCESS("",$PIECE($GET(^INVORG(YM,YM,1)),Y,31))'=$$$OK WRITE $$^WWWTEXT(5) DO FF^WWWW() QUIT    ;KEINE BERECHTIGUNG FÜR BESTELLUNG ;no to sales order 
	IF $GET(YBELEG)=7  IF 'blnComplaint IF $$^WWWACCESS("",$PIECE($GET(^INVORG(YM,YM,1)),Y,29))'=$$$OK WRITE $$^WWWTEXT(5) DO FF^WWWW() DO UNLOCK QUIT    ;KEINE BERECHTIGUNG FÜR RECHNUNG ;no to tab 
	IF $GET(YBELEG)=17 IF 'blnComplaint IF $$^WWWACCESS("",$PIECE($GET(^INVORG(YM,YM,1)),Y,29))'=$$$OK WRITE $$^WWWTEXT(5) DO FF^WWWW() DO UNLOCK QUIT    ;KEINE BERECHTIGUNG FÜR GUTSCHRIFT ;no to 
	IF $GET(YBELEG)=7  IF blnComplaint  IF $$^WWWACCESS("",$PIECE($GET(^INVORG(YM,YM,1)),Y,30))'=$$$OK WRITE $$^WWWTEXT(5) DO FF^WWWW() DO UNLOCK QUIT    ;KEINE BERECHTIGUNG FÜR RECHNUNG REKLA ;no to tab 
	IF $GET(YBELEG)=17 IF blnComplaint  IF $$^WWWACCESS("",$PIECE($GET(^INVORG(YM,YM,1)),Y,30))'=$$$OK WRITE $$^WWWTEXT(5) DO FF^WWWW() DO UNLOCK QUIT    ;KEINE BERECHTIGUNG FÜR GUTSCHRIFT REKLA ;no to 
	
	IF $GET(DRUCKSTOP)=$$$YES SET YSTOP=1 QUIT   ;NICHT WEITER, DA STOP
	
	SET GESAMT=0
	DO  ;VORGABEN
	. SET YCOPY  = +$GET(YCOPY)        ;GESAMT ODER WIEDERHOLUNGSDRUCK ;total Or 
	. SET YBELEG = +$GET(YBELEG)       ;BELEGART
	. IF (YBELEG=7) || (YBELEG=12) DO  ;WENN RECHNUNG, DANN PRUEFEN AUF GUTSCHRIFT
	. . SET GESAMT=0
	. . IF $ORDER(YAUFTRAG(""))="" DO  ;KEINE POSITIONEN ANGEGEBEN=ALLE ;no 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . . . SET YFELD=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . . . ;SR13107: Treat the first copy just like any other
	. . . . ;IF +YCOPY=0 QUIT:$PIECE(YFELD,Y,97)'=""  ;WENN GESAMTDRUCK, DANN NUR DIE NOCH NICHT GEDRUCKTEN POSITIONEN
	. . . . SET YAUFTRAG(POS)=""
	. . ;
	. . SET POS=""
	. . FOR  SET POS=$ORDER(YAUFTRAG(POS)) QUIT:POS=""  DO 
	. . . SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . . IF $GET(YPROFORMA)=1 SET POS1=$GET(^INANGP(YM,YAUFTRAG,POS,1))
	. . . ;SET GESAMT=GESAMT+$PIECE(POS1,Y,119)   ;GES BETRAG
	. . . SET GESAMT=GESAMT+$PIECE(POS1,Y,123)   ;NETTO BETRAG (INKL. RABATTE/ZUSCHLÄGE) FIS,06.02.02
	. . ;
	. . DO  ;ZUSATZKOSTEN ;additional costs 
	. . . NEW YI,AUF1
	. . . SET AUF1=$GET(^INAUF(YM,YAUFTRAG,1))
	. . .;FOR YI=182,183,184,211 SET GESAMT=GESAMT+$PIECE(AUF1,Y,YI)
	. . . FOR YI=182,183,184 SET GESAMT=GESAMT+$PIECE(AUF1,Y,YI)		// SR12988: Don't include surcharge
	. . ;
	. . ;+++++++++++++++++++++++++++++++++++
	. . ; Invoice => Credit Note
	. . ;+++++++++++++++++++++++++++++++++++
	. . IF $GET(YSUMINVOICE)'=1 IF YBELEG=7 IF GESAMT<0 SET YBELEG=17  ;GUTSCHRIFT  ;NICHT BEI SAMMELGUTSCHRIFT
	. ;
	. IF $GET(YDATE)="" SET YDATE=+$HOROLOG  ;TAGESDATUM WENN KEIN BELEGDATUM ;when no 
	. ;
	. SET YAUFTRAG1=$GET(^INAUF(YM,YAUFTRAG,1))  ;AUFTRAGSDATEN
	. IF $GET(YTEST)=$$$YES                                                      SET YAUFTRAG1 = $GET(^INAUFCHECK(YM,YAUFTRAG,1))   ;WEM;25073;16.02.2004;ANDERE AUFTRAGSDATEI WENN BELEGDRUCKTEST
	. IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1)                        SET YAUFTRAG1 = $GET(^INANG(YM,YAUFTRAG,1))        ;ANGEBOTSDATEN
	. IF $GET(YTEST)=$$$YES  IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1) SET YAUFTRAG1 = $GET(^INANGCHECK(YM,YAUFTRAG,1))   ;WEM;25073;16.02.2004;ANDERE ANGEBOTSDATEI WENN BELEGDRUCKTEST
	. IF $GET(YTEST)'=$$$YES IF (YBELEG=7) || (YBELEG=17) IF '$DATA(^INAUF(YM,YAUFTRAG,1)) IF $DATA(^INANG(YM,YAUFTRAG,1)) SET YAUFTRAG1 = $GET(^INANG(YM,YAUFTRAG,1)),YPROFORMA=1  ;ANGEBOTSDATEN   ;WEM;25073;16.02.2004;NUR WENN KEIN BELEGDRUCKTEST
	. ;
	. IF YBELEG=12 DO
	. . SET YFELDPZ=""
	. . IF $GET(YPZDATUM)'="" IF $DATA(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)) SET YFELDPZ = $GET(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1))    ;ZAHLUNGSVEREINBAR DATEN
	. ;
	. SET YBETRIEB = $GET(YBETRIEB)   ;BETRIEBSNUMMER
	. IF YBETRIEB="" SET YBETRIEB = $PIECE(YAUFTRAG1,Y,6)       ;BETRIEB DES VERKAUFS ;location    $$$INAUFLocation()
	.;IF YBETRIEB="" SET YBETRIEB =+$ORDER(^WWW0121(0,YM,""))   ;BETRIEBSNUMMER FÜR ORTSBEZEICHNUNG
	. if YBETRIEB="" set YBETRIEB = $order(^WWW0121(0,YM,""))   ;BETRIEBSNUMMER FÜR ORTSBEZEICHNUNG ; SR15605 (2 lines)
	. if YBETRIEB="" set YBETRIEB = 0 
	. SET YKUNDE=$PIECE(YAUFTRAG1,Y,1)  ;KUNDENNUMMER FÜR ANSCHRIFT ;to 
	. IF $PIECE(YAUFTRAG1,Y,108)'="" SET YKUNDE=$PIECE(YAUFTRAG1,Y,108)  ;ANDERER RECHNUNGSEMPFÄNGER Z.B. Leasing ges ;other e.g. leasing 
	. SET YADRES=""  ;ANSCHRIFTEN
	. IF YKUNDE'="" SET YADRES=$GET(^INKUNDE(YM,YKUNDE,1))  ;KUNDENNUMMER FÜR ANSCHRIFT ;to 
	. IF YKUNDE'="" SET BETNR=$PIECE(YADRES,Y,201)  ;BETRIEBSNUMMER
	. IF YBELEG=1 IF YADRES="" IF YKUNDE'="" DO
	. . SET YADRES=$GET(^INWERBADR(YM,YKUNDE,1))  ;WERBEANSCHRIFT FÜR ANSCHRIFT ;to 
	. . SET $PIECE(YADRES,Y,54)=1   ;STEUER INLAND ;tax 
	. . SET $PIECE(YADRES,Y,50)=""  ;STEUER INLAND ;tax 
	. ;
	. DO   ;BEC;26820;23.11.04;ANSPRECHPARTNER ADRESSE (EMAIL/Fax EINTRAGEN)
	. . IF $PIECE(YAUFTRAG1,Y,2)=0 IF YBELEG=3 QUIT   ;BEC;27161;19.01.04
	. . IF $PIECE(YAUFTRAG1,Y,308)'="" SET $PIECE(YADRES,Y,24)=$PIECE(YAUFTRAG1,Y,308)    ;email
	. . IF $PIECE(YAUFTRAG1,Y,307)'="" SET $PIECE(YADRES,Y,22)=$PIECE(YAUFTRAG1,Y,307)    ;fax
	. ;
	. ;------------------------Rechnungsempfänger-------------------------FAN 21.09.2001
	. ;
	. IF (YBELEG=7) || (YBELEG=12) || (YBELEG=17) DO  ;RECHNUNG,TEILZAHLUNGSRECHNUNG,GUTSCHRIFT     ;BEC;26.11.04;26820;AB DIREKT ZU KUNDE 
	. . IF $PIECE(YADRES,Y,38)'="" IF $DATA(^INKUNDE(YM,$PIECE(YADRES,Y,38),1)) DO   ;Rechnungsempfänger ;Invoice Recipient 
	. . . SET YKUNDE=$PIECE(YADRES,Y,38)
	. . . IF YKUNDE'="" IF YKUNDE'="" SET YADRES=$GET(^INKUNDE(YM,YKUNDE,1))
	. . . IF YKUNDE'="" IF $DATA(^INKUNDEA(YM,YKUNDE,YBELEG,1)) SET YADRES=^INKUNDEA(YM,YKUNDE,YBELEG,1) DO   ;BEC;26.11.04;26820SONDERANSCHRIFT KUNDE
	. . . . IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)  ;STEUER KENZEICHEN;TYBD ;tax 
	. . . . IF +$PIECE(YADRES,Y,15)=1 IF $PIECE(YADRES,Y,24)="" SET $PIECE(YADRES,Y,24)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,24)  ;MAILADRESSE AUS KUNDEN
	. . . . IF +$PIECE(YADRES,Y,15)=2 IF $PIECE(YADRES,Y,22)="" SET $PIECE(YADRES,Y,22)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,22)  ;FAX AUS KUNDEN
	. ;
	. ;-------------------------------------------------------------------END
	. SET YVERBAND  = ""
	. SET YVERBAND1 = ""
	. SET YREGUL    = 0
	. ;-------------------------------------------------------------------VERBAND     
	. IF (YBELEG=2) || (YBELEG=7) || (YBELEG=12) || (YBELEG=17) DO  ;RECHNUNG,AB,TEILZAHLUNGSRECHNUNG,GUTSCHRIFT
	. . IF $PIECE(YADRES,Y,1)'="" IF $DATA(^INVERBAND(YM,$PIECE(YADRES,Y,1),1)) DO   ;VERBAND-ADRESSE
	. . . SET YVERBAND=$PIECE(YADRES,Y,1) 
	. . . SET YVERBAND1=$GET(^INVERBAND(YM,YVERBAND,1))
	. ;
	. SET YDEBITOR=""
	. IF YKUNDE'="" SET YDEBITOR=$PIECE(YADRES,Y,48)  ;DEBITORENNUMMER FÜR RECHNUNG ;to tab 
	. SET YLIEFER1=""
	. IF $GET(YLIEFER)'="" IF $DATA(^INLIEF(YM,YLIEFER))  DO   ;LIEFERANTENDATEN (BESTELLUNG)   LIEFERANT IST EIN LIEFERANT  FAN  19.02.2002 ;supplier uni- supplier buff 
	. . SET YADRES=$GET(^INLIEF(YM,YLIEFER,1)),YLIEFER1=YADRES
	. . SET BETNR=$PIECE(YADRES,Y,201)  ;BETRIEBSNUMMER
	. . IF $PIECE(YAUFTRAG1,Y,2)=2 IF $PIECE(YAUFTRAG1,Y,308)'="" SET $PIECE(YADRES,Y,24)=$PIECE(YAUFTRAG1,Y,308)    ;email;BEC;26820;27.12.04;BEC;17.01.04;NUR BEI LIEFERANTENBESTELLUNG
	. . IF $PIECE(YAUFTRAG1,Y,2)=2 IF $PIECE(YAUFTRAG1,Y,307)'="" SET $PIECE(YADRES,Y,22)=$PIECE(YAUFTRAG1,Y,307)    ;FAX;BEC;26820;27.12.04:17.01.04;NUR BEI LIEFERANTENBESTELLUNG
	. . IF $PIECE(YAUFTRAG1,Y,2)=0 IF $DATA(^INLIEFA(YM,YLIEFER,YBELEG,1)) DO     ;26820;27.12.04;nicht mehr berücksichtigen, wird ja beim Anlegen des Auftrages eingetragen
	. . . SET YADRES=^INLIEFA(YM,YLIEFER,YBELEG,1)
	. . . set YLIEFER1=YADRES
	. . . IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER KENZEICHEN ;tax 
	. ;
	. ;IF $GET(YLIEFER)="" IF $PIECE(YLIEFER1,Y,36)'="" DO
	. IF $PIECE(YLIEFER1,Y,36)'="" IF $DATA(^INLIEF(YM,$PIECE(YLIEFER1,Y,36))) DO   ;AGENTUR LIEFERANT ;branch office supplier 
	. . SET YLIEFER=$PIECE(YLIEFER1,Y,36)
	. . SET YADRES=$GET(^INLIEF(YM,YLIEFER,1)),YLIEFER1=YADRES
	. . IF $DATA(^INLIEFA(YM,YLIEFER,YBELEG,1)) DO
	. . . SET YADRES=^INLIEFA(YM,YLIEFER,YBELEG,1),YLIEFER1=YADRES
	. . . IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER KENZEICHEN ;tax 
	. ;
	. IF $GET(YLIEFER)'="" IF '$DATA(^INLIEF(YM,YLIEFER))  DO   ;KUNDENDATEN (BESTELLUNG)   LIEFERANT IST EIN KUNDEN  FAN  19.02.2002 ;supplier uni- buff 
	. . SET YADRES=$GET(^INKUNDE(YM,YLIEFER,1)),YLIEFER1=YADRES 
	. . IF $DATA(^INKUNDEA(YM,YLIEFER,YBELEG,1)) DO
	. . . SET YADRES=^INKUNDEA(YM,YLIEFER,YBELEG,1),YLIEFER1=YADRES
	. . . IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YLIEFER,1)),Y,54)  ;STEUER KENZEICHEN;TYBD ;tax 
	. ;
	. SET YINKLMWST=0		// SR13415: For now, don't look at this field
	. // IF YKUNDE'="" IF $$$INKUNDEPrintDocumentsInclTax($GET(^INKUNDE(YM,YKUNDE,1)))=1 SET YINKLMWST=1  ;EINZELHANDEL INKL MWST ;retailing Tax 
	. SET YMSPRACHE=SPRACHE
	. SET YBELEG1=$GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1))  ;DRUCKPARAMETER FÜR BELEGE ;to 
	. ;
	. IF +$GET(YSEND)'="" IF $DATA(^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$GET(YSEND),1)) DO   ;26050;05.07.04;ZUM TEST, NUR VON DEM FORMULAR  ;BEC;25224;21.05.04;BELEGDRUCK PRO VERSANDART
	. . IF $GET(YTEST)=$$$YES  IF $GET(YFORM)="INDRPARA" QUIT
	. . SET YBELEG1=$GET(^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$GET(YSEND),1))       
	. ;
	. IF YBELEG1="" DO
	. . NEW YBETRIEB
	. . SET YBETRIEB=$ORDER(^INDRPARA(YM,""))
	. . ;SET YBELEG1=$GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1))  ;DRUCKPARAMETER FÜR BELEGE
	. . IF +$GET(YSEND)'="" IF $GET(YBETRIEB)'="" IF $DATA(^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$GET(YSEND),1)) Do      ;26050;05.07.04;ZUM TEST, NUR VON DEM FORMULAR  ;BEC;25224;21.05.04;BELEGDRUCK PRO VERSANDART
	. . . IF $GET(YTEST)=$$$YES  IF $GET(YFORM)="INDRPARA" QUIT
	. . . SET YBELEG1=$GET(^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$GET(YSEND),1))
	. . ;
	. . IF $GET(YTEST)=$$$YES  IF $GET(YFORM)="INDRPARA" QUIT
	. . IF YBELEG1="" IF $GET(YBETRIEB)'="" SET YBELEG1=$GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1))  ;DRUCKPARAMETER FÜR BELEGE;BEC;25866;YBETRIEB ABGEPRÜFT
	. ;
	. ;SONDERANSCHRIFT (AUCH FÜR BESTELLUNG) ;to 
	. ;
	. IF $PIECE(YAUFTRAG1,Y,15)'="" DO
	. . IF (YBELEG=3) || (YBELEG=13) IF $PIECE(YAUFTRAG1,Y,2)'=2 QUIT    ;BEC;26820;22.11.04;NICHT BEI LIEFERANTENBESTELLUNG
	. . IF (YBELEG=7) || (YBELEG=12) || (YBELEG=17) IF $PIECE(YAUFTRAG1,Y,1)'="" IF $PIECE(YAUFTRAG1,Y,1)'=$GET(YKUNDE) IF $PIECE($GET(^INKUNDEA(YM,$PIECE(YAUFTRAG1,Y,1),YBELEG,1)),Y,15)'=$PIECE(YAUFTRAG1,Y,15) QUIT    ;BEC;26820;06.12.04;NICHT WENN KUNDE ANDERE RECHNUNGSANSCHRIFT
	. . SET $PIECE(YADRES,Y,15)=$PIECE(YAUFTRAG1,Y,15)
	. ;
	. DO
	. . NEW YA
	. . IF YBELEG'=1 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 IF $DATA(^INAUFA(YM,YAUFTRAG,YBELEG,1)) DO  QUIT  ;ANSCHRIFT FESTGELEGTLEGEN
	. . . SET YADRES=^INAUFA(YM,YAUFTRAG,YBELEG,1)
	. . . IF $GET(YKUNDE)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,YA)  ;STEUER KENZEICHEN KUNDE ;tax customer 
	. . ;
	. . IF YBELEG=1 IF $DATA(^INANGA(YM,YAUFTRAG,YBELEG,1)) DO  ;ANSCHRIFT FESTGELEGTLEGEN
	. . . SET YADRES=^INANGA(YM,YAUFTRAG,YBELEG,1)
	. . . IF $GET(YKUNDE)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,YA)  ;STEUER KENZEICHEN KUNDE ;tax customer 
	. . ;
	. . IF YBELEG=7 IF '$DATA(^INAUF(YM,YAUFTRAG,1)) IF $DATA(^INANGA(YM,YAUFTRAG,YBELEG,1)) DO  ;ANSCHRIFT FESTGELEGTLEGEN PROFORMARECHNUNG ;proforma invoice 
	. . . SET YADRES=^INANGA(YM,YAUFTRAG,YBELEG,1)
	. . . SET YPROFORMA=1
	. . . IF $GET(YKUNDE)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,YA)  ;STEUER KENZEICHEN KUNDE ;tax customer 
	. . ;
	. . IF YBELEG=7 IF $DATA(^INAUF(YM,YAUFTRAG,1)) IF $DATA(^INAUFA(YM,YAUFTRAG,YBELEG,1)) DO  ;ANSCHRIFT FESTGELEGTLEGEN ;BEC;26820;02.12.04 
	. . . SET YADRES=^INAUFA(YM,YAUFTRAG,YBELEG,1)
	. . . IF $GET(YKUNDE)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,YA)  ;STEUER KENZEICHEN KUNDE ;tax customer 
	. . ;
	. . IF (YBELEG=10) && $DATA(^INANGA(YM,YAUFTRAG,YBELEG,1)) DO  ;ANFRAGE NUMMER ;numeral 
	. . . SET YADRES   = ^INANGA(YM,YAUFTRAG,YBELEG,1)
	. . . set YLIEFER1 = YADRES 
	. . . IF $GET(YLIEFER)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,YA)  ;STEUER KENZEICHEN ;tax 
	. . ;
	. . ;      ;BEC;21.09.04;24490;AUCH FÜR BESTELLUNG
	. . IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) IF $DATA(^INAUFA(YM,YAUFTRAG,YBELEG,1)) DO  ;AUFTRAGSBESTELLUNGSADRESSE
	. . . SET YADRES   = ^INAUFA(YM,YAUFTRAG,YBELEG,1)
	. . . set YLIEFER1 = YADRES
	. . . IF $GET(YLIEFER)'="" FOR YA=50,54 IF $PIECE(YADRES,Y,YA)="" SET $PIECE(YADRES,Y,YA)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,YA)  ;STEUER KENZEICHEN ;tax 
	. ;
	. IF $PIECE(YADRES,Y,69)'="" IF $DATA(^INDRPARA(YM,YBETRIEB,YBELEG,$PIECE(YADRES,Y,69),1)) do      ;AUSLAND ;foreign country
	. . SET YBELEG1=^INDRPARA(YM,YBETRIEB,YBELEG,$PIECE(YADRES,Y,69),1)
	. . set SPRACHE=$PIECE(YADRES,Y,69) 
	. IF $PIECE(YADRES,Y,69)'="" IF +$GET(YSEND)'="" IF $DATA(^INDRPARAB(YM,YBETRIEB,YBELEG,$PIECE(YADRES,Y,69),+$get(YSEND),1)) do        ;BEC;25224;21.05.04;BELEGDRUCK PRO VERSANDART
	. . SET YBELEG1=^INDRPARAB(YM,YBETRIEB,YBELEG,$PIECE(YADRES,Y,69),+$get(YSEND),1)
	. . set SPRACHE=$PIECE(YADRES,Y,69)
	. IF +$PIECE(YBELEG1,Y,3)=0 SET $PIECE(YBELEG1,Y,3)=$PIECE($GET(^WWW012(0,YM,1)),Y,16)
	. ;
	. ;BELEGE ALS HTML-VORLAGE ;when 
	. IF $PIECE(YBELEG1,Y,1)=1 IF $DATA(^INDRPARAHTML(YM,YBETRIEB,YBELEG)) SET YHTML=1  ;FIS;18.06.03;23781;DRUCKEN HTML BELEGE
	
	IF $PIECE(YADRES,Y,201)="" SET $PIECE(YADRES,Y,201)=$GET(BETNR)
	IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) IF $TRANSLATE($GET(YLIEFER)," ")="" SET YADRES="",YLIEFER1=""  ;KEIN LIEFERANT=KEINE ANSCHRIFT ;no 
	
	;IF $PIECE(YAUFTRAG1,Y,15)'="" SET $PIECE(YADRES,Y,15)=$PIECE(YAUFTRAG1,Y,15)  ;SENDEART IN AUFTRAG GEÄNDERT ;within order 
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF $PIECE(YAUFTRAG1,Y,15)'="" DO
	. IF YBELEG=3!(YBELEG=13) IF $PIECE(YAUFTRAG1,Y,2)'=2 QUIT    ;BEC;26820;22.11.04;NICHT BEI LIEFERANTENBESTELLUNG
	. SET $PIECE(YADRES,Y,15)=$PIECE(YAUFTRAG1,Y,15)
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	IF '$FIND(",3,10,13,",","_YBELEG_",") IF YKUNDE="" WRITE $$^WWWTEXT(32176) DO UNLOCK QUIT
	IF '$FIND(",3,10,13,",","_YBELEG_",") IF YKUNDE'="" IF '$DATA(^INKUNDE(YM,YKUNDE,1)) IF '$DATA(^INWERBADR(YM,YKUNDE,1)) WRITE $$^WWWTEXT(32176) DO UNLOCK QUIT
	
	SET YSEND=+$GET(YSEND)  ;SENDEART,OK;TYBD;28,5,2004
	;IF $GET(YSENDART)'="" IF $GET(YCOPY)'=1 IF +$PIECE(YADRES,Y,15)'=$GET(YSENDART) QUIT    ;BEC;25783;25.05.04;TYBD
	;IF $GET(YSENDART)'="" IF $GET(YCOPY)'=1 SET YSEND=+$PIECE(YADRES,Y,15)
	
	IF $GET(YGESTSENDART)=1 SET YGESTSENDART=+$PIECE(YADRES,Y,15) DO UNLOCK QUIT                ;BEC;26820;15.12.04;
	IF $GET(YSENDART)'="" IF +$PIECE(YADRES,Y,15)'=$GET(YSENDART) SET YSTOP=1 DO UNLOCK QUIT    ;BEC;26820;15.12.04;UNLOCK
	
	SET YFAX=$PIECE(YADRES,Y,22)
	;IF YSEND=2 IF YFAX="" SET YSEND=0   ;DRUCKER STATT FAX
	IF YSEND=2 IF YFAX="" SET YSEND=0 SET VORG(99)=""  ;BEC;26820;24.11.04;DRUCKER STATT FAX
	
	SET YMAIL=$PIECE(YADRES,Y,24)
	;IF YSEND=1 IF YMAIL="" SET YSEND=0   ;DRUCKER STATT MAIL
	IF YSEND=1 IF YMAIL="" SET YSEND=0 SET VORG(99)=""  ;BEC;26820;24.11.04 DRUCKER STATT MAIL
	
	;IF YSEND=1!(YSEND=3)!(YSEND=4) IF YMAIL="" SET YSEND=0   ;DRUCKER STATT MAIL ;TYBD 14.10.2002 (Wenn sammeldruck)
	IF YSEND=9 SET YSTDIF=1,YHTML=0  ;DATENAUFBEREITUNG FÜR STANDARDSCHNITTSTELLE;FIS;20.02.04;25177
	
	IF (YSEND=3) || (YSEND=4) || (YSEND=6) || (YSEND=9) SET YHTML=0    ;BEC;268200;2.12.04
	
	IF YHTML=1  SET YHTMLSEND=YSEND,YSEND=3          ;FIS;18.06.03;23781;DRUCKEN HTML BELEGE (AUFBEREITUNG MIT INDRUCKXML)
	IF YSTDIF=1 SET YHTMLSEND=YSEND,YSEND=3,YHTML=0  ;FIS;20.02.04;25177;SENDEN ÜBER STANDARD SCHNITTSTELLE (AUFBEREITUNG MIT INDRUCKXML)
	
	;RECHNUNGSWÄHRUNG
	SET YWHR1=YWHR
	NEW YWHR
	SET YWHR=""
	IF $PIECE(YAUFTRAG1,Y,51)'="" SET YWHR=$PIECE(YAUFTRAG1,Y,51)  ;AUFTRAGSWÄHRUNG
	IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) IF $PIECE(YAUFTRAG1,Y,2)=0 IF $GET(YLIEFER)'="" SET YWHR=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,51)  ;FIS;26316;24.08.04
	IF YWHR="" SET YWHR=YWHR1
	SET YWHRF=""  ;UMRECHNUNGSFAKTOR FREMDWÄHRUNG;FIS;26316;24.08.04
	IF YWHR'=YWHR1 SET YWHRF=$PIECE(YAUFTRAG1,Y,314)
	
	IF GESAMT<0 SET Q=0 DO  QUIT:Q=1  ;KEINE AUSFÜHRUNG WENN GUTSCHRIFT ;no execution when 
	. IF YBELEG=2  SET Q=1
	. IF YBELEG=3  SET Q=1
	. IF YBELEG=13 SET Q=1
	. IF YBELEG=5  SET Q=1
	. IF YBELEG=6  SET Q=1
	. IF YBELEG=9  SET Q=1
	.;IF YBELEG=12 SET Q=1  ;AUSGESCHALTET;FIS;24105;08.08.03
	
	;---------- PRÜFEN KUNDENSPERRE/KREDITLIMIT; FIS,05.10.2001
	
	;NEW KUNDE1,NR,AUFWERT,curLimit
	new objCust,idLine,curValue,curLimit,idCreditEntity,numDebtor,strBalance,SUM,idCust,idxCreditEntity,blnAdded
 
	SET SPERRE=""
	IF $GET(YTEST)'=$$$YES  && (YKUNDE'="") && $DATA(^INKUNDE(YM,YKUNDE,1)) {
		SET objCust=$get(^INKUNDE(YM,YKUNDE,1))
		
		IF +$$$INKUNDECustomerFlags(objCust)=1 {
			//SR14723: Meaningful error message
			set SPERRE=$$$Text($listbuild("IN00492",YKUNDE))  ;Customer %1 is suspended.
			//SET SPERRE=$$^WWWTEXT(32231)_" "_$$^WWWTEXT(10004)  ;KUNDE GESPERRT ;customer DISABLED 
			
		} elseif (YBELEG=6) || (YBELEG=2) && ($$$INVORGCredLimitForDistribution($GET(^INVORG(YM,YM,1)))) {
			
			SET curValue=0
			SET idLine=""		;ERMITTELN AUFTRAGSWERT POSITIONSDRUCK ;find 
			FOR {
				SET idLine=$ORDER(YAUFTRAG(idLine)) QUIT:idLine=""
				SET curValue=curValue+$$$INAUFPNetSalesPrice($GET(^INAUFP(YM,YAUFTRAG,idLine,1)))
			}
			
			IF curValue=0 {		;ERMITTELN AUFTRAGSWERT GESAMTDRUCK ;find
				FOR {
					SET idLine=$ORDER(^INAUFP(YM,YAUFTRAG,idLine)) QUIT:idLine=""
					SET curValue=curValue+$$$INAUFPNetSalesPrice($GET(^INAUFP(YM,YAUFTRAG,idLine,1)))
				}
			}
			
			IF curValue'=0 {
				set idCreditEntity = $$$INKUNDECreditEntity(objCust)
				if idCreditEntity'="" {
					SET objCust=$get(^INKUNDE(YM,idCreditEntity,1))		// Override
				}
				set curLimit = $$$INKUNDECreditLimit(objCust)
				
				IF +curLimit=0 {	// Blank credit limit
					if +$$$INVORGBlankCreditLimitMeans($GET(^INVORG(YM,YM,1)))=1 {
						SET SPERRE=$$^WWWTEXT(32217)      ;KEIN KREDIT ;no credit 
					}
					
				} elseif curLimit<curValue {
					//SR14723: Meaningful error message
					set SPERRE=$$$Text($listbuild("IN00493",YKUNDE,$$FormatCurrency^COMTable(curLimit)))  ;Customer %1 has exceeded their limit of %2.
					//SET SPERRE=$$^WWWTEXT(32086)      ;KREDITLIMIT ÜBERZOGEN
					
				} else {
					SET SUM=0
					SET numDebtor=$$$INKUNDEDebtorNumber(objCust)
					
					if numDebtor'="" {
						set strBalance = $$^INSALDO(numDebtor)
						
						IF $FIND(strBalance,"S") || $FIND(strBalance,"D") {
							SET SUM=SUM+strBalance
						} elseif $FIND(strBalance,"H") || $FIND(strBalance,"K") {
							SET SUM=SUM-strBalance
						}
						set blnAdded(numDebtor)=$$$YES //SR14486
					}
					
					if idCreditEntity'="" {	
						set idxCreditEntity = $$^WWWUMLAU(idCreditEntity,1)
						
						SET idCust=""
						FOR {
							SET idCust=$ORDER(^INKUNDEs(YM,8,idxCreditEntity,idCust))
							QUIT:idCust=""
							
							SET numDebtor=$$$INKUNDEDebtorNumber($GET(^INKUNDE(YM,idCust,1)))
							if numDebtor'="" && '$get(blnAdded(numDebtor)) {
								
								set strBalance = $$^INSALDO(numDebtor)
								IF $FIND(strBalance,"S") || $FIND(strBalance,"D") {
									SET SUM=SUM+strBalance
								} elseif $FIND(strBalance,"H") || $FIND(strBalance,"K") {
									SET SUM=SUM-strBalance
								}
								set blnAdded(numDebtor)=$$$YES
							}
						}
					}
					if curLimit<(SUM+curValue) {
						set SPERRE=$$$Text($listbuild("IN00493",YKUNDE,$$FormatCurrency^COMTable(curLimit)))
					} ; "Customer %1 has exceeded their limit of %2."
				}
			}
		}
	}
	
	; "Cannot print order %1. Reason: %2"
	IF SPERRE'="" WRITE $$$Text($listbuild("IN00494",YAUFTRAG,SPERRE)) DO FF^WWWW() DO UNLOCK QUIT
	
	SET YREF=YAUFTRAG_".0"
	FOR DRUCK=1:1 SET YREF=$ORDE]]><![CDATA[R(^INDMS(YM,YREF)) QUIT:YREF=""  QUIT:$PIECE(YREF,".",1)'=YAUFTRAG   ;BEC;24.11.04;26820
	
	; FIXME: Is this check needed??? Why 120 times, if at all?
	
	IF DRUCK>120 IF +$$^WWWBEDBER(YBED)'=1 WRITE $$^WWWTEXT(34051),"<br>",$$^WWWTEXT(32292)," ",YAUFTRAG QUIT    ;Aus Sicherheitsgründen, dürfen nur max. 120 Belegkopien pro Auftrag oder Angebot gedruckt und gespeichert werden.
	SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")  ;NEXT NUMBER ;REFFERENZNUMMER
	IF $EXTRACT($REVERSE(YREF))=0 FOR  QUIT:$EXTRACT($REVERSE(YREF))'=0  DO
	. SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")
	
	KILL ^INDMS(YM,YREF)  ;LÖSCHEN ALTES DOKUMENT ;Delete paper 
	SET YDATUM=$$^WWWDATE(YDATE)
	SET LFN=0  ;LFD ZEILE
	IF $GET(YCOPY)'=1 DO SORT   ;SPEICHERN DATEN WENN KEIN WIEDERHOLUNGSDRUCK ;Save when no 
	DO DRUCK   ;DRUCKEN BELEG ;print proof 
	
	;I YMSPRACHE'=SPRACHE S SPRACHE=YMSPRACHE S LFN=0 D DRUCK  ;ÜBERSETZTUNG ;printing 
	IF +$PIECE(YBELEG1,Y,2)=0 SET $PIECE(YBELEG1,Y,2)=1
	
	IF YREF'="" SET ^INDMSSEND(YM,+$HOROLOG,+YSEND,+YBELEG,YREF,1)=$GET(YAUFTRAG)_Y_$GET(YKUNDE)_Y_$GET(YLIEFER)  ;SAMMELSENDUNG;
	
	IF YHTML=1  DO ^INDRUCKXMLTR(YREF) SET YSEND=YHTMLSEND  ;FIS;18.06.03;23781;DRUCKEN HTML BELEGE
	IF YSTDIF=1 DO ^INDRUCKXMLIF(YREF) SET YSEND=YHTMLSEND  ;FIS;20.02.04;25177;AUFBEREITEN DATEN FÜR SCHNITTSTELLE
	
	SET $Y=0
	IF +YSEND'=0 SET $PIECE(YBELEG1,Y,2)=1  ;NUR EIN FAX/MAIL/XML ;only uni- 
	
	;SET $PIECE(YBELEG1,Y,2)=1  ;ANZEIGEN AUFBEREITETE DATEI
	FOR DRUCK=1:1:$PIECE(YBELEG1,Y,2) DO   ;ANZAHL DER BELEGE AUF BILDSCHIRM AUCH BEI FAX ;Number the upon monitor too next to 
	. IF +YSEND=9 QUIT
	. NEW YVOR,YRUECK
	. SET YVOR=""
	. IF $GET(YFORM)="" SET YFORM="INAUF"
	. IF YFORM'="" SET YVOR=$GET(^WWW120(0,YFORM,1))
	. SET $PIECE(YVOR,Y,9)=$PIECE(YBELEG1,Y,7)  ;SCHRIFTART
	. SET $PIECE(YVOR,Y,7)=$PIECE(YBELEG1,Y,8)   ;GRÖSSE
	. SET YRUECK=""
	. IF YHTML=1 SET YRUECK=1 NEW YFORM 
	. DO ^INDMS(YREF,YRUECK)
	. IF $PIECE(YBELEG1,Y,71)=1 DO FF^WWWW() DO ^INDRUCK9 ;AGBS DRUCKEN ;print 
	. IF $PIECE(YBELEG1,Y,2)'=1 IF DRUCK'=$PIECE(YBELEG1,Y,2) IF $GET(VORG(99))'=1 DO FF^WWWW()  ;SEITENVORSCHUB;TYBD;30,07,2003
	
	;SPEICHERN INDMSA UND DOKUMENTENMANAGEMENT ;Save And 
	;DO INDMSA              ;BEC;25807;28.05.04;ERST NACH PROGRAMMSTAND EINSCHALTEN
	IF YSEND=2 DO  ;VERSENDEN FAX
	. NEW VORG
	. SET VORG(1)=YFAX
	. SET VORG(2)=""
	. SET YSEITE=""
	. FOR  SET YSEITE=$ORDER(^INDMS(YM,YREF,YSEITE)) QUIT:YSEITE=""  DO
	. . FOR LFN=1:1:$PIECE(YBELEG1,Y,3) DO
	. . . IF '$DATA(^INDMS(YM,YREF,YSEITE,LFN,1)) SET ^INDMS(YM,YREF,YSEITE,LFN,1)=""
	. . . SET VORG(2)=VORG(2)_$GET(^INDMS(YM,YREF,YSEITE,LFN,1))_" |"
	. DO ^WWWFAX
	
	;VERSENDEN PER E-MAIL
	IF (YSEND=1) || (YSEND=3) || (YSEND=4) || (YSEND=6) DO   ;E-MAIL/XML/EDIFACT/EDIPRO/STANDARDSCHNITTSTELLE
	. IF YMAIL="" SET YMAIL=$PIECE(YADRES,Y,24)  ;SENDEN AN ;transmit upon 
	. IF YMAIL="" QUIT
	. SET BETR=$PIECE(YBELEG1,Y,23)_" "_YAUFTRAG  ;BETREFF SETZEN ;typeset 
	. SET OK=$$^INMAILSEND(YREF,YMAIL,BETR,1,2,$PIECE(YBELEG1,Y,202))
	
	;ALS FTP-DATEI BEREITSTELLEN ;when 
	IF YSEND=5 DO   ;FTP
	. NEW YADR,BETR
	. SET YADR=YKUNDE
	. IF YKUNDE="" SET YADR=YLIEFER
	. SET BETR=$PIECE(YBELEG1,Y,23)_" "_YAUFTRAG  ;BETREFF SETZEN ;typeset 
	. SET OK=$$^INFTP(YREF,YADR,BETR)
	. IF OK=1 WRITE "<font-color=green>"_$$^WWWTEXT(33075)_"</font>" QUIT  ;ZUM FTP DOWNLOAD BEREITGESTELLT
	. WRITE "<font COLOR="_YRED_">"_$$^WWWTEXT(33029)_"</font>"  ;FEHLER ;shortcoming 
	
	;PDF DATEI ERSTELLEN ;data file 
	IF YSEND=7 DO
	. FOR DRUCK=1:1:$PIECE(YBELEG1,Y,2) DO   ;ANZAHL DER BELEGE AUF BILDSCHIRM AUCH BEI FAX ;Number the upon monitor too next to 
	. . NEW YVOR
	. . SET YVOR=""
	. . IF $GET(YFORM)="" SET YFORM="INAUF"
	. . IF YFORM'="" SET YVOR=$GET(^WWW120(0,YFORM,1))
	. . SET $PIECE(YVOR,Y,9)=$PIECE(YBELEG1,Y,7)  ;SCHRIFTART
	. . SET $PIECE(YVOR,Y,7)=$PIECE(YBELEG1,Y,8)   ;GRÖSSE
	. . DO ^INDMSPDF(YREF)
	
	;ERSTELLEN DATEI FÜR STANDARDSCHNITTSTELLE ;data file to 
	IF YSEND=9 DO  QUIT  ;KEINE WEITERE BEARBEITUNG ;no adaptation 
	. DO ^INSTDIF(YREF)
	. DO ^INDMS(YREF)
	. DO INDMSA                ;BEC;25807;28.05.04;ERST nach Programmstand (siehe servive) ausschalten
	. DO UNLOCK
	
	;SPEICHERN INDMSA UND DOKUMENTENMANAGEMENT ;Save And 
	DO INDMSA                 ;BEC;25807;28.05.04;ERST nach Programmstand (siehe servive) ausschalten
	
	;IF $GET(YCOPY)=1!($GET(YTEST)=1) I YSEND'=3 I YSEND'=4 I YSEND'=6 KILL ^INDMS(YM,YREF)   ;NICHT SPEICHERN, DA COPY ODER TEST, KEIN KILL BEI EDI
	IF $PIECE($GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1)),Y,175)=1 KILL ^INDMS(YM,YREF)  ;KEINE SPEICHERUNG ;no 
	
	;AKTIONS E-MAIL SCHICKEN ;transmit 
	IF YCOPY'=1 IF (YBELEG=3) || (YBELEG=6) DO  ;E-MAIL AN KUNDE BEI BESTELLDRUCK / LIEFERSCHEINDRUCK ;upon customer next to 
	. IF YBELEG=3 QUIT:'$DATA(^INAKTIONMAIL(YM,1,1))  ;BESTELLDRUCK
	. IF YBELEG=6 QUIT:'$DATA(^INAKTIONMAIL(YM,2,1))  ;LF-DRUCK
	. NEW BRIEF,BRIEF1,MAIL,POS,REL,KUNDE,KEY,YOK,SATZ,YFORM,XAUFTRAG
	. IF YBELEG=3 SET BRIEF=$PIECE($GET(^INAKTIONMAIL(YM,1,1,1)),Y,1)
	. IF YBELEG=6 SET BRIEF=$PIECE($GET(^INAKTIONMAIL(YM,2,1,1)),Y,1)
	. QUIT:BRIEF=""
	. SET BRIEF1=$GET(^INBRIEF(YM,BRIEF,1))
	. QUIT:BRIEF1=""
	. SET KUNDE=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,1)
	. SET POS=""
	. MERGE XAUFTRAG=YAUFTRAG
	. DO:KUNDE'=""  IF KUNDE="" FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  SET REL="" FOR  SET REL=$ORDER(^INAUFPREL(YM,YAUFTRAG,POS,REL)) QUIT:REL=""  SET KUNDE=$PIECE($GET(^INAUFPREL(YM,YAUFTRAG,POS,REL,1)),Y,3) DO:KUNDE'=""  ;HOLEN DATEN AUS RELEASE ;send for out of 
	. . NEW YAUFTRAG
	. . KILL YAUFTRAG
	. . IF POS'="" SET YAUFTRAG=XAUFTRAG SET YAUFTRAG(POS,REL)=""  ;NOTWENDIG FÜR ^INAKTIONMAIL BEI RELEASE
	. . IF (POS="") || (YBELEG=6) KILL YAUFTRAG MERGE YAUFTRAG=XAUFTRAG  ;RÜCKHOLEN ALTE DATEN WENN KEIN RELEASE ;when no 
	. . SET MAIL=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,24)  ;E-MAIL ADRESSE ;address 
	. . QUIT:MAIL=""
	. . SET KEY=$$^WWWNEXT("INMAILJOB")
	. . SET SATZ=""
	. . SET $PIECE(SATZ,Y,3)=MAIL                ;EMPFÄNGER ;recipient 
	. . SET $PIECE(SATZ,Y,4)=$PIECE(BRIEF1,Y,2)  ;BETREFF
	. . SET $PIECE(SATZ,Y,6)=0                   ;OHNE BILDER ;without imagery 
	. . SET $PIECE(SATZ,Y,7)=0                   ;PLAIN TEXT
	. . SET $PIECE(SATZ,Y,8)=KUNDE               ;REFERENZ FÜR INDMS ;reference to 
	. . IF YBELEG=3 SET $PIECE(SATZ,Y,5)=$$BESTELLUNG^INAKTIONMAIL($PIECE(BRIEF1,Y,5))  ;TEXT
	. . IF YBELEG=6 SET $PIECE(SATZ,Y,5)=$$LIEFERSCHEIN^INAKTIONMAIL($PIECE(BRIEF1,Y,5))  ;TEXT
	. . ;SPEICHERN IN MAILAUSGANG ;Save within 
	. . SET YOK=$$^WWWSPEI("INMAILJOB",KEY,SATZ,1)
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;;IF +YSEND=0 IF YMSPRACHE'=SPRACHE SET SPRACHE=YMSPRACHE DO  ;WENN SPRACHENTEXT, DANN WIEDERHOLUNG IN EINGENSPRACHE ;AUSGESCHALTET;FIS;19.04.04;25558
	. SET YCOPY=0
	. IF YBELEG=9 QUIT  ;KEINE KOPIE BEI BEREITSTELLUNG;TYBD;8,1,04
	. SET YBELEG1=$GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1))  ;DRUCKPARAMETER FÜR BELEGE ;to 
	. IF +$PIECE(YBELEG1,Y,3)=0 SET $PIECE(YBELEG1,Y,3)=$PIECE($GET(^WWW012(0,YM,1)),Y,16)
	. SET YREF=YAUFTRAG_".0"
	. FOR DRUCK=1:1 SET YREF=$ORDER(^INDMS(YM,YREF)) QUIT:YREF=""  QUIT:$EXTRACT(YREF,1,$LENGTH(YAUFTRAG))'=YAUFTRAG
	. IF DRUCK>100 QUIT   ;FEHLER IN BEARBEITUNG ;shortcoming within adaptation 
	. SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")  ;NEXT NUMBER ;REFFERENZNUMMER
	. IF $EXTRACT($REVERSE(YREF))=0 FOR  QUIT:$EXTRACT($REVERSE(YREF))'=0  DO
	. . SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")
	. KILL ^INDMS(YM,YREF)  ;LÖSCHEN ALTES DOKUMENT ;Delete paper 
	. SET YDATUM=$$^WWWDATE(YDATE)
	. SET LFN=0  ;LFD ZEILE
	. IF YBELEG=7!(YBELEG=17)!(YBELEG=12) SET YCOPY=1
	. NEW YSAMMEL,YTRANSLATE  ;KEINE WIEDERHOLTE SAMMELDRUCKAUFBEREITUNG ;no 
	. SET YTRANSLATE=1
	. SET $PIECE(YBELEG1,Y,56)=0  ;KEINE PREISE BEI ÜBERSETZUNG;FIS;19.04.04;25558
	. SET $PIECE(YBELEG1,Y,58)=0
	. SET $PIECE(YBELEG1,Y,62)=0
	. DO DRUCK  ;ÜBERSETZTUNG
	. NEW YVOR
	. SET YVOR=^WWW120(0,YFORM,1)
	. SET $PIECE(YVOR,Y,9)=$PIECE(YBELEG1,Y,7)  ;SCHRIFTART
	. SET $PIECE(YVOR,Y,7)=$PIECE(YBELEG1,Y,8)   ;GRÖSSE
	. DO ^INDMS(YREF)
	. KILL ^INDMS(YM,YREF) 
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	IF YVERBAND'="" IF $PIECE(YVERBAND1,Y,71)=2 DO  ;RECHNUNGSKOPIE AN VERBANDSADRESSE ;WEM VORSCHLAG;KEIN DOPPELDRUCK BEI XML;HINZUFÜGEN IF +YSEND=0
	. SET YCOPY=1
	. SET $PIECE(YVERBAND1,Y,71)=1  ;VERBAND ERHÄLT RECHNUNG ;ligature tab 
	. SET YBELEG1=$GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1))  ;DRUCKPARAMETER FÜR BELEGE ;to 
	. IF +$GET(YSEND)'="" IF $DATA(^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$get(YSEND),1)) do     ;BEC;25224;21.05.04;BELEGDRUCK PRO VERSANDART
	. . SET YBELEG1=^INDRPARAB(YM,YBETRIEB,YBELEG,SPRACHE,+$get(YSEND),1)
	. IF +$PIECE(YBELEG1,Y,3)=0 SET $PIECE(YBELEG1,Y,3)=$PIECE($GET(^WWW012(0,YM,1)),Y,16)
	. SET YREF=YAUFTRAG_".0"
	. FOR DRUCK=1:1 SET YREF=$ORDER(^INDMS(YM,YREF)) QUIT:YREF=""  QUIT:$EXTRACT(YREF,1,$LENGTH(YAUFTRAG))'=YAUFTRAG
	. IF DRUCK>100 QUIT   ;FEHLER IN BEARBEITUNG ;shortcoming within adaptation 
	. SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")  ;NEXT NUMBER ;REFFERENZNUMMER
	. IF $EXTRACT($REVERSE(YREF))=0 FOR  QUIT:$EXTRACT($REVERSE(YREF))'=0  DO
	. . SET YREF=YAUFTRAG_"."_$$^WWWNEXT("INDRPARA")
	. ;
	. KILL ^INDMS(YM,YREF)  ;LÖSCHEN ALTES DOKUMENT ;Delete paper 
	. SET YDATUM=$$^WWWDATE(YDATE)
	. IF YREGUL=1 SET YCOPY=0
	. SET $PIECE(YAUFTRAG1,Y,96)=$PIECE(YAUFTRAG1,Y,96)_"("_$$^WWWTEXT(32097)_")"  ;KOPIE ;copy 
	. DO INDMSA
	. SET $PIECE(YAUFTRAG1,Y,96)=$PIECE($PIECE(YAUFTRAG1,Y,96),"(",1)
	. SET LFN=0  ;LFD ZEILE
	. SET YCOPY=1
	. DO DRUCK  ;WIEDERHOLUNGSDRUCK
	. NEW YVOR
	. SET YVOR=^WWW120(0,YFORM,1)
	. SET $PIECE(YVOR,Y,9)=$PIECE(YBELEG1,Y,7)  ;SCHRIFTART
	. SET $PIECE(YVOR,Y,7)=$PIECE(YBELEG1,Y,8)   ;GRÖSSE
	. DO ^INDMS(YREF)
	. IF YREGUL'=1 KILL ^INDMS(YM,YREF) 
	. SET YREGUL=0
	
	SET YCOPY=0
	DO UNLOCK
	
	IF YBELEG=6,YSEND=0,$GET(YKUNDE)'="",$GET(YAUFTRAG)'="",$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,312)=1 {
		//FIS;12.07.04;25693;RECHNUNG MIT LIEFERSCHEIN DRUCKEN ;tab by means of packing slip print 
		NEW YNOCOPY
		SET YNOCOPY=1
		DO FF^WWWW()
		DO SHIP^INRECH1
	}
	QUIT
	
	
UNLOCK ;FREIGEBEN LOCK
	;do CleanUpLocks^WWW006(XUSER,$$$YES) // SR14924
	QUIT:'$DATA(XPROT)
	
	NEW DATEI1
	
	SET DATEI1 = ""
	FOR {
		SET DATEI1 = $ORDER(XPROT(DATEI1))
		QUIT:DATEI1=""
		
		KILL ^WWW006(0,+$HOROLOG,DATEI1,1)  ;FREIGEBEN LOCK
	}
	QUIT
	
	
INDMSA ;SPEICHERN INDMSA UND DOKUMENTENMANAGEMENT ;Save And 
	;IF $GET(YCOPY)'=1 IF $GET(YTEST)'=1 DO   ;KOPIE;TYBD;24076;KOPIE AUCH SPEICHERN
	IF $GET(YTEST)'=$$$YES  DO                ;KOPIE;TYBD;24076;KOPIE AUCH SPEICHERN
	. QUIT:$PIECE($GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1)),Y,175)=1  ;BELEG NICHT SPEICHERN ;proof Not Save 
	. NEW SATZ,YBESCHR,YVERSAND
	. SET (SATZ,YBESCHR,YVERSAND)=""
	. IF $DATA(^WWW101(0,"MEDIUM1",SPRACHE,+YSEND,1)) SET YVERSAND=$PIECE($GET(^WWW101(0,"MEDIUM1",SPRACHE,+YSEND,1)),Y,1)
	. IF $DATA(^WWW101(0,"BELEG",SPRACHE,YBELEG,1))   SET YBESCHR =$PIECE($GET(^WWW101(0,"BELEG",SPRACHE,YBELEG,1)),Y,1)
	. IF YBELEG=1  SET YBESCHR=YBESCHR_" "_YAUFTRAG                 ;ANGEBOT ;proposition 
	. IF YBELEG=2  SET YBESCHR=YBESCHR_" "_$PIECE(YAUFTRAG1,Y,78)   ;AB ;Confirm. 
	. IF YBELEG=6  SET YBESCHR=YBESCHR_" "_$PIECE(YAUFTRAG1,Y,91)   ;LIEFERSCHEIN ;packing slip 
	. IF YBELEG=7  SET YBESCHR=YBESCHR_" "_$PIECE(YAUFTRAG1,Y,96)   ;RECHNUNG ;tab 
	. IF YBELEG=17 SET YBESCHR=YBESCHR_" "_$PIECE(YAUFTRAG1,Y,96)   ;GUTSCHRIFT
	. IF YBELEG=12 DO  ;ANZAHLUNGSRECHNUNG
	. . IF $PIECE($GET(YFELDPZ),Y,14)'="" SET YBESCHR=$PIECE($GET(^INPARA(YM,"INAUFPZ",SPRACHE,$PIECE(YFELDPZ,Y,14),1)),Y,1)
	. . SET YBESCHR=YBESCHR_" "_$PIECE($GET(YFELDPZ),Y,7)
	. ;
	. SET $PIECE(SATZ,Y,1)=+$HOROLOG  ;DRUCKDATUM
	. SET $PIECE(SATZ,Y,2)=YBED  ;MITARBEITER
	. SET $PIECE(SATZ,Y,3)=YBESCHR  ;INHALT ;purport 
	. SET $PIECE(SATZ,Y,4)=YVERSAND  ;VERSANDART
	. SET $PIECE(SATZ,Y,6)=$PIECE($GET(^INVORG(YM,YM,1)),Y,46)  ;SPEICHERADRESSE DOKUMENTENMANAGEMENT
	. SET $PIECE(SATZ,Y,7)=$PIECE($GET(^INVORG(YM,YM,1)),Y,47)  ;ABRUF URL
	. SET $PIECE(SATZ,Y,8)=1  ;ANGEBOT/ANFRAGE
	. IF YBELEG'=1 IF YBELEG'=10 IF $GET(YPROFORMA)'=1 SET $PIECE(SATZ,Y,8)=2  ;AUFTRAG ;mandate  ;order 
	. SET $PIECE(SATZ,Y,11)=YBELEG   ;BELEGART
	. SET $PIECE(SATZ,Y,12)=YAUFTRAG   ;AUFTRAGSNUMMER ZUR SUCHE ;search 
	. IF $PIECE(SATZ,Y,6)'="" SET OK=$$^INMAILSEND(YREF,$PIECE(SATZ,Y,6),YREF,0,1)
	. IF $GET(OK)'=1 SET $PIECE(SATZ,Y,7)=""
	. IF $GET(YCOPY)=1 SET $PIECE(SATZ,Y,20)=1    ;KOPIE;TYBD;24076;KOPIE AUCH SPEICHERN
	. DO
	. . NEW YFORM,YVOR
	. . SET OK=$$^WWWSPEI("INDMSA",YREF,SATZ,1)
	
	IF $GET(YSUMINVOICE)=1 DO  ;COPY DER REFFERENZ AN ALLE AUFTÄGE;TYBD;31,1,2005
	. NEW YAUFTRAG,YREF1
	. QUIT:$PIECE($GET(^INDRPARA(YM,YBETRIEB,YBELEG,SPRACHE,1)),Y,175)=1  ;BELEG NICHT SPEICHERN ;proof Not Save 
	. ;
	. SET YAUFTRAG=""
	. FOR  SET YAUFTRAG=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAG)) QUIT:YAUFTRAG=""  DO
	. . QUIT:YAUFTRAG=$PIECE(YREF,".",1)  ;SCHON GESPEICHERT
	. . SET YREF1=YAUFTRAG_"."_$PIECE(YREF,".",2)
	. . MERGE ^INDMS(YM,YREF1)=^INDMS(YM,YREF)
	. . DO   ;SPEICHERN DER REFFERENZ ZUR SUCHE
	. . . NEW YFORM,YVOR,SATZ
	. . . ;W YREF_"/"_YREF1_"--"
	. . . SET SATZ=$GET(^INDMSA(YM,YREF,1))
	. . . ;W SATZ,".."
	. . . SET $PIECE(SATZ,Y,12)=YAUFTRAG 
	. . . SET OK=$$^WWWSPEI("INDMSA",YREF1,SATZ,1)
	
	QUIT
	
DRUCK    ;PRINT START
	
	NEW YFORM
	
	SET YSEITE=1
	SET YVOLUMEN=0
	SET YKILO=0
	SET YUEBERTRAG=0  ;NOCH KEIN ÜBERTRAG ;yet no 
	
	IF (YBELEG=3) || (YBELEG=13) DO       ;BEC;04.01.05;27056
	. IF $GET(YKUNDE)'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,229)=1 DO
	. .IF $PIECE(YBELEG1,Y,191)=1 DO
	. . . IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,247)'="" SET $PIECE(YBELEG1,Y,12)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,247)
	. . . IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,248)'="" SET $PIECE(YBELEG1,Y,76)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,248)
	. . ;
	. . IF $PIECE(YBELEG1,Y,191)'=1 IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,241)'="" DO
	. . . SET $PIECE(YBELEG1,Y,5)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,241)
	. . . SET $PIECE(YBELEG1,Y,4)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,241)
	
	DO
	. SET A=YCR_YCR_"<PRE>"  ;TEXT VORBEREITUNG ;Text preparation 
	. IF $PIECE(YBELEG1,Y,191)=1 IF $FIND($PIECE(YBELEG1,Y,12),"<PRE>") SET A=YCR_YCR     ;BEC;26964;09.12.04
	. IF (YSEND=1) || (YSEND=2) IF $FIND($PIECE(YBELEG1,Y,12),"<PRE>") SET A=YCR_YCR           ;BEC;26964;09.12.04;SPÄTER IM ABSENDERTEXT
	. IF $GET(YVOR)'="" DO
	. . SET YFACE=$PIECE(YVOR,Y,9)
	. . SET YSIZE=$PIECE(YVOR,Y,7)
	. . SET YFACE=$PIECE(YBELEG1,Y,7)      ;BEC;25440;26.03.04
	. . IF YFACE'="" IF YFACE'=10 IF YFACE'=19 SET YFACE=""  ;FIS;20.07.04 ;UNGÜLTIGE SCHRIFTARTEN
	. . SET YSIZE=$PIECE(YBELEG1,Y,8)
	. . ;IF YFACE'="" DO
	. . IF (YFACE'="") || (YSIZE'="") DO  ;FIS;14.07.04;SIZE AUCH OHNE FACE SETZEN ;too without typeset 
	. . . SET A=A_"<FONT"
	. . . IF YFACE'="" SET A=A_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . . IF YSIZE'="" SET A=A_" SIZE="_YSIZE
	. . . SET A=A_">"
	. ;
	. IF YSEND=3 DO  ;XML VORBEREITUNG ;XML preparation 
	. . NEW YISO
	. . SET A=YCR_"<?xml version="_""""_"1.0"_""""
	. . SET YISO=$PIECE($GET(^WWW012(0,YM,1)),Y,76)  ;zeichensatz suchen ;seek 
	. . IF YISO'="" SET YISO=$PIECE($GET(^WWW100(0,"CHARSET",SPRACHE,YISO,1)),Y,1)
	. . IF YISO=""  SET YISO="iso-8859-1"
	. . IF YISO'="" SET A=A_" encoding="_""""_YISO_""""
	. . SET A=A_"?>"
	. . SET A=A_YCR_"<!DOCTYPE "_$$^WWWUMLAU($TRANSLATE($PIECE(YBELEG1,Y,23)," "),1)_".dtd"_"> "_YCR_"<DATA>"
	. ;
	. IF YSEND=4 SET A=""  ;EDI VORBEREITUNG ;EDI preparation 
	. IF YSEND=6 SET A=""  ;EDIPRO VORBEREITUNG ;preparation 
	. ;
	. SET LFN=0
	. SET ^INDMS(YM,YREF,YSEITE,LFN,1)=A
	. SET A=YCR
	
	IF (YSEND<3) || (YSEND=5) || (YSEND=7) DO  ;TEXT    ;BEC;28.04.03;GEÄNDERT AUCH FÜR PDF
	. DO ^INDRUCK1   ;FIRMENKOPF
	. DO ^INDRUCK2   ;Address
	. DO ^INDRUCK3   ;HINWEISE - References
	. DO ^INDRUCK4   ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	. DO ^INDRUCK41  ;BETREFFTEXT
	. DO ^INDRUCK5   ;Heading
	. DO ^INDRUCK6   ;Line Items
	. DO ^INDRUCK6W  ;WERBUNG
	. DO ^INDRUCK7   ;Foot
	. DO ^INDRUCK8   ;HINWEIS
	. DO ^INDRUCK81  ;BEC;27122;BEC;28.02.05
	. IF $PIECE(YBELEG1,Y,193)=1 IF $PIECE(YAUFTRAG1,Y,262)=1 DO            ;BILD DRUCK ;portrait printing 
	. . NEW YFACE1,YFACE2,YFACE,ASIZE,POS,POS1,BILD
	. . SET YFACE1=""
	. . SET YFACE2=""
	. . SET YFACE=$PIECE(YBELEG1,Y,7)
	. . SET YSIZE=$PIECE(YBELEG1,Y,8)
	. . IF (YFACE'="")!(YSIZE'="") DO
	. . . SET YFACE1="<FONT"
	. . . IF YFACE'="" SET YFACE1=YFACE1_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . . IF YSIZE'="" SET YFACE1=YFACE1_" SIZE="_""""_YSIZE_""""
	. . . SET YFACE1=YFACE1_">"
	. . . SET YFACE2="</FONT>"
	. . ;
	. . SET POS=""
	. . FOR  SET POS=$ORDER(YAUFTRAG(POS)) QUIT:POS=""  DO
	. . . IF (YBELEG'=1) && (YBELEG'=10) SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))      ;AUFTRAG ;mandate  ;order 
	. . . IF (YBELEG=1) || (YBELEG=10)   SET POS1=$GET(^INANGP(YM,YAUFTRAG,POS,1))         ;ANGEBOT  ;proposition 
	. . . SET BILD=$PIECE(POS1,Y,54)
	. . . QUIT:BILD=""
	. . . SET A=YCR_"<CENTER>"_YFACE1_$PIECE(POS1,Y,1)_YFACE2_"<BR>" 
	. . . SET A=A_"<IMG SRC="_YGIF1_BILD_" BORDER=0></CENTER>"
	. . . SET LFN=1
	. . . SET YSEITE=YSEITE+1
	. . . DO SPE
	. . . SET A=""
	
	DO ZUSATZ
	
	
	IF YSEND=3 DO       ;XML
	. DO ^INDRUCKXML1   ;FIRMENKOPF
	. DO ^INDRUCKXML2   ;ANSCHRIFT
	. DO ^INDRUCKXML3   ;HINWEISE
	. DO ^INDRUCKXML4   ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	. DO ^INDRUCKXML41  ;BETREFFTEXT
	. DO ^INDRUCKXML6   ;POSITIONEN
	. DO ^INDRUCKXML7   ;FUSS
	. DO ^INDRUCKXML8   ;HINWEIS
	. DO XML^INDRUCK(,,,"</DATA>")  ;ENDE ;termination 
	
	IF YSEND=99 DO      ;HTML
	. DO ^INDRUCKXML1   ;FIRMENKOPF
	. DO ^INDRUCKXML2   ;ANSCHRIFT
	. DO ^INDRUCKXML3   ;HINWEISE
	. DO ^INDRUCKXML4   ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	. DO ^INDRUCKXML41  ;BETREFFTEXT
	. DO ^INDRUCKXML6   ;POSITIONEN
	. DO ^INDRUCKXML7   ;FUSS
	. DO ^INDRUCKXML8   ;HINWEIS
	. DO XML^INDRUCK(,,,"</DATA>")  ;ENDE ;termination 
	
	IF YSEND=4 DO    ;EDIFACT
	. NEW YUNH,YUNB
	. ;START ;take-off 
	. SET YUNB=$$^WWWNEXT("EDIUNB")
	. DO EDI("UNB+UNOA+"_$PIECE($GET(^INVORG(YM,YM,1)),Y,101)_"+"_$PIECE($GET(YADRES),Y,201)_"+"_$ZDATE($HOROLOG,8)_":"_$TRANSLATE($ZTIME($PIECE($HOROLOG,",",2),2),":")_"+"_$GET(YUNB))
	. DO ^INDRUCKEDI4   ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	. DO ^INDRUCKEDI3   ;HINWEISE
	. DO ^INDRUCKEDI1   ;FIRMENKOPF
	. DO ^INDRUCKEDI2   ;ANSCHRIFT
	. DO ^INDRUCKEDI41  ;BETREFFTEXT
	. DO ^INDRUCKEDI6   ;POSITIONEN
	. DO EDI("UNS+S")   ;SUMME ;sum 
	. DO ^INDRUCKEDI7   ;FUSS
	. DO ^INDRUCKEDI8   ;HINWEIS
	. ;
	. SET YUNH=$$^WWWNEXT("EDIUNH")
	. SET A=YCR_"UNH+"_YUNH_"+"
	. SET $PIECE(A,"+",3)=$PIECE("REQOTE:D:96A:UN:EAN008,ORDRSP:D:96A:UN:EAN008,ORDERS:D:96A:UN:EAN008,,,DELFOR:D:96A:UN:EAN008,INVOICE:D:96A:UN:EAN008,,,QUOTES:D:96A:UN:EAN008,,INVOICE:D:96A:UN:EAN008,,,,,INVOICE:D:96A:UN:EAN008",",",YBELEG)  ;BELEGART
	. SET ^INDMS(YM,YREF,1,0,1)=A_"'"
	. ;
	. DO EDI("UNS+S")                            ;ENDE SUMME ;termination sum 
	. IF YBELEG=6 DO EDI("MOA+86:"_+$GET(YMOA))  ;KONTROLL SUMME BETRAG ;sum Sum 
	. DO EDI("CNT+2:"_+$GET(YLIN))               ;ANZAHL POS ;Number 
	. DO EDI("CNT+1:"_+$GET(YQTY))               ;ANZAHL DER MENGEN ;Number the shuffle 
	. DO EDI("UNT+"_($GET(YSEG)+1)_"+"_YUNH)     ;ENDE MESSAGTE ;termination 
	. DO EDI("UNZ+1+"_$GET(YUNB))                ;STOP ALLE
	
	IF YSEND=6 DO    ;EDIPRO
	. NEW YUNH,YUNB
	. ;START ;take-off 
	. SET YUNB=$$^WWWNEXT("EDIUNB")
	. DO EDIP("ISA*00*          *00*          *01*"_$EXTRACT($PIECE($GET(^INVORG(YM,YM,1)),Y,101)_"               ",1,15)_"*01*"_$EXTRACT($PIECE($GET(YADRES),Y,201)_"               ",1,15)_"*"_$EXTRACT($ZDATE($HOROLOG,8),3,10)_"*"_$TRANSLATE($ZTIME($PIECE($HOROLOG,",",2),2),":")_"*U*00401*"_$EXTRACT($GET(YUNB)_"         ",1,9)_"*0*P*>")
	. DO ^INDRUCKEDIP4  ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	. DO ^INDRUCKEDIP3  ;HINWEISE
	. DO ^INDRUCKEDIP2  ;ANSCHRIFT
	. DO ^INDRUCKEDIP6  ;POSITIONEN
	. IF YBELEG=7 DO EDIP("TDS*"_$JUSTIFY($GET(YMOA),0,2))  ;SUMME BETRAG ;sum Sum 
	. DO EDIP("CTT*"_+$GET(YLIN))                           ;ANZAHL POS ;Number 
	. DO EDIP("SE*"_($GET(YSEG)+1)_"*"_$GET(YUNH))          ;ENDE MESSAGTE ;termination 
	. DO EDIP("GE*1*"_$GET(YUNB))                           ;STOP ALLE
	. DO EDIP("IEA*1*"_$GET(YUNB))                          ;STOP ALLE
	
	;DO FF
	
	QUIT
	
ZUSATZ
	IF $PIECE(YBELEG1,Y,181)=1 IF (YBELEG=1) || (YBELEG=10) DO   ;DRUCKEN KOPFSEITE ANGEBOT/ANFRAGE ;print 
	. NEW YFACE1,YFACE2,YI,A,TEXT1
	. SET A(1)=$PIECE(YAUFTRAG1,Y,225)
	. QUIT:A(1)=""
	. SET A="<BR><BR><BR><BR><BR><BR><BR><BR>" 
	. FOR YA(88)=1:1 SET A(2)=$PIECE(A(1),"|",YA(88)) QUIT:$TRANSLATE($PIECE(A(1),"|",YA(88),999),"|")=""  DO
	. . SET A=A_$$^WWWNBSP(A(2))_"<BR>"_YCR
	. ;
	. SET YFACE1=""
	. SET YFACE2=""
	. SET YFACE=$PIECE(YAUFTRAG1,Y,226)
	. SET YSIZE=$PIECE(YAUFTRAG1,Y,227)
	. IF (YFACE'="") || (YSIZE'="") DO
	. . SET YFACE1="<FONT"
	. . IF YFACE'="" SET YFACE1=YFACE1_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . IF YSIZE'="" SET YFACE1=YFACE1_" SIZE="_""""_YSIZE_""""
	. . SET YFACE1=YFACE1_">"
	. . SET YFACE2="</FONT>"
	. ;
	. SET A=YFACE1_A_YFACE2
	. SET LFN=1
	. SET YSEITE=YSEITE+1
	. DO SPE
	. SET A=""
	
	IF $PIECE(YBELEG1,Y,181)=1 IF $PIECE(YAUFTRAG1,Y,2)=0 IF (YBELEG=2) || (YBELEG=6) || (YBELEG=7) || (YBELEG=9) || (YBELEG=12) || (YBELEG=17) DO
	. NEW YFACE1,YFACE2,YI,A,TEXT1
	. SET A(1)=$PIECE(YAUFTRAG1,Y,225)
	. QUIT:A(1)=""
	. SET A="<BR><BR><BR><BR><BR><BR><BR><BR>" 
	. FOR YA(88)=1:1 SET A(2)=$PIECE(A(1),"|",YA(88)) QUIT:$TRANSLATE($PIECE(A(1),"|",YA(88),999),"|")=""  DO
	. . SET A=A_$$^WWWNBSP(A(2))_"<BR>"_YCR
	. ;
	. SET YFACE1=""
	. SET YFACE2=""
	. SET YFACE=$PIECE(YAUFTRAG1,Y,226)
	. SET YSIZE=$PIECE(YAUFTRAG1,Y,227)
	. IF (YFACE'="") || (YSIZE'="") DO
	. . SET YFACE1="<FONT"
	. . IF YFACE'="" SET YFACE1=YFACE1_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . IF YSIZE'="" SET YFACE1=YFACE1_" SIZE="_""""_YSIZE_""""
	. . SET YFACE1=YFACE1_">"
	. . SET YFACE2="</FONT>"
	. ;
	. SET A=YFACE1_A_YFACE2
	. SET LFN=1
	. SET YSEITE=YSEITE+1
	. DO SPE
	. SET A=""
	
	IF $PIECE(YBELEG1,Y,181)=1 IF $PIECE(YAUFTRAG1,Y,2)=2 IF (YBELEG=3) || (YBELEG=13) DO
	. NEW YFACE1,YFACE2,YI,A,TEXT1
	. SET A(1)=$PIECE(YAUFTRAG1,Y,225)
	. QUIT:A(1)=""
	. SET A="<BR><BR><BR><BR><BR><BR><BR><BR>" 
	. FOR YA(88)=1:1 SET A(2)=$PIECE(A(1),"|",YA(88)) QUIT:$TRANSLATE($PIECE(A(1),"|",YA(88),999),"|")=""  DO
	. . SET A=A_$$^WWWNBSP(A(2))_"<BR>"_YCR
	. ;
	. SET YFACE1=""
	. SET YFACE2=""
	. SET YFACE=$PIECE(YAUFTRAG1,Y,226)
	. SET YSIZE=$PIECE(YAUFTRAG1,Y,227)
	. IF (YFACE'="") || (YSIZE'="") DO
	. . SET YFACE1="<FONT"
	. . IF YFACE'="" SET YFACE1=YFACE1_" FACE="_""""_$PIECE($GET(^WWW100(0,"SCHRIFTART",SPRACHE,YFACE,1)),Y,1)_""""
	. . IF YSIZE'="" SET YFACE1=YFACE1_" SIZE="_""""_YSIZE_""""
	. . SET YFACE1=YFACE1_">"
	. . SET YFACE2="</FONT>"
	. ;
	. WRITE YCR
	. SET A=YFACE1_A_YFACE2
	. SET LFN=1
	. SET YSEITE=YSEITE+1
	. DO SPE
	. SET A=""
 
	QUIT
	
FF ;FORM FEED ;shape 
	SET A=$$FF2^WWWW()
	DO SPE
	QUIT
	
SORT ;
	NEW YFORM,YVORG
	
	QUIT:$GET(YTEST)'=""     ;NUR TEST ;only Test 
	DO @YBELEG  ;VERTEILEN AUF BELEGART ;distribute upon 
	
	IF YBELEG'=1 IF YBELEG'=10 IF $GET(YPROFORMA)'=1    SET YA=$$^WWWSPEI("INAUF",YAUFTRAG,YAUFTRAG1,1)  ;SPEICHERN DATEN UND SORTKEY ;Save And 
	IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1) SET YA=$$^WWWSPEI("INANG",YAUFTRAG,YAUFTRAG1,1)  ;SPEICHERN DATEN UND SORTKEY ;Save And 
	QUIT
	
1 ;ANGEBOT ;proposition 
	SET $PIECE(YAUFTRAG1,Y,79)=YDATE                   ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YAUFTRAG1,Y,79)        ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,80)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,81)=YBED                    ;GEDRUCKT VON
	QUIT
	
2 ;AB ;Confirm. 
	IF $PIECE(YBELEG1,Y,24)'=1 SET $PIECE(YAUFTRAG1,Y,78)=$$^WWWNEXT("INAUF"_2)   ;NEUE NUMMER;BELEGNUMMER ERRECHNEN ;numeral 
	IF $PIECE(YBELEG1,Y,24)=1  SET $PIECE(YAUFTRAG1,Y,78)=YAUFTRAG  ;SPEICHERN ;Save 
	SET $PIECE(YAUFTRAG1,Y,79)=YDATE                   ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YAUFTRAG1,Y,79)        ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,80)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,81)=YBED                    ;GEDRUCKT VON
	QUIT
	
3 ;BESTELLUNG ;sales order 
	SET $PIECE(YAUFTRAG1,Y,83)=+$HOROLOG               ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YAUFTRAG1,Y,83)        ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,84)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,85)=YBED                    ;GEDRUCKT VON
	QUIT
	
4 ;
	QUIT
	
5 ;
	QUIT
	
6 ;LIEFERSCHEIN ;packing slip 
	IF $PIECE(YBELEG1,Y,24)'=1 SET $PIECE(YAUFTRAG1,Y,91)=$$^WWWNEXT("INAUF"_6)   ;NEUE NUMMER ;BELEGNUMMER ERRECHNEN ;numeral 
	IF $PIECE(YBELEG1,Y,24)=1  SET $PIECE(YAUFTRAG1,Y,91)=YAUFTRAG  ;SPEICHERN ;Save 
	SET $PIECE(YAUFTRAG1,Y,92)=YDATE                   ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATUM=$PIECE(YAUFTRAG1,Y,92)       ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,93)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,94)=YBED                    ;GEDRUCKT VON
	QUIT
	
    /*-------------------------------------------------------------------------------
    ; Invoice the customer order
    ;
    ; Params: None
    ;
    ; ByRefs: None
    ;
    ; Returns: Nothing
    ;
    ; History:
    ; 19-Jan-2006	PO		SR14109: Ensure invoice number allocated is not already used.
    ;-------------------------------------------------------------------------------*/
7 ;RECHNUNG ;tab 
	set $piece(YAUFTRAG1,Y,96) = $$GetNextInvoiceNumber() ; SR14109
 
	;IF $GET(YPROFORMA)=1  IF $PIECE(YBELEG1,Y,24)'=1 SET $PIECE(YAUFTRAG1,Y,96)=$$^WWWNEXT("INAUF"_7_"P")   ;NEUE NUMMER  ;BELEGNUMMER ERRECHNEN ;numeral  ; SR14109
	;IF $GET(YPROFORMA)'=1 IF $PIECE(YBELEG1,Y,24)'=1 SET $PIECE(YAUFTRAG1,Y,96)=$$^WWWNEXT("INAUF"_7)   ;NEUE NUMMER  ;BELEGNUMMER ERRECHNEN ;numeral  ; SR14109
	;IF $PIECE(YBELEG1,Y,24)=1 SET $PIECE(YAUFTRAG1,Y,96)=YAUFTRAG  ;SPEICHERN ;Save  ; SR14109
	SET $PIECE(YAUFTRAG1,Y,97)=YDATE                   ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YAUFTRAG1,Y,97)        ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,98)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,99)=YBED                    ;GEDRUCKT VON
	
	IF $GET(YSUMINVOICE)=1 DO 7SUM  ;SAMMELRECHNUNG; 29,1,2005;TYBD
	
	;SAP-SD;TYBD;26697;3,2,2005
	IF $FIND(YBELEG,7) IF $PIECE(YAUFTRAG1,Y,96)'="" IF $GET(YKUNDE)'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,68)=1 DO
	. NEW COMPANY
	. IF $GET(YLOCATION)'="" SET COMPANY=$PIECE($GET(^WWW0121(0,YM,YLOCATION,1)),Y,2)  ;BEZEICHNUNG;NAME
	. IF $GET(COMPANY)=""    SET COMPANY=$PIECE($GET(^WWW012(0,YM,1)),Y,1)             ;ALTERNATIVE
	. SET ^INSAPSD(YM,YKUNDE,YDATE,$PIECE(YAUFTRAG1,Y,96),1,1)="00"_$EXTRACT(COMPANY_"                     ",1,20)_$$^WWWDATE(YDATE)
	
	QUIT
 
    /*-------------------------------------------------------------------------------
    ; For a customer invoice (document type 7) determine the invoice number.
    ;
    ; Params: None
    ;
    ; ByRefs: None
    ;
    ; Returns: strCusInvoiceNumber
    ;
    ; @NM variables: YBELEG1, YAUFTRAG1, YAUFTRAG, YPROFORMA, YM, Y
    ;
    ; History:
    ; 18-Jan-2006	PO		SR14109: Created
    ;-------------------------------------------------------------------------------*/
GetNextInvoiceNumber()
	new strCusInvoiceNumber
 
	if $piece(YBELEG1,Y,24) = 1 { ; $$$INDRPARADocumentNumberOrderNumbe
		set strCusInvoiceNumber = YAUFTRAG
		; SR14109
		; TODO:
		; No customer invoices in Adrads setup assign the invoice number to the value of the order number.
		; This needs to be fixed, possibly postfix date & time.
		;if $data(^INREBUCHs(YM,1,strCusInvoiceNumber)) {
		;}
	} else {
		set strCusInvoiceNumber = ""
		do {
			if $get(YPROFORMA) = 1  set strCusInvoiceNumber = $$^WWWNEXT("INAUF7P")
			if $get(YPROFORMA) '= 1 set strCusInvoiceNumber = $$^WWWNEXT("INAUF7")
			if $data(^INREBUCHs(YM,1,strCusInvoiceNumber)) set strCusInvoiceNumber = ""
		} while (strCusInvoiceNumber = "")
	}
 
	quit strCusInvoiceNumber
 
7SUM ;RECHNUNG ;INVOICE SUM;TYBD;29,1,2005;SAMMELRECHNUNG
	NEW YAUFTRAG,SUMINVOICE,YFORM,YVORG
	
	SET SUMINVOICE=$PIECE(YAUFTRAG1,Y,96)
	NEW YAUFTRAG1
	
	DO  ;TYBD;29,1,2004;SAMMELRECHNUNGS AUFTRÄGE SUCHEN.
	. NEW YAUFTRAG
	. SET YAUFTRAG=""
	. FOR  SET YAUFTRAG=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAG)) QUIT:YAUFTRAG=""  DO
	. . SET YAUFTRAG1=$GET(^INAUF(YM,YAUFTRAG,1))
	. . SET $PIECE(YAUFTRAG1,Y,96)=SUMINVOICE              ;SAMMELRECHNUNGSNUMMER
	. . SET $PIECE(YAUFTRAG1,Y,97)=YDATE                   ;GEDRUCKT AM ;to the 
	. . SET $PIECE(YAUFTRAG1,Y,98)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	. . SET $PIECE(YAUFTRAG1,Y,99)=YBED                    ;GEDRUCKT VON
	. . SET YA=$$^WWWSPEI("INAUF",YAUFTRAG,YAUFTRAG1,1)
	QUIT
	
8 ;
	QUIT
	
9 ;BEREITSTELLUNG
	SET $PIECE(YAUFTRAG1,Y,87)=+$HOROLOG                 ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YAUFTRAG1,Y,87)          ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YAUFTRAG1,Y,88)=$PIECE($HOROLOG,",",2)    ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,89)=YBED                      ;GEDRUCKT VON
	QUIT
	
10 ;ANFRAGE
	IF $PIECE(YAUFTRAG1,Y,83)="" SET $PIECE(YAUFTRAG1,Y,83)=YDATE  ;ANFRAGE GEDRUCKT AM ;to the 
	SET $PIECE(YAUFTRAG1,Y,84)=$PIECE($HOROLOG,",",2)              ;GEDRUCKT UM ;to 
	SET $PIECE(YAUFTRAG1,Y,85)=YBED                                ;GEDRUCKT VON
	QUIT
	
11 ;
	QUIT
 
	;-------------------------------------------------------------------------------
	;		TEILZAHLUNGSRECHNUNG
	; SR14109
	; TODO: Need to ensure invoice number not used more than once
	; Not fixed as Adrad does not have any Partial Payment Invoices setup in their system.
	;-------------------------------------------------------------------------------
12
	IF $PIECE(YFELDPZ,Y,7)="" SET $PIECE(YFELDPZ,Y,7)=$$^WWWNEXT("INAUF"_7)    ;NEUE NUMMER ;numeral 
	SET $PIECE(YFELDPZ,Y,4)=YDATE                   ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(YFELDPZ,Y,4)        ;WENN WIEDERHOLUNG ;when repetition 
	SET $PIECE(YFELDPZ,Y,5)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	SET $PIECE(YFELDPZ,Y,6)=YBED                    ;GEDRUCKT VON
	FOR YI=4,5,6,7 SET $PIECE(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1),Y,YI)=$PIECE(YFELDPZ,Y,YI)
	
	;SET ^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)=YFELDPZ
	IF YCOPY'=1 DO
	. SET $PIECE(YAUFTRAG1,Y,96)=$PIECE(YFELDPZ,Y,7)  ;NEUE NUMMER  ;BELEGNUMMER ERRECHNEN ;numeral 
	. SET $PIECE(YAUFTRAG1,Y,97)=$PIECE(YFELDPZ,Y,4)  ;GEDRUCKT AM ;to the 
	. SET $PIECE(YAUFTRAG1,Y,98)=$PIECE(YFELDPZ,Y,5)  ;GEDRUCKT UM ;to 
	. SET $PIECE(YAUFTRAG1,Y,99)=$PIECE(YFELDPZ,Y,6)  ;GEDRUCKT VON
	QUIT
	
13 ;
	QUIT
	
14 ;
	QUIT
	
15 ;
	QUIT
	
16 ;
	QUIT
	
17 ;Gutschrift ;credit 
	DO 7
	QUIT
	
18 ;
	QUIT
	
19 ;
	QUIT       
	
SAP(TEXT,BETRAG)
	;-------------------------------------------------------------------------------
	;	SPEICHERN SONDERKOSTEN
	;	
	;	D SAP^INDRUCK("FRACHT",40)
	;
	;History :
	;SAP-SD;TYBD;26697;03-02-2005
	;-------------------------------------------------------------------------------
	new spaces
	
	set spaces=$justify("",42)    ; string for padding text
	
	IF $FIND($GET(YBELEG),7) IF $PIECE($GET(YAUFTRAG1),Y,96)'="" IF $GET(YKUNDE)'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,68)=1 DO
	. NEW RNUM,SNUM,SATZ,UM
	. SET SATZ=""
	. SET RNUM=$PIECE(YAUFTRAG1,Y,96)
	. SET SNUM=$ORDER(^INSAPSD(YM,YKUNDE,YDATE,RNUM,""),-1)+1
	. IF SNUM=1 SET SNUM=3   ;WEGEN DES HEADERS= POSITIONEN AB ZEILE 3
	. IF SNUM=2 SET SNUM=3   ;WEGEN DES HEADERS= POSITIONEN AB ZEILE 3
	. SET SATZ="20"_"40"  ;RECHNUNG
	. IF BETRAG<0       SET SATZ="20"_"50" SET BETRAG=BETRAG*-1                 ;GUTSCHRIFT.
	. IF $GET(POS1)'="" SET SATZ=SATZ_$EXTRACT($PIECE(POS1,Y,384)_spaces,1,6)   ;SACHKONTO
	. IF $GET(POS1)=""  SET SATZ=SATZ_$EXTRACT(" "_spaces,1,6)                  ;SACHKONTO
	. SET SATZ=SATZ_$$^WWWZAHL(BETRAG,12,2)_$EXTRACT(YWHR_spaces,1,3)           ;PREIS
	. SET SATZ=SATZ_$$^WWWZAHL(1,9,0)                                           ;MENGE
	. SET SATZ=SATZ_$$^WWWZAHL(BETRAG,12,2)_$EXTRACT(YWHR_spaces,1,3)
	. SET UM=""
	. IF UM'="" SET UM=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,UM,1)),Y,1)
	. SET SATZ=SATZ_$EXTRACT(UM_spaces,1,2)  ;MENGENEINHEIT
	. SET SATZ=SATZ_"  "  ;FREI
	. IF $GET(POS1)=""  SET SATZ=SATZ_$EXTRACT(" "_spaces,1,7)   ;KOSTENSTELLE
	. IF $GET(POS1)'="" SET SATZ=SATZ_$EXTRACT($PIECE(POS1,Y,385)_spaces,1,7)   ;KOSTENSTELLE
	. DO
	. . IF $PIECE(POS1,Y,256)'="" SET SATZ=SATZ_$EXTRACT($PIECE(POS1,Y,256)_spaces,1,12) quit  ;AUFTRAGSNUMMER KUNDE
	. . SET SATZ=SATZ_$EXTRACT($PIECE($GET(YAUFTRAG1),Y,302)_spaces,1,12)                      ;AUFTRAG]]><![CDATA[SNUMMER KUNDE
	. ;
	. SET SATZ=SATZ_$EXTRACT(" "_spaces,1,6)
	. SET SATZ=SATZ_$EXTRACT(TEXT_spaces,1,42)
	. SET SATZ=SATZ_$EXTRACT(RNUM_spaces,1,7)
	. SET SATZ=SATZ_$$^WWWDATE(YDATE)
	. SET ^INSAPSD(YM,YKUNDE,YDATE,RNUM,SNUM,1)=SATZ      ; FIXME : <GRF> This class is defined with only three keys.  ???
	
	QUIT
	
SPE
	;-------------------------------------------------------------------------------
	;	SPEICHERN DATEN ;Save 
	;
	;	YPAGEBR=1 DANN MANUELLER SEITENWECHSEL
	;	YPAGEBR=2 DANN KEINEN UMBRUCH ;NO PAGE BRAKE 
	;-------------------------------------------------------------------------------
	NEW A1,LFN1,YA,YI,YII,UMBR
	
	SET LFN = $GET(LFN)+1
	SET A   = $GET(A)
	
	;IF LFN>$PIECE(YBELEG1,Y,3)!($GET(YPAGEBR)=1) IF $GET(YPAGEBR)'=2 IF LFN>40 DO UEBER1 DO  DO UEBER2 IF $GET(YMINDESTLFN)'="" SET LFN=YMINDESTLFN KILL MINDESTLFN   ;ZU LANG, NEUE SEITE
	IF (LFN>$PIECE(YBELEG1,Y,3)) || ($GET(YPAGEBR)=1) || (LFN'<$PIECE(YBELEG1,Y,64)) IF $GET(YPAGEBR)'=2 IF LFN>40 DO UEBER1 DO  DO UEBER2 IF $GET(YMINDESTLFN)'="" SET LFN=YMINDESTLFN KILL MINDESTLFN   ;ZU LANG, NEUE SEITE;BEC;27122;BEC;28.02.05
	. NEW A,A1
	. ;SET YFOOTBR=1
	. DO ^INDRUCK81     ;BEC;27122;BEC;28.02.05
	. KILL YPAGEBR
	. KILL YFOOTBR
	. SET YSEITE=YSEITE+1
	. SET LFN=0      ;NEUE SEITE ;side 
	. DO ^INDRUCK1   ;FIRMENKOPF
	. DO ^INDRUCK2   ;ANSCHRIFT
	. DO ^INDRUCK3   ;HINWEISE
	.;DO ^INDRUCK4   ;RECHNUNG/LIEFERSCH/AB/BESTELL/...
	.;DO ^INDRUCK41  ;BETREFFTEXT
	. DO ^INDRUCK5   ;UEBERSCHRIFT
	. SET LFN=$GET(LFN)+2
	
	KILL YPAGEBR
	
	; FIXME : Should this be drop through? Mark accordingly <GRF>
	
SET
	;-------------------------------------------------------------------------------
	;		EINSPRUNG
	; 
	;	N YACHTUNG S YACHTUNG=1 ;substitute product 
	;  ;WENN DATEN MINDESTENS AUF ZEILE ;when upon 
	;-------------------------------------------------------------------------------
	IF LFN=1 IF $TRANSLATE($EXTRACT(A,1,8)," ")="" SET $EXTRACT(A,1,8)="</B></I>"
	IF $DATA(^INDMS(YM,YREF,YSEITE,LFN,1)) DO
	. SET A1=^INDMS(YM,YREF,YSEITE,LFN,1)
	. IF $FIND($zconvert(A,"U"),"<U>") || ($GET(YACHTUNG)=1) SET A1="" FOR  SET LFN=LFN+1 QUIT:'$DATA(^INDMS(YM,YREF,YSEITE,LFN,1))  ;BELEGT!
	. IF '$FIND(A1,"<") FOR LFN1=1:1:600 IF $EXTRACT(A,LFN1)'=" " IF $EXTRACT(A,LFN1)'="" SET $EXTRACT(A1,LFN1)=$EXTRACT(A,LFN1)
	. ;
	. SET A=A1
	
	SET ^INDMS(YM,YREF,YSEITE,LFN,1)=A
	IF $GET(^INDMS(YM,YREF,YSEITE,1,1))="" SET ^INDMS(YM,YREF,YSEITE,1,1)="</B></I>"  ;TYBD 21.10.2002
	QUIT
	
UEBER1 ;UEBERTRAGSTEXT (UNTEN)
	NEW A,YACHTUNG
	
	QUIT:$PIECE(YBELEG1,Y,65)=""
	SET LFN=$PIECE(YBELEG1,Y,64)  ;ÜBERTRAG TEXT AB ZEILE
	IF LFN'="" IF (LFN+1)<$PIECE(YBELEG1,Y,3) SET LFN=LFN+1
	IF LFN="" SET LFN=66
	SET YACHTUNG=1
	;SET A="                                                             "_$PIECE(YBELEG1,Y,65)   
	SET A=$PIECE(YBELEG1,Y,65)
	SET A=$$^WWWTRANSLATE(A,"<PAGE>",YSEITE)                               ;BEC;01.03.05;27122;aktuelle Seite
	SET A=$$^WWWTRANSLATE(A,"<PAGEB>",(YSEITE-1))                          ;BEC;01.03.05;27122;vorherige Seite
	SET A=$$^WWWTRANSLATE(A,"<PAGEN>",(YSEITE+1))                          ;BEC;01.03.05;27122;nächste Seite
	SET A="                                                             "_A
	DO SET
	QUIT
	
UEBER2 ;Übertragstext Folgeseite (OBEN)
	NEW A
	
	QUIT:$PIECE(YBELEG1,Y,66)=""
	
	SET A=$PIECE(YBELEG1,Y,66)
	SET A=$$^WWWTRANSLATE(A,"<PAGE>",YSEITE)                               ;BEC;01.03.05;27122;aktuelle Seite
	SET A=$$^WWWTRANSLATE(A,"<PAGEB>",(YSEITE-1))                          ;BEC;01.03.05;27122;vorherige Seite
	SET A=$$^WWWTRANSLATE(A,"<PAGEN>",(YSEITE+1))                          ;BEC;01.03.05;27122;nächste Seite
	SET A=" "_A
	DO SET
	SET LFN=LFN+1
	QUIT
	
EDI(YINHALT) ;SET EDIFACT FORMAT ;table-mat format 
	QUIT:$EXTRACT(YINHALT,4)'="+"  ;KEIN INHALT NACH SEGMENT ;no purport within segment 
	
	IF $EXTRACT(YINHALT,1,3)="QTY" SET YQTY=$GET(YQTY)+$PIECE($PIECE(YINHALT,":",2),"+",2)  ;GESAMTMENGE
	IF $EXTRACT(YINHALT,1,3)="LIN" SET YLIN=$GET(YLIN)+1                                    ;GESAMTPOSITIONEN
	IF $EXTRACT(YINHALT,1,3)="PRI" IF $PIECE($PIECE(YINHALT,":",1),"+",2)="AAA" SET YMOA=$GET(YMOA)+$PIECE($PIECE(YINHALT,":",2),"+",2)  ;GESAMTBETRAG
	SET YSEG=$GET(YSEG)+1  ;GESAMTSEGMENTE
	SET LFN=$GET(LFN)+1
	SET ^INDMS(YM,YREF,YSEITE,LFN,1)=$TRANSLATE(YINHALT,"|'"," ")_"'"
	QUIT 
	
	
EDIP(YINHALT) ;SET EDIPRO FORMAT ;table-mat format 
	QUIT:'$FIND(YINHALT,"*")  ;KEIN INHALT NACH SEGMENT ;no purport within segment 
	
	IF $EXTRACT(YINHALT,1,3)="PO1" SET YLIN=$GET(YLIN)+1                      ;GESAMTPOSITIONEN
	IF $EXTRACT(YINHALT,1,3)="IT1" SET YLIN=$GET(YLIN)+1                      ;GESAMTPOSITIONEN
	IF $EXTRACT(YINHALT,1,3)="SAC" SET YMOA=$GET(YMOA)+$PIECE(YINHALT,"*",6)  ;GESAMTBETRAG
	SET YSEG=$GET(YSEG)+1  ;GESAMTSEGMENTE
	SET LFN=$GET(LFN)+1
	SET ^INDMS(YM,YREF,YSEITE,LFN,1)=$TRANSLATE(YINHALT,"|'"," ")_"^"
	QUIT 
	
	
XML(YFILE,YART,YLFN,TAG,YINHALT)    ;SET XMLFORMAT ;table-mat 
	;ACHTUNG EINSPRUNG AUS INDRUCKXML8  ;estimation out of 
	NEW XMLTAG,YTAB
	
	SET TAG=$GET(TAG)
	IF $GET(YHTML)=1 DO  ;AUFBEREITUNG FÜR HTML-BELEGE ;to 
	. IF $GET(YFILE)'="" IF $GET(YART)'="" IF $GET(YLFN)'="" SET TAG="DOCUMENT:"_YFILE_":"_YART_YLFN     QUIT  ;FIS;HTML BELEGE DRUCKEN ;HTML print 
	. IF '$FIND($GET(TAG),"<")                               SET TAG="DOCUMENT:MANU:"_$TRANSLATE(TAG,":")
	
	IF $GET(YSTDIF)=1 DO  ;AUFBEREITUNG FÜR STANDARDSCHNITTSTELLE ;to 
	. IF $GET(YFILE)'="" IF $GET(YART)'="" IF $GET(YLFN)'="" SET TAG="DOCUMENT"_YFILE_"_"_YART_YLFN      QUIT  ;FIS;HTML BELEGE DRUCKEN ;HTML print 
	. IF '$FIND($GET(TAG),"<")                               SET TAG="DOCUMENTMANU_"_$TRANSLATE(TAG,"_")
	
	SET XMLTAG  = $GET(TAG)
	SET YINHALT = $GET(YINHALT)
	
	IF $GET(TAG)="" IF $GET(YLFN)'="" IF $GET(YFILE)'=""  DO
	. IF $GET(YART)="D"              SET XMLTAG=$PIECE($GET(^WWW003(0,YFILE,YLFN,1)),Y,25)
	. IF $GET(YART)="D" IF XMLTAG="" SET XMLTAG=$PIECE($GET(^WWW003(0,YFILE,YLFN,1)),Y,1)
	. IF $GET(YART)="P"              SET XMLTAG=$PIECE($GET(^WWW002(0,YFILE,YLFN,1)),Y,25)
	. IF $GET(YART)="P" IF XMLTAG="" SET XMLTAG=$PIECE($GET(^WWW002(0,YFILE,YLFN,1)),Y,1)
	
	SET YTAB="        "
	IF $GET(TAG)'="" SET YTAB="  "
	IF $GET(YHTML)'=1 IF $GET(YSTDIF)'=1  SET XMLTAG=$TRANSLATE(XMLTAG," .,;:-_#'+*~`´?\=}][{|()&%$§!"_"""")
	
	IF '$FIND(XMLTAG,"<") DO
	. QUIT:$TRANSLATE(YINHALT,"| ")=""
	. SET LFN=$GET(LFN)+1
	. FOR  QUIT:'$DATA(^INDMS(YM,YREF,YSEITE,LFN))  SET LFN=LFN+1
	. SET ^INDMS(YM,YREF,YSEITE,LFN,1)=YTAB_"<"_XMLTAG_">"_$TRANSLATE(YINHALT,"|"," ")_"</"_XMLTAG_">"  ;MIT INHALT = TAG ;by means of purport TAG 
	
	IF $FIND(XMLTAG,"<") DO
	. SET LFN=$GET(LFN)+1
	. FOR  QUIT:'$DATA(^INDMS(YM,YREF,YSEITE,LFN))  SET LFN=LFN+1
	. QUIT:$TRANSLATE(XMLTAG,"</ >")=""
	. SET ^INDMS(YM,YREF,YSEITE,LFN,1)=YTAB_XMLTAG  ;TAG = START ODER STOP TAG <HEADER> ;TAG take-off Or TAG 
	
	QUIT
	
]]></Routine>
</Export>