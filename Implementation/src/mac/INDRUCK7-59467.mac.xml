<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCK7" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRUCK7
	
#include COMSYS
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BERECHNUNG GESAMTBETRAG
	;
	;		Updates General Ledger through FIBU^INFIBBUCH called by
	;		INDRUCK71 & INDRUCK72
	; 
	; Called By: DRUCK^INDRUCK, DRUCK^INDRUCKPRINT
	; 
	; Inputs : 
	;   YSEND
	;   YWHR			Currency Code
	;	YBELEG			Document Type from ^WWW101(0,"BELEG",SPRACHE,1)
	;												(combinations used in routine) + others?
	;						 1	Offer						  b       f g h   j
	;						 2	Order Confirmation			  b   d   f g h   j
	;						 3	Purchase Order				a   c     f     i  
	;						 5	Delivery Note				a     d   f g h   j
	;						 6	Packing Slip				a     d   f g h   j
	;						 7	Invoice						  b   d e   g h   j k l
	;						 9	Disposal Note				a     d   f g h   j
	;						10	Inquiries					a   c     f g h    
	;						12	Partial Payment Invoice		a       e   g     j     m
	;						13	Order Cancel				a   c     f g h i  
	;						17	Credit						  b   d e         j k
	;  YBELEG1			objINDRPARA or objINDRPARAB
	;  YAUFTRAG1		objINAUF or objINAUFCHECK or objINANG
	;  LFN
	;  
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 03-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1
	; 05-Dec-2006	GRF		SR15272: Doco; quits
	; 23-Jan-2006	GRF		SR14105: Doco; boolean macros; replace find test with
	; 						explicit check; extend YSPA use; remove old EURO conversion;
	; 						central check for EURO character
	; 13-Sep-2005	JW		SR13434: Centralised discount calculations
	; 30-Aug-2005	Steve S	SR13012: Display discounts/surcharges correctly
	;  3-Aug-2005	JW		SR12988: Calculate portion of total discount/surcharges
	; 29-Jul-2005	JW		SR12992: Making tax consistent
	; 11-May-2005	GRF		Removed ridiculously long strings of spaces; Mark disabled blocks
	; 07.Mar.2000	DT		Created
	;-------------------------------------------------------------------------------
	new A,ANZAHLG,ANZAHLGN,AUF1,AUFSCHLAG,AUFSCHLAGP,AUSSEN,ERLOESE,EuroOffset,KEY,KONTCOGS,KONTEN
	new INLAND,idLine,lstLines,MENGE,MWSTANZ,NETTOWERT,POS,RABATTWERT,RABATT
	new SORTI,STEUER,STEUERKZ,UAN,UAUS,WAGR,XTAB,YLAST,YSPA,YZUSATZ,YZUSKONTO
	
	;---------------------------------------
	; YBELEG1			objINDRPARA or objINDRPARAB
	; YAUFTRAG1			objINAUF    or objINAUFCHECK or objINANG
	; KOND				objINKOND
	; KUNDE1			objINKUNDE
	; KOND1				objINAUFPK
	; SATZ1				objINREBUCH
	; BANK1				objINBANK
	; YSATZ				objINSCHL
	;---------------------------------------
	
	SET UAN=""
	SET UAUS=""
	IF YSEND=0 SET UAN="<U>",UAUS="</U>"
	
	; Euro symbol needs 6 more characters in string (already allowing 1)  ;EUROZEICHEN 6 ZEICHEN MEHR
	;	D2		Currency Symbol
	SET YWHRS      = $PIECE($GET(^WWWWAE(0,YWHR,1)),Y,2)
	set EuroOffset = $select(YWHRS="&#8364;":6,1:0)
	
	;	D62			VAT And Total Line 
	;	D105		$$$INAUFPrintDocumentsWithoutTota()
	QUIT:$PIECE(YBELEG1,Y,62)'=$$$YES  ;KEINE ENDSUMME  ;no total
	IF $PIECE(YAUFTRAG1,Y,2)=2  IF (YBELEG=3)||(YBELEG=10)||(YBELEG=13)  QUIT:$PIECE(YAUFTRAG1,Y,105)=$$$YES   ;105=KEINE ENDSUMME DRUCKEN ;print 
	IF $PIECE(YAUFTRAG1,Y,2)'=2 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 QUIT:$PIECE(YAUFTRAG1,Y,105)=$$$YES   ;105=KEINE ENDSUMME DRUCKEN ;print 
	
	;---------------------------------------
	
	;	D69			Total Line Starting From Line
	IF +$PIECE(YBELEG1,Y,69)'=0 SET LFN=$PIECE(YBELEG1,Y,69)  ;SUMMENZEILE AB ZEILE ;Confirm. 
	IF $GET(LFN)="" SET LFN=26
	SET YSPA = $justify("",100)
	SET A    = ""
	
	;NETTOWARENWERT
	SET NETTOWERT = 0
	SET XMWPO     = ""
	FOR  SET XMWPO=$ORDER(MWPO(XMWPO)) QUIT:XMWPO=""  SET NETTOWERT=NETTOWERT+$GET(MWPO(XMWPO))
	
	KILL ANZAHLG        ;BRUTTO ANZAHLUNG ARRAY
	KILL ANZAHLGN       ;NETTO ANZAHLUNG ARRAY
	SET ANZAHLG    = 0
	
	SET AUFSCHLAG  = 0  ;AUFSCHLAGSBETRAG
	SET AUFSCHLAGP = 0  ;AUFSCHLAGS%
	SET RABATTWERT = 0
	SET RABATT     = 0
	SET YEXTRA     = $GET(YEXTRA)
	
	;+++++++++++++++++++++++++++++++++++++++
	;Overall Discount  ;FIS, 26.07.02
	;	D71			$$$INAUFDiscountTotal()
	;	31412		"Discount"
	;	32322		"Surcharge"
	DO
	. IF YBELEG'=1 IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG ;no expenses when no tab 
	. SET RABATT=$PIECE(YAUFTRAG1,Y,71)
	. IF +RABATT'=0 IF NETTOWERT'=0 DO
	. . SET RABATTWERT=RABATTWERT+(NETTOWERT/100)*RABATT  ;SPEICHERN RABATTSUMME ;table-mat Save 
	. . ;SET RABATTWERT=RABATTWERT+((NETTOWERT-YEXTRA)/100)*RABATT  ;RABATT NICHT FÜR EXTRAKOSTEN;FIS;26191;02.08.04
	. . ;
	. . // SR12988: Consider rounding error from total to line
	. . ;set idLine="" for  set idLine=$order(YAUFTRAG(idLine)) quit:idLine=""  do
	. . ;. set RABATTWERT=$get(RABATTWERT)+$$PercentDiscount(YAUFTRAG,idLine,RABATT)
	. . ;
	. . SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))  ;IN SPALTE ;in column 
	. . SET A=YTAB
	. .;SET XTAB=17+10+17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. . SET XTAB=17+10+17+EuroOffset
	. . ;SET A=A_$EXTRACT("- "_RABATT_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(NETTOWERT,12,2,YWHR)_YSPA,1,+XTAB)  ; "Netto-Warenwert"
	. . ;SET A=A_$EXTRACT("- "_RABATT_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL((NETTOWERT-YEXTRA),12,2,YWHR,,YWHRF)_YSPA,1,+XTAB)  ; "Netto-Warenwert"  ;RABATT NICHT FÜR EXTRAKOSTEN;FIS;26191;02.08.04
	. . ;SR13012: Display discounts/surcharges correctly
	. . SET A=A_$EXTRACT($zabs(RABATT)_"% "_$select(RABATT>=0:$$^WWWTEXT(31412),$$$YES:$$^WWWTEXT(32322))_" "_$$^WWWZAHL(NETTOWERT-YEXTRA,12,2,YWHR,,YWHRF)_YSPA,1,+XTAB)  ; "Netto-Warenwert"  ;RABATT NICHT FÜR EXTRAKOSTEN
	. . SET A=A_$EXTRACT($$^WWWZAHL((RABATTWERT*-1),12,2,YWHR,,YWHRF)_YSPA,1,XTAB)  ; "Netto-Warenwert" - N% RABATT
	. . IF $GET(RABATTZEILE)=""  NEW YACHTUNG SET YACHTUNG=1
	. . IF $GET(RABATTZEILE)'="" NEW LFN      SET LFN=RABATTZEILE  ;PLATZHALTER AUS INDRUCK6;FIS;18.08.04;26191
	. . IF $GET(RABATTSEITE)'="" NEW YSEITE   SET YSEITE=RABATTSEITE
	. . SET RABATTEXIST=1
	. . DO SPE^INDRUCK
	. . DO SAP^INDRUCK($$^WWWTEXT(31412),RABATTWERT)     ; FIXME : Should this be 31412/32322 rather than just 31412? <GRF>
	
	;+++++++++++++++++++++++++++++++++++++++
	;Overall Surcharge ;TYBD,3,2,2005
	;	D56			$$$INAUFStandardCondition()
	;	D57			Special Terms
	DO
	. IF YBELEG'=1 IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG ;no expenses when no tab 
	. SET KOND=""
	. IF $PIECE($GET(YAUFTRAG1),Y,57)="" IF $PIECE($GET(YAUFTRAG1),Y,56)="" DO  ;KEINE KONDITION
	. . IF YAUFTRAG'="" SET YAUFTRAG1=$GET(^INAUF(YM,YAUFTRAG,1))
	. . QUIT
	. IF $PIECE($GET(YAUFTRAG1),Y,57)="" IF $PIECE($GET(YAUFTRAG1),Y,56)="" QUIT  ;KEINE KONDITION
	. IF $PIECE(YAUFTRAG1,Y,56)'="" IF $PIECE($GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,56),1)),Y,16)'="" SET KOND=$GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,56),1))
	. IF $PIECE(YAUFTRAG1,Y,57)'="" IF $PIECE($GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,57),1)),Y,16)'="" SET KOND=$GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,57),1))
	. QUIT:+$PIECE(KOND,Y,16)=0
	. SET AUFSCHLAGP=$PIECE(KOND,Y,16)
	. IF NETTOWERT'=0 DO
	. . ;SET AUFSCHLAG=(NETTOWERT-YEXTRA)/100*AUFSCHLAGP  ;AUFSCHLAG (NICHT FÜR EXTRAKOSTEN)
	. . SET AUFSCHLAG=NETTOWERT/100*AUFSCHLAGP  ;AUFSCHLAG 
	. . ;SET YZUSCHLAG=$GET(YZUSCHLAG)+AUFSCHLAG
	. . SET YKONDITION=$GET(YKONDITION)+AUFSCHLAG  ;FIS;07.03.05  ;NICHT GLEICHE WIE SPEZIALZUSCHLAG (WEGEN UST)
	. . SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))  ;IN SPALTE ;in column
	. . SET A=YTAB
	. .;SET XTAB=17+10+17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. . SET XTAB=17+10+17+EuroOffset
	. . ;SET A=A_$EXTRACT("+ "_AUFSCHLAGP_"% "_$P(KOND,Y,17)_" "_$$^WWWZAHL((NETTOWERT-YEXTRA),12,2,YWHR,,YWHRF)_YSPA,1,+XTAB)  (NICHT FÜR EXTRAKOSTEN)
	. . ;SET A=A_$EXTRACT("+ "_AUFSCHLAGP_"% "_$PIECE(KOND,Y,17)_YSPA,1,+XTAB)     ;_" "_$$^WWWZAHL((NETTOWERT),12,2,YWHR,,YWHRF)_YSPA,1,+XTAB)  
	. . ;SR13012: Display discounts/surcharges correctly
	. . SET A=A_$EXTRACT($zabs(AUFSCHLAGP)_"% "_$PIECE(KOND,Y,17)_YSPA,1,+XTAB)     ;_" "_$$^WWWZAHL((NETTOWERT),12,2,YWHR,,YWHRF)_YSPA,1,+XTAB)
	. . SET A=A_$EXTRACT($$^WWWZAHL((AUFSCHLAG),12,2,YWHR,,YWHRF)_YSPA,1,XTAB)  ; "Netto-Warenwert" +AUFSCHLAG
	. . DO SPE^INDRUCK
	. . DO SAP^INDRUCK(AUFSCHLAGP_"% "_$PIECE(KOND,Y,17),(AUFSCHLAG))
	. . ;
	. . // SR12992: Calculate tax consistently. MWPO is still wrong though.
	. . SET STEUERKZ=$PIECE($GET(YADRES),Y,54)
	. . set STEUER = (STEUERKZ'=0)
	. . set MWPO = STEUER								// JW SR11997: TODO: This line is not good.
	. . ;
	. . ;DO   ;MWST ZU AUFSCHLAG;TYBD;7,2,2005
	. . ;. SET STEUERKZ=+$PIECE($GET(YADRES),Y,54)  ;0,INLAND,EG,3.LAND  -> FELD 54 WIRD OBEN NEU GESETZT !!!
	. . ;. ;I STEUER=1 I +STEUERKZ=0 S STEUERKZ=1  ;FEHLER?? = STEUER ABER AUSLAND??? ;tax yet 
	. . ;. SET STEUER=1  ;INLAND
	. . ;. IF $PIECE($GET(YADRES),Y,17)'="" IF $PIECE(YADRES,Y,17)'=$GET(YCOUNTRY) SET STEUER=0  ;KEIN DEUTSCHLAND ;no Germany 
	. . ;. IF $PIECE($GET(YADRES),Y,50)'="" IF '$FIND($PIECE(YADRES,Y,50),"DE") SET STEUER=0  ;STEUERID AUSLAND ;foreign country 
	. . ;. IF $PIECE($GET(YADRES),Y,54)'="" IF $PIECE(YADRES,Y,54)'=1 SET STEUER=0  ;KEINE STEUER  -> FELD 54 WIRD OBEN NEU GESETZT !!! ;no tax field upstairs recent staid 
	. . ;. IF $PIECE($GET(YADRES),Y,54)="" IF STEUER=1 SET STEUERKZ=1  ;DFLT= STEUER INLAND ;FIS;04.03.2005
	. . ;. IF STEUERKZ=2 IF $PIECE($GET(YADRES),Y,50)="" SET STEUER=1  ;EG OHNE UST-ID = STEUER BERECHNEN ! (PRIVATPERSON)  -> FELD 50 WIRD OBEN NEU GESETZT !!! ;without tax calculate field upstairs recent staid 
	. . ;. SET MWPO=0
	. . ;. IF STEUER=1 SET MWPO=1  ;AUFSCHLAG IMMER 16%
	. . ;
	. . SET MWPO(MWPO)=$GET(MWPO(MWPO))+AUFSCHLAG
	. . ;
	. . IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YKONDITION"_$PIECE(KOND,Y,17),MWPO)=AUFSCHLAG
	
	;+++++++++++++++++++++++++++++++++++++++
	;ANZAHLUNG ;down payment/deposit 
	;	32089		"Down Payment"
	IF YBELEG'=1 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=12 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANGEBOTEN ;Not next to sales order Or 
	. NEW YACHTUNG,MWPO
	. SET YACHTUNG=1
	. SET ANZAHLG=$$^INAUFANZAHL(YAUFTRAG,$PIECE(YAUFTRAG1,Y,96),1)     ;ERMITTELN ANZAHLUNG + RÜCKBUCHUNG !! ;FIS;23.02.05;27033
	. IF +ANZAHLG=0 QUIT
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,49))  ;IN SPALTE ;in column 
	. SET A=YTAB
	. DO SPE^INDRUCK
	. IF $DATA(ANZAHLGN) IF $ORDER(ANZAHLGN(""))'="" DO  QUIT  ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . SET MWPO=""
	. . FOR  SET MWPO=$ORDER(ANZAHLGN(MWPO)) QUIT:MWPO=""  DO
	. . . QUIT:+$GET(ANZAHLGN(MWPO))=0
	. . . SET A=$EXTRACT(YTAB_$$^WWWTEXT(32089)_YSPA,1,+$PIECE(YBELEG1,Y,63))  ;ANZAHLUNG ;down payment 
	. . . SET A=A_$$^WWWZAHL((ANZAHLGN(MWPO)*-1),12,2,YWHR,,YWHRF)
	. . . DO SPE^INDRUCK
	. ;
	. DO  ;ANZAHLUNG GESAMT
	. . SET A=$EXTRACT(YTAB_$$^WWWTEXT(32089)_YSPA,1,+$PIECE(YBELEG1,Y,63))  ;ANZAHLUNG ;down payment 
	. . SET A=A_$$^WWWZAHL((ANZAHLG*-1),12,2,YWHR,,YWHRF)
	. . DO SPE^INDRUCK
	
	DO  ;---------------------------
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,32))  ;IN SPALTE ;in column 
	. IF $PIECE(YBELEG1,Y,34)=""  SET A=YTAB_UAN_$$^WWWNBSP($EXTRACT(YSPA,1,$LENGTH($PIECE(YBELEG1,Y,33))))_UAUS
	. IF $PIECE(YBELEG1,Y,34)'="" SET A=YTAB_UAN_$$^WWWNBSP($EXTRACT(YSPA,1,$LENGTH($PIECE(YBELEG1,Y,34))))_UAUS
	. ;S YPAGEBR=2
	. DO SPE^INDRUCK
	
	;+++++++++++++++++++++++++++++++++++++++
	;ÜBERSCHRIFT ;title
	;	31413		"Net Value"
	;	31414		"Tax %"
	;	31415		"Tax Amount"
	;	32173		"Offer Amount"
	;	32175		"Order Value"
	;	32470		"Net Amount"
	;IF +GESAMT'=0!(YBELEG=2)!(YBELEG=7)!(YBELEG=17)!(YBELEG=12) DO   ;NUR WENN BETRAG VORHANDEN ;only when Sum on hand 
	IF (+GESAMT'=0)||(YBELEG=7)||(YBELEG=17)||(YBELEG=12) DO               ;NUR WENN BETRAG VORHANDEN ;only when Sum on hand 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))           ;IN SPALTE ;in column 
	. SET A=YTAB_$EXTRACT($$^WWWTEXT(31413)_YSPA,1,17)                     ; "Netto-Warenwert"
	. IF YBELEG=12 SET A=YTAB_$EXTRACT($$^WWWTEXT(32470)_YSPA,1,17)        ; "Netto-BETRAG"
	. SET A=A_$EXTRACT($$^WWWTEXT(31414)_YSPA,1,10)                        ; "MwSt%"
	. SET A=A_$EXTRACT($$^WWWTEXT(31415)_YSPA,1,17)                        ; "MwSt-Betrag" 
	. IF YBELEG'=1 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 SET A=A_$EXTRACT($$^WWWTEXT(31416)_YSPA,1,17)   ; "Rechnungsbetrag"
	. IF YBELEG=1 SET A=A_$EXTRACT($$^WWWTEXT(32173)_YSPA,1,17)                     ; "Angebotsbetrag"
	. ; FIXME : Can't have following values in this block <GRF>
	. IF (YBELEG=3) || (YBELEG=13) SET A=A_$EXTRACT($$^WWWTEXT(32175)_YSPA,1,17)    ; "Bestellwert"
	. ;IF $GET(YSEND)=0 SET A="</U>"_A  ;OHNE UNDERLINE
	. DO SPE^INDRUCK
	
	SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,1,1)),Y,1)		// JW SR11997: TODO: Hardcoded
	SET MWST=0,GESAMT=0,MGESAMT=0,NGESAMT=0,MWSTANZ=0
	
	;WENN ZZGL MWST  (NETTO=B TO B) ;when Tax 
	IF +$GET(YINKLMWST)=0 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. ;IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0
	. IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. ;
	. // SR13434: Remove order discounts
	. set lstLines=""
	. set idLine=""
	. for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. . set lstLines = lstLines_$lb(idLine)
	. set MWPO(MWPO)=MWPO(MWPO)- $$OrderDiscountPortion^INAUFCalc(YAUFTRAG,lstLines)	//SR13434
	. ;
	. ;IF +RABATT'=0 DO  ;GESAMTRABATT
	. ;. IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-RABATTWERT,RABATTWERT=0 QUIT  ;REST (GGF. RUNDUNGSDIFFERENZ) ;residue 
	. ;. SET RABATTWERT=RABATTWERT-((MWPO(MWPO)/100)*RABATT)
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-((MWPO(MWPO)/100)*RABATT)
	. ;
	. ; SR12988: Overall dollar discount/surcharge (not percentage) - apportioned
	. ;set idLine=""
	. ;for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount(YAUFTRAG,idLine)
	. ;
	. ;SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount(YAUFTRAG,$order(YAUFTRAG("")))
	. ;
	. IF +$GET(ANZAHLG)'=0 DO  ;ANZAHLUNG ;down payment
	. . IF $DATA(ANZAHLGN) IF $ORDER(ANZAHLGN(""))'="" DO  QUIT  ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . . SET MWPO(MWPO)=MWPO(MWPO)-$GET(ANZAHLGN(MWPO))
	. . . SET ANZAHLG=ANZAHLG-$GET(ANZAHLGN(MWPO))
	. . . IF $ORDER(MWPO(MWPO))="" IF ANZAHLG>0 SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no
	. . ;
	. . IF ANZAHLG'>MWPO(MWPO) SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG,ANZAHLG=0 QUIT  ;ANZAHLUNG WENIGER/GLEICH ALS RECHNUNG (NORMALFALL) ;down payment when tab 
	. . SET ANZAHLG=ANZAHLG-MWPO(MWPO)  ;RESTANZAHLUNG
	. . SET MWPO(MWPO)=0
	. . IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no 
	. ;
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))  ;IN SPALTE ;in column 
	. SET A=YTAB
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6                         ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO),12,2,YWHR,,YWHRF)_YSPA,1,XTAB)  ; "Netto-Warenwert"
	. ;SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO))  SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO         ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET A=A_$EXTRACT($$^WWWZAHL(MWSTP,5,2)_YSPA,1,10)                 ; "MwSt%"
	. SET MWST=$JUSTIFY(MWPO(MWPO)/100*MWSTP,0,2)
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6                    ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)_YSPA,1,XTAB)   ; "MwSt-Betrag"
	. SET GESAMT=GESAMT+$JUSTIFY(MWPO(MWPO),0,2)                        ;GESAMT ;total
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO)+MWST,12,2,YWHR,,YWHRF)_YSPA,1,XTAB)   ; "Rechnungsbetrag"
	. ;IF $GET(YSAMMEL)'="" SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=MWPO(MWPO)_Y_MWST_Y_(MWPO(MWPO)+MWST)  ;SPEICHERN RECHNUNGSENDBETRAG FÜR SAMMELDECKBLATT;FIS;25.02.04;25202
	. IF $GET(YSAMMEL)'="" DO    ;AUFSUMMIEREN DER SUMMEN; BEC;02.02.04;25202
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+MWPO(MWPO)             ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+(MWPO(MWPO)+MWST)      ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	. ;
	. DO SPE^INDRUCK
	
	;WENN INKL MWST  (BRUTTO=B TO C) ;when Tax 
	IF +$GET(YINKLMWST)=1 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. ;IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0
	. IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. ;
	. // SR13434: Remove order discounts
	. set lstLines=""
	. set idLine=""
	. for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. . set lstLines = lstLines_$lb(idLine)
	. set MWPO(MWPO)=MWPO(MWPO)- $$OrderDiscountPortion^INAUFCalc(YAUFTRAG,lstLines)
	. ;
	. ;IF RABATT'=0 DO
	. ;. IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-RABATTWERT,RABATTWERT=0 QUIT  ;REST (GGF. RUNDUNGSDIFFERENZ) ;residue 
	. ;. SET RABATTWERT=RABATTWERT-((MWPO(MWPO)/100)*RABATT)
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-((MWPO(MWPO)/100)*RABATT)
	. ;
	. ; SR12988: Overall dollar discount/surcharge (not percentage) - apportioned
	. ;set idLine=""
	. ;for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount(YAUFTRAG,idLine)
	. ;SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount^INDRUCK7(YAUFTRAG,$order(YAUFTRAG("")))
	. ;
	. IF +AUFSCHLAGP'=0 DO  ;GESAMTZUSCHLAG
	. . IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)+AUFSCHLAG,AUFSCHLAG=0 QUIT  ;REST (GGF. RUNDUNGSDIFFERENZ) ;residue 
	. . SET AUFSCHLAG=AUFSCHLAG-((MWPO(MWPO)/100)*AUFSCHLAGP)
	. . SET MWPO(MWPO)=MWPO(MWPO)+((MWPO(MWPO)/100)*AUFSCHLAGP)
	. ;
	. IF +$GET(ANZAHLG)'=0 DO  ;ANZAHLUNG ;down payment 
	. . IF $DATA(ANZAHLGN) IF $ORDER(ANZAHLGN(""))'="" DO  QUIT  ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . . SET MWPO(MWPO)=MWPO(MWPO)-$GET(ANZAHLGN(MWPO))
	. . . SET ANZAHLG=ANZAHLG-$GET(ANZAHLGN(MWPO))
	. . . IF $ORDER(MWPO(MWPO))="" IF ANZAHLG>0 SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no
	. . ;
	. . IF ANZAHLG'>MWPO(MWPO) SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG,ANZAHLG=0 QUIT  ;ANZAHLUNG MEHR ALS RECHNUNG ;down payment more when tab 
	. . SET ANZAHLG=ANZAHLG-MWPO(MWPO)
	. . IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG QUIT  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no 
	. . SET MWPO(MWPO)=0
	. ;
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))  ;IN SPALTE ;in column 
	. SET A=YTAB
	. ;SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO))  SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO  ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET MWST=$JUSTIFY((MWPO(MWPO))/(100+MWSTP)*MWSTP,0,2)
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6                              ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO)-MWST,12,2,YWHR,,YWHRF)_YSPA,1,XTAB)  ; "Netto-Warenwert"
	. SET A=A_$EXTRACT($$^WWWZAHL(MWSTP,5,2)_YSPA,1,10)                           ; "MwSt%"
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6                              ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)_YSPA,1,XTAB)             ; "MwSt-Betrag"
	. SET GESAMT=GESAMT+$JUSTIFY(MWPO(MWPO)-MWST,0,2)                             ;GESAMT ;total
	. SET MGESAMT=MGESAMT+MWST                                                    ;MWST ;Tax 
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6                              ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. IF YBELEG'=12 SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO),12,2,YWHR,,YWHRF)_YSPA,1,XTAB)   ;W "Rechnungsbetrag"
	. ;IF $GET(YSAMMEL)'="" SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=(MWPO(MWPO)-MWST)_Y_MWST_Y_MWPO(MWPO)  ;SPEICHERN RECHNUNGSENDBETRAG FÜR SAMMELDECKBLATT;FIS;25.02.04;25202
	. IF $GET(YSAMMEL)'="" DO                 ;BEC;25202;23.02.04; SUMME SAMMELDRUCK
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+(MWPO(MWPO)-MWST)      ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+MWPO(MWPO)             ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	. ;
	. DO SPE^INDRUCK
	
	IF YBELEG=12 DO  ;TEILZAHLUNGSRECHNUNG
	. SET MWST=0,MGESAMT=0,NGESAMT=0,MWSTANZ=0
	. SET GESAMTPZ=""
	. IF +$PIECE(YFELDPZ,Y,2)'=0 SET GESAMTPZ=$PIECE(YFELDPZ,Y,2)        ;ZALHLUNG-BETRAG     
	. IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET GESAMTPZ=SUMME*$PIECE(YFELDPZ,Y,3)/100
	. SET MWPO=$ORDER(MWPO(""))  ;UST;FIS;22349;11.11.03
	. SET MWSTANZ=MWSTANZ+1      ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-(17+10+17))  ;IN SPALTE ;in column 
	. SET A=YTAB
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(GESAMTPZ,12,2,YWHR,,YWHRF)_YSPA,1,XTAB)   ;WERT "Netto-BETRAG"
	. SET MWSTP=0  ;TYBD;12,12,2003
	. ;IF MWPO'="" SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF MWPO'="" IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF MWPO'="" IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO  ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET A=A_$EXTRACT($$^WWWZAHL(MWSTP,5,2)_YSPA,1,10)   ;W "MwSt%"
	. SET MWST=$JUSTIFY(GESAMTPZ/100*MWSTP,0,2)
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)_YSPA,1,XTAB)   ;W "MwSt-Betrag"
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	.;SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET XTAB=17+EuroOffset
	. SET A=A_$EXTRACT($$^WWWZAHL(GESAMTPZ+MWST,12,2,YWHR,,YWHRF)_YSPA,1,XTAB)       ;W "Rechnungsbetrag"
	. ;IF $GET(YSAMMEL)'="" SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=GESAMTPZ_Y_MWST_Y_(GESAMTPZ+MWST)  ;SPEICHERN RECHNUNGSENDBETRAG FÜR SAMMELDECKBLATT;FIS;25.02.04;25202
	. IF $GET(YSAMMEL)'="" DO                 ;BEC;25202;23.02.04; SUMME SAMMELDRUCK
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+GESAMTPZ               ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+(GESAMTPZ+MWST)        ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	. ;
	. DO SPE^INDRUCK
	
	IF YBELEG'=12 SET NGESAMT=GESAMT  ;NETTO
	IF YBELEG=12  SET NGESAMT=GESAMTPZ,GESAMT=NGESAMT  ;NETTO
	SET GESAMT=GESAMT+$GET(MGESAMT)  ;NETTO + MWST ;Tax 
	
	IF ($GET(MWSTANZ)>1) || (+$PIECE(YAUFTRAG1,Y,71)'=0) IF +$GET(GESAMT)'=0 IF (YBELEG=2) || (YBELEG=1) || (YBELEG=7) || (YBELEG=17) DO  ;NUR WENN MEHRERE MWST ZEILEN UND BETRAG > 0 UND BEI RECHNUNGEN/GUTSCHRIFTEN ;only when divers Tax And Sum And next to 
	. ;
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63))  ;IN SPALTE ;in column 
	. SET A=YTAB_$$^WWWZAHL(GESAMT,12,2,YWHR,,YWHRF)   ;GESAMTBETRAG
	. DO SPE^INDRUCK
	. ;
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63))  ;IN SPALTE ;in column 
	. SET A=YTAB_$EXTRACT("=========================",1,16)
	. DO SPE^INDRUCK
	
	SET A=" "
	DO SPE^INDRUCK
	
	;Frachtbedingung kunden ;Freight Condition 
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=12 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ODER TEILZAHUNGEN ;Not next to sales order Or Or 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. IF $PIECE(YAUFTRAG1,Y,26)'="" DO
	. . NEW KOND,YI,YFRACHT
	. . SET A=YTAB_$$^WWWTEXT(32183)_" "  ;FRACHTBEDINGUNGEN
	. . FOR YI=1:1 SET YFRACHT=$piece($piece(YAUFTRAG1,Y,26),";",YI) QUIT:YFRACHT=""  DO
	. . . SET KOND=$PIECE($GET(^INPARA(YM,"FRACHT",SPRACHE,YFRACHT,1)),Y,1)
	. . . SET A=A_KOND_" "
	. . ;
	. . DO SPE^INDRUCK
	
	;ZAHLUNGSBEDINGUNGEN - kunden ;payment terms - customer
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. IF $PIECE(YAUFTRAG1,Y,56)'="" DO
	. . NEW KOND
	. . SET A=YTAB_$$^WWWTEXT(32094)_" "  ;ZAHLUNGSBEDINGUNG
	. . SET KOND=$GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,56),1))
	. . SET A=A_$PIECE(KOND,Y,1)
	. . IF $LENGTH(A)>50 DO  ;ZEILE ZU LANG ;within long 
	. . . DO SPE^INDRUCK
	. . . SET A=YTAB_$EXTRACT(YSPA,1,$LENGTH($$^WWWTEXT(32094)))  ;ZAHLUNGSBEDINGUNGS BREITE ;width 
	. . ;
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,2)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,2)>$PIECE(KOND,Y,4) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,2))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,4)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,4)>$PIECE(KOND,Y,2) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,4))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,7)'=0 DO  ;PROX 7. ZAHLBAR 7.DES FOLGEMONATS;TYBD;8,8,2003
	. . . ;AB HIER ERRECHNEN DES ZAHLTAGES WENN ZAHLBAR VON BIS MONATE;TYBD;16.1.2005
	. . . IF +$PIECE(KOND,Y,8)=0 DO  QUIT   
	. . . . NEW YDATE1
	. . . . SET YDATE1=$$DMY^WWWDATE1($PIECE(KOND,Y,7)_"."_$$^WWWMONTH(30+$$DMY^WWWDATE1("15."_$$^WWWMONTH(YDATE)_"."_$$^WWWYEAR(YDATE)))_"."_$$^WWWYEAR(YDATE)) ; SR17146
	. . . . SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE1)  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . . ;
	. . . IF +$PIECE(KOND,Y,8)'=0 DO  QUIT
	. . . . NEW YDATE1,YDATE2,YDAY1
	. . . . SET YDAY1=$$^WWWDAYTAG(YDATE)
	. . . . IF YDAY1<$PIECE(KOND,Y,8) SET $PIECE(KOND,Y,7)=YDAY1
	. . . . IF YDAY1>$PIECE(KOND,Y,9) SET $PIECE(KOND,Y,7)=YDAY1
	. . . . IF +$PIECE(KOND,Y,10)'=0 DO
	. . . . . IF YDAY1=$PIECE(KOND,Y,11) SET $PIECE(KOND,Y,7)=$PIECE(KOND,Y,10)
	. . . . . IF YDAY1=$PIECE(KOND,Y,12) SET $PIECE(KOND,Y,7)=$PIECE(KOND,Y,10)
	. . . . . IF YDAY1>$PIECE(KOND,Y,11) IF YDAY1<$PIECE(KOND,Y,12) SET $PIECE(KOND,Y,7)=$PIECE(KOND,Y,10)
	. . . . ;
	. . . . SET YDATE1=$$DMY^WWWDATE1($PIECE(KOND,Y,7)_"."_$$^WWWMONTH(30+$$DMY^WWWDATE1("15."_$$^WWWMONTH(YDATE)_"."_$$^WWWYEAR(YDATE)))_"."_$$^WWWYEAR(YDATE)) ; SR17146
	. . . . SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE1)  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . ;
	. . ;IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,2)'=0  IF $PIECE(KOND,Y,2)>$PIECE(KOND,Y,4) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,2))  ;SPÄTESTENS BIS + DATUM +
	. . ;IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,4)'=0  IF $PIECE(KOND,Y,4)>$PIECE(KOND,Y,2) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,4))  ;SPÄTESTENS BIS + DATUM +
	. . SET $PIECE(YAUFTRAG1,Y,74)=$PIECE(KOND,Y,3)  ;SKONTO
	. . SET $PIECE(YAUFTRAG1,Y,75)=$PIECE(KOND,Y,2)  ;TAGE
	. . SET $PIECE(YAUFTRAG1,Y,76)=$PIECE(KOND,Y,4)  ;NETTO
	. . DO SPE^INDRUCK
	. . IF $PIECE(YAUFTRAG1,Y,107)'="" DO  ;VEREINBARTE SONDERKONDITION
	. . . NEW SPACE,YZ,LAENGE
	. . . SET $PIECE(SPACE," ",$LENGTH($$^WWWTEXT(32094)))=" "  ;ABSTAND WI OBEN (ZAHLUNGSBEDINGUNG) ;offset upstairs 
	. . . SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. . . SET $PIECE(YAUFTRAG1,Y,107)=$PIECE(YAUFTRAG1,Y,107)_"|"
	. . . SET TEXT=$PIECE(YAUFTRAG1,Y,107)
	. . . FOR YA(88)=1:1 SET TEXT1=$PIECE(TEXT,"|",YA(88)) QUIT:$TRANSLATE($PIECE(TEXT,"|",YA(88),999),"|")=""  DO
	. . . . SET A=YTAB_SPACE_" "
	. . . . FOR YA(33)=1:1 QUIT:$PIECE(TEXT1," ",YA(33),999)=""  DO  SET A=A_$PIECE(TEXT1," ",YA(33))_" "   
	. . . . . IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>$PIECE(YBELEG1,Y,73) DO SPE^INDRUCK SET A=YTAB_SPACE_" "
	. . . . ;
	. . . . IF $TRANSLATE(A," ")'=""            DO SPE^INDRUCK
	. . . . IF $TRANSLATE(A," ")="" IF YA(33)=1 DO SPE^INDRUCK
	. ;
	. ;LASTSCHRIFT VERMERK ;direct debit observation 
	. IF YBELEG'=7 QUIT  ;NUR RECHNUNG IF YBELEG'=17  ;only tab 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. IF YKUNDE'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,102)=3 IF +GESAMT>0 DO  ;LASTSCHRIFT ;direct debit 
	. . SET A=YTAB_$PIECE(YBELEG1,Y,196)  ;ZAHLUNGSBEDINGUNG
	. . IF $PIECE(YBELEG1,Y,196)="" QUIT
	. . DO SPE^INDRUCK
	
	;+++++++++++++++++++++++++++++++++++++++
	;UST-STEUERNUMMER DES KUNDEN
	; Customer's Tax Number
	;	33906		"Your Tax ID No."
	IF $PIECE(YBELEG1,Y,203)=1 DO  ;NUR RECHNUNG IF YBELEG'=17 ;only tab 
	. NEW STNR
	. SET STNR=""
	. ;IF $GET(YKUNDE)'="" SET STNR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,233)  ;STEURNUMMER DER KUNDEN
	. IF $GET(YKUNDE)'="" SET STNR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,50)  ;ust-id nicht steuernummer ! ;FIS;20.07.04;25708
	. QUIT:STNR=""
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. SET A=YTAB_$$^WWWTEXT(33906)_": "_STNR  ;steuernummer des kunden
	. DO SPE^INDRUCK
	
	;+++++++++++++++++++++++++++++++++++++++
	;ZAHLUNGSBEDINGUNGEN bestellung ;payment terms
	;	32094		"Payment Terms:"
	IF (YBELEG=3) || (YBELEG=13) DO   ; BEI BESTELLUNG ;next to sales order 
	. NEW YPOS
	. SET YPOS=$ORDER(YAUFTRAG(""))
	. IF YPOS="" SET YPOS=" "
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. IF '$DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;KEINE SPEZIALKONDITION NUR DIE KONDITION DES LIEFERANTEN ;no only who 
	. . IF $PIECE(YADRES,Y,56)'="" DO
	. . . NEW KOND
	. . . SET A=YTAB_$$^WWWTEXT(32094)_" "  ;ZAHLUNGSBEDINGUNG
	. . . SET KOND=$GET(^INKOND(YM,$PIECE(YADRES,Y,56),1))
	. . . QUIT:$PIECE(KOND,Y,1)=""
	. . . SET A=A_$PIECE(KOND,Y,1)
	. . . DO SPE^INDRUCK
	. ;
	. IF $DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;SPEZIALKONDITION DES AUFTRAGES
	. . NEW KOND1,YZ
	. . SET KOND1=$GET(^INAUFPK(YM,YAUFTRAG,YPOS,1))
	. . SET A=YTAB_$$^WWWTEXT(32094)  ;ZAHLUNGSBEDINGUNG
	. . IF +$PIECE(KOND1,Y,7)'=0 DO   ;SKONTO
	. . . IF +$PIECE(KOND1,Y,9)'="" DO
	. . . . SET A=A_" "_$$^WWWTEXT(32091)_" "_$PIECE(KOND1,Y,9)_" "_$$^WWWTEXT(32092)   ;IN XXX TAGEN ;within 
	. . . . QUIT
	. . . SET A=A_" "_$PIECE(KOND1,Y,7)_$$^WWWTEXT(32090)   ;% SKONTO
	. . ;
	. . IF +$PIECE(KOND1,Y,10)'=0 DO   ;NETTO
	. . . SET A=A_" "_$PIECE(KOND1,Y,10)_" "_$$^WWWTEXT(32093)   ;Tage Netto ;days Net 
	. . ;
	. . IF +$PIECE(KOND1,Y,7)=0 IF +$PIECE(KOND1,Y,10)=0 IF $PIECE(YADRES,Y,56)'="" DO  QUIT   ;KEINE ZAHLUNGSBEDINGUNG, ABER STANDARD;FIS;29.12.04
	. . . SET A=YTAB_$$^WWWTEXT(32094)_" "  ;ZAHLUNGSBEDINGUNG
	. . . SET KOND=$GET(^INKOND(YM,$PIECE(YADRES,Y,56),1))
	. . . QUIT:$PIECE(KOND,Y,1)=""
	. . . SET A=A_$PIECE(KOND,Y,1)
	. . . DO SPE^INDRUCK
	. . ;
	. . IF A=YTAB_$$^WWWTEXT(32094) QUIT   ;KEINE ZAHLUNGSBEDINGUNG ; - No Payment Terms
	. . DO SPE^INDRUCK
	. . IF $PIECE(YAUFTRAG1,Y,107)'="" DO  ;VEREINBARTE SONDERKONDITION
	. . . NEW SPACE,YZ,LAENGE
	. . . SET $PIECE(SPACE," ",$LENGTH($$^WWWTEXT(32094)))=" "  ;ABSTAND WI OBEN (ZAHLUNGSBEDINGUNG) ;offset upstairs 
	. . . SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. . . SET $PIECE(YAUFTRAG1,Y,107)=$PIECE(YAUFTRAG1,Y,107)_"|"
	. . . SET TEXT=$PIECE(YAUFTRAG1,Y,107)
	. . . FOR YA(88)=1:1 SET TEXT1=$PIECE(TEXT,"|",YA(88)) QUIT:$TRANSLATE($PIECE(TEXT,"|",YA(88),999),"|")=""  DO
	. . . . SET A=YTAB_SPACE_" "
	. . . . FOR YA(33)=1:1 QUIT:$PIECE(TEXT1," ",YA(33),999)=""  DO  SET A=A_$PIECE(TEXT1," ",YA(33))_" "   
	. . . . . IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>$PIECE(YBELEG1,Y,73) DO SPE^INDRUCK SET A=YTAB_SPACE_" "
	. . . . ;
	. . . . IF $TRANSLATE(A," ")'=""            DO SPE^INDRUCK
	. . . . IF $TRANSLATE(A," ")="" IF YA(33)=1 DO SPE^INDRUCK
	
	/* Start Disabled Block ******************
	;                                       *
	;STEUER GGF NEU SETZEN  -> ERFOLGT BEREITS IN INDRUCK ;tax recent typeset yet within 
	;IF $GET(YKUNDE)'="" DO
	. ;IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)  ;STEUER
	. ]]><![CDATA[SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)  ;STEUER  ;fis;06.01.04;24875
	. IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,38)'="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,38),1)),Y,54)  ;STEUER  ;FIS;19.03.04 ;tax 
	. SET $PIECE(YADRES,Y,50)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,50)  ;UST-ID  ;FIS;26.03.04
	. IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,38)'="" SET $PIECE(YADRES,Y,50)=$PIECE($GET(^INKUNDE(YM,$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,38),1)),Y,50)  ;UST-ID  ;FIS;26.03.04
	
	;IF $GET(YLIEFER)'="" DO
	. ;IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER
	. SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER  ;fis;06.01.04;24875
	. SET $PIECE(YADRES,Y,50)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,50)  ;UST-ID  ;fis;26.03.04
	;                                       *
	; End Disabled Block ******************** */
	
	;+++++++++++++++++++++++++++++++++++++++
	;umsatzsteuer id nummer auf kundenbeleg und lieferantenbestellung (YADRES)
	; value added tax ID number on customer's receipt and supplier order
	;	32158		Our EU Id-N.:
	DO 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,41))  ;IN SPALTE ;in column 
	. IF $PIECE(YADRES,Y,54)=2 DO  ;EG Ausland ;foreign country 
	. . NEW IDNR
	. . SET IDNR=$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,20)
	. . QUIT:IDNR=""   ;KEINE  ID ;no ID 
	. . SET A=YTAB_$$^WWWTEXT(32158)_" "  ;Steuer id nummer ;tax ID no. 
	. . SET A=A_IDNR
	. . ;NEW YACHTUNG
	. . ;SET YACHTUNG=1 ;table-mat 
	. . DO SPE^INDRUCK
	
	;+++++++++++++++++++++++++++++++++++++++
	;STEUERÄNDERUNGSGRUND DYN. VERGEBEN;FIS;26276;18.10.04 ;STEUERHINWEIS
	; TAX REASON FOR CHANGE DYNAMICALLY ASSIGNED   ; TAX REFERENCE
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 IF $PIECE(YADRES,Y,54)'="" DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. DO  ;IF $PIECE(YBELEG1,Y,198)=1 DO  ;IF +$PIECE($GET(^INVORG(YM,YM,1)),Y,196)=1 DO
	. . NEW STEUERGRUND,TEXT1,YA
	. . SET A=YTAB
	. . SET STEUERGRUND=$PIECE($GET(^INSTEUERGRUND(YM,$PIECE(YADRES,Y,54),YBELEG,SPRACHE,1)),Y,1)
	. . QUIT:STEUERGRUND=""
	. . ;SET A=STEUERGRUND_$EXTRACT(A,1,$LENGTH(STEUERGRUND))   ;EINSETZEN
	. . DO SPE^INDRUCK
	. . FOR YA(88)=1:1 SET TEXT1=$PIECE(STEUERGRUND,"|",YA(88)) QUIT:$TRANSLATE($PIECE(STEUERGRUND,"|",YA(88),999),"|")=""  DO
	. . . SET A=YTAB
	. . . FOR YA(33)=1:1 QUIT:$PIECE(TEXT1," ",YA(33),999)=""  DO  SET A=A_$PIECE(TEXT1," ",YA(33))_" "   
	. . . . ;IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>$PIECE(YBELEG1,Y,73) DO SPE^INDRUCK SET A=YTAB 
	. . . . IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>77 DO SPE^INDRUCK SET A=YTAB
	. . . ;
	. . . IF $TRANSLATE(A," ")'=""            DO SPE^INDRUCK
	. . . IF $TRANSLATE(A," ")="" IF YA(33)=1 DO SPE^INDRUCK
	
	;+++++++++++++++++++++++++++++++++++++++
	;RABATTZUSATZTEXT;FIS;26276;18.10.04
	; DISCOUNT ADDITIONAL TEXT
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 IF $GET(RABATTEXIST)=1 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. IF $PIECE(YBELEG1,Y,206)'="" DO
	. . NEW TEXT,TEXT1,YA
	. . SET A=YTAB
	. . SET TEXT=$PIECE(YBELEG1,Y,206)
	. . DO SPE^INDRUCK
	. . FOR YA(88)=1:1 SET TEXT1=$PIECE(TEXT,"|",YA(88)) QUIT:$TRANSLATE($PIECE(TEXT,"|",YA(88),999),"|")=""  DO
	. . . SET A=YTAB
	. . . FOR YA(33)=1:1 QUIT:$PIECE(TEXT1," ",YA(33),999)=""  DO  SET A=A_$PIECE(TEXT1," ",YA(33))_" "   
	. . . . ;IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>$PIECE(YBELEG1,Y,73) DO SPE^INDRUCK SET A=YTAB 
	. . . . IF $LENGTH(A_$EXTRACT($PIECE(TEXT1," ",YA(33)),1,26))>77 DO SPE^INDRUCK SET A=YTAB
	. . . ;
	. . . IF $TRANSLATE(A," ")'=""            DO SPE^INDRUCK
	. . . IF $TRANSLATE(A," ")="" IF YA(33)=1 DO SPE^INDRUCK
	
	QUIT:$get(YPROFORMA)=1     ;NUR PROFORMARECHNUNG ;only proforma invoice 
	QUIT:+$GET(YCOPY)=1   ;NUR WIEDERHOLUNGSDRUCK ;only 
	QUIT:$GET(YTEST)'=""  ;NUR TEST ;only Test 
	IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 QUIT   ;KEINE RECHUNG KEINE GUTSCHRIFT ;no no 
	SET AUSSEN=0   ;FAN 26.10.2001  NICHT VON AUSSEN EINSPRUNG   &  NACH RECHNUNG DRUCHEN ;buff Not within tab 
	
	; vvvvv drop through vvvvv
	
BUCHEN
	;-------------------------------------------------------------------------------
	; NOTE: Entry point into this routine ------^INAUFPL BESTÄTIGEN AUSLIEFERUNG-----AUSSEN=1 
	;
	; Called By : ^INAUFPL, ^INDRUCKEDI7, ^INDRUCKXML7, ^INDRUCKXML7PRINT
	; 
	; 03-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1
	;-------------------------------------------------------------------------------
	NEW GESAMTQ,GESAMTQQ
	
	;SAP-SD;TYBD;26697;3,2,2005 ;SR14105 GRF - replace test with explicit check
	;IF $FIND(YBELEG,7) IF $PIECE(YAUFTRAG1,Y,96)'="" IF $GET(YKUNDE)'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,68)=1 DO
	IF (YBELEG=7) || (YBELEG=17) IF $PIECE(YAUFTRAG1,Y,96)'="" IF $GET(YKUNDE)'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,68)=1 DO
	. SET ^INSAPSD(YM,YKUNDE,YDATE,$PIECE(YAUFTRAG1,Y,96),2,1)="10"_$EXTRACT($PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,201)_"    ",1,4)_$$^WWWZAHL(NGESAMT,12,2)_$EXTRACT(YWHR_"   ",1,3)_$$^WWWZAHL(MGESAMT,12,2)_$EXTRACT(YWHR_"   ",1,3)
	
	;          EINSPRUNG AUCH AUS INFREMD - BUCHUNG BEI FREMDFERTIGUNG --------BUCHEN=0 ;ULM;13.01.03
	;	D22		$$$INFIBPARPostSalesInvoice()
	;				0	Post Manually
	;				1	Post On Invoice Printing
	;				2	On Delivery-Confirmation
	SET BUCHEN=$$$NO                                                                     ;MANUELL BUCHEN
	IF AUSSEN=0 IF $PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,22)=1 SET BUCHEN=$$$YES    ;BUCHEN NACH DRUCKEN DER RECHNUNG  ;within print the tab 
	IF AUSSEN=1 IF $PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,22)=2 SET BUCHEN=$$$YES    ;BUCHEN NACH AUSLIEFERUNGS-BESTÄTIGUNG ;within 
	NEW YLAST
	SET YLAST=0  ;LASTSCHRIFT BETRAG;FIS;18.02.04;25107
	
	;------------------------------------------RECHNUNGSAUSGANGSBUCH------------------------IF AUSSEN=0   
	QUIT:$GET(YKUNDE)=""  ;KEINE KUNDENNUMMER ;no 
	
	SET YDEBITOR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,48)
	IF YDEBITOR="" SET YDEBITOR=YKUNDE
	
	IF AUSSEN=0 DO                    ;INFO IN RECHUNGSBUCHUNG ;within 
	. ;QUIT:+$GET(NGESAMT)=0  ;IMMER ALLE
	. SET NGESAMT=+NGESAMT
	. QUIT:$DATA(^INREBUCHs(YM,1,$$^WWWUMLAU($PIECE(YAUFTRAG1,Y,96),1),$$^WWWUMLAU($GET(NGESAMT),1)))
	. DO  ;IF +GESAMT'=0 DO  ;IMMER ALLE ;constantly 
	. . IF $GET(YCOPY)=1 QUIT  ;NICHT BEI COPY  ;Not next to 
	. . NEW GEZA,FDAT,KOND,SKTOKZ,KUNDE1
	. . SET GEZA=""
	. . SET FDAT=""
	. . SET KUNDE1=$GET(^INKUNDE(YM,YKUNDE,1))
	. . IF $PIECE($GET(^INVORG(YM,YM,1)),Y,170)=1 DO
	. . . IF +$PIECE(KUNDE1,Y,230)=0 IF $PIECE(KUNDE1,Y,104)="" QUIT  ;KEINE BANK   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. . . IF +$PIECE(KUNDE1,Y,230)=0 IF $PIECE(KUNDE1,Y,106)="" QUIT  ;KEINE BANK   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. . . IF +$PIECE(KUNDE1,Y,230)=1 IF $PIECE(KUNDE1,Y,114)="" QUIT  ;KEINE BANK   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. . . IF +$PIECE(KUNDE1,Y,230)=1 IF $PIECE(KUNDE1,Y,116)="" QUIT  ;KEINE BANK   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. . . IF $PIECE(KUNDE1,Y,102)=3 SET GEZA=+$HOROLOG  ;NUR WENN BANKEINZUG;TYBD;10,3,2004
	. . ;
	. . DO   ;WEM;25308;18.03.2004;FÄLLIGKEITSDATUM ERRECHNEN
	. . . SET KOND=""
	. . . IF YAUFTRAG'=""   SET SKTOKZ = $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,56)
	. . . IF SKTOKZ=""      SET SKTOKZ = $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,56)
	. . . IF SKTOKZ'=""     SET KOND   = $GET(^INKOND(YM,SKTOKZ,1))
	. . . IF $GET(YDATE)="" SET YDATE  = +$HOROLOG
	. . . IF KOND'="" DO
	. . . . IF +$PIECE(KOND,Y,2)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,2)>$PIECE(KOND,Y,4) SET FDAT=YDATE+$PIECE(KOND,Y,2)
	. . . . IF +$PIECE(KOND,Y,4)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,4)>$PIECE(KOND,Y,2) SET FDAT=YDATE+$PIECE(KOND,Y,4)
	. . . . IF +$PIECE(KOND,Y,7)'=0 SET FDAT=$$DMY^WWWDATE1($PIECE(KOND,Y,7)_"."_$$^WWWMONTH(30+$$DMY^WWWDATE1("15."_$$^WWWMONTH(YDATE)_"."_$$^WWWYEAR(YDATE)))_"."_$$^WWWYEAR(YDATE)) ; SR17146
	. . ;
	. . DO   ;WEM;25308;19.03.2004;SPEICHERN AUF WWWSPEI UMGESTELLT
	. . . NEW YVOR,YFORM,YOK,KEY1,SATZ1,YDH
	. . . SET $PIECE(SATZ1,Y,1)=$GET(YDEBITOR)
	. . . SET $PIECE(SATZ1,Y,2)=$PIECE(YAUFTRAG1,Y,96)
	. . . SET $PIECE(SATZ1,Y,3)=$PIECE(YAUFTRAG1,Y,97)
	. . . SET $PIECE(SATZ1,Y,4)=$GET(NGESAMT)
	. . . SET $PIECE(SATZ1,Y,5)=$GET(MGESAMT)
	. . . SET $PIECE(SATZ1,Y,6)=($GET(NGESAMT)+$GET(MGESAMT))
	. . . SET $PIECE(SATZ1,Y,7)=YAUFTRAG
	. . . SET $PIECE(SATZ1,Y,8)=GEZA
	. . . SET $PIECE(SATZ1,Y,9)=FDAT
	. . . SET YDH=$HOROLOG
	. . . IF $DATA(^INREBUCH(YM,+YDH,$PIECE(YDH,",",2),YKUNDE)) FOR  QUIT:'$DATA(^INREBUCH(YM,+YDH,$PIECE(YDH,",",2),YKUNDE,1))  SET $PIECE(YDH,",",2)=$PIECE(YDH,",",2)+1
	. . . SET KEY1=+YDH_","_$PIECE(YDH,",",2)_","_YKUNDE
	. . . SET YOK=$$^WWWSPEI("INREBUCH",KEY1,SATZ1,1)
	. . . ;SET ^INREBUCH(YM,+YDH,$PIECE(YDH,",",2),YKUNDE,1)=$GET(YDEBITOR)_Y_$PIECE(YAUFTRAG1,Y,96)_Y_$PIECE(YAUFTRAG1,Y,97)_Y_$GET(NGESAMT)_Y_$GET(MGESAMT)_Y_($GET(NGESAMT)+$GET(MGESAMT))_Y_YAUFTRAG_Y_GEZA_Y_FDAT   ;WEM;25308;18.03.2004;FÄLLIGKEITSDATUM SPEICHERN
	. . . ;DO ^WWWSSORT("INREBUCH",+YDH_","_$PIECE(YDH,",",2)_","_YKUNDE)
	. . ;
	. . ;SET ^INREBUCHs(YM,1,$$^WWWUMLAU($PIECE(YAUFTRAG1,Y,96),1),$$^WWWUMLAU($GET(NGESAMT),1),+YDH,$PIECE(YDH,",",2),YKUNDE)=""
	
	;-------------------------------------Zentralregulierungs-Datei-------------------------IF AUSSEN=0      
	IF AUSSEN=0 IF YVERBAND'="" DO  ;RECHNUNGSKOPIE IN DATEI SCHREIBEN ;within data file write 
	. QUIT:$DATA(^INREGULIERs(YM,1,$$^WWWUMLAU(YVERBAND,1),$$^WWWUMLAU($PIECE(YAUFTRAG1,Y,96),1)))
	. DO
	. . NEW ZR1,ZR2
	. . QUIT:$PIECE(YAUFTRAG1,Y,96)=""                     ;RECHNUNGSNUMMER
	. . SET ZR1 = $PIECE(YVERBAND,Y,70)                    ;EIGENE ZENTRALREGULIERUNGSNUMMER
	. . SET ZR2 = $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,2)  ;KUNDENZENTRALREG.-NR.
	. . SET ^INREGULIER(YM,+$HOROLOG,YVERBAND,$PIECE(YAUFTRAG1,Y,96),1)=ZR1_Y_ZR2_Y_($GET(NGESAMT)+$GET(MGESAMT))_Y_$PIECE(YAUFTRAG1,Y,51)_Y_$GET(MGESAMT)
	. . DO ^WWWSSORT("INREGULIER",+$HOROLOG_","_YVERBAND_","_$PIECE(YAUFTRAG1,Y,96))
	. . SET YREGUL=1  ;MERKEN FÜR DOKUMENTENSPEICHERUNG BEI WIEDERHOLUNGSDRUCK
	
	SET DATUM=+$HOROLOG
	SET RECHNUNG=$PIECE(YAUFTRAG1,Y,96)
	IF $GET(YSAMMEL)=1 IF $GET(^WWWSOR(YUSER,"SAMMELYREF"))'="" SET RECHNUNG=$GET(^WWWSOR(YUSER,"SAMMELYREF"))_" "_RECHNUNG    ;BELEGNUMMER SAMMELRECHNUNG;FIS;31.01.05;26967
	SET ANZAHLG=""
	FOR  SET ANZAHLG=$ORDER(ANZAHLG(ANZAHLG)) QUIT:ANZAHLG=""  SET GESAMT=GESAMT+ANZAHLG(ANZAHLG)  ;ZURÜCKHOLEN TEILZAHLUNGSBETRÄGE;21.02.05;FIS;27033
	SET GESAMT=$JUSTIFY(GESAMT,0,2)
	
	// SR12992: Calculate tax consistently. Use variable INLAND to decide whether we are in the same tax system
 	SET STEUERKZ=$PIECE(YADRES,Y,54)
	set STEUER = (STEUERKZ'=0)
	set INLAND = $$SameTaxSystem^COMTAXLocation($PIECE(YADRES,Y,52))
	/*
	SET STEUERKZ=+$PIECE(YADRES,Y,54)  ;0,INLAND,EG,3.LAND  -> FELD 54 WIRD OBEN NEU GESETZT !!!
	;I STEUER=1 I +STEUERKZ=0 S STEUERKZ=1  ;FEHLER?? = STEUER ABER AUSLAND??? ;tax yet 
	SET STEUER=1  ;INLAND
	IF $PIECE(YADRES,Y,17)'="" IF $PIECE(YADRES,Y,17)'=$GET(YCOUNTRY) SET STEUER=0  ;KEIN DEUTSCHLAND ;no Germany 
	IF $PIECE(YADRES,Y,50)'="" IF '$FIND($PIECE(YADRES,Y,50),$GET(YCOUNTRY)) SET STEUER=0  ;STEUERID AUSLAND ;foreign country 
	IF $PIECE(YADRES,Y,54)'="" IF $PIECE(YADRES,Y,54)'=1 SET STEUER=0  ;KEINE STEUER  -> FELD 54 WIRD OBEN NEU GESETZT !!! ;no tax field upstairs recent staid 
	IF $PIECE(YADRES,Y,54)="" IF STEUER=1 SET STEUERKZ=1  ;DFLT= STEUER INLAND ;FIS;04.03.2005
	IF STEUERKZ=2 IF $PIECE(YADRES,Y,50)="" SET STEUER=1  ;EG OHNE UST-ID = STEUER BERECHNEN ! (PRIVATPERSON)  -> FELD 50 WIRD OBEN NEU GESETZT !!! ;without tax calculate field upstairs recent staid 
 	*/
 	
	;SET YDEBITOR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,48)  ;WEITER OBEN BENÖTIGT;FIS;27.08.04;26334
	;IF YDEBITOR="" SET YDEBITOR=YKUNDE
	;GESAMTBUCHEN?
	;$PIECE(YAUFTRAG1,Y,101):       IN FIBU ÜBERTRAGEN AM
	;$PIECE(^INFIBPAR(YM,YM,YBETRIEB,1),Y,28): Ausgangsrechnung positionsweise buchen  JA/NEIN  , 
	;$PIECE(YAUFTRAG1,Y,71):        NACHLASS %
	
	SET KEY=""        ;KEY=EINGABEWERT BEI TEILEBUCHUNGEN ;next to 
	SET GESAMTBUCH=1  ;EINZELTEILE BUCHEN!
	
	;IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,15)'=1 IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,15)'=4 IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,15)'=2 IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,15)'=5 SET GESAMTBUCH=""  ;GESAMTBUCHEN WENN NICHT ABACUS,DISC ODER SIMBA
	IF $case(+$$$INFIBPARAttachedGL($GET(^INFIBPAR(0,YM,YBETRIEB,1))),1:0,4:0,2:0,5:0,:1) SET GESAMTBUCH=""		// JW - Simplified
	
	// SR12988: Do not do this check, as there is no support for GESAMTBUCH="".
	;IF +$$$INFIBPARPostSalesInvoiceByLineIte($GET(^INFIBPAR(0,YM,YBETRIEB,1)))=0 || (+$$$INAUFDiscountTotal($GET(YAUFTRAG1))'=0) SET GESAMTBUCH=""  ;GESAMT BUCHEN=JA (PARAMETER ODER GESAMTRABATT) ;total Or 
	
	IF $GET(YSUMINVOICE)=1 IF GESAMTBUCH="" SET GESAMTBUCH=1,$piece(^INFIBPAR(0,YM,YBETRIEB,1),Y,45)=1  ;BEI SAMMELRECHNUNG NUR EINZELBUCHUNG
	IF YBELEG=12 SET GESAMTBUCH=""   ;ANZAHLUNG NUR GESAMTBUCHUNG;down payment
	
	; Either everything or only one record
	; GESAMTSUMME BUCHEN; ENTWEDER ALLES ODER NUR 1. SATZ
	IF GESAMTBUCH="" DO GES
	
	; FIXME : GES/INDRUCK71 doesn't change GESAMTBUCH so this can be changed
	;         to "if GESAMTBUCH="" { INDRUCK72 } else { INDRUCK71 }" <GRF>
	
	; when parameter or overall discount
	; GESAMTBUCHEN WENN PARAMETER ODER GESAMTRABATT
	QUIT:GESAMTBUCH=""
	
	;=========================================================================================
	;EINZELBUCHUNG
	;Single posting
	
	DO ^INDRUCK71  ;AUSGELAGERT, DA ROUTINE ZU LANG;FIS;08.03.05
	QUIT
	
	;==================================================================================================
	
GES
	;-------------------------------------------------------------------------------
	;	GESAMT BUCHEN, DA GESAMTRABATT
	;	Entire booking, overall/total discount/allowance/deduction
	;
	; Called By : BUCHEN
	;-------------------------------------------------------------------------------
	DO ^INDRUCK72  ;AUSGELAGERT, DA ROUTINE ZU LANG;FIS;08.03.05
	QUIT
	
	
LASTSCHRIFT
	;-------------------------------------------------------------------------------
	;ERSTELLEN LASTSCHRIFTDATEI;FIS;18.02.04;25107
	;AUFBEREITUNG LASTSCHRIFT ;direct debit 
	;IF YBELEG=7!(YBELEG=17) IF +YLAST'=0 IF YKUNDE'="" IF $PIECE($GET(^INVORG(YM,YM,1)),Y,170)=1 DO  ;ERFASSEN LASTSCHRIFT
	;
	; Called By: ^INDRUCK71, ^INDRUCK72
	;-------------------------------------------------------------------------------
	IF YBELEG=7 IF YLAST>0 IF YKUNDE'="" IF $PIECE($GET(^INVORG(YM,YM,1)),Y,170)=1 DO  ;ERFASSEN LASTSCHRIFT ;Edit direct debit 
	. NEW YLFN,YSATZ,KUNDE1,BANK1,YOK,YFORM,YVOR
	. SET KUNDE1=$GET(^INKUNDE(YM,YKUNDE,1))
	. QUIT:$PIECE(KUNDE1,Y,102)'=3  ;NUR WENN BANKEINZUG ;only when 
	. IF +$PIECE(KUNDE1,Y,230)=0 QUIT:$PIECE(KUNDE1,Y,104)=""  ;KEIN KTO-NR.  TYBD;21,2,2004   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. IF +$PIECE(KUNDE1,Y,230)=0 QUIT:$PIECE(KUNDE1,Y,106)=""  ;KEIN BLZ   ;TYBD:21,2,2004     ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. IF +$PIECE(KUNDE1,Y,230)=1 QUIT:$PIECE(KUNDE1,Y,114)=""  ;KEIN KTO-NR.                   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. IF +$PIECE(KUNDE1,Y,230)=1 QUIT:$PIECE(KUNDE1,Y,116)=""  ;KEIN BLZ                       ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. ;
	. SET BANK1=$GET(^INBANK(YM,YBETRIEB,1))  ;EIGENE BANKVERBINDUNG
	. SET YLFN=$$^WWWNEXT("INSCHL")
	. SET YSATZ=""
	. SET $PIECE(YSATZ,Y,1)=YBETRIEB
	. SET $PIECE(YSATZ,Y,3)=RECHNUNG  ;VERWENDUNGSZWECK 1
	. SET $PIECE(YSATZ,Y,4)=YAUFTRAG  ;VERWENDUNGSZWECK 2
	. SET $PIECE(YSATZ,Y,23)=YLAST  ;BETRAG ;Sum 
	. SET $PIECE(YSATZ,Y,26)=(+$HOROLOG+$PIECE(YAUFTRAG1,Y,76))  ;FÄLLIG (NETTO-TAGE AB HEUTE) ;payable Confirm. 
	. SET $PIECE(YSATZ,Y,31)=$PIECE(KUNDE1,Y,8)  ;ZAHLUNGSPFLICHTIGER
	. DO
	. . IF +$PIECE(KUNDE1,Y,230)=0 DO  QUIT   ;WEM;25529;15.04.2004;KONTOAUSWAHLPARAMETER HINZUGEFÜGT
	. . . SET $PIECE(YSATZ,Y,32)=$PIECE(KUNDE1,Y,104)  ;KTO-NR.
	. . . SET $PIECE(YSATZ,Y,33)=$PIECE(KUNDE1,Y,106)  ;BLZ ;Bank-code Number  ;Bank-code Number Number 
	. . . SET $PIECE(YSATZ,Y,34)=$PIECE(KUNDE1,Y,108)  ;BANKBEZ.
	. . ;
	. . SET $PIECE(YSATZ,Y,32)=$PIECE(KUNDE1,Y,114)  ;KTO-NR.
	. . SET $PIECE(YSATZ,Y,33)=$PIECE(KUNDE1,Y,116)  ;BLZ ;Bank-code Number  ;Bank-code Number Number 
	. . SET $PIECE(YSATZ,Y,34)=$PIECE(KUNDE1,Y,118)  ;BANKBEZ.
	. ;
	. SET $PIECE(YSATZ,Y,35)=$PIECE(BANK1,Y,4)  ;ZAHLUNGSEMPFÄNGER KTO.-NR.
	. SET $PIECE(YSATZ,Y,36)=$PIECE(BANK1,Y,5)  ;BLZ ;Bank-code Number  ;Bank-code Number Number 
	. SET $PIECE(YSATZ,Y,37)=$PIECE(BANK1,Y,2)  ;BANKBEZ.
	. SET $PIECE(YSATZ,Y,38)=$PIECE(BANK1,Y,6)  ;ZAHLUNGSEMPFÄNGER
	. SET YOK=$$^WWWSPEI("INSCHL",YLFN,YSATZ,1)
	
	QUIT
	
	;-------------------------------------------------------------------------------
	
	// FOLLOWING 2 ROUTINES ARE NOT IN USE //
	
	;-------------------------------------------------------------------------------
	
DollarDiscount(pidOrder,pidCurrentLine)			// NOT IN USE
    ;-------------------------------------------------------------------------------
    ; Calculate the portion of a dollar discount for a certain line.
    ; May need to adjust last line due to rounding.
    ;
    ; Params:
    ;
    ; Returns:
    ;
    ; History:
    ; 02-Aug-2005	JW		SR12988: Created
    ;-------------------------------------------------------------------------------
	quit:$get(pidOrder)="" 0
	quit:$get(pidCurrentLine)="" 0
 
	new overallDollarDiscount,idLine,orderTotal,lineAmounts,summedAmount,lineAmount
	
	set overallDollarDiscount = $$$INAUFBLANK($get(^INAUF(YM,pidOrder,1)))
	set orderTotal = $$OrderTotal^INAUFCalc(pidOrder,.lineAmounts)
	
	if (orderTotal=0) || '$data(lineAmounts(pidCurrentLine)) {
		set lineAmount = 0
		
	} else {
		set lineAmount = $justify(lineAmounts(pidCurrentLine) / orderTotal * overallDollarDiscount,0,2)
		// There may be a rounding difference, so if this is the last line,
		// calculate it and add the difference
		if pidCurrentLine = $order(lineAmounts(""),-1) {
			set summedAmount = 0
			set idLine=""
			for {
				set idLine = $order(lineAmounts(idLine))
				quit:idLine=""
				
				set summedAmount = summedAmount + $justify(lineAmounts(idLine) / orderTotal * overallDollarDiscount,0,2)
			}
			set lineAmount = lineAmount - summedAmount + overallDollarDiscount		// Adjust
		}
	}
	
	quit lineAmount
	
	
PercentDiscount(pidOrder,pidCurrentLine,pcurPercent)		// NOT IN USE
    ;-------------------------------------------------------------------------------
    ; Calculate the percentage discount for a line.
    ; May need to adjust last line due to rounding.
    ;
    ; Params:
    ;
    ; Returns:
    ;
    ; History:
    ; 02-Aug-2005	JW		SR12988: Created
    ;-------------------------------------------------------------------------------
	quit:$get(pidOrder)="" 0
	quit:$get(pidCurrentLine)="" 0
 
	new idLine,orderTotal,lineAmounts,summedAmount,lineAmount
	
	set orderTotal = $$OrderTotal^INAUFCalc(pidOrder,.lineAmounts)
	
	if (orderTotal=0) || '$data(lineAmounts(pidCurrentLine)) {
		set lineAmount = 0
	} else {
		set lineAmount = $justify(lineAmounts(pidCurrentLine) / 100 * pcurPercent,0,2)
		// There may be a rounding difference, so if this is the last line,
		// calculate it and add the difference
		
		if pidCurrentLine = $order(lineAmounts(""),-1) {
			set summedAmount = 0
			set idLine=""
			for {
				set idLine = $order(lineAmounts(idLine))
				quit:idLine=""
				
				set summedAmount = summedAmount + $justify(lineAmounts(idLine) / 100 * pcurPercent,0,2)
			}
			set lineAmount = lineAmount - summedAmount + $justify(orderTotal / 100 * pcurPercent,0,2)	// Adjust
		}
	}
	
	quit lineAmount
	
]]></Routine>
</Export>