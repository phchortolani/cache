<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INANG1" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INANG1
#include COMSYS  ; SR14746
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		VERTEILEN ARTIKELSUCHE
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 26-Mar-2008	GRF		dot level; quits
	; 21-SEP-2006   FAN     SR14746: Sales statistics incorrect
	; 12-Oct-2005	GRF		Doco
	; 28.10.2000	DT
	;-------------------------------------------------------------------------------
	NEW KM,KUNDE,YA
	
	SET VORG(1)="#"_$GET(VORG(1))  ;SUCHE Artikel ;search Item 
	SET %("VAR","YBACK")    = "INANGNEU,"
	SET %("VAR","YAUSWAHL") = VORG(1)
	SET %("VAR","YFORM")    = "INANG"
	
	SET YANGEBOT=$PIECE($GET(YKEY),",",1)			QUIT:YANGEBOT=""
	QUIT:'$DATA(^INANG(YM,YANGEBOT))  ;NICHT VORHANDEN ;Not on hand 
	
	;NEUE BERECHNUNG J/N DER KM/VP/...
	;NEU BERECHNEN IN ZWISCHESPEICHER ;recent calculate within 
	FOR YA=178,179,180,181,303 {
		IF $PIECE($GET(^INANG1(YM,YANGEBOT,1)),Y,YA)=1 {
			SET $PIECE(^INANG(YM,YANGEBOT,1),Y,YA)=1
			SET $PIECE(^INANG1(YM,YANGEBOT,1),Y,YA)=""
		}
	}
	
	;REKLAMERKER
	IF $DATA(^INANGP(YM,YANGEBOT)) IF $PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,170)'="" SET $PIECE(^INANG(YM,YANGEBOT,1),Y,169)=$PIECE(^INANG(YM,YANGEBOT,1),Y,170)  ;REKLA ALT ;stale 
	SET YREKLA=+$PIECE(^INANG(YM,YANGEBOT,1),Y,169) SET $PIECE(^INANG(YM,YANGEBOT,1),Y,170)=YREKLA
	
	;IF YREKLA=1 DO
	DO
	. NEW YPOS
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . SET $PIECE(^INANGP(YM,YANGEBOT,YPOS,1),Y,169)=YREKLA
	
	;ANGEBOTSSPERRE FREI ;unreserved 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,38)=0 DO   ;KEINE SPERRE=FREIGEGEBEN    ;no 
	. IF $PIECE(YFELD,Y,39)="" SET $PIECE(^INANG(YM,YANGEBOT,1),Y,39)=YBED       ;MITARBEITER15.06.04;FAN;25860;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,39)="" SET $PIECE(YFELD,Y,39)=YBED                       ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,40)="" SET $PIECE(^INANG(YM,YANGEBOT,1),Y,40)=$HOROLOG   ;DATUM    ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	. IF $PIECE(YFELD,Y,40)="" SET $PIECE(YFELD,Y,40)=$HOROLOG                   ;15.06.04;25860;FAN;NUR WENN KEINE DATEN DA IST
	
	;ANGEBOTSSPERRE EIN ;uni- 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,38)=1 DO   ;KEINE SPERRE=FREIGEGEBEN ;no 
	. SET $PIECE(^INANG(YM,YANGEBOT,1),Y,39)=""   ;MITARBEITER
	. SET $PIECE(YFELD,Y,39)=""
	. SET $PIECE(^INANG(YM,YANGEBOT,1),Y,40)=""   ;DATUM ;Date
	. SET $PIECE(YFELD,Y,40)=""
	
	;ANGEBOT NICHT MEHR ÄNDERBAR ;proposition Not more 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,228)=1 DO   ;NICHT MEHR ÄNDERBAR ;Not more 
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . SET $PIECE(^INANGP(YM,YANGEBOT,YPOS,1),Y,248)=1
	
	;ANGEBOT WIEDER OFFEN;FIS;25810;06.07.04
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,60)'=1 DO   ;NICHT ABGESCHLOSSEN ;Not 
	. IF '$DATA(^INANG1(YM,YANGEBOT,1)) DO
	. . NEW AUFTEXT,SATZ
	. . SET SATZ=""
	. . SET AUFTEXT=""
	. . IF $PIECE(YFELD,Y,2)=0 IF $PIECE(YFELD,Y,1)'="" SET AUFTEXT=$PIECE($GET(^INKUNDE(YM,$PIECE(YFELD,Y,1),1)),Y,8)  ;KUNDE ;lore 
	. . IF $PIECE(YFELD,Y,2)=2 IF $PIECE(YFELD,Y,12)'="" SET AUFTEXT=$PIECE($GET(^INLIEF(YM,$PIECE(YFELD,Y,12),1)),Y,8)  ;LIEFERANT ;purveyor 
	. . IF $PIECE(YFELD,Y,2)=1 SET AUFTEXT=$$^WWWTEXT(32037)  ;AUFTRAGSTEXT EIGENFERTIGUNG
	. . DO
	. . . NEW YFORM,YVOR,YA
	. . . SET YA=$$^WWWSPEI("INANG1",YANGEBOT,AUFTEXT_Y_$PIECE(YFELD,Y,2)_Y_Y_$PIECE(YFELD,Y,4),1)
	
	IF '$DATA(^INANG1(YM,YANGEBOT)) SET ^INANG1(YM,YANGEBOT,1)=$PIECE(YFELD,Y,13)_Y_$PIECE(YFELD,Y,2)_Y_Y_+$HOROLOG  ;NOCHMAL AKTIV ;ENABLED 
	;IF $PIECE(^INANG(YM,YANGEBOT,1),Y,2)="" DO         ;KEINE ANGEBOTSART ;no 
	. ;IF $PIECE(^INANG(YM,YANGEBOT,1),Y,1)'="" DO      ;KUNDE ;lore  // SR14746
	. . ;SET $PIECE(^INANG(YM,YANGEBOT,1),Y,2)=0 DO     ;ANGEBOT KUNDE ;proposition lore  // SR14746
	. . ;SET $PIECE(^INANG(YM,YANGEBOT,1),Y,12)="" DO   ;ANGEBOT LIEFERANT ;proposition purveyor  // SR14746
	. ;IF $PIECE(^INANG(YM,YANGEBOT,1),Y,12)'="" DO     ;LIEF // SR14746
	. . ;SET $PIECE(^INANG(YM,YANGEBOT,1),Y,2)=2 DO     ;ANG.ART LIEFERANT ;purveyor  // SR14746
	. . ;SET $PIECE(^INANG(YM,YANGEBOT,1),Y,1)="" DO    ;ANGEBOTSART KUNDE ;lore  // SR14746
	
 	IF $PIECE(^INANG(YM,YANGEBOT,1),Y,2)="" DO               // SR14746
 	. NEW ANG1
 	. SET ANG1=$GET(^INANG(YM,YANGEBOT,1))
 	. IF $PIECE(ANG1,Y,1)'=""  SET $PIECE(ANG1,Y,2)=0 SET $PIECE(ANG1,Y,12)=""
 	. IF $PIECE(ANG1,Y,12)'="" SET $PIECE(ANG1,Y,2)=2 SET $PIECE(ANG1,Y,1)=""
 	.;DO SAVE^WWWSPEI("INANG",YANGEBOT,ANG1,1) // SR14746
 	. set strStatus=$$$Save("INANG",YANGEBOT,ANG1,$$$YES) // SR14746
	
	//POSITIONSRABATT IN ALLE POSITIONEN ÜBERTRAGEN;FIS;27.07.04;26150
	IF +$PIECE(YFELD,Y,70)'=0 DO
	. NEW TERM,POS,POS1,YKEY,YVOR,YOK,YFORM
	. SET POS=""
	. FOR  SET POS=$ORDER(^INANGP(YM,YANGEBOT,POS)) QUIT:POS=""  DO
	. . SET POS1=$GET(^INANGP(YM,YANGEBOT,POS,1))
	. . IF $PIECE(POS1,Y,122)'=$PIECE(YFELD,Y,70) DO  //RABATT IN POSITION
	. . . SET $PIECE(POS1,Y,122)=$PIECE(YFELD,Y,70)
	. . . DO
	. . . . NEW YFELD
	. . . . SET YFELD=POS1
	. . . . DO EH^INBRUTTONETTO                  ; Updates YFELD ByRef
	. . . . SET POS1=YFELD
	. . . ;
	. . . SET YOK=$$^WWWSPEI("INANGP",YANGEBOT_","_POS,POS1,1)
	
	;ENTFERNUNGSPAUSCHALE RECHNEN ;have faith in 
	SET KUNDE=$PIECE(^INANG(YM,YANGEBOT,1),Y,1)  ;KUNDE customer 
	SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)
	IF KUNDE'="" IF +KM=0 SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	IF +KM'=0 SET $PIECE(^INANG(YM,YANGEBOT,1),Y,187)=KM
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,181)=1 DO   ;ERRECHNEN PAUSCHALE
	. NEW KMGELD
	. QUIT:KUNDE=""   ;KEIN KUNDE ;no customer 
	. SET KMGELD=$PIECE($GET(^INVORG(YM,YM,1)),Y,28)  ;KMPAUSCHALSATZ BETRAG ;Sum 
	. QUIT:+KMGELD=0  ;KEIN KMGELD ;no rate
	. SET KM=0
	. IF KUNDE'="" SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)  ;ANZAHL DER KM ;Number the 
	. QUIT:+KM=0
	. SET $PIECE(^INANG(YM,YANGEBOT,1),Y,185)=KMGELD*KM   ;KILOMETERGELD
	. SET $PIECE(YFELD,Y,185)=KMGELD*KM 
	
	;FRACHTKOSTEN RECHNEN ;freight calculation 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,179)=1 DO   ;ERRECHNEN FRACHTKOSTEN
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,FRACHTFREI,VOLUMEN,GEWICHT,STUECK
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0
	. SET GEWICHT = 0
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL STÜCK ;BEC;24591;28.01.03;ADDED PICES;
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . QUIT:$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;no transport next to performance 
	. . SET BETRAG  = BETRAG +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,123)   ;NETTOVERKANGSPREIS
	. . SET VOLUMEN = VOLUMEN+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,5)     ;STUECK
	. ;
	. ;IF +KOSTEN'=0 DO
	. IF +KOSTEN=0 DO     ;BEC;24591;28.01.04;GEÄNDERT, DA SONST KEINE FRACHKOSTEN
	. . SET KUNDE=$PIECE(^INANG(YM,YANGEBOT,1),Y,1)  ;KUNDE ;lore 
	. . SET FRACHTFREI=0
	. . IF KUNDE'="" SET FRACHTFREI=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,42)  ;FRACHTFREI AB ;Confirm. 
	. . IF +FRACHTFREI=0!(FRACHTFREI>BETRAG) DO   ;NICHTFRACHTFREI=BERECHNEN
	. . . NEW AB,VERSAND
	. . . SET VERSAND=$PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,16)  ;WIE TRANSPORTIEREN? ;such as 
	. . . QUIT:VERSAND=""
	. . . ;FESTER BETRAG ;Sum 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,5,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;KG
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,2,GEWICHT+0.1),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,2,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;VOLUMEN ;volume 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,3,VOLUMEN+0.1),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,3,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;BETRAG ;Sum 
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,1,BETRAG+0.1),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,1,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . DO
	. . . . SET KM=0
	. . . . IF KUNDE'="" SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . . IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,187)'=0 SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)
	. . . . QUIT:+KM=0
	. . . . ;KG
	. . . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,4,KM+0.1),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,4,AB,1))
	. . . . . IF +$PIECE(KOSTEN1,Y,1)'=0 IF AB=1 SET KOSTEN=$PIECE(KOSTEN1,Y,1)*KM QUIT
	. . . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;STUECK
	. . . SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,6,STUECK+1),-1)  ;BERECHNUNG AB STUECK ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH STUECK ;within 
	. . . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,6,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. SET $$$INANGTransportationCost(^INANG(YM,YANGEBOT,1))=KOSTEN   ;VERSANDKOSTEN
	. SET $$$INANGTransportationCost(YFELD)=KOSTEN
	
	;VERPACKUNG BERECHNEN ;wrapping calculate 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,178)=1 DO   ;ERRECHNEN VERPACKUNGSKOSTEN ;packing expenses 
	. QUIT:$PIECE(^INANG(YM,YANGEBOT,1),Y,186)=""    ;KEINE VERPACKUNG ANGEGEBEN ;no wrapping 
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,STUECK
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0
	. SET GEWICHT = 0
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GEAMTANZAHL STÜCK  ;spare part 
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . QUIT:$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;no transport next to performance 
	. . SET BETRAG  = BETRAG +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,123)   ;NETTOVERKANGSPREIS
	. . SET VOLUMEN = VOLUMEN+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,5)     ;STUECK
	. ;
	. IF +KOSTEN=0 DO   ;VERPACKUNG ;wrapping 
	. . NEW AB,VERPACK
	. . SET VERPACK=$PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,186)  ;WIE VERPACKEN? ;such as 
	. . QUIT:VERPACK=""
	. . ;FESTER BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,5,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;KG
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,2,GEWICHT+0.1),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,2,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;VOLUMEN ;volume 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,3,VOLUMEN+0.1),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,3,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,1,BETRAG+0.1),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,1,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . DO
	. . . QUIT:+KOSTEN'=0
	. . . SET KUNDE=$PIECE(^INANG(YM,YANGEBOT,1),Y,1)  ;KUNDE ;lore 
	. . . QUIT:KUNDE=""   ;KEIN KUNDE ;no lore 
	. . . SET KM=0
	. . . IF KUNDE'="" SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,187)'=0 SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)    ;BEC;18.02.04;25135
	. . . QUIT:+KM=0
	. . . ;KG
	. . . SET AB=$ORDER(^INVERPACK(YM,VERPACK,4,KM+0.1),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,4,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;STUECK
	. . SET AB=$ORDER(^INVERPACK(YM,VERPACK,6,STUECK+1),-1)  ;BERECHNUNG AB ANZAHL ;Confirm. Number 
	. . IF AB'="" DO   ;BERECHNUNG NACH ANZAHL ;within Number 
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,6,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. SET $$$INANGPackageCost(^INANG(YM,YANGEBOT,1))=KOSTEN   ;VERPACKKOSTEN
	. SET $$$INANGPackageCost(YFELD)=KOSTEN
	
	;VERSICHERUNG BERECHNEN ;insurance calculate 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,180)=1 DO   ;ERRECHNEN VERSICHERUNGGSKOSTEN
	. QUIT:$PIECE(^INANG(YM,YANGEBOT,1),Y,26)=""    ;KEINE VERPACKUNG ANGEGEBEN ;no wrapping 
	. NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,STUECK
	. SET BETRAG  = 0   ;GESAMTBETRAG
	. SET VOLUMEN = 0
	. SET GEWICHT = 0
	. SET KOSTEN  = 0   ;FRACHTKOSTEN
	. SET STUECK  = 0   ;GESAMTANZAHL STÜCK  ;spare part 
	. SET YPOS=""
	. FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . QUIT:$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,26)=2  ;KEIN TRANSPORT BEI LEISTUNG ;no transport next to performance 
	. . SET BETRAG  = BETRAG +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,123)   ;NETTOVERKANGSPREIS
	. . SET VOLUMEN = VOLUMEN+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,44)    ;VOLUMEN ;volume 
	. . SET GEWICHT = GEWICHT+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,43)    ;GEWICHT ;wt. 
	. . SET STUECK  = STUECK +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,5)     ;STUECK
	. ;
	. IF +KOSTEN=0 DO   ;VERSICHERUNG ;insurance 
	. . NEW AB,VERSICH
	. . SET VERSICH=$PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,26)  ;WIE VERSICHERN? ;such as 
	. . QUIT:VERSICH=""
	. . ;FESTER BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,5,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;KG
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,2,GEWICHT+0.1),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,2,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;VOLUMEN ;volume 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,3,VOLUMEN+0.1),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,3,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . QUIT:+KOSTEN'=0
	. . ;BETRAG ;Sum 
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,1,BETRAG+0.1),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,1,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . DO
	. . . QUIT:+KOSTEN'=0
	. . . SET KUNDE=$PIECE(^INANG(YM,YANGEBOT,1),Y,1)  ;KUNDE ;lore 
	. . . QUIT:KUNDE=""   ;KEIN KUNDE ;no lore 
	. . . SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,187)'=0 SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)    ;BEC;18.02.04;25135
	. . . QUIT:+KM=0
	. . . ;KG
	. . . SET AB=$ORDER(^INVERSICH(YM,VERSICH,4,KM+0.1),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,4,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . ;STUECK
	. . SET AB=$ORDER(^INVERSICH(YM,VERSICH,6,STUECK+1),-1)  ;BERECHNUNG AB ANZAHL ;Confirm. Number 
	. . IF AB'="" DO   ;BERECHNUNG NACH ANZAHL ;within Number 
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,6,AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. SET $PIECE(^INANG(YM,YANGEBOT,1),Y,184)=KOSTEN   ;VERSICHKOSTEN
	. SET $PIECE(YFELD,Y,184)=KOSTEN
	
	;SPEZIALZUSCHLAG RECHNEN ;have faith in 
	IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,303)=1 DO   ;ERRECHNEN PAUSCHALE
	. IF $PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,210)'="" DO   ;ERRECHNEN SPEZIALZUSCHLAG
	. . ;QUIT:+$PIECE(^INANG(YM,YANGEBOT,1),Y,211)'=0  ;BETRAG BEREITS MANUELL ERFASST
	. . NEW KOSTEN,KOSTEN1,YPOS,KUNDE,BETRAG,VOLUMEN,GEWICHT,ZUSCHLAG
	. . SET ZUSCHLAG = $PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,210)
	. . SET BETRAG   = 0   ;GESAMTBETRAG
	. . SET VOLUMEN  = 0
	. . SET GEWICHT  = 0
	. . SET KOSTEN   = 0   ;FRACHTKOSTEN
	. . SET STUECK   = 0   ;ANZAHL STÜCK  ;Number spare part 
	. . SET YPOS=""
	. . FOR  SET YPOS=$ORDER(^INANGP(YM,YANGEBOT,YPOS)) QUIT:YPOS=""  DO
	. . . SET BETRAG  = BETRAG +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,123)   ;NETTOVERKAUFSPREIS
	. . . SET VOLUMEN = VOLUMEN+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,44)    ;VOLUMEN ;volume 
	. . . SET GEWICHT = GEWICHT+$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,43)    ;GEWICHT ;wt. 
	. . . SET STUECK  = STUECK +$PIECE($GET(^INANGP(YM,YANGEBOT,YPOS,1)),Y,5)     ;STUECK
	. . ;
	. . DO
	. . . ;FESTER BETRAG ;Sum 
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,5,""),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,5,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;KG
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,2,+GEWICHT+0.1),-1)  ;BERECHNUNG AB GEWICHT ;Confirm. wt. 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,2,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;VOLUMEN ;volume 
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,3,+VOLUMEN+0.1),-1)  ;BERECHNUNG AB VOLUMEN ;Confirm. volume 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,3,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;AUFTRAGSWERT
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,1,+BETRAG+0.1),-1)  ;BERECHNUNG AB BETRAG ;Confirm. Sum 
	. . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,1,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . QUIT:+KOSTEN'=0
	. . . ;KM
	. . . DO
	. . . . SET KM=0
	. . . . SET KUNDE=$PIECE($GET(^INANG(YM,YANGEBOT,1)),Y,1)  ;KUNDE ;lore 
	. . . . IF KUNDE'="" SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM ;Number the 
	. . . . IF +$PIECE(^INANG(YM,YANGEBOT,1),Y,187)'=0 SET KM=$PIECE(^INANG(YM,YANGEBOT,1),Y,187)    ;BEC;18.02.04;25135
	. . . . QUIT:+KM=0
	. . . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,4,+KM+0.1),-1)  ;BERECHNUNG AB WEGSTRECKE ;Confirm. 
	. . . . IF AB'="" DO   ;BERECHNUNG NACH WERT ;within value 
	. . . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,4,AB,1))
	. . . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . . ;
	. . . ;STUECK
	. . . SET AB=$ORDER(^INZUSCHLAG(YM,ZUSCHLAG,6,STUECK+1),-1)  ;BERECHNUNG AB ANZAHL ;Confirm. Number 
	. . . IF AB'="" DO   ;BERECHNUNG NACH ANZAHL ;within Number 
	. . . . SET KOSTEN1=$GET(^INZUSCHLAG(YM,ZUSCHLAG,6,AB,1))
	. . . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOSTEN=$PIECE(KOSTEN1,Y,1) QUIT
	. . . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOSTEN=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. . ;
	. . SET $PIECE(^INANG(YM,YANGEBOT,1),Y,211)=KOSTEN   ;BETRAG SPEZIALZUSCHLAG ;Sum 
	. . SET $PIECE(YFELD,Y,211)=KOSTEN
	
	SET $PIECE(^INANG(YM,YANGEBOT,1),Y,178)=0
	SET $PIECE(^INANG(YM,YANGEBOT,1),Y,179)=0
	SET $PIECE(^INANG(YM,YANGEBOT,1),Y,180)=0
	SET $PIECE(^INANG(YM,YANGEBOT,1),Y,181)=0
	SET $PIECE(^INANG(YM,YANGEBOT,1),Y,303)=0
	QUIT
	
]]></Routine>
</Export>