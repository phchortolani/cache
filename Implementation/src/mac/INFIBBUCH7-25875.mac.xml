<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INFIBBUCH7" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INFIBBUCH7(BUCHUNG,YFPARA,BUCHART,KEY)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BUCHEN IN FIBU-NET
	;	VORGABE=BUCHUNG
	;	S BUCHUNG=^INFIBBUCH(YM,BTR,DAT,VOR,1)
	;	S BUCHUNG=";DATUM $H;BETRAG;SOLL;HABEN;STEUER;BELEGNR.;TEXT"   ;Kostenstelle-12;skontotage-13;skonto%-14;netto-15;betrieb-16;warengruppe-17;steuerid-18;;;;;text2-22;rechnungsnummerdeslieferanten-23;zahlungsweg-24 "
	;
	; Inputs : 
	;	BUCHART=DATENSATZEBENE
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 05-Feb-2007	GRF		SR15424: Naked References; doco; expand commands
	; 15.09.2004	DT
	;-------------------------------------------------------------------------------
	NEW YRETURN,MAN,UCI,DATUM,BUCH,IDNR,LIEF,KUND,KOND,BTR,ZAEHL,SAT2,NUM,DAT
	
	SET BUCHART=$GET(BUCHART)
	SET KEY=$GET(KEY)
	SET YRETURN=""
	SET MAN=0 
	IF $PIECE(YFPARA,Y,2)'="" SET MAN=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAN="" YRETURN
	
	IF $PIECE(YFPARA,Y,3)'="" SET BTR=$PIECE(YFPARA,Y,3)  ;BETRIEB IN FIBU ;location within 
	IF $GET(BTR)="" SET BTR=1
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	SET YH=";"
	SET BUCHUNG=$TRANSLATE(BUCHUNG,YH,",")  
	IF '$DATA(^INFIBEXPO(YM)) DO
	. SET NUM=$$^WWWNEXT("INFIBEXPO")
	. SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("0001"_YH_"0"_YH_1)  ;START ;take-off 
	
	;SET NUM=$$^WWWNEXT("INFIBEXPO")
	;SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("1000"_YH_MAN_YH_$$^WWWDATE(+$H))  ;MANDANTENKENNUNG
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET BUCH="1100"
	SET $PIECE(BUCH,YH,2)=$TRANSLATE($$^WWWZAHL($PIECE(BUCHUNG,Y,3),0,2)," .,")  ;BETRAG ;Sum 
	SET $PIECE(BUCH,YH,5)=$PIECE(BUCHUNG,Y,4)  ;KONTO SOLL ;acct. 
	SET KONTOS=$PIECE(BUCHUNG,Y,4)             ;KONTO SOLL ;acct. 
	QUIT:KONTOS="" YRETURN                     ;KEIN SOLL  ;no
	 
	SET LIEF=$PIECE(BUCHUNG,Y,4)
	SET KUND=$PIECE(BUCHUNG,Y,4)
	IF '$DATA(^INKUNDE(YM,KUND,1)) IF '$DATA(^INLIEF(YM,LIEF,1)) DO 
	. SET $PIECE(BUCH,YH,6)=0
	. IF $PIECE(BUCHUNG,Y,6)<10 SET $PIECE(BUCH,YH,6)=2  ;MWST STEUER ;Tax tax 
	. IF $PIECE(BUCHUNG,Y,6)>10 SET $PIECE(BUCH,YH,6)=1  ;VORSTEUER ;prior turnover tax 
	
	SET $PIECE(BUCH,YH,7)=+$PIECE(BUCHUNG,Y,6)    ;$P($G(^WWW101(0,"MWST",SPRACHE,+$PIECE(BUCHUNG,Y,6),1)),Y,1)  ;STEUER
	SET $PIECE(BUCH,YH,8)=$PIECE(BUCHUNG,Y,7)   ;BELEG1
	SET $PIECE(BUCH,YH,9)=$PIECE(BUCHUNG,Y,23)  ;BELEG2
	SET $PIECE(BUCH,YH,10)=$$^WWWDATE($PIECE(BUCHUNG,Y,2))  ;DATUM ;Date  ;Date Date 
	SET $PIECE(BUCH,YH,11)=$PIECE(BUCHUNG,Y,5)  ;KONTO HABEN ;acct. have got 
	SET LIEF=$PIECE(BUCHUNG,Y,5)
	SET KUND=$PIECE(BUCHUNG,Y,5)
	IF '$DATA(^INKUNDE(YM,KUND,1)) IF '$DATA(^INLIEF(YM,LIEF,1)) DO 
	. SET $PIECE(BUCH,YH,12)=0
	. IF $PIECE(BUCHUNG,Y,6)<10 SET $PIECE(BUCH,YH,12)=2  ;MWST STEUER ;Tax tax 
	. IF $PIECE(BUCHUNG,Y,6)>10 SET $PIECE(BUCH,YH,12)=1  ;VORSTEUER ;prior turnover tax 
	
	SET $PIECE(BUCH,YH,13)=+$PIECE(BUCHUNG,Y,6)   ;$P($G(^WWW101(0,"MWST",SPRACHE,+$PIECE(BUCHUNG,Y,6),1)),Y,1)  ;STEUER
	SET $PIECE(BUCH,YH,14)=$EXTRACT($PIECE(BUCHUNG,Y,8)_" "_$PIECE(BUCHUNG,Y,22),1,40)  ;BELEG2
	SET $PIECE(BUCH,YH,17)=$PIECE(BUCHUNG,Y,6)   ;STEUER ;tax 
	SET $PIECE(BUCH,YH,25)=$PIECE(BUCHUNG,Y,12)  ;KSTSTELLE
	SET $PIECE(BUCH,YH,27)=$PIECE(BUCHUNG,Y,24)  ;ZAHLUNGSART
	SET $PIECE(BUCH,YH,19)=2
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)   ;STEUERID       ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID       ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;SKONTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" DO
	. . SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. ;
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))       ; SR15424
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE       ; SR15424
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))       ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))       ; SR15424
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'=""  SET KONTOA=7
	SET SACH=""
	IF $LENGTH($PIECE(BUCHUNG,Y,4))>5 SET SACH="S"
	;HABEN BUCHUNG ;have got 
	SET KONTOH=$PIECE(BUCHUNG,Y,5)  ;KONTO HABEN ;acct. have got 
	SET LIEF=$PIECE(BUCHUNG,Y,5)
	SET KUND=$PIECE(BUCHUNG,Y,5)
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)   ;STEUERID       ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID       ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;SKONTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" DO
	. . SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. ;
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))       ; SR15424
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE       ; SR15424
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))       ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))       ; SR15424
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'=""  SET KONTOA=7
	SET $PIECE(BUCH,YH,18)=$TRANSLATE($$^WWWZAHL($PIECE(BUCHUNG,Y,13),0,0)," ,.")_"/"_$TRANSLATE($$^WWWZAHL($PIECE(BUCHUNG,Y,14),0,2)," ,.")_"/"_$TRANSLATE($$^WWWZAHL($PIECE(BUCHUNG,Y,15),0,0)," ,.")
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF(BUCH)  ;
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("0005"_YH_"End")
	QUIT 1
]]></Routine>
</Export>