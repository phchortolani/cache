<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWCHECKSORT" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWCHECKSORT(YCLASS,YINDEX)
	;-------------------------------------------------------------------------------
	;	CHECK INDEX
	; 
	; Inputs: 
	;	YCLASS = CLASS TO BE CHECKED
	;	YINDEX = IF SET (1;3;...) CHECK ONLY THIS INDEX
	;
	;History:
	; 01-Feb-2007	GRF		SR15411: Doco; dot levels; expand commands
	; 25.09.2004	TYBD	Speedup
	; 				TYBD	Created
	;-------------------------------------------------------------------------------
	NEW YA,LC,UC,CLASS,YFILES,YYYM,YDATA,MAXKEY
	
	DO ^WWWVAR
	
	QUIT:$GET(YCLASS)=""  ;NO CLASS
	SET YFILES=YCLASS_"s"
	SET YDATA=""
	SET YYYM(0)=$$^WWWYM(YCLASS,0)
	SET YYYM(1)=$$^WWWYM(YCLASS,1)
	SET MAXKEY=+$ORDER(^WWW002(0,YCLASS,""),-1)
	IF MAXKEY=0 SET MAXKEY=1
	SET LC="ÜÄÖüäöß][\}{|abcdefghijklmnopqrstuvwxyz,()@#$%^&*_=+<>?/"_$CHAR(128)_""""_" "   ;SPEEDUP;TYBD;25.09.2004
	SET UC="UAOUAOSUAOUAOABCDEFGHIJKLMNOPQRSTUVWXYZ                   "
	
	DO ^WWWSORTKEY(YCLASS)                  ;GET DATA
	SET YA="^"_YCLASS_"("_YYYM(1)_"-1"_")"  ;DATENSATZ
	SET YA(1)="^"_YCLASS_"("_YYYM(1)        ;DATENSATZ CHECK
	FOR  DO NEXT QUIT:YA=""  DO KEY         ;RUN THRU
	QUIT
	
NEXT
	 SET YA=$QUERY(@YA)  ;NEXT RECORD
	 QUIT
	 
KEY  
	NEW YSA,YKEY,YI
	
	SET YSA=YA
	SET %FELD1=$GET(@YSA)
	SET YKEY=$PIECE($PIECE(YA,YA(1),2),",1)",1)
	IF '$FIND(YKEY,"(") SET YKEY=$PIECE(YKEY,")",1)
	SET YKEY=$TRANSLATE(YKEY,"""")
	DO
	. SET SKEY=""
	. FOR  SET SKEY=$ORDER(YSKEY(SKEY)) QUIT:SKEY=""  DO
	. . IF $GET(YINDEX)'="" QUIT:'$FIND(";"_YINDEX_";",";"_SKEY_";")      
	. . NEW YQ,YMAX,YMAX1,YMAX2,YOK
	. . KILL YSFELD,YSDATEI
	. . SET YSDATEI="^"_YFILES_"("_YYYM(1)_SKEY
	. . SET YMAX=1
	. . SET YOK=1
	. . SET YSDATEI(YMAX)=YSDATEI
	. . FOR YI=1:1 SET YLFN=$PIECE(YSKEY(SKEY),",",YI) QUIT:YLFN=""  DO
	. . . IF $EXTRACT(YLFN)="F" SET YSFELD(YI)=$PIECE(%FELD1,Y,+$EXTRACT(YLFN,2,9))
	. . . IF $EXTRACT(YLFN)="K" SET YSFELD(YI)=$PIECE(YKEY,",",+$EXTRACT(YLFN,2,9))
	. . . IF YI=1 IF $EXTRACT(YLFN)="F" IF YSFELD(YI)="" IF $PIECE(YSKEY(SKEY),",",2)="" IF $GET(YSKEYN(+$EXTRACT(YLFN,2,9)))=+$EXTRACT(YLFN,2,9) SET YOK=0 QUIT  ;KEINEN INDEX WENN LEER;TYBD;28,4,2005;27706
	. . . IF YI=1 DO   ;WENN ERSTER KEY ;when premier KEY 
	. . . . FOR  QUIT:$EXTRACT(YSFELD(YI))'=";"  SET YSFELD(YI)=$EXTRACT(YSFELD(YI),2,2000)
	. . . . IF $EXTRACT($REVERSE(YSFELD(YI)))=";" FOR  QUIT:$EXTRACT($REVERSE(YSFELD(YI)))'=";"  SET YSFELD(YI)=$REVERSE($EXTRACT($REVERSE(YSFELD(YI)),2,2000))
	. . . . ;
	. . . . ; Possibly improved by   <GRF>
	. . . . ;set strReverse=$reverse(YSFELD(YI))
	. . . . ;set lenReverse=$length(strReverse)
	. . . . ;for posn=1:1 quit:posn>lenReverse  quit:$extract(strReverse,posn)'=";"
	. . . . ;if lenReserve>posn set strReverse=$extract(strReverse,posn,lenReverse)
	. . . . ;set YSFELD(YI)=$reverse(strReverse)
	. . . . ;
	. . . . SET YMAX=$LENGTH(YSFELD(YI),";")  ;ANZAHL DER ";" FELDER IM FELD
	. . . . FOR YMAX1=1:1:YMAX SET YSDATEI(YMAX1)=YSDATEI
	. . . ;
	. . . IF YSFELD(YI)="" SET YSFELD(YI)=" "
	. . . FOR YMAX1=1:1:YMAX DO
	. . . . SET YMAX2=YMAX1
	. . . . IF YMAX=1 SET YMAX2=200  ;ANZAHL DER ";" FELDER IN DATENFELD
	. . . . IF YI=1 DO
	. . . . . IF $EXTRACT(YLFN)="F" IF YUMLAU'="" SET YSFELD(YMAX1,YI)=$EXTRACT($$^WWWUMLAU($PIECE(YSFELD(YI),";",YMAX1,YMAX2),1),1,150)  ;KEINE UMLAUTE;TYBD;6,10,2004;26526
	. . . . . IF $EXTRACT(YLFN)="F" IF YUMLAU=""  SET YSFELD(YMAX1,YI)=$EXTRACT($TRANSLATE($PIECE(YSFELD(YI),";",YMAX1,YMAX2),LC,UC),1,150)  ;SPEED UP;TYBD;25.09.2004 ;KEINE UMLAUTE;TYBD;6,10,2004;26526
	. . . . . IF $EXTRACT(YLFN)="K" IF YUMLAU=""  SET YSFELD(YMAX1,YI)=$EXTRACT($TRANSLATE(YSFELD(YI),LC,UC),1,150)
	. . . . . IF $EXTRACT(YLFN)="K" IF YUMLAU'="" SET YSFELD(YMAX1,YI)=$EXTRACT($$^WWWUMLAU(YSFELD(YI),1),1,150)
	. . . . . IF YSFELD(YMAX1,YI)="" SET YSFELD(YMAX1,YI)=" "
	. . . . . SET YSDATEI(YMAX1)=YSDATEI(YMAX1)_","_""""_YSFELD(YMAX1,YI)_""""
	. . . . ;
	. . . . IF YI'=1 DO
	. . . . . IF $EXTRACT(YLFN)="F" IF YUMLAU'="" SET YSFELD(YMAX1,YI)=$EXTRACT($$^WWWUMLAU(YSFELD(YI),1),1,150)     ;KEINE UMLAUTE;TYBD;6,10,2004;26526
	. . . . . IF $EXTRACT(YLFN)="F" IF YUMLAU=""  SET YSFELD(YMAX1,YI)=$EXTRACT($TRANSLATE(YSFELD(YI),LC,UC),1,150)  ;SPEED UP;TYBD;25.09.2004 ;KEINE UMLAUTE;TYBD;6,10,2004;26526
	. . . . . IF $EXTRACT(YLFN)="K" IF YUMLAU=""  SET YSFELD(YMAX1,YI)=$EXTRACT($TRANSLATE(YSFELD(YI),LC,UC),1,150)
	. . . . . IF $EXTRACT(YLFN)="K" IF YUMLAU'="" SET YSFELD(YMAX1,YI)=$EXTRACT($$^WWWUMLAU(YSFELD(YI),1),1,150)
	. . . . . IF YSFELD(YMAX1,YI)="" SET YSFELD(YMAX1,YI)=" "
	. . . . . SET YSDATEI(YMAX1)=YSDATEI(YMAX1)_","_""""_YSFELD(YMAX1,YI)_""""
	. . ;
	. . QUIT:YOK=0  ;NICHT SPEICHERN;TYBD;28,4,2005
	. . FOR YMAX1=1:1:YMAX DO
	. . . SET YQ=1
	. . . FOR YI=1:1:MAXKEY SET KEY=$PIECE(YKEY,",",YI) SET YSDATEI(YMAX1)=YSDATEI(YMAX1)_","_""""_KEY_"""" IF KEY="" SET YQ=0
	. . . SET YSDATEI(YMAX1)=YSDATEI(YMAX1)_")"
	. . . QUIT:YQ=0
	. . . IF '$DATA(@YSDATEI(YMAX1)) DO
	. . . . WRITE !,YSA," ",YSDATEI(YMAX1)
	
	QUIT
	
	
ROUTINE ; CHECK ALL THE ROUTINES
	DO ^WWWVAR
	
	NEW P,L,LINE
	
	SET P="%"
	FOR  set P=$order(^ROUTINE(P)) quit:P=""  do
	. QUIT:$EXTRACT(P)="%"
	. SET LINE1=0
	. QUIT:$FIND(P,".")
	. IF $EXTRACT(P)'="I" IF $EXTRACT(P)'="T" QUIT
	. IF $EXTRACT(P,1,5)="INSER" QUIT
	. SET L=""
	. FOR  SET L=$ORDER(^ROUTINE(P,0,L)) QUIT:L=""  DO
	. . SET LINE=$PIECE($GET(^ROUTINE(P,0,L)),";",1)
	. . SET LINEX=LINE
	. . SET CHECK=0
	. . SET OK=1
	. . FOR X=1:1:40 SET X(1)=$EXTRACT(LINE,X) QUIT:X(1)=""  QUIT:'$FIND($CHAR(9)_"/; ",X(1))  IF X(1)=";"!(X(1)="/") SET OK=0
	. . QUIT:OK=0
	. . DO
	. . . IF '$FIND(LINE,"S $P") QUIT:'$FIND(LINE,"SET $P")
	. . . QUIT:'$FIND(LINE,"^")
	. . . QUIT:'$FIND(LINE,"=")
	. . . QUIT:'$FIND(LINE,",Y,")
	. . . SET CHECK=1
	. . ;
	. . IF CHECK=1 DO
	. . . IF $FIND(LINE,"S $P") SET LINE="$P"_$PIECE(LINE,"S $P",2)
	. . . IF $FIND(LINE,"SET $P") SET LINE="$P"_$PIECE(LINE,"SET $P",2)
	. . . QUIT:$PIECE(LINE,"=",2)=""
	. . . SET LINE=$PIECE(LINE,"=",1)
	. . . SET CLASS=$PIECE($PIECE(LINE,"^",2),"(",1)
	. . . IF $FIND(CLASS,"WWW") QUIT
	. . . SET FIELD=$PIECE($PIECE(LINE,",Y,",2),")",1)
	. . . IF CLASS'="" IF +FIELD'=0 DO
	. . . . SET SK=$PIECE($GET(^WWW003(0,CLASS,FIELD,1)),Y,6)
	. . . . IF SK'="" WRITE !,P,"+",L,?20," ",LINE  ;,!,LINEX
	
	QUIT
	
]]></Routine>
</Export>