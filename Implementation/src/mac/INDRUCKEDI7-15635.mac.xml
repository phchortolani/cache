<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCKEDI7" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRUCKEDI7 ;INDRUCKEDI7;DT;BERECHNUNG GESAMTBETRAG EDI;19.06.2002  ; Compiled February 24, 2005 09:48:23
#include COMSYS
	/*------------------------------------------------------------------------------
	; Description of Function :
	;		BERECHNUNG GESAMTBETRAG EDI
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 23-Jan-2006	GRF		SR14105: Doco; use $justify in place of long string of
	; 						spaces; disabled blocks
	; 19.Jun.2002	DT		Created
	;-----------------------------------------------------------------------------*/
	NEW XTAB,POS,ERLOESE,KONTEN,A,WAGR,SORTI,STEUER,STEUERKZ,UAN,UAUS,MWSTANZ,ANZAHLG,ANZAHLGN,YZUSATZ,KEY,MWSTANZ,AUF1,AUSSEN
	
	SET YWHRS=$PIECE($GET(^WWWWAE(0,YWHR,1)),Y,2)
	QUIT:$PIECE(YBELEG1,Y,62)'=1  ;KEINE ENDSUMME  ;no 
	IF $PIECE(YAUFTRAG1,Y,2)=2  IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) QUIT:$PIECE(YAUFTRAG1,Y,105)=1   ;105=KEINE ENDSUMME DRUCKEN ;print 
	IF $PIECE(YAUFTRAG1,Y,2)'=2 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13    QUIT:$PIECE(YAUFTRAG1,Y,105)=1   ;105=KEINE ENDSUMME DRUCKEN ;print 
	
	SET YSPA=$justify("",92)
	
	KILL ANZAHLG  ;BRUTTO ANZAHLUNG ARRAY
	KILL ANZAHLGN  ;NETTO ANZAHLUNG ARRAY
	SET ANZAHLG=0
	
	;ANZAHLUNG ;down payment 
	IF YBELEG'=1 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=12 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANGEBOTEN ;Not next to sales order Or 
	. SET ANZAHLG=$$^INAUFANZAHL(YAUFTRAG,$PIECE(YAUFTRAG1,Y,96))     ;I $G(YDEBITOR)'=""
	. IF +ANZAHLG'=0 DO
	. . DO EDI^INDRUCK("???+:"_(ANZAHLG*-1))
	
	SET A=""
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;ÜBERSCHRIFT ;title 
	;IF +GESAMT'=0!(YBELEG=2)!(YBELEG=7)!(YBELEG=17)!(YBELEG=12) DO   ;NUR WENN BETRAG VORHANDEN ;only when Sum on hand 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-17-10-17)  ;IN SPALTE ;within rift 
	. SET A=YTAB_$EXTRACT($$^WWWTEXT(31413)_YSPA,1,17)        ;W "Netto-Warenwert"
	. IF YBELEG=12 SET A=YTAB_$EXTRACT($$^WWWTEXT(32470)_YSPA,1,17)        ;W "Netto-BETRAG"
	. SET A=A_$EXTRACT($$^WWWTEXT(31414)_YSPA,1,10)   ;W "MwSt%"
	. SET A=A_$EXTRACT($$^WWWTEXT(31415)_YSPA,1,17)   ;W "MwSt-Betrag"
	. IF YBELEG'=1 I YBELEG'=3 I YBELEG'=10 IF YBELEG'=13 SET A=A_$EXTRACT($$^WWWTEXT(31416)_YSPA,1,17)   ;W "Rechnungsbetrag"
	. IF YBELEG=1 SET A=A_$EXTRACT($$^WWWTEXT(32173)_YSPA,1,17)    ;W "Angebotsbetrag"
	. IF YBELEG=3!(YBELEG=13) SET A=A_$EXTRACT($$^WWWTEXT(32175)_YSPA,1,17)    ;W "Bestellwert"
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,1,1)),Y,1)
	SET MWST=0,GESAMT=0,MGESAMT=0,NGESAMT=0,MWSTANZ=0
	
	;WENN ZZGL MWST  (NETTO=B TO B) ;when Tax 
	IF +$GET(YINKLMWST)=0 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. ;
	. ;SET A=$$^WWWZAHL(MWPO(MWPO)-$GET(ANZAHLG),12,2,YWHR)  ;W "Netto-Warenwert"
	. ;SET A=MWPO(MWPO)-$GET(ANZAHLG)  ;W "Netto-Warenwert"
	. IF +$GET(ANZAHLG)'=0 DO   ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . SET MWPO(MWPO)=MWPO(MWPO)-$G(ANZAHLGN(MWPO))
	. . SET ANZAHLG=ANZAHLG-$G(ANZAHLGN(MWPO))
	. . IF $ORDER(MWPO(MWPO))="" IF ANZAHLG>0 SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no
	. . QUIT
	. SET A=$$^WWWZAHL(MWPO(MWPO),12,2,YWHR)  ;W "Netto-Warenwert"
	. DO EDI^INDRUCK("MOA+79:"_A)
	. ;
	. SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. SET A=$$^WWWZAHL(MWSTP,5,2)   ;W "MwSt%"
	. SET A=MWSTP   ;W "MwSt%"
	. IF +A>0 DO EDI^INDRUCK("TAX+7+VAT+++:::"_A_":S")
	. ;
	. SET MWST=$JUSTIFY(MWPO(MWPO)-$GET(ANZAHLG)/100*MWSTP,0,2)
	. ;
	. SET A=$$^WWWZAHL(MWST,10,2,YWHR)   ;W "MwSt-Betrag"
	. SET A=MWST   ;W "MwSt-Betrag"
	. DO EDI^INDRUCK("MOA+124:"_A)
	. ;
	. SET GESAMT=GESAMT+$JUSTIFY(MWPO(MWPO)-$GET(ANZAHLG),0,2)   ;GESAMT ;total  ;total whole 
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. IF YBELEG'=12 SET A=$$^WWWZAHL(MWPO(MWPO)-$GET(ANZAHLG)+MWST,12,2,YWHR)   ;W "Rechnungsbetrag"
	. IF YBELEG'=12 SET A=MWPO(MWPO)-$GET(ANZAHLG)+MWST   ;W "Rechnungsbetrag"
	. S YA(2)=""
	. IF YBELEG'=1 I YBELEG'=3 I YBELEG'=10 IF YBELEG'=13 SET YA(2)=$$^WWWTEXT(31416)   ;W "Rechnungsbetrag"
	. IF YBELEG=1 SET YA(2)=$$^WWWTEXT(32173)    ;W "Angebotsbetrag"
	. IF YBELEG=3!(YBELEG=13) SET YA(2)=$$^WWWTEXT(32175)    ;W "Bestel
	. DO EDI^INDRUCK("MOA+128:"_A)
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;WENN INKL MWST  (BRUTTO=B TO C) ;when Tax 
	;IF +$GET(YINKLMWST)=1 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-17-10-17)  ;IN SPALTE ;within rift 
	. SET A=YTAB     
	. SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. SET MWST=$JUSTIFY((MWPO(MWPO)-$GET(ANZAHLG))/(100+MWSTP)*MWSTP,0,2)
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO)-$GET(ANZAHLG)-MWST,12,2,YWHR)_YSPA,1,XTAB)  ;W "Netto-Warenwert"
	. SET A=A_$EXTRACT($$^WWWZAHL(MWSTP,5,2)_YSPA,1,10)   ;W "MwSt%"
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET A=A_$EXTRACT($$^WWWZAHL(MWST,10,2,YWHR)_YSPA,1,XTAB)   ;W "MwSt-Betrag"
	. SET GESAMT=GESAMT+$JUSTIFY(MWPO(MWPO)-$GET(ANZAHLG)-MWST,0,2)   ;GESAMT ;total  ;total whole 
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. IF YBELEG'=12 SET A=A_$EXTRACT($$^WWWZAHL(MWPO(MWPO)-$G(ANZAHLG),12,2,YWHR)_YSPA,1,XTAB)   ;W "Rechnungsbetrag"
	. ;DO SPE^INDRUCK
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	IF YBELEG=12 DO
	. SET MWST=0,MGESAMT=0,NGESAMT=0,MWSTANZ=0
	. SET GESAMTPZ=""
	. IF +$PIECE(YFELDPZ,Y,2)'=0 SET GESAMTPZ=$PIECE(YFELDPZ,Y,2)        ;ZALHLUNG-BETRAG     
	. IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET GESAMTPZ=SUMME*$PIECE(YFELDPZ,Y,3)/100
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-17-10-17)  ;IN SPALTE ;within rift 
	. SET A=YTAB
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET A=A_$EXTRACT($$^WWWZAHL(GESAMTPZ,12,2,YWHR)_YSPA,1,XTAB)   ;WERT "Netto-BETRAG"
	. SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. SET A=A_$EXTRACT($$^WWWZAHL(MWSTP,5,2)_YSPA,1,10)   ;W "MwSt%"
	. SET MWST=$JUSTIFY(GESAMTPZ/100*MWSTP,0,2)
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. SET A=A_$EXTRACT($$^WWWZAHL(MWST,10,2,YWHR)_YSPA,1,XTAB)   ;W "MwSt-Betrag"
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. SET XTAB=17 IF YWHRS="&#8364;" SET XTAB=XTAB+6  ;EUROZEICHEN 6 ZEICHEN MEHR
	. ;
	. SET A=$EXTRACT($$^WWWZAHL(GESAMTPZ+MWST,12,2,YWHR)_YSPA,1,XTAB)       ;W "Rechnungsbetrag"
	. SET A=GESAMTPZ+MWST       ;W "Rechnungsbetrag"
	. S YA(2)=""
	. IF YBELEG'=1 I YBELEG'=3 I YBELEG'=10 IF YBELEG'=13 SET YA(2)=$$^WWWTEXT(31416)   ;W "Rechnungsbetrag"
	. IF YBELEG=1 SET YA(2)=$$^WWWTEXT(32173)    ;W "Angebotsbetrag"
	. IF YBELEG=3!(YBELEG=13) SET YA(2)=$$^WWWTEXT(32175)    ;W "Bestel
	. DO EDI^INDRUCK("MOA+128:"_A)
	
	IF YBELEG'=12 SET NGESAMT=GESAMT  ;NETTO
	IF YBELEG=12 SET NGESAMT=GESAMTPZ,GESAMT=NGESAMT  ;NETTO
	SET GESAMT=GESAMT+$GET(MGESAMT)  ;NETTO + MWST ;Tax 
	
	
	;GESAMTRABATT            ;AUSSCHALTEN ;eliminate 
	;IF YBELEG'=3!(YBELEG=2)!(YBELEG=7)!(YBELEG=17) I YBELEG'=10 I YBELEG'=12 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ;Not next to sales order 
	;. SET RABATT=$P(YAUFTRAG1,Y,71)
	;. IF +RABATT'=0 DO
	;. . SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,49))  ;IN SPALTE ;within rift 
	;. . SET A=$EXTRACT(YTAB_RABATT_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(GESAMT,0,2,YWHR)_YSPA,1,+$PIECE(YBELEG1,Y,63))  ;RABATT ;deduction 
	;. . SET RABATT=$JUSTIFY(GESAMT/100*RABATT,0,2)  ;GESAMTRABATT
	;. . SET A=A_$$^WWWZAHL(RABATT,12,2,YWHR)
	;. . ;DO SPE^INDRUCK
	;. . SET GESAMT=GESAMT-$JUSTIFY(RABATT,0,2)  
	
	IF $G(MWSTANZ)>1!(+$P(YAUFTRAG1,Y,71)'=0) IF +$G(GESAMT)'=0 I YBELEG=2!(YBELEG=7)!(YBELEG=17) DO  ;NUR WENN MEHRERE MWST ZEILEN UND BETRAG > 0 UND BEI RECHNUNGEN/GUTSCHRIFTEN ;only when divers Tax And Sum And next to 
	. ;
	. SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63))  ;IN SPALTE ;within rift 
	. SET A=$$^WWWZAHL(GESAMT,12,2,YWHR)   ;GESAMTBETRAG
	. SET A=GESAMT   ;GESAMTBETRAG
	. DO EDI^INDRUCK("MOA+128:"_A)
	
	;Frachtbedingung kunden ;Freight Condition 
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=12 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ODER TEILZAHUNGEN ;Not next to sales order Or Or 
	. IF $PIECE(YAUFTRAG1,Y,26)'="" DO
	. . NEW KOND,YI,YFRACHT
	. . SET YA(2)=$$^WWWTEXT(32183)  ;FRACHTBEDINGUNGEN
	. . FOR YI=1:1 SET YFRACHT=$piece($piece(YAUFTRAG1,Y,26),";",YI) QUIT:YFRACHT=""  DO
	. . . SET KOND=$GET(^INPARA(YM,"FRACHT",SPRACHE,YFRACHT,1))
	. . . SET A=KOND
	. . . DO EDI^INDRUCK("FTX+ZZZ+"_YA(2)_" "_A)
	
	;ZAHLUNGSBEDINGUNGEN  kunden ;payment terms 
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. IF $PIECE(YAUFTRAG1,Y,56)'="" DO
	. . NEW KOND
	. . SET YA(2)=$$^WWWTEXT(32094)  ;ZAHLUNGSBEDINGUNG
	. . SET KOND=$GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,56),1))
	. . SET A=$PIECE(KOND,Y,1)
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,2)'=0  IF $PIECE(KOND,Y,2)>$PIECE(KOND,Y,4) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,2))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,4)'=0  IF $PIECE(KOND,Y,4)>$PIECE(KOND,Y,2) SET A=A_" "_$$^WWWTEXT(32174)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,4))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . SET $PIECE(YAUFTRAG1,Y,74)=$PIECE(KOND,Y,3)  ;SKONTO
	. . SET $PIECE(YAUFTRAG1,Y,75)=$PIECE(KOND,Y,2)  ;TAGE
	. . SET $PIECE(YAUFTRAG1,Y,76)=$PIECE(KOND,Y,4)   ;NETTO
	. . DO EDI^INDRUCK("FTX+ZZZ+"_YA(2)_" "_A)
	
	;ZAHLUNGSBEDINGUNGEN bestellung ;payment terms 
	IF YBELEG=3!(YBELEG=13) DO   ; BEI BESTELLUNG ;next to sales order 
	. NEW YPOS
	. SET YPOS=$ORDER(YAUFTRAG(""))
	. IF YPOS="" SET YPOS=" "
	. IF '$DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;KEINE SPEZIALKONDITION NUR DIE KONDITION DES LIEFERANTEN ;no only who 
	. . IF $PIECE(YADRES,Y,56)'="" DO
	. . . NEW KOND
	. . . SET YA(2)=$$^WWWTEXT(32094)_" "  ;ZAHLUNGSBEDINGUNG
	. . . SET KOND=$GET(^INKOND(YM,$PIECE(YADRES,Y,56),1))
	. . . QUIT:$PIECE(KOND,Y,1)=""
	. . . SET A=$PIECE(KOND,Y,1)
	. . . DO EDI^INDRUCK("FTX+ZZZ+"_YA(2)_" "_A)
	. . . QUIT
	. . QUIT
	. IF $DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;SPEZIALKONDITION DES AUFTRAGES
	. . NEW KOND1,YZ
	. . SET KOND1=$GET(^INAUFPK(YM,YAUFTRAG,YPOS,1))
	. . SET YA(2)=$$^WWWTEXT(32094)  ;ZAHLUNGSBEDINGUNG
	. . IF +$PIECE(KOND1,Y,7)'=0 DO   ;SKONTO
	. . . IF +$PIECE(KOND1,Y,9)'="" DO
	. . . . SET A=" "_$$^WWWTEXT(32091)_" "_$PIECE(KOND1,Y,9)_" "_$$^WWWTEXT(32092)   ;IN XXX TAGEN ;within 
	. . . . QUIT
	. . . SET A=A_" "_$PIECE(KOND1,Y,7)_$$^WWWTEXT(32090)   ;% SKONTO
	. . . QUIT
	. . IF +$PIECE(KOND1,Y,10)'=0 DO   ;NETTO
	. . . SET A=A_" "_$PIECE(KOND1,Y,10)_" "_$$^WWWTEXT(32093)   ;Tage Netto ;days Net 
	. . . QUIT
	. . IF A=$$^WWWTEXT(32094)   ;KEINE ZAHLUNGSBEDINGUNG ;no 
	. . DO EDI^INDRUCK("FTX+ZZZ+"_A)
	
	;STEUER GGF NEU SETZEN ;tax recent typeset 
	IF $GET(YKUNDE)'="" DO
	. IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)  ;STEUER ;tax 
	
	IF $GET(YLIEFER)'="" DO
	. IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER ;tax
	
	;umsatzsteuer id nummer auf kundenbeleg und lieferantenbestellung (YADRES) ;upon and 
	DO 
	. IF $PIECE(YADRES,Y,54)=2 DO  ;EG Ausland ;foreign country 
	. . NEW IDNR
	. . SET IDNR=$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,20)
	. . QUIT:IDNR=""   ;KEINE  ID ;no ID 
	. . SET YA(2)=$$^WWWTEXT(32158)  ;Steuer id nummer ;tax no 
	. . SET A=IDNR
	. . DO EDI^INDRUCK("FTX+ZZZ+"_YA(2)_" "_A)
	
	QUIT:$get(YPROFORMA)=1     ;NUR PROFORMARECHNUNG ;only proforma invoice 
	QUIT:+$GET(YCOPY)=1   ;NUR WIEDERHOLUNGSDRUCK ;only 
	QUIT:$GET(YTEST)'=""  ;NUR TEST ;only Test 
	IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 QUIT   ;KEINE RECHUNG KEINE GUTSCHRIFT ;no no 
	
	SET AUSSEN=1   ;FAN 26.10.2001  NICHT VON AUSSEN EINSPRUNG   &  NACH RECHNUNG DRUCHEN ;buff Not within tab 
	
	DO BUCHEN^INDRUCK7
	QUIT
]]></Routine>
</Export>