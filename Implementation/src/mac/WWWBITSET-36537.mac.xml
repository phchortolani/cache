<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWBITSET" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWBITSET(YDATEI,YKEY,SET,YFELD,YKILLBI,YBITLIST,NOBACKGROUND,YYM,YXREF)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BITS SETZTEN ODER LÖSCHEN
	;       S OK=$$^WWWBITSET(YDATEI,YKEY,1)  ;BEISPIEL
	;
	; Inputs : 
	;	YDATEI      	= DATEI
	;	YKEY        	= KEY
	;	SET         	= 1 = SET 1 ;table-mat table-mat 
	;	SET         	= 0 = KILL, SET 0
	;	YFELD       	= DATENSATZ ; RECORD
	;	YKILLBI     	= 1  ;KILL bi FILE
	;	YBITLIST    	="1,2,3" ;DANN NUR ÄNDERUNG DER BITS , WENN "" DANN ALLE BITS
	;	NOBACKGROUND	="1" = NOT IN BACKGROUND
	;	YYM         	= COMPANY OR 0 FOR CENTRAL FILE OR "" 
	;	YXREF		  	= XREF FILE FOR BITS LIKE
	;	
	; ByRef :
	;
	; Returns :
	;
	; History :
	; 28-Sep-2007	GRF		Doco; quits
	; 31-May-2007	HeberB	BR014465:Add new characters
	; 23.06.2003	DT
	;-------------------------------------------------------------------------------
	;QUIT ""  ;AUSGESCHALTET = TEST TYBD;24.06.2003
	quit 1  ; Not used
	NEW RETURN,YRET,WWWYM
	
	SET RETURN="" 
	QUIT:$GET(YDATEI)="" RETURN
	;QUIT:$GET(YKEY)="" RETURN 
	QUIT:$TR($GET(YKEY),"""")="" RETURN        ;BEC;27141;11.01.05
	
	SET WWWYM    = $GET(YYM)
	SET YKILLBI  = $GET(YKILLBI)
	SET YBITLIST = $GET(YBITLIST)
	SET YXREF    = $GET(YXREF)
	SET SET      = $GET(SET)
	
	IF $GET(NOBACKGROUND)'=1 IF $PIECE($GET(^WWW012(0,YM,1)),Y,167)=1 DO  IF RETURN=1 QUIT RETURN  ;HINTERGRUNDVERARBEITUNG
	. NEW YNEXT
	. IF '$DATA(^WWWBITRUN) SET ^WWWBITRUN=""
	. LOCK +^WWWBITRUN:0 IF $TEST LOCK -^WWWBITRUN JOB ^WWWBITRUN::0 IF '$TEST QUIT  ;NICHT MÖGLICH ;Not potential 
	. SET YNEXT=$$^WWWNEXT("WWWBITRUN")
	. SET ^WWWBITRUN(YM,YNEXT,1,1)=YDATEI
	. SET ^WWWBITRUN(YM,YNEXT,2,1)=YKEY
	. SET ^WWWBITRUN(YM,YNEXT,3,1)=YFELD
	. SET ^WWWBITRUN(YM,YNEXT,4,1)=SET_Y_YKILLBI_Y_YBITLIST_Y_WWWYM_Y_YXREF
	. SET RETURN=1
	
	;UMLAUTE IN $TR ; TYBD;30,9,2004
	;BR014465
	;SET LC="ÜÄÖüäöß][\}{|abcdefghijklmnopqrstuvwxyz,()@#$%^&*_=+<>?/"_$CHAR(128)_""""_" "   ;SPEEDUP;TYBD;25.09.2004
	;SET UC="UAOUAOSUAOUAOABCDEFGHIJKLMNOPQRSTUVWXYZ                   "
	SET LC="áàãâéèêíìîóòõôúùûçÜÄÖüäöß][\}{|abcdefghijklmnopqrstuvwxyz,()@#$%^&*_=+<>?/"_$CHAR(128)_""""_" "   ;SPEEDUP;TYBD;25.09.2004
	SET UC="ÁÀÃÂÉÈÊÍÌÎÓÒÕÔÚÙÛÇUAOUAOSUAOUAOABCDEFGHIJKLMNOPQRSTUVWXYZ                   "
	SET WWWYM=$P($GET(YYM),",",1)  ;NICHT MIT ","
	IF WWWYM="" SET WWWYM=$$^WWWYM(YDATEI,0)  ;VERSCHOBEN;TYBD;27.10,2004
	IF $GET(YXREF)'="" DO  IF +$PIECE($GET(^WWW001(0,YDATEI,1)),Y,24)=0 QUIT RETURN  ;SETZEN XREF DATEI
	. SET RETURN=$$^WWWBITSETXREF(YDATEI,YXREF,YKEY,$PIECE(YKEY,",",$LENGTH(YKEY,",")),SET,WWWYM)  ;TYBD;20,12,2004;UNTERBITMAP
	. SET RETURN=1
				
	;SET YRET(1)="SET YRET=$SORTBEGIN(^"_YDATEI_"b)" XECUTE YRET(1)
	;SET YRET(1)="SET YRET=$SORTBEGIN(^"_YDATEI_"bi)" XECUTE YRET(1)
	DO
	. NEW BIT,BITX,BITS,BITM,COUNT,FIELD,YLFN,YLFN1,OK,YKEY1,ID,SCHL
	. SET OK=0
	. DO 
	. . SET YKEY=$EXTRACT(YKEY,1,128)             ;BEC;27141;11.01.05
	. . SET SCHL(1)="^"_YDATEI_"bi("_""""_WWWYM_""""_","_2_","_""""_$TRANSLATE(YKEY,"""")_""""_")"
	. . SET SCHL(10)="^"_YDATEI_"bi("_""""_WWWYM_""""_","_2_","_""""_$TRANSLATE(YKEY,"""")_""""_",ID)"
	. . SET SCHL(2)="^"_YDATEI_"bi("_""""_WWWYM_""""_","_1_",ID,"_""""_$TRANSLATE(YKEY,"""")_""""_")"
	. . SET SCHL(3)="^"_YDATEI_"bi("_""""_WWWYM_""""_")"
	. . IF '$DATA(@SCHL(1)) DO
	. . . LOCK +@SCHL(3):1
	. . . SET ID=$GET(@SCHL(3))+1
	. . . SET @SCHL(3)=ID
	. . . SET @SCHL(10)=""
	. . . SET @SCHL(2)=""
	. . . LOCK -@SCHL(3)
	. . ;
	. . SET ID=""
	. . SET ID=$ORDER(@SCHL(10))
	. . IF ID'="" DO
	. . . ;SET YKEY=ID   ;NEUE ID ;table-mat ID 
	. . . SET OK=1
	. ;
	. QUIT:OK=0
	. ;
	. SET BIT=0   ;=DATENSATZ VORHANDEN j/n ;on hand 
	. SET BITX=1  ;=DATENbit
	. SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)  ;KEY, MAIN BIT 0 = EXISTS
	. DO  ;SET KEY ALS FULLTEXT ;table-mat KEY when 
	. . SET BIT=9999  ;FÜR FULLTEXT DES KEY ;to KEY 
	. . IF YUMLAU="" SET BITX=$TRANSLATE(YKEY,LC,UC)  ;TYBD;6,11,2003;MIT UMSETZTUNG;26526
	. . IF YUMLAU'="" SET BITX=$$^WWWUMLAU(YKEY,1)  ;TYBD;6,11,2003;MIT UMSETZTUNG;26526
	. . SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)  ;KEY IN FULLTEXT ;KEY within 
	. ;
	. IF YKILLBI=1 DO  ;LÖSCHEN bi, da datensatz gelöscht
	. . KILL @SCHL(10)
	. . KILL @SCHL(2)
	. ;
	. SET RETURN=1  ;OK
	. IF YFELD="" QUIT  ;NO DELETE OR SET ON NO DATA;TYBD;29,10,2004
	. ;
	. ;DATENFELDER
	. ;
	. SET YLFN=""
	. FOR  SET YLFN=$ORDER(^WWW001B(0,YDATEI,YLFN)) QUIT:YLFN=""  DO
	. . IF $GET(YBITLIST)'="" QUIT:'$FIND(","_YBITLIST_",",","_YLFN_",")  ;NICHT IN DER LISTE ;Not within the list 
	. . SET YLFN1=$GET(^WWW001B(0,YDATEI,YLFN,1))
	. . DO SETBIT
	. ;
	. ;CUSTOMIZING
	. SET YLFN=""
	. FOR  SET YLFN=$ORDER(^WWW001BD(0,YDATEI,YM,YLFN)) QUIT:YLFN=""  DO
	. . SET YLFN1=$GET(^WWW001BD(0,YDATEI,YM,YLFN,1))
	. . DO SETBIT
	
	;SET YRET(1)="SET YRET=$SORTEND(^"_YDATEI_"bi)" XECUTE YRET(1)
	;SET YRET(1)="SET YRET=$SORTEND(^"_YDATEI_"b)" XECUTE YRET(1)
	QUIT RETURN
	
SETBIT ; 
	;FULLTEXT
	IF +$PIECE(YLFN1,Y,5)=1 IF $PIECE(YFELD,Y,YLFN)'="" DO    ;FULLTEXT BIT = GENAUER INHALT ;bit purport 
	. SET BIT=9999  ;FELDNUMMER = FULLTEXT
	. ;SET BITX(2)=$TRANSLATE($PIECE(YFELD,Y,YLFN),",;:-_!?=(){}§$&/´#'|<>."_"""","                       ")  ;TYBD;BIT MIT . UND , BEI 0.10 UND 
	. SET BITX(2)=$TRANSLATE($PIECE(YFELD,Y,YLFN),";:_!?=(){}§$&´#'|<>"_"""","                       ")
	. FOR BITX(1)=1:1 QUIT:$PIECE(BITX(2)," ",BITX(1),9999)=""  DO
	. . SET BITX=$EXTRACT($PIECE(BITX(2)," ",BITX(1)),1,50)
	. . ;
	. . ;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK
	. . ;AB HIER PRÜFUNG DER ZAHLEN ALS .;TYBD;17.01.2005
	. . ;IF $FIND(BITX,".") DO  ;"." WIRD NICHT IN WWWUMLAU UMGESETZT;FIS;03.03.05
	. . . IF $EXTRACT($REVERSE($PIECE(BITX,".",2)))=0!($EXTRACT($PIECE(BITX,".",2))>0) QUIT  ;NUMBER DO NOT CHANGE;TYBD;17.1.2004
	. . . SET BITX=$TRANSLATE(BITX,"."," ")
	. . ;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
	. . ;
	. . ;AB HIER PRÜFUNG DER ZAHLEN ALS ,;TYBD;17.01.2005
	. . IF $FIND(BITX,",") DO
	. . .IF $EXTRACT($REVERSE($PIECE(BITX,",",2)))=0!($EXTRACT($PIECE(BITX,",",2))>0) QUIT  ;NUMBER DO NOT CHANGE;TYBD;17.1.2004
	. . .SET BITX=$TRANSLATE(BITX,","," ")
	. . ;
	. . ;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK
	. . ;AB HIER PRÜFUNG DER ZAHLEN ALS ,;TYBD;17.01.2005
	. . ;IF $FIND(BITX,"-") DO  ;"-" WIRD NICHT IN WWWUMLAU UMGESETZT;FIS;03.03.05
	. . .IF $EXTRACT($REVERSE($PIECE(BITX,"-",2)))=0!($EXTRACT($PIECE(BITX,"-",2))>0) QUIT  ;NUMBER DO NOT CHANGE;TYBD;17.1.2004
	. . .SET BITX=$TRANSLATE(BITX,"-"," ")
	. . ;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
	. . ;
	. . ;AB HIER PRÜFUNG DER ZAHLEN ALS ,;TYBD;17.01.2005
	. . IF $FIND(BITX,"/") DO
	. . .IF $EXTRACT($REVERSE($PIECE(BITX,"/",2)))=0!($EXTRACT($PIECE(BITX,"/",2))>0) QUIT  ;NUMBER DO NOT CHANGE;TYBD;17.1.2004
	. . .SET BITX=$TRANSLATE(BITX,"/"," ")
	. . ;
	. . QUIT:$TRANSLATE(BITX," ")=""  ;WENN KEIN INHALT;NO CONTENT;TYBD;29,10,2004
	. . ;
	. . ;SET BITX=$TRANSLATE(BITX,",;:-_!=()/&´#'")  ;DATEN Bit;TYBD;6,11,2003;NUR WWWUMLAU;26526
	. . IF YUMLAU="" SET BITX=$TRANSLATE(BITX,LC,UC)
	. . IF YUMLAU'="" SET BITX=$$^WWWUMLAU(BITX,1,1)
	. . QUIT:$TRANSLATE(BITX," ")=""  ;WENN KEIN INHALT;NO CONTENT;TYBD;29,10,2004
	. . ;
	. . SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)
	
	;NUR WENN GLEICH DER VORGABE ;only when without delay the default 
	;IF $PIECE(YLFN1,Y,1)=$PIECE(YFELD,Y,YLFN) DO  QUIT  ;NUR WENN GLEICH INHALT
	IF $PIECE(YLFN1,Y,1)'="" IF $PIECE(YLFN1,Y,1)=$PIECE(YFELD,Y,YLFN) DO    ;NUR WENN GLEICH INHALT  ;FIS;24.06.04;25940
	. SET BIT=YLFN  ;FELDNUMMER 
	. SET BITX=1    ;DATENbit IMMER 1 ;constantly 
	. SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)
	
	;NUR WENN NICHT LEER ;only when Not void 
	IF $PIECE(YLFN1,Y,2)=1 IF $PIECE(YFELD,Y,YLFN)'="" DO   ;NUR WENN NICHT LEER ;only when Not void 
	. SET BIT=YLFN  ;FELDNUMMER
	. SET BITX=1    ;DATEN Bit
	. SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)
	
	;SUMMENBILDUNG
	;IF $PIECE(YLFN1,Y,3)=1 IF $PIECE(YFELD,Y,YLFN)'="" DO  QUIT  ;SUMMENBILDUNG
	IF $PIECE(YLFN1,Y,3)=1 DO  
	. SET BIT=YLFN  ;FELDNUMMER
	. IF +$PIECE(YFELD,Y,YLFN)=0 DO  QUIT  ;SUMME LÖSCHEN;FIS;25940;24.06.04
	. . FOR BITX=1:1:40 SET OK=$$^WWWBIT(YDATEI,ID,YLFN,BITX,0,WWWYM)
	. ;
	. SET BITM=""
	. SET BITR=$PIECE(YFELD,Y,YLFN)*100  ;BETRAG ;Sum 
	. FOR BITX=1:1 QUIT:BITR<1  DO
	. . SET $EXTRACT(BITM,BITX)=BITR#2
	. . SET BITR=BITR\2
	. . IF BITR<1 SET BITR=0
	. ;
	. FOR BITX=1:1:$LENGTH(BITM) IF $EXTRACT(BITM,BITX)=1 DO
	. . SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)
	
	;GENAUER INHALT ;purport 
	;IF +$PIECE(YLFN1,Y,4)=1 DO    ;BIT = EXACT ;OLD VERSION;SR13264;FIS;26.08.05
	. SET BIT=YLFN  ;FELDNUMMER
	. SET BITX="" 
	. IF $PIECE($GET(^WWW003(0,YDATEI,YLFN,1)),Y,3)=2 IF $PIECE(YFELD,Y,YLFN)'=1 SET $PIECE(YFELD,Y,YLFN)=0  ;JA/NEIN FELD = 0/1 ;field 
	. IF YUMLAU=""  SET BITX=$TRANSLATE($EXTRACT($PIECE(YFELD,Y,YLFN),1,50),LC,UC)  ;DATEN Bit
	. IF YUMLAU'="" SET BITX=$$^WWWUMLAU($EXTRACT($PIECE(YFELD,Y,YLFN),1,50),1)  ;DATEN Bit;TYBD;26526;6,10,2004
	. IF $PIECE(YFELD,Y,YLFN)="" SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,0,WWWYM) QUIT  ;LÖSCHEN ;Delete 
	. QUIT:BITX=""
	. SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)
	
	IF +$PIECE(YLFN1,Y,4)=1 DO    ;BIT = EXACT ;NEW VERSION;SR13264;FIS;26.08.05
	. SET BIT=YLFN  ;FELDNUMMER
	. SET BITX=""
	. IF $PIECE($GET(^WWW003(0,YDATEI,YLFN,1)),Y,3)=2 IF $PIECE(YFELD,Y,YLFN)'=1 SET $PIECE(YFELD,Y,YLFN)=0  ;YES/NO FIELD = 0/1
	. IF $PIECE(YFELD,Y,YLFN)="" SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,0,WWWYM) QUIT  ;LÖSCHEN ;Delete 
	. IF YUMLAU="" SET BITX(2)=$TRANSLATE($EXTRACT($PIECE(YFELD,Y,YLFN),1,50),LC,UC)  ;DATEN Bit
	. IF YUMLAU'="" SET BITX(2)=$$^WWWUMLAU($EXTRACT($PIECE(YFELD,Y,YLFN),1,50),1)  ;DATEN Bit;TYBD;26526;6,10,2004
	. FOR BITX(1)=1:1 QUIT:$PIECE(BITX(2),";",BITX(1),999)=""  DO   ;WENN PARAMETER;TYBD;21,4,2005;
	. . SET BITX=$EXTRACT($PIECE(BITX(2),";",BITX(1)),1,50)
	. . ;IF $PIECE($GET(^WWW003(0,YDATEI,YLFN,1)),Y,3)=2 IF BITX'=1 SET BITX=0  ;JA/NEIN FELD = 0/1 ;field 
	. . ;IF $PIECE(YFELD,Y,YLFN)="" SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,0,WWWYM) QUIT  ;LÖSCHEN ;Delete ;FIS;27.05.05;27744;IN TEMP FILE AUFBAUEN
	. . QUIT:BITX=""
	. . SET OK=$$^WWWBIT(YDATEI,ID,BIT,BITX,SET,WWWYM)  ;FIS;27.05.05;27744;IN TEMP FILE AUFBAUEN
	
	QUIT
]]></Routine>
</Export>