<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWDRAGDROP2" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWDRAGDROP2(YFUNCTION,OBJEKT)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		AUSFÜHREN EVENT
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 07-Nov-2007	GRF		Doco; quits
	; 15.08.2003	FIS		Created
	;-------------------------------------------------------------------------------
	NEW YRETVAL,YFELD,YFELDNAME,YSUCH,YNUM,YCHART,YINUSE,YCHART1,YHTMFORM,Q,YKEY,YSKEY,YI
	
	SET YRETVAL=""
	SET YINUSE=0
	SET Q=0
	SET OBJEKT=$GET(OBJEKT)
	SET YHTMFORM="WWW"
	IF $GET(YFUNCTION)'="" DO
	. SET YCHART=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","CHART",1))
	. IF YCHART="" SET YRETVAL="!"_$$^WWWTEXT(119,,1) QUIT  ;FEHLER DATENSATZ NICHT GEFUNDEN ;shortcoming data record Not 
	. ;
	. SET YSKEY=""
	. SET YKEY=OBJEKT
	. IF $FIND(OBJEKT,"_") SET YKEY=$PIECE(OBJEKT,"_",1)_"-"_$PIECE(OBJEKT,"_",2)
	. IF $PIECE(OBJEKT,"_",3,999)'="" SET $PIECE(YKEY,"-",3)=$TRANSLATE($PIECE(OBJEKT,"_",3,999),"_",".")
	. IF $FIND(YKEY,"%s%") SET YSKEY=$PIECE(YKEY,"%s%",2) SET YKEY=$PIECE(YKEY,"%s%",1)
	. SET YFELDNAME="Y"_$TRANSLATE(YKEY,".-","__")
	. ;IF YSKEY'="" SET YFELDNAME=YFELDNAME_"%s%"_YSKEY
	. IF YSKEY'="" SET YFELDNAME=YFELDNAME_"_s_"_YSKEY  ;Fehler bei % in Query ! ;Error next to within 
	. SET YFELDNAME=YFELDNAME_"M"  ;ACHTUNG YKEY WIRD DANACH VERÄNDERT ;estimation thereafter 
	. ;
	. SET ARBBEGINN=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","ARBBEGINN",1))  ;ARBEITSGEBINN
	. ;
	. SET YCHART1=$$VORG^WWWDRAGDROP(YCHART)   ;VORGABEN CHART
	. IF $PIECE(YCHART1,Y,34)'="" DO  ;LOCK PRÜFUNG ;quiz 
	. . NEW YDATEI,LOCK,EXEC
	. . SET YDATEI="^"_$PIECE(YCHART1,Y,34)_"("_""""_$$^WWWYM($PIECE(YCHART1,Y,34))_""""_","_""""_$PIECE(YKEY,"-",1)_""""
	. . IF $PIECE(YKEY,"-",2)'="" SET YDATEI=YDATEI_","_""""_$PIECE(YKEY,"-",2)_""""
	. . IF $PIECE(YKEY,"-",3)'="" SET YDATEI=YDATEI_","_""""_$PIECE(YKEY,"-",3)_""""
	. . SET YDATEI(2)=$TRANSLATE(YDATEI,"(,"_"""","/.")_"1/"
	. . SET YDATEI=YDATEI_",1)"
	. . IF $DATA(^WWW006(0,+$HOROLOG,YDATEI(2))) DO
	. . . IF $PIECE($GET(^WWW006(0,+$HOROLOG,YDATEI(2),1)),Y,1)'=YBED SET YINUSE=1  ;LOCK PRÜFEN ;check 
	. ;
	. IF YSKEY=""  SET YFELD=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","DATEN",YKEY,1))              ;HOLEN DATEN ;send for 
	. IF YSKEY'="" SET YFELD=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","DATEN",YKEY_"%s%"_YSKEY,1))  ;HOLEN DATEN ;send for 
	. ;
	. IF YINUSE'=1 DO
	. . SET YNUM=""
	. . FOR  SET YNUM=$ORDER(^WWWDRAGDROPD(0,YCHART,YNUM)) QUIT:YNUM=""  DO
	. . . IF $PIECE($GET(^WWWDRAGDROPD(0,YCHART,YNUM,1)),Y,3)'=1 QUIT  ;NICHT ÄNDERBAR ;Not 
	. . . IF $PIECE($GET(^WWWDRAGDROPD(0,YCHART,YNUM,1)),Y,7)'=1 QUIT:$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V",YFELDNAME_YNUM,1))=""     ;KEINE LEEREN FELDER ERLAUBT ;no permissive 
	. . . ;IF YNUM=$PIECE(YCHART1,Y,21)!(YNUM=$PIECE(YCHART1,Y,22)) QUIT:$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V",YFELDNAME_YNUM,1))=""  ;NICHT MÖGLICH, DA FÜR CHART WICHTIG
	. . . SET $PIECE(YFELD,Y,YNUM)=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V",YFELDNAME_YNUM,1))
	. . ;
	. . XECUTE YFUNCTION  ;EXECUTE NACH ÄNDERUNG ;EXECUTE within alteration 
	. . ;
	. . IF $EXTRACT(YRETVAL)="!" SET YRETVAL=" alert("_""""_$TRANSLATE($EXTRACT(YRETVAL,2,999),"'"_"""","´´")_""""_");"
	. . IF Q=1 SET YFELD=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","DATEN",YKEY,2)) QUIT  ;ALTE DATEN ZURÜCKHOLEN
	. . ;
	. . IF YSKEY=""  SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","DATEN",YKEY,1)=YFELD              ;SETZEN DATEN ;typeset 
	. . IF YSKEY'="" SET ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"V","DATEN",YKEY_"%s%"_YSKEY,1)=YFELD  ;SETZEN DATEN ;typeset 
	. . SET YRETVAL=$$^WWWDRAGDROP4()_YRETVAL  ;PRÜFEN ÄNDERUNGEN UND NEUSETZTEN DIAGRAMM ;check And 
	. ;
	. IF YINUSE=1 SET YRETVAL=YRETVAL_" alert("_""""_$$^WWWTEXT(392,,1)_""""_");"  ; "Another User has changed the data record. Please Refresh This Page. Save is not possible."
	. IF YRETVAL'="" SET YRETVAL="#FUNCTION~"_YRETVAL
	
	QUIT YRETVAL
]]></Routine>
</Export>