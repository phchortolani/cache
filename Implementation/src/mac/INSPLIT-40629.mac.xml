<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INSPLIT" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INSPLIT(AUF,POS,MG,ML,MR,ME,WH)
#include COMSYS
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		SPLITTEN AUFTRAGSPOSITIONEN
	;		Split Order Line
	; 
	; Called By :
	;	Routines	INAUFSPLIT		(AUF,POS,MG,   ML,MR)
	;				INAUFWHSPLIT	(AUF,POS,MG,   ML,MR)
	;				INDRPRUN8		(AUF,POS,OldD5,ML,MG-ML,OldD6)
	;				INERECH1SPLIT	(AUF,POS,MG,   ML,MR)
	;				INPICKCHECK		(AUF,POS,OldD5,ML,MG-ML,0,1)
	;				INWEAUFSPLIT	(AUF,POS,MG,   ML,MR)
 
	; Inputs : 
	;	AUF		idOrder									AUFTRAGSNUMMER
	;	POS		idOrderLine								POSITIONSNUMMER
	;	MG		Entire Qty								GESAMTE MENGE
	;	ML		Available Qty							LIEFERBARE MENGE
	;	MR		Remainder of Qty (INNEUEN Split)		REST MENGE INNEUEN SPLIT
	;	ME		Qty stored as (booking)					MENGE ALS EINGELAGERT BUCHEN
	;	WH		Goods Origin of the new open line		WARENHERKUNFT DER NEUEN POS. OFFEN LASSEN
	;
	;	Entire Qty (MG) => Available Qty (ML) in Existing Line + Remainder (MR) in New Order Line
	; 
	; ByRef :
	;	POSNEU		(New order number - apparently passed back per comment not to new it.
	;
	; Returns :
	;
	;
	; History :
	; 12-Oct-2006	GRF		Doco
	; 02-Oct-2006	GRF		SR15107: Doco; remove *-1 replacing -ve with +ve; boolean
	; 						macros; ensure WHMNG clearly set
	; 22.02.2005	FIS		PREISEINHEIT;27384
	; 19.02.2005	TYBD	27377
	;            	FIS		24053: MENGE 0 BEI FESTLEGEN WH
	; 25.06.2003	FIS		23781;BESTELLMENGE IN LIEFERSCHEIN
	; 18.10.2002	DT
	;-------------------------------------------------------------------------------
	NEW MNGU,POSALT1,POSNEU1,WERT,WHMNG
	;NEW POSNEU  ;NICHT NEW, DA DURCH AUFRUFENDE PROGRAMME BENUTZT (Z.B. INAUFSPLIT) ;FIS;24.02.05
	
	;POS1:DATENSATZ VON AUFTRAGPOSITION VOR SPLIT ;pre- 
	QUIT:$GET(AUF)=""
	QUIT:$GET(POS)=""
	SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	QUIT:POS1=""
	
	SET MG=$GET(MG)
	SET ML=$GET(ML)
	SET MR=$GET(MR)
	SET ME=$GET(ME)
	SET WH=$GET(WH)
	
	;---------------------------------------
	;	D6			$$$INAUFPQuantity1()
	;	D262		$$$INAUFPOldSuggestedQuantityPPG()
	;---------------------------------------
	SET MNGU=$PIECE(POS1,Y,262)         ;URSPRÜNGLICHE BESTELLMENGE ;ordering quantity 
	IF +MNGU=0 SET MNGU=MG
	SET WHMNG=$select(WH=1:+$PIECE(POS1,Y,6),1:0)  ;MERKEN URSPR. WH MENGE ;quantity      ; 02-Oct-2006  1=Source from Order
	
	;--------------------------------------------------NEU POSITON--------INAUFP
	SET POSNEU=$ORDER(^INAUFP(YM,AUF,""),-1)+1
	MERGE ^INAUFP(YM,AUF,POSNEU,1)=^INAUFP(YM,AUF,POS,1)
	; <<<<< OLD BLOCK OF CODE #1 MOVED TO END OF ROUTINE >>>>>
	SET POSNEU1=$GET(^INAUFP(YM,AUF,POSNEU,1))
	; FIXME : SR15107 : Use D109 Received quantity if non-null? <GRF>    <DEFERRED FOR PURCHASE ORDER REVIEW>
	SET $PIECE(POSNEU1,Y,5)=MR
	SET $PIECE(POSNEU1,Y,6)=ME
	IF ME="" SET $PIECE(POSNEU1,Y,6)=MR
	SET $PIECE(POSNEU1,Y,47)=$PIECE(POS1,Y,47)*MR/MG
	;SET $PIECE(POSNEU1,Y,119)=$JUSTIFY(MR*$PIECE(POS1,Y,118),0,2)  ;MENGE * PREIS ;quantity * price
	SET $PIECE(POSNEU1,Y,119)=$JUSTIFY(MR/$$^INQTYUNIT($PIECE(POS1,Y,4),AUF,POSNEU)*$PIECE(POS1,Y,118),0,$$^WWWDECIMALLEN("INAUFP",119))  ;MENGE * PREIS ;FIS;22.02.05;PREISEINHEIT;27384
	SET NETTO=$PIECE(POSNEU1,Y,119)  ;ERRECHNEN NETTO PREIS ;price 
	IF +$PIECE(POS1,Y,121)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,121))
	IF +$PIECE(POS1,Y,122)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,122))
	IF +$PIECE(POS1,Y,128)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,128))
	IF +$PIECE(POS1,Y,212)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,212))       ;TYBD;19.2.2005:GEM;27377
	IF +$PIECE(POS1,Y,214)'=0 SET NETTO=NETTO+(NETTO/100*$PIECE(POS1,Y,214))       ;TYBD;19.2.2005:GEM;27377   ; 02-Oct-2006 replace *-1
	SET NETTO=NETTO+$PIECE(POS1,Y,211)  ;ZUSCHLAG BETRAG  210=BEGRÜNDUNG ;surcharge Sum
	SET $PIECE(POSNEU1,Y,123)=$JUSTIFY(NETTO,0,2)      ; Nett Sales Price
	SET $PIECE(POSNEU1,Y,116)=0                        ; Reached Additional Charge
	SET WERT=0
	IF +$PIECE(POSNEU1,Y,47)'=0 SET WERT=$PIECE(POSNEU1,Y,123)/($PIECE(POSNEU1,Y,47)+$PIECE(POSNEU1,Y,71))-1*100
	IF +WERT'=0 SET $PIECE(POSNEU1,Y,116)=$JUSTIFY(WERT,0,2)  ;AUFSCHLAG ;overcharge 
	SET $PIECE(POSNEU1,Y,90) =$$$NO       ; Ready for Delivery
	SET $PIECE(POSNEU1,Y,242)=""    ; split forward link
	SET $PIECE(POSNEU1,Y,243)=POS   ; split back link
	SET $PIECE(POSNEU1,Y,262)=MNGU  ; pre-split quantity  ;HISTORY URSPRÜNGLICHE MENGE
	SET $PIECE(POSNEU1,Y,322)=""    ;URSPRÜNGLICHE MENGE;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	SET $PIECE(POSNEU1,Y,323)=0     ;GESPLITTETE MENGE  ;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	SET $PIECE(POSNEU1,Y,109)=""    ; Incoming Goods Quantity
	IF $PIECE(POSNEU1,Y,12)'="" IF $PIECE($GET(^INLIEF(YM,$PIECE(POSNEU1,Y,12),1)),Y,244)=1 NEW YI FOR YI=91,92,93,94 SET $PIECE(POSNEU1,Y,YI)=""  ;FIS;22.02.05;LIEFERINFORMATIONEN WIEDER LÖSCHENB
	DO
	. NEW YFORM,YVOR,YOK
	. SET YOK=$$^WWWSPEI("INAUFP",AUF_","_POSNEU,POSNEU1,1)
	
	; <<<<< OLD BLOCK OF CODE #2 MOVED TO END OF ROUTINE >>>>>
	SET POSALT1=POS1
	; FIXME : SR15107 : Use D109 Received quantity if non-null? <GRF>    <DEFERRED FOR PURCHASE ORDER REVIEW>
	SET $PIECE(POSALT1,Y,5)=ML
	SET $PIECE(POSALT1,Y,6)=ME
	IF ME="" SET $PIECE(POSALT1,Y,6)=ML
	SET $PIECE(POSALT1,Y,47)=$PIECE(POS1,Y,47)*ML/MG
	;SET $PIECE(POSALT1,Y,119)=$JUSTIFY(ML*$PIECE(POS1,Y,118),0,2)  ;MENGE * PREIS ;quantity * price 
	SET $PIECE(POSALT1,Y,119)=$JUSTIFY(ML/$$^INQTYUNIT($PIECE(POS1,Y,4),AUF,POS)*$PIECE(POS1,Y,118),0,$$^WWWDECIMALLEN("INAUFP",119))  ;MENGE * PREIS ;FIS;22.02.05;PREISEINHEIT;27384
	SET NETTO=$PIECE(POSALT1,Y,119)  ;ERRECHNEN NETTO PREIS ;price 
	IF +$PIECE(POS1,Y,121)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,121))
	IF +$PIECE(POS1,Y,122)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,122))
	IF +$PIECE(POS1,Y,128)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,128))
	IF +$PIECE(POS1,Y,212)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,212))       ;TYBD;19.2.2005:GEM;27377
	IF +$PIECE(POS1,Y,214)'=0 SET NETTO=NETTO+(NETTO/100*$PIECE(POS1,Y,214))       ;TYBD;19.2.2005:GEM;27377   ; 02-Oct-2006 replace *-1
	SET NETTO=NETTO+$PIECE(POS1,Y,211)  ;ZUSCHLAG BETRAG  210=BEGRÜNDUNG ;surcharge Sum 
	SET $PIECE(POSALT1,Y,123)=$JUSTIFY(NETTO,0,2)      ; Nett Sales Price
	SET $PIECE(POSALT1,Y,116)=0                        ; Reached Additional Charge
	SET WERT=0
	IF +$PIECE(POSALT1,Y,47)'=0 SET WERT=$PIECE(POSALT1,Y,123)/($PIECE(POSALT1,Y,47)+$PIECE(POSALT1,Y,71))-1*100
	IF +WERT'=0 SET $PIECE(POSALT1,Y,116)=$JUSTIFY(WERT,0,2)  ;AUFSCHLAG ;overcharge 
	SET $PIECE(POSALT1,Y,90) =$$$YES
	SET $PIECE(POSALT1,Y,242)=POSNEU     ; split forward link
	SET $PIECE(POSALT1,Y,262)=MNGU       ; pre-split quantity  ;HISTORY URSPRÜNGLICHE MENGE 
	SET $PIECE(POSALT1,Y,323)=(MNGU-ML)  ; split quantity      ;GESPLITTETE MENGE;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	DO
	. NEW YFORM,YVOR,YOK
	. SET YOK=$$^WWWSPEI("INAUFP",AUF_","_POS,POSALT1,1)
	
	;-----------------------------------------------------INAUFPK
	IF $DATA(^INAUFPK(YM,AUF,POS)) DO
	. SET POSK1=$GET(^INAUFPK(YM,AUF,POS,1))
	. ;
	. ;-------------------------------------------------NEU POSITION--------INAUFPK
	. MERGE ^INAUFPK(YM,AUF,POSNEU)=^INAUFPK(YM,AUF,POS)
	. SET $PIECE(^INAUFPK(YM,AUF,POSNEU,1),Y,16)=$JUSTIFY($PIECE(POSK1,Y,16)*MR/MG,0,2)
	. SET $PIECE(^INAUFPK(YM,AUF,POSNEU,1),Y,12)=$JUSTIFY($PIECE(POSK1,Y,12)*MR/MG,0,2)
	. SET $PIECE(^INAUFPK(YM,AUF,POSNEU,1),Y,13)=$JUSTIFY($PIECE(POSK1,Y,13)*MR/MG,0,2)
	. DO ^WWWSSORT("INAUFPK",AUF_","_POSNEU)
	. ;
	. ;-------------------------------------------------ALT POSITION--------INAUFPK
	. DO ^WWWSKILL("INAUFPK",AUF_","_POS,1)
	. SET $PIECE(^INAUFPK(YM,AUF,POS,1),Y,16)=$JUSTIFY($PIECE(POSK1,Y,16)*ML/MG,0,2)
	. SET $PIECE(^INAUFPK(YM,AUF,POS,1),Y,12)=$JUSTIFY($PIECE(POSK1,Y,12)*ML/MG,0,2)
	. SET $PIECE(^INAUFPK(YM,AUF,POS,1),Y,13)=$JUSTIFY($PIECE(POSK1,Y,13)*ML/MG,0,2)
	. DO ^WWWSSORT("INAUFPK",AUF_","_POS)
	
	;--------------------------------------------------INAUFPSP
	MERGE ^INAUFPSP(YM,AUF,POSNEU)=^INAUFPSP(YM,AUF,POS)
	;
	;--------------------------------------------------INAUFPIMPACT  ;FIS;09.03.05;27445
	IF $PIECE($GET(^INVORG(YM,YM,1)),Y,215)=1 DO
	. NEW ZUS
	. SET ZUS=""
	. FOR  SET ZUS=$ORDER(^INAUFPIMPACT(YM,AUF,POS,ZUS)) QUIT:ZUS=""  DO
	. . SET ZUS(1)=$GET(^INAUFPIMPACT(YM,AUF,POS,ZUS,1))
	. . QUIT:+$PIECE(ZUS(1),Y,6)=0  ;KEIN BETRAG
	. . QUIT:$PIECE(ZUS(1),Y,7)'=""  ;BEREITS BERECHNET
	. . QUIT:$PIECE(ZUS(1),Y,4)'=""  ;KEINE FIXBETRÄGE KOPIEREN
	. . SET $PIECE(ZUS(1),Y,6)=""
	. . DO  ;neurechnen alte kosten
	. . . NEW YKEY,YFELD
	. . . SET YKEY=AUF_","_POS_","_ZUS
	. . . SET YFELD=ZUS(1)
	. . . DO ^INAUFPIMPACT
	. . ;
	. . DO  ;neurechnen neue kosten
	. . . ;SET ^INAUFPIMPACT(YM,AUF,POSNEU,ZUS,1)=ZUS(1)
	. . . NEW YKEY,YFELD
	. . . SET YKEY=AUF_","_POSNEU_","_ZUS
	. . . SET YFELD=ZUS(1)
	. . . DO ^INAUFPIMPACT
	
	IF WH=1 {
		SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,7) = ""        ; Source still open  ;WH NOCH OFFEN
		SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,6) = 0         ;KEINE MENGE ZUGEORDNET ;no quantity 
		SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,6)    = WHMNG     ;ZURÜCKSETZTEN ZUGEORDNETE MENGE ;quantity     ; 02-Oct-2006
	}
	
	QUIT
	
	; vvvvv OLD BLOCK OF CODE #1 MOVED TO END OF ROUTINE vvvvv
 
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,5)=MR
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,6)=ME
	;IF ME="" SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,6)=MR
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,47)=$PIECE(POS1,Y,47)*MR/MG
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,119)=$JUSTIFY(MR*$PIECE(POS1,Y,118),0,2)  ;MENGE * PREIS ;quantity * price
	;SET NETTO=$PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,119)  ;ERRECHNEN NETTO PREIS ;price 
	;IF +$PIECE(POS1,Y,121)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,121))
	;IF +$PIECE(POS1,Y,122)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,122))
	;IF +$PIECE(POS1,Y,128)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,128))
	;IF +$PIECE(POS1,Y,212)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,212))  ;TYBD;19.2.2005:GEM;27377
	;IF +$PIECE(POS1,Y,214)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,214))  ;TYBD;19.2.2005:GEM;27377
	;SET NETTO=NETTO+$PIECE(POS1,Y,211)  ;ZUSCHLAG BETRAG  210=BEGRÜNDUNG ;surcharge Sum
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,123)=$JUSTIFY(NETTO,0,2)
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,116)=0
	;SET WERT=0
	;IF +$PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,47)'=0 SET WERT=$PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,123)/($PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,47)+$PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,71))-1*100
	;IF +WERT'=0 SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,116)=$JUSTIFY(WERT,0,2)  ;AUFSCHLAG ;overcharge 
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,90)=0
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,242)=""
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,243)=POS
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,262)=MNGU  ;HISTORY URSPRÜNGLICHE MENGE ;quantity 
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,322)=""  ;URSPRÜNGLICHE MENGE;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,323)=0  ;GESPLITTETE MENGE;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	;SET $PIECE(^INAUFP(YM,AUF,POSNEU,1),Y,109)=""
	;DO ^WWWSSORT("INAUFP",AUF_","_POSNEU)
	;  -> FIS:NEU 22.02.2005;27384;BESSER WWWSPEI
	; ^^^^^ OLD BLOCK OF CODE #1 MOVED TO END OF ROUTINE ^^^^^
	
	
	
	; vvvvv OLD BLOCK OF CODE #2 MOVED TO END OF ROUTINE vvvvv
	;--------------------------------------------------ALT POSITION-------INAUFP
	;DO ^WWWSKILL("INAUFP",AUF_","_POS,1)  ;LÖSCHEN SORTKEY
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,5)=ML
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,6)=ME
	;IF ME="" SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,6)=ML
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,47)=$PIECE(POS1,Y,47)*ML/MG
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,119)=$JUSTIFY(ML*$PIECE(POS1,Y,118),0,2)  ;MENGE * PREIS ;quantity * price 
	;SET NETTO=$PIECE(^INAUFP(YM,AUF,POS,1),Y,119)  ;ERRECHNEN NETTO PREIS ;price 
	;IF +$PIECE(POS1,Y,121)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,121))
	;IF +$PIECE(POS1,Y,122)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,122))
	;IF +$PIECE(POS1,Y,128)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,128))
	;IF +$PIECE(POS1,Y,212)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,212))  ;TYBD;19.2.2005:GEM;27377
	;IF +$PIECE(POS1,Y,214)'=0 SET NETTO=NETTO-(NETTO/100*$PIECE(POS1,Y,214))  ;TYBD;19.2.2005:GEM;27377
	;SET NETTO=NETTO+$PIECE(POS1,Y,211)  ;ZUSCHLAG BETRAG  210=BEGRÜNDUNG ;surcharge Sum 
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,123)=$JUSTIFY(NETTO,0,2)
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,116)=0
	;SET WERT=0
	;IF +$PIECE(^INAUFP(YM,AUF,POS,1),Y,47)'=0 SET WERT=$PIECE(^INAUFP(YM,AUF,POS,1),Y,123)/($PIECE(^INAUFP(YM,AUF,POS,1),Y,47)+$PIECE(^INAUFP(YM,AUF,POS,1),Y,71))-1*100
	;IF +WERT'=0 SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,116)=$JUSTIFY(WERT,0,2)  ;AUFSCHLAG ;overcharge 
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,90)=1
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,242)=POSNEU
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,262)=MNGU  ;HISTORY URSPRÜNGLICHE MENGE ;quantity 
	;SET $PIECE(^INAUFP(YM,AUF,POS,1),Y,323)=(MNGU-ML)  ;GESPLITTETE MENGE;FIS;25.06.03;23781;BESTELLMENGE IN LIEFERSCHEIN
	;DO ^WWWSSORT("INAUFP",AUF_","_POS)  ;NEUAUFBAU SORTKEY
	;  -> FIS:NEU 22.02.2005;27384;BESSER WWWSPEI
	; ^^^^^ OLD BLOCK OF CODE #2 MOVED TO END OF ROUTINE ^^^^^
	
]]></Routine>
</Export>