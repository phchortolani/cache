<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCKXML7" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
#include COMSYS
#include INConst
 
	/*------------------------------------------------------------------------------
	; Description of Function :
	;		BERECHNUNG GESAMTBETRAG XML
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 03-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1
	; 03-Mar-2006	PO			SR14290: Include document type 17 - Tax Credit
	; 23-Jan-2006	GRF			SR14105: Doco; use $justify in place of long string of
	; 							spaces; disabled blocks
	; 23-Jan-2006	PO			SR14109: If invoice number ends with dot perform DCM Event even if YCOPY=1
	; 02-Dec-2005	Steve S		SR13873: Get correct delivery date
	; 13-Sep-2005	JW			SR13434: Centralised discount calculations
	; 18-Aug-2005	JW			SR12988: Calculate portion of total discount/surcharges
	; 10-Aug-2005	PO			SR12141: Included new handling of new HTML Print Form tags
	; 12-Jul-2005	PO			SR12923: pass in Document Type
	; DT	19.06.2002  
	;-----------------------------------------------------------------------------*/
INDRUCKXML7 ;INDRUCKXML7;DT;BERECHNUNG GESAMTBETRAG XML;19.06.2002  ; Compiled February 24, 2005 09:48:05
	NEW XTAB,POS,ERLOESE,KONTEN,A,WAGR,SORTI,STEUER,STEUERKZ,UAN,UAUS,MWSTANZ,ANZAHLG,ANZAHLGN,YZUSATZ,KEY,MWSTANZ,AUF1,AUSSEN,NETTOWERT,RABATTWERT,MENGE,RABATT,YZUSKONTO,YLAST,KONTCOGS,MWSTANZ,idLine,lstLines
	;
	SET YWHRS=$PIECE($GET(^WWWWAE(0,YWHR,1)),Y,2)
	QUIT:$PIECE(YBELEG1,Y,62)'=1  ;KEINE ENDSUMME  ;no 
	IF $PIECE(YAUFTRAG1,Y,2)=2  IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) QUIT:$PIECE(YAUFTRAG1,Y,105)=1   ;105=KEINE ENDSUMME DRUCKEN ;print 
	IF $PIECE(YAUFTRAG1,Y,2)'=2 IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=13    QUIT:$PIECE(YAUFTRAG1,Y,105)=1   ;105=KEINE ENDSUMME DRUCKEN ;print 
	
	SET YSPA=$justify("",92)
	
	SET A=""
	
	;NETTOWARENWERT
	SET NETTOWERT=0,RABATTWERT=0,RABATT=0
	SET XMWPO=""
	FOR  SET XMWPO=$ORDER(MWPO(XMWPO)) QUIT:XMWPO=""  SET NETTOWERT=NETTOWERT+$GET(MWPO(XMWPO))
	
	KILL ANZAHLG  ;BRUTTO ANZAHLUNG ARRAY
	KILL ANZAHLGN  ;NETTO ANZAHLUNG ARRAY
	SET ANZAHLG=0
	SET YEXTRA=$GET(YEXTRA)
	
	;GESAMTRABATT  ;FIS, 26.07.02
	DO
	. IF YBELEG'=1 IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG ;no expenses when no tab 
	. SET RABATT=$PIECE(YAUFTRAG1,Y,71)
	. IF +RABATT'=0 IF NETTOWERT'=0 DO
	. . SET RABATTWERT=RABATTWERT+(NETTOWERT/100)*RABATT  ;SPEICHERN RABATTSUMME ;table-mat Save 
	. . ; SET RABATTWERT=RABATTWERT+((NETTOWERT-YEXTRA)/100)*RABATT  ;RABATT NICHT FÜR EXTRAKOSTEN;FIS;26191;02.08.04
	. . 
	. . // SR12988: Consider rounding error from total to line
	. . ;set RABATTWERT=$$PercentDiscount^INDRUCK7(YAUFTRAG,$order(YAUFTRAG("")),RABATT)
	. . 
	. . DO XML^INDRUCK(,,,"GESAMTRABATT",$$^WWWZAHL((RABATTWERT*-1),12,2,YWHR,,YWHRF))
	. . ;
	. . NEW RABATT1
	. . SET RABATT1="-"_+RABATT_"&nbsp;"_"%"_"&nbsp;"_$$^WWWTEXT(31412)_"&nbsp;"_$$^WWWZAHL((NETTOWERT-YEXTRA),12,2,YWHR,,YWHRF)
	. . DO XML^INDRUCK(,,,"GESAMTRABATT-INFO",RABATT1)      ;BEC;25846;13.09.04
	. . DO XML^INDRUCK(,,,"RABATTWERT",$$^WWWZAHL((NETTOWERT-YEXTRA),12,2,YWHR,,YWHRF))          ;BEC;25846;13.09.04
	. . SET RABATTEXIST=1
	
	;ANZAHLUNG ;down payment 
	IF YBELEG'=1 IF YBELEG'=3 IF YBELEG'=13 IF YBELEG'=10 IF YBELEG'=12 DO   ;NICHT BEI BESTELLUNG ODER ANGEBOTEN ;Not next to sales order Or 
	. ;IF ANZAHLG=0 SET ANZAHLG=$$^INAUFANZAHL(YAUFTRAG,$PIECE(YAUFTRAG1,Y,96))   ;ERMITTELN ANZAHLUNG
	. SET ANZAHLG=$$^INAUFANZAHL(YAUFTRAG,$PIECE(YAUFTRAG1,Y,96),1)   ;ERMITTELN ANZAHLUNG + RÜCKBUCHUNG !! ;FIS;23.02.05;27033
	. IF +ANZAHLG'=0 DO
	. . DO XML^INDRUCK(,,,$$^WWWTEXT(32089),$$^WWWZAHL((ANZAHLG*-1),12,2,YWHR,,YWHRF))  ;ANZAHLUNG
	
	;ÜBERSCHRIFT ;superscription 
	;IF +GESAMT'=0!(YBELEG=2)!(YBELEG=7)!(YBELEG=17)!(YBELEG=12) DO   ;NUR WENN BETRAG VORHANDEN ;only when Sum on hand 
	;.SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,63)-17-10-17)  ;IN SPALTE
	;.SET A=YTAB_$EXTRACT($$^WWWTEXT(31413)_YSPA,1,17)        ;W "Netto-Warenwert"
	;.IF YBELEG=12 SET A=YTAB_$EXTRACT($$^WWWTEXT(32470)_YSPA,1,17)        ;W "Netto-BETRAG"
	;.SET A=A_$EXTRACT($$^WWWTEXT(31414)_YSPA,1,10)   ;W "MwSt%"
	;.SET A=A_$EXTRACT($$^WWWTEXT(31415)_YSPA,1,17)   ;W "MwSt-Betrag"
	;.IF YBELEG'=1 I YBELEG'=3 IF YBELEG'=10 I YBELEG'=10 SET A=A_$EXTRACT($$^WWWTEXT(31416)_YSPA,1,17)   ;W "Rechnungsbetrag"
	;.IF YBELEG=1 SET A=A_$EXTRACT($$^WWWTEXT(32173)_YSPA,1,17)    ;W "Angebotsbetrag"
	;.IF YBELEG=3!(YBELEG=13) SET A=A_$EXTRACT($$^WWWTEXT(32175)_YSPA,1,17)    ;W "Bestellwert"
	
	SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,1,1)),Y,1)	// JW SR11997: TODO: Hardcoded
	SET MWST=0,GESAMT=0,MGESAMT=0,NGESAMT=0,MWSTANZ=""
	
	;WENN ZZGL MWST  (NETTO=B TO B);FIS;09.07.04;26076
	IF +$GET(YINKLMWST)=0 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. ;IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0
	. IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. ;
	. // SR13434: Remove order discounts
	. set lstLines=""
	. set idLine=""
	. for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. . set lstLines = lstLines_$lb(idLine)
	. set MWPO(MWPO)=MWPO(MWPO)- $$OrderDiscountPortion^INAUFCalc(YAUFTRAG,lstLines)	//SR13434
	. ;
	. ;IF RABATT'=0 DO  ;GESAMTRABATT
	. ;. IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-RABATTWERT,RABATTWERT=0 QUIT  ;REST (GGF. RUNDUNGSDIFFERENZ) ;residue 
	. ;. SET RABATTWERT=RABATTWERT-((MWPO(MWPO)/100)*RABATT)
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-((MWPO(MWPO)/100)*RABATT)		// round ??
	. ;. QUIT
	. ;
	. ; SR12988: Overall dollar discount/surcharge (not percentage) - apportioned
	. ;set idLine="" for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount^INDRUCK7(YAUFTRAG,idLine)
	. ;
	. ;SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount^INDRUCK7(YAUFTRAG,$order(YAUFTRAG("")))
	. ;
	. IF +$GET(ANZAHLG)'=0 DO  ;ANZAHLUNG ;down payment 
	. . IF $DATA(ANZAHLGN) IF $ORDER(ANZAHLGN(""))'="" DO  QUIT  ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . . SET MWPO(MWPO)=MWPO(MWPO)-$G(ANZAHLGN(MWPO))
	. . . SET ANZAHLG=ANZAHLG-$G(ANZAHLGN(MWPO))
	. . . IF $ORDER(MWPO(MWPO))="" IF ANZAHLG>0 SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no
	. . . QUIT
	. . IF ANZAHLG'>MWPO(MWPO) SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG,ANZAHLG=0 QUIT  ;ANZAHLUNG WENIGER/GLEICH ALS RECHNUNG (NORMALFALL) ;down payment when tab 
	. . SET ANZAHLG=ANZAHLG-MWPO(MWPO)  ;RESTANZAHLUNG
	. . SET MWPO(MWPO)=0
	. . IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no 
	. . QUIT
	. SET A=$$^WWWZAHL(MWPO(MWPO),12,2,YWHR,,YWHRF)
	. ;DO XML^INDRUCK(,,,"NETTO-WARENWERT"_MWSTANZ,A)
	. DO XML^INDRUCK(,,,"NETTO-WARENWERT",A)      ;BEC;26360;09.09.04
	. DO XML^INDRUCK(,,,"NETTO-WARENWERT"_MWPO,A) ;BEC;26360;09.09.04
	. SET NGESAMT=NGESAMT+MWPO(MWPO)  ;NETTO GESAMT ;total 
	. ;SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO  ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET A=$$^WWWZAHL(MWSTP,5,2)
	. ;DO XML^INDRUCK(,,,"MWST%"_MWSTANZ,A)
	. DO XML^INDRUCK(,,,"MWST%",A)        ;BEC;26360;09.09.04
	. DO XML^INDRUCK(,,,"MWST%"_MWPO,A)   ;BEC;26360;09.09.04
	. SET MWST=$JUSTIFY(MWPO(MWPO)/100*MWSTP,0,2)
	. SET A=$$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)   ;W "MwSt-Betrag"
	. ;DO XML^INDRUCK(,,,"MWST-BETRAG"_MWSTANZ,A)
	. DO XML^INDRUCK(,,,"MWST-BETRAG",A)         ;BEC;26360;09.09.04
	. DO XML^INDRUCK(,,,"MWST-BETRAG"_MWPO,A)    ;BEC;26360;09.09.04
	. SET GESAMT=GESAMT+MWPO(MWPO)   ;GESAMT ;total  ;total whole 
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. SET A=$$^WWWZAHL(MWPO(MWPO)+MWST,12,2,YWHR,,YWHRF)   ;W "Rechnungsbetrag"
	. ;DO XML^INDRUCK(,,,"GESAMTBETRAG"_MWSTANZ,A)
	. DO XML^INDRUCK(,,,"GESAMTBETRAG",A)       ;BEC;26360;09.09.04
	. DO XML^INDRUCK(,,,"GESAMTBETRAG"_MWPO,A)  ;BEC;26360;09.09.04
	. IF $GET(YSAMMEL)'="" DO    ;AUFSUMMIEREN DER SUMMEN; BEC;02.02.04;25202
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+MWPO(MWPO)             ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+(MWPO(MWPO)+MWST)      ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	. . QUIT
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	
	;WENN INKL MWST  (BRUTTO=B TO C);FIS;09.07.04;26076
	IF +$GET(YINKLMWST)=1 IF YBELEG'=12 SET MWPO="" FOR  SET MWPO=$ORDER(MWPO(MWPO)) QUIT:MWPO=""  DO
	. ;IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0
	. IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF +MWPO(MWPO)=0 QUIT    ;KEINE AUSGABE WENN KEINE RECHNUNG UND BETRAG =0 ;no expenses when no tab And Sum 
	. ;
	. // SR13434: Remove order discounts
	. set lstLines=""
	. set idLine="" for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. . set lstLines = lstLines_$lb(idLine)
	. set MWPO(MWPO)=MWPO(MWPO)- $$OrderDiscountPortion^INAUFCalc(YAUFTRAG,lstLines)
	. ;
	. ;IF RABATT'=0 DO
	. ;. IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-RABATTWERT,RABATTWERT=0 QUIT  ;REST (GGF. RUNDUNGSDIFFERENZ) ;residue 
	. ;. SET RABATTWERT=RABATTWERT-((MWPO(MWPO)/100)*RABATT)
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-((MWPO(MWPO)/100)*RABATT)
	. ;. QUIT
	. ;
	. ; SR12988: Overall dollar discount/surcharge (not percentage) - apportioned
	. ;set idLine="" for  set idLine=$order(MWPO(MWPO,idLine)) quit:idLine=""  do
	. ;. SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount^INDRUCK7(YAUFTRAG,idLine)
	. ;
	. ;SET MWPO(MWPO)=MWPO(MWPO)-$$DollarDiscount^INDRUCK7(YAUFTRAG,$order(YAUFTRAG("")))
	. ;
	. IF +$GET(ANZAHLG)'=0 DO  ;ANZAHLUNG ;down payment 
	. . IF $DATA(ANZAHLGN) IF $ORDER(ANZAHLGN(""))'="" DO  QUIT  ;FIS;JE STEUERSATZ ABZIEHEN;23.02.05;27033
	. . . SET MWPO(MWPO)=MWPO(MWPO)-$G(ANZAHLGN(MWPO))
	. . . SET ANZAHLG=ANZAHLG-$G(ANZAHLGN(MWPO))
	. . . IF $ORDER(MWPO(MWPO))="" IF ANZAHLG>0 SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no
	. . . QUIT
	. . IF ANZAHLG'>MWPO(MWPO) SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG,ANZAHLG=0 QUIT  ;ANZAHLUNG MEHR ALS RECHNUNG ;down payment more when tab 
	. . SET ANZAHLG=ANZAHLG-MWPO(MWPO)
	. . IF $ORDER(MWPO(MWPO))="" SET MWPO(MWPO)=MWPO(MWPO)-ANZAHLG QUIT  ;KEINE FOLGENDE UST-POS.=GUTSCHRIFT ;no 
	. . SET MWPO(MWPO)=0
	. . QUIT
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. ;SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO  ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET MWST=$JUSTIFY((MWPO(MWPO))/(100+MWSTP)*MWSTP,0,2)
	. SET A=$$^WWWZAHL(MWPO(MWPO)-MWST,12,2,YWHR,,YWHRF)  ;W "Netto-Warenwert"
	. DO XML^INDRUCK(,,,"NETTO-WARENWERT",A)
	. SET NGESAMT=NGESAMT+MWPO(MWPO)  ;NETTO GESAMT ;total 
	. SET A=$$^WWWZAHL(MWSTP,5,2)   ;W "MwSt%"
	. DO XML^INDRUCK(,,,"MWST%",A)
	. SET A=$$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)   ;W "MwSt-Betrag"
	. DO XML^INDRUCK(,,,"MWST-BETRAG",A)
	. SET GESAMT=GESAMT+MWPO(MWPO)-MWST   ;GESAMT ;total  ;total whole 
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. SET A=$$^WWWZAHL(MWPO(MWPO),12,2,YWHR,,YWHRF)   ;W "Rechnungsbetrag"
	. DO XML^INDRUCK(,,,"GESAMTBETRAG",A)
	. IF $GET(YSAMMEL)'="" DO                 ;BEC;25202;23.02.04; SUMME SAMMELDRUCK
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+(MWPO(MWPO)-MWST)      ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+MWPO(MWPO)             ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	
	IF YBELEG=12 DO  ;TEILZAHLUNGSRECHNUNG
	. SET MWST=0,MGESAMT=0,NGESAMT=0,MWSTANZ=0
	. SET GESAMTPZ=""
	. IF +$PIECE(YFELDPZ,Y,2)'=0 SET GESAMTPZ=$PIECE(YFELDPZ,Y,2)        ;ZALHLUNG-BETRAG     
	. IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET GESAMTPZ=SUMME*$PIECE(YFELDPZ,Y,3)/100
	. SET MWPO=$ORDER(MWPO(""))  ;UST;FIS;22349;11.11.03
	. SET MWSTANZ=MWSTANZ+1  ;ANZAHL DER MWST ZEILEN ;Number the Tax 
	. SET A=$$^WWWZAHL(GESAMTPZ,12,2,YWHR,,YWHRF)   ;WERT "Netto-BETRAG"
	. DO XML^INDRUCK(,,,"NETTO-WARENWERT",A)
	. SET MWSTP=0  ;TYBD;12,12,2003
	. ;IF MWPO'="" SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF MWPO'="" IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+$PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)
	. IF MWPO'="" IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) SET MWSTP=+MWPO  ;FIS;USA KENNZEICHEN;05.05.04 ;characteristic 
	. SET A=$$^WWWZAHL(MWSTP,5,2)   ;W "MwSt%"
	. DO XML^INDRUCK(,,,"MWST%",A)
	. SET MWST=$JUSTIFY(GESAMTPZ/100*MWSTP,0,2)
	. SET A=$$^WWWZAHL(MWST,10,2,YWHR,,YWHRF)   ;W "MwSt-Betrag"
	. DO XML^INDRUCK(,,,"MWST-BETRAG",A)
	. SET MGESAMT=MGESAMT+MWST  ;MWST ;Tax 
	. SET A=$$^WWWZAHL(GESAMTPZ+MWST,12,2,YWHR,,YWHRF)       ;W "Rechnungsbetrag"
	. DO XML^INDRUCK(,,,"GESAMTBETRAG",A)
	. ;IF $GET(YSAMMEL)'="" SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=GESAMTPZ_Y_MWST_Y_(GESAMTPZ+MWST)  ;SPEICHERN RECHNUNGSENDBETRAG FÜR SAMMELDECKBLATT;FIS;25.02.04;25202
	. IF $GET(YSAMMEL)'="" DO                 ;BEC;25202;23.02.04; SUMME SAMMELDRUCK
	. . NEW YTEMP
	. . SET YTEMP=$GET(^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF))
	. . SET $PIECE(YTEMP,Y,1)=$PIECE(YTEMP,Y,1)+GESAMTPZ               ;NETTO
	. . SET $PIECE(YTEMP,Y,2)=$PIECE(YTEMP,Y,2)+MWST                   ;UST-ST
	. . SET $PIECE(YTEMP,Y,3)=$PIECE(YTEMP,Y,3)+(GESAMTPZ+MWST)        ;GESAMT ;total  ;total whole 
	. . SET ^WWWSOR(YUSER,"SAMMEL",YAUFTRAG,YREF)=YTEMP  
	
	DO XML^INDRUCK(,,,"RECHNUNGGESAMT",$$^WWWZAHL((NGESAMT+MGESAMT),12,2,YWHR,,YWHRF))  ;GESAMT RECHNUNGSBETRAG (ALL MWST-SÄTZE) ;FIS;09.07.04;26076
	DO XML^INDRUCK(,,,"NETTOGESAMT",$$^WWWZAHL(NGESAMT,12,2,YWHR,,YWHRF))  ;GESAMT NEZTTOBETRAG (ALL MWST-SÄTZE);FIS;09.07.04;26076
	DO XML^INDRUCK(,,,"MWSTGESAMT",$$^WWWZAHL(MGESAMT,12,2,YWHR,,YWHRF))  ;GESAMT MWSTBETRAG (ALL MWST-SÄTZE);FIS;09.07.04;26076
	
	DO XML^INDRUCK(,,,"TOTALTAXRATE",$$GetOrderTaxRate^INAUFHTML(YAUFTRAG)) ;SR11963
	
	DO XML^INDRUCK(,,,"DELIVERYDATE",$$GetDueDate^INAUFHTML(YAUFTRAG,$$$YES)) ;SR13873
	DO XML^INDRUCK(,,,"ORDERTOTAL",$$GetOrderTotal^INAUFHTMLPO(YAUFTRAG,$$$YES)) ;SR12086
	do XML^INDRUCK(,,,"ORDERTOTALEXTAX",$$GetOrderTotalExTax^INAUFHTMLPO(YAUFTRAG,$$$YES)) ;SR12141
	do XML^INDRUCK(,,,"ORDERTAXAMOUNT",$$GetOrderTaxAmount^INAUFHTMLPO(YAUFTRAG,$$$YES)) ;SR12141
	
	;DO XML^INDRUCK(,,,"ORDERTOTALEXTAX",$$^WWWZAHL(NGESAMT,12,2,YWHR,,YWHRF)) ;SR12086
	;do XML^INDRUCK(,,,"ORDERTOTAL",$$^WWWZAHL(NGESAMT+MWST,12,2,YWHR,,YWHRF)) ;SR12141
	;do XML^INDRUCK(,,,"ORDERTAXAMOUNT",$$^WWWZAHL(MWST,12,2,YWHR,,YWHRF)) ;SR12141
	
	// SR12707
	new fltOrderPrice,fltSurcharges,fltDiscounts,fltTotalTax,orderCurrency
	
	set fltOrderPrice = $$GetOrderPrice^INAUFHTML(YAUFTRAG,,.fltSurcharges,.fltDiscounts,.fltTotalTax,YBELEG) ; 12-Jul-2005	PO	SR12923: pass in Document Type
	set orderCurrency = $$$INAUFOrderCurrency(YAUFTRAG1)
	
	DO XML^INDRUCK(,,,"INVOICENUMBER",$$$INAUFInvoiceNumber(YAUFTRAG1)) ;SR14293
	DO XML^INDRUCK(,,,"TOTALORDERPRICE",$$FormatCurrency^COMTable(fltOrderPrice,,orderCurrency))
	DO XML^INDRUCK(,,,"ORDERSURCHARGE",$$FormatCurrency^COMTable(fltSurcharges,,orderCurrency))
	DO XML^INDRUCK(,,,"ORDERDISCOUNT",$$FormatCurrency^COMTable(fltDiscounts,,orderCurrency))
	DO XML^INDRUCK(,,,"TOTALTAX",$$FormatCurrency^COMTable(fltTotalTax,,orderCurrency))
		
	;DO XML^INDRUCK(,,,"TOTALTAX",$$GetTotalTax^INAUFHTML(YAUFTRAG,1)) ;SR11963
	;DO XML^INDRUCK(,,,"TOTALORDERPRICE",$$GetOrderPrice^INAUFHTML(YAUFTRAG,1)) ;SR11963
	;DO XML^INDRUCK(,,,"ORDERSURCHARGE",$$GetOrderSurcharges^INAUFHTML(YAUFTRAG,1)) ;SR11963
	;DO XML^INDRUCK(,,,"ORDERDISCOUNT",$$GetOrderDiscounts^INAUFHTML(YAUFTRAG,1)) ;SR11963
	
	IF YBELEG'=12 SET NGESAMT=GESAMT  ;NETTO
	IF YBELEG=12 SET NGESAMT=GESAMTPZ,GESAMT=NGESAMT  ;NETTO
	SET GESAMT=GESAMT+$GET(MGESAMT)  ;NETTO + MWST ;Tax 
	
	;GESAMTRABATT            ;AUSSCHALTEN ;eliminate 
	;IF YBELEG'=3!(YBELEG=2)!(YBELEG=7)!(YBELEG=17) I YBELEG'=10 I YBELEG'=12 DO   ;NICHT BEI BESTELLUNG ;Not next to sales order 
	;.SET RABATT=$P(YAUFTRAG1,Y,71)
	;.IF +RABATT'=0 DO
	;..SET YTAB=$EXTRACT(YSPA,1,+$PIECE(YBELEG1,Y,49))  ;IN SPALTE
	;..SET A=$EXTRACT(YTAB_RABATT_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(GESAMT,0,2,YWHR,,YWHRF)_YSPA,1,+$PIECE(YBELEG1,Y,63))  ;RABATT
	;..SET RABATT=$JUSTIFY(GESAMT/100*RABATT,0,2)  ;GESAMTRABATT
	;..SET A=A_$$^WWWZAHL(RABATT,12,2,YWHR,,YWHRF)
	;..;DO SPE^INDRUCK
	;..SET GESAMT=GESAMT-$JUSTIFY(RABATT,0,2)  
	
	IF $GET(MWSTANZ)>1!(+$PIECE(YAUFTRAG1,Y,71)'=0) IF +$GET(GESAMT)'=0 IF YBELEG=2!(YBELEG=1)!(YBELEG=7)!(YBELEG=17) DO  ;NUR WENN MEHRERE MWST ZEILEN UND BETRAG > 0 UND BEI RECHNUNGEN/GUTSCHRIFTEN ;only when divers Tax And Sum And next to 
	. SET A=$$^WWWZAHL(GESAMT,12,2,YWHR,,YWHRF)   ;GESAMTBETRAG
	. DO XML^INDRUCK(,,,"TOTAL",A)
	
	;Frachtbedingung kunden ;Freight Condition 
	IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=12  IF YBELEG'=13 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ODER TEILZAHUNGEN ;Not next to sales order Or Or 
	. IF $PIECE(YAUFTRAG1,Y,26)'="" DO
	. . NEW KOND,YI,YFRACHT
	. . SET YA(2)=$$^WWWTEXT(32183)  ;FRACHTBEDINGUNGEN
	. . FOR YI=1:1 SET YFRACHT=$piece($piece(YAUFTRAG1,Y,26),";",YI) QUIT:YFRACHT=""  DO
	. . . SET KOND=$GET(^INPARA(YM,"FRACHT",SPRACHE,YFRACHT,1))
	. . . SET A=KOND
	. . . ;DO XML^INDRUCK(,,,YA(2),A)
	. . . DO XML^INDRUCK(,,,"FRACHTKONDITION",A)
	
	;ZAHLUNGSBEDINGUNGEN  kunden ;payment terms 
	IF YBELEG'=3 IF YBELEG'=13 IF YBELEG'=10 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. IF $PIECE(YAUFTRAG1,Y,56)'="" DO
	. . NEW KOND
	. . SET YA(2)=$$^WWWTEXT(32094,,1)  ;ZAHLUNGSBEDINGUNG
	. . SET KOND=$GET(^INKOND(YM,$PIECE(YAUFTRAG1,Y,56),1))
	. . SET A=$PIECE(KOND,Y,1)
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,2)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,2)>$PIECE(KOND,Y,4) SET A=A_" "_$$^WWWTEXT(32174,,1)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,2))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,4)'=0 IF +$PIECE(KOND,Y,7)=0 IF $PIECE(KOND,Y,4)>$PIECE(KOND,Y,2) SET A=A_" "_$$^WWWTEXT(32174,,1)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,4))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . IF +GESAMT'=0 IF YBELEG=7 IF +$PIECE(KOND,Y,7)'=0 DO  ;PROX 7. ZAHLBAR 7.DES FOLGEMONATS;TYBD;8,8,2003
	. . . NEW YDATE1
	. . . SET YDATE1=$$DMY^WWWDATE1($PIECE(KOND,Y,7)_"."_$$^WWWMONTH(30+$$DMY^WWWDATE1("15."_$$^WWWMONTH(YDATE)_"."_$$^WWWYEAR(YDATE)))_"."_$$^WWWYEAR(YDATE)) ; SR17146
	. . . SET A=A_" "_$$^WWWTEXT(32174,,1)_" "_$$^WWWDATE(YDATE+$PIECE(KOND,Y,7))  ;SPÄTESTENS BIS + DATUM + ;until Date 
	. . ;
	. . SET $PIECE(YAUFTRAG1,Y,74)=$PIECE(KOND,Y,3)  ;SKONTO
	. . SET $PIECE(YAUFTRAG1,Y,75)=$PIECE(KOND,Y,2)  ;TAGE
	. . SET $PIECE(YAUFTRAG1,Y,76)=$PIECE(KOND,Y,4)   ;NETTO
	. . ;DO XML^INDRUCK(,,,YA(2),A)
	. . DO XML^INDRUCK(,,,"ZAHLUNGSKONDITION",A)
	. ;
	. ;LASTSCHRIFT VERMERK ;direct debit observation 
	. IF YBELEG'=7 QUIT  ;NUR RECHNUNG IF YBELEG'=17  ;only tab 
	. IF YKUNDE'="" IF $PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,102)=3 IF +GESAMT>0 DO  ;LASTSCHRIFT ;direct debit 
	. . SET A=$PIECE(YBELEG1,Y,196)  ;TEXT LASTSCRIFTVERMERK
	. . IF A="" QUIT
	. . DO XML^INDRUCK(,,,"LASTSCHRIFTVERMERK",A)
	
	;STEUERNUMMER DES KUNDEN
	IF $PIECE(YBELEG1,Y,203)=1 DO  ;NUR RECHNUNG IF YBELEG'=17 ;only tab 
	. NEW STNR
	. SET STNR=""
	. ;IF $GET(YKUNDE)'="" SET STNR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,233)
	. IF $GET(YKUNDE)'="" SET STNR=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,50)   ;FIS;20.07.04;25708
	. QUIT:STNR=""
	. SET A=STNR  ;steuernummer des kunden
	. ;DO XML^INDRUCK(,,,"KUNDENSTEUERNUMMER",A)
	. DO XML^INDRUCK(,,,"UST-IDNUMMER",A)
	
	;ZAHLUNGSBEDINGUNGEN bestellung ;payment terms 
	IF YBELEG=3!(YBELEG=13) DO   ; BEI BESTELLUNG ;next to sales order 
	. NEW YPOS
	. SET YPOS=$ORDER(YAUFTRAG(""))
	. IF YPOS="" SET YPOS=" "
	. IF '$DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;KEINE SPEZIALKONDITION NUR DIE KONDITION DES LIEFERANTEN ;no only who 
	. . IF $PIECE(YADRES,Y,56)'="" DO
	. . . NEW KOND
	. . . SET YA(2)=$$^WWWTEXT(32094)_" "  ;ZAHLUNGSBEDINGUNG
	. . . SET KOND=$GET(^INKOND(YM,$PIECE(YADRES,Y,56),1))
	. . . QUIT:$PIECE(KOND,Y,1)=""
	. . . SET A=$PIECE(KOND,Y,1)
	. . . ;DO XML^INDRUCK(,,,YA(2),A)
	. . . DO XML^INDRUCK(,,,"ZAHLUNGSKONDITION",A)
	. . . QUIT
	. . QUIT
	. IF $DATA(^INAUFPK(YM,YAUFTRAG,YPOS,1)) DO  ;SPEZIALKONDITION DES AUFTRAGES
	. . NEW KOND1,YZ
	. . SET KOND1=$GET(^INAUFPK(YM,YAUFTRAG,YPOS,1))
	. . SET A=$$^WWWTEXT(32094)  ;ZAHLUNGSBEDINGUNG
	. . IF +$PIECE(KOND1,Y,7)'=0 DO   ;SKONTO
	. . . IF +$PIECE(KOND1,Y,9)'="" DO
	. . . . SET A=" "_$$^WWWTEXT(32091)_" "_$PIECE(KOND1,Y,9)_" "_$$^WWWTEXT(32092)   ;IN XXX TAGEN ;within 
	. . . . QUIT
	. . . SET A=A_" "_$PIECE(KOND1,Y,7)_$$^WWWTEXT(32090)   ;% SKONTO
	. . . QUIT
	. . IF +$PIECE(KOND1,Y,10)'=0 DO   ;NETTO
	. . . SET A=A_" "_$PIECE(KOND1,Y,10)_" "_$$^WWWTEXT(32093)   ;Tage Netto ;days Net 
	. . . QUIT
	. . IF A=$$^WWWTEXT(32094) QUIT   ;KEINE ZAHLUNGSBEDINGUNG ;no 
	. . ;DO XML^INDRUCK(,,,YA(2),A)
	. . DO XML^INDRUCK(,,,"ZAHLUNGSKONDITION",A)
	
	;STEUER GGF NEU SETZEN  -> ERFOLGT BEREITS IN INDRUCK ;tax recent typeset yet within 
	;IF $GET(YKUNDE)'="" DO
	. IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)  ;STEUER ;tax 
	
	;IF $GET(YLIEFER)'="" DO
	. IF $PIECE(YADRES,Y,54)="" SET $PIECE(YADRES,Y,54)=$PIECE($GET(^INLIEF(YM,YLIEFER,1)),Y,54)  ;STEUER ;tax
	
	;umsatzsteuer id nummer auf kundenbeleg und lieferantenbestellung (YADRES) ;upon and 
	DO 
	. IF $PIECE(YADRES,Y,54)=2 DO  ;EG Ausland ;foreign country 
	. . NEW IDNR
	. . SET IDNR=$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,20)
	. . QUIT:IDNR=""                 ;KEINE ID ;no ID 
	. . SET YA(2)=$$^WWWTEXT(32158)  ;Steuer id nummer ;tax 
	. . SET A=IDNR
	. . ;DO XML^INDRUCK(,,,YA(2),A)
	. . DO XML^INDRUCK(,,,"STEUER-ID",A)
	
	;STEUERÄNDERUNGSGRUND DYN. VERGEBEN;FIS;26276;18.10.04
	IF YBELEG'=3 IF YBELEG'=13 IF YBELEG'=10 IF $PIECE(YADRES,Y,54)'="" DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. DO  ;IF $PIECE(YBELEG1,Y,198)=1 DO  ;IF +$PIECE($GET(^INVORG(YM,YM,1)),Y,196)=1 DO
	. . NEW STEUERGRUND,TEXT1,YA
	. . SET A=YTAB
	. . SET STEUERGRUND=$PIECE($GET(^INSTEUERGRUND(YM,$PIECE(YADRES,Y,54),YBELEG,SPRACHE,1)),Y,1)
	. . QUIT:STEUERGRUND=""
	. . DO XML^INDRUCK(,,,"STEUERAENDERUNGSGRUND",STEUERGRUND)
	
	;RABATTZUSATZTEXT;FIS;26276;18.10.04
	IF YBELEG'=3 IF YBELEG'=13 IF YBELEG'=10 IF $GET(RABATTEXIST)=1 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. IF $PIECE(YBELEG1,Y,206)'="" DO
	. . NEW TEXT,TEXT1,YA
	. . SET A=YTAB
	. . SET TEXT=$PIECE(YBELEG1,Y,206)
	. . DO XML^INDRUCK(,,,"RABATTZUSATZTEXT",TEXT)
	
	QUIT:$get(YPROFORMA)=1     ;NUR PROFORMARECHNUNG ;only proforma invoice 
	;QUIT:+$GET(YCOPY)=1   ;NUR WIEDERHOLUNGSDRUCK ;only ; SR14109
	if '($$$OrdersInvoiceEndsWithDot(YAUFTRAG1) && ((YBELEG=7) || (YBELEG=17))) QUIT:+$GET(YCOPY)=1   ;NUR WIEDERHOLUNGSDRUCK ;only ; SR14109 ; SR14290
	QUIT:$GET(YTEST)'=""  ;NUR TEST ;only Test 
	IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 QUIT   ;KEINE RECHUNG KEINE GUTSCHRIFT ;no no 
	
	;SET AUSSEN=1   ;FAN 26.10.2001  NICHT VON AUSSEN EINSPRUNG   &  NACH RECHNUNG DRUCHEN ;table-mat buff Not within tab 
	SET AUSSEN=0   ;FIS:21.07.03  ;KEINE UNTERSCHIED ZWISCHEN DRUCK UND XML ! ;no difference inter- printing And XML 
	
	DO BUCHEN^INDRUCK7     ; includes posting to GL
	QUIT
	
]]></Routine>
</Export>