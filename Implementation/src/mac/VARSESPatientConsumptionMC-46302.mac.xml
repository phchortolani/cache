<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="VARSESPatientConsumptionMC" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
VARSESPatientConsumptionMC
	#include COMConst
	#include INConst
	#include MEDConst
	#include WWWConst
	#include FIN
 	#include COMSYS
	#include COMGridEdit31
	#include VARConst
	#include VARSESTreatmentMC
    #include VARSESFarmaciaAltoCusto 
 
OnBlurPatient(pidPatient="")
    ;-------------------------------------------------------------------------------
    ; 
    ;
    ; Params:	
    ;
    ; Returns:	
    ;
    ; History:
    ; 30-Aug-2008	Heber		SRXXX: Created
    ;-------------------------------------------------------------------------------
	new strTxt
	
	set $piece(^VARTempPacienteMC(YBED),Y,1) = $$$INIssueCustomerName(YFELD)

	if ($Get(^IDTempPatient(YBED)) '= ""){
		set pPatientID = ^IDTempPatient(YBED)
	}
	else{
		set pPatientID = $$$INIssueCustomerName(YFELD)
	}
	
	
	set pPatientID = $$$INIssueCustomerName(YFELD)
	if (pidPatient = "") && ($LENGTH(pPatientID) > 0) {
		set objPatient  = $get(^MEDPatient(0,$$$INIssueCustomerName(YFELD),1))
		if (objPatient = "" ) {
			quit 0
		}
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 18, $$$MEDPatientName(objPatient), "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 60, $$$MEDPatientMothersName(objPatient), "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 59, $$$MEDPatientExternalCode(objPatient), "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 62, $$$MEDPatientPID(objPatient), "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 63, $$$MEDPatientTel(objPatient), "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 17, $$$MEDPatientDOB(objPatient), "D")
		if ($Get(^IDTempPatient(YBED))= ""){
			set ^IDTempPatient(YBED) = pPatientID	
		}
		
	}
	else {
		; clean the list of prescriptions
		kill ^COMTempList(YM,YUSER,"VARSESTreatmentActTrtForPat")	
		quit:(pidPatient = "")
		
		; changed to prevent window repetition
		set strFormData = $$$GetFormData(YFORM,"D")
		w strFormData
		quit:($$$INIssueCustomerName(strFormData) = pidPatient)

		; if entered user is on the list of valid ones, go on
		if $data(^COMTempList(YM,YUSER,"VARSESTreatmentMC",pidPatient,1)) > 0 {
			set strTxt = $$GetLastConsumptionsTxt^VARSESPatientConsumptionMCLog(pidPatient,$$$OK,$$$NO)
			if (strTxt '= "") {
				$$$StartScript()
				$$$Alert(strTxt)
				$$$EndScript()
			}
		} 
	}
	quit
	
PrintJSAlertConsumptions()
	;AEPOfferLineItem.MAC(911): retval = EventValue('#(YUCI)#','#(YUSER)#','#(YFORM)#','FIX','itemNumberUpdateValues^AEPOfferLineItem',itemNumber,6,'');
	
	;set formURL = "www.cls?EP=WWWMANU1&YEXEC=D|Start^VARSESPatientConsumptionUI()&YUCI="_YUCI_"&YUSER="_YUSER_"&YBED="_YBED_"&YM="_YM_"&YTRAKT="_YTRAKT
 	
 	set formURL = "www.cls?EP=WWWFORM&YUCI="_YUCI_"&YFORM=VARSESPatientConsumption&YUSER="_YUSER_"&YBED="_YBED_"&YM="_YM_"&YTRAKT="_YTRAKT
	write !,"<script language=""javascript"">"
	&js<
		function alertconsumptions(idPatient) {
 
 			//debugger;
 			if (idPatient == null) {
	 			idPatient = document.WWW2.YVARSESPatientConsumptionMCD23.value
 			}
 			
			//window.showModalDialog("#(formURL)#"+"&YPARA="+idPatient,"","resizable=yes;dialogWidth=800px;dialogHeight=600px");
			
		}
		
		function searchPatientFromCNS() {
			CallBack('searchPatient^VARSESPatientConsumptionUI',document.WWW2.YVARSESPatientConsumptionMCD59.value);
		}
	>
	write !,"</script>"
	quit
 
UpdateAlertConsumptions(pidPatient)
    ;-------------------------------------------------------------------------------
    ; 
    ;
    ; Params:	
    ;
    ; Returns:	
    ;
    ; History:
    ; 15-Dec-2008	Heber		SRXXX: Created
    ;-------------------------------------------------------------------------------	
	new command,strTxt
	
	set strTxt = ""
 	
	if (pidPatient '= "") set strTxt = $$GetLastConsumptionsTxt^VARSESPatientConsumptionMCLog(pidPatient,$$$NO,$$$OK)
 
	set strTxt = $$DecodeError^COMUtilError(strTxt,1)
	if strTxt = "" set strTxt = "Não há dispensações registradas."
	set strTxt = ##class(%CSP.Page).QuoteJS(strTxt)
		
	&js<
		alert(#(strTxt)#);
	>
	
	quit
 
checkNascimento(pintPosPatientId)
	set pidNascimento=""
	set pidNascimento=$$$MEDPatientDOB($GET(^MEDPatient(YM,$PIECE(YFELD,Y,pintPosPatientId),1)))
	set pidNascimento=$ZD(pidNascimento,4)
	quit pidNascimento
 
CanViewReport()
 	//Gustavo, 11/10/2007
 	//Desabilita o botão de relatório caso a solicitação não tenha sido processada.
 	
 	if (YKEY) {
		if $$$INIssueStatus(YFELD) '= 9 {
			set YQ = 1_$$^WWWTEXT(334014)
		}  	
		else { 
			set YQ = $$$YQEnable
		} 	
 	} 
	quit
 
checkPaciente(pintPosPatientId)
	set dado=$piece(YFELD,Y,pintPosPatientId)
	IF dado="" quit ""
	if ($get(^MEDPatient(YM,dado,1))'="") {
		quit dado
		}
	quit ""
	
checkCodigoPaciente(pintPosPatientId,pintPosName)
	if (($piece(YFELD,Y,pintPosName)'= "") && ($PIECE(YFELD,Y,pintPosPatientId)="")) {		
		set idPacient = $piece(YFELD,Y,15)
		if idPacient '= "" {
			&js<
				alertconsumptions('#(idPacient)#');
			>
		}
		quit 1
	}
	quit 0
 
result(pintPosPacientId)
	quit $PIECE($get(^MEDPatient(YM,$PIECE(YFELD,Y,pintPosPacientId),1)),Y,1)
 
checkDoctorId(pintPosDoctorId,pintPosDocName)
	if (($piece(YFELD,Y,pintPosDocName)'= "") && ($PIECE(YFELD,Y,pintPosDoctorId)="")) quit 1
	quit 0
 
searchMedico(pintPosMedico)
	set strFormData = $$$GetFormData(YFORM,"D")
	set dado = $piece(strFormData,Y,pintPosMedico)
	quit:$get(^CacheTempVARSESCONSUMOPACIENTEMEDICO(YUSER))=dado $$$OK
	set ^CacheTempVARSESCONSUMOPACIENTEMEDICO(YUSER) = dado
	kill ^COMTempList(YM,YUSER,"VARSESCONSUMOPACIENTEMEDICO")
 	set dadoMAX = $$^WWWUMLAU(dado,1)
	set medico = ""
	set idxNome = ""
	set idxNome = $order(^MEDProviders(0,201,dadoMAX))
	// Se o nome entrado coincidir com o nome inteiro registrado.
	if $order(^MEDProviders(0,201,dadoMAX,"")) '= "" {
		set idxNome = dadoMAX
	} else {
		set idxNome = $order(^MEDProviders(0,201,dadoMAX))
	}
 
	set i = 1
	set blnMaxNumberResults = $$$NO
	set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	
	while blnNamePrefix && 'blnMaxNumberResults {
		set medico = $order(^MEDProviders(0, 201, idxNome, ""))
		set medicodado = $get(^MEDProvider(YM, medico, 1))
		if dadoMAX = $extract($$^WWWUMLAU($$$MEDProviderName(medicodado), 1), 1, $length(dadoMAX)) {
			set ^COMTempList(YM,YUSER,"VARSESCONSUMOPACIENTEMEDICO",dado,medico,1) = $$$MEDProviderName(medicodado)
			set i = i + 1
			if i = 100 {				
				set blnMaxNumberResults = $$$YES
				write "alert('" _ $$^WWWTEXT(334015) _ "');"
			}
		}
		set idxNome = $order(^MEDProviders(0,201,idxNome))
		set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	}
 
	quit $$$OK
 
search(pintPosName, pintPosSearch)
 	; 
 	; 16-Jun-2009 		heber 	2009 - ses change
 	; 
 	new strFormData, dado, dadoMAX, idxNome, i, blnMaxNumberResults, blnNamePrefix,
		paciente, pacientedado, cns, i
	
	set strFormData = $$$GetFormData(YFORM,"D")
	set dado = $piece(strFormData,Y,pintPosName)
 
 	quit:$get(^CacheTempVARSESPatientConsumptionMC(YUSER))=dado $$$OK
 	set ^CacheTempVARSESPatientConsumptionMC(YUSER) = dado
 	kill ^COMTempList(YM,YUSER,"VARSESPatientConsumptionMC")
 
	set dadoMAX = $$^WWWUMLAU(dado,1)
	set idxNome = ""
	// Se o nome entrado coincidir com o nome inteiro registrado.
	if $order(^MEDPatients(0,3,dadoMAX,"")) '= "" {
		set idxNome = dadoMAX
	} else {
		set idxNome = $order(^MEDPatients(0,3,dadoMAX))
	}
	set i = 0
	set blnMaxNumberResults = $$$NO
	set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	
	while blnNamePrefix && 'blnMaxNumberResults {		
		set paciente = ""
		for {
			set paciente = $order(^MEDPatients(0, 3, idxNome, paciente))
			quit:(paciente = "")
			set pacientedado = $get(^MEDPatient(YM, paciente, 1))
			if dadoMAX = $extract($$^WWWUMLAU($$$MEDPatientName(pacientedado), 1), 1, $length(dadoMAX)) {
				
				if ($length(pacientedado) > 1) {
					set cns = $$$MEDPatientExternalCode(pacientedado)
				} else {
					set cns = ""
				}
				
				// Apenas retornarão na pesquisa os paciente com CNS cadastrado.
				continue:(cns = "")
				set idxNome = $$^WWWUMLAU($$$MEDPatientName(pacientedado), 1)
				set ^COMTempList(YM,YUSER,"VARSESPatientConsumptionMC",dado,idxNome_"_"_paciente,1) = "["_cns_"] - "_$ZDATE($$$MEDPatientDOB(pacientedado),4)_"-"_$$$MEDPatientName(pacientedado)
				set i = i + 1
				if i > 100 {
					set blnMaxNumberResults = $$$YES
					write "alert('" _ $$^WWWTEXT(334035) _ "');"
				}
			}
			quit:blnMaxNumberResults
		}
		set idxNome = $order(^MEDPatients(0,3,idxNome))
		set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	}
	set dado=$order(^MEDPatients(0,3,$$^WWWUMLAU($piece(YFELD,Y,pintPosName),1),""))
	set $piece(YFELD,Y,pintPosSearch)=dado
 
	quit $$$OK
 
searchActive(pintPosName, pintPosSearch)
 	; 
 	; 16-Jun-2009 		heber 	2009 - ses change
 	; 
	new strFormData, dado, dadoMAX, idxNome, i, blnMaxNumberResults, blnNamePrefix,
		paciente, pacientedado, cns, i
 
	set strFormData = $$$GetFormData(YFORM,"D")
	set dado = $piece(strFormData,Y,pintPosName)
 
 	quit:$get(^CacheTempVARSESPatientConsumptionMC(YUSER))=dado $$$OK
 	set ^CacheTempVARSESPatientConsumptionMC(YUSER) = dado
 	kill ^COMTempList(YM,YUSER,"VARSESPatientConsumptionMC")
 
	set dadoMAX = $$^WWWUMLAU(dado,1)
	set idxNome = ""
	// Se o nome entrado coincidir com o nome inteiro registrado.
	if $order(^MEDPatients(0,3,dadoMAX,"")) '= "" {
		set idxNome = dadoMAX
	} else {
		set idxNome = $order(^MEDPatients(0,3,dadoMAX))
	}
 
	set i = 1
	set blnMaxNumberResults = $$$NO
	set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	
	while blnNamePrefix && 'blnMaxNumberResults {
		set paciente = ""
		for {
			set paciente = $order(^MEDPatients(0, 3, idxNome, paciente))
			quit:(paciente = "")
			
			set pacientedado = $get(^MEDPatient(YM, paciente, 1))
			if dadoMAX = $extract($$^WWWUMLAU($$$MEDPatientName(pacientedado), 1), 1, $length(dadoMAX)) {
				; restrict to patients with operational treatments
				if $data(^COMTempList(YM,YUSER,"VARSESTreatmentMC",paciente,1)) {
					set cns = $$$MEDPatientExternalCode(pacientedado)
					set ^COMTempList(YM,YUSER,"VARSESPatientConsumptionMC",dado,paciente,1) = "["_cns_"] - "_$ZDATE($$$MEDPatientDOB(pacientedado),4)_"-"_$$$MEDPatientName(pacientedado)
					set i = i + 1
					if i = 100 {
						set blnMaxNumberResults = $$$YES
						write "alert('" _ $$^WWWTEXT(334035) _ "');"
					}
				}
			}
			quit:blnMaxNumberResults
		}
		
		set idxNome = $order(^MEDPatients(0,3,idxNome))
		set blnNamePrefix = (dadoMAX = $extract(idxNome, 1, $length(dadoMAX)))
	}
	set dado=$order(^MEDPatients(0,3,$$^WWWUMLAU($piece(YFELD,Y,pintPosName),1),""))
	
	set $piece(YFELD,Y,pintPosSearch)=dado
 
	quit $$$OK
	
	
 	
 // This one is not called since callback is defined at INIssue :  $$OnBeforeEditAccess^VARSESCONSUMOPACIENTE() 
OnBeforeEditAccess()
 	
	if YFORM = "VARSESPatientConsumptionMC" {
	//Bloqueia o form para usuários que não estejam lotados em locais de Farmácia
		set TipoUsuario = $PIECE($GET(^WWW0121(0,YM,YLOCATION,1)),Y,61) //(Almoxarifado, Farmácia ou Centro de Custo)
		if (TipoUsuario'="FARMACIA") {
			$$$StartScript()
			w "alert('" _ $$$Text($listbuild(334016,$PIECE($GET(^WWW0121(0,YM,YLOCATION,1)),Y,61)))_ "'); "
			$$$EndScript()
			quit 0
		}
	}		
	if YKEY'="" {
 
		set LocalUsuario = $$$INIssueFromLocn(YFELD)
		set Processado = $$$INIssueStatus(YFELD)		
		
		if YFORM = "VARSESPatientConsumptionMC" {
		//Se o form for "Efetivar Consumo para Paciente", carrega o E.F.(Local) e o E.F.(Rede)			
		//Gustavo, 27/09/2007: conforme solicitação do Marcelo e Soleni,
		//deve ser mantido a quantidade em estoque da data de processamento.
		
			if Processado '= 1 {
				do CarregaEstoque^VARSESPatientConsumptionMCLine(YKEY,LocalUsuario)
			}
		}
		elseif YFORM = "INIssue" {
		//Se o form for INIssue, carrega apenas o E.F.(Local)			
			if Processado '= 1 {
				do CarregaEstoqueAjuste^VARSESPatientConsumptionMCLine(YKEY,LocalUsuario)
			}		
		}		
					
		if YLOCATION'=$$$INIssueFromLocn($GET(^INIssue(YM,YKEY,1))) && $data(^INIssue(YM,YKEY,1)) {
		//Bloqueia o form se o registro for referente a um local que não o do usuário
			$$$StartScript()
			w "alert('" _ $$$Text(listbuild(334017,$$$INIssueFromLocn($GET(^INIssue(YM,YKEY,1))),YLOCATION)) _ "'); "
			$$$EndScript()
			QUIT 0
		}
	}
	quit 1
 	
 
validarPaciente(pintPosPatientId)
	if $piece(YFELD,Y,$get(pintPosPatientId))'="" {
		if $get(^MEDPatient(YM,$PIECE(YFELD,Y,pintPosPatientId),1))'="" {
			quit 0
		}
		quit 1
	}
	quit 2
	
validarProfSaude(pintPosCRM)
	if $piece(YFELD,Y,pintPosCRM)'="" {
		if $get(^MEDProvider(YM,$PIECE(YFELD,Y,pintPosCRM),1))'="" {
			quit 0
		}
		quit 1
	}
	quit 2
		
OnBeforeButtonLine(pidAdj,pobjAdj,&pobjForm)
    ;-------------------------------------------------------------------------------
    ; Set form to readonly if not editable
    ;
    ; Params:	pidAdj		- Adj id
    ; 			pobjAdj		- Adj object
    ;
    ; Returns:	pobjForm	- Form object (WWW120)
    ;
    ; History:
	; 15-Aug-2006	JW		SR14826: Created
    ;-------------------------------------------------------------------------------
	if '$$$NoKey(pidAdj) {
		if '$$Editable(pidAdj) {
			set $$$WWW120AuthorizationToModifyData(pobjForm) = 5	// Read Only
		}
	}
	
	quit
 
Editable(pidAdj) 
    ;-------------------------------------------------------------------------------
    ; Is form editable (unprocessed) ?
    ;
    ; Params:	pidAdj - Adj id
    ;
    ; Returns:	status
    ;
    ; History:
    ; 15-Aug-2006	JW		SR14826: Created
    ;-------------------------------------------------------------------------------
	new strStatus,objAdj
	
	set strStatus = $$$OK

	set objAdj=$get(^INIssue(YM,pidAdj,1))
	if (objAdj '= "") {	
		if $$$INIssueStatus(objAdj) = 9 {
			set strStatus = $listbuild("IN00377")  ;Record already processed
		}
	}
	quit strStatus
 
Postable(pidAdj) 
	;-------------------------------------------------------------------------------
	; Test whether this record is postable
	;
	; Params:	pidAdj - INIssue id
	;
	; ByRefs:
	;
	; Returns:	postable status
	;
	; History:
	; 15-Aug-2006	JW		SR14826: Created
	;-------------------------------------------------------------------------------
	quit:$$$NoKey(pidAdj) '$$$OK
	new strStatus
	
	set strStatus = $$Editable(pidAdj)
	
	if $$$ISOK(strStatus) {
		if '$data(^INIssueLine(YM,pidAdj)) {
			set strStatus = $listbuild("IN00517")  ;  Adjustment must have lines
		}
	}
	
	if $$$ISOK(strStatus) {
		set YQ=$$$QSave
	} else {
		set YQ=$$$QDontSave_" "_$$$Text(strStatus)
	}
 	
	quit strStatus
 
OnAfterSave(pidINIssue,pYFELD)
    ;-------------------------------------------------------------------------------
    ; Stock Adjustment
    ; 
	; Params:	pidINIssue - INIssue id
    ; 
    ; Returns: 
    ;
    ; History:
    ; 04-Sep-2008	heber	SRBRxx	: Create
    ;-------------------------------------------------------------------------------
	if ($get(^VARSESCreateLinesFromTreatmentBol) '= "") {
		if $$$ISOK(^VARSESCreateLinesFromTreatmentBol) {
			do CreateLinesFromTreatment^VARSESPatientConsumptionMCLine($$$INIssueReference(pYFELD),pidINIssue)
			kill ^VARSESCreateLinesFromTreatmentBol
		}
	}
	set objIssue = $Get(^INIssue(YM,pidINIssue,1))
	if (objIssue '= ""){
		set $$$INIssueType(objIssue) = 3
		set strStatus = $$$Save("INIssue",pidINIssue,objIssue,$$$YES)		
	}
	do updateLines^VARSESPatientConsumptionMCLine(pidINIssue)

	quit
 
OnAfterPrimaryKey(pidAdj)
    ;-------------------------------------------------------------------------------
    ; OnAfterPrimaryKey
    ; 
	; Params:	pidAdj - INIssue id
    ; 
    ; Returns: 
    ;
    ; History:
    ; 12-Sep-2008	heber	SRBRxx	: Created
    ;-------------------------------------------------------------------------------
	new objINIssue, idTreatment, idINIssueLine, datEstornadoEm
 	set ^datEstornadoEm(YUSER) = 0
	do PrintJS
	///todo Estorno 
	 if (YSEITE=4) {
		if ($length(YKEY)=0) quit
		set strChaveSemBarra = $translate(YKEY,"/"," ")
		if ($length(strChaveSemBarra)=0) quit
		set idHCReverse = $order(^INIssues(0,9,strChaveSemBarra,""))
		if ($length(idHCReverse)=0) quit
		set objEstorno = ^INIssue(0,idHCReverse,1)
		if ($length(objEstorno)=0) quit
		set objDispensacao= ^INIssue(0,YKEY,1)
		set strMotivoEstorno=$$$INIssueFREE16(objDispensacao) 
		set strObservacaoEstorno=$$$INIssueFREE17(objDispensacao) 
		set strEstornadoPor=$$$INIssueFREE18(objEstorno) 
		set datEstornadoEm=$$$INIssueFREE19(objEstorno) 
		set ^datEstornadoEm(YUSER) = datEstornadoEm
	} else {
	// update status
	;do UpdateStatusAllTMC^VARSESTreatmentMC()  Movido para o ato de processar
 
 	set ALERTSTOCK = ""
	set BEGINDATE = ""
	set ENDDATE = ""
	set STATUS = ""
	set DURATION = ""
	set HASLINEADDED = ""
	set YOPTION1=0
	set OBSTREATMENT = ""
	set VARSESRETURNDAY = ""
	
	if (pidAdj '= "") {
		set objINIssue = $get(^INIssue(YM,pidAdj,1))
		set idTreatment = $$$INIssueReference(objINIssue)
		if ($$IsReverted($get(pidAdj))) {
				set strChaveSemBarra = $translate(YKEY,"/"," ")
				set idHCReverse = $order(^INIssues(0,9,strChaveSemBarra,""))
				set objEstorno = ^INIssue(0,idHCReverse,1)
				set datEstornadoEm=+$$$INIssueFREE19(objEstorno) 
				set ^datEstornadoEm(YUSER) = datEstornadoEm
				w !, "<div style=border-color:999999;border-width:1px;border-style=solid;background-color:#E0E0E0;margin-top:6px;margin-bottom:5px;padding-top:4px;padding-right:12px;padding-bottom:4px;padding-left:12px>"
				w !, "<font color=red size=2>Esta dispensação foi estornada em "_$zdate(+datEstornadoEm,4)_".</font>"
				w !, "</div>"
		}
		if (idTreatment '= "") {
			set STATUS = $$SetStatus^VARSESTreatmentMC(idTreatment)
			set BEGINDATE = $$GetFirstConsumptionDate^VARSESPatientConsumptionMCLog(idTreatment)
			set ENDDATE = $$GetEndTreatmentDate^VARSESPatientConsumptionMCLog(idTreatment)
			set idINIssueLine = ""
			set HASLINEADDED = ($order(^INIssueLine(YM,pidAdj,idINIssueLine)) '= "")
			set OBSTREATMENT = $$$VARSESTreatmentMCObservation($get(^VARSESTreatmentMC(YM,idTreatment,1)))
			set CriadoEm  = $$SQLGetDataFormatada^VARSQL($$$INIssueCreatedOn(objINIssue))
			if (HASLINEADDED) {
				set ALERTSTOCK = "Atenção: O valor Estoque Físico (Local) registrado nesse documento é relativo à " _CriadoEm
				set YOPTION1=1
			}
			set VARSESRETURNDAY = $$ReturnDay()
		}
	}
	
	do BuildPatientListActiveTreatments^VARSESTreatmentMC()
	do PrintJSAlertConsumptions()
	}
	quit
 
 
OnBlurTreatment1(pobjINIssue)
	new idTreatment
	set idTreatment = $$$INIssueReference(pobjINIssue)
	quit:(idTreatment = "")
 
	set OBSTREATMENT = $$$VARSESTreatmentMCObservation($get(^VARSESTreatmentMC(YM,idTreatment,1)))
	
	&js<
	document.WWW2.YVARSESPatientConsumptionMCM35.value = "#(OBSTREATMENT)#"
	>
	quit
 
 
OnBlurTreatment(pobjINIssue)
	new idTreatment
	
	set idTreatment = $$$INIssueReference(pobjINIssue)
		
	if (idTreatment '= "") {
		set STATUS = $$SetStatus^VARSESTreatmentMC(idTreatment)
		set BEGINDATE = $$GetFirstConsumptionDate^VARSESPatientConsumptionMCLog(idTreatment)
		set ENDDATE = $$GetEndTreatmentDate^VARSESPatientConsumptionMCLog(idTreatment)
	}
	quit
 
OnBeforeSave(pidAdj)
    ;-------------------------------------------------------------------------------
    ; Stock Adjustment
    ; 
	; Params:	pidAdj - INIssue id
    ; 
    ; Returns: 
    ;
    ; History:
    ; 04-Sep-2008	heber	SRBRxx	: add control to create TMC lines
    ; 17-Aug-2006	JW		SR14826 : Rewrote
    ; 21-Jul-2006	FAN		SR14826 : Created
    ;-------------------------------------------------------------------------------
	new strStatus
 	;FOR I=1:1:999 HANG 1
 	// SRBRxx
 	if ('$$IsLineAdded(pidAdj)) {
	 	set ^VARSESCreateLinesFromTreatmentBol = $$$OK
 	}
	//^^^^
	
	set strStatus = $$Editable(pidAdj)
	
	if $$$ISOK(strStatus) {
		set strStatus=$$$GRIDSave(pidAdj)
	}
	
	if $$$ISERR(strStatus) {
		set Q=$$$QDontSave
		do ReturnError^COMUtilError(strStatus)
	}	
	quit
	
IsLineAdded(pidADJ)
    ;-------------------------------------------------------------------------------
    ; Stock Adjustment
    ; 
	; Params:	pidAdj - INIssue id
    ; 
    ; Returns: 
    ;
    ; History:
    ; 20-Sep-2008	heber	SRBRxx	: check if lines are already added to header
    ;-------------------------------------------------------------------------------
	new idINIssueLine
	set idINIssueLine = ""
	quit ($order(^INIssueLine(YM,pidADJ,idINIssueLine)) '= "")
	
	
Post(pidADJ)
    ;-------------------------------------------------------------------------------
    ; Post adj
    ;
    ; Returns:Status
    ;
    ; History:
    ; 25-Jul-2006	FAN		SR14828: 
    ;-------------------------------------------------------------------------------
	new strStatus, objIssue
	set objIssue = $get(^INIssue(0,pstrKey,1))
	set strStatus = $$$OK
	//Open/Partial Fulfilled
	if ($$$INIssueStatus(objIssue)'=1) && ($$$INIssueStatus(objIssue)'=7) {
		set strStatus = $$$MakeStatus("INREQ05")      ; "Requisition is not Outstanding"
	}
	if $$$ISOK(strStatus) {
		set strStatus = $$Transaction^COMTransaction("FirmTxn^INIssue("""_pidADJ_""")",$$$YES)
	}
	if $$$ISOK(strStatus) {
		do ReloadForm^COMUtilForm()
	}
	quit strStatus
	
PostTxn(pidAdj)
    ;-------------------------------------------------------------------------------
    ; Post adj
    ;
    ; Returns:Status
    ;
    ; History:
    ; 16-Aug-2006	JW		SR14826: Rewrote
    ; 10-Aug-2006	SC		SR14826: fltQuantity is not defined. do u mean fltADJ???
    ; 25-Jul-2006	FAN		SR14826: 
    ;-------------------------------------------------------------------------------
	new idLine,idItem,idLoc,idStkLoc,dteSOH,fltQty,strStatus
	new objAdj,objAdjLine,idReason,curCost,objSOH,fltQtyLeft
	
	set strStatus = $$Editable(pidAdj)
		// Comentada pois o Gustavo disse que a Issue já faz esse tratamento.
			/*
	if $$$ISOK(strStatus) {
		set objAdj=$get(^INIssue(YM,pidAdj,1))
		
		set idLoc 	= $$$INIssueFromLocn(objAdj)
		//set dteAdj	= $$$INIssueStockAdjustmentDate(objAdj)
		
		$$$Order3(^INIssueLine,YM,pidAdj,idLine)
	 		set objAdjLine=$get(^INIssueLine(YM,pidAdj,idLine,1))
	 		
			set idItem		= $$$INIssueLineItem(objAdjLine)
			set idStkLoc	= $$$INIssueLineDespatchStorage(objAdjLine)
			set fltQty		= $$$INIssueLineQtyRequired(objAdjLine)
			set idReason 	= $$$INIssueLineReasonCode(objAdjLine)
			set curCost		= $$$INIssueLineUnitCost(objAdjLine) * $$$INIssueLineQtyRequired(objAdjLine)
			set fltQtyLeft	= fltQty
			
			if fltQtyLeft<0 {
				$$$Order5(^INWE,YM,idItem,idLoc,idStkLoc,dteSOH)
					quit:fltQtyLeft=0
					// TODO - Only for same batch, and expiry date
					set strStatus = $$Adjust^INWE(idItem,idLoc,idStkLoc,dteSOH,.fltQtyLeft,$$$NO)
					quit:$$$ISERR(strStatus)
				$$$End
			} */
			// Comentada pois o Gustavo disse que a Issue já faz esse tratamento.
			/*
			if fltQtyLeft {
			
				set dteSOH = $order(^INWE(YM,idItem,idLoc,idStkLoc,""),-1)
				if dteSOH'="" {					// Add to last batch
					set strStatus = $$Adjust^INWE(idItem,idLoc,idStkLoc,dteSOH,.fltQtyLeft,$$$YES)
					
				}	
					
				// Or if all else fails, create new INWE
			if fltQtyLeft {
				set $$$INWEQuantity(objSOH)		= fltQtyLeft
				set $$$INWEQuantityUnit(objSOH)	= $$$INIssueLineUnit(objAdjLine)
				set $$$INWEUnitPrice(objSOH)	= $$$INIssueLineUnitCost(objAdjLine)
				
				set dteSOH = $$Increment^INWECounter(idItem,idLoc,idStkLoc)
				set strStatus = $$$Save("INWE",idItem_","_idLoc_","_idStkLoc_","_dteSOH,objSOH,1)
			
			//}
			if $$$ISOK(strStatus) {			// History for whoel qty
				;do History(idItem,idLoc,idStkLoc,fltQty,curCost,idReason)
				do History(idItem,idLoc,idStkLoc,fltQty,curCost,idReason,$get(YFORM),pidAdj_","_idLine)  ;BR014754
			}
		$$$End
			
		if $$$ISOK(strStatus) {
			set $$$INIssueStatus(objAdj) = $$$EnumINSTATUSProcessed
			set strStatus = $$$Save("INIssue",pidAdj,objAdj,1)
		}
	}}*/
	quit strStatus
 
LoadGrid(pYKEY)
    ;-------------------------------------------------------------------------------
    ; Code for Grid Edit 
    ;
    ; Returns:
    ;
    ; History:
    ; 25-Jul-2006	FAN		SR14828: Created
    ;-------------------------------------------------------------------------------
	new idForm,YAUSWAHL
	//set idForm="VARSESCONSUMOPACIENTELinha"
	set idForm="VARSESPatientConsumptionMCLine"
	
	set $$$COMGridEditParameterSharedForm(YAUSWAHL)=1
	set $$$COMGridEditParameterMaximumHeight(YAUSWAHL)=400
	set $$$COMGridEditParameterGridName(YAUSWAHL)=idForm
	set $$$COMGridEditParameterUpdateFields(YAUSWAHL)="D2=7"
	set $$$COMGridEditParameterEnabled(YAUSWAHL)=($piece(YVOR,Y,23)'=5)
	//set $$$COMGridEditParameterContainer(YAUSWAHL) = "VARSESCONSUMOPACIENTE"
	set $$$COMGridEditParameterContainer(YAUSWAHL) = "VARSESPatientConsumptionMC"
	$$$GRIDStart(idForm,pYKEY)
	
	quit 
	
OnAfterDataFields(pidAdj)
    ;-------------------------------------------------------------------------------
    ; Code to run when called by the AfterDataField event on the @netManager form.
    ;
    ; History:
    ; 21-JUL-2006		FAN			SR14826: Created
    ;-------------------------------------------------------------------------------
 	
 	new strMessage, blnQuantidadeExcedente, arrItensEmExcesso, item, blnExcesso
 	
 	kill ^CacheTempVARSESCONSUMOPACIENTEMEDICO(YUSER)
	;kill ^CacheTempVARSESCONSUMOPACIENTE(YUSER)
	kill ^CacheTempVARSESPatientConsumptionMC(YUSER)
	
	
	quit:((pidAdj="") || (pidAdj="+"))
	
	do verificarQuantidadeExcedente(pidAdj, .arrItensEmExcesso)
	
	set strMessage = ""
	set blnExcesso = $$$NO
	$$$Order1(arrItensEmExcesso,item)
		set strMessage = strMessage _ "Item: "_item_
						 ", Quantidade a consumir: "_$piece(arrItensEmExcesso(item),Y,1)_
						 ", Quantidade restante: "_$piece(arrItensEmExcesso(item),Y,2)_"\n"
	$$$End
	if strMessage '= "" set blnExcesso = $$$YES
	
	write !,"<script language=""javascript"">"
	&js<
		function processar() {
			if (#(blnExcesso)# == 1) {
				var str = 'Alguns itens serão consumidos em uma quantidade maior do que resta na prescrição.\n' +
							 'Gostaria de proceder com a dispensação?\n\n';
				if (confirm(str + '#(strMessage)#')) {
					CallBackNow('ProcessOnClick^VARSESPatientConsumptionMC','#(pidAdj)#');
				}
			} else {
				CallBackNow('ProcessOnClick^VARSESPatientConsumptionMC','#(pidAdj)#');
			}
		}		
	>
	write !,"</script>"
 
	do LoadGrid(pidAdj)
	quit
 
verificarQuantidadeExcedente(pidConsumo, &arrConsumo)
 
	$$$Order3(^INIssueLine,YM,pidConsumo,idLinha)
 
		set objConsumoLinha = $get(^INIssueLine(YM, pidConsumo, idLinha, 1))
		
		set item	    = $$$INIssueLineItem(objConsumoLinha)
		set qtyAtender  = $$$INIssueLineQtyRequired(objConsumoLinha)
		set qtyRestante = $$MaxQtyToBeConsumed^VARSESPatientConsumptionMCLine(pidConsumo_$$$COMMA_idLinha)
		if qtyRestante < 0 set qtyRestante = 0
		
		if qtyAtender > qtyRestante set arrConsumo(item) = qtyAtender_Y_qtyRestante
 
	$$$End
 
	quit
 
History(pidItem,pidLoc,pidStkLoc,pfltQty,pcurCost,pidReason,pstrSourceForm="",pidSourceId="")  ;BR014754
	;-------------------------------------------------------------------------------
	; Update History for this adjustment
	;
	; Params:	pidItem,pidLoc,pidStkLoc - SOH keys
	; 			pfltQty		- qty adjusted
	; 			pcurCost	- cost update
	; 			pidReason	- 
	;
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 17-Aug-2006	JW		SR14826: Created
	;-------------------------------------------------------------------------------
	new strText,idDelStkLoc
	
	set strText = $$$Text($listbuild("IN00520",pfltQty,pidLoc,pidStkLoc,pidReason))	;%1 Adjusted From %2/%3 Reason Code %4
	
	set idDelStkLoc = $$$INVORGDeleteStockLocation($get(^INVORG(YM,YM,1)))
	if idDelStkLoc="" set idDelStkLoc = "X"
	
	do ^INARTHIST(pidItem,strText,pidLoc,,,-pfltQty,,-pcurCost,idDelStkLoc,,pidStkLoc,,,pidLoc,,"ADJ",,,pidReason,,,pstrSourceForm,pidSourceId) ;BR014754
	
	quit
	
ProcessOnClick(pidAdjustment)
	;-------------------------------------------------------------------------------
	; x
	;
	; Params:	
	; 
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 08-Sep-2008	heber		SRBRXXX: Changed
	;------------------------------------------------------------------------------- 
	if $$VerifyAll(pidAdjustment) {
		
		set strStatus = $$Transaction^COMTransaction("Process^VARSESPatientConsumptionMC("""_pidAdjustment_""")")
		if $$$ISOK(strStatus) {
			do UpdateMCLog^VARSESPatientConsumptionMCLog(pidAdjustment)
			// update status on process
			do UpdateStatus(pidAdjustment)
		}
		do GoToForm^COMUtilForm("VARSESPatientConsumptionMC", pidAdjustment)
	} else {
		do GoToForm^COMUtilForm("VARSESPatientConsumptionMC", pidAdjustment)
	}
	quit
 
UpdateStatus(pidAdjustment)
	;-------------------------------------------------------------------------------
	; 
	;
	; Params:	
	; 
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 02-Dec-2008	heber		SRBRXXX: Created
	;------------------------------------------------------------------------------- 	
	// update status
	new objINIssue, idTMC
	set objINIssue = $get(^INIssue(YM,pidAdjustment,1))
	set idTMC = $$$INIssueReference(objINIssue)
	
	do UpdateStatusTMC^VARSESTreatmentMC(idTMC)
	quit 
	 
VerifyAll(pidAdjustment)
	;-------------------------------------------------------------------------------
	; Check if prescription conditions haven´t changed while dispensation on edition
	;
	; Params:	
	; 
	; ByRefs:
	;
	; Returns:
	;
	; History:
	; 28-Nov-2008	heber		SRBRXXX: Created
	;------------------------------------------------------------------------------- 	
	new objINIssue, idTMC, idPatient, idINIssueLine, objINIssueLine, intResult, YKEY, YFELD,
		strStatus, fltQty, strResponse, strFormData
	set strResponse = $$$OK
	
	set objINIssue = $get(^INIssue(YM,pidAdjustment,1))
	set idTMC = $$$INIssueReference(objINIssue)
	set strFormData = $$$GetFormData(YFORM,"D")
	set idPatient = $$$INIssueCustomerName(strFormData)
		
	// check if treatment still on valid list
	do LstActTrtForPatient^VARSESTreatmentMC()
	if ($data(^COMTempList(YM,YUSER,"VARSESTreatmentActTrtForPat",idPatient,idTMC,1)) = 0) {
		set strResponse = $$$NO
		$$$StartScript()
		w "alert('" _ $$$Text(334027) _"');"
		$$$EndScript()
	} else {
		// check every line
		set idINIssueLine = ""
		set intResult = 0
		for {
			set idINIssueLine = $order(^INIssueLine(YM,pidAdjustment,idINIssueLine))
			quit:(idINIssueLine = "")
			
			set objINIssueLine = $get(^INIssueLine(YM,pidAdjustment,idINIssueLine,1))
			
			set strStatus = $$StatusTreatmentMCLine^VARSESTreatmentMCLine(idTMC,idINIssueLine)
			set fltQty = 1 //$$$INIssueFREE9(objINIssueLine)
			
			// line has been cancelled and qty > 0 do 
			if ((strStatus = $$$TMCCancelled) && (+fltQty '= 0)) {
				set strResponse = $$$NO
				// do not process dispensation
				$$$StartScript()
				w "alert('" _ $$$Text(334027) _"');"
				$$$EndScript()
				quit
			}
			
			set YKEY = pidAdjustment _ "," _ idINIssueLine
			set YFELD = objINIssueLine
			set $$$INIssueLineLocationInventory(YFELD)=$$getSOHLocal^VARSESPatientConsumptionMCLine($$$INIssueLineItem(YFELD),YLOCATION)
	 		set $$$INIssueLineNetworkInventory(YFELD)=$$getSOHCompany^VARSESPatientConsumptionMCLine($$$INIssueLineItem(YFELD))
			// check stock is available fr dispensation
			// check if prescription still has available qty
			set intResult = $$ChecarQuantidade^VARSESPatientConsumptionMCLine()
			if (intResult = 1) {
				set strResponse = $$$NO
				quit
			}
		}
	}
	quit strResponse
	
Process(pidAdjustment)
 
	new strStatus, objAdjustment
	set objIssue = $get(^INIssue(0,pidAdjustment,1))
	set strStatus = $$$OK
	
	//Open/Partial Fulfilled
	if ($$$INIssueStatus(objIssue)'=1) && ($$$INIssueStatus(objIssue)'=7) && ($$$INIssueStatus(objIssue)'=0) {
		set strStatus = $$$MakeStatus("INREQ05")      ; "Requisition is not Outstanding"
	}

	if $$$ISOK(strStatus) {	
		set strStatus = $$Transaction^COMTransaction("FirmTxn^INIssue("""_pidAdjustment_""")",$$$YES)
	}
	
	if $$$ISOK(strStatus) {	
		if '$$$ISOK(strStatus) {
			set $zerror = "Erro no ajuste de estoque. => "_$$DecodeError^COMUtilError(strStatus)
			zquit 1 GOTO @$ZTRAP
		}
		
		set pDate = $Horolog
		set pLocalEst=$$$INIssueFromLocn($get(^INIssue(YM,pidAdjustment,1)))
		set pItens=""
		set dado=""
		set dado=$order(^INIssueLine(YM,pidAdjustment,dado))
		while dado'="" {
			if pItens'="" 
			set pItens=pItens_"|"
			set objIssueLine = $get(^INIssueLine(YM,pidAdjustment,dado,1))
			set pItens=pItens_$$$INIssueLineItem(objIssueLine)_Y_$$$INIssueLineQtyIssued(objIssueLine)
			set dado=$order(^INIssueLine(YM,pidAdjustment,dado))
		}
	} else {
		set $zerror = $$$Text(334018) _ " => "_$$DecodeError^COMUtilError(strStatus)
		zquit 1 GOTO @$ZTRAP
	}
 
	quit $$$OK 
	
OnBlurCNS()
    ;-------------------------------------------------------------------------------
    ; Fills fields with values recovered from ^MEDPatient
    ; 
	; Params: 
    ; 
    ; Returns: 
    ;
    ; History:
    ; 20-Sep-2008	heber	SRBRxx	: created based on routine from VARSESCONSUMOPACIENTE
    ;-------------------------------------------]]><![CDATA[------------------------------------
	new objConsumoPaciente, strCNS, idPaciente, objPaciente, strNome, dteNascimento, strNomeMae
 
	set objConsumoPaciente = $$$GetFormData("VARSESPatientConsumptionMC","D")
	set strCNS 			   = $$$INIssueFREE20(objConsumoPaciente)
	
	quit:(strCNS = "")
	
	if '$data(^MEDPatients(YM, 2, strCNS)) {
	
		$$$Alert($$$Text($listbuild(334019,strCNS)))
 
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 22, "", "D")
	} else {
		
		set idPaciente  = $order(^MEDPatients(YM, 2, strCNS, ""))
		set objPaciente = $get(^MEDPatient(YM, idPaciente, 1))
		set strNome 	   = $$$MEDPatientName(objPaciente)
		set dteNascimento  = $$^WWWDATE($$$MEDPatientDOB(objPaciente))
		set strNomeMae	   = $$$MEDPatientMothersName(objPaciente)
		 
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 18, strNome, "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 12, idPaciente, "D")
		do PopulateDataField^COMUtils("VARSESPatientConsumptionMC", 16, strNomeMae, "D")
		
		write "document.WWW2.YVARSESPatientConsumptionMCD17.value = '"_dteNascimento_"';"
	}
 
	quit
 
 
UpdateFREE9(pobjPatientConsumption) 		
    ;-------------------------------------------------------------------------------
    ; 
    ; 
	; Params:	
    ; 
    ; Returns: 
    ;
    ; History:
    ; 16-Jun-2009	heber	change ses 2009
    ; 08-Sep-2008	heber	SRBRxx	: Create
    ;-------------------------------------------------------------------------------
 	new objTreatmentMC, idTreatment, strResult, idMed, objMed
 	
 	set strResult = ""
 	set idTreatment = $$$INIssueReference(pobjPatientConsumption)
 	set objTreatmentMC = $get(^VARSESTreatmentMC(YM,idTreatment,1))
  	
 	set idMed = $$$VARSESTreatmentMCDoctorId(objTreatmentMC)
 	
 	if (idMed '= "") {
 		set objMed = $get(^MEDProvider(YM,idMed,1))
 		set strResult = $$$MEDProviderName(objMed)
 	}
 	quit strResult
 
UpdateFREE11(pobjPatientConsumption) 		
    ;-------------------------------------------------------------------------------
    ; 
    ; 
	; Params:	
    ; 
    ; Returns: 
    ;
    ; History:
    ; 16-Jun-2009	heber	change ses 2009
    ; 08-Sep-2008	heber	SRBRxx	: Create
    ;-------------------------------------------------------------------------------
 	new objTreatmentMC, idTreatment, strResult, objMed
 	set strResult = ""
 	set idTreatment = $$$INIssueReference(pobjPatientConsumption)
 	set objTreatmentMC = $get(^VARSESTreatmentMC(YM,idTreatment,1))
  	set idMed = $$$VARSESTreatmentMCDoctorId(objTreatmentMC)
 	
 	if (idMed '= "") {
 		set objMed = $get(^MEDProvider(YM,idMed,1))
 		set idEsp = $$$MEDProviderSpeciality(objMed)
 		set strResult = idEsp
 	}
 	quit strResult
 
UpdateFREE1(pobjPatientConsumption) 		
    ;-------------------------------------------------------------------------------
    ; 
    ; 
	; Params:	
    ; 
    ; Returns: 
    ;
    ; History:
    ; 08-Sep-2008	heber	SRBRxx	: Create
    ;-------------------------------------------------------------------------------
 	new objTreatmentMC, idTreatment, strResult
 
 	set strResult = ""
 	set idTreatment = $$$INIssueReference(pobjPatientConsumption)
 	set objTreatmentMC = $get(^VARSESTreatmentMC(YM,idTreatment,1))
 	set strResult = $$$VARSESTreatmentMCCRMCRO(objTreatmentMC)
 	quit strResult
 
AlertConsumptions(pYFELD)
    ;-------------------------------------------------------------------------------
    ; 
    ;
    ; Params:	
    ;
    ; Returns:	
    ;
    ; History:
    ; 15-Dec-2008	Heber		SRXXX: Created
    ;-------------------------------------------------------------------------------	
	new strTxt, idPatient
 
	quit:(pYFELD = "")
	set idPatient = $$$INIssueCustomerName(pYFELD)
	quit:(idPatient = "")
	
	set strTxt = $$GetLastConsumptionsTxt^VARSESPatientConsumptionMCLog(idPatient,$$$NO)
	if (strTxt '= "") {
		$$$StartScript()
		$$$Alert(strTxt)
		$$$EndScript()
	}
	quit
	
	
ReturnDay()
    ;-------------------------------------------------------------------------------
    ; 
    ;
    ; Params:	
    ;
    ; Returns:	
    ;
    ; History:
    ; 21-Aug-2009	Heber		SRXXX: Created
    ;-------------------------------------------------------------------------------
	new intDay, intDayWeek
	
	set intDay = +$horolog
	
	set intDay = intDay + 28
	set intDayWeek = $zdate(intDay,10)
	if (intDayWeek = 0) set intDay = intDay - 3
	if (intDayWeek = 6) set intDay = intDay - 2
	if (intDayWeek = 5) set intDay = intDay - 4
 
	;quit $zdate(intDay,4)
	quit intDay
	
 
GetReceiverName(pIdPatient, pIdAuthorized)
    ;-------------------------------------------------------------------------------
    ; 
    ;
    ; Params:	
    ;
    ; Returns:	
    ;
    ; History:
    ; 23-Set-2009	Heber		SRXXX: Created
    ;-------------------------------------------------------------------------------
	new strNomeRecebedor, objRecebedor
	
	set strNomeRecebedor = ""
	
	quit:(pIdAuthorized = "" ) strNomeRecebedor
	set objRecebedor = $get(^MEDAuthorize(YM,pIdAuthorized,1))
	quit:(objRecebedor = "" ) strNomeRecebedor
	
	set strNomeRecebedor = $$$MEDAuthorizeName(objRecebedor)
	quit strNomeRecebedor
 
IsReturnDateInvalid(pYFELD)
	new strDate
	set strDate = $$$INIssueFREE17(pYFELD)
	quit '(strDate > +$horolog)
 
 
ConvertToCache()
	new idINIssue, idxLocation, objINIssue, strDate, strCacheDate, strStatus 
	set idINIssue = ""
	set idxLocation = ""
	for {
		set idxLocation = $order(^INIssues(YM,10,4,idxLocation))
		quit:(idxLocation = "")
		
		set idINIssue = ""
	
		for {
			set idINIssue = $order(^INIssues(YM,10,4,idxLocation,idINIssue))
			quit:(idINIssue = "")
			
			set objINIssue = $get(^INIssue(YM,idINIssue,1))
			set strDate = $$$INIssueFREE17(pYFELD)
			continue:(strDate = "")
			
			set ^HBLogx("INIssue",idINIssue,$zdate($horolog),0)=objINIssue
			set strCacheDate = $$DateToCache(strDate)
			if (strCacheDate = 0) set ^HBLogx("INIssueerr",idINIssue,$zdate($horolog),0)=objINIssue
			if (strCacheDate > 0) { 
				set ^HBLogx("INIssue",idINIssue,$zdate($horolog),1)=objINIssue
				set strStatus = $$$Save("INIssue",idINIssue,objINIssue,$$$YES)
				set ^HBLog("INIssue",idINIssue,$zdate($horolog),2)=strStatus
			}	
		}
	}
	quit
 
DateToCache(pstrDate)
	; first is the number of days since December 31, 1840
 
 	new strDay, strMonth, strYear, intYears, intNerDays, strDate
 
 	quit:($find(pstrDate,"/") = 0) -1
 	 
 	quit:($length(pstrDate) < 6) 0
 
	set strDay = $piece(pstrDate,"/",1)
	set strMonth = $piece(pstrDate,"/",2)
	set strYear = $piece(pstrDate,"/",3)
	
	quit:($length(strDay) < 2) 0
	quit:($length(strMonth) < 2) 0
	quit:($length(strYear) < 2) 0
	
	; DD/MM/AA
	if ($length(strYear) = 2) { 
		set strYear = "20" _ strYear
		set pstrDate = strDay_"/"_strMonth_"/"_strYear
	}
	quit:($length(strYear) = 3) 0
	
	set intYears = strYear - 1841
	quit:(intYears < 0) 0
	 
	set intNerDays = (intYears * 365)  + strDay
	;set intNerDays = 1
	set strDate = $zdate(intNerDays,4)
	
	for {
		quit:(strDate = pstrDate)	
		set intNerDays = intNerDays + 1
		set strDate = $zdate(intNerDays,4)
	}
	quit intNerDays
	
 
RecoverLastDate()
	new oldINIssue, idINIssue, strX, objHBLog, strLastDate, objINIssue	
	
	$$$VAR
	set oldINIssue = ""
	set idINIssue = ""
	for {
		set idINIssue = $order(^HBLog("INIssue",idINIssue))
		quit:(idINIssue = "")
		; get only new reg
		continue:(oldINIssue = idINIssue)	
		set oldINIssue = idINIssue
		
		set strX = ""
		set strX = $order(^HBLog("INIssue",idINIssue,strX))
		set objHBLog = $get(^HBLog("INIssue",idINIssue,strX,0))
		set strLastDate = $piece(objHBLog,Y,5)
		set objINIssue = $get(^INIssue(YM,idINIssue,1))
		set ^HBLogINIssue(idINIssue,0) = objINIssue
		set $piece(objINIssue,Y,5) = strLastDate
		set ^INIssue(YM,idINIssue,1) = objINIssue
		set ^HBLogINIssue(idINIssue,1) = $get(^INIssue(YM,idINIssue,1))
	}
	quit
 
CheckChanges()
	$$$VAR
	
	new idINIssue, obj, strDate, strX
	set idINIssue = ""
	for {
		set idINIssue = $order(^HBLogINIssue(idINIssue))
		quit:(idINIssue = "")
		set obj = $get(^HBLogINIssue(idINIssue,0))
		set strDate = $piece(obj,Y,5)
		set strX = $piece(strDate,",",1)
		
		if (strX '= "61712") w idINIssue _ "x" _ strX,!		
	}
 
	quit
 
 /// Criado: Jorge Data: 31/03/2010
 /// Método que usa o código de dispensa para zerar os produtos 
 /// daquela dispensação
EstornaDispensacao(pidINIssue, pbolAtualizar=0)
	new strStatus
 	
 	$$$VAR
 
	set strStatus = $$Transaction^COMTransaction("EstornaDispensacaoExec^VARSESPatientConsumptionMC("""_pidINIssue_""", "_pbolAtualizar_")")
	if ($$$ISERR(strStatus)) {
		write !, "Erro ao estornar dispensação: ",
			!, $$DecodeError^COMUtilError(strStatus)
	}
	quit
 
EstornaDispensacaoExec(pidINIssue, pbolAtualizar)
	new objINIssue, idTreatment, datConsumoDisp, strStatus, intLine, idINIssue,
		objLog, datConsumoLog
 
	if (($length(pidINIssue) = 0) ||
		('$data(^INIssue(YM, pidINIssue, 1)))) {
		set $zerror = "A dispensação "_pidINIssue_" não existe ou não foi "_
			"encontrada"
		zquit 1 GOTO @$ZTRAP
	}
 
	set objINIssue = ^INIssue(YM, pidINIssue, 1)
	if ($$$INIssueFREE16(objINIssue) '= $$$VARSESTIPOPACIENTEUSERMediaComplexidade) {
		set $zerror = "Esta dispensação não é do tipo 'Média Complexidade' "_
			"("_$$$INIssueFREE16(objINIssue)_")"
		zquit 1 GOTO @$ZTRAP
	}
	if ($$$INIssueStatus(objINIssue) '= 9) {
		set $zerror = "Esta dispensação não está com status de processada"
		zquit 1 GOTO @$ZTRAP
	}
 
	set idTreatment = $$$INIssueReference(objINIssue)
	if (($length(idTreatment) = 0) ||
		('$data(^VARSESTreatmentMC(YM, idTreatment, 1)))) {
		set $zerror = "Esta dispensação está referenciando a prescrição "_
			idTreatment_" que não existe ou não foi encontrada"
		zquit 1 GOTO @$ZTRAP
	}
	write !, "Prescricao: ", idTreatment
 
	set datConsumoDisp = $$$INIssueCreatedOn(objINIssue)
	set strStatus = $$$OK
 
	set intLine = $order(^VARSESPatientConsumptionMCLog(YM, idTreatment, ""))
	while ($length(intLine) > 0) {
		write !, "Linha: ", intLine
 
		set idINIssue = $order(^VARSESPatientConsumptionMCLog(YM, idTreatment,
			intLine, ""))
		while ($length(idINIssue) > 0) {
			set objLog = ^VARSESPatientConsumptionMCLog(YM, idTreatment, intLine,
				idINIssue, 1)
			set datConsumoLog = $$$VARSESPatientConsumptionMCLogDateConsumption(objLog)
			if (+datConsumoLog = +datConsumoDisp) {
				write !, "Dispensacao: ", idINIssue
				write !, "Valor a zerar: ",
					$$$VARSESPatientConsumptionMCLogQtyConsumption(objLog)
 
				if (pbolAtualizar) {
					set $$$VARSESPatientConsumptionMCLogQtyConsumption(objLog) = 0
					set strStatus = $$$Save("VARSESPatientConsumptionMCLog",idTreatment_$$$COMMA_intLine_$$$COMMA_idINIssue,objLog,1)
					if ('$$$ISOK(strStatus)) quit
 
					write !, "Valor zerado com sucesso", !
				}
			}
 
			set idINIssue = $order(^VARSESPatientConsumptionMCLog(0, idTreatment,
				intLine, idINIssue))
		}
		if ('$$$ISOK(strStatus)) quit
 
		set intLine = $order(^VARSESPatientConsumptionMCLog(0, idTreatment, intLine))
	}
	quit strStatus
 
ValidaBotaoEstorno(pYKEY)
	new LocalUsuario, LocalDonoDoRegistro, objINIssue, strChaveSemBarra
	
	set LocalUsuario = YLOCATION
	set LocalDonoDoRegistro = $$$INIssueFromLocn(YFELD)
	
	if LocalUsuario '= LocalDonoDoRegistro {  // verifica se o usuário é do mesmo local do documento
		set YQ = $$$YQDisable()
		quit
	}
	
	set objINIssue = $get(^INIssue(YM, pYKEY, 1))
	if ($$$INIssueStatus(objINIssue) '= 9) { // verifica se a dispensação ja foi processada
		set YQ = 1_"Dispensação ainda não foi processada"
		quit
	}
 
    set strChaveSemBarra = $translate(pYKEY,"/"," ")
	if (($$$INIssueStatus(objINIssue) = $$$EnumINSTATUSReverted) || ($order(^INIssues(YM, 9, strChaveSemBarra, "")) '= "")
	        ) { // verifica se a dispensação ja foi estornada
		set YQ = 1_"Dispensação já foi estornada"
		quit
	}
	
	
	quit $$$OK


AbreFormEstorno(pYKEY)

	do GoToForm^COMUtilForm("VARSESEstornoDispensacaoMC","",,pYKEY)
	
	quit


IsReverted(idPatientConsumptionHC)
	set strSemBarra = $translate(idPatientConsumptionHC,"/"," ")
	if ($length(strSemBarra)=0) {
		quit ""
	} else {
		quit $order(^INIssues(0,9,strSemBarra,""))'=""
	}

PrintJS
	write !, "<script language=""javascript"">"
	
	&js<
	
		function esconderCampos() {
			if ('#(YSEITE)#' != 1) {
				document.getElementById('Y#(YFORM)#D15').style.display = "none";
				document.getElementById('Y#(YFORM)#D34').style.display = "none";
				document.getElementById('Y#(YFORM)#D25').style.display = "none";
			}
		}			
		
		function addEvent(obj, evType, fn) {
 			if (obj.addEventListener) {
   				obj.addEventListener(evType, fn, false);
   				return true;
 			} else if (obj.attachEvent){
   				var r = obj.attachEvent('on'+evType, fn);
   				return r; 
 			} else {
   				return false;
 			}
		}		

		addEvent(window,'load', esconderCampos);
			
	>
	
	write !, "</script>"
	;;alertconsumptions()
	quit


]]></Routine>
</Export>