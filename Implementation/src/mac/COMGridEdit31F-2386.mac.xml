<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="COMGridEdit31F" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[COMGridEdit31F
	
#include COMGridEdit31
#include WWWConst
#include COMConst
	; Macro override : based on ^CacheTemp rather than YFORM - not used?
#def1arg WWWDATEN(%args)	^WWWDATEN(YM,+$horolog,YUSER,$get(^CacheTemp(YUSER,"Grid","Name")," "),"V",%args)
	
#define LogR(%1,%2) 	;
#define LogRx(%1)		; 
#define LogRm(%1)		;
#;define LogR(%1,%2) 	$$$JournalOff s ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))= %1_"^COMGridEdit31F("_%2_") : "_$zh $$$JournalOn
#;define LogRx(%1)		$$$JournalOff s ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))=%1 $$$JournalOn
#;define LogRm(%1)		$$$JournalOff m ^zzLogR($g(YBED,"UNK"),$i(^zzLogR))=%1 $$$JournalOn
	
INPUT(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)	  ;INPUT FIELD
	;-------------------------------------------------------------------------------
	; Create an input control in a cell
	;
	; YHTML - HTML code for the structure is build in here.    
	; 
	; Inputs:
	;	pblnEvent		.
	;	YFIELDNAME		
	;	YTXT			
	;	PARA			
	;	REL				
	;	YTEXT			
	;	YTYP			.
	;	
	; Implicit:
	;	YFORM			
	;	YUSER			
	;	YLFDAT			"Yyrow_ycol"
	;	YBBN			
	;	YVALIGN			
	;	YPADDING		
	;	YFONT			
	;	YFONTCOLOR		
	;	YFONTSIZE		
	; 
	; Returns:string (HTML)
	;
	; History:
	; 23-Sep-2013	shobby	IPIRANGA-173: Allow for space for button.
	; 23-Sep-2013	shobby	IPIRANGA-173: Width of input text field.
	; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 05-Jul-2010	GRF		SR17414: replace onclick with onmousedown; include
	;							hard-coded width with expression
	; 17-Jun-2010	GRF		SR17375: modified reversion of 14-Apr change
	; 17-May-2010	shobby	SR17253: Included ID (from carlos)
	; 14-Apr-2010	FIS		SR17253: event.keyCode => getEventKeyCode; window.event
	;							=> doCancelEvent
	; 10-Feb-2009	shobby	SR16126:Made previous change optional based on a company parameter.
	; 12-Nov-2008	shobby	SR16126:Simulate commas in a primary key.
	; 26-Jun-2008	GM		SRBR014802: Changed parameter "$$$WWW122ButtonBehindInputField(YTXT)" to "pYTXT"
	; 26-Feb-2008	GRF		Doco; reuse YROW instead of extracting again; remove
	;							$get when variable already accessed; logic inverted
	; 28-Nov-2007	GRF		SR15615: alignment
	; 30-Oct-2007	Karine	BR014722: Change the behavior of "Enter Key" to the same
	;							as "Tab Key"
	; 24-Oct-2006	Steve S	SR14915: Memo field support
	; 26-Jun-2006	JW		SR12775: Make INPUT transparent to see colour of TD
	; 14-Jun-2005	Paul K	Disable coins if "Disable Coins" option on. SR:12589
	;-------------------------------------------------------------------------------
	; keyCode 114	F3	(provide keyboard equivalent to search button)
	;-------------------------------------------------------------------------------
	new blnAdvancedSearch,blnCurrency,strKey,strRef,strReferenceValue
	new YCOL,YHTML,YROW
 
	$$$LogR("INPUT",YFIELDNAME_"."_YTYP_"<"_YLFDAT)
	
	set blnAdvancedSearch = (($get(REL)'="") && ($piece($get(YTXT),Y,94)=1))
	set blnCurrency       = ((YTYP=8)  &&
	                         $find($get(^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V",YLFDAT,1)),"@")  &&
	                         '$get(^CacheTemp(YUSER,$get(^CacheTemp(YUSER,"Grid","Container")," "),"Disable Coins")))
 
	set YROW  = $piece($piece(YLFDAT,"_",1),"Y",2)
	set YCOL  = $piece(YLFDAT,"_",2)
	set YHTML = ""
	;et strKey = $get(^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCEKEY",$Piece($PIECE(YLFDAT,"_",1),"Y",2),1))  ; 26-Feb-2008
	set strKey = $get(^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCEKEY",YROW,1))
	set strKey = $translate(strKey,"""","")
	
	set YHTML = YHTML_"<DIV id='input"_YFIELDNAME_"."_YTYP_"' class='DIVin' >"	

	;**********************************Input*************************************************************
	; SR17253 missing id ;set YHTML=YHTML_"<input name='"_YFIELDNAME_"'"
	set YHTML=YHTML_"<input name='"_YFIELDNAME_"' id='"_YFIELDNAME_"'" // SR17253 added id
	if YTYP=5 {
		set YHTML=YHTML_" type='password'"
	} else {
		set YHTML=YHTML_" type='text'"
	}
	set YHTML=YHTML_" maxlength='"_YLENGTH_"'"
 
	//SR14915
	//IF blnAdvancedSearch||blnCurrency||($$$WWW122ButtonBehindInputField(YTXT)'="") { 
	if (YTYP = 3) || blnAdvancedSearch || blnCurrency || ($$$WWW122ButtonBehindInputField(YTXT)'="") {
	;	set YHTML=YHTML_" class='INsearch' style='width:expression(parentNode.offsetWidth-parentNode.children[1].offsetWidth);"  ;RELATION MIT SUCHFUNKTION
		;IPIRANGA-173 set YHTML=YHTML_" class='INsearch' style='width:350px; width:expression(parentNode.offsetWidth-parentNode.children[1].offsetWidth);" ; SR17414
		set YHTML=YHTML_" class='INsearch' style='width:100%; margin-right:24px;" ; SR17414 ;IPIRANGA-173
	
	} else {
		set YHTML=YHTML_" class='IN' style='"
	}
	
	set YHTML=YHTML_" background-color:transparent;"	//SR12775
	
	if YVALIGN'=""  set YHTML = YHTML_YVALIGN
	if YPADDING'="" set YHTML = YHTML_YPADDING
	set YHTML = YHTML_" font-family:"_YFONT_"; font-size:"_YFONTSIZE_"pt;"
	if $get(YFONTCOLOR)'="" set YHTML = YHTML_" color:"_YFONTCOLOR_";"
	set YHTML = YHTML_"'"
	if $piece(YTXT,Y,23)=5  set YHTML = YHTML_" readonly"  ;FIS;31.08.04;26346
	
	set YHTML = YHTML_YCR_" onKeyDown='"
	;set YHTML = YHTML_YCR_" alert(window.event.keyCode); "
	
	/*  // SR17253 FIS vvvvv
	if ($get(REL)'="") && $$SimulateCommainPrimaryKey^WWW012() {   ;16126
		set YHTML = YHTML_YCR_"if (event.keyCode==188) { window.status="""_REL_"""; event.keyCode=190; "_YFIELDNAME_".value="_YFIELDNAME_".value+""¸"";  window.event.returnValue=false; }"  ;SR16126
	}
	;set YHTML = YHTML_"  if (event.keyCode == 13) { saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""",""eventkey""); window.event.returnValue=false; window.event.cancelBubble=true;}"  //BR014722
	if blnAdvancedSearch {
		set YHTML = YHTML_"  if (event.keyCode == 114) {ysaveevent=""calendar""; openParasearch("""_YFIELDNAME_""",""Y"_YFORM_"D"_$get(YLFN)_""","""_$get(YBBN)_""",570,530);}" ;SR11145
	} elseif blnCurrency {
		set YHTML = YHTML_"  if (event.keyCode == 114) {"_$$CurrencyScreen(YFORM,strKey,YFIELDNAME,YTYP,YLFN,YROW)_"}" ;SR11145
	}
	*/
	if ($get(REL)'="") && $$SimulateCommainPrimaryKey^WWW012() {   ;16126
		set YHTML = YHTML_YCR_"if (window.event.keyCode == 188) { window.status="""_REL_"""; event.keyCode=190; "_YFIELDNAME_".value="_YFIELDNAME_".value+""¸""; window.event.returnValue = false; window.event.cancelBubble = true; }"  ;SR16126  //SR17253 ;SR17853
	}
	;set YHTML = YHTML_"  if (window.event.keyCode == 13) { saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""",""eventkey""); window.event.returnValue = false; window.event.cancelBubble = true;}"  //BR014722  //SR17253 ;SR17853
	if blnAdvancedSearch {
		set YHTML = YHTML_"  if (window.event.keyCode == 114) {ysaveevent=""calendar""; openParasearch("""_YFIELDNAME_""",""Y"_YFORM_"D"_$get(YLFN)_""","""_$get(YBBN)_""",570,530);}" ;SR11145  //SR17253
	} elseif blnCurrency {
		set YHTML = YHTML_"  if (window.event.keyCode == 114) {"_$$CurrencyScreen(YFORM,strKey,YFIELDNAME,YTYP,YLFN,YROW)_"}" ;SR11145  //SR17253
	}
	; SR17375 ^^^
	
	set YHTML = YHTML_"'"
	set YHTML = YHTML_YCR_" onhelp='javascript: window.event.returnValue = false; window.event.cancelBubble = true;'"  //SR17253 ;SR17853
	set YHTML = YHTML_YCR_" onFocus='select();'"
	set YHTML = YHTML_YCR_" onBlur=' if (document.activeElement.id!=""input"_YFIELDNAME_"."_YTYP_""") saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""");'" ;shobby
	set YHTML = YHTML_">"
    
	;**********************************Image*************************************************************
	if blnAdvancedSearch {  ;RELATION MIT SUCHFUNKTION
		set icone=""
		if $$MenuType^WWW013()=14{
			set icone = $$traducaoIcone^WWWFORMCOMMON("search1.gif")
		}
		if icone'=""{
			set YHTML = YHTML_"   <div class='btn btn-outline-"_corBotao_" btn-sm IMGcell' "
			set YHTML = YHTML_" style='width:23px;height:16px;padding:1px 1px 1px 1px;top:1px;right:2px;' "
			set YHTML = YHTML_" onmousedown='ysaveevent=""calendar""; openParasearch("""_YFIELDNAME_""",""Y"_YFORM_"D"_$get(YLFN)_""","""_$get(YBBN)_""",570,530); '"
			set YHTML = YHTML_"TITLE="""_$$^WWWTEXT(148)_""" border=0>"
			set YHTML = YHTML_"<i class='"_icone_"'></i>"
			set YHTML = YHTML_"</div>"
		}else{			
			set YHTML = YHTML_"<IMG SRC='"_YGIF_"search1.gif' TITLE='"_$$^WWWTEXT(148)_"' class='IMGcell' "
		;	set YHTML = YHTML_" onclick='ysaveevent=""calendar""; openParasearch("""_YFIELDNAME_""",""Y"_YFORM_"D"_$get(YLFN)_""","""_$get(YBBN)_""",570,530); '" ; SR17414
			set YHTML = YHTML_" onmousedown='ysaveevent=""calendar""; openParasearch("""_YFIELDNAME_""",""Y"_YFORM_"D"_$get(YLFN)_""","""_$get(YBBN)_""",570,530); '"
			set YHTML = YHTML_">"
		}	
	} elseif blnCurrency {      ;&&('$data(^CacheTemp(YUSER,YFORM,"Disable Coins"))) {
		set YHTML = YHTML_"<IMG SRC='"_YGIF_"konditionen.gif' TITLE='"_$$^WWWTEXT(33910)_"' class='IMGcell' "
	;	set YHTML = YHTML_" onclick='"_$$CurrencyScreen(YFORM,strKey,YFIELDNAME,YTYP,YLFN,YROW)_"'" ; JW 14-Dec-2004: Added onclick. ; SR17414
		set YHTML = YHTML_" onmousedown='"_$$CurrencyScreen(YFORM,strKey,YFIELDNAME,YTYP,YLFN,YROW)_"'"
	
		set YHTML = YHTML_">"
		set strReferenceValue = $get(^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V",YLFDAT,1))
		if $find(strReferenceValue,"@") {
			set strReferenceValue = $piece(strReferenceValue,"@",2)
			set YINHALT = strReferenceValue
		}
		
	} elseif $$$WWW122ButtonBehindInputField(YTXT)'="" {
		; Active Field Button
		;set YHTML=YHTML_$$GetCustomButton(YFORM,$$$WWW122ButtonBehindInputField(YTXT), YFIELDNAME,$$$NO)  ;BR014802
		set YHTML = YHTML_$$GetCustomButton(YFORM,YTXT,YFIELDNAME,$$$NO)  ;BR014802
	}
	
	if YTYP = 3 { //SR14915 Memo Fields
		set YHTML = YHTML_$$MemoLink^WWWFORM9($$$GRIDClass(YFORM),YTXT,"D",strKey,$$$YES)
	}
	;**********************************Original Value*************************************************************
	set YHTML = YHTML_"</DIV>"
	quit YHTML
	
	
GetCustomButton(pidForm="",pYTXT,YFIELDNAME,pblnDisabledField=$$$NO)
	;-------------------------------------------------------------------------------
	; Dunno, maybe get the custom button
	;
	; Params:
	;
	; Returns:
	;
	; History:
	; 23-Sep-2013	shobby	IPIRANGA-173: Give focus back to the cell after button operation.
	; 27-Jun-2013	shobby	IPIRANGA-125: Put a DIV around the buttons so they can be hidden if
	;							the column is not shown.
	; 26-Jun-2008	GM		SRBR014802: Changed parameter "pstrButtons" to "pYTXT"
	; 29-May-2008	GM		SRBR014802: Make work "Execute OnClick" field in WWW124
	; 08-May-2008	GM		SRBR014802: Included conditions for permanent button and
	;							parameter pblnDisabledField for disable fields in grid
	; 18-Oct-2007	shobby	SRBR014566: Replace the YFIELDNAME keyword specified
	;							in the button call with the actual value of YFIELDNAME
	;							(So the button knows where the result is called)
	;							*** Custom buttons can be added to a cell in a grid
	;							*** note that the data structure is the same so the
	;							*** same macros can be used.
	; 22-Aug-2007	Frank	SRBR014566: Consider Hyper Event Call as well;
	; 15-Jul-2005	shobby	SR12754:Replaced LANGUAGE global (not always reliable)
	; 08-Jul-2005	RobertW	Commented.
	;-------------------------------------------------------------------------------
	new blnCustomFlag,ButtonLoop,idButton,objButton,strButtons,strExec,strHTML
	new strHyper,strParam1,strParam2,strParam3,strParam4,strPicture,strParams
 
	$$$LogR("GetCustomButton",pidForm_"<"_$get(YFIELDNAME))
	
	set blnCustomFlag = $$$NO ;BR014566
	set strHTML       = ""
	set strButtons    = $$$WWW122ButtonBehindInputField(pYTXT)  ;BR014802
	set strHTML=strHTML_"<DIV id='BTN"_YFIELDNAME_"' style='overflow:hidden;'>" ;IPIRANGA-125
	if (pidForm'="") && (strButtons'="") {
		for ButtonLoop=1:1:$length(strButtons) {
			set idButton = $piece(strButtons,";",ButtonLoop)
			continue:idButton="" ;BR014566
			
			if idButton="***CUSTOM***" set blnCustomFlag = $$$YES continue  ;BR014566
			
			if blnCustomFlag {
				set objButton = $get(^WWW124D(0,pidForm,SPRACHE,idButton,1))
			} else {
				set objButton = $get(^WWW124(0,pidForm,SPRACHE,idButton,1))
			}
			if $$$WWW122PermanentButton(pYTXT) || 'pblnDisabledField {  ;BR014802
 
				set strPicture=$$$WWW124PictureFileOnButton(objButton)
				if strPicture="" set strPicture=$extract($$$WWW124ButtonDescription(objButton))_".gif"
				set strHTML=strHTML_"<IMG SRC='"_YGIF_strPicture_"' "
				if pblnDisabledField set strHTML=strHTML_"style=""position:relative; top:0;height:18"""   ;BR014802
				if pblnDisabledField set strHTML=strHTML_" align=right "  ;BR014802
 
				set strHTML=strHTML_" TITLE='"_$zconvert($$$WWW124ButtonDescription(objButton),"o","HTML")_"' class='IMGcell' "
				
				if $$$WWW124FunctionJavaScriptOnClick(objButton)'="" {
					set strHTML=strHTML_"onclick="""_$$FullReplace^COMUtilStr($translate($$$WWW124FunctionJavaScriptOnClick(objButton),"|"),"YFIELDNAME",YFIELDNAME)_";"
					set strHTML=strHTML_" window.setTimeout(function() {" ;IPIRANGA-173
					set strHTML=strHTML_" var value=document.getElementById('activefield').value;"
					set strHTML=strHTML_" if (value!='') {"
					set strHTML=strHTML_"   var obj=document.getElementById(value);"
					set strHTML=strHTML_"   if (obj!=null) {"
					set strHTML=strHTML_"	  obj.focus();"
					set strHTML=strHTML_"   }"
					set strHTML=strHTML_" }"
					set strHTML=strHTML_"}"
					set strHTML=strHTML_",50); " ;IPIRANGA-173

					set strHTML=strHTML_""" " ;BR014566
				
				} elseif $$$WWW124HyperEventOnClick(objButton) '= "" { ;SRBR014566
	 
					set strHyper  = $$$WWW124HyperEventOnClick(objButton)
					set strParams = $piece($piece(strHyper,"(",2),")",1)
					set strExec   = $piece(strHyper,"(",1)
					
					// When the button is shown inside the Grid Edit cell (this situation) the first parameter of the
					// Hyper Event Call will be the cell name.
					set strParam1 = YFIELDNAME
					set strParam2 = $piece(strParams, ",", 1)
					
					set strParams = $piece(strParams, ",", 2)    ; FIXME : Should this be ...,2,999)? won't strParams4 always be null?
					set strParam3 = $piece(strParams, ",", 1)    ;         and this always match strParams as currently is? <GRF>
					
					set strParams = $piece(strParams, ",", 2)    ; FIXME : why not set strParam3 & strParam4 directly to pieces 2 and 3?
					set strParam4 = $piece(strParams, ",", 1)    ;         current instances all have "subr^ROUTINE" structure. <GRF>
					
					set strHTML = strHTML_" onclick=""CallBackNow('"_strExec_"','"_strParam1_"','"_strParam2_"','"_strParam3_"','"_strParam4_"');"""
			
				} elseif $$$WWW124ExecuteOnClick(objButton) '="" {  ;BR014802
					set strHTML = strHTML_" onclick=""CallBackNow('"_$piece($$$WWW124ExecuteOnClick(objButton),"(",1)_"');""" ;BR014802
					; FIXME : What happens about parameters proposed for passing to functions?
					;         e.g. D ^WWW0042($G(YKEY),2) for WWW013 button 4
					;              DO KILL1^WWWWV(+$h-7)  for WWWWV  button 3
 
				}
				set strHTML=strHTML_">"
			}
		}
	}
	set strHTML=strHTML_"</DIV>" ;IPIRANGA-125
	quit strHTML
	
	
CurrencyScreen(YFORM,YKEY,YFIELDNAME,YTYP,YLFN,YROW)
	;-------------------------------------------------------------------------------
	;
	; Returns:
	;
	; History:
	; 07-Apr-2005	shobby	SR10549: Passed the Column number into the WWWDATEN
	;							routine.  Required because Form Column does not
	;							always match Class Column.
	; 04-Apr-2005	shobby	Passed in parameters
	;-------------------------------------------------------------------------------
	new YHTML,YART
	
	$$$LogR("CurrencyScreen",YFORM_"<"_YKEY_"<"_YFIELDNAME_"<"_YTYP_"<"_YLFN)
	
	set YHTML = ""
	set YART  = "D"
	set URL   = YAKTION_"EP=WWWFORM&YFORM=WWWWHRX&YUSER="_YUSER_"&YBED="_YBED_"&YTRAKT="_YTRAKT_"&YUCI="_$get(YUCI)_"&YM="_YM_"&YLFDAT=Y"_YFORM_YART_YLFN_"&YLFFORM="_YFORM_"&YHTMFORM1="_YHTMFORM_"&YKEY="_YKEY
	set YHTML = YHTML_" var retval = EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"",""COMGridEdit31R"",""WWWDATEN"",""6"","""_YFORM_Y_YART_Y_YLFN_Y_YROW_Y_$piece(YFIELDNAME,"_",2)_""");"
	set YHTML = YHTML_" var result = window.showModalDialog("""_URL_"&YSEC=""+ new Date().getSeconds(),""Calendar"",""DialogWidth: 600px; DialogHeight: 180px; resizable: no; status: no"");"
	set YHTML = YHTML_" if (result == null ) { "		; JW 15-Dec-2004: If eXit pressed.
	set YHTML = YHTML_"   result=document.getElementById("""_YFIELDNAME_""").value;"
	set YHTML = YHTML_" } "
	set YHTML = YHTML_"   saveData("""_YFIELDNAME_""",result,"""_YTYP_""");"
	quit YHTML
 
 
CUR]]><![CDATA[RENCY(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
 ;FREMDWÄHRUNG;FIS;25933;21.06.2004
	new YHTML
	
	$$$LogR("CURRENCY",pblnEvent_"<"_YFIELDNAME_"."_YTYP_"<"_YLFN)
	
	set YHTML = ""
	if (YTYP=8) && $find(YTEXT,"@") {
		if (YHID'=1) && (YHID'=2) {
			set YART  = "D"
			set YHTML = YHTML_"<A class=link"
			set URL   = YAKTION_"EP=WWWFORM&YFORM=WWWWHRX&YUSER="_YUSER_"&YBED="_YBED_"&YTRAKT="_YTRAKT_"&YUCI="_$get(YUCI)_"&YM="_YM_"&YLFDAT=Y"_YFORM_YART_YLFN_"&YLFFORM="_YFORM_"&YHTMFORM1="_YHTMFORM_"&YKEY="_YKEY
			set YHTML = YHTML_" onclick=""var result = window.showModalDialog('"_URL_"&YSEC='+ new Date().getSeconds(),'Calendar','DialogWidth: 600px; DialogHeight: 180px; resizable: no; status: no');"
			set YHTML = YHTML_"if (result != null) {"
			set YHTML = YHTML_"  retval = EventValue('"_YUCI_"','"_YUSER_"','"_YFORM_"','FIX','Y"_YFORM_YART_YLFN_"',result,'2','NOVALUE');"
		;	if (YFOART=1)||(YFOART=3) IF YART="D" IF $$$WWW120StandardSubmit(YVOR)="" set YHTML=YHTML_" BEARB('"_$GET(^WWW100(0,"BEARBEITUNG",SPRACHE,2,1))_"');"
			set YHTML = YHTML_" document."_YHTMFORM_".Y"_YFORM_YART_YLFN_".focus();"
			set YHTML = YHTML_" }"
			set YHTML = YHTML_""""
			set YHTML = YHTML_">"
			set YHTML = YHTML_"<IMG SRC='"_YGIF_"konditionen.gif' ALIGN=ABSBOTTOM TITLE="""_$$^WWWTEXT(33910)_""" border=0>"
			set YHTML = YHTML_"</A>"                                                ; "Edit Foreign Currency"
		;	}
		}
	} else {
		set YHTML = $$INPUT(pblnEvent,YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
	}
	quit YHTML
	
	
CHECK(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
	;-------------------------------------------------------------------------------
	; 
	;	shobby - Can be called from GetData2^COMGridEdit31A
	;
	; Returns:
	;
	; History:
	; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 17-Jun-2010	GRF		SR17375: modified reversion of 14-Apr change
	; 14-Apr-2010	FIS		SR17253: event.keyCode => getEventKeyCode; window.event
	;							=> doCancelEvent
	; 06-Jun-2005	shobby	Passed in parameters.  Code Check
	;-------------------------------------------------------------------------------
	new YHTML,YVOR
	;quit "gridControlsCheck("_YFIELDNAME_","_YTEXT_",1);"
	
	$$$LogR("CHECK",pblnEvent_"<"_YFIELDNAME_"."_YTYP)
	
	set YVOR = $$$GRIDYVOR(YFORM)
	
	set YHTML = ""
	set YHTML = YHTML_"<input type=""checkbox"" name="""_YFIELDNAME_""" id="""_YFIELDNAME_""""
	set YHTML = YHTML_" value="""_+YTEXT_""""
	if +YTEXT=1 set YHTML = YHTML_" checked"
	
	if (YVOR="") || ($$$WWW120AuthorizationToModifyData(YVOR)'=$$$EnumReadOnly) {
		
		set YHTML = YHTML_YCR_" onKeyDown='if (window.event.keyCode == 13) {var setval=0; if (this.checked == true) setval=1; saveData("""_YFIELDNAME_""",setval,"""_YTYP_""",""eventkey""); window.event.returnValue = false; window.event.cancelBubble = true;}'" ;SR17853
		set YHTML = YHTML_YCR_" onhelp=""javascript: window.event.returnValue = false; window.event.cancelBubble = true;""" ;SR17853
		set YHTML = YHTML_YCR_" onBlur ='var setval=0; if (this.checked == true) setval=1; saveData("""_YFIELDNAME_""",setval,"""_YTYP_""");'"
		set YHTML = YHTML_YCR_" onClick='var setval=0; if (this.checked == true) setval=1; saveData("""_YFIELDNAME_""",setval,"""_YTYP_""",""mouseclick"");'"
	}
	set YHTML = YHTML_">"
	quit YHTML
 
 
 
RADIO()
	;-------------------------------------------------------------------------------
	;	RADIO BUTTON
	;	
	; History:
	; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 17-Jun-2010	GRF		SR17375: modified reversion of 14-Apr change
	; 17-May-2010	shobby	SR17253: add id to input
	; 14-Apr-2010	FIS		SR17253: event.keyCode => getEventKeyCode; window.event
	;							=> doCancelEvent
	;-------------------------------------------------------------------------------
	new SUCH,YI,NR,YHTML
	
	$$$LogR("RADIO","")
	
	set YHTML=""
	set SUCH="^"_REL_"("""_$$$WWWYM(REL)_""""  ;ZUSAMMENBAU DER GLOBALREFERENZ
	if PARA'="" set SUCH=SUCH_","_PARA
	set SUCH=SUCH_")"
	for  do  quit:SUCH=""
	. set SUCH = $query(@SUCH)
	. if $piece($piece(SUCH,"^",2),"(",1)'=REL           set SUCH = "" quit
	. if $piece($piece(SUCH,"(",2),",",1)'=$$$WWWYM(REL) set SUCH = "" quit
	. if PARA'="" for YI=2:1:1+$length(PARA,",") do  quit:SUCH=""
	. . if $find($piece(PARA,",",YI-1),"""")  if $piece(SUCH,",",YI)'=$piece(PARA,",",YI-1) set SUCH = ""
	. . if '$find($piece(PARA,",",YI-1),"""") if $translate($piece(SUCH,",",YI),"""")'=$translate(@$piece(PARA,",",YI-1),"""") set SUCH = ""
	. ;
	. quit:SUCH=""
	. if PARA'="" set NR = $piece(SUCH,",",2+$length(PARA,","))
	. if PARA=""  set NR = $piece(SUCH,",",2)
	. set YHTML = YHTML_"<input type=""radio"" name="""_YFIELDNAME_""" id="""_YFIELDNAME_""""		;SR17253
	. set YHTML = YHTML_" value="""""
	. if YTEXT=NR set YHTML = YHTML_" checked"
	. set YHTML = YHTML_YCR_" onKeyDown='"
	.;     SR17375 vvv
	. set YHTML = YHTML_" if (window.event.keyCode == 13) {saveData("""_YFIELDNAME_""","""_YTEXT_""","""_YTYP_""",""eventkey""); window.event.returnValue = false; window.event.cancelBubble = true;}" ;SR17853
	. set YHTML = YHTML_" if (window.event.keyCode == 32) {window.event.returnValue = false; window.event.cancelBubble = true;}'" ;SR17853
	.;     SR17375 ^^^
	. set YHTML = YHTML_YCR_" onhelp=""javascript: window.event.returnValue = false; window.event.cancelBubble = true;""" ;SR17853
	. set YHTML = YHTML_YCR_" onBlur ='saveData("""_YFIELDNAME_""","""_YTEXT_""","""_YTYP_""");'"
	. set YHTML = YHTML_YCR_" onClick='saveData("""_YFIELDNAME_""","""_NR_""","""_YTYP_""",""mouseclick"");'"
	. set YHTML = YHTML_">"
	. if (($get(YDAT)'="") && ($piece(YDAT,Y,7)=1)) || ($piece(YTXT,Y,62)=1) set YHTML = YHTML_$piece(@SUCH,Y,+RELF) quit ; SR11074
	. set YHTML = YHTML_$$^WWWNBSP($translate(NR,"""")_" ("_$piece(@SUCH,Y,+RELF))_")"
	
	quit YHTML
	
	
SELECT(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
	;-------------------------------------------------------------------------------
	;	AUSWAHLFELD
	; Builds HTML for a Select/Option structure (Drop-down list) in the Grid.
	;	ie. <Select>
	;			<Option> ... </option>
	;			<Option> ... </option>
	;			...
	;			<Option> ... </option>
	;		</Select>
	;
	;	YHTML(1) - <Select> tag
	;	YHTML(2) - <Option></Option> tags
	;	YHTML(3) - </Select> tag
	; 
	; Inputs:	pblnEvent=""
	;			YFIELDNAME
	;			YTXT
	;			PARA
	;			REL
	;			YTEXT
	;			YTYP
	;
	; Returns:	YHTML - HTML for the SELECT structure.
	;
	; History:
	; 26-Jun-2013	shobby	CORE-126.4: Corrected sizing of combo boxes in grids.
	; 22-May-2012	shobby	SR17724: Corrected with of selection controls	
    ; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 01-Nov-2010	shobby	SR17591: Moved the $$$OnBeforeDisplayCombo so that variables
	;					created by DefineKeys will be available.
	; 17-Jun-2010	GRF		SR17375: modified reversion of 14-Apr change
	; 18-May-2010	shobby	SR17253: Incorrect defined id (reported by Carlos)
	; 14-Apr-2010	FIS		SR17253: event.keyCode => getEventKeyCode; window.event
	;							=> doCancelEvent
	; 03-Nov-2009	DWR		SR16983: PassYTXT into BUILDSELECTOVERRIDE
	; 28-Feb-2008	shobby	SRBR014894: Pass YTXT into BUILDSELECT
	; 07-Aug-2006	SC		SR14604: Clean up routine.  Switch to INPUT cell if max
	;							data items reached.
	; 06-Jun-2005	shobby	Passed in YTEXT,RELF,YMAXSTR as parameters to BUILDSELECT 
	;							and BUILDSELECT override. (Code Check)
	;-------------------------------------------------------------------------------
	new YHTML,YN,YMAXSTR,SUCH,YI,NR,blnOverride,intCounter,intMaxDataShow, blnDoINPUT
	
	$$$LogR("SELECT",pblnEvent_"<"_YFIELDNAME_"."_YTYP_"<"_REL)
	
	set YMAXSTR = 0
	set YHTML   = ""
	;START
	
	//SR14604
	set blnDoINPUT = $$$NO
	
	set SUCH = "^"_REL_"("""_$$$WWWYM(REL)_""""  ;ASSEMBLY OF THE GLOBAL REFERENCE
	if PARA'="" set SUCH = SUCH_","_PARA
	set SUCH = SUCH_")"
	
	set blnOverride = $$$NO
	;SR17591 $$$OnBeforeDisplayCombo(YKEY,YFIELDNAME,.SUCH,.blnOverride)
	
	set YN = 2
	set YHTML(YN) = ""
	
	if (PARA="") || $$DefineKeys^WWWFieldValidation(YFORM,PARA) {	//SR14604
		$$$OnBeforeDisplayCombo(YKEY,YFIELDNAME,.SUCH,.blnOverride) ;SR17591 
		;<Option></Option> tags.
		if blnOverride { 
			set blnDoINPUT = $$BUILDSELECTOVERRIDE(.SUCH,.YHTML,.YN,YBBN,REL,PARA,YTEXT,RELF,.YMAXSTR,YWIDTH,YTXT)  ; SR16983
		} else {
			set blnDoINPUT = $$BUILDSELECT(.SUCH,.YHTML,.YN,YBBN,REL,PARA,YTEXT,RELF,.YMAXSTR,YWIDTH,YTXT) ;BR014894
		}
	}
	
	if blnDoINPUT {  //Skip SELECT, switch to an INPUT(COMSearch).
		set $$$WWW122RelationWithSearchFuncti(YTXT)=$$$YES  
		set YHTML = $$INPUT(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
		
		quit YHTML                                              ; *** EARLY EXIT ***   ; FIXME : could be else <GRF>
	}
	
	set ^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCESELECT",YBBN,2,1)=YHTML(2)
	
	;<Select> tag
	set YN=1  
	set YHTML(YN) = ""
	;SR17253 set YHTML(YN) = YHTML(YN)_YCR_"<select NAME="""_YFIELDNAME_""" ID="""_YFIELDNAME_"_select"""
	set YHTML(YN) = YHTML(YN)_YCR_"<select NAME="""_YFIELDNAME_""" ID="""_YFIELDNAME_""" "  ;SR17253
	if $$$WWW122DataInputType(YTXT)=6 {
		set YHTML(YN) = YHTML(YN)_" size=5 multiple=""multiple"""  ;multi-select
	} else {
		set YHTML(YN) = YHTML(YN)_" size=1"
	}
	set YHTML(YN) = YHTML(YN)_" class='SEL'"
	set YHTML(YN) = YHTML(YN)_" style='"
	set YHTML(YN) = YHTML(YN)_" background-color:"_YCOLON_";"
	set YHTML(YN) = YHTML(YN)_" width:"_YWIDTH_"px;" ;CORE-126.4
	set YHTML(YN) = YHTML(YN)_" height:"_YHEIGHT_"pt;"
	set YHTML(YN) = YHTML(YN)_" font-family:"_YFONT_"; font-size:"_YFONTSIZE_"pt;"
	set YHTML(YN) = YHTML(YN)_"'"	 
	
	set YHTML(YN) = YHTML(YN)_YCR_" onKeyDown='if (window.event.keyCode == 13) { this.blur(); }'"
	set YHTML(YN) = YHTML(YN)_YCR_" onhelp=""javascript: window.event.returnValue = false; window.event.cancelBubble = true;""" ;SR17853
	
	set YHTML(YN) = YHTML(YN)_YCR_" onBlur='"
	if $$$WWW122DataInputType(YTXT)=6 {
		set YHTML(YN) = YHTML(YN)_" selval=MULTISELECTD"_YLFN_"();"
	} else {
		set YHTML(YN) = YHTML(YN)_" selval=this.value;"
	}
	
	set YHTML(YN) = YHTML(YN)_" saveData("""_YFIELDNAME_""",selval,"""_YTYP_"""); window.event.returnValue=false; window.event.cancelBubble=true;'"  //SR17253 FIS ;SR17853
	
	set YHTML(YN) = YHTML(YN)_">"
	set YHTML(YN) = YHTML(YN)_YCR_"<option value="""">&nbsp;</option>"
	
	set ^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCESELECT",YBBN,YN,1)=YHTML(YN)
 
	;</Select> tag
	set YN = 3
	set YHTML(YN) = ""
	set YHTML(YN) = YHTML(YN)_YCR_"</select>"	 
	if $piece(YTXT,Y,2)=6 set YHTML(YN) = YHTML(YN)_$$VAR^WWWFORM73(,,YFIELDNAME,1)  ;AUFBEREITEN FELDAUSWAHL
	
	set ^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCESELECT",YBBN,YN,1)=YHTML(YN)
	 
	set YN = ""
	for {
		set YN = $order(YHTML(YN))
		quit:YN=""
		
		set YHTML = YHTML_YHTML(YN)
	}
	quit YHTML
	
	
BUILDSELECT(&SUCH,&YHTML,&YN,YBBN,REL,PARA,YTEXT,RELF,&YMAXSTR,YWIDTH,YTXT)
	;-------------------------------------------------------------------------------
	; Builds HTML for a individual Select (Drop-down list) lines.
	;
	; Returns: blnMaxNumRecords - Set if the Select has reached MaxNumRecords
	;
	; History:
	; 02-Jun-2014	SCR		HEVA-1505: Allow for calculated fields
	; 19-Oct-2010	shobby	SR17565: Call to common ComboToSearch routine.
	; 17-Jul-2009	GRF		Variables repeated invalidly in new list; comment cleanup
	; 28-Feb-2008	shobby	SRBR014894: Don't display primary key if DoNotShowPrimaryKey is checked.
	; 04-Jul-2007	RPW		SRadhoc: Rewrote in Brace Syntax
	; 05-Dec-2006	JW		SR?: Default max
	; 18-Aug-2006	RPW/JW	SR14604: Make 0 always show a popup
	; 07-Aug-2006	SC		SR14604: Quit if MaxDataItems reached. 
	; 06-Jun-2005	shobby	Passed in YTEXT,RELF,YMAXSTR as parameters. (Code Check)
	; 11-Apr-2005	shobby	Passed in REL and PARA as parameters.
	;-------------------------------------------------------------------------------
	new blnCheck,blnMax,intCounter,intMax,NR,strLine,strPiece,strRel,YI
	
	$$$LogR("BUILDSELECT",SUCH)
	
	set blnMax = $$$NO
	//set intMax= $$$WWW012MaximumNumberOfRecordsOnS($get(^WWW012(0,YM,1)))
	set intMax = $$GetMaxSelectRecords^WWW012()
	
	// Check number of records if have limit and can change Combo to Search.
	//set blnCheck = (intMax'="") && (intMax>=0) && $$$WWW001ComboToSearch($get(^WWW001(0,REL,1)))	
	;SR17565 set blnCheck = $$$WWW001ComboToSearch($get(^WWW001(0,REL,1)))
	set blnCheck = $$ComboToSearch^WWWFOR71("",REL) ;SR17565
	
	set strRel = $$$WWWYM(REL)
	
	for {
		set SUCH = $query(@SUCH)
		quit:SUCH=""
		
		if $piece($piece(SUCH,"^",2),"(",1)'=REL {
			set SUCH=""
		} elseif $piece($piece(SUCH,"(",2),",",1)'=strRel {
			set SUCH=""
		} else {
			if PARA'="" {
				for YI=2:1:1+$length(PARA,",") {
					set strPiece=$piece(PARA,",",YI-1)
					if $find(strPiece,"""") {
						if $piece(SUCH,",",YI)'=strPiece {
							set SUCH=""
						}
					} else {
						if $translate($piece(SUCH,",",YI),"""")'=$translate(@strPiece,"""") {
							set SUCH=""
						}
					}
				}
			}
			if SUCH'="" {
				if (blnCheck && (($increment(intCounter))>intMax)) {
					set SUCH = ""
					set blnMax = $$$YES
					
				} else {
					if PARA'="" {
						set NR = $piece(SUCH,",",2+$length(PARA,","))
					} else {
						set NR = $piece(SUCH,",",2)
					}
					;17604 TODO
					set YHTML(YN) = YHTML(YN)_"<option value="""_$translate(NR,"""")_""""

					if YTEXT=NR {
						set YHTML(YN) = YHTML(YN)_" selected"
					}
					set strLine = ""
					if '$$$WWW122DoNotShowPrimaryKey(YTXT) set strLine=$$^WWWNBSP($translate(NR,""""))_" - "
					if $$$WWW122CalcRelationalDataField(YTXT)="" {
						set strLine	= strLine_$piece(@SUCH,Y,+RELF)
					} else {
						set strLine	= strLine_$$GetCalculatedValue^COMGridEdit31F1(YFORM,YKEY,@SUCH,YBBN,YTXT,$translate(NR,""""),YLFN) ;SR17714.4
		 			}					
					set YHTML(YN) = YHTML(YN)_">"_$extract(strLine,1,YWIDTH)_"</option>"
					if $length(YHTML(YN))>32600 {
						set YMAXSTR = 1
						set ^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCESELECT",YBBN,YN,1) = YHTML(YN)
						set YN = YN+1 
						set YHTML(YN) = ""
					}
				}
			}
		}
		quit:SUCH=""
	}
	quit blnMax
	
	
BUILDSELECTOVERRIDE(SUCH,YHTML,YN,YBBN,REL,PARA,YTEXT,RELF,YMAXSTR,YWIDTH,YTXT)
	;----------------------------------------------------------------------------------
	; Build extra details into a selection control
	; 
	; Returns:
	; 
	; History:
	; 13-Aug-2014	SCR		HEVA-1505: Allow for no PARA
	; 29-Apr-2011	shobby	SR17714.3:	Call to GetCalculatedValue
	; 19-Oct-2010	shobby	SR17565: Call to common ComboToSearch routine.
	; 03-Nov-2009	DWR		SR16983: Added las Parameter, check company parameters to see
	; 							if need to hide primary key realtion.
	; 04-Jul-2007	RPW		SRadhoc: Rewrote in Brace Syntax
	; 05-Dec-2006	JW		SR???: Default max
	; 18-Aug-2006	RPW/JW	SR14604: Make 0 always show a popup
	; 07-Aug-2006	SC		SR14604: Quit if MaxDataItems reached. 
	; 06-Jun-2005	shobby	Passed in YTEXT,RELF,YMAXSTR as parameters. (Code Check)
	; 11-Apr-2005	shobby	Passed in REL and PARA as parameters.
	; 28-Jan-2005	RobertW	Fixed the undefined error, by putting "'s around NR
	; xx-xxx-2004	???		Created
	;----------------------------------------------------------------------------------
	new blnCheck,blnMax,intCounter,intMax,NR,strRelationship
	
	$$$LogR("BUILDSELECTOVERRIDE",SUCH)
	
	set blnMax = $$$NO
	//set intMax = $$$WWW012MaximumNumberOfRecordsOnS($get(^WWW012(0,YM,1)))
	set intMax = $$GetMaxSelectRecords^WWW012()
	
	// Check number of records if have limit and can change Combo to Search.
	//set blnCheck = (intMax'="") && (intMax>=0) && $$$WWW001ComboToSearch($get(^WWW001(0,REL,1)))
	;SR17565 set blnCheck = $$$WWW001ComboToSearch($get(^WWW001(0,REL,1)))
	set blnCheck = $$ComboToSearch^WWWFOR71("",REL) ;SR17565
	
	for {
		set SUCH = $query(@SUCH)
		quit:SUCH=""
		
		if (blnCheck && (($increment(intCounter))>intMax)) {
			set SUCH   = ""
			set blnMax = $$$YES
			
		} else {
			new objFELD 															;SR17714.4
			set NR = $piece(@SUCH,Y,1)
			if PARA="" {
				set strRelationship = "^"_REL_"("""_$$$WWWYM(REL)_""","""_NR_""",1)"	// Use WWWYM
			} else {
				set strRelationship = "^"_REL_"("""_$$$WWWYM(REL)_""","_PARA_","""_NR_""",1)"	// Use WWWYM
			}
			set objFELD=$get(@strRelationship)										;SR17714.4
			set strRelationship = $piece(objFELD,Y,1)								;SR17714.4

			set YHTML(YN) = YHTML(YN)_"<option value="""_$translate(NR,"""")_""""
			if YTEXT=NR set YHTML(YN) = YHTML(YN)_" selected"
			
		 	if $$$WWW122CalcRelationalDataField(YTXT)'="" {							;SR17714.4
				set strRelatio]]><![CDATA[nship=$$GetCalculatedValue^COMGri]]><![CDATA[dEdit31F1(YFORM,YKEY,objFELD,YBBN,YTXT,$translate(NR,""""),YLFN) ;SR17714.4
		 	}																		;SR17714.4
			;SR16983 vvv
			if '$$$WWW122DoNotShowPrimaryKey(YTXT){
				set YHTML(YN) = YHTML(YN)_">"_$extract($$^WWWNBSP($translate(NR,""""))_" - "_strRelationship,1,YWIDTH)_"</option>"
			} else {
				set YHTML(YN) = YHTML(YN)_">"_$extract(strRelationship,1,YWIDTH)_"</option>"
			}
			;SR16983 ^^^
			
			if $length(YHTML(YN))>32600 {        //SR14604
				set YMAXSTR = 1
				set ^WWWDATEN(YM,+$horolog,YUSER,YFORM,"V","REFERENCESELECT",YBBN,YN,1) = YHTML(YN)
				set YN = YN+1
				set YHTML(YN) = ""
			}
		}
		quit:SUCH=""
	}
	quit blnMax
	
	
DATE()
	;-------------------------------------------------------------------------------
	; Show date field        ;DATUMSFELD
	;
	; Params:	nil
	;
	; ByRefs:	nil
	;
	; Returns:	HTML string
	;
	; History:
	; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 27-Sep-2011	shobby	SR17853: Reverted doCancelEvent
	; 26-Jul-2010	shobby	SR17456: Changes as sent by Carlos
	; 12-Jul-2010	FIS		SR17431: use onmousedown rather onlick to overwrite page handler
	; 17-Jun-2010	GRF		SR17375: modified reversion of 14-Apr change
	; 19-May-2010	shobby	SR17253: Add id to the object.
	; 14-Apr-2010	FIS		SR17253: event.keyCode => getEventKeyCode; window.event
	;							=> doCancelEvent
	; 26-Jun-2006	JW		SR12775: Make INPUT transparent to see colour of TD
	;-------------------------------------------------------------------------------
	; keyCode 114	F3	(provide keyboard equivalent to search button)
	;-------------------------------------------------------------------------------
	new YHTML
	
	$$$LogR("DATE","")
	
	;SR17456 SET YHTML = "<input type='text' name='"_YFIELDNAME_"' id='"_YFIELDNAME_"'"_
	set YHTML = "<div style='position: relative; width: 100%;'><input type='text' name='"_YFIELDNAME_"' id='"_YFIELDNAME_"'"_ ;SR17456
				" value='"_YTEXT_"'"_
				" maxlength='10'"_
				" class='INdate'"_
				" style='background-color:transparent;"_
				" height:"_YHEIGHT_"pt;"
	if YVALIGN'=""  set YHTML = YHTML_YVALIGN
	if YPADDING'="" set YHTML = YHTML_YPADDING
	set YHTML = YHTML_" font-family:"_YFONT_"; font-size:"_YFONTSIZE_"pt;"
	set YHTML = YHTML_"'"
	set YHTML = YHTML_YCR_" onKeyDown='"
	
	set YHTML = YHTML_YCR_"   if (window.event.keyCode == 13)  {saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""",""eventkey""); window.event.returnValue = false; window.event.cancelBubble = true;}" ;SR17853
	set YHTML = YHTML_YCR_"   if (window.event.keyCode == 114) {ysaveevent=""calendar""; openCalendar("""_YFIELDNAME_""")        ;window.event.returnValue = false; window.event.cancelBubble = true;}" ;SR17853
	
	set YHTML = YHTML_YCR_"'"
	set YHTML = YHTML_YCR_" onhelp=""javascript: window.event.returnValue = false; window.event.cancelBubble = true;"""  //SR17253 FIS //SR17853
	set YHTML = YHTML_YCR_" onFocus='select();'"
	set YHTML = YHTML_YCR_" onBlur='if (document.activeElement.getAttribute(""id"")!=""td"_YFIELDNAME_""") { saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""",""blur"");};'" 
	set YHTML = YHTML_">"
	
	;Image
	;SR17456 set YHTML = YHTML_YCR_"<img src="""_YGIF_"cal.gif"" style=""z-index: 90000; cursor: pointer;"" width=16 height=16 alt=""Calendar"""
	;set YHTML = YHTML_YCR_"<img src="""_YGIF_"cal.gif"" style=""z-index: 90000; cursor: pointer; position: absolute; right: 0;"" width=16 height=16 alt=""Calendar"""  ;SR17456
	;set YHTML = YHTML_" onmousedown='ysaveevent=""calendar""; openCalendar("""_YFIELDNAME_"""); window.event.returnValue = false; window.event.cancelBubble = true;'"  //use onmousedown rather onclick SR17431 ;SR17853
	;set YHTML = YHTML_" onKeyDown='if (window.event.keyCode == 13) {saveData("""_YFIELDNAME_""",this.value,"""_YTYP_""",""eventkey"");}window.event.returnValue = false; window.event.cancelBubble = true;'></div>"  ;SR17456 ;SR17853
	
	quit YHTML
	
	
TEXT(pblnEvent="",YFIELDNAME,YTXT,PARA,REL,YTEXT,YTYP)
	;-------------------------------------------------------------------------------
	;	NUR TEXTANZEIGE
	; 
	; Called By : BodyFieldCell^COMGridEdit31Body
	;             InnerHTML^COMGridEdit31ExtraFields
	;             ^COMGridEdit31S
	; 
	; FIXME : simple variables YTXT & PARA not altered so why are they called as .ARG?
	; 
	; History:
	; 14-Aug-2013	shobby	CORE-237.2: Improved white-space handling.
	; 07-Jun-2012	PPP		SR18002.1:Add the OnClick event to Typ =File
	; 05-Jun-2012	PPP		SR18002:If Type = File and HideRelationClassID=True do not show file name
	; 26-Apr-2012	shobby	SR18004: whitespace assists in proper sizing of row heights.
	; 14-Nov-2011	shobby	SR17934: onclick event should always exists as it is possible that
	;							the field could become editable even if it is readonly on load.
	; 04-May-2011	shobby	SR17714.4: Need to have YFELD defined to be used later by the calculation
	; 21-Jul-2010	GRF		SR17444: add an id to the text div ("tdY#_#dt")
	; 17-Nov-2009	PPP		SR17029: Cannot have Relation classes with Normal &
	;							Calculated fields together
	; 02-Sep-2009	shobby	SR16511: Pass a value if the ctrl key is held down when clicking
	; 29-Jun-2009	PPP		SR16663: Add the Calculated Relation Display Fields
	; 03-Mar-2007	shobby	SRBR014907: Don't display relationships when field is marked as such.
	; 29-Nov-2007	GM		SRBR014805: Hide relation class ID of a specific class relation
	; 12-Apr-2007	HeberB	BR014432: change coding style
	; 11-Apr-2007	HeberB	BR014432: field ID shown based on WWW012 param
	; 01-Feb-2007	RPW		SR15419: Check if it's a string the browser thinks is null
	; 22-Dec-2006	PO		SR15351: Append to YHTML string
	; 24-Oct-2006	Steve S	SR14915: File Name Display
	; 26-Apr-2005	JW		SR14508: Try to define variables
	; 09-Dec-2005	JW		SR13195: Don't call BEARB function here.
	; 20-Oct-2005	JW		SR11573: Call MadeChange
	;-------------------------------------------------------------------------------
	; 
	; <div class='DIVtxt' id='tdY12_34dt'>YTEXT Value</div>
	; 
	; <div class='DIVtxt' id='tdY12_34dt'>(YTEXT) StrValue
	;    <a><input id="tdY12_34_checkbox" type="checkbox"></a>
	; </div>
	;
	; or similar
	;---------------------------------------
	new YHTML,SUCH,YVOR,NR,YI,strVal

	$$$LogR("TEXT",pblnEvent_"<"_YFIELDNAME_"."_YTYP_"<"_YVALIGN_"<"_YPADDING_"<")
	
	set YVOR  = $$$GRIDYVOR(YFORM)
	
	set YHTML = ""
	;SET YHTML = YHTML_YCR_"<div class='DIVtxt' style="""   ; SR17444
	set YHTML = YHTML_YCR_"<div id='td"_YFIELDNAME_"dt' class='DIVtxt' style="""
	if $$AutoResizeRows^WWW120(YFORM) {
		set YHTML = YHTML_ "white-space:nowrap; " ;SR18004
	} else {
		set YHTML = YHTML_ "white-space:nowrap; " ;SR18004
	}
	if YVALIGN'="" set YHTML = YHTML_YVALIGN
	if YPADDING'="" if $piece(YTXT,Y,2)'=3 if $piece(YTXT,Y,2)'=2 if $piece(YTXT,Y,2)'=11 set YHTML = YHTML_YPADDING
	;SET YHTML=YHTML_" font-family:"_YFONT_"; font-size:"_YFONTSIZE_"pt; font-weight:normal; border:none; width:100%"
	
	if $piece(YTXT,Y,23)'=5 if +$get(pblnEvent) set YHTML = YHTML_" width:100%;"
	
	set YHTML = YHTML_""">"
	; changed coding style 
	if ($piece(YTXT,Y,2)'=3) && ($piece(YTXT,Y,2)'=2) && ($piece(YTXT,Y,2)'=11) && (YTEXT'="") {
		if REL="" { 
			//SR18002: If Type = File and HideRelationClassID=True
			if '((YTYP=10) && $$HideRelationClassIDs^WWW122HideRelation(YFORM,YBBN)) {
				set YHTML = YHTML_YTEXT
			}
		} else {
			if (PARA'="") && '$find(PARA,"$") && '$$DefineKeys^WWWFieldValidation(YFORM,PARA,YKEY,YFELD) {
				set YHTML = YHTML_YTEXT
			
			} else {
				set SUCH = "^"_REL_"("""_$$$WWWYM(REL)_""""
				if (PARA'="") {
					set SUCH = SUCH_","_PARA
				}
				set SUCH = SUCH_","""_$translate(YTEXT,"""")_""",1)"
				
				if ($data(@SUCH)#2'=1) { 
					set YHTML = YHTML_YTEXT
				
				} else {    ; Calculated Fields
					if $get(RELCF) {
						new YFELD																	;SR17714.4
						set YFELD=@SUCH																;SR17714.4
						set strVal = $$GetCalculatedValue^WWWFOR71(REL,RELCF,PARA_","_YTEXT,YFELD)	;SR17714.4
						if $$HideRelationClassIDs^WWW122HideRelation(YFORM,YBBN) { 
							set YHTML = YHTML_strVal
						} else {
							set YHTML = YHTML_"("_YTEXT_") "_strVal ;CORE-237.2
						}
						set RELF = 0
					}
					
					if RELF {
						if $piece(@SUCH,Y,RELF)="" {
							set YHTML = YHTML_YTEXT
						
						} else {
							if ($$HideRelationClassIDs^WWW122HideRelation(YFORM,YBBN)) {
								set YHTML = YHTML_$piece(@SUCH,Y,RELF)
							
							} elseif $$$WWW122RelationDisplayOptions(YTXT)=2 {
								set YHTML = YTEXT
							
							} else {
								set YHTML = YHTML_"("_YTEXT_") "_$piece(@SUCH,Y,RELF) ;CORE-237.2
							}
						}
					}
				}
			}
		}
	}

	; FIXME : set blnReadOnly once from YVOR/YENABLED <GRF>
	if $piece(YTXT,Y,2)=3 {                                ;CHECKBOX INAKTIV
		if ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) || 'YENABLED {
			set YHTML = YHTML_"<a>" ; allow selection of an unselectable checkbox
		}
		
		set YHTML = YHTML_"<input id=""td"_YFIELDNAME_"_checkbox"" type=""checkbox"" name="""_YFIELDNAME_""" value="""""
		if +YTEXT=1 set YHTML = YHTML_" checked"
		
		;SR17934 vvvvvv
		;SR17934 if ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) || 'YENABLED {
		;SR17934 	set YHTML = YHTML_" disabled readonly unselectable></a>"
		;SR17934 } else {   ; MSIE uses default value when moving checkboxes around - so add this.defaultchecked.
		;SR17934 	set YHTML = YHTML_" onclick="" this.defaultChecked = this.checked; retval=EventValue('"_YUCI_"','"_YUSER_"','"_YFORM_"','FIX','COMGridEdit31S','CLICK','6','"_YFIELDNAME_";'+event.shiftKey+';;'+event.ctrlKey); "">"  ;16511
		;SR17934 }
		
		if ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) || 'YENABLED {
		 	set YHTML = YHTML_" disabled readonly unselectable "
		}
		set YHTML = YHTML_" onclick="" if (this.disabled!=true) {this.defaultChecked = this.checked; retval=EventValue('"_YUCI_"','"_YUSER_"','"_YFORM_"','FIX','COMGridEdit31S','CLICK','6','"_YFIELDNAME_";'+event.shiftKey+';;'+event.ctrlKey); }"">"  ;16511
		if ($$$WWW120AuthorizationToModifyData(YVOR)=$$$EnumReadOnly) || 'YENABLED {
			set YHTML = YHTML_"</A>"
		}
		;SR17934 ^^^^^^
	}
	
	if ($piece(YTXT,Y,2)=2) || ($piece(YTXT,Y,2)=11) do  ;RADIO-BUTTON INAKTIV
	. set SUCH = "^"_REL_"("""_$$$WWWYM(REL)_""""  ;ZUSAMMENBAU DER GLOBALREFERENZ
	. if PARA'="" set SUCH = SUCH_","_PARA
	. set SUCH = SUCH_")"
	. ;
	. for  do  quit:SUCH=""
	. . set SUCH = $query(@SUCH)
	. . if $piece($piece(SUCH,"^",2),"(",1)'=REL           set SUCH = "" quit
	. . if $piece($piece(SUCH,"(",2),",",1)'=$$$WWWYM(REL) set SUCH = "" quit
	. . if PARA'="" for YI=2:1:1+$length(PARA,",") do  quit:SUCH=""
	. . . if $find($piece(PARA,",",YI-1),"""")  if $piece(SUCH,",",YI)'=$piece(PARA,",",YI-1) set SUCH = ""
	. . . if '$find($piece(PARA,",",YI-1),"""") if $translate($piece(SUCH,",",YI),"""")'=$translate(@$piece(PARA,",",YI-1),"""") set SUCH = ""
	. . ;
	. . quit:SUCH=""
	. . if PARA'="" set NR = $piece(SUCH,",",2+$length(PARA,","))
	. . if PARA=""  set NR = $piece(SUCH,",",2)
	. . set YHTML = YHTML_"<input type=""radio"" name="""_YFIELDNAME_""" value="""""
	. . if YTEXT=NR set YHTML = YHTML_" checked"
	. . set YHTML=YHTML_" disabled unselectable readonly>"
	. . if (($get(YDAT)'="") && ($piece(YDAT,Y,7)=1)) || ($piece(YTXT,Y,62)=1) set YHTML = YHTML_$piece(@SUCH,Y,+RELF) quit
	. . set YHTML=YHTML_$$^WWWNBSP($translate(NR,"""")_" ("_$piece(@SUCH,Y,+RELF))_")"
	
	if $translate(YTEXT," ")="" set YHTML = YHTML_"&nbsp;"
	if (YTYP=10) {      ; File Name
		//SR18002.1
		//set YHTML="<a><img src="""_YGIF_YTEXT_""" align='center'></a>"_YHTML
		set YHTML = "<div align=center><a><img style='vertical-align:middle; height:18px;' src="""_YGIF_YTEXT_""" align='center' onclick=""retval=EventValue('"_YUCI_"','"_YUSER_"','"_YFORM_"','FIX','COMGridEdit31S','CLICK','6','"_YFIELDNAME_";'+event.shiftKey+';;'+event.ctrlKey+';1');""></a>" ;_YHTML ;HEVA-694
	}
	
	set YHTML = YHTML_YCR_"</div>"
	quit YHTML
	
	
MiniText(pREL,pPARA,pYTEXT,&pSUCH,pRELF,pYTXT="",pRELCF,pblnHideRelationClassIDs=$$$NO) ;SR18063
	;-------------------------------------------------------------------------------
	; Return the translated cell based on a relationship.
	;
	; Called By: ClassTranslate^COMGridEdit31F   (REL,PARA,YTEXT,.SUCH,RELF,""  ,RELCF)
	;            GetRelation^COMGridEdit31Excel  (REL,PARA,YTEXT,.SUCH,RELF,""  ,RELCF)
	;            ScreenTranslate^COMGridEdit31S  (REL,PARA,YTEXT,.SUCH,RELF,YTXT,RELCF)
	; 
	; Inputs:
	;	pREL		
	;	pPARA		
	;	pYTEXT		
	;	pSUCH		
	;	pRELF		
	;	pYTXT		objWWW122 (as modified by WWW122D?)
	;	pRELCF		Calculated Field #
	; 
	; Returns: pYTEXT  or  (pYTEXT) strRelationValue  or  strRelationValue
	;
	; History:
	; 20-Jul-2012	shobby	SR18063: Additional parameter to only return the relation part.
	; 05-Jul-2011	shobby	SR17815: Calculated relation not being calculated correctly.
	; 24-Jan-2011	GRF		-:& on arg
	; 29-Jun-2009	PPP		SR16663: Add the Calculated Relation Display Fields (added RELCF)
	; 28-Feb-2008	shobby	SRBR014894:	pYTXT parameter.
	; ??-???-????	???		SR14606: ????
	; 18-Aug-2005	RPW		SR11983: pPARA doesn't need to be tested.
	; 23-Jun-2005	JW		If there is no relation - quit with original text
	; 31-Jan-2005	shobby	Passed parameters into MiniText
	; 18-Jan-2005	RobertW	Created (10061)
	;-------------------------------------------------------------------------------
	new strVal,YHTML
	
	$$$LogR("MiniText",pREL)
	
	if (pREL="") || (pYTEXT="") || (pPARA'="" && '$$DefineKeys^WWWFieldValidation(YFORM,pPARA)) {
		set YHTML = pYTEXT
	
	} else {
		set pSUCH = "^"_pREL_"("""_$$$WWWYM(pREL)_""""  ; ZUSAMMENBAU DER GLOBALREFERENZ
		if pPARA'="" {
			set pSUCH = pSUCH_","_pPARA
		}
		
		; FIXME : If pYTEXT contains an individual parameter that is a string longer than around
		;         255 characters, or multiple parameters with a total length over 500 characters,
		;         or contains a variable name/names that will be converted to such a string/strings
		;         in the @pSUCH commands below, we will end up with a <SUBSCRIPT> error.                <GRF>
		
		set pSUCH = pSUCH_","""_$translate(pYTEXT,"""")_""",1)"
		
		if $data(@pSUCH)#2'=1 {
			set YHTML = pYTEXT
			
		} else {
			if $get(pRELCF) {   ; only applies date formatting unless functions explicitly specify
				set strVal = $$GetCalculatedValue^WWWFOR71(pREL,pRELCF,pPARA_","_pYTEXT,@SUCH)
				;SR17815 if $$$WWW122HideRelationClassIDs(pYTXT) {
				if pblnHideRelationClassIDs||$$HideRelationClassIDs^WWW122HideRelation(YFORM,YBBN) { ;SR17815 ;SR18063
					set YHTML = strVal
				
				} else {
					;set YHTML = "("_strVal_")&nbsp;"        ;SR17815
					set YHTML = "("_pYTEXT_")&nbsp;"_strVal  ;SR17815
				}
			}
			
			if pRELF'=0 {
				if $piece(@pSUCH,Y,pRELF)="" {
					set YHTML = pYTEXT
				
				} else {
					set YHTML = ""
					if '$$$WWW122HideRelationClassIDs(pYTXT)&&'pblnHideRelationClassIDs set YHTML = "("_pYTEXT_")&nbsp;" ;SR18063
					set YHTML = YHTML_$piece(@pSUCH,Y,pRELF)
				}
			}
		}
	}
	if YHTML="" set YHTML = "&nbsp;"
	quit YHTML
	
	
ClassTranslate(pstrValue,pintClassCol,pstrClassName)
	;-------------------------------------------------------------------------------
	; translates the text for the specified item of data into its relationship
	;
	; Returns:
	;
	; History:
	; 29-Jun-2009	PPP		SR16663: Add the Calculated Relation Display Fields (added RELCF)
	; 31-Jan-2005	shobby	Passed parameters into MiniText
	; 19-Jan-2005	Shobby	SR10061: Created
	;-------------------------------------------------------------------------------
	new strDisplay,YTYP,YDAT,REL,PARA,RELF,YLENGTH,YTEXT,YHTML,RELCF
	
	$$$LogR("ClassTranslate",pstrValue_"<"_$get(pstrClassName)_"<"_YFORM)
	
	set strDisplay = ""
	if $get(pstrValue)'="" {
		if $get(pstrClassName)="" set pstrClassName = $$$GRIDClass(YFORM)
		
		set YDAT    = $get(^WWW003(0,pstrClassName,pintClassCol,1))
		set YTYP    = $piece(YDAT,Y,3)
		set REL     = $piece(YDAT,Y,8)    ;RELATIONSDATEI (PARAMETER)
		set PARA    = $piece(YDAT,Y,9)    ;KEY FÜR RELATIONSDATEI (Z.B. SPRACHE)
		set RELF    = $piece(YDAT,Y,10)   ;ANZUZEIGENDES FELD AUS RELATIONSDATEI
		set YLENGTH = $piece(YDAT,Y,4)    ;ERFASSUNGSFELDLÄNGE
		set YTEXT   = pstrValue
		set YHTML   = ""
		set RELCF   = $$$WWW003CalcRelationalDisplayItems(YDAT)   ;DisplayFields
		
		; WARNING : See MiniText for potential problem with long relation strings.
		
		set strDisplay = $$MiniText(REL,PARA,YTEXT,.SUCH,RELF,"",RELCF)
	}
	quit strDisplay]]></Routine>
</Export>