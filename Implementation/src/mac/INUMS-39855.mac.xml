<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INUMS" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INUMS(DATUM1,DATUM2,KATEGORIE1,KEY,ART,EINHEIT,BETRIEB,WARENGRUPPE,VKEK,SUBSELECT,SUBFROM,SUBTO,ADJUST,SAVE)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		AUFBEREITEN GESAMTUMSATZ
	;
	; Inputs : 
	;	DATUM1      = VON DATUM (FROM DATE)  IF="" : FROM THE BEGINNING OF THE YEAR  ($H FORMAT)
	;	DATUM2      = BIS DATUM (UNTIL DATE) IF="" : UNTIL TODAY                     ($H FORMAT)
	;
	;	KATEGORIE (CATEGORIE): ;category 
	;	  0 ODER 00 =MONATE KUNDE / STANDARD  (MONTHS CUSTOMER / DEFAULT ;Or customer 
	;	  1 ODER 10 =MONATE LIEFERANT         (MONTHS SUPLLIER) ;Or supplier 
	;	  2 ODER 20 =MONATE ARTIKEL           (MONTHS ITEM)   ;Or item 
	;	  3 ODER 30 =MONATE WARENGRUPPEN      (MONTHS ITEMGROUP) ;Or 
	;	  4 ODER 40 =MONATE VERKÄUFER         (MONTHS SALESMAN) ;Or salesman 
	;	  5         =PROJEKTUMSATZ            (PROJECT)               ;BEC;23997;22.07.03;PROJEKTUMSATZ IN DIE INUMS EINGEBAUT
	;
	;	  01 =WARENGRUPPE KUNDE               (ITEMGROUP CUSTOMER) ;customer 
	;	  11 =WARENGRUPPE LIEFERANT           (ITEMGROUP SUPPLIER) ;supplier 
	;	  21 =WARENGRUPPE ARTIKEL             (ITEMGROUP ITEM) ;item 
	;	  41 =WARENGRUPPE ARTIKEL             (ITEMGROUP ITEM) ;item 
	;
	;	  09 =GESAMT KUNDE                    (SUMMERY CUSTOMER) ;customer 
	;	  19 =GESAMT LIEFERANT                (SUMMERY SUPPLIER) ;supplier 
	;	  29 =GESAMT ARTIKEL                  (SUMMERY ITEM) ;item 
	;	  39 =GESAMT WARENGRUPPEN             (SUMMERY ITEMGROUP)
	;	  49 =GESAMT VERKÄUFER                (SUMMERY SALESMAN) ;salesman 
	;
	;	KEY         = KUNDE ODER LIEFERANT ODER ARTIKEL;  WENN "", DANN =ALLES
	;				  (CUSTOMER OR SUPPLIER OR ITEM    IF =""  ALL)
	;
	;	ART         = UMSATZART = UMSATZ 0=NACH AUFTRÄGEN 1=NACH RECHNUNGSDRUCK ;Type volume of trade 
	;                 MENGE  2=NACH AUFTRÄGEN 3=NACH RECHNUNGSDRUCK ;quantity 
	;				  (KIND OF STATISTIC: SALES : 0= DEPENDING ON ORDERS 1= DEPENDING ON INVOICE PRINT   
	;                       QUANTITY : 2= DEPENDING ON ORDERS 3= DEPENDING ON INVOICE PRINT)   
	;	EINHEIT     = 1000=IN TAUSEND 1=GESAMT ;unit thousand 
	;				  (UNIT =1000 / PER TAUSEND 1=TOTAL ;thousand 
	;	BETRIEB     = BETRIEBSNUMMER INNERHALBDES MANDANTEN
	;				  (LOCATION INSIDE THE COMPANY)
	;	WARENGRUPPE = LISTE DER WARENGRUPPEN, DIE AUSGEWERTET WERDEN SOLLEN
	;				  (ITEM GROUP LIST, FOR THE STATISTICS) 
	;	VKEK        = EK = 1 ODER VK = 0   ;Or Sale 
	;				  (=1  PURCHASE PRICE    =0  SALESPRICE)  
	;	SUBSELECT   =  ""=KEINE 1=ARTIKEL 2=WARENGRUPPEN 3=LIEFERANTEN 4=KUNDEN
	;				  (SUBSELECTION OR SUBGROUP: "" WITHOUT,  1=ITEM,2= ITEMGROUP,3=SUPPLIER,4=CUSTOMER
	;	SUBFROM     = WENN SUBSELECT DANN SELECTION AB  ;ODER SUBFROM= N;N;N;N; DANN $FIND
	;				  (SUB FROM: SUBSELECTION FORM  E.G. 1244 OR N;N; (SEPERATED BY ";")
	;	SUBTO       = SELECTION BIS ;WENN SUBFROM = N;N;N; DANN IST SUBTO=BLANK
	;				  (SUB TO: SUBSELCTION TO  IF  SUBFROM = N;N;N LEAVE SUBTO BLANC OR ""
	;	ADJUST      = CALCULATE INCL. SALES ADJUSTMENTS
	;	SAVE        = SAVE DATA IN INUMSA (NEEDS SPECIAL CONDITIONS !) ;within 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;   UMSATZ
	;	SALES   :  JAN,FEB,MAR,.. OR ITEMGROUP1,ITEMGROUP1,ITEMGROUP1
	;   QUANTITY:  JAN,FEB,MAR,.. OR ITEMGROUP1,ITEMGROUP1,ITEMGROUP1
	;
	; History :
	; 07-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1
	; 26-Sep-2006	GRF		Doco; !=>||
	; 30-May-2006	GRF		Doco; !=>||; naked references
	; 17.01.2005	FIS		27153
	; 22.07.2003	BEC		23997
	; 24,06,2003	TYBD	23812
	; 02,04,2003	TYBD
	; 09.08.2002	FAN
	; 10.07.2000	DT		Created
	;-------------------------------------------------------------------------------
	NEW POS,DATUM,AUF,SORTFOLGE,SORT,YI,POS1,MONUMS,MONMEN,UMSATZ,TOTAL,OLD,MENGE
	
	
	SET UMSATZ=""  ;RÜCKGABE UMSATZ IN "JAN,FEB,MAR,..." oder in "WG1,WG2,WG3,...."
	SET MENGE=""   ;RÜCKGABE MENGE  IN "JAN,FEB,MAR,..." oder in "WG1,WG2,WG3,...."
	
	SET EINHEIT=+$GET(EINHEIT)  ;1000=UMSATZ IN TAUSEND ;within thousand 
	IF EINHEIT=0 SET EINHEIT=1
	
	SET WARENGRUPPE=$TRANSLATE($GET(WARENGRUPPE),";",",")  ;WARENGRUPPE
	IF WARENGRUPPE'="" SET WARENGRUPPE=","_WARENGRUPPE_","
	
	SET ART     = +$GET(ART)  ;UMSATZART
	SET VKEK    = +$GET(VKEK) ;UMSATZ EK ODER VK ;volume of trade Planned Cost Or Sale 
	SET BETRIEB = $TRANSLATE($GET(BETRIEB),";",",") ;UMSATZART
	
	SET DATUM1=$GET(DATUM1)
	;F DATUM1="" SET DATUM1 = $$^WWWDATE1("01.01."_$$^WWWYEAR($HOROLOG))  ;VON DATUM ;Date 
	IF DATUM1="" SET DATUM1 = $$DMY^WWWDATE1("01.01."_$$^WWWYEAR($HOROLOG))  ;VON DATUM ;Date 
	
	SET DATUM2=$GET(DATUM2)
	IF DATUM2="" SET DATUM2=+$HOROLOG
	
	SET TOTAL=""
	SET KATEGORIE1 = $GET(KATEGORIE1)         ;ART DER RÜCKGABE ;Type the 
	SET KATEGORIE  = $EXTRACT(KATEGORIE1)     ;0=KUNDE,1=LIEF;2=ART;3=WARENGRUPPE
	SET SORT       = +$EXTRACT(KATEGORIE1,2)  ;0=MONATE 1=WARENGRUPPEN 9=GESAMT
	IF SORT=9 SET SORT=0 SET TOTAL=1          ;WIRD SPÄTER ZUSAMMENADDIERT ;subsequent 
	
	SET SUBSELECT = $GET(SUBSELECT)  ;= KEINE 1=ARTIKEL 2=WARENGRUPPEN 3=LIEFERANTEN 4=KUNDEN ;no 
	SET SUBFROM   = $GET(SUBFROM)
	SET SUBTO     = $GET(SUBTO)
	SET KEY       = $GET(KEY)
	SET ADJUST    = $GET(ADJUST)  ;CALCULATION OF ADJUSTMENTS
	SET SAVE      =+$GET(SAVE)    ;SAVE IN TEMP FILE ;within 
	
	DO UMSATZ^INUMSBIT  ;FIS;17.01.2005;27153
	
	IF ADJUST=1 IF KATEGORIE=2 IF SORT=0 IF ART>2 IF KEY'="" IF SAVE'=1 DO  ;NUR FÜR ARTIKELMENGEN ;only to 
	. NEW JAHR,MON,LOC
	. SET JAHR=$$^WWWYEAR(DATUM1)
	. SET LOC=""
	. FOR  SET LOC=$ORDER(^INSALESADJUST(YM,LOC)) QUIT:LOC=""  DO
	. . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_LOC_",")   ;FALSCHER BETRIEB ;location 
	. . FOR MON=1:1:12 DO
	. . . SET ADJMEN=+$PIECE($GET(^INSALESADJUST(YM,LOC,KEY,JAHR,MON,1)),Y,1)  ;(+/-) SALES ADJUSTMENTS
	. . . IF ADJMEN'=0 SET $PIECE(MENGE,",",MON)=$PIECE(MENGE,",",MON)+ADJMEN
	
	IF TOTAL=1 DO                 ;GESAMTSUMME ;total amount
	. NEW MENGE1,UMSATZ1
	. SET (MENGE1,UMSATZ1)=0
	. IF ART>1 DO  QUIT
	. . FOR YI=1:1 QUIT:$PIECE(MENGE,",",YI,99)=""  SET MENGE1=MENGE1+$PIECE(MENGE,",",YI)
	. . SET MENGE=MENGE1
	. . IF MENGE<0 SET MENGE=0
	. ;
	. FOR YI=1:1 QUIT:$PIECE(UMSATZ,",",YI,99)=""  SET UMSATZ=UMSATZ+$PIECE(UMSATZ,",",YI)
	. SET UMSATZ=UMSATZ1
	. . IF UMSATZ<0 SET UMSATZ=0
	
	IF EINHEIT'=1 DO
	. IF ART>1 FOR YI=1:1 QUIT:$PIECE(MENGE,",",YI,99)=""  SET $PIECE(MENGE,",",YI)=$JUSTIFY($PIECE(MENGE,",",YI),0,0) QUIT
	. FOR YI=1:1 QUIT:$PIECE(UMSATZ,",",YI,99)=""  SET $PIECE(UMSATZ,",",YI)=$JUSTIFY($PIECE(UMSATZ,",",YI),0,0)
	
	IF ART>1 QUIT MENGE  ;RÜCKGABE DER MENGE ;the quantity 
	QUIT UMSATZ
	
UMSATZ ;ERRECHNEN UMSATZ ;volume of trade 
	;-------------------------------------------------------------------------------
	;  Possibly obsolete - see call to UMSATZ^INUMSBIT above
	;-------------------------------------------------------------------------------
	
	;+++++++++++++++++++++++++++++++++++++++
	; POS1			objINAUFP
	;+++++++++++++++++++++++++++++++++++++++
	
	IF KEY="" DO  QUIT  ;ALLES ;whatsoever 
	. NEW SKEY
	. SET SKEY=2                         ;SORTKEY 2 = AUFTRAGSDATUM;;TYBD;21.08.2003;24173
	. IF (ART=1) || (ART=3) SET SKEY=12  ;SORTKEY 12=RECHNUNG GEDRUCK AM ;to the 
	. SET DATUM=DATUM1-1
	. FOR  SET DATUM=$ORDER(^INAUFs(YM,SKEY,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF (DATUM1=DATUM) || (DATUM>DATUM1) DO
	. . SET AUF=""
	. . FOR  SET AUF=$ORDER(^INAUFs(YM,SKEY,DATUM,AUF)) QUIT:AUF=""  DO
	. . . IF KATEGORIE'=1 IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0  IF +$PIECE(^INAUF(YM,AUF,1),Y,2)'=3 QUIT   ;KEIN KUNDENAUFTRAG;TYBD;23812;24,06,2003
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")    ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFP(YM,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:POS1=""
	. . . . QUIT:$PIECE(POS1,Y,9)=1  ;STORNIERT;TYBD;02,04,2003;
	. . . . ;
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF ART=1!(ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))  ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . IF KATEGORIE=1 QUIT:$PIECE(POS1,Y,7)'=1                    ;KEINE BESTELLUNG ;no sales order 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE ;Not 
	. . . . IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""                        ;NOCH KEINE RECHNUNG ;yet no tab 
	. . . . IF VKEK=0 SET MONUMS=MONUMS+($PIECE(POS1,Y,123)/EINHEIT)  ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . IF VKEK=1 SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)   ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)              ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	. . . . ;SPEICHERN AUFBEREITUNG FÜR REPLENISHMENT ;Save to 
	. . . . IF SAVE=1 DO
	. . . . . NEW LOCAT,ITEM,YEAR,MONTH,ADJMEN,QTY
	. . . . . SET LOCAT=$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)
	. . . . . IF LOCAT="" SET LOCAT=" "
	. . . . . SET ITEM=$PIECE(POS1,Y,4)
	. . . . . IF ITEM="" QUIT
	. . . . . SET YEAR=$$^WWWYEAR(DATUM)
	. . . . . SET MONTH=$$^WWWMONTH(DATUM)
	. . . . . SET QTY=$PIECE($GET(^INUMSA(YM,+$HOROLOG,YUSER,LOCAT,ITEM,YEAR,MONTH,1)),Y,1)
	. . . . . SET QTY=QTY+$PIECE(POS1,Y,5)
	. . . . . SET ^INUMSA(YM,+$HOROLOG,YUSER,LOCAT,ITEM,YEAR,MONTH,1)=QTY
	. . . . . SET ^INUMSA(YM,+$HOROLOG,YUSER," "," ",YEAR,MONTH,1)=1         ;SAVE AS CALCULATED
	
	IF +KATEGORIE=0 IF KEY'="" DO  QUIT  ;UMSATZ EINES KUNDEN ;volume of trade 
	. NEW SKEY,KEY1
	. SET SKEY=1                         ;SORTKEY 1 = AUFTRAGSDATUM;;TYBD;21.08.2003;24173
	. IF (ART=1) || (ART=3) SET SKEY=21  ;SORTKEY 21=RECHNUNG GEDRUCK AM ;to the 
	. SET DATUM=DATUM1-1
	. SET KEY1=$$^WWWUMLAU(KEY,1) ;TYBD;7,12,2003
	. FOR  SET DATUM=$ORDER(^INAUFs(YM,SKEY,KEY1,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF DATUM1=DATUM!(DATUM>DATUM1) DO
	. . FOR ABGESCH=" ",1,0 SET AUF="" FOR  SET AUF=$ORDER(^INAUFs(YM,SKEY,KEY1,DATUM,ABGESCH,AUF)) QUIT:AUF=""  DO
	. . . ;QUIT:+$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0   ;KEIN KUNDENAUFTRAG
	. . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0  IF +$PIECE(^INAUF(YM,AUF,1),Y,2)'=3 QUIT   ;KEIN KUNDENAUFTRAG;TYBD;23812;24,06,2003
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")   ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFP(YM,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:$PIECE(POS1,Y,9)=1  ;STORNIERT;TYBD;02,04,2003;
	. . . . IF SUBSELECT'="" DO      ;SUBSELECT VORHANDEN ;on hand 
	. . . . . IF SUBSELECT=1 DO      ;ARTIKEL ;item 
	. . . . . . IF $GET(SUBFROM)'="" IF $GET(SUBFROM)]]$PIECE(POS1,Y,4) SET POS1="" QUIT
	. . . . . . IF $GET(SUBTO)'=""   IF $PIECE(POS1,Y,4)]]$GET(SUBTO)   SET POS1="" QUIT
	. . . . ;
	. . . . QUIT:POS1=""
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF (ART=1) || (ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))   ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE ;Not 
	. . . . IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""                        ;NOCH KEINE RECHNUNG ;yet no tab 
	. . . . IF VKEK=0 SET MONUMS=MONUMS+($PIECE(POS1,Y,123)/EINHEIT)  ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . IF VKEK=1 SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)   ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)              ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	
	
	/*vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF KATEGORIE=1 IF KEY'="" IF ART=1 IF SORT=0 DO  QUIT  ;UMSATZ EINES LIEFERANTEN NACH RECHNUNGEN;FIS;24242;08.09.03
	. ;SET DATUM=DATUM1-1 ;table-mat 
	. NEW DAT,RE,RSATZ
	. SET DATUM=$ORDER(^INERECHs(YM,4,$$^WWWUMLAU(DATUM1,1)),-1)
	. IF KEY="" SET KEY=" " QUIT  ;WENN KEIN LIEFERANT ;when no supplier 
	. FOR  SET DATUM=$ORDER(^INERECHs(YM,4,DATUM)) QUIT:DATUM=""  QUIT:DATUM]]$$^WWWUMLAU(DATUM2,1)  DO  ;IF DATUM=$$^WWWUMLAU(DATUM1,1)!(DATUM]]$$^WWWUMLAU(DATUM1,1)) DO
	. . SET RE=""
	. . FOR  SET RE=$ORDER(^INERECHs(YM,4,DATUM,KEY,RE)) QUIT:RE=""  DO
	. . . SET DAT=""
	. . . FOR  SET DAT=$ORDER(^INERECHs(YM,4,DATUM,KEY,RE,DAT)) QUIT:DAT=""  DO
	. . . . SET RSATZ=$GET(^INERECH(YM,KEY,RE,DAT,1))  ;RECHNUNGSSATZ
	. . . . QUIT:RSATZ=""
	. . . . QUIT:$PIECE(RSATZ,Y,121)'=1  ;NOCH NICHT IN FIBU ÜBERTRAGEN ;yet Not within transport 
	. . . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE(RSATZ,Y,22)_",")   ;FALSCHER BETRIEB ;location 
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DAT)   ;NACH MONATEN ;within 
	. . . . ;IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . ;IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE
	. . . . ;IF (ART=1) || (ART=3) QUIT:'$DATA(^INERECH1(YM,AUF,POS,KEY))  ;NOCH KEINE EINGANGSRECHNUNG
	. . . . SET MONUMS=MONUMS+($PIECE(RSATZ,Y,4)/EINHEIT)  ;UMSATZ NETTO ;volume of trade 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . ;SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)  ;MENGE
	. . . . ;SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END */
	
	IF KATEGORIE=1 IF KEY'="" DO  QUIT  ;UMSATZ EINES LIEFERANTEN nach aufträgen ;volume of trade within 
	. NEW KEY1
	. SET KEY1=$$^WWWUMLAU(KEY,1)  ;TYBD;7,12,2003
	. SET DATUM=DATUM1-1
	. IF KEY="" SET KEY=" " QUIT  ;WENN KEIN LIEFERANT ;when no supplier 
	. FOR  SET DATUM=$ORDER(^INAUFPs(YM,13,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF DATUM1=DATUM!(DATUM>DATUM1) DO
	. . SET AUF=""
	. . FOR  SET AUF=$ORDER(^INAUFPs(YM,13,DATUM,KEY1,AUF)) QUIT:AUF=""  DO
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")   ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFPs(YM,13,DATUM,KEY1,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:POS1=""
	. . . . QUIT:$PIECE(POS1,Y,9)=1  ;STORNIERT;TYBD;02,04,2003;
	. . . . IF SUBSELECT'="" DO      ;SUBSELECT VORHANDEN ;on hand  ;ARTIKELNUMMER;09.12.2004;FAN;26826 
	. . . . . IF SUBSELECT=1 DO      ;ARTIKEL ;item 
	. . . . . . IF $GET(SUBFROM)'="" IF $GET(SUBFROM)]]$PIECE(POS1,Y,4) SET POS1="" QUIT
	. . . . . . IF $GET(SUBTO)'=""   IF $PIECE(POS1,Y,4)]]$GET(SUBTO)   SET POS1="" QUIT
	. . . . ;
	. . . . QUIT:POS1=""
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF ART=1!(ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))   ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . QUIT:$PIECE(POS1,Y,7)'=1       ;KEINE BESTELLUNG KEIN UMSATZ ;no sales order no volume of trade 
	. . . . QUIT:+$PIECE(POS1,Y,12)'=+KEY  ;FALSCHER LIEFERANT  ;supplier 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE ;Not 
	. . . .;IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""                        ;NOCH KEINE RECHNUNG
	. . . . IF (ART=1) || (ART=3) QUIT:'$DATA(^INERECH1(YM,AUF,POS,KEY))  ;NOCH KEINE EINGANGSRECHNUNG     FAN 09.08.02 ;yet no buff 
	. . . . SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)                 ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)                  ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	
	IF KATEGORIE=2 IF KEY'="" DO  QUIT  ;UMSATZ EINES ARTIKELS ;volume of trade 
	. NEW SKEY
	. SET SKEY=6                         ;SORTKEY 6 = AUFTRAGSDATUM;;TYBD;21.08.2003;24173
	. IF (ART=1) || (ART=3) SET SKEY=18  ;SORTKEY 18=RECHNUNG GEDRUCK AM ;to the 
	. SET DATUM=DATUM1-1
	. SET KEY=$$^WWWUMLAU(KEY,1)
	. IF KEY="" SET KEY=" "  ;WENN KEIN ARTIKEL ;when no item 
	. FOR  SET DATUM=$ORDER(^INAUFPs(YM,SKEY,KEY,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF DATUM1=DATUM!(DATUM>DATUM1) DO
	. . SET AUF=""
	. . FOR  SET AUF=$ORDER(^INAUFPs(YM,SKEY,KEY,DATUM,AUF)) QUIT:AUF=""  DO
	. . . ;QUIT:+$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0   ;KEIN KUNDENAUFTRAG;TYBD
	. . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0  IF +$PIECE(^INAUF(YM,AUF,1),Y,2)'=3 QUIT   ;KEIN KUNDENAUFTRAG;TYBD;23812;24,06,2003
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")   ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFPs(YM,SKEY,KEY,DATUM,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:POS1=""
	. . . . QUIT:$PIECE(POS1,Y,9)=1  ;STORNIERT;TYBD;02,04,2003;
	. . . . QUIT:$$^WWWUMLAU($PIECE(POS1,Y,4),1)'=$TRANSLATE(KEY," ")  ;FALSCHER ARTIKEL  ;item 
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF ART=1!(ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))   ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE ;Not 
	. . . . IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""                       ;NOCH KEINE RECHNUNG ;yet no tab 
	. . . . IF VKEK=0 SET MONUMS=MONUMS+($PIECE(POS1,Y,123)/EINHEIT)  ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . IF VKEK=1 SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)   ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)              ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	
	IF KATEGORIE=3 IF KEY'="" DO  QUIT  ;UMSATZ EINER WARENGRUPPE ;volume of trade unit 
	. NEW SKEY
	. SET SKEY=2                              ;SORTKEY 2 = AUFTRAGSDATUM  ;TYBD;21.08.2003;24173
	. IF (ART=1) || (ART=3) SET SKEY=12       ;SORTKEY 12=RECHNUNG GEDRUCK AM ;to the 
	. SET DATUM=DATUM1-1
	. IF KEY="" SET KEY=" "                   ;WENN KEINE WARENGRUPPE ;when no 
	. FOR  SET DATUM=$ORDER(^INAUFs(YM,SKEY,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF DATUM1=DATUM!(DATUM>DATUM1) DO
	. . SET AUF=""
	. . FOR  SET AUF=$ORDER(^INAUFs(YM,SKEY,DATUM,AUF)) QUIT:AUF=""  DO
	. . . ;QUIT:+$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0   ;KEIN KUNDENAUFTRAG
	. . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0  IF +$PIECE(^INAUF(YM,AUF,1),Y,2)'=3 QUIT   ;KEIN KUNDENAUFTRAG;TYBD;23812;24,06,2003
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")   ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFP(YM,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:$PIECE(POS1,Y,9)=1               ;STORNIERT;TYBD;02,04,2003;
	. . . . IF SUBSELECT'="" DO                   ;SUBSELECT VORHANDEN ;on hand 
	. . . . . IF SUBSELECT=4 DO                   ;KUNDE ;customer 
	. . . . . . QUIT:$GET(AUF)=""
	. . . . . . IF $GET(SUBFROM)'="" IF $GET(SUBFROM)]]$PIECE($GET(^INAUF(YM,AUF,1)),Y,1) SET POS1="" QUIT
	. . . . . . IF $GET(SUBTO)'=""   IF $PIECE($GET(^INAUF(YM,AUF,1)),Y,1)]]$GET(SUBTO)   SET POS1="" QUIT
	. . . . ;
	. . . . QUIT:POS1=""
	. . . . QUIT:$PIECE(POS1,Y,30)'=KEY  ;FALSCHE WARENGRUPPE 
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF ART=1!(ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))   ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . ;IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE
	. . . . IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""           ;NOCH KEINE RECHNUNG ;yet no tab 
	. . . . IF VKEK=0 SET MONUMS=MONUMS+($PIECE(POS1,Y,123)/EINHEIT)  ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . IF VKEK=1 SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)   ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)              ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	
	IF KATEGORIE=4 IF KEY'="" DO  QUIT  ;UMSATZ EINES VERKÄUFERS ;volume of trade 
	. NEW SKEY
	. SET SKEY=2                         ;SORTKEY 2 = AUFTRAGSDATUM;;TYBD;21.08.2003;24173
	. IF (ART=1) || (ART=3) SET SKEY=12  ;SORTKEY 12=RECHNUNG GEDRUCK AM ;to the 
	. SET DATUM=DATUM1-1
	. IF KEY="" SET KEY=" "  ;WENN KEIN VERKÄUFER ;when no salesman 
	. FOR  SET DATUM=$ORDER(^INAUFs(YM,SKEY,DATUM)) QUIT:DATUM=""  QUIT:DATUM>DATUM2  IF DATUM1=DATUM!(DATUM>DATUM1) DO
	. . SET AUF=""
	. . FOR  SET AUF=$ORDER(^INAUFs(YM,SKEY,DATUM,AUF)) QUIT:AUF=""  DO
	. . . ;QUIT:+$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0   ;KEIN KUNDENAUFTRAG
	. . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)'=0  IF +$PIECE(^INAUF(YM,AUF,1),Y,2)'=3 QUIT   ;KEIN KUNDENAUFTRAG;TYBD;23812;24,06,2003
	. . . ;QUIT:$PIECE($GET(^INAUF(YM,AUF,1)),Y,30)'=KEY   ;FALSCHER VERKÄUFER
	. . . IF BETRIEB'="" QUIT:'$FIND(","_BETRIEB_",",","_$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)_",")   ;FALSCHER BETRIEB ;location 
	. . . SET POS=""
	. . . FOR  SET POS=$ORDER(^INAUFPs(YM,16,KEY,AUF,POS)) QUIT:POS=""  DO
	. . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . QUIT:POS1=""
	. . . . QUIT:$PIECE(POS1,Y,9)=1  ;STORNIERT;TYBD;02,04,2003;
	. . . . IF SORT=0 SET SORTFOLGE=$$^WWWMONTH(DATUM) IF ART=1!(ART=3) SET SORTFOLGE=$$^WWWMONTH($PIECE(POS1,Y,97))   ;NACH MONATEN ;within 
	. . . . IF SORT=1 SET SORTFOLGE=+$EXTRACT($PIECE(POS1,Y,30),1,2)   ;NACH WARENGRUPPEN ;within 
	. . . . SET MONUMS=$PIECE(UMSATZ,",",SORTFOLGE)
	. . . . SET MONMEN=$PIECE(MENGE,",",SORTFOLGE)
	. . . . IF WARENGRUPPE'="" QUIT:'$FIND(WARENGRUPPE,","_$PIECE(POS1,Y,30)_",")  ;NICHT AUSGEWÄHLTE WARENGRUPPE ;Not 
	. . . . IF (ART=1) || (ART=3) QUIT:$PIECE(POS1,Y,96)=""           ;NOCH KEINE RECHNUNG ;yet no tab 
	. . . . IF VKEK=0 SET MONUMS=MONUMS+($PIECE(POS1,Y,123)/EINHEIT)  ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . IF VKEK=1 SET MONUMS=MONUMS+($PIECE(POS1,Y,47)/EINHEIT)   ;UMSATZ MINUS RABATT ;volume of trade minus deduction 
	. . . . SET $PIECE(UMSATZ,",",SORTFOLGE)=MONUMS
	. . . . SET MONMEN=MONMEN+($PIECE(POS1,Y,5)/EINHEIT)              ;MENGE ;quantity 
	. . . . SET $PIECE(MENGE,",",SORTFOLGE)=MONMEN
	
	QUIT
	
]]></Routine>
</Export>