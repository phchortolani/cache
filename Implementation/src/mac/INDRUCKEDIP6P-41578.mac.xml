<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCKEDIP6P" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRUCKEDIP6P
#include COMSYS
#include INConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		DRUCKEN POSITION EDI
	;	DRUCKEN DER POSITION ;print the 
	;
	; Called By : ^INDRUCKEDI6
	;
	; Inputs : 
	;
	;
	; ByRef :
	;	YAUFTRAG()
	;	POS1		obj???Line (Order, Quote?)
	;	YBELEG1		obj???
	;	YEKK
	;	YFELDPZ		
	;	YKUNDE		Customer?
	;	YLIEFER		Supplier?
	;	
	; Returns :
	;
	;
	; History :
	; 04-Sep-2006	GRF		SR12027: D1=>D8; Naked References; clear unneeded $data;
	; 						quits; !=>||
	; 13-Sep-2005	JW		SR13434: Remember tax code for line
	; 29-Jul-2005	JW		SR12992: Use COMTAX
	; 19.06.2002	DT
	;
	;-------------------------------------------------------------------------------
	SET BLANKS=0   ;ZUSATZBLANKS WEGEN HTML TAG ;quibble HTML TAG 
	
	; FIXME : Is YAUFTRAG actually an array?  What if there are too many lines in the order? <GRF>
	
	IF POS'=$ORDER(YAUFTRAG("")) IF $PIECE(POS1,Y,105)=1 SET YPAGEBR=1  ;MANUELLER SEITENWECHSEL
	IF +$PIECE(YBELEG1,Y,42)=0 IF +$PIECE(YBELEG1,Y,44)=0 IF +$PIECE(YBELEG1,Y,46)=0 IF +$PIECE(YBELEG1,Y,48)=0 IF +$PIECE(YBELEG1,Y,50)=0 IF +$PIECE(YBELEG1,Y,52)=0 IF +$PIECE(YBELEG1,Y,54)=0 IF +$PIECE(YBELEG1,Y,56)=0 IF +$PIECE(YBELEG1,Y,58)=0 QUIT  ;KEINE POSITIONEN AUSGEGEN ;no 
	
	; SR12992: ------------------ Determine Tax ----------------------
	set MWST = $$INDRUCKTAX^INTAX(YBELEG,POS1,$get(YEKK),$get(YFELDPZ),$get(YKUNDE),$get(YLIEFER),.MWPO)
	SET MWPO(MWPO)=$GET(MWPO(MWPO))
	set MWPO(MWPO,POS) = ""			// SR13434: Remember that this line has code MWPO
 	
 	/*
	DO
	. ;------------------ ERMITTELN STEUERSATZ ---------------------- ;FIS;KORREKTUREN WEGEN STEUERSATZ/STEUERKENNZEICHEN;30.06.04
	. SET MWST=""
	. SET MWPO=$PIECE(POS1,Y,36)  ;POSTIONS MWST-SATZ
	. IF (YBELEG=3) || (YBELEG=10) SET MWPO=$PIECE(YEKK,Y,30)  ;VORSTEUER-SATZ EINKAUF
	. IF YBELEG=12 IF $PIECE($GET(YFELDPZ),Y,21)'="" SET MWPO=$PIECE(YFELDPZ,Y,21)  ;FIS;11.11.03;22349;STEUERSATZ TEILZAHLUNGSRECHNUNG
	. IF MWPO="" IF YBELEG'=3 IF YBELEG'=10   SET MWPO=1   ;DFLT. 1 - 16% MWST ;Tax 
	. IF MWPO="" IF (YBELEG=3) || (YBELEG=10) SET MWPO=11  ;DFLT. 11 - 16% VST
	. DO  ;MWST NACH PLZ USA ;Tax within ZIP 
	. . NEW PLZ
	. . SET PLZ=$PIECE(YADRES,Y,12)
	. . QUIT:PLZ=""
	. . IF $PIECE(^INPLZ(0,PLZ,1),Y,11)'="" SET MWPO=+$PIECE(^INPLZ(0,PLZ,1),Y,11)  ;STEUERSATZ-PARAMETER = STEUERSATZ % ;tax rate 
	. IF $$EXIST^%R("COMTAX.OBJ",$GET(YUCI)) DO  ;MWST NACH USA CITY TAX ;Tax within 
	. . NEW YTAXLOCATION,YTAX
	. . SET YTAXLOCATION=""
	. .;IF $GET(YKUNDE)'="" SET YTAXLOCATION=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,52)
	. . IF $GET(YKUNDE)'="" SET YTAXLOCATION=$PIECE($GET(^INKUNDE(YM,YKUNDE,1)),Y,54)    ;BEC;26384;14.09.04
	. . IF YTAXLOCATION="" IF $GET(YLOCATION)'="" SET YTAXLOCATION=$PIECE($GET(^WWW0121(0,YM,YLOCATION,1)),Y,52)
	. . ;IF $$IsTaxable^COMTAX($PIECE(POS1,Y,4),YTAXLOCATION)=0 QUIT    ;BEC;07.07.03;23656;WENN MWSTFUNKTION VORHANDEN IST
	. . IF $$IsTaxable^COMTAX($PIECE(POS1,Y,36),YTAXLOCATION)=0 QUIT    ;BEC;26384;14.09.04
	. . SET MWPO=$$CombinedTaxRate^COMTAX(1,YTAXLOCATION,+$HOROLOG,$get(YKUNDE)="")  ;COMTAX(TaxCode,TaxLocation,TransactionDate)RETURNS THE COMBINED TAX RATE
	. SET MWST=MWPO
	. IF $PIECE(YADRES,Y,17)'="" IF $PIECE(YADRES,Y,17)'=$GET(YCOUNTRY) SET MWPO=0  ;KEIN DEUTSCHLAND ;no Germany 
	. IF $PIECE(YADRES,Y,50)'="" IF '$FIND($PIECE(YADRES,Y,50),$GET(YCOUNTRY)) SET MWPO=0  ;STEUERID AUSLAND ;foreign country 
	. IF $PIECE(YADRES,Y,54)'="" IF $PIECE(YADRES,Y,54)'=1 SET MWPO=0  ;KEINE STEUER ;no tax 
	. IF $PIECE(YADRES,Y,55)'="" IF $PIECE(YADRES,Y,55)'<$HOROLOG SET MWPO=0  ;KEINE STEUER BIS ZUM ;no tax until 
	. IF $PIECE(YADRES,Y,54)=2 IF $PIECE(YADRES,Y,50)="" SET MWPO=MWST  ;EG OHNE UST-ID = STEUER BERECHNEN ! (PRIVATPERSON);FIS;25.03.04 ;without tax calculate 
	. ;
	. ;IF +MWPO'=0 DO   ;PRUEFEN %SATZ
	. IF +MWPO'=0 IF $DATA(^WWW101(0,"MWST",SPRACHE,MWPO)) DO   ;PRUEFEN %SATZ;FIS;USA KENNZEICHEN NICHT ÃœBERSCHREIBEN;05.05.04
	. . NEW MWST
	. . SET MWST(9)=0  ;ENDE ;termination 
	. . SET MWST(0)=+$PIECE($PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)," ",1)
	. . SET MWST(1)="" FOR  SET MWST(1)=$ORDER(^WWW101(0,"MWST",SPRACHE,MWST(1))) QUIT:MWST(1)=""  QUIT:MWST(1)=MWPO  DO  QUIT:MWST(9)=1
	. . . SET MWST(2)=+$PIECE($PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWST(1),1)),Y,1)," ",1)
	. . . IF +MWST(0)=+MWST(2) SET MWPO=MWST(1) SET MWST(9)=1   ;NEUES MWSTKENNZEICHEN ;something new 
	. SET MWPO(MWPO)=$GET(MWPO(MWPO))
	. SET MWST=+$PIECE($PIECE($GET(^WWW101(0,"MWST",SPRACHE,MWPO,1)),Y,1)," ",1)
	. IF +MWPO'=0 IF '$DATA(^WWW101(0,"MWST",SPRACHE,MWPO,1)) SET MWST=MWPO  ;TYBD;12.6.2003;#23656; UST NACH PLZ EINSETZTEN USA
	. ;
	. SET $PIECE(POS1,Y,36)=MWPO
	. ;IF YBELEG'=12 IF YBELEG'=3 IF YBELEG'=10 SET $PIECE(^INAUFP(YM,YAUFTRAG,POS,1),Y,36)=MWPO  ;SPEICHERN GENUTZTE MWST;FIS;22.03.04;25372;AUSGESCHALTET;19,10,2004;TYBD;26471
	. ;IF YBELEG=12 SET $PIECE(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1),Y,21)=MWPO  ;SPEICHERN GENUTZTE MWST;FIS;22.03.04;25372;AUSGESCHALTET;19,10,2004;TYBD;26471
	. IF (YBELEG=3) || (YBELEG=10) IF $DATA(^INAUFPK(YM,YAUFTRAG,POS)) SET $PIECE(^INAUFPK(YM,YAUFTRAG,POS,1),Y,30)=MWPO  ;SPEICHERN GENUTZTE MWST;FIS;22.03.04;25372
 	*/
 
	DO ;Artikel ;Item
	. DO  ;ANZEIGEN ;give notice  ;display 
	. . SET YA(3)=$PIECE(POS1,Y,4)  ;ART-NR.:XXXXX
	. . NEW QUAL,ME,PREIS,CATALOG
	. . ;
	. . SET QUAL="LIN"
	. . IF YBELEG=3  SET QUAL="PO1"
	. . IF YBELEG=7  SET QUAL="IT1"
	. . IF YBELEG=17 SET QUAL="IT1"
	. . ;
	. . SET PREIS=+$PIECE(POS1,Y,118)
	. . IF (YBELEG=3) || (YBELEG=13) DO   ;BESTELLUNG = EK ;sales order Planned Cost 
	. . . SET PREIS=$PIECE(YEKK,Y,47)     ;SELBSTKOSTEN ;total production costs  ;total production costs whole 
	. . ;
	. . SET ME=""  ;MENGEEINHEIT
	. . DO
	. . . QUIT:$PIECE(POS1,Y,40)=""
	. . . SET ME=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(POS1,Y,40),1)),Y,1)  ;MENGENEINHEIT
	. . ;
	. . SET CATALOG=""
	. . IF YBELEG=3 IF $GET(YLIEFER)'="" IF YA(3)'="" DO
	. . .;SET CATALOG=$PIECE($GET(^INAUFPK(YM,YA(3),YLIEFER,1)),Y,1)     ; 04-Sep-2006
	. . . SET CATALOG=$$$INAUFPKSupplierItemNumber($GET(^INAUFPK(YM,YA(3),YLIEFER,1)))    ; D8
	. . ;
	. . DO EDIP^INDRUCK(QUAL_"*"_$EXTRACT(1000+POS,2,4)_"*"_$PIECE(POS1,Y,5)_"*"_ME_"*"_PREIS_"*PE*UI*"_$PIECE(POS1,Y,2)_"*BP*"_YA(3)_"*VC*"_CATALOG)   ;ARTIKELNUMMER
	. . DO EDIP^INDRUCK("PID*F****"_$PIECE(POS1,Y,1))   ;BESCHREIBUNG ;description 
	. ;
	. ;SERIENNUMMER/LOT-NUMMER  ;FIS, 05.06.2001
	. IF ($PIECE(YBELEG1,Y,176)=1) || ($PIECE(YBELEG1,Y,178)=1) DO  ;SERIENNUMMER/LOTNUMMER DRUCKEN ;print 
	. . NEW BET,LAP,WE,SN,SN1,LOT,LOT1
	. . SET SN1=$PIECE(POS1,Y,56)
	. . SET LOT1=""
	. . IF $DATA(^INWEAUFS(YM,YAUFTRAG,POS)) DO
	. . . SET BET=""
	. . . FOR  SET BET=$ORDER(^INWEAUFS(YM,YAUFTRAG,POS,BET)) QUIT:BET=""  DO
	. . . . SET LAP=""
	. . . . FOR  SET LAP=$ORDER(^INWEAUFS(YM,YAUFTRAG,POS,BET,LAP)) QUIT:LAP=""  DO
	. . . . . SET WE=""
	. . . . . FOR  SET WE=$ORDER(^INWEAUFS(YM,YAUFTRAG,POS,BET,LAP,WE)) QUIT:WE=""  DO
	. . . . . . SET SN=""
	. . . . . . FOR  SET SN=$ORDER(^INWEAUFS(YM,YAUFTRAG,POS,BET,LAP,WE,SN)) QUIT:SN=""  DO
	. . . . . . . SET LOT=$PIECE($GET(^INWEAUF(YM,YAUFTRAG,POS,BET,LAP,WE,1)),Y,19)  ;LOTNUMMER
	. . . . . . . IF LOT=""
	. . . . . . . SET LOT=$PIECE($GET(^INWEAUF(YM,YAUFTRAG,POS,BET,LAP,WE,1)),Y,2)  ;CHARGENNUMMER
	. . . . . . . IF LOT'="" DO
	. . . . . . . . IF LOT1="" SET LOT1=LOT QUIT
	. . . . . . . . SET LOT1=LOT1_";"_LOT
	. . . . . . . ;
	. . . . . . . IF SN1="" SET SN1=SN QUIT
	. . . . . . . SET SN1=SN1_";"_SN
	. . ;
	. . IF $DATA(^INWEAUFALTS(YM,YAUFTRAG,POS)) DO
	. . . SET BET=""
	. . . FOR  SET BET=$ORDER(^INWEAUFALTS(YM,YAUFTRAG,POS,BET)) QUIT:BET=""  DO
	. . . . SET LAP=""
	. . . . FOR  SET LAP=$ORDER(^INWEAUFALTS(YM,YAUFTRAG,POS,BET,LAP)) QUIT:LAP=""  DO
	. . . . . SET WE=""
	. . . . . FOR  SET WE=$ORDER(^INWEAUFALTS(YM,YAUFTRAG,POS,BET,LAP,WE)) QUIT:WE=""  DO
	. . . . . . SET SN=""
	. . . . . . FOR  SET SN=$ORDER(^INWEAUFALTS(YM,YAUFTRAG,POS,BET,LAP,WE,SN)) QUIT:SN=""  DO
	. . . . . . . SET LOT=$PIECE($GET(^INWEAUFALT(YM,YAUFTRAG,POS,BET,LAP,WE,1)),Y,19)  ;LOTNUMMER
	. . . . . . . IF LOT="" SET LOT=$PIECE($GET(^INWEAUFALT(YM,YAUFTRAG,POS,BET,LAP,WE,1)),Y,2)  ;CHARGENNUMMER
	. . . . . . . IF LOT'="" DO
	. . . . . . . . IF LOT1="" SET LOT1=LOT QUIT
	. . . . . . . . SET LOT1=LOT1_";"_LOT
	. . . . . . . ;
	. . . . . . . IF SN1="" SET SN1=SN QUIT
	. . . . . . . SET SN1=SN1_";"_SN
	. . ;
	. . ;SERIENNUMMER
	. . IF $PIECE(YBELEG1,Y,176)=1 IF SN1'="" DO
	. . . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . . SET A=YSPE
	. . . SET YA(1)=$PIECE(YBELEG1,Y,172)  ;DRUCK 0/1  BARCODE ;printing 
	. . . SET YA(3)=$$^WWWTEXT(32116)      ;SERIENNUMMER
	. . . IF YA(1)'=1 IF ($LENGTH(YA(3))+$LENGTH(SN1)+YA(2))'>80 DO  QUIT  ;ALLE SN IN EINER ZEILE ;within unit 
	. . . . ;DO EDIP^INDRUCK("MSG*SN: "_SN1)    ;EINSETZEN  SERIENNUMMER: XXXX,XXXX,...
	. . ;
	. . ;LOTNUMMER
	. . IF $PIECE(YBELEG1,Y,178)=1 IF $TRANSLATE(LOT1,";,")'="" DO
	. . . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . . SET A=YSPE
	. . . SET YA(1)=$PIECE(YBELEG1,Y,172)  ;DRUCK 0/1  BARCODE ;printing 
	. . . SET YA(3)=$$^WWWTEXT(32535)  ;LOT-NUMMER
	. . . ;DO EDIP^INDRUCK("MSG*LOT: "_LOT1)  
	. ;
	. SET A=YSPE
	. ;TEXT
	. SET YA(1)=$PIECE(YBELEG1,Y,48)  ;DRUCK 0/1  SUCHTEXT ;printing 
	. IF YA(1)=1 DO                   ;ANZEIGEN  ;NICHT ANZEIGEN  ;display Not display 
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . SET YA(3)=$PIECE(POS1,Y,1)
	. . ;
	. . ;TYBD;23717;4,08,2003
	. . IF $TRANSLATE($PIECE($get(^INANGPSP(YM,YAUFTRAG,POS,SPRACHE,1)),Y,2)," ")'="" SET YA(3)=$PIECE(^INANGPSP(YM,YAUFTRAG,POS,SPRACHE,1),Y,2)    ; 04-Sep-2006
	. . IF $TRANSLATE($PIECE($get(^INAUFPSP(YM,YAUFTRAG,POS,SPRACHE,1)),Y,2)," ")'="" SET YA(3)=$PIECE(^INAUFPSP(YM,YAUFTRAG,POS,SPRACHE,1),Y,2)    ; 04-Sep-2006
	. . ;
	. . ;DO EDIP^INDRUCK("PID*"_YA(3))
	. ;
	. ;  FIXME : Note EDIP call commented - does the rest of the block matter?
	. ;          Is YA(*) used elsewhere before being overwritten?        <GRF>
	. ;
	. ;STEUERÃ„NDERUNGSGRUND;FIS;20.04.04;25528
	. IF YBELEG'=3 IF YBELEG'=10 DO   ;NICHT BEI BESTELLUNG ODER ANFRAGE ;Not next to sales order Or 
	. . IF $PIECE(POS1,Y,351)'="" DO
	. . . SET YA(1)=$PIECE(YBELEG1,Y,198)  ;DRUCK 0/1 ;printing 
	. . . IF YA(1)=1 DO  ;ANZEIGEN ;give notice  ;display 
	. . . . SET YA(3)=$PIECE(POS1,Y,351)  ;STEUERÃ„NDERUNGSGRUND
	. . . . ;DO EDI^INDRUCK("MSG*_YA(3))
	. ;
	. ;  FIXME : Note EDIP call commented - does the rest of the block matter?
	. ;          Is YA(*) used elsewhere before being overwritten?        <GRF>
	. ;
	. SET A=YSPE
	. ;LIEFERANTENTEXTE AUF BESTELLUNG ;upon sales order 
	. IF (YBELEG=3) || (YBELEG=10) DO
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . QUIT:$GET(YLIEFER)=""
	. . QUIT:$PIECE(POS1,Y,4)=""
	. .;SET YA(3)=$PIECE($GET(^INAUFPK(YM,YAUFTRAG,POS,1)),Y,1)                        ; 04-Sep 2006 vvv
	. .;IF YBELEG=10 SET YA(3)=$PIECE($GET(^INANGPK(YM,YAUFTRAG,POS,1)),Y,1)
	. . set YA(3) = $$$INAUFPKSupplierItemNumber($GET(^INAUFPK(YM,YAUFTRAG,POS,1)))    ; D8
	. . IF YBELEG=10 SET YA(3)=$PIECE($GET(^INANGPK(YM,YAUFTRAG,POS,1)),Y,8)           ; 04-Sep 2006 ^^^
	. . IF YA(3)="" QUIT
	. . SET YA(1)=$PIECE(YBELEG1,Y,80)         ;DRUCK 0/1  AUSFÃœHRUNG ;printing execution 
	. . ;DO   ;IF YA(1)=1 DO                   ;ANZEIGEN ;display ; 04-Sep-2006 commented ineffective DO
	. . ;. ;DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. ;  FIXME : Note EDIP call commented - does the rest of the block matter?
	. ;          Is YA(*) used elsewhere before being overwritten?        <GRF>
	. ;
	. SET A=YSPE
	. ;AUSFUEHRUNG
	. SET YA(1)=$PIECE(YBELEG1,Y,80)  ;DRUCK 0/1  AUSFÃœHRUNG ;printing execution 
	. IF YA(1)=1 DO                   ;ANZEIGEN ;give notice  ;display 
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . ;IF YBELEG'=3 QUIT:$TRANSLATE($PIECE(POS1,Y,10),"| ")'=""  ;KUNDENTEXT VORHANDEN WENN BELEG AN KUNDEN
	. . SET YA(3)=$PIECE(POS1,Y,14)
	. . IF $PIECE(POS1,Y,171)'="" DO
	. . . IF '$FIND($TRANSLATE($PIECE(POS1,Y,14)," -"),"DIN"_$PIECE(POS1,Y,171)) DO
	. . . . IF $EXTRACT(YA(3),$LENGTH(YA(3)))="|" SET YA(3)=$EXTRACT(YA(3),1,$LENGTH(YA(3))-1)
	. . . . IF $EXTRACT(YA(3),$LENGTH(YA(3)))=" " SET YA(3)=$EXTRACT(YA(3),1,$LENGTH(YA(3))-1)
	. . . . SET YA(3)=YA(3)_" DIN-"_$PIECE(POS1,Y,171)
	. . ;
	. . ;DO EDIP^INDRUCK("PID*F****"_YA(3))
	. ;
	. ;  FIXME : Note EDIP call commented - does the rest of the block matter?
	. ;          Are YA(*) & ME used elsewhere before being overwritten?        <GRF>
	. ;
	. ;MENGE   ;quantity 
	. SET YA(1)=$PIECE(YBELEG1,Y,42)  ;DRUCK 0/1 ;printing 
	. IF YA(1)=1 DO                   ;ANZEIGEN ;give notice  ;display 
	. . NEW ME
	. . SET ME=""
	. . IF +$PIECE(POS1,Y,5)=0 QUIT   ;KEINE AUSGABE BEI MENGE 0 ;no expenses next to quantity 
	. . ;
	. . IF $FIND($PIECE(POS1,Y,5),".") SET YA(3)=$$^WWWZAHL($PIECE(POS1,Y,5),5,$LENGTH($PIECE($PIECE(POS1,Y,5),".",2)))
	. . IF '$FIND($PIECE(POS1,Y,5),",") IF '$FIND($PIECE(POS1,Y,5),".") SET YA(3)=$$^WWWZAHL($PIECE(POS1,Y,5),5,0)
	. . ;
	. . IF $PIECE(YBELEG1,Y,44)=1 DO  ;ANZEIGEN MENGENEINHEIT ;display 
	. . . QUIT:$PIECE(POS1,Y,40)=""
	. . . SET ME=$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(POS1,Y,40),1)),Y,1)  ;MENGENEINHEIT
	. . ;
	. . ;DO EDIP^INDRUCK("QTY*"_$PIECE(POS1,Y,5)_"*"_ME)
	. ;
	. SET YPROZM=+$PIECE($GET(^INVORG(YM,YM,1)),Y,21)
	. ;einzel preis ;price 
	. SET YA(1)=$PIECE(YBELEG1,Y,56)  ;DRUCK 0/1 ;printing 
	. IF YA(1)=1 DO  ;ANZEIGEN ;give notice  ;display 
	. . NEW PREIS
	. . SET PREIS=+$PIECE(POS1,Y,118)
	. . IF (YBELEG=3) || (YBELEG=13) DO   ;BESTELLUNG = EK ;sales order Planned Cost 
	. . . SET PREIS=$PIECE(YEKK,Y,47)  ;SELBSTKOSTEN ;total production costs  ;total production costs whole 
	. . . ;SET PREIS=$PIECE(YEKK,Y,13)/$PIECE(POS1,Y,5)  ;SELBSTKOSTEN
	. . . IF YPROZM'=0 IF PREIS'=0 SET PREIS=$JUSTIFY(PREIS-(PREIS/100*YPROZM),0,2)   ;WENN % ABZIEHEN BEI BESTELLUNG ;when subtract next to sales order 
	. . ;
	. . QUIT:+PREIS=0
	. . IF YINKLMWST=1 IF YBELEG'=3 SET PREIS=PREIS+$JUSTIFY(PREIS/100*MWST,0,2)  ;WENN INKL MWST!! ;when 
	. . SET YA(3)=$$^WWWZAHL(PREIS,10,2,YWHR)
	. . IF PREIS<100 IF $LENGTH($PIECE(PREIS,".",2))>2 IF +$EXTRACT($PIECE(PREIS,".",2),3,9)'=0 SET YA(3)=$$^WWWZAHL(PREIS,9,3,YWHR)
	. . ;MENGENEINHEIT WENN KEINE MENGE UND KEIN GESAMTPREIS ;when no quantity And no 
	. . IF (+$PIECE(POS1,Y,11)'=0) || ((+$PIECE(POS1,Y,5)=0) && (+$PIECE(POS1,Y,119)=0)) DO         ; split for clarity  ; 04-Sep-2006
	. . . IF $PIECE(POS1,Y,40)'="" SET YA(3)=YA(3)_"/"_$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,$PIECE(POS1,Y,40),1)),Y,1)
	. . ;EINZELPREIS DRUCKEN ;print 
	. . SET YA(3)=PREIS
	. . IF $PIECE(YAUFTRAG1,Y,104)=1 QUIT  ;OHNE POSITIONSPREISE DRUCKEN ;without print 
	. . ;DO EDIP^INDRUCK("PRI*"_YA(3))   ;EINZELPREIS 
	. ;
	. ;GESpreis
	. SET YA(1)=$PIECE(YBELEG1,Y,58)  ;DRUCK 0/1 ;printing 
	. IF (YBELEG=1) || (YBELEG=10) IF +$PIECE(POS1,Y,11)'=0 DO   ;WENN ANGEBOT;NUR ALTERNATIVPOSITION = KEIN GESAMTPREIS ;when proposition only no 
	. . ;
	. . SET YA(3)=$PIECE($GET(^WWW101(0,"OPTIONAL",SPRACHE,$PIECE(POS1,Y,11),1)),Y,1)
	. . IF YA(3)="" IF YBELEG=1 SET YA(3)=$$^WWWTEXT(32180)   ;ALTERNATIV BIETEN WIR AN ;afford we upon 
	. . IF YA(3)="" IF YBELEG=10 SET YA(3)=$$^WWWTEXT(32202)   ;BIETEN SIE UNS ALTERNATIV AN ;afford they we upon 
	. . ;
	. . ;DO EDIP^INDRUCK("MSG*"_YA(3)) 
	. ;
	. DO             ;ANZEIGEN ;give notice  ;display 
	. . NEW PREIS
	. . IF (YBELEG=1) || (YBELEG=10) IF +$PIECE(POS1,Y,11)'=0 QUIT  ;WENN ALTERNATIV, DANN KEIN PREIS 
	. . ;IF +$PIECE(POS1,Y,5)=0 SET $PIECE(POS1,Y,5)=1
	. . SET PREIS=+$PIECE(POS1,Y,119)
	. . IF (YBELEG=3) || (YBELEG=10) DO   ;BESTELLUNG = EK ;sales order Planned Cost 
	. . . SET PREIS=$PIECE(YEKK,Y,47)  ;SELBSTKOSTEN EINZEL ;total production costs 
	. . . ;SET PREIS=$PIECE(YEKK,Y,13)/$PIECE(POS1,Y,5)   ;SELBSTKOSTEN EINZEL
	. . . QUIT:+PREIS=0
	. . . IF YPROZM'=0 IF PREIS'=0 SET PREIS=$JUSTIFY(PREIS-(PREIS/100*YPROZM),0,2)   ;ABZIEHEN ;subtract 
	. . . SET PREIS=PREIS*$PIECE(POS1,Y,5)/$$^INQTYUNIT($PIECE(POS1,Y,4))  ;GESAMTEK
	. . . SET POSTOTAL=PREIS  ;GESAMTPOSTIONSPREIS EINKAUFSPREIS
	. . ;
	. . IF YINKLMWST=1 IF YBELEG'=3 SET PREIS=$JUSTIFY(($PIECE(POS1,Y,118)+($PIECE(POS1,Y,118)/100*MWST))*$PIECE(POS1,Y,5)/$$^INQTYUNIT($PIECE(POS1,Y,4)),0,2)  ;WENN INKL MWST!! ;when 
	. . QUIT:+PREIS=0  ;KEIN PREIS ;no prize 
	. . SET YA(3)=PREIS
	. . ;SET YA(3)=$$^WWWZAHL(PREIS,12,2,YWHR)
	. . IF $PIECE(YAUFTRAG1,Y,104)=1 QUIT  ;OHNE POSITIONSPREISE DRUCKEN ;without print 
	. . DO EDIP^INDRUCK("SAC*A*F050***"_YA(3)) 
	. ;
	. NEW PREIS
	. SET PREIS=0
	. SET PREIS=+$PIECE(POS1,Y,119)
	. IF YINKLMWST=1 IF YBELEG'=3 DO       ; split for clarity
	. . SET PREIS=$JUSTIFY(($PIECE(POS1,Y,118)+($PIECE(POS1,Y,118)/100*MWST))*$PIECE(POS1,Y,5)/$$^INQTYUNIT($PIECE(POS1,Y,4)),0,2)  ;WENN INKL MWST!! ;when 
	. IF YBELEG=3 DO   ;BEI BESTELLUNG ;next to sales order 
	. . SET PREIS=$PIECE(YEKK,Y,47)  ;SELBSTKOSTEN ;total production costs  ;total production costs whole 
	. . ;SET PREIS=$PIECE(YEKK,Y,13)/$PIECE(POS1,Y,5)   ;SELBSTKOSTEN EINZEL
	. . IF YPROZM'=0 IF PREIS'=0 SET PREIS=$JUSTIFY(PREIS-(PREIS/100*YPROZM),0,2)
	. . SET PREIS=PREIS*$PIECE(POS1,Y,5)/$$^INQTYUNIT($PIECE(POS1,Y,4))  ;GESAMTEK
	. ;
	. IF +$PIECE(POS1,Y,11)=0 DO  ;NICHT BEI OPTIONAL ;Not next to 
	. . SET MWPO(MWPO) = MWPO(MWPO)+PREIS
	. . SET SUMME      = SUMME+PREIS
	. . SET POSSUM     = POSSUM+PREIS
	. ;
	. ;WEITERE DATENFELDER (MULTI-SELECT)
	. DO                       ;IF (YBELEG=7) || (YBELEG=12) DO  ;BEI RECHNUNGEN ;next to 
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . NEW DAFELD,YI,FTYP
	. . SET DAFELD=$TRANSLATE($PIECE(YBELEG1,Y,180),";",",")
	. . QUIT:DAFELD=""
	. . FOR YI=1:1  QUIT:$PIECE(DAFELD,",",YI,999)=""  DO
	. . . QUIT:$PIECE(DAFELD,",",YI)=""
	. . . SET YA(3)=$PIECE($GET(^INAUFP(YM,YAUFTRAG,POS,1)),Y,$PIECE(DAFELD,",",YI))
	. . . QUIT:YA(3)=""
	. . . SET FTYP=$PIECE($GET(^WWW003(0,"INAUFP",$PIECE(DAFELD,",",YI),1)),Y,3)  ;FELDTYP
	. . . IF FTYP=1 SET YA(3)=$$^WWWDATE(YA(3))  ;DATUM ;Date  ;Date Date 
	. . . IF FTYP=2 SET YA(3)=$PIECE($GET(^WWW100(0,"JA/NEIN",SPRACHE,YA(3),1)),Y,1)  ;JA/NEIN
	. . . IF FTYP=7 SET YA(3)=$$^WWWTIME(YA(3))  ;UHRZEIT
	. . . IF FTYP=8 SET YA(3)=$$^WWWZAHL(YA(3),0,2,YWHR)  ;WÃ„HRUNG ;money standard 
	. . . IF FTYP=14 SET YA(3)=$$^WWWDATE(+YA(3))_" "_$$^WWWTIME($PIECE(YA(3),",",2))  ;ZEITSTEMPEL
	. . . DO  ;IF YA(1)=1 DO  ;ANZEIGEN ;display 
	. . . . ;DO EDIP^INDRUCK("MSG*"_$P($G(^WWW003(0,"INAUFP",$PIECE(DAFELD,",",YI),1)),Y,2)_" "_YA(3))
	. ;
	. ;  FIXME : Note EDIP calls commented - does the rest of the block matter?
	. ;          Are YA(*) & ME used elsewhere before being overwritten?        <GRF>
	. ;
	. ;LIEFERTERMIN IN POSITION ;time of delivery within 
	. IF $PIECE(POS1,Y,19)'="" IF $PIECE(POS1,Y,19)'=$PIECE(YAUFTRAG1,Y,19) DO
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . ;
	. . SET YA(1)=$PIECE(YBELEG1,Y,80)  ;DRUCK 0/1  AUSFÃœHRUNG ;printing execution 
	. . DO
	. . . IF YBELEG'=3 IF YBELEG'=10 IF YBELEG'=2 QUIT
	. . . ;
	. . . SET YA(2)=$$^WWWTEXT(32168)   ;"Liefertermin:"
	. . . IF (YBELEG=3) || (YBELEG=10) DO   ;LIEFERANT   ;supplier 
	. . . . SET YA(3)=""
	. . . . ;IF $PIECE(YAUFTRAG1,Y,197)'="" SET YA(3)=$PIECE($GET(^WWW101(0,"LIEFERKENNZEICHEN",SPRACHE,$PIECE(YAUFTRAG1,Y,197),1)),Y,1)
	. . . . IF $PIECE(YAUFTRAG1,Y,197)'=4   IF $PIECE(YBELEG1,Y,36)'=1 SET YA(3)=$ZDATE($PIECE(POS1,Y,19),8)
	. . . . IF ($PIECE(YAUFTRAG1,Y,197)=4) || ($PIECE(YBELEG1,Y,36)=1) SET YA(3)=$ZDATE($PIECE(POS1,Y,19),8)  ;SET YA(3)=$$^WWWWEEK($PIECE(POS1,Y,19),1)
	. . . . QUIT:YA(3)=""
	. . . . ;DO EDIP^INDRUCK("DTM*"_YA(3))
	. . . ;
	. . . IF YBELEG'=3 IF YBELEG'=10 DO     ;KUNDE   ;customer 
	. . . . SET YA(3)=""
	. . . . ;IF $PIECE(YAUFTRAG1,Y,198)'="" SET YA(3)=$PIECE($GET(^WWW101(0,"LIEFERKENNZEICHEN",SPRACHE,$PIECE(YAUFTRAG1,Y,197),1)),Y,1)
	. . . . IF $PIECE(YAUFTRAG1,Y,198)'=4   IF $PIECE(YBELEG1,Y,36)'=1 SET YA(3)=$ZDATE($PIECE(POS1,Y,19),8)
	. . . . IF ($PIECE(YAUFTRAG1,Y,198)=4) || ($PIECE(YBELEG1,Y,36)=1) SET YA(3)=$ZDATE($PIECE(POS1,Y,19),8)  ;SET YA(3)=$$^WWWWEEK($PIECE(POS1,Y,19),1)
	. . . . QUIT:YA(3)=""
	. . . . ;DO EDIP^INDRUCK("DTM*"_YA(3))
	. ;
	. ;LIEFERANSCHRIFT AUF BESTELLUNG ;upon sales order 
	. IF (YBELEG=3) || (YBELEG=10) DO
	. . QUIT:$PIECE(YBELEG1,Y,187)=1       ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . NEW ADR,ADR2,YN
	. . SET ADR=""
	. . QUIT:$GET(YLIEFER)=""
	. . QUIT:$PIECE(POS1,Y,241)'=1  ;KEINE LA ;no 
	. . IF '$DATA(^INAUFPLA(YM,YAUFTRAG,POS)) IF $PIECE(YAUFTRAG1,Y,215)=1 DO  QUIT  ;BEREITS ALS KOPF ;yet when pate 
	. . . SET $PIECE(^INAUFP(YM,YAUFTRAG,POS,1),Y,241)=0  ;UMSETZTEN AUF NICHT DRUCKEN ;upon Not print 
	. . . QUIT
	. . SET ADR=$GET(^INAUFA(YM,YAUFTRAG,6,1))               ;AUFTRAG ;order 
	. . IF $DATA(^INAUFPLA(YM,YAUFTRAG,POS,1)) SET ADR=^INAUFPLA(YM,YAUFTRAG,POS,1)     ; 04-Sep-2006
	. . IF YBELEG=10 SET ADR=$GET(^INANGA(YM,YAUFTRAG,6,1))  ;ANGEBOT ;quote
	. . IF ADR="" DO
	. . . IF $PIECE(YAUFTRAG1,Y,1)'="" IF $DATA(^INKUNDE(YM,$PIECE(YAUFTRAG1,Y,1))) DO
	. . . . SET ADR2=$GET(^INKUNDE(YM,$PIECE(YAUFTRAG1,Y,1),1))
	. . . . FOR YN=3,4,6,7,10,12,14,16,17 SET $PIECE(ADR,Y,YN)=$PIECE(ADR2,Y,YN)
	. . ;
	. . QUIT:$TRANSLATE(ADR,Y)=""
	. . SET YA(3)=$$^INADRES(ADR,0,1)
	. . IF $TRANSLATE($PIECE(ADR,Y,17)," ")'="" DO  ;LAND (NUR WENN NICHT WIE LIEFERANT) ;rural when Not such as 
	. . . NEW AUSLAND
	. . . SET AUSLAND=0
	. . . IF $PIECE(YADRES,Y,17)="" QUIT
	. . . IF $PIECE(YADRES,Y,17)'=$PIECE($GET(^WWW0121(0,YM,YLOCATION,1)),Y,17) SET AUSLAND=1  ;AUSLAND ;foreign country 
	. . . IF $PIECE(YADRES,Y,17)'=$PIECE(ADR,Y,17) SET AUSLAND=1  ;AUSLAND ;foreign country 
	. . . QUIT:AUSLAND=0
	. . . SET YA(3)=YA(3)_$PIECE($GET(^WWW100(0,"LAND",SPRACHE,$PIECE(ADR,Y,17),1)),Y,1)_"|"
	. . ;
	. . SET TEXT=$PIECE(YBELEG1,Y,87)  ;LIEFERANSCHRIFT
	. . DO EDIP^INDRUCK("MSG*"_TEXT_" "_YA(3))
	. ;
	. ;LIEFERVORSCHRIFT AUF BESTELLUNG ;shipping instruction upon sales order 
	. IF (YBELEG=3) || (YBELEG=10) DO
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . NEW LIVO
	. . SET LIVO=""
	. . QUIT:$GET(YLIEFER)=""
	. . QUIT:$PIECE(POS1,Y,4)=""
	. . SET LIVO=$PIECE($GET(^INAUFPK(YM,YAUFTRAG,POS,1)),Y,71)
	. . IF YBELEG=10 SET LIVO=$PIECE($GET(^INANGPK(YM,YAUFTRAG,POS,1)),Y,71)
	. . QUIT:LIVO=""
	. . SET YA(3)=$PIECE($GET(^INVERPVOR(YM,LIVO,1)),Y,2)
	. . IF YA(3)="" QUIT
	. . SET YA(1)=$PIECE(YBELEG1,Y,86)   ;DRUCK 0/1  AUSFÃœHRUNG ;printing execution 
	. . IF YA(1)=1 DO  ;ANZEIGEN ;give notice  ;display 
	. . DO EDIP^INDRUCK("MSG*"_"INFO: "_YA(3))
	. ;
	. IF (YBELEG=3) || (YBELEG=10) DO  QUIT  ;BESTELLUNGS RABATTE
	. . NEW YI
	. . FOR YI=2:1:4 DO
	. . . QUIT:$PIECE(YEKK,Y,YI)=""  ;KEIN RABATT ;no deduction 
	. . . SET A=YSPE
	. . . ;RABATTE
	. . . SET RABZW=POSTOTAL
	. . . SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. . . ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. . . IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . . . QUIT:+RABZW=0
	. . . . SET YA(3)=$PIECE(YEKK,Y,YI)
	. . . . QUIT:+YA(3)=0
	. . . . SET RABATT=$JUSTIFY(RABZW/100*YA(3),0,2)
	. . . . IF $PIECE(YEKK,Y,50+YI)="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT ;deduction 
	. . . . IF $PIECE(YEKK,Y,50+YI)'="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$PIECE(YEKK,Y,49+YI)   ;_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT
	. . . . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . . . SET RABZW=RABZW-RABATT
	. . . . SET POSTOTAL=POSTOTAL-RABATT
	. . . . SET POSSUM=POSSUM-RABATT
	. . . . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . . . SET YA(3)=RABATT*-1
	. . . . DO EDIP^INDRUCK("MSG*Discount "_YA(3))
	. . ;
	. . FOR YI=5 DO       ; FIXME : single value <GRF>
	. . . QUIT:+$PIECE(YEKK,Y,YI)=0  ;KEIN RABATT ;no deduction 
	. . . SET $PIECE(YEKK,Y,YI)=+$PIECE(YEKK,Y,YI)*-1  ;ZU/ABSCHLAG %
	. . . SET A=YSPE
	. . . ;RABATTE
	. . . SET RABZW=POSTOTAL
	. . . SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. . . ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. . . IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . . . QUIT:+RABZW=0
	. . . . SET YA(3)=$PIECE(YEKK,Y,YI)
	. . . . QUIT:+YA(3)=0
	. . . . SET RABATT=$JUSTIFY(RABZW/100*YA(3),0,2)
	. . . . IF RABATT<0 SET YA(3)="+"_$JUSTIFY(YA(3)*-1,5,2)_"% "_$$^WWWTEXT(32957)_"   "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;ZUSCHL
	. . . . IF RABATT>0 SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$$^WWWTEXT(32958)_"   "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;ABSCHL
	. . . . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . . . SET RABZW=RABZW-RABATT
	. . . . SET POSTOTAL=POSTOTAL-RABATT
	. . . . SET POSSUM=POSSUM-RABATT
	. . . . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . . . SET YA(3)=RABATT*-1
	. . . . DO EDIP^INDRUCK("MSG*Discount "_YA(3))
	. . ;
	. . FOR YI=6 DO       ; FIXME : single value <GRF>
	. . . QUIT:+$PIECE(YEKK,Y,YI)=0  ;KEIN RABATT ;no deduction 
	. . . SET $PIECE(YEKK,Y,YI)=+$PIECE(YEKK,Y,YI)*-1  ;ZU/ABSCHLAG %
	. . . ;RABATTE
	. . . SET RABZW=POSTOTAL
	. . . SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. . . ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. . . IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . . . QUIT:+RABZW=0
	. . . . SET YA(3)=$PIECE(YEKK,Y,YI)
	. . . . QUIT:+YA(3)=0
	. . . . SET RABATT=$JUSTIFY(YA(3),0,2)
	. . . . IF RABATT<0 SET YA(3)="+"_" "_$$^WWWTEXT(32957)  ;ZUSCHLAG ;surcharge 
	. . . . IF RABATT>0 SET YA(3)="-"_" "_$$^WWWTEXT(32958)  ;ABSCHLAG
	. . . . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . . . SET RABZW=RABZW-RABATT
	. . . . SET POSTOTAL=POSTOTAL-RABATT
	. . . . SET POSSUM=POSSUM-RABATT
	. . . . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . . . SET YA(3)=RABATT*-1
	. . . . DO EDIP^INDRUCK("MSG*Discount "_YA(3))
	. ;
	. ;  FIXME : Note EDIP call commented - does the rest of the block matter?
	. ;          Are YA(*) & ME used elsewhere before being overwritten?        <GRF>
	. ;
	. SET A=YSPE
	. ;KUNDENTEXT
	. SET YA(1)=$PIECE(YBELEG1,Y,81)  ;DRUCK 0/1 ;printing 
	. IF YA(1)=1 DO  ;ANZEIGEN ;give notice  ;display 
	. . QUIT:$PIECE(YBELEG1,Y,187)=1  ;POSITIONEN NICHT DRUCKEN ;Not print 
	. . SET YA(3)=$PIECE(POS1,Y,10)
	. . ;
	. . IF $TRANSLATE($PIECE($get(^INANGPSP(YM,YAUFTRAG,POS,SPRACHE,1)),Y,1)," ")'="" SET YA(3)=$PIECE(^INANGPSP(YM,YAUFTRAG,POS,SPRACHE,1),Y,1)     ; 04-Sep-2006
	. . IF $TRANSLATE($PIECE($get(^INAUFPSP(YM,YAUFTRAG,POS,SPRACHE,1)),Y,1)," ")'="" SET YA(3)=$PIECE(^INAUFPSP(YM,YAUFTRAG,POS,SPRACHE,1),Y,1)     ; 04-Sep-2006
	. . ;
	. . IF $TRANSLATE(YA(3),"| ")="" IF $PIECE(YBELEG1,Y,82)=1 SET YA(3)=$PIECE(POS1,Y,14)  ;WENN KEIN EINTRAG ABER GEKLICKT DANN KUNDENTEXT=AUSFÃœHRUNG ;when no yet 
	. . ;DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. SET A=YSPE
	. ;RABATT1
	. SET RABZW=$PIECE(POS1,Y,119)
	. ;IF YINKLMWST=1 I YBELEG'=3 SET RABZW=$JUSTIFY(($PIECE(POS1,Y,118)/100*MWPO)*$PIECE(POS1,Y,5),0,2)  ;WENN INKL MWST!!
	. IF YINKLMWST=1 IF YBELEG'=3 SET RABZW=$JUSTIFY(($PIECE(POS1,Y,118)+($PIECE(POS1,Y,118)/100*MWST))*$PIECE(POS1,Y,5)/$$^INQTYUNIT($PIECE(POS1,Y,4)),0,2)  ;WENN INKL MWST!!  ;FIS, 12.11.01
	. SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . QUIT:+RABZW=0
	. . SET YA(3)=$PIECE(POS1,Y,121)
	. . QUIT:+YA(3)=0
	. . SET RABATT=$JUSTIFY(RABZW/100*YA(3),0,2)
	. . SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT ;deduction 
	. . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . SET RABZW=RABZW-RABATT
	. . SET POSSUM=POSSUM-RABATT
	. . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . SET YA(3)=RABATT*-1
	. . DO EDIP^INDRUCK("MSG*Discount "_YA(3))
	. ;
	. SET A=YSPE
	. ;RABATT2
	. SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . QUIT:+RABZW=0
	. . IF +$PIECE(YAUFTRAG1,Y,70)'=0 IF $PIECE(POS1,Y,122)'=$PIECE(YAUFTRAG1,Y,70) SET $PIECE(POS1,Y,122)=$PIECE(YAUFTRAG1,Y,70)
	. . SET YA(3)=$PIECE(POS1,Y,122)   ;RABATT ;deduction 
	. . QUIT:+YA(3)=0
	. . SET RABATT=$JUSTIFY(RABZW/100*YA(3),0,2)
	. . IF $PIECE(POS1,Y,125)="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT ;deduction 
	. . IF $PIECE(POS1,Y,125)'="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$PIECE(POS1,Y,125)  ;_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT
	. . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . SET RABZW=RABZW-RABATT
	. . SET POSSUM=POSSUM-RABATT
	. . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . SET YA(3)=RABATT*-1
	. . DO EDIP^INDRUCK("MSG*Discount "_YA(3))
	. ;
	. SET A=YSPE
	. ;RABATT3  MENGENRABATT ;volume discount 
	. SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . QUIT:+RABZW=0
	. . SET YA(3)=$PIECE(POS1,Y,128)   ;RABATT ;deduction 
	. . QUIT:+YA(3)=0
	. . SET RABATT=$JUSTIFY(RABZW/100*YA(3),0,2)
	. . IF $PIECE(POS1,Y,129)="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$$^WWWTEXT(31412)_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT ;deduction 
	. . IF $PIECE(POS1,Y,129)'="" SET YA(3)="-"_$JUSTIFY(YA(3),5,2)_"% "_$PIECE(POS1,Y,129)  ;_" "_$$^WWWZAHL(RABZW,7,2,YWHR)  ;RABATT
	. . SET MWPO(MWPO)=MWPO(MWPO)-RABATT  ;MWST ;Tax 
	. . SET RABZW=RABZW-RABATT
	. . SET POSSUM=POSSUM-RABATT
	. . SET YA(3)=$$^WWWZAHL(RABATT*-1,12,2,YWHR)  ;RABATT ;deduction 
	. . SET YA(3)=RABATT*-1
	. . DO EDIP^INDRUCK("MSG*Discount"_YA(3))
	. ;
	. SET A=YSPE
	. ;SPEZIALZUSCHLAG
	. SET YA(1)=$PIECE(YBELEG1,Y,60)  ;DRUCK 0/1 ;printing 
	. ;IF YA(1)=1 DO  ;ANZEIGEN RABATT ;display deduction 
	. IF YA(1)=1 IF +$PIECE(POS1,Y,11)=0 DO  ;ANZEIGEN RABATT;FIS;NICHT BEI OPTIONAL;08.04.04
	. . QUIT:+$PIECE(POS1,Y,211)=0  ;KEIN ZUSCHLAG ;no surcharge 
	. . IF $PIECE(POS1,Y,210)="" SET YA(3)=$$^WWWTEXT(32351)_" "  ;ZUSTZKOSTEN
	. . IF $PIECE(POS1,Y,210)'="" SET YA(3)=$PIECE(POS1,Y,210)  ;ZUSCHLAGSBEZEICHNUNG
	. . IF $PIECE(POS1,Y,211)>0 SET YA(3)="+ "_YA(3)
	. . IF $PIECE(POS1,Y,211)<0 SET YA(3)="- "_YA(3)
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . SET YA(3)=$PIECE(POS1,Y,211)     ;ZUSCHLAG ;surcharge 
	. . SET MWPO(MWPO)=MWPO(MWPO)+YA(3)  ;MWST ;Tax 
	. . SET RABZW=RABZW+YA(3)
	. . SET POSSUM=POSSUM+YA(3)
	. . ;SET YA(3)=$$^WWWZAHL(YA(3),12,2,YWHR)  ;ZUSCHLAG
	. . ;
	. . DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. ;ERSATZTEXT ANSTELLE POSITIONEN DRUCKEN ;print 
	. IF YBELEG'=12 IF $PIECE(YBELEG1,Y,187)=1 IF $PIECE(YBELEG1,Y,188)'="" DO
	. . SET A=YSPE
	. . SET YA(3)=$PIECE(YBELEG1,Y,188)
	. . IF $ORDER(YAUFTRAG(POS),-1)="" DO  ;NUR BEI 1.POSITION ;only next to 
	. . . DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. ;ERSATZTEXT ANSTELLE POSITIONEN DRUCKEN ;print 
	. IF YBELEG=12 IF $PIECE(YFELDPZ,Y,13)=1 IF $PIECE(YFELDPZ,Y,18)'="" DO
	. . SET A=YSPE
	. . SET YA(3)=$PIECE(YFELDPZ,Y,18)
	. . IF $ORDER(YAUFTRAG(POS),-1)="" DO  ;NUR BEI 1.POSITION ;only next to 
	. . . DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. ;ERSATZTEXT ANSTELLE POSITIONEN DRUCKEN ;print 
	. IF YBELEG=12 IF $PIECE(YFELDPZ,Y,13)=1 IF $PIECE(YFELDPZ,Y,18)="" IF $PIECE(YBELEG1,Y,188)'="" DO
	. . SET A=YSPE
	. . SET YA(3)=$PIECE(YBELEG1,Y,188)
	. . SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. . IF YA(2)="" SET YA(2)=14
	. . IF $ORDER(YAUFTRAG(POS),-1)="" DO  ;NUR BEI 1.POSITION ;only next to 
	. . . DO EDIP^INDRUCK("MSG*"_YA(3))
	. ;
	. ;SONDERTEXTE JE POSITION JE BELEG ;once once proof 
	. IF $DATA(^INAUFPC(YM,YAUFTRAG,POS,YBELEG,1)) DO
	. . SET YA(3)=$PIECE(^INAUFPC(YM,YAUFTRAG,POS,YBELEG,1),Y,1)     ; 04-Sep-2006
	. . SET YA(1)=$PIECE(YBELEG1,Y,80)         ;DRUCK 0/1  AUSFÃœHRUNG ;printing execution 
	. . DO EDIP^INDRUCK("MSG*"_YA(3))        ;ANZEIGEN ;give notice  ;display 
	
	QUIT
	
TEILE(DEEP)   ;DRUCKEN DER TEILE ;VAIABLE POS1=TEILEDATENSATZ ;print the 
	; FIXME : No internal calls. Obsolete?  <GRF>
	QUIT
]]></Routine>
</Export>