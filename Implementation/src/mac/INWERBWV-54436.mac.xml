<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INWERBWV" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INWERBWV     ;INWERBWV;FAN;WIEDERVORLAGEN;31.07.2001
	;
#include COMSYS   // SR14746
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		WIEDERVORLAGEN
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	; 05-Oct-2006		RPW			SR14746: Fixed missed direct global set
	; 21-SEP-2006 FAN SR14746 Sales statistics incorrect
	;|
	;| FAN	31.07.2001
	;|
	;\------------------------------------------------------------------/
	;
	NEW SATZ,YI,TAG,DATUM,ADR1,SATZ1,KONNR,KEY
	QUIT:YKEY=""
	SET YKEY1=$PIECE($GET(YKEY),",",1)
	SET YKEY2=$PIECE($GET(YKEY),",",2)
	QUIT:YKEY1=""
	QUIT:YKEY2=""
	QUIT:'$DATA(^INWERBADR(YM,YKEY1,1))
	SET ADR1=$GET(^INWERBADR(YM,YKEY1,1))
	;IF $PIECE(YFELD,Y,30)="" SET $PIECE(^INWERBADR1(YM,YKEY1,YKEY2,1),Y,30)=$PIECE(ADR1,Y,82)  //SORTKEY // SR14746 
	;IF $PIECE(YFELD,Y,40)="" SET $PIECE(^INWERBADR1(YM,YKEY1,YKEY2,1),Y,40)=$PIECE(ADR1,Y,8)
	DO
	. NEW SATZ
	. SET SATZ=$GET(^INWERBADR1(YM,YKEY1,YKEY2,1))
	. IF $PIECE(YFELD,Y,30)="" SET $PIECE(SATZ,Y,30)=$PIECE(ADR1,Y,82)  //SORTKEY // SR14746 
	. IF $PIECE(YFELD,Y,40)="" SET $PIECE(SATZ,Y,40)=$PIECE(ADR1,Y,8)
	
	. IF $PIECE(YFELD,Y,8)=1 IF $PIECE(YFELD,Y,9)="" SET $PIECE(SATZ,Y,9)=+$HOROLOG  ;SETZEN ERLEDIGUNGSDATUM ;typeset 
	
	. SET strStatus=$$$Save("INWERBADR1",YKEY1_","_YKEY2,SATZ,$$$YES) // SR14746
	
	IF $PIECE(YFELD,Y,18)'="" IF $PIECE(ADR1,Y,28)'=$PIECE(YFELD,Y,18) IF $PIECE(ADR1,Y,90)="" DO        ;NICHT LOST, POTENTIAL NICHT GELEICH
	. SET $PIECE(ADR1,Y,28)=$PIECE(YFELD,Y,18) 
	. SET YOK=$$^WWWSPEI("INWERBADR",YKEY1,ADR1,1)  ;SPEICHERN ;Save 
	. QUIT
	;--------------------------------NICHT ÜBERLEITEN ABER LOST
	IF $PIECE(YFELD,Y,19)'=1 IF $PIECE(YFELD,Y,25)'="" DO
	. SET $PIECE(ADR1,Y,91)=+$H  ;LOST DATUM ;Date 
	. SET $PIECE(ADR1,Y,90)=$PIECE(YFELD,Y,25)  ;LOST GRUND ;motive 
	. SET YOK=$$^WWWSPEI("INWERBADR",YKEY1,ADR1,1)  ;SPEICHERN ;Save 
	. IF $DATA(^INWERBADR1(YM,YKEY1)) DO
	. . SET KONNR="" FOR  SET KONNR=$ORDER(^INWERBADR1(YM,YKEY1,KONNR)) QUIT:KONNR=""  DO
	. . . SET SATZ1=$GET(^INWERBADR1(YM,YKEY1,KONNR,1))
	. . . SET $PIECE(SATZ1,Y,25)=$PIECE(ADR1,Y,90)    ;LOST GRUND ;motive 
	. . . SET $PIECE(SATZ1,Y,26)=+$H  ;LOST DATUM ;Date 
	. . . SET KEY=YKEY1_","_KONNR
	. . . SET YOK=$$^WWWSPEI("INWERBADR1",KEY,SATZ1,1)  ;SPEICHERN  ;Save 
	. . . QUIT
	. . QUIT
	. QUIT
	;--------------------------------ÜBERLEITUNG DER WERBEADRESSE IN KUNDENDATEI
	;IF $P(YFELD,Y,19)=1 IF $P(YFELD,Y,20)="" DO ^INDAKONLEIT1 Q        ;IF YMANDANT="FITNESS" 
	IF $PIECE(YFELD,Y,19)=1 IF $PIECE(YFELD,Y,20)="" DO 
	. SET YNR=$$^WWWNEXT("INKUNDE")
	. SET $PIECE(ADR1,Y,35)=1  ;KUNDENNUMMER
	. SET $PIECE(ADR1,Y,36)=YNR  ;KUNDENNUMMER
	. SET $PIECE(ADR1,Y,30)=0  ;WERBUNG ERWÜNSCHT=NEIN
	. SET $PIECE(ADR1,Y,37)=+$H  ;ÜBERLEITEN DATUM ;Date 
	. SET $PIECE(ADR1,Y,90)=0    ;LOST GRUND ;motive 
	. SET $PIECE(ADR1,Y,91)=+$H  ;LOST DATUM ;Date 
	. SET YOK=$$^WWWSPEI("INWERBADR",YKEY1,ADR1,1)  ;SPEICHERN ;Save 
	. ;
	. ;KOPIEREN ADRESS-DATEN IN KUNDENSTAMM ;within 
	. FOR I=1:1:26 SET $PIECE(SATZ,Y,I)=$PIECE(ADR1,Y,I)  ;DATENFELDER 1-26
	. SET $PIECE(SATZ,Y,31)=$PIECE(ADR1,Y,32)  ;ADRESSGRUPPE
	. SET $PIECE(SATZ,Y,86)=$PIECE(ADR1,Y,31)  ;BRANCHE    ;sector of industry 
	. SET $PIECE(SATZ,Y,94)=$PIECE(ADR1,Y,40)  ;BEMERKUNGEN
	. SET $PIECE(SATZ,Y,96)=1  ;MAHNKENNZEICHEN
	. SET $PIECE(SATZ,Y,54)=1  ;STEUERKENNZEICHEN=STEUER INLAND
	. SET $PIECE(SATZ,Y,102)=5  ;ZAHLUNGSWEG=FREI
	. DO
	. . NEW YFORM,YVOR
	. . SET YFORM="INKUNDE"
	. . SET YOK=$$^WWWSPEI("INKUNDE",YNR,SATZ,1)
	. . QUIT
	. QUIT:YOK'=1
	. ;
	. IF $DATA(^INWERBADR1(YM,YKEY1)) DO
	. . SET KONNR="" FOR  SET KONNR=$ORDER(^INWERBADR1(YM,YKEY1,KONNR)) QUIT:KONNR=""  DO
	. . . SET SATZ1=$GET(^INWERBADR1(YM,YKEY1,KONNR,1))
	. . . SET $PIECE(SATZ1,Y,19)=1    ;KUNDENDATEI  JA ;yes 
	. . . SET $PIECE(SATZ1,Y,20)=YNR  ;KUNDENNUMMER
	. . . SET $PIECE(SATZ1,Y,21)=+$H  ;ÜBERLEITEN DATUM ;Date 
	. . . SET $PIECE(SATZ1,Y,25)=0    ;LOST GRUND ;motive 
	. . . SET $PIECE(SATZ1,Y,26)=+$H  ;LOST DATUM ;Date 
	. . . SET KEY=YKEY1_","_KONNR
	. . . SET YOK=$$^WWWSPEI("INWERBADR1",KEY,SATZ1,1)  ;SPEICHERN  ;Save 
	. . . QUIT
	. . QUIT
	. ;
	. ;KOPIEREN KONTAKTE
	. MERGE ^INKUNDED(YM,YNR)=^INWERBADR1(YM,YKEY1)
	. DO ^WWWSSORT("INKUNDED",YNR)
	. ;
	. ;KOPIEREN ANSPRECHPARTNER
	. MERGE ^INPARTN(YM,YNR)=^INPARTN(YM,YKEY1)
	. DO ^WWWSSORT("INPARTN",YNR)
	. ;
	. ;KOPIEREN BRIEFE
	. SET YREF=YKEY1
	. FOR  SET YREF=$ORDER(^INDMS(YM,YREF)) QUIT:YREF=""  QUIT:$PIECE(YREF,".",1)'=YKEY1  DO  ;SUCHEN BELEGE ;seek 
	. . MERGE ^INDMS(YM,YNR_"."_$PIECE(YREF,".",2))=^INDMS(YM,YREF)
	. . IF $PIECE(YFELD,Y,23)=1 KILL ^INDMS(YM,YREF)  ;LÖSCHEN NACH ÜBERLEITUNG ;Delete within 
	. . QUIT
	. ;LÖSCHEN WERBESTAMMDATEN ;Delete 
	. IF $PIECE(YFELD,Y,23)=1 DO
	. . DO ^WWWSKILL("INWERBADR",YKEY1)
	. . DO ^WWWSKILL("INWERBADR1",YKEY1)
	. . DO ^WWWSKILL("INPARTN",YKEY1)
	. . DO
	. . . KILL YOLD
	. . . SET ^WWWSOR(YUSER,1)=$$^WWWTEXT(31403)_" "_YNR  ;INFOTEXT FÜR ^WWWSAVE
	. . . QUIT
	. . QUIT
	. ;
	. SET $PIECE(^INWERBADR(YM,YKEY,1),Y,202)=1 DO ^INDOC("INWERBADR",YKEY,YFELD)   ;SCHREIBEN BRIEF ;write letter 
	. ;
	. QUIT
	; ----------------------------------------------OHNE LOST GRUND WIEDERVORLAGEN 
	;ÄNDERERUNGSDATUM=""--NUR BEI NEU ERFASSUNGEN ,WIEDERVORLAGE DATUM'=""
	;NICHT LOST, NICHT ÜBERLEITER, KEIN KUNDENNUMMER 
	IF YFORM="INWERBKON1" IF $P(YFELD,Y,33)="" IF $PIECE(YFELD,Y,12)'="" DO  Q
	. IF $PIECE(YFELD,Y,25)="" IF $PIECE(YFELD,Y,19)'=1!($PIECE(YFELD,Y,20)'="") DO  Q
	. . NEW SATZ,YI,TAG,DATUM,YDAT,KEY,KKEY
	. . SET DATUM=$PIECE(YFELD,Y,12)
	. . Q:DATUM=""
	. . ;
	. . SET YDAT=DATUM+1 FOR  SET YDAT=$ORDER(^WWWWV(YM,YBED,YDAT),-1) QUIT:YDAT=""  DO
	. . . SET FORM="INWERBKON1" DO
	. . . . SET KKEY="" FOR  SET KKEY=$ORDER(^WWWWV(YM,YBED,YDAT,YFORM,KKEY)) QUIT:KKEY=""  DO
	. . . . . IF $PIECE(KKEY,"/",1)=$PIECE($GET(YKEY),",",1) KILL ^WWWWV(YM,YBED,YDAT,YFORM,KKEY,1)
	. . . . . QUIT
	. . . . QUIT
	. . . QUIT
	. . ;
	. . SET $PIECE(SATZ,Y,1)=+$H
	. . SET $PIECE(SATZ,Y,2)=$H
	. . SET $PIECE(SATZ,Y,3)=YBED
	. . SET $PIECE(SATZ,Y,4)=$PIECE(ADR1,Y,8)
	. . IF $PIECE(YFELD,Y,18)=1 SET $PIECE(SATZ,Y,4)="<FONT COLOR=RED><B>"_$PIECE(SATZ,Y,4)_"</B></FONT>"
	. . IF $PIECE(YFELD,Y,18)=2 SET $PIECE(SATZ,Y,4)="<FONT COLOR=ORANGERED>"_$PIECE(SATZ,Y,4)_"</FONT>"
	. . IF $PIECE(YFELD,Y,16)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_": "_$PIECE($GET(^INPARA(YM,"WVBETREFF",SPRACHE,$PIECE(YFELD,Y,16),1)),Y,1)
	. . ;IF $PIECE(YFELD,Y,5)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_" "_$TR($PIECE(YFELD,Y,5),"|"," ")
	. . S KEY=$P($G(YKEY),",",1)_"/"_$P($G(YKEY),",",2)
	. . SET ^WWWWV(YM,YBED,DATUM,YFORM,KEY,1)=SATZ
	. . QUIT
	. QUIT
	QUIT
]]></Routine>
</Export>