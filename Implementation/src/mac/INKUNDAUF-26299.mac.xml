<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INKUNDAUF" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INKUNDAUF(KUNDE,HIST,VON,BIS)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		ERRECHNEN AUFTRAGSMENGE EINES KUNDEN
	;
	; Inputs : 
	;	HIST=1 AKTUELLE AUFTRÄGE-------ACHTUNG:  VON UND BIS OHNE WERKUNG
	;	HIST=2 ALLE AUFTRÄGE ;IN ZEITRAUM VON--BIS  (OHNE VON BIS,DANN ALLE) ;03.05.2004;FAN;25425; FORECAST  
	;	HIST=3 Auftragsvolumen ;IN ZEITRAUM VON--BIS  (OHNE VON BIS,DANN ALLE) ;03.05.2004;FAN;25425; FORECAST  
	;	HIST=5 BESTIMMT ZEITRAUM, VON DATUM, BIS DATUM, NUR VON ANGEBOTE BEKOMMEN IST  ;03.05.2004;FAN;25425; FORECAST  
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 24-Jul-2007	GRF		Doco; quits; Fixme
	; 04.07.2000	DT
	;-------------------------------------------------------------------------------
	NEW AUF,DAT,AUF1,AUFTRAEGE,AUFENDE
	
	SET HIST = $GET(HIST,1)
	SET VON  = $GET(VON)
	SET BIS  = $GET(BIS)
	
	SET AUFTRAEGE=0  ;KUNDENAUFTRÄGE
	IF KUNDE=""  QUIT:AUFTRAEGE
	
	IF HIST=1 IF $GET(KUNDE)'="" DO  ;SUCHEN AUFTRAGSBESTAND ;seek volume of orders 
	. SET KUNDE=$PIECE(KUNDE,",",1)
	. SET AUF=""
	. FOR  SET AUF=$ORDER(^INAUF1(YM,AUF)) QUIT:AUF=""  DO
	. . SET AUF1=$GET(^INAUF(YM,AUF,1))
	. . QUIT:$PIECE(AUF1,Y,1)'=$GET(KUNDE)  ;NICHT RICHTIGER KUNDE ;Not customer 
	. . SET AUFTRAEGE=AUFTRAEGE+1
	
	IF HIST=2 IF $GET(KUNDE)'="" IF ($GET(VON)="")||($GET(BIS)="") DO  ;SUCHEN AUFTRAGSBESTAND  ;BEC;25886;08.06.04;NUR WENN VON OD. BIS="" sonst doppelt so viele Ergebnisse
	. SET KUNDE=$$^WWWUMLAU($PIECE(KUNDE,",",1),1)
	. QUIT:KUNDE=""
	. SET DAT=""
	. FOR  SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,DAT)) QUIT:DAT=""  DO
	. . SET AUFENDE=""
	. . FOR  SET AUFENDE=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE)) QUIT:AUFENDE=""  DO
	. . . SET AUF=""
	. . . FOR  SET AUF=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE,AUF)) QUIT:AUF=""  DO
	. . . . SET AUFTRAEGE=AUFTRAEGE+1
	
	IF HIST=2 IF $GET(KUNDE)'="" IF $GET(VON)'="" IF $GET(BIS)'="" DO  ;BESTIMMT ZEITRAUM, VON DATUM, BIS DATUM, ALLE AUFTRAG  ;03.05.2004;FAN;25425; FORECAST
	. SET KUNDE=$$^WWWUMLAU(KUNDE,1)
	. QUIT:KUNDE=""
	. IF BIS="" SET BIS=$ORDER(^INAUFs(YM,1,KUNDE,""),-1)
	. SET DAT=""
	. IF VON'="" SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,VON),-1)
	. FOR  SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,DAT)) QUIT:DAT]]BIS  QUIT:DAT=""  DO
	. . SET AUFENDE=""
	. . FOR  SET AUFENDE=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE)) QUIT:AUFENDE=""  DO
	. . . SET AUF=""
	. . . FOR  SET AUF=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE,AUF)) QUIT:AUF=""  DO
	. . . . SET AUFTRAEGE=AUFTRAEGE+1
	
	IF HIST=3 IF $GET(KUNDE)'="" DO  ;SUCHEN AUFTRAGSBESTAND WERT;TYBD:14.04.2003 ;seek volume of orders worthy 
	. SET KUNDE=$$^WWWUMLAU($PIECE(KUNDE,",",1),1)
	. QUIT:KUNDE=""
	. NEW POS,POS1
	. SET VON=$GET(VON)
	. SET BIS=$GET(BIS)
	. IF BIS="" SET BIS=$ORDER(^INAUFs(YM,1,KUNDE,""),-1)
	. SET DAT=""
	. IF VON'="" SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,VON),-1)
	. FOR  SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,DAT)) QUIT:DAT]]BIS  QUIT:DAT=""  DO
	. . SET AUFENDE=""
	. . FOR  SET AUFENDE=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE)) QUIT:AUFENDE=""  DO
	. . . SET AUF=""
	. . . FOR  SET AUF=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE,AUF)) QUIT:AUF=""  DO
	. . . . SET POS=""
	. . . . ; FIXME : ? Should there be a "FOR" here or are we specifically only processing the first entry? <GRF>
	. . . . SET POS=$ORDER(^INAUFP(YM,AUF,POS)) QUIT:POS=""  DO
	. . . . . SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. . . . . IF +$PIECE(POS1,Y,9)=1  QUIT  ;STORNO
	. . . . . IF +$PIECE(POS1,Y,60)=1 QUIT  ;ABGESCHLOSSENE POSITION
	. . . . . SET AUFTRAEGE=AUFTRAEGE+$PIECE(POS1,Y,123)
	
	IF HIST=5 IF $GET(KUNDE)'="" DO  ;BESTIMMT ZEITRAUM, VON DATUM, BIS DATUM,NUR VON ANGBOTE BEKOMMEN  ;03.05.2004;FAN;25425; FORECAST
	. SET KUNDE=$$^WWWUMLAU(KUNDE,1)
	. QUIT:KUNDE=""
	. SET VON=$GET(VON)
	. SET BIS=$GET(BIS)
	. IF BIS="" SET BIS=$ORDER(^INAUFs(YM,1,KUNDE,""),-1)
	. SET DAT=""
	. IF VON'="" SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,VON),-1)
	. FOR  SET DAT=$ORDER(^INAUFs(YM,1,KUNDE,DAT)) QUIT:DAT]]BIS  QUIT:DAT=""  DO
	. . SET AUFENDE=""
	. . FOR  SET AUFENDE=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE)) QUIT:AUFENDE=""  DO
	. . . SET AUF=""
	. . . FOR  SET AUF=$ORDER(^INAUFs(YM,1,KUNDE,DAT,AUFENDE,AUF)) QUIT:AUF=""  DO
	. . . . QUIT:$PIECE($GET(^INAUF(YM,AUF,1)),Y,7)=""           ;NUR VON ANGBOTE BEKOMMEN ;only 
	. . . . SET AUFTRAEGE=AUFTRAEGE+1
	
	QUIT AUFTRAEGE
	
]]></Routine>
</Export>