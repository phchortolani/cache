<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INWERBKUN" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INWERBKUN       ;INWERBKUN;FIS;PRUEFPROGRAMM BEI SPEICHERN WERBEADRESSEN;12.01.2001
	;
#include COMSYS   // SR14746
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		PRUEFPROGRAMM BEI SPEICHERN WERBEADRESSEN
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	; 05-Oct-2006		RPW		SR14746: Removed merge, load old then save new.
	; 21-SEP-2006 FAN SR14746 Sales statistics incorrect
	;|
	;| FIS	12.01.2001
	;|
	;\------------------------------------------------------------------/
	;
	;DO ^INDAKONLEIT Q
	;IF YMANDANT="FITNESS" DO ^INDAKONLEIT Q
	NEW SATZ,I,LINK
	DO SAVE^INKUNDED54  ;FIS;PRÜFEN STEUERKENNZEICHEN;31.12.04;26636
	IF $PIECE(YFELD,Y,100)="" SET $PIECE(YFELD,Y,100)=YFORM
	IF YFORM="INWERBADR" IF $PIECE(YFELD,Y,8)="" SET $PIECE(YFELD,Y,8)=$PIECE(YFELD,Y,4)
	IF YFORM="INWERBADR" SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD,1)  ;KURZBEZEICHNUNG
	IF YFORM="INWERBKON" IF $PIECE(YFELD,Y,8)="" SET $PIECE(YFELD,Y,8)=$PIECE(YFELD,Y,6)_", "_$PIECE(YFELD,Y,4) 
	IF YFORM="INWERBKON" SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD,1)  ;KURZBEZEICHNUNG
	;-------------------------------------------------------LOST 
	IF $PIECE(YFELD,Y,35)'=1 IF $PIECE(YFELD,Y,90)'="" DO        
	. SET $PIECE(YFELD,Y,91)=+$HOROLOG  ;LOST DATUM ;Date 
	. SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD,1)  ;SPEICHERNIF 
	. IF $DATA(^INWERBADR1(YM,YKEY)) DO
	. . SET KONNR="" FOR  SET KONNR=$ORDER(^INWERBADR1(YM,YKEY,KONNR)) QUIT:KONNR=""  DO
	. . . SET SATZ1=$GET(^INWERBADR1(YM,YKEY,KONNR,1))
	. . . SET $PIECE(SATZ1,Y,25)=$P(YFELD,Y,90)    ;LOST GRUND ;motive 
	. . . SET $PIECE(SATZ1,Y,26)=+$H  ;LOST DATUM ;Date 
	. . . SET YKEY1=YKEY_","_KONNR
	. . . SET YOK=$$^WWWSPEI("INWERBADR1",YKEY1,SATZ1,1)  ;SPEICHERN  ;Save 
	. . . QUIT
	. . QUIT
	. QUIT
	;--------------------------------------------------------WIEDERVORLAGEN
	;ÄNDERERUNGSDATUM=""--NUR BEI NEU ERFASSUNGEN ,WIEDERVORLAGE DATUM'=""
	;NICHT LOST, NICHT ÜBERLEITER, KEIN KUNDENNUMMER
	IF YFORM="INWERBKON" IF $PIECE(YFELD,Y,47)="" IF $PIECE(YFELD,Y,70)'="" DO    
	. IF $PIECE(YFELD,Y,90)="" IF $PIECE(YFELD,Y,35)'=1!($PIECE(YFELD,Y,36)'="") IF $PIECE(YFELD,Y,85)="" DO
	. . NEW SATZ,YI,TAG,DATUM,ADR1,YDAT,ADRESSGRUPPE,BETRIEB
	. . QUIT:$PIECE(YFELD,Y,45)'=""
	. . SET BETRIEB=$PIECE(YFELD,Y,82)
	. . QUIT:BETRIEB=""
	. . ;
	. . SET ADRESSGRUPPE=$PIECE(YFELD,Y,32)
	. . IF ADRESSGRUPPE="" SET $P(^INWERBADR(YM,YKEY,1),Y,70)="" QUIT
	. . ;
	. . IF '$DATA(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)) SET $P(^INWERBADR(YM,YKEY,1),Y,70)="" QUIT
	. . ;
	. . IF $DATA(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)) DO
	. . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)'="" DO
	. . . . SET $P(^INWERBADR(YM,YKEY,1),Y,70)=$$^WWWDATE(+$H+$PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1))
	. . . . QUIT
	. . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)="" DO
	. . . . SET $P(^INWERBADR(YM,YKEY,1),Y,70)="" 
	. . . . QUIT
	. . . QUIT
	. . SET DATUM=$P(^INWERBADR(YM,YKEY,1),Y,70) 
	. . IF DATUM'="" DO
	. . . SET $PIECE(SATZ,Y,1)=+$H
	. . . SET $PIECE(SATZ,Y,2)=$H
	. . . SET $PIECE(SATZ,Y,3)=YBED
	. . . SET $PIECE(SATZ,Y,4)=$PIECE(YFELD,Y,8)
	. . . IF $PIECE(YFELD,Y,28)=1 SET $PIECE(SATZ,Y,4)="<FONT COLOR=RED><B>"_$PIECE(SATZ,Y,4)_"</B></FONT>"
	. . . IF $PIECE(YFELD,Y,28)=2 SET $PIECE(SATZ,Y,4)="<FONT COLOR=ORANGERED>"_$PIECE(SATZ,Y,4)_"</FONT>"
	. . . IF $PIECE(YFELD,Y,32)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_": "_$PIECE($GET(^INPARA(YM,"ADRESSGRUPPE",SPRACHE,$PIECE(YFELD,Y,32),1)),Y,1)
	. . . ;IF $PIECE(YFELD,Y,40)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_" "_$TR($PIECE(YFELD,Y,40),"|"," ")
	. . . SET ^WWWWV(YM,YBED,DATUM,YFORM,YKEY,1)=SATZ
	. . . QUIT
	. . QUIT
	. QUIT
	IF YFORM="INWERBKON" IF $PIECE(YFELD,Y,47)=""  IF $PIECE(YFELD,Y,70)="" DO    
	. IF $PIECE(YFELD,Y,90)="" IF $PIECE(YFELD,Y,35)'=1!($PIECE(YFELD,Y,36)'="") IF $PIECE(YFELD,Y,85)="" DO
	. . NEW SATZ,YI,DATUM,ADR1,YDAT,ADRESSGRUPPE,BETRIEB
	. . ;IF $P(YFELD,Y,70)'="" SET DATUM=$PIECE(YFELD,Y,70) 
	. . SET BETRIEB=YLOCATION
	. . SET ADRESSGRUPPE=$PIECE(YFELD,Y,32)
	. . IF BETRIEB="" SET DATUM=""
	. . IF ADRESSGRUPPE="" SET DATUM=""
	. . IF BETRIEB'="" IF ADRESSGRUPPE'="" IF '$DATA(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)) SET DATUM=""
	. . IF BETRIEB'="" IF ADRESSGRUPPE'="" IF $DATA(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)) DO
	. . . IF YFORM="INWERBKON" DO
	. . . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)="" SET DATUM=""
	. . . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)'="" SET DATUM=$$^WWWDATE(+$H+$PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1))
	. . . . QUIT
	. . . ;IF YFORM="INWERBADR" DO
	. . . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)="" SET DATUM=""
	. . . . IF $PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1)'="" SET DATUM=$$^WWWDATE(+$H+$PIECE($GET(^INWERBWVPARA(YM,BETRIEB,ADRESSGRUPPE,1)),Y,1))
	. . . . QUIT
	. . SET $P(^INWERBADR(YM,YKEY,1),Y,70)=DATUM
	. . IF DATUM'="" DO
	. . . SET $PIECE(SATZ,Y,1)=+$H
	. . . SET $PIECE(SATZ,Y,2)=$H
	. . . SET $PIECE(SATZ,Y,3)=YBED
	. . . SET $PIECE(SATZ,Y,4)=$PIECE(YFELD,Y,8)
	. . . IF $PIECE(YFELD,Y,28)=1 SET $PIECE(SATZ,Y,4)="<FONT COLOR=RED><B>"_$PIECE(SATZ,Y,4)_"</B></FONT>"
	. . . IF $PIECE(YFELD,Y,28)=2 SET $PIECE(SATZ,Y,4)="<FONT COLOR=ORANGERED>"_$PIECE(SATZ,Y,4)_"</FONT>"
	. . . IF $PIECE(YFELD,Y,32)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_": "_$PIECE($GET(^INPARA(YM,"ADRESSGRUPPE",SPRACHE,$PIECE(YFELD,Y,32),1)),Y,1)
	. . . ;IF $PIECE(YFELD,Y,40)'="" SET $PIECE(SATZ,Y,4)=$PIECE(SATZ,Y,4)_" "_$TR($PIECE(YFELD,Y,40),"|"," ")
	. . . SET ^WWWWV(YM,YBED,DATUM,YFORM,YKEY,1)=SATZ
	. . . QUIT
	. . QUIT
	. QUIT
	;-------------------------------------------------WEITERLEITER
	IF YFORM="INWERBKON" IF $PIECE(YFELD,Y,35)'=1 IF $PIECE(YFELD,Y,85)'="" DO
	. FOR YI=1:1:81 SET $PIECE(SATZ,Y,YI)=$PIECE(YFELD,Y,YI)  ;DATENFELDER 3-15
	. SET $PIECE(SATZ,Y,82)=$PIECE(YFELD,Y,85)  ;BEARBEITENSTUDIO = WEITERLEITERSTUDIO
	. SET $PIECE(SATZ,Y,83)=$PIECE(YFELD,Y,82)  ;ERHALTEN VON STUDIO = BEARBEITENSTUDIO
	. SET $PIECE(SATZ,Y,84)=+$H  ;ERHALTEN AM ;to the 
	. SET $PIECE(SATZ,Y,85)=""
	. SET $PIECE(SATZ,Y,100)=$PIECE(YFELD,Y,100)
	. SET YOK=$$^WWWSPEI(YDATEI,YKEY,SATZ,1)  ;SPEICHERN ;Save 
	. QUIT
	;-------------------------------------------------------;ÜBERLEITUNG DER WERBEADRESSE IN KUNDENDATEI
	IF $PIECE(YFELD,Y,35)=1 IF $PIECE(YFELD,Y,36)="" DO  
	. ;
	. SET YNR=$$^WWWNEXT("INKUNDE")
	. SET $PIECE(YFELD,Y,36)=YNR  ;KUNDENNUMMER
	. SET $PIECE(YFELD,Y,30)=0  ;WERBUNG ERWÜNSCHT=NEIN
	. SET $PIECE(YFELD,Y,37)=+$H  ;ÜBERLEITEN DATUM ;Date 
	. SET $PIECE(YFELD,Y,90)=0    ;LOST GRUND ;motive 
	. SET $PIECE(YFELD,Y,91)=+$H  ;LOST DATUM ;Date 
	. SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD,1)  ;SPEICHERN ;Save 
	. ;
	. ;KOPIEREN ADRESS-DATEN IN KUNDENSTAMM ;within 
	. FOR I=1:1:26 SET $PIECE(SATZ,Y,I)=$PIECE(YFELD,Y,I)  ;DATENFELDER 1-26
	. ;SET $PIECE(SATZ,Y,31)=$PIECE(YFELD,Y,32)  ;ADRESSGRUPPE
	. ;SET $PIECE(SATZ,Y,86)=$PIECE(YFELD,Y,31)  ;BRANCHE   
	. SET $PIECE(SATZ,Y,94)=$PIECE(YFELD,Y,40)  ;BEMERKUNGEN  
	. SET $PIECE(SATZ,Y,69)=$PIECE(YFELD,Y,101)  ;BELEG SPRACHE ;proof Language 
	. SET $PIECE(SATZ,Y,54)=$P(YFELD,Y,54)     ;STEUERKENNZEICHEN;FIS;31.12.04;26636
	. SET $PIECE(SATZ,Y,56)=$P(YFELD,Y,56)     ;KONDITION
	. SET $PIECE(SATZ,Y,96)=1  ;MAHNKENNZEICHEN
	. SET $PIECE(SATZ,Y,54)=1  ;STEUERKENNZEICHEN=STEUER INLAND
	. SET $PIECE(SATZ,Y,102)=5  ;ZAHLUNGSWEG=FREI
	. SET $PIECE(SATZ,Y,199)=YKEY    ;WERBEADRESSNUMMER IN KUNDENSTAMM    FAN,12.07.02
	. SET $PIECE(SATZ,Y,48)=YNR  ;KUNDENNUMMER ALS DEBITORENNUMMER   ULM;22.01.03 ;when 
	. SET $PIECE(SATZ,Y,224)=$PIECE(YFELD,Y,32)  ;ADRESSEGRUPPE  ;FAN;11.03.04;25310
	. SET $PIECE(SATZ,Y,85)=$PIECE(YFELD,Y,203)  ;WERBEGEBIET ;FAN;11.03.04;25309
	. DO
	. . NEW YFORM,YVOR
	. . SET YFORM="INKUNDE"
	. . SET YOK=$$^WWWSPEI("INKUNDE",YNR,SATZ,1)
	. . QUIT
	. QUIT:YOK'=1
	. ;
	. ;WENN WAREN FÜR DIESE WERBEKUNDEN RESERVIERT TRAGEN KUNDENNUMMER IN RESERVIEREN DATEI EIN          FAN,12.07.02
	. IF $DATA(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1))) DO
	. . NEW ART,BET,LAP,WED,RENR
	. . SET ART="" FOR  SET ART=$O(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1),ART)) Q:ART=""  DO
	. . . SET BET="" FOR  SET BET=$ORDER(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1),ART,BET)) QUIT:BET=""  DO     ;BETRIEB
	. . . . SET LAP="" FOR  SET LAP=$ORDER(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1),ART,BET,LAP)) QUIT:LAP=""  DO     ;LAGERPLATZ ;stock location 
	. . . . . SET WED="" FOR  SET WED=$ORDER(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1),ART,BET,LAP,WED)) QUIT:WED=""  DO
	. . . . . . SET RENR="" FOR  SET RENR=$ORDER(^INWERs(YM,4,$$^WWWUMLAU(YKEY,1),ART,BET,LAP,WED,RENR)) QUIT:RENR=""  DO 
	. . . . . . . QUIT:'$DATA(^INWER(YM,ART,BET,LAP,WED,RENR,1))
	. . . . . . . DO
	. . . . . . . . NEW SATZ
	. . . . . . . . SET SATZ=$GET(^INWER(YM,ART,BET,LAP,WED,RENR,1))
	. . . . . . . . SET $PIECE(SATZ,Y,1)=YNR             // SR14746 ;KUNDENNUMMER EINTRAGEN
	. . . . . . . . SET strStatus=$$$Save("INWER",ART_","_BET_","_LAP_","_WED_","_RENR,SATZ,$$$YES) // SR14746
	. . . . . . . QUIT
	. . . . . . QUIT
	. . . . . QUIT
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. ;
	. ;
	. IF $DATA(^INWERBADR1(YM,YKEY)) DO
	. . SET KONNR="" FOR  SET KONNR=$ORDER(^INWERBADR1(YM,YKEY,KONNR)) QUIT:KONNR=""  DO
	. . . SET SATZ1=$GET(^INWERBADR1(YM,YKEY,KONNR,1))
	. . . SET $PIECE(SATZ1,Y,19)=1    ;KUNDENDATEI  JA ;yes 
	. . . SET $PIECE(SATZ1,Y,20)=YNR  ;KUNDENNUMMER
	. . . SET $PIECE(SATZ1,Y,21)=+$H  ;ÜBERLEITEN DATUM ;Date 
	. . . SET $PIECE(SATZ1,Y,25)=0    ;LOST GRUND ;motive 
	. . . SET $PIECE(SATZ1,Y,26)=+$H  ;LOST DATUM ;Date 
	. . . SET YKEY1=YKEY_","_KONNR
	. . . SET YOK=$$^WWWSPEI("INWERBADR1",YKEY1,SATZ1,1)  ;SPEICHERN  ;Save 
	. . . QUIT
	. . QUIT
	. ;KOPIEREN KONTAKTE
	. MERGE ^INKUNDED(YM,YNR)=^INWERBADR1(YM,YKEY)
	. DO ^WWWSSORT("INKUNDED",YNR)
	. ;
	. ;KOPIEREN ANSPRECHPARTNER
	. MERGE ^INPARTN(YM,YNR)=^INPARTN(YM,YKEY)
	. DO ^WWWSSORT("INPARTN",YNR)
	. ;
	. ;KOPIEREN BRIEFE
	. SET YREF=YKEY
	. FOR  SET YREF=$ORDER(^INDMS(YM,YREF)) QUIT:YREF=""  QUIT:$PIECE(YREF,".",1)'=YKEY  DO  ;SUCHEN BELEGE ;seek 
	. . MERGE ^INDMS(YM,YNR_"."_$PIECE(YREF,".",2))=^INDMS(YM,YREF)
	. . //MERGE ^INDMSA(YM,YNR_"."_$PIECE(YREF,".",2))=^INDMSA(YM,YREF) // SR14746
	. . ;SET $PIECE(^INDMSA(YM,YNR_"."_$PIECE(YREF,".",2),1),Y,12)=YNR  // SR14746
	. . DO 
	. . . NEW SATZ
	. . . SET SATZ=$GET(^INDMSA(YM,YREF,1))
	. . . SET $PIECE(SATZ,Y,12)=YNR  // SR14746
	. . . SET strStatus=$$$Save("INDMSA",YNR_"."_$PIECE(YREF,".",2),SATZ,$$$YES) // SR14746
	. . . QUIT
	. . IF $PIECE(YFELD,Y,51)=1 DO
	. . . KILL ^INDMS(YM,YREF)
	. . . DO ^WWWSKILL("INDMSA",YREF)   ;LÖSCHEN NACH ÜBERLEITUNG ;Delete within 
	. . . QUIT
	. . QUIT
	. ;
	. ;ÄNDERN KUNDENNUMMER IN ANGEBOTEN ;alter within 
	. DO
	. . NEW ANG,DAT,ABGE
	. . SET DAT="" FOR  SET DAT=$ORDER(^INANGs(YM,1,YKEY,DAT)) QUIT:DAT=""  DO
	. . . SET ABGE="" FOR  SET ABGE=$ORDER(^INANGs(YM,1,YKEY,DAT,ABGE)) QUIT:ABGE=""  DO
	. . . . SET ANG="" FOR  SET ANG=$ORDER(^INANGs(YM,1,YKEY,DAT,ABGE,ANG)) QUIT:ANG=""  DO
	. . . . . QUIT:$GET(^INANG(YM,ANG,1))=""
	. . . . . ;SET $PIECE(^INANG(YM,ANG,1),Y,1)=YNR  // SR14746
	. . . . . DO 
	. . . . . . NEW SATZ
	. . . . . . SET SATZ=$G(^INANG(YM,ANG,1))
	. . . . . . SET $PIECE(SATZ,Y,1)=YNR  // SR14746
	. . . . . . SET strStatus=$$$Save("INANG",ANG,SATZ,$$$YES) // SR14746
	. . . . . QUIT
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. ;
	. SET $PIECE(^INWERBADR(YM,YKEY,1),Y,202)=1 DO ^INDOC("INWERBADR",YKEY,YFELD)   ;SCHREIBEN BRIEF ;write letter 
	. DO
	. . KILL YOLD
	. . NEW YI,YKEY,YFORM
	. . SET ^WWWSOR(YUSER,1)=$$^WWWTEXT(31403)_" "_YNR  ;INFOTEXT FÜR ^WWWSAVE
	. . SET YI=YAKTION_"EP=WWWFORM&YFORM=INKUNDE&YKEY="_YNR  ;LINK NACH KUNDENSTAMM ;within 
	. . DO VAR^WWWCGI
	. . SET YLINK=YI
	. . QUIT
	. QUIT
	. QUIT
	;LÖSCHEN WERBESTAMMDATEN ;Delete 
	IF $PIECE(YFELD,Y,51)=1 I $PIECE(YFELD,Y,36)'="" DO  ;NACH ÜBERLEITUNG ;within 
	. DO ^WWWSKILL("INWERBADR",YKEY)
	. DO ^WWWSKILL("INWERBADR1",YKEY)
	. DO ^WWWSKILL("INWERBKON1",YKEY)
	. DO ^WWWSKILL("INPARTN",YKEY)
	. Q
	. ;
	QUIT
]]></Routine>
</Export>