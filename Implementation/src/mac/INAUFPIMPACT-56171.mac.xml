<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUFPIMPACT" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUFPIMPACT
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		LINE ITEM IMPACT
	;
	; Called by :   INAUF, Routine INARTK
	; 
	; Inputs : 
	;  YKEY    OrderNo,OrderLine,idINAUFPIMPACT
	;  
	;  YFELD		objINAUFPIMPACT
	;     D3  Description    or    Cost Code
	;     D4  curValue 
	;     D8                       code 1-4
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 28-Jul-2006	GRF		Doco
	; 04.03.2005	FIS		Created
	;-------------------------------------------------------------------------------
	NEW KOST,VK,LFN,YI,YFELDOLD
	
	QUIT:$GET(YKEY)=""
	QUIT:$GET(YFELD)=""
	
	;---------------------------------------
	;  YFELD		objINAUFPIMPACT		Additional Costs
	;  POS1			objINAUFP
	;---------------------------------------
	
	SET YFELDOLD=YFELD
	
	;  D215		$$$INVORGCalcAdditionalCostsInLine()
	IF $PIECE($GET(^INVORG(YM,YM,1)),Y,215)'=1 QUIT:+$PIECE(YFELD,Y,6)'=0  ;NICHT NEU RECHNEN
	
	SET KOST=0
	
	IF +$PIECE(YFELD,Y,4)'=0 DO  ;MARKUP AMOUNT
	. SET KOST=$PIECE(YFELD,Y,4)
	. FOR YI=1,2,5,8 SET $PIECE(YFELD,Y,YI)=""
	
	IF +$PIECE(YFELD,Y,5)'=0 DO  ;IMPACT PERCENT
	. SET VK=$PIECE($GET(^INAUFP(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),1)),Y,123)  ;NETTO-VK
	. SET KOST=$JUSTIFY(VK/100*$PIECE(YFELD,Y,5),0,2)
	. FOR YI=1,2,4,8 SET $PIECE(YFELD,Y,YI)=""
	
	IF $PIECE(YFELD,Y,1)'="" DO  ;SPECIAL COSTS
	. IF $PIECE(YFELD,Y,3)="" SET $PIECE(YFELD,Y,3)=$PIECE(YFELD,Y,1)  ;TEXT
	. IF $PIECE(YFELD,Y,2)="" SET $PIECE(YFELD,Y,2)=$ORDER(^INZUSCHLAG(YM,$PIECE(YFELD,Y,1),""))
	. IF $PIECE(YFELD,Y,2)="" SET $PIECE(YFELD,Y,1)="" QUIT  ;KEINE BERECHNUNGSGRUNDLAGE
	. FOR YI=4,5,8 SET $PIECE(YFELD,Y,YI)=""
	. ;
	. NEW KOSTEN1,POS1,BETRAG,VOLUMEN,GEWICHT,STUECK,AB,KUNDE,BETRAG1
	. SET POS1=$GET(^INAUFP(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),1))
	. SET BETRAG=$PIECE(POS1,Y,123)   ;NETTOVERKAUFSPREIS
	. ;
	. SET AB=""
	. IF $PIECE(YFELD,Y,2)=5 SET AB=""
	. IF $PIECE(YFELD,Y,2)=1 SET AB=$PIECE(POS1,Y,123)  ;BERECHNUGN NACH AUFTRAGSWERT
	. IF $PIECE(YFELD,Y,2)=2 SET AB=$PIECE(POS1,Y,43)   ;GEWICHT
	. IF $PIECE(YFELD,Y,2)=3 SET AB=$PIECE(POS1,Y,44)   ;VOLUMEN
	. IF $PIECE(YFELD,Y,2)=6 SET AB=$PIECE(POS1,Y,5)    ;MENGE
	. IF $PIECE(YFELD,Y,2)=4 DO                         ;ENTFERNUNG
	. . SET KUNDE=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,1)  ;KUNDE
	. . IF KUNDE'="" SET AB=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM
	. . IF +$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,187)'=0 SET AB=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,187)
	. ;
	. IF AB'="" SET AB=$ORDER(^INZUSCHLAG(YM,$PIECE(YFELD,Y,1),$PIECE(YFELD,Y,2),+AB+.01),-1)  ;BERECHNUNG AB
	. IF AB=""  SET AB=$ORDER(^INZUSCHLAG(YM,$PIECE(YFELD,Y,1),$PIECE(YFELD,Y,2),""),-1)       ;BERECHNUNG AB
	. IF AB'="" DO   ;BERECHNUNG NACH WERT
	. . SET KOSTEN1=$GET(^INZUSCHLAG(YM,$PIECE(YFELD,Y,1),$PIECE(YFELD,Y,2),AB,1))
	. . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOST=$PIECE(KOSTEN1,Y,1)           QUIT
	. . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOST=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	
	IF $PIECE(YFELD,Y,8)'="" DO  ;PACKING / FREIGHT / INSURANCE / DISTANCE
	. IF $PIECE(YFELD,Y,3)="" SET $PIECE(YFELD,Y,3)=$PIECE($GET(^WWW101(0,"ZUSATZKOSTEN",SPRACHE,$PIECE(YFELD,Y,8),1)),Y,1)  ;TEXT
	. ;
	. NEW KOSTEN1,POS1,BETRAG,VOLUMEN,GEWICHT,STUECK,AB,KUNDE,BETRAG1
	. SET POS1=$GET(^INAUFP(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),1))
	. SET BETRAG=$PIECE(POS1,Y,123)   ;NETTOVERKAUFSPREIS
	. ;
	. SET AB=""
	. IF $PIECE(YFELD,Y,2)=5 SET AB=""
	. IF $PIECE(YFELD,Y,2)=1 SET AB=$PIECE(POS1,Y,123)  ;BERECHNUGN NACH AUFTRAGSWERT
	. IF $PIECE(YFELD,Y,2)=2 SET AB=$PIECE(POS1,Y,43)   ;GEWICHT
	. IF $PIECE(YFELD,Y,2)=3 SET AB=$PIECE(POS1,Y,44)   ;VOLUMEN
	. IF $PIECE(YFELD,Y,2)=6 SET AB=$PIECE(POS1,Y,5)    ;MENGE
	. IF $PIECE(YFELD,Y,2)=4 DO                         ;ENTFERNUNG
	. . SET KUNDE=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,1)  ;KUNDE
	. . IF KUNDE'="" SET AB=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)  ;ANZAHL DER KM
	. . IF +$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,187)'=0 SET AB=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,187)
	. ;
	. SET BETRAG1=0  ;AUFTRAGSWERT
	. SET POSY=""
	. FOR  SET POSY=$ORDER(^INAUFP(YM,$PIECE(YKEY,",",1),POSY)) QUIT:POSY=""  DO
	. . SET BETRAG1=BETRAG1+$PIECE($GET(^INAUFP(YM,$PIECE(YKEY,",",1),POSY,1)),Y,123)
	. ;
	. IF $PIECE(YFELD,Y,8)=1 DO  ;PACKING
	. . NEW VERPACK
	. . SET VERPACK=$PIECE($GET(^INAUF(YM,$PIECE(YKEY,",",1),1)),Y,186)  ;WIE VERPACKEN?
	. . IF VERPACK="" QUIT
	. . IF $PIECE(YFELD,Y,2)="" SET $PIECE(YFELD,Y,2)=$ORDER(^INVERPACK(YM,VERPACK,""))
	. . IF $PIECE(YFELD,Y,2)'="" IF '$DATA(^INVERPACK(YM,VERPACK,$PIECE(YFELD,Y,2))) SET $PIECE(YFELD,Y,2)=$ORDER(^INVERPACK(YM,VERPACK,""))
	. . IF $PIECE(YFELD,Y,2)="" QUIT
	. . IF AB'="" SET AB=$ORDER(^INVERPACK(YM,VERPACK,$PIECE(YFELD,Y,2),+AB+.01),-1)  ;BERECHNUNG AB
	. . IF AB=""  SET AB=$ORDER(^INVERPACK(YM,VERPACK,$PIECE(YFELD,Y,2),""),-1)       ;BERECHNUNG AB
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT
	. . . SET KOSTEN1=$GET(^INVERPACK(YM,VERPACK,$PIECE(YFELD,Y,2),AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOST=$PIECE(KOSTEN1,Y,1)           QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOST=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. IF $PIECE(YFELD,Y,8)=2 DO  ;FREIGHT
	. . NEW FRACHTFREI,KUNDE,VERSAND
	. . SET KUNDE=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,1)  ;KUNDE ;lore 
	. . SET FRACHTFREI=0
	. . IF KUNDE'="" SET FRACHTFREI=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,42)  ;FRACHTFREI BIS
	. . IF +FRACHTFREI'=0 IF FRACHTFREI'<BETRAG1 QUIT   ;NICHTFRACHTFREI=BERECHNEN
	. . ;SET VERSAND=$PIECE($GET(^INAUFP(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),1)),Y,95)  ;AUSKOMMENTIERT, WEIL VERPACKUNG AUCH NICHT NACH POSITION
	. . SET VERSAND=$PIECE($GET(^INAUF(YM,$PIECE(YKEY,",",1),1)),Y,16)  ;WIE TRANSPORTIEREN?
	. . QUIT:VERSAND=""
	. . IF $PIECE(YFELD,Y,2)="" SET $PIECE(YFELD,Y,2)=$ORDER(^INTRANSPORT(YM,VERSAND,""))
	. . IF $PIECE(YFELD,Y,2)'="" IF '$DATA(^INTRANSPORT(YM,VERSAND,$PIECE(YFELD,Y,2))) SET $PIECE(YFELD,Y,2)=$ORDER(^INTRANSPORT(YM,VERSAND,""))
	. . IF $PIECE(YFELD,Y,2)="" QUIT
	. . IF AB'="" SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,$PIECE(YFELD,Y,2),+AB+.01),-1)  ;BERECHNUNG AB
	. . IF AB=""  SET AB=$ORDER(^INTRANSPORT(YM,VERSAND,$PIECE(YFELD,Y,2),""),-1)       ;BERECHNUNG AB
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT
	. . . SET KOSTEN1=$GET(^INTRANSPORT(YM,VERSAND,$PIECE(YFELD,Y,2),AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOST=$PIECE(KOSTEN1,Y,1)           QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOST=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	.IF $PIECE(YFELD,Y,8)=3 DO  ;INSURANCE
	. . NEW VERSICH
	. . SET VERSICH=$PIECE($GET(^INAUF(YM,$PIECE(YKEY,",",1),1)),Y,26)  ;WIE VERSICHERN? ;such as 
	. . QUIT:VERSICH=""
	. . IF $PIECE(YFELD,Y,2)="" SET $PIECE(YFELD,Y,2)=$ORDER(^INVERSICH(YM,VERSICH,""))
	. . IF $PIECE(YFELD,Y,2)'="" IF '$DATA(^INVERSICH(YM,VERSICH,$PIECE(YFELD,Y,2))) SET $PIECE(YFELD,Y,2)=$ORDER(^INVERSICH(YM,VERSICH,""))
	. . IF $PIECE(YFELD,Y,2)="" QUIT
	. . IF AB'="" SET AB=$ORDER(^INVERSICH(YM,VERSICH,$PIECE(YFELD,Y,2),+AB+.01),-1)  ;BERECHNUNG AB
	. . IF AB=""  SET AB=$ORDER(^INVERSICH(YM,VERSICH,$PIECE(YFELD,Y,2),""),-1)       ;BERECHNUNG AB
	. . IF AB'="" DO   ;BERECHNUNG NACH WERT
	. . . SET KOSTEN1=$GET(^INVERSICH(YM,VERSICH,$PIECE(YFELD,Y,2),AB,1))
	. . . IF +$PIECE(KOSTEN1,Y,1)'=0 SET KOST=$PIECE(KOSTEN1,Y,1)           QUIT
	. . . IF +$PIECE(KOSTEN1,Y,2)'=0 SET KOST=$JUSTIFY(BETRAG/100*$PIECE(KOSTEN1,Y,2),0,2)
	. ;
	. IF $PIECE(YFELD,Y,8)=4 DO  ;DISTANCE
	. . NEW KMGELD,KUNDE,KM
	. . SET $PIECE(YFELD,Y,2)=4                                ;IMMER ENTFERNUNG
	. . SET KUNDE=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,1)  ;KUNDE ;customer 
	. . QUIT:KUNDE=""                                          ;KEIN KUNDE ;no customer 
	. . SET KMGELD=$PIECE($GET(^INVORG(YM,YM,1)),Y,28)         ;KMPAUSCHALSATZ BETRAG ;Sum    ; D28  $$$INVORGAmountPerKilometre()
	. . QUIT:+KMGELD=0                                         ;KEIN KMGELD ;no 
	. . SET KM=$PIECE(^INAUF(YM,$PIECE(YKEY,",",1),1),Y,187)
	. . IF +KM=0 SET KM=$PIECE($GET(^INKUNDE(YM,KUNDE,1)),Y,41)
	. . QUIT:+KM=0
	. . SET KOST=KMGELD*KM
	
	;		D215		$$$INVORGCalcAdditionalCostsInLine()
	SET $PIECE(YFELD,Y,6)=KOST
	IF $PIECE($GET(^INVORG(YM,YM,1)),Y,215)'=1 IF +$PIECE(YFELD,Y,6)=0 SET $PIECE(YFELD,Y,6)=""
	
	IF YFELD'=YFELDOLD DO
	. NEW YFORM,YVOR,YOK
	. SET YOK=$$^WWWSPEI("INAUFPIMPACT",YKEY,YFELD,1)
	
	QUIT
	
TOTAL(YKEY)	;TOTAL IMPACT
	NEW LFN,KOST
	
	QUIT:$GET(YKEY)="" ""
	
	SET KOST=""
	SET LFN=""
	FOR  SET LFN=$ORDER(^INAUFPIMPACT(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),LFN)) QUIT:LFN=""  DO
	. SET KOST=KOST+$PIECE($GET(^INAUFPIMPACT(YM,$PIECE(YKEY,",",1),$PIECE(YKEY,",",2),LFN,1)),Y,6)
	
	IF +KOST=0 QUIT ""
	QUIT $$^WWWZAHL(KOST,0,2)
	
]]></Routine>
</Export>