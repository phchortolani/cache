<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INDRUCK6" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INDRUCK6
#include COMSYS
#include INConst
#define hexstrEuro "&#8364;"
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		DRUCKEN POSITIONEN
	; 
	; Updates :	^INAUFPK, ^INANGPK
	; 			^INAUF, ^INAUFPZ		direct sets
	; 			^INAUFP, ^INANGP     (SORT^INDRUCK6)
	; 
	; Called By :
	; 	Routines - INDRUCK, INDRUCKPRINT
	; 
	; Inputs : 
	;
	;
	; ByRef :
	;	YBELEG1		obj???
	;
	; Returns :
	;
	;
	; History :
	; 05-Oct-2006	GRF		Doco; $$$hexstrEuro
	; 29-Sep-2006	GRF		Doco
	; 04-Sep-2006	GRF		SR12027: Naked References; remove unneeded $data; doco;
	; 						INVORG Macros; !=>||; space strings optimised
	; 31-Aug-2005	Steve S	SR13012: Display discounts/surcharges correctly
	;  3-Aug-2005	JW		SR12988: Don't include special surcharge as an additional charge
	; 22.02.2000	DT
	;-------------------------------------------------------------------------------
	NEW POS,MWST,LAND,YA,YSPE,YI,TEIL,TIEFE,YEKK,A,UAN,UAUS,BLANKS,DATUM,GESAMTPZ,POSSUM,POSGRUP,MWPOX,POSSUM1,POSSUM2
	
	;+++++++++++++++++++++++++++++++++++++++
	; When a string contains "&#8364;" ($$$hexstrEuro) its length can be extended
	; by 6 characters to fill a column since the seven characters of the hexstring
	; will convert to a single character on output.
	;+++++++++++++++++++++++++++++++++++++++
	
	;+++++++++++++++++++++++++++++++++++++++
	;	YAUFTRAG1		objINAUF		Order Header
	;	YFELD			objINAUFP		Order Line
	;	POS1			objINAUFP
	;	POS1			objINANGP
	;	POS1			objINAUFPCHECK
	;	POS1			objINANGPCHECK
	;	YEKK			objINAUFPK		Order - Item Supplier Terms
	;	YEKK			objINANGPK		Quote - Item Supplier Terms
	;	YFELD			objINAUFPK
	;	YFELD			objINANGPK
	;	POS1			objINAUFPXL
	;	YFELD			objINANGPZ
	;	YFELD			objINAUFPZ
	;+++++++++++++++++++++++++++++++++++++++
	
	SET YTAB=$EXTRACT($justify("",76),1,+$PIECE(YBELEG1,Y,39))  ;IN SPALTE ;within column  ; 04-Sep-2006 replace long string 
	SET YSPE=$justify("",80)               ; 04-Sep-2006
	
	;YBELEG1
	SET GESAMT=0  ;GESAMTBETRAG
	KILL MWPO     ;STEUERSUMMEN
	SET SUMME=0
	
	SET YVERPACK1    = 0
	SET YFRACHT1     = 0
	SET YVERSICH1    = 0
	SET YKMGELD1     = 0
	SET YZUSCHLAG1   = 0
	SET YZUABSCHLAG1 = 0
	
	SET YINKLMWST=$GET(YINKLMWST)  ;WENN 1 DANN IMMER IMKL MWST ;when constantly Tax 
	SET POSSUM=0  ;ZWISCHENSUMME POSITIONSGRUPPEN ;subtotal 
	
	IF +$PIECE(YBELEG1,Y,73)=0 SET $PIECE(YBELEG1,Y,73)=50  ;POSITIONSTEXTPARAMETER
	
	IF $GET(YSUMINVOICE)=1 DO  QUIT   ;TYBD;29,1,2004;SAMMELRECHNUNG
	. NEW YAUFTRAG,YAUFTRAGX
	. SET YAUFTRAGX=""
	. FOR  SET YAUFTRAGX=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAGX)) QUIT:YAUFTRAGX=""  DO
	. . KILL YAUFTRAG
	. . SET YAUFTRAG=YAUFTRAGX
	. . SET YAUFTRAG1=$GET(^INAUF(YM,YAUFTRAG,1))
	. . ;
	. . ;ÜBERSCHRIFT
	. . SET A=YSPE                       ; spaces
	. . DO SPE^INDRUCK  ;LEERZEILE
	. . SET A=YSPE
	. . SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. . IF YA(2)="" SET YA(2)=14
	. . SET YA(3)="<B>"_$$^WWWTEXT(31401)_" "_YAUFTRAG
	. . IF +$PIECE(YBELEG1,Y,89)=1 SET YA(3)=YA(3)_" "_$PIECE($GET(YAUFTRAG1),Y,302)  ;KUNDENBESTELLNUMMER NUR WENN GEWÜNSCHT;FIS;16.02.05
	. . SET YA(3)=YA(3)_" "_$$^WWWDATE($PIECE(YAUFTRAG1,Y,4))  ;AUFTRAGSNUMMER: NUMMER UND BESTELLNUMMER DES KUNDEN
	. . SET YA(3)=YA(3)_"</B>"
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	. . ;
	. . ;DRUCKEN DER POSITIONEN
	. . SET POS=""
	. . FOR  SET POS=$ORDER(^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAG,POS)) QUIT:POS=""  SET YAUFTRAG(POS)=""
	. . KILL ^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAG)  ;FIS;WEGEN WEITERER FILTER IN LINEITEM;08.03.05
	. . DO LINEITEM
	
	DO LINEITEM
	QUIT
	
LINEITEM
	;-------------------------------------------------------------------------------
	; History:
	; 06-Jan-2006	PO		SR14152: For customer invoice, only invoice if not sourced
	; 29-Jul-2005	JW		SR12992: Making tax consistent
	;-------------------------------------------------------------------------------
	new blnInvDelivery,objINVORG,strInvDelivery
	
	set objINVORG      = $get(^INVORG(YM,YM,1))                          ; 04-Sep-2006
	set strInvDelivery = $$$INVORGInvoiceDeliverySlipOnlyWh(objINVORG)   ; D150   ; 04-Sep-2006 simplify long tests	
	set blnInvDelivery = ((strInvDelivery=1) || (strInvDelivery=2))
		
	;AUFTRAG ODER TEILZAHLUNGSRECHNUNGEN ;order Or 
	IF $GET(YTEST)'=1 IF $GET(YPROFORMA)="" IF YBELEG'=1 IF YBELEG'=10 IF $ORDER(YAUFTRAG(""))="" DO  ;KEINE POSITIONEN ANGEGEBEN=ALLE ;no 
	. SET POS=""
	. FOR  SET POS=$ORDER(^INAUFP(YM,YAUFTRAG,POS)) QUIT:POS=""  DO
	. . SET YFELD=$GET(^INAUFP(YM,YAUFTRAG,POS,1))
	. . IF $PIECE(YFELD,Y,60)=1 QUIT  ;ABGESCHLOSSEN
	. . ;IF YBELEG=5!(YBELEG=6)!(YBELEG=7) IF $PIECE(YFELD,Y,5)'<0 IF strInvDelivery=1 IF +$PIECE(YFELD,Y,90)'=1 QUIT   ;NUR AUSLIEFERUNGSFÄHIGE DRUCKEN;TYBD;27.07.2003;UL;TONY
	. . IF (YBELEG=5) || (YBELEG=6) || (YBELEG=7) IF $PIECE(YFELD,Y,5)'<0 IF $GET(VORKASSE)'=1 IF blnInvDelivery IF +$PIECE(YFELD,Y,90)'=1 QUIT   ;NUR AUSLIEFERUNGSFÄHIGE DRUCKEN;TYBD;27.07.2003;UL;TONY
	. . IF YBELEG=7 IF $PIECE(YFELD,Y,5)'<0 IF $GET(VORKASSE)'=1 IF strInvDelivery=2 IF $PIECE(YFELD,Y,92)="" QUIT   ;NUR GELIEFERTE DRUCKEN;FIS;28.06.04;25791
	. . ;IF YBELEG'=12 IF +$PIECE(YFELD,Y,205)'=0 QUIT  ;SPERR POSITION NICHT DRUCKEN      AUßER ANZAHLUNGEN
	. . IF YBELEG'=12 IF YBELEG'=7 IF +$PIECE(YFELD,Y,205)'=0 QUIT  ;SPERR POSITION NICHT DRUCKEN;FIS;23466;RECHNUNG AUCH WENN GESPERRT
	. . IF YBELEG<13 IF $PIECE(YFELD,Y,9)=1 QUIT  ;storno
	. . IF (YBELEG=7) || (YBELEG=17) IF +YCOPY=0 QUIT:$PIECE(YFELD,Y,97)'=""  ;WENN GESAMTDRUCK, DANN NUR DIE NOCH NICHT GEDRUCKTEN POSITIONEN
	. . SET YAUFTRAG(POS)=""
	
	;ANGEBOT ;quote
	IF $GET(YTEST)'=1 IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1) IF $ORDER(YAUFTRAG(""))="" DO  ;KEINE POSITIONEN ANGEGEBEN=ALLE ;no 
	. SET POS=""
	. FOR  SET POS=$ORDER(^INANGP(YM,YAUFTRAG,POS)) QUIT:POS=""  SET YAUFTRAG(POS)=""
	
	;ANZAHLUNGSRECHTUNG POS DRUCKEN ODER NICHT ;print Or Not
	IF YBELEG=12 IF $GET(YPZDATUM)'="" IF $DATA(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)) DO
	. SET $PIECE(YBELEG1,Y,187)=$PIECE($GET(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)),Y,13)     ; 04-Sep-2006
	
	;REST ;residue 
	SET POS=""
	FOR  SET POS=$ORDER(YAUFTRAG(POS)) QUIT:POS=""  DO  IF +$PIECE(POS1,Y,11)=0 SET GESAMT=GESAMT+POSTOTAL  ;WENN KEINE ALTERNATIV POSITION ;when no 
	. SET POS1=""
	. IF $GET(YTEST)'=1 IF YBELEG'=1 IF YBELEG'=10 IF $GET(YPROFORMA)=""    SET POS1=$GET(^INAUFP(YM,YAUFTRAG,POS,1))       ;AUFTRAG   ;order 
	. IF $GET(YTEST)'=1 IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1) SET POS1=$GET(^INANGP(YM,YAUFTRAG,POS,1))       ;ANGEBOT ODER ANFRAGE ;quote 
	. IF $GET(YTEST)=1  IF YBELEG'=1 IF YBELEG'=10 IF $GET(YPROFORMA)=""    SET POS1=$GET(^INAUFPCHECK(YM,YAUFTRAG,POS,1))  ;AUFTRAG   ;WEM;25073;25.02.2004;SONDERWEG FÜR BELEGDRUCKTEST
	. IF $GET(YTEST)=1  IF (YBELEG=1) || (YBELEG=10) || ($GET(YPROFORMA)=1) SET POS1=$GET(^INANGPCHECK(YM,YAUFTRAG,POS,1))  ;ANGEBOT ODER ANFRAGE   ;WEM;25073;25.02.2004;SONDERWEG FÜR BELEGDRUCKTEST
	. SET YEKK=$GET(^INAUFPK(YM,YAUFTRAG,POS,1))                                        ;EK KONDITION ;Planned Cost 
	. IF $DATA(^INANGPK(YM,YAUFTRAG,POS,1)) SET YEKK=$GET(^INANGPK(YM,YAUFTRAG,POS,1))  ;EK KONDITION ANGEBOT ;Planned Cost proposition 
	. IF $GET(YTEST)=1 SET YEKK="444~0~0~0~0~0.00~5.00~~8~30~~1789.52~1700.05~~~2000~50~1~~102.26~~~2~0~~~~~~1~~~~~~~58450~WIL~58566,50787~WIL~~~~~~~0.89~~~~Treuerabatt~Profirabatt~Mengenrabatt~~~~~~~~~~~~~772"
	. ;
	. SET POSTOTAL=0
	. ;
	. quit:((($$$INAUFPSource(POS1) = "") || ($$$INAUFPInvoiceNumber(POS1) '= "")) && (YBELEG = 7)) ; SR14152
	. ;
	. ;IF YBELEG=6!(YBELEG=5)!(YBELEG=7) IF $PIECE(POS1,Y,5)'<0 IF strInvDelivery=1 IF +$PIECE(POS1,Y,90)'=1 KILL YAUFTRAG(POS) QUIT   ;NUR AUSLIEFERUNGSFÄHIGE DRUCKEN;TYBD;27.07.2003;UL;TONY
	. ;IF YBELEG=6!(YBELEG=5)!(YBELEG=7) IF $GET(YTEST)'=1 IF $GET(YCOPY)'=1 IF $PIECE(POS1,Y,5)'<0 IF strInvDelivery=1 IF +$PIECE(POS1,Y,90)'=1 KILL YAUFTRAG(POS) QUIT   ;FIS;09.09.03
	. IF (YBELEG=6) || (YBELEG=5) || (YBELEG=7) IF $GET(YTEST)'=1 IF $GET(YCOPY)'=1 IF $GET(YPROFORMA)'=1 IF $PIECE(POS1,Y,5)'<0 IF $GET(VORKASSE)'=1 IF blnInvDelivery IF +$PIECE(POS1,Y,90)'=1 KILL YAUFTRAG(POS) QUIT   ;FIS;09.09.03
	. IF YBELEG=7 IF $GET(YTEST)'=1 IF $GET(YCOPY)'=1 IF $GET(YPROFORMA)'=1 IF $PIECE(POS1,Y,5)'<0 IF strInvDelivery=2 IF $GET(VORKASSE)'=1 IF $PIECE(POS1,Y,92)="" KILL YAUFTRAG(POS) QUIT   ;NUR GELIEFERTE DRUCKEN;FIS;28.06.04;25791
	. ;
	. ;PRUEFEN GESAMTDRUCK BEI RECHNUNG/GUTSCHRIFT/PROFORMARECHNUNG ;next to 
	. IF (YBELEG=7) || (YBELEG=17) || ($GET(YPROFORMA)=1) IF +$GET(YCOPY)'=1 IF $PIECE(POS1,Y,101)'="" KILL YAUFTRAG(POS)  QUIT   ;SCHON ÜBERTRAGEN ;yet transport 
	. IF YBELEG<11                   IF $PIECE(POS1,Y,9)=1    KILL YAUFTRAG(POS) QUIT  ;STORNO: KEIN DRUCK UND KEINE BUCHUNG ! ;no printing And no 
	. IF YBELEG<11 IF YBELEG'=7      IF $PIECE(POS1,Y,205)=1  KILL YAUFTRAG(POS) QUIT  ;GESPERRT: KEIN DRUCK UND KEINE BUCHUNG !;FIS;23466;RECHNUNG AUCH WENN GESPERRT
	. ;IF YBELEG<11                  IF $PIECE(POS1,Y,205)=1  KILL YAUFTRAG(POS) QUIT  ;GESPERRT: KEIN DRUCK UND KEINE BUCHUNG !
	. IF +$GET(YCOPY)'=1 IF YBELEG=3 IF $PIECE(POS1,Y,83)'="" KILL YAUFTRAG(POS) QUIT  ;DOPPELT: BESTELLUNG BEREITS GEDRUCKT ! ;sales order yet 
	. IF YBELEG'=1 IF YBELEG'=10     IF $PIECE(POS1,Y,60)=1   KILL YAUFTRAG(POS) QUIT  ;ABGESCHLOSSEN
	. ;
	. IF +$GET(YCOPY)'=1 DO SORT  ;SPEICHER DATEN,WENN NICHT WIEDERHOLUNGSDRUCK
	. ;
	. IF $GET(YSUMINVOICE)=1 SET ^WWWSOR(YUSER,"SUMINVOICE",YAUFTRAG,POS)=""  ;NEU SETZTEN POSITIONEN, DIE GEDRUCKT WERDEN
	. 
	. IF (YBELEG=3) || (YBELEG=10) || (YBELEG=13) DO  ;NUR BEI BESTELLUNGEN U. ANFRAGEN  !AUSFÜHRUNG NUR NACH "D SORT"
	. . IF $PIECE(YEKK,Y,30)="" DO  ;KEIN STEUERSATZ AUSGEWÄHLT;FIS;07.02.05
	. . . IF $PIECE(POS1,Y,4)'="" SET $PIECE(YEKK,Y,30)=$PIECE($GET(^INART(YM,$PIECE(POS1,Y,4),1)),Y,36)
	. . . // SR12992: Do not change tax code
	. . . ; IF $LENGTH($PIECE(YEKK,Y,30))=1 IF $DATA(^WWW101(0,"MWST",SPRACHE,"1"_$PIECE(YEKK,Y,30))) SET $PIECE(YEKK,Y,30)="1"_$PIECE(YEKK,Y,30)  ;UST -> VST
	. . ;
	. . IF +$PIECE(YEKK,Y,16)'=0 DO
	. . . SET $PIECE(POS1,Y,5)=$PIECE(YEKK,Y,16)  ;MENGE MIT UMRECHNUNGSFAKTOR ;quantity by means of 
	. . . IF $PIECE(YEKK,Y,18)'="" SET $PIECE(POS1,Y,40)=$PIECE(YEKK,Y,18)  ;MENGENEINHEIT MIT UMRECHNUNGSFAKTOR ;by means of 
	. . ;
	. . IF YWHR'=YWHR1 DO  ;FIS;26316;24.08.04;ANPASSEN UMRECHNUNGSFAKTOREN DER POSITIONEN
	. . . NEW YWHRF1
	. . . SET YWHRF1=""
	. . . IF YWHR=$PIECE(YAUFTRAG1,Y,51) SET YWHRF1=YWHRF              ;ORDER EXCHANGE RATE ;instalment 
	. . . IF YWHRF1="" SET YWHRF1=$PIECE(YEKK,Y,78)                    ;LINE ITEM EXCHANGE RATE ;ITEM instalment 
	. . . IF YWHRF1="" SET YWHRF1=$PIECE($GET(^WWWWAE(0,YWHR,1)),Y,5)  ;DFLT. EXCHANGE RATE ;instalment 
	. . . SET YWHRF=YWHRF1  ;NEW EXCHANGE RATE ;instalment 
	. . . IF +$PIECE(YEKK,Y,68)'=0 DO
	. . . . NEW YFELD,MENGE,YVOR,YFORM,YOK,NKOMMA
	. . . . SET YFELD=YEKK
	. . . . SET NKOMMA=$PIECE(YEKK,Y,25)  ;FIS;18.08.04;26250;ANZAHL NK-STELLEN
	. . . . IF (+NKOMMA=0) || (NKOMMA>9) SET NKOMMA=2
	. . . . SET $PIECE(YFELD,Y,47)=$JUSTIFY($PIECE(YFELD,Y,68)*YWHRF,0,NKOMMA)  ;UNIT PRICE
	. . . . SET MENGE=$PIECE(POS1,Y,5)
	. . . . IF +$PIECE(YFELD,Y,16)'=0 SET MENGE=$PIECE(YFELD,Y,16)  ;AB ODER RECHNUNGSEINGANGSMENGE ;Confirm. Or 
	. . . . IF +MENGE=0  SET MENGE=$PIECE(POS1,Y,5)
	. . . . IF +MENGE'=0 SET $PIECE(YFELD,Y,12)=$JUSTIFY($PIECE(YFELD,Y,47)*MENGE/$$^INQTYUNIT(,YAUFTRAG,POS),0,NKOMMA)
	. . . . IF +MENGE=0  SET $PIECE(YFELD,Y,12)=$JUSTIFY($PIECE(YFELD,Y,47),0,NKOMMA)
	. . . . SET $PIECE(YFELD,Y,13)=$$^INNETTO(YFELD)   ;RECHEN NETTO AUS BRUTTO FELD ;out of gr. field 
	. . . . SET $PIECE(YFELD,Y,78)=YWHRF
	. . . . IF YBELEG=3 SET $PIECE(YFELD,Y,79)=+$HOROLOG
	. . . . SET YEKK=YFELD
	. . . . IF YBELEG=3  IF $DATA(^INAUFPK(YM,YAUFTRAG,POS)) SET YOK=$$^WWWSPEI("INAUFPK",YAUFTRAG_","_POS,YFELD,1)
	. . . . IF YBELEG=10 IF $DATA(^INANGPK(YM,YAUFTRAG,POS)) SET YOK=$$^WWWSPEI("INANGPK",YAUFTRAG_","_POS,YFELD,1)
	. ;
	. DO POSUEB^INDRUCK6G  ;ÜBERSCHRIFT POSITIONSGRUPPEN ;superscription
	. ;
	. KILL POSSUM2
	. ;
	. DO ^INDRUCK6P  ;POSITIONEN
	. ;
	. IF $GET(YSAMMEL)'="" IF $DATA(POSSUM2) DO
	. . NEW MWPOX
	. . SET MWPOX=""
	. . FOR  SET MWPOX=$ORDER(POSSUM2(MWPOX)) QUIT:MWPOX=""  DO
	. . . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,POS,MWPOX)=POSSUM2(MWPOX)  ;FIS;09.03.05;27056;SUMME JE POSIITON
	. ;
	. IF YBELEG=3 IF $DATA(^INAUFPREL(YM,YAUFTRAG,POS)) DO ^INDRUCK6R  ;POSITIONEN RELIES
	. DO POSZWS^INDRUCK6G  ;ZWISCHENSUMME POSITIONSGRUPPEN ;subtotal 
	. ;
	. IF YBELEG'=3 SET POSTOTAL=$PIECE(POS1,Y,123)   ;WENN KEINE BESTELLUNG DANN TOTAL=VKTOTAL ;when no sales order 
	. ;
	. QUIT:$PIECE(YBELEG1,Y,187)=1  ;KEINE TEILE WENN POSITIONEN NICHT GEDRUCKT WERDEN ;no when Not will 
	. IF YBELEG=6 QUIT:$PIECE(POS1,Y,309)=1  ;KEIN LIEFERSCHEINDRUCK ;no 
	. ;
	. ; FIXME : 1) Why aren't we using $query here as so often used elsewhere?
	. ; 		   (doesn't limit us to 5 levels)
	. ; 		2) Why isn't SPE^INDRUCK called at last level?
	. ; 		3) YSPE is 80 spaces so why use $extract(   ,132)?         <GRF>
	. ;
	. SET TIEFE=$PIECE(YBELEG1,Y,38)   ;WEITERE ARTIKELTIEFE
	. IF YBELEG'=1 IF YBELEG'=10 IF TIEFE>1 DO  ; ARTIKELTIEFE  (NICHT BEI ANGEBOTEN) ;next to 
	. . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,""))=""   ;KEINE TEILE ;no 
	. . SET A=YSPE
	. . SET SPACE=2
	. . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . IF YA(2)="" SET YA(2)=0
	. . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	. . SET TEIL(1)=""
	. . FOR  SET TEIL(1)=$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1))) QUIT:TEIL(1)=""  DO
	. . . QUIT:TIEFE<2  ;TEIL IST ZU TIEF ;part within profound 
	. . . ;
	. . . SET POS1=$GET(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1)))
	. . . DO TEILE^INDRUCK6P(1)
	. . . ;
	. . . SET A=YSPE
	. . . QUIT:TIEFE<3 
	. . . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),""))=""   ;KEINE TEILE ;no 
	. . . SET SPACE=4
	. . . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . . IF YA(2)="" SET YA(2)=0
	. . . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . . DO SPE^INDRUCK
	. . . SET TEIL(2)=""
	. . . FOR  SET TEIL(2)=$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2))) QUIT:TEIL(2)=""  DO
	. . . . QUIT:TIEFE<3  ;TEIL IST ZU TIEF ;part within profound 
	. . . . ;
	. . . . SET POS1=$GET(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2)))
	. . . . DO TEILE^INDRUCK6P(2)
	. . . . ;
	. . . . SET A=YSPE
	. . . . QUIT:TIEFE<4 
	. . . . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),""))=""   ;KEINE TEILE ;no 
	. . . . SET SPACE=6
	. . . . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . . . IF YA(2)="" SET YA(2)=0
	. . . . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . . . DO SPE^INDRUCK
	. . . . SET TEIL(3)=""
	. . . . FOR  SET TEIL(3)=$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3))) QUIT:TEIL(3)=""  DO
	. . . . . QUIT:TIEFE<4  ;TEIL IST ZU TIEF ;part within profound 
	. . . . . ;
	. . . . . SET POS1=$GET(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3)))
	. . . . . DO TEILE^INDRUCK6P(3)
	. . . . . ;
	. . . . . SET A=YSPE
	. . . . . QUIT:TIEFE<5 
	. . . . . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),""))=""   ;KEINE TEILE ;no 
	. . . . . SET SPACE=8
	. . . . . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . . . . IF YA(2)="" SET YA(2)=0
	. . . . . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . . . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . . . . ;DO SPE^INDRUCK
	. . . . . SET TEIL(4)=""
	. . . . . FOR  SET TEIL(4)=$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4))) QUIT:TEIL(4)=""  DO
	. . . . . . QUIT:TIEFE<5  ;TEIL IST ZU TIEF ;part within profound 
	. . . . . . ;
	. . . . . . SET POS1=$GET(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4)))
	. . . . . . DO TEILE^INDRUCK6P(4)
	. . . . . . ;
	. . . . . . SET A=YSPE
	. . . . . . QUIT:TIEFE<6 
	. . . . . . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4),""))=""   ;KEINE TEILE ;no 
	. . . . . . SET SPACE=10
	. . . . . . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . . . . . IF YA(2)="" SET YA(2)=0
	. . . . . . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . . . . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . . . . . DO SPE^INDRUCK
	. . . . . . SET TEIL(5)="" FOR  SET TEIL(5)=$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4),TEIL(5))) QUIT:TEIL(5)=""  DO
	. . . . . . . QUIT:TIEFE<6  ;TEIL IST ZU TIEF ;part within profound 
	. . . . . . . ;
	. . . . . . . SET POS1=$GET(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4),TEIL(5)))
	. . . . . . . DO TEILE^INDRUCK6P(5)
	. . . . . . . ;
	. . . . . . . SET A=YSPE
	. . . . . . . QUIT:TIEFE<7 
	. . . . . . . QUIT:$ORDER(^INAUFPXL(YM,YAUFTRAG,POS,TEIL(1),TEIL(2),TEIL(3),TEIL(4),TEIL(5),""))=""   ;KEINE TEILE ;no 
	. . . . . . . SET SPACE=12
	. . . . . . . SET YA(2)=$PIECE(YBELEG1,Y,41)+SPACE   ;SPALTE ;column 
	. . . . . . . IF YA(2)="" SET YA(2)=0
	. . . . . . . SET YA(3)=$PIECE(YBELEG1,Y,37)  ;BESTEHEND AUS ;out of 
	. . . . . . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . . . . . . ;DO SPE^INDRUCK
	. . . . . . . ;HIER WEITER ;here is ulterior 
	. . ;
	. . SET A=YSPE DO SPE^INDRUCK 
	. ;
	. ;Barcode andrucken
	. SET A=YSPE
	. ;TEXT
	. SET YA(1)=$PIECE(YBELEG1,Y,172)  ;DRUCK 0/1  BARCODE ;printing 
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. IF YA(1)=1 DO                            ;ANZEIGEN  ;NICHT ANZEIGEN ;display Not display 
	. .;DO ^WWWBAR(YAUFTRAG_"-"_POS,"",20,1)   ;KEIN PRINT
	. . DO ^WWWBAR(YAUFTRAG_"-"_POS,"",11,1)   ;KEIN PRINT ;no 
	. . SET YA(3)="<IMG SRC="_""""_YGIF_"gif"_YAUFTRAG_"-"_POS_".gif"_""""_">"
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	. ;
	. IF +$PIECE(YBELEG1,Y,194)=1 IF $ORDER(YAUFTRAG(POS))'="" SET A=YSPE DO SPE^INDRUCK  ;LEERZEILE VOR POSITION ;blank line pre- 
	
	DO POSGRUP^INDRUCK6G
	
	SET POS1=""  ;KEINE POSITIONEN MEHR NUN GESAMT;16,2,2005;TYBD; WEGEN SAP SCHNITTSTELLE POS1="" 
	SET NETTOWW=0
	IF $GET(MWPO)'="" SET NETTOWW=+$GET(MWPO(MWPO))  ;NETTO-WARENWERT (OHNE ZUSATZKOSTEN)
	
	IF YBELEG'=1 IF YBELEG'=2 IF YBELEG'=7 IF YBELEG'=17 IF YBELEG'=12 IF YBELEG'=3 QUIT   ; NUR BEI ANGEBOT/ AB/ RECHUNG/ TEIZAHLUNGSRECHNUNG ;only next to 
	
	DO  ;PLATZHALTER FÜR GESAMTRABATT(INDRUCK7) EINSETZEN;FIS;18.08.04;26191
	. SET A=YTAB
	. NEW YACHTUNG
	. SET YACHTUNG=1
	. DO SPE^INDRUCK
	. SET RABATTZEILE=$GET(LFN)
	. SET RABATTSEITE=$GET(YSEITE)
	. IF $GET(YSUMINVOICE)'=1 DO SPE^INDRUCK  ;TYBD;10,2,2005
	
	;IF +YCOPY=0 IF YBELEG=7 IF $PIECE(YAUFTRAG1,Y,101)'="" QUIT  ;SCHON EINMAL GEDRUCKT WENN GESAMT BEI 2.TEILRECHNUNG KEINE BERECHNUNG;TYBD; AUS; 19,08,2003
	
	// SR12992: Do not re-compute MWPO
	set MWPO = $get(MWPO,1)
	/*
	DO  ;MWST KENNZIFFERN FÜR VP,FRACH,KM,PORTO
	. SET MWPO=1  ;DFLT. 1-16% UST
	. IF $PIECE(YADRES,Y,17)'="" IF $PIECE(YADRES,Y,17)'=$GET(YCOUNTRY) SET MWPO=0  ;KEIN DEUTSCHLAND ;no Germany 
	. IF $PIECE(YADRES,Y,50)'="" IF '$FIND($PIECE(YADRES,Y,50),$GET(YCOUNTRY)) SET MWPO=0  ;STEUERID AUSLAND ;foreign country 
	. IF $PIECE(YADRES,Y,54)'="" IF $PIECE(YADRES,Y,54)'=1 SET MWPO=0  ;KEINE STEUER ;no tax 
	. IF $PIECE(YADRES,Y,54)=2   IF $PIECE(YADRES,Y,50)="" SET MWPO=1  ;EG OHNE UST-ID = STEUER BERECHNEN ! (PRIVATPERSON);FIS;25.03.04 ;without tax calculate 
	*/
	
	SET MWPOX=MWPO
	
	;VERPACKUNG ;wrapping 							// JW SR11997: TODO
	SET YVERPACK=0
	DO  ;ERMITTELN STEUERSATZ;FIS;30.06.04;26024
	. NEW KEY
	. SET MWPO=""
	. SET KEY(1)=""
	. FOR  SET KEY(1)=$ORDER(^INVERPACK(YM,KEY(1)))  QUIT:KEY(1)=""  DO  QUIT:MWPO'=""
	. . SET KEY(2)=""
	. . FOR  SET KEY(2)=$ORDER(^INVERPACK(YM,KEY(1),KEY(2)))  QUIT:KEY(2)=""  DO  QUIT:MWPO'=""
	. . . SET KEY(3)=""
	. . . FOR  SET KEY(3)=$ORDER(^INVERPACK(YM,KEY(1),KEY(2),KEY(3)))  QUIT:KEY(3)=""  DO  QUIT:MWPO'=""
	. . . . SET MWPO=$PIECE($GET(^INVERPACK(YM,KEY(1),KEY(2),KEY(3),1)),Y,3)
	. ;
	. IF (MWPO="")||(MWPOX=0) SET MWPO=MWPOX
	
	;IF +$PIECE(YAUFTRAG1,Y,182)'=0 SET YVERPACK=$PIECE(YAUFTRAG1,Y,182)
	IF YBELEG'=12 IF YBELEG'=3 IF +$$$INAUFPackageAmount(YAUFTRAG1)'=0 DO
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,242)=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,292)=0 QUIT  ;BEREITS BERECHNET;TYBD; ;yet ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,242)=1  ;AUF BERECHNET SETZEN ;upon typeset ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. SET A=$EXTRACT(YSPE,1,70)
	. SET YVERPACK=$$$INAUFPackageAmount(YAUFTRAG1)
	. SET YVERPACK1=YVERPACK1+YVERPACK  ;SUMME;TYBD;31,1,2005
	. ;IF YCOPY=1 IF YBELEG=7!(YBELEG=17) SET YVERPACK=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,292)  ;TYBD;15,09,2003;24271
	. IF YCOPY=1 IF (YBELEG=7) || (YBELEG=17) SET YVERPACK=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,292)  ;BEC;03.11.04
	. IF (YBELEG=7) || (YBELEG=17) IF $GET(YPROFORMA)'=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,292)=YVERPACK  ;TYBD;15,09,2003;24271 ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. QUIT:+YVERPACK=0
	. DO SPE^INDRUCK  ;EINE ZEILE ZU VIEL;TYBD;10,2,2005
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(3)=YVERPACK
	. QUIT:+YA(3)=0
	. SET YA(99)=1
	. ;IF YBELEG=17 SET YA(99)=-1   ;GUTSCHRIFT - AUSGESCHALTET ! (IMMER BETRAG 1:1 ÜBERNEHMEN !) ;table-mat Sum assume 
	. SET MWPO(MWPO)=$GET(MWPO(MWPO))+(YA(3)*YA(99))   ;JE MWST ;once Tax 
	. SET YEXTRA=$GET(YEXTRA)+(YA(3)*YA(99))           ;EXTRAKOSTEN;FIS;26191;02.08.04
	. SET YA(3)=$$^WWWTEXT(32184)                      ;VERPACKUNG ;wrapping 
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,59)                   ;SPALTE ;column 
	. SET YA(3)=$$^WWWZAHL(YVERPACK*YA(99),12,2,YWHR)  ;VERPACKUNG BETRAG ;PACKING Sum 
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($$^WWWTEXT(32184),YVERPACK*YA(99))  ;TYBD;4,2,2005
	. ;
	. IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YVERPACK",MWPO)=YVERPACK
	
	;FRACHTKOSTEN
	SET YFRACHT=0
	DO  ;ERMITTELN STEUERSATZ;FIS;30.06.04;26024
	. NEW KEY
	. SET MWPO=""
	. SET KEY(1)=""
	. FOR  SET KEY(1)=$ORDER(^INTRANSPORT(YM,KEY(1)))  QUIT:KEY(1)=""  DO  QUIT:MWPO'=""
	. . SET KEY(2)=""
	. . FOR  SET KEY(2)=$ORDER(^INTRANSPORT(YM,KEY(1),KEY(2)))  QUIT:KEY(2)=""  DO  QUIT:MWPO'=""
	. . . SET KEY(3)=""
	. . . FOR  SET KEY(3)=$ORDER(^INTRANSPORT(YM,KEY(1),KEY(2),KEY(3)))  QUIT:KEY(3)=""  DO  QUIT:MWPO'=""
	. . . . SET MWPO=$PIECE($GET(^INTRANSPORT(YM,KEY(1),KEY(2),KEY(3),1)),Y,3)
	. ;
	. IF (MWPO="") || (MWPOX=0) SET MWPO=MWPOX
	
	;IF +$PIECE(YAUFTRAG1,Y,183)'=0 SET YFRACHT=$PIECE(YAUFTRAG1,Y,183)
	;IF YBELEG'=12 IF YBELEG'=3 IF +$PIECE(YAUFTRAG1,Y,183)'=0 DO
	IF YBELEG'=12 IF YBELEG'=3 IF +$$$INAUFFreightAmount($GET(YAUFTRAG1))'=0 DO    ;BEC;18.11.04
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,243)=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,293)=0 QUIT   ;BEREITS BERECHNET ;yet ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,243)=1  ;AUF BERECHNET SETZEN ;upon typeset ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. SET A=$EXTRACT(YSPE,1,70)
	. SET YFRACHT=$$$INAUFFreightAmount(YAUFTRAG1)
	. SET YFRACHT1=YFRACHT1+YFRACHT  ;TYBD;SUMME;31,1,2005
	. IF YCOPY=1 IF (YBELEG=7) || (YBELEG=17)    SET YFRACHT=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,293)          ;TYBD;15,09,2003;24271
	. IF (YBELEG=7) || (YBELEG=17) IF $GET(YPROFORMA)'=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,293)=YFRACHT  ;TYBD;15,09,2003;24271 ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. QUIT:+YFRACHT=0
	. DO SPE^INDRUCK
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(3)=YFRACHT
	. QUIT:+YA(3)=0
	. SET YA(99)=1
	. ;IF YBELEG=17 SET YA(99)=-1   ;GUTSCHRIFT - AUSGESCHALTET ! (IMMER BETRAG 1:1 ÜBERNEHMEN !) ;table-mat Sum assume 
	. SET MWPO(MWPO)=$GET(MWPO(MWPO))+(YA(3)*YA(99))  ;MWST ;Tax 
	. SET YEXTRA=$GET(YEXTRA)+(YA(3)*YA(99))          ;EXTRAKOSTEN;FIS;26191;02.08.04
	. SET YA(3)=$$^WWWTEXT(32186)                     ;FRACHT ;loading 
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,59)                  ;SPALTE ;column 
	. SET YA(3)=$$^WWWZAHL(YFRACHT*YA(99),12,2,YWHR)  ;VERSICHERUNG BETRAG ;insurance Sum 
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($$^WWWTEXT(32186),YFRACHT*YA(99))  ;TYBD;4,2,2005
	. ;
	. IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YFRACHT",MWPO)=YFRACHT
	
	;VERSICHERUNG ;insurance 
	SET YVERSICH=0
	DO  ;ERMITTELN STEUERSATZ;FIS;30.06.04;26024
	. NEW KEY
	. SET MWPO=""
	. SET KEY(1)=""
	. FOR  SET KEY(1)=$ORDER(^INVERSICH(YM,KEY(1)))  QUIT:KEY(1)=""  DO  QUIT:MWPO'=""
	. . SET KEY(2)=""
	. . FOR  SET KEY(2)=$ORDER(^INVERSICH(YM,KEY(1),KEY(2)))  QUIT:KEY(2)=""  DO  QUIT:MWPO'=""
	. . . SET KEY(3)=""
	. . . FOR  SET KEY(3)=$ORDER(^INVERSICH(YM,KEY(1),KEY(2),KEY(3)))  QUIT:KEY(3)=""  DO  QUIT:MWPO'=""
	. . . . SET MWPO=$PIECE($GET(^INVERSICH(YM,KEY(1),KEY(2),KEY(3),1)),Y,3)
	. ;
	. IF (MWPO="") || (MWPOX=0) SET MWPO=MWPOX
	
	;IF +$PIECE(YAUFTRAG1,Y,184)'=0 SET YVERSICH=$PIECE(YAUFTRAG1,Y,184)
	IF YBELEG'=12 IF YBELEG'=3 IF +$PIECE(YAUFTRAG1,Y,184)'=0  DO
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,244)=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,294)=0 QUIT   ;BEREITS BERECHNET ;yet ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,244)=1  ;AUF BERECHNET SETZEN ;upon typeset ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. SET A=$EXTRACT(YSPE,1,70)
	. SET YVERSICH=$PIECE(YAUFTRAG1,Y,184)
	. SET YVERSICH1=YVERSICH1+YVERSICH  ;TYBD;GESAMT
	. IF YCOPY=1 IF (YBELEG=7) || (YBELEG=17)   SET YVERSICH=$PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,294)     ;TYBD;15,09,2003;24271
	. IF (YBELEG=7) || (YBELEG=17) IF $GET(YPROFORMA)'=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,294)=YVERSICH  ;TYBD;15,09,2003;24271 ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. QUIT:+YVERSICH=0
	. DO SPE^INDRUCK
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(3)=YVERSICH
	. QUIT:+YA(3)=0
	. SET YA(99)=1
	. ;IF YBELEG=17 SET YA(99)=-1  ;GUTSCHRIFT - AUSGESCHALTET ! (IMMER BETRAG 1:1 ÜBERNEHMEN !) ;table-mat Sum assume 
	. SET MWPO(MWPO) = $GET(MWPO(MWPO))+(YA(3)*YA(99))        ;MWST ;Tax 
	. SET YEXTRA     = $GET(YEXTRA)    +(YA(3)*YA(99))        ;EXTRAKOSTEN;FIS;26191;02.08.04
	. SET YA(3)      = $$^WWWTEXT(32185)                      ;VERSICHERUNG ;insurance 
	. SET A          = $EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)      = $PIECE(YBELEG1,Y,59)                   ;SPALTE ;column 
	. SET YA(3)      = $$^WWWZAHL(YVERSICH*YA(99),12,2,YWHR)  ;VERSICHERUNG BETRAG ;insurance Sum 
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($$^WWWTEXT(32185),YVERSICH*YA(99))  ;TYBD;4,2,2005
	. ;
	. IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YVERSICH",MWPO)=YVERSICH
	
	;ENTFERNUNGSPAUSCHALE
	SET YKMGELD=0
	DO  ;ERMITTELN STEUERSATZ;FIS;30.06.04;26024 (STEUER KM-GELD WIE BEI TRANSPORTKOSTEN)
	. NEW KEY
	. SET MWPO=""
	. SET KEY(1)=""
	. FOR  SET KEY(1)=$ORDER(^INTRANSPORT(YM,KEY(1)))  QUIT:KEY(1)=""  DO  QUIT:MWPO'=""
	. . SET KEY(2)=""
	. . FOR  SET KEY(2)=$ORDER(^INTRANSPORT(YM,KEY(1),KEY(2)))  QUIT:KEY(2)=""  DO  QUIT:MWPO'=""
	. . . SET KEY(3)=""
	. . . FOR  SET KEY(3)=$ORDER(^INTRANSPORT(YM,KEY(1),KEY(2),KEY(3)))  QUIT:KEY(3)=""  DO  QUIT:MWPO'=""
	. . . . SET MWPO=$PIECE($GET(^INTRANSPORT(YM,KEY(1),KEY(2),KEY(3),1)),Y,3)
	. ;
	. IF (MWPO="") || (MWPOX=0) SET MWPO=MWPOX
	
	;IF +$PIECE(YAUFTRAG1,Y,185)'=0 SET YKMGELD=$PIECE(YAUFTRAG1,Y,185)
	IF YBELEG'=12 IF YBELEG'=3 IF +$PIECE(YAUFTRAG1,Y,185)'=0  DO
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,245)=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,295)=0 QUIT   ;BEREITS BERECHNET ;yet ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,245)=1  ;AUF BERECHNET SETZEN ;upon typeset ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. SET A=$EXTRACT(YSPE,1,70)
	. SET YKMGELD=$PIECE(YAUFTRAG1,Y,185)
	. SET YKMGELD1=YKMGELD1+YKMGELD
	. IF YCOPY=1 IF (YBELEG=7) || (YBELEG=17)    SET YKMGELD=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,295)          ;TYBD;15,09,2003;24271
	. IF (YBELEG=7) || (YBELEG=17) IF $GET(YPROFORMA)'=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,295)=YKMGELD  ;TYBD;15,09,2003;24271 ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. QUIT:+YKMGELD=0
	. DO SPE^INDRUCK
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(3)=YKMGELD
	. QUIT:+YA(3)=0
	. SET YA(99)=1
	. ;IF YBELEG=17 SET YA(99)=-1   ;GUTSCHRIFT - AUSGESCHALTET ! (IMMER BETRAG 1:1 ÜBERNEHMEN !) ;table-mat Sum assume 
	. SET YA(3)=$$^WWWTEXT(32187)  ;KM PAUSCHALE
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,57)   ;SPALTE ;column 
	. SET YA(3)=""
	. IF +$PIECE(YAUFTRAG1,Y,187)'=0 DO
	. . SET YA(3)=$PIECE(YAUFTRAG1,Y,187)_$$^WWWFELDNAME("INAUF","D",187)_" * "_$$^WWWZAHL($$$INVORGAmountPerKilometre(objINVORG),0,2)  ; D28 ;EINZELPREIS  ; 04-Sep-2006
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,59)   ;SPALTE ;column 
	. SET YA(3)=$$^WWWZAHL($PIECE(YAUFTRAG1,Y,187)*$$$INVORGAmountPerKilometre(objINVORG)*YA(99),12,2,YWHR)  ; D28 ;KM PAUSCHALE  ; 04-Sep-2006
	. IF +YKMGELD'=0 SET YA(3)=$$^WWWZAHL(YKMGELD,12,2,YWHR)   ;TYBD;15,09,2003
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)      ;EINSETZEN ;insert 
	. SET YA(3)=$PIECE(YAUFTRAG1,Y,187)*$$$INVORGAmountPerKilometre(objINVORG)     ; D28 ; 04-Sep-2006
	. IF +YKMGELD'=0 SET YA(3)=YKMGELD                                             ;TYBD;15,09,2003
	. SET MWPO(MWPO)=$GET(MWPO(MWPO))+(YA(3)*YA(99))    ;MWST ;Tax 
	. SET YEXTRA=$GET(YEXTRA)+(YA(3)*YA(99))            ;EXTRAKOSTEN;FIS;26191;02.08.04
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($$^WWWTEXT(32187),YKMGELD*YA(99))  ;TYBD;4,2,2005
	. ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. IF $GET(YSAMMEL)'="" SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YKMGELD",MWPO)=YKMGELD
	
	;SPEZIALZUSCHLAG
	SET YZUSCHLAG=0
	DO  ;ERMITTELN STEUERSATZ;FIS;30.06.04;26024
	. NEW KEY
	. SET MWPO=""
	. SET KEY(1)=""
	. FOR  SET KEY(1)=$ORDER(^INZUSCHLAG(YM,KEY(1)))  QUIT:KEY(1)=""  DO  QUIT:MWPO'=""
	. . SET KEY(2)=""
	. . FOR  SET KEY(2)=$ORDER(^INZUSCHLAG(YM,KEY(1),KEY(2)))  QUIT:KEY(2)=""  DO  QUIT:MWPO'=""
	. . . SET KEY(3)=""
	. . . FOR  SET KEY(3)=$ORDER(^INZUSCHLAG(YM,KEY(1),KEY(2),KEY(3)))  QUIT:KEY(3)=""  DO  QUIT:MWPO'=""
	. . . . SET MWPO=$PIECE($GET(^INZUSCHLAG(YM,KEY(1),KEY(2),KEY(3),1)),Y,3)
	. ;
	. IF (MWPO="") || (MWPOX=0) SET MWPO=MWPOX
	
	;IF +$PIECE(YAUFTRAG1,Y,211)'=0 SET YZ]]><![CDATA[USCHLAG=$PIECE(YAUFTRAG1,Y,211)
	IF YBELEG'=12 IF YBELEG'=3 IF +$PIECE(YAUFTRAG1,Y,211)'=0  DO
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) IF $PIECE($GET(^INAUF(YM,YAUFTRAG,1)),Y,246)=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,296)=0 QUIT  ;BEREITS BERECHNET ;yet  ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. IF YCOPY'=1 IF $GET(YPROFORMA)'=1 IF (YBELEG=7) || (YBELEG=17) SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,246)=1  ;AUF BERECHNET SETZEN ;upon typeset ;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. SET A=$EXTRACT(YSPE,1,70)
	. ;
	. // SR12988: Do not add surcharge here.
	. ; SET YZUSCHLAG=$PIECE(YAUFTRAG1,Y,211)
	. ; SET YZUSCHLAG1=YZUSCHLAG1+YZUSCHLAG
	. ; IF YCOPY=1 IF YBELEG=7!(YBELEG=17) SET YZUSCHLAG=$PIECE(^INAUF(YM,YAUFTRAG,1),Y,296)  ;TYBD;15,09,2003;24271
	. ; IF YBELEG=7!(YBELEG=17) IF $GET(YPROFORMA)'=1 SET $PIECE(^INAUF(YM,YAUFTRAG,1),Y,296)=YZUSCHLAG  ;TYBD;15,09,2003;24271;FIS;03.12.04;26944;NICHT BEI PROFORMA-RECHNUNG 
	. ; QUIT:+YZUSCHLAG=0
	. ;
	. DO SPE^INDRUCK
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(3)=$PIECE(YAUFTRAG1,Y,211)
	. QUIT:+YA(3)=0
	. SET YA(99)=1
	. ;IF YBELEG=17 SET YA(99)=-1   ;GUTSCHRIFT - AUSGESCHALTET ! (IMMER BETRAG 1:1 ÜBERNEHMEN !) ;table-mat Sum assume 
	. ;
	. // SR12988: Do not add surcharge here.
	. ; SET MWPO(MWPO)=$GET(MWPO(MWPO))+(YA(3)*YA(99))  ;MWST ;Tax 
	. ; SET YEXTRA=$GET(YEXTRA)+(YA(3)*YA(99))  ;EXTRAKOSTEN;FIS;26191;02.08.04
	. ;
	. set YA(3)=$select(+$PIECE(YAUFTRAG1,Y,211)>=0:"- ",1:"+ ")               ;SR13012: Choose correct sign
	. ;SET YA(3)=$PIECE(YAUFTRAG1,Y,210)                                       ;SPEZIALZUSCHLAG BEZEICHNUNG ;notation 
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,59)                                           ;SPALTE ;column
	. ;SR13012: Display discounts/surcharges correctly
	. SET YA(3)=$$^WWWZAHL($zabs($PIECE(YAUFTRAG1,Y,211))*YA(99),12,2,YWHR)    ;BETRAG ;Sum
	. ;SET YA(3)=$$^WWWZAHL($PIECE(YAUFTRAG1,Y,211)*YA(99),12,2,YWHR)          ;BETRAG ;Sum 
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($PIECE(YAUFTRAG1,Y,210),YZUSCHLAG*YA(99))                 ;TYBD;4,2,2005
	. ;
	. IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YZUSCHLAG",MWPO)=YZUSCHLAG
	
	SET MWPO=MWPOX
	
	;ZU/ABSCHLAG
	SET YZUABSCHLAG=0
	IF +$PIECE(YAUFTRAG1,Y,251)'=0 SET YZUABSCHLAG=$PIECE(YAUFTRAG1,Y,251)
	IF +$PIECE(YAUFTRAG1,Y,252)'=0 SET YZUABSCHLAG=YZUABSCHLAG+(($GET(MWPO(MWPO))/100)*$PIECE(YAUFTRAG1,Y,252))
	IF (YBELEG=3) || (YBELEG=13) IF YZUABSCHLAG'=0  DO
	. SET A=$EXTRACT(YSPE,1,70)
	. DO SPE^INDRUCK
	. SET A=YSPE
	. SET YA(2)=$PIECE(YBELEG1,Y,49)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=14
	. SET YA(99)=1
	. SET YA(3)=$$^WWWTEXT(32959)  ;Zu/Abschlag Betrag ;Surcharge/Allowance Amount 
	. IF +$PIECE(YAUFTRAG1,Y,251)'=0 SET YA(3)=YA(3)_" "_$$^WWWZAHL($PIECE(YAUFTRAG1,Y,251),0,2,YWHR)
	. IF +$PIECE(YAUFTRAG1,Y,251)'=0 IF +$PIECE(YAUFTRAG1,Y,252)'=0 SET YA(3)=YA(3)_" /"
	. IF +$PIECE(YAUFTRAG1,Y,252)'=0 SET YA(3)=YA(3)_" "_$PIECE(YAUFTRAG1,Y,252)_"%"
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(2)=$PIECE(YBELEG1,Y,59)   ;SPALTE ;column 
	. SET YA(3)=$$^WWWZAHL(YZUABSCHLAG,12,2,YWHR)  ;ZUSCHLAGE
	. DO
	. . NEW EURO
	. . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. ;
	. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. SET YA(3)=YZUABSCHLAG
	. SET YZUABSCHLAG1=YZUABSCHLAG1+YZUABSCHLAG             ;TYBD;31,1,2005
	. SET MWPO(MWPO)=$GET(MWPO(MWPO))+(YA(3)*YA(99))        ;MWST ;Tax 
	. DO SPE^INDRUCK
	. DO SAP^INDRUCK($$^WWWTEXT(32959),YZUABSCHLAG*YA(99))  ;TYBD;4,2,2005
	. ;
	. IF $GET(YSAMMEL)'="" DO  ;FIS;10.12.04;ZWISCHENSUMMEN FÜR KONTEN/KST-AUFLISTUNG IM RECHNUNGSSAMMELDRUCK
	. . SET ^WWWSOR(YUSER,"SAMMELPOS",YREF,YAUFTRAG,"YZUABSCHLAG",MWPO)=YZUABSCHLAG
	
	;----------------------------------AN ODER TEILZAHLUNGSRECHUNG---------
	IF YBELEG=12 DO
	. NEW MWSU
	. QUIT:$GET(YPZDATUM)=""
	. IF $DATA(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1))  SET YA(1)=1     ;DRUCK 0/1 ;printing 
	. IF '$DATA(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)) SET YA(1)=0     ;DRUCK 0/1 ;printing 
	. IF YA(1)=1 DO                                               ;ANZEIGEN ;give notice  ;display 
	. . ;VON INDRUCK.INT KOMMT-----YFELDPZ=$GET(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1))
	. . SET SUMME=0
	. . SET MWSU=""
	. . FOR  SET MWSU=$ORDER(MWPO(MWSU))  QUIT:MWSU=""  SET SUMME=SUMME+MWPO(MWSU)  ;SUMME NEU RECHNEN;FIS;24473;28.10.03
	. . ;IF $PIECE(YFELDPZ,Y,8)=1 SET SUMME=SUMME+YVERPACK+YKMGELD+YFRACHT+YVERSICH+YZUSCHLAG  ;KEINE ZUSATZKOSTEN;FIS;24473;11.11.03
	. . SET A=YSPE 
	. . SET A=$EXTRACT(YSPE,1,70)
	. . DO SPE^INDRUCK
	. . ;SET YA(2)=$PIECE(YBELEG1,Y,55)   ;SPALTE GESAMTWERT
	. . ;IF YA(2)="" SET YA(2)=22
	. . ;SET A=YSPE ;table-mat 
	. . ;SET YA(3)=$$^WWWTEXT(32059)      ;GESAMTWERT
	. . ;SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN 
	. . ;SET YA(2)=$PIECE(YBELEG1,Y,59)   ;SPALTE GESAMTWERT-BETRAG
	. . ;IF YA(2)="" SET YA(2)=63
	. . ;SET YA(3)=$$^WWWZAHL(GESAMT,12,2,YWHR)      ;GESAMTWERT--BETRAG
	. . ;SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN
	. . ;DO SPE^INDRUCK
	. . SET A=YSPE
	. . IF +$PIECE(YBELEG1,Y,40)'=0 DO
	. . . SET YA(2)=$PIECE(YBELEG1,Y,41)          ;SPALTE ZALHLUNG ;column 
	. . . IF YA(2)="" SET YA(2)=1
	. . . SET YA(3)=$$^WWWTEXT(32553,,1)_":"      ;FÄLLIG:
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . ;
	. . ;IF $PIECE(YFELDPZ,Y,4)'="" DO  ;SONDERZAHLUNGSTEXT
	. . ;. SET YA(2)=1
	. . ;. SET YA(3)=$E($PIECE(YFELDPZ,Y,4),1,21)
	. . ;. SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN
	. . ;
	. . SET YA(2)=$PIECE(YBELEG1,Y,55)   ;SPALTE ZALHLUNG WIE BEZEICHNUNG ;column such as notation 
	. . IF YA(2)="" SET YA(2)=22
	. . IF $PIECE(YFELDPZ,Y,1)=1  IF +$PIECE(YFELDPZ,Y,2)'=0                           SET YA(3)=$$^WWWTEXT(32330)      ;ANZAHLUNG ;down payment 
	. . IF $PIECE(YFELDPZ,Y,1)'=1 IF +$PIECE(YFELDPZ,Y,2)'=0                           SET YA(3)=$$^WWWTEXT(32469)      ;TEILZAHLUNG ;progress payment 
	. . IF $PIECE(YFELDPZ,Y,1)=1  IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELDPZ,Y,3),0,2)_" % "_$$^WWWTEXT(32330)      ; % ANZALHLUNG
	. . IF $PIECE(YFELDPZ,Y,1)'=1 IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELDPZ,Y,3),0,2)_" % "_$$^WWWTEXT(32469)     ; % TEILZALHLUNG
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . SET YA(2)=$PIECE(YBELEG1,Y,59)   ;SPALTE ZALHLUNG WIE GESAMTBETRAG ;column such as 
	. . IF YA(2)="" SET YA(2)=63
	. . IF +$PIECE(YFELDPZ,Y,2)'=0                           SET YA(3)=$$^WWWZAHL($PIECE(YFELDPZ,Y,2),12,2,YWHR)         ;ZALHLUNG--BETRAG     
	. . IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET YA(3)=$$^WWWZAHL(SUMME*$PIECE(YFELDPZ,Y,3)/100,12,2,YWHR)
	. . IF $GET(YPZDATUM)'="" IF $GET(YAUFTRAG)'="" IF $DATA(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1)) IF $GET(YCOPY)'=1 DO
	. . . IF +$PIECE(YFELDPZ,Y,2)'=0                           SET $PIECE(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1),Y,11)=$PIECE(YFELDPZ,Y,2)
	. . . IF +$PIECE(YFELDPZ,Y,2)=0 IF +$PIECE(YFELDPZ,Y,3)'=0 SET $PIECE(^INAUFPZ(YM,YAUFTRAG,YPZDATUM,1),Y,11)=SUMME*$PIECE(YFELDPZ,Y,3)/100
	. . ;
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	
	;RECHNENSVEREINBARUNG
	IF (YBELEG=1) || (YBELEG=2) || (YBELEG=12) DO  ;WENN ANGEBOT ;when proposition 
	. IF $PIECE(YBELEG1,Y,84)'=1 SET YA(1)=0
	. IF $PIECE(YBELEG1,Y,84)=1 IF YBELEG=1                  IF $DATA(^INANGPZ(YM,YAUFTRAG))  SET YA(1)=1  ;DRUCK 0/1 ;printing 
	. IF $PIECE(YBELEG1,Y,84)=1 IF YBELEG=1                  IF '$DATA(^INANGPZ(YM,YAUFTRAG)) SET YA(1)=0  ;DRUCK 0/1 ;printing 
	. IF $PIECE(YBELEG1,Y,84)=1 IF (YBELEG=2) || (YBELEG=12) IF $DATA(^INAUFPZ(YM,YAUFTRAG))  SET YA(1)=1  ;DRUCK 0/1 ;printing 
	. IF $PIECE(YBELEG1,Y,84)=1 IF (YBELEG=2) || (YBELEG=12) IF '$DATA(^INAUFPZ(YM,YAUFTRAG)) SET YA(1)=0  ;DRUCK 0/1 ;printing 
	. SET YA(2)=$PIECE(YBELEG1,Y,85)   ;SPALTE ;column 
	. IF YA(2)="" SET YA(2)=22
	. IF YA(1)=1 DO  ;ANZEIGEN ;give notice  ;display 
	. . SET A=YSPE 
	. . SET A=$EXTRACT(YSPE,1,70)
	. . DO SPE^INDRUCK
	. . ;
	. . SET A=YSPE
	. . SET YA(3)=$$^WWWTEXT(32333)_":"          ;Zahlungsvereinbarung: 
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	. . ;
	. . SET A=YSPE
	. . SET YA(2)=YA(2)
	. . SET YA(3)=$$^WWWTEXT(32331)              ;Zahlungsdatum /termin ;Payment date 
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . SET YA(2)=YA(2)+15
	. . SET YA(3)=$$^WWWTEXT(32332)              ;Zahlungsbetrag o. Anteil ;Payment Amount whack 
	. . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)   ;EINSETZEN ;insert 
	. . DO SPE^INDRUCK
	. . ;
	. . IF YBELEG=1 SET DATUM="" FOR  SET DATUM=$ORDER(^INANGPZ(YM,YAUFTRAG,DATUM)) QUIT:DATUM=""  DO
	. . . SET YFELD=$GET(^INANGPZ(YM,YAUFTRAG,DATUM,1))
	. . . SET A=YSPE
	. . . SET YA(2)=YA(2)-15
	. . . SET YA(3)=$$^WWWDATE(DATUM)
	. . . IF $PIECE(YFELD,Y,4)'="" DO  ;SONDERZAHLUNGSTEXT STATT DATUM ;Date 
	. . . . SET YA(2)=YA(2)+15-$LENGTH($PIECE(YFELD,Y,4))
	. . . . SET YA(3)=$PIECE(YFELD,Y,4)
	. . . ;
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)
	. . . IF $PIECE(YFELD,Y,4)'="" SET YA(2)=YA(2)-15+$LENGTH($PIECE(YFELD,Y,4))
	. . . SET YA(2)=YA(2)+15
	. . . IF +$PIECE(YFELD,Y,2)'=0 DO 
	. . . . SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,2),10,2,YWHR)
	. . . . IF $PIECE(YFELD,Y,2)<100 IF $LENGTH($PIECE($PIECE(YFELD,Y,2),".",2))>2 IF +$EXTRACT($PIECE($PIECE(YFELD,Y,2),".",2),3,9)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,2),9,3,YWHR)
	. . . ;
	. . . IF +$PIECE(YFELD,Y,2)=0 IF +$PIECE(YFELD,Y,3)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,3),14,2)_"&nbsp;%"
	. . . DO
	. . . . NEW EURO
	. . . . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . . . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. . . ;
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)
	. . . DO SPE^INDRUCK
	. . ;
	. . IF (YBELEG=2) || (YBELEG=12) SET DATUM="" FOR  SET DATUM=$ORDER(^INAUFPZ(YM,YAUFTRAG,DATUM)) QUIT:DATUM=""  DO
	. . . SET YFELD=$GET(^INAUFPZ(YM,YAUFTRAG,DATUM,1))
	. . . SET A=YSPE
	. . . SET YA(2)=YA(2)-15
	. . . SET YA(3)=$$^WWWDATE(DATUM)
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)
	. . . SET YA(2)=YA(2)+15
	. . . IF +$PIECE(YFELD,Y,2)'=0 DO 
	. . . . SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,2),10,2,YWHR)
	. . . . IF $PIECE(YFELD,Y,2)<100 IF $LENGTH($PIECE($PIECE(YFELD,Y,2),".",2))>2 IF +$EXTRACT($PIECE($PIECE(YFELD,Y,2),".",2),3,9)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,2),9,3,YWHR)
	. . . ;
	. . . IF +$PIECE(YFELD,Y,2)=0 IF +$PIECE(YFELD,Y,3)'=0 SET YA(3)=$$^WWWZAHL($PIECE(YFELD,Y,3),14,2)_"&nbsp;%"
	. . . DO
	. . . . NEW EURO
	. . . . SET EURO=$LENGTH(A,$$$hexstrEuro)-1
	. . . . IF EURO>0 SET YA(2)=YA(2)+(EURO*6)
	. . . ;
	. . . SET A=$EXTRACT(A,1,YA(2))_YA(3)_$EXTRACT(A,YA(2)+1+$LENGTH(YA(3)),132)
	. . . DO SPE^INDRUCK
	
	SET YVERPACK    = YVERPACK1      ;TYBD;31,1,2004;SUMMENRECHNUNG
	SET YFRACHT     = YFRACHT1       ;TYBD;31,1,2004;SUMMENRECHNUNG
	SET YVERSICH    = YVERSICH1      ;TYBD;31,1,2004;SUMMENRECHNUNG
	SET YKMGELD     = YKMGELD1       ;TYBD;31,1,2004;SUMMENRECHNUNG
	SET YZUSCHLAG   = YZUSCHLAG1     ;TYBD;31,1,2004;SUMMENRECHNUNG
	SET YZUABSCHLAG = YZUABSCHLAG1   ;TYBD;31,1,2004;SUMMENRECHNUNG
	QUIT
	
SORT
	;-------------------------------------------------------------------------------
	;   Call pre-save processing based on YBELEG value then update Quote or Order Line
	; 
	; By Ref:
	;    YPROFORMA
	;    YBELEG
	;    YAUFTRAG		idOrder
	;    POS			idLine
	;    POS1			objINAUFP, objINANGP
	;    YDATE
	;    YBED
	;-------------------------------------------------------------------------------
	NEW YFORM,YVORG
	
	QUIT:$GET(YTEST)'=""  ;NUR TEST ;only Test 
	DO @YBELEG            ;VERTEILEN AUF BELEGART ;distribute upon
	
	;SPEICHERN DATEN UND SORTKEY ;Save record
	IF (YBELEG=1) || (YBELEG=10) {                            ; 04-Sep-2006 ; else and braces
		SET YA=$$^WWWSPEI("INANGP",YAUFTRAG_","_POS,POS1,1)                         
	} else {
		IF $GET(YPROFORMA)'=1 SET YA=$$^WWWSPEI("INAUFP",YAUFTRAG_","_POS,POS1,1)
	}
	QUIT
	
1 ;ANGEBOT ;proposition 
	IF $PIECE(POS1,Y,79)="" SET $PIECE(POS1,Y,79)=YDATE                   ;GEDRUCKT AM ;to the 
	IF $PIECE(POS1,Y,80)="" SET $PIECE(POS1,Y,80)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,81)="" SET $PIECE(POS1,Y,81)=YBED                    ;GEDRUCKT VON
	QUIT
	
2 ;AB ;Confirm. 
	;BELEGNUMMER EINTRAGEN   ;NUMMER AUS AUFTRAG ;numeral out of order 
	if $PIECE(YAUFTRAG1,Y,78)'="" SET $PIECE(POS1,Y,78)=$PIECE(YAUFTRAG1,Y,78)    ; 04-Sep-2006 Rearrange to remove do level
 
	IF $PIECE(POS1,Y,78)="" SET $PIECE(POS11,Y,78)=YAUFTRAG               ;SPEICHERN ;Save 
	IF $PIECE(POS1,Y,79)="" SET $PIECE(POS1,Y,79)=YDATE                   ;GEDRUCKT AM ;to the 
	IF $PIECE(POS1,Y,80)="" SET $PIECE(POS1,Y,80)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,81)="" SET $PIECE(POS1,Y,81)=YBED                    ;GEDRUCKT VON
	QUIT
	
3 ;BESTELLUNG ;sales order 
	IF $PIECE(POS1,Y,83)="" SET $PIECE(POS1,Y,83)=+$HOROLOG               ;GEDRUCKT AM ;to the 
	IF $PIECE(POS1,Y,84)="" SET $PIECE(POS1,Y,84)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,85)="" SET $PIECE(POS1,Y,85)=YBED                    ;GEDRUCKT VON
	QUIT
	
4 ;
	QUIT
	
5 ;
	QUIT
	
6 ;LIEFERSCHEIN ;packing slip 
	IF YBELEG=6 QUIT:$PIECE(POS1,Y,309)=1  ;KEIN LIEFERSCHEINDRUCK ;no 
	DO  ;BELEGNUMMER ERRECHNEN
	. QUIT:$PIECE(YAUFTRAG1,Y,91)=""
	. SET $PIECE(POS1,Y,91)=$PIECE(YAUFTRAG1,Y,91)   ;NUMMER  AUS AUFTR ;numeral out of 
	
	IF $PIECE(POS1,Y,91)="" SET $PIECE(POS1,Y,91)=YAUFTRAG  ;SPEICHERN ;Save 
	IF $PIECE(POS1,Y,92)="" SET $PIECE(POS1,Y,92)=YDATE     ;GEDRUCKT AM ;to the 
	IF $$$INVORGPrintDeliveryNotesDistrib($GET(^INVORG(YM,YM,1)))=$$$YES SET $PIECE(POS1,Y,76)=YDATE    ; D40  ;AUSLIEFERUNGSDATUM
	IF YCOPY=1 SET YDATUM=$PIECE(POS1,Y,92)                 ;WENN WIEDERHOLUNG ;when repetition 
	IF $PIECE(POS1,Y,93)="" SET $PIECE(POS1,Y,93)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,94)="" SET $PIECE(POS1,Y,94)=YBED      ;GEDRUCKT VON
	QUIT
	
7 ;RECHNUNG ;tab 
	QUIT:$$$INAUFPrintDocumentsWithoutTota(YAUFTRAG1)=1 
	
	;BELEGNUMMER ERRECHNEN     ; NUMMER AUS AUFTRAG ;numeral out of order
	IF $PIECE(YAUFTRAG1,Y,96)'="" SET $PIECE(POS1,Y,96)=$PIECE(YAUFTRAG1,Y,96)    ; 04-Sep-2006 Rearrange to remove do level
	
	IF $PIECE(POS1,Y,96)="" SET $PIECE(POS1,Y,96)=YAUFTRAG  ;SPEICHERN ;Save 
	IF $PIECE(POS1,Y,97)="" SET $PIECE(POS1,Y,97)=YDATE  ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(POS1,Y,97) ;WENN WIEDERHOLUNG ;when repetition 
	IF $PIECE(POS1,Y,98)="" SET $PIECE(POS1,Y,98)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,99)="" SET $PIECE(POS1,Y,99)=YBED  ;GEDRUCKT VON
	DO  ;SETZEN UMSATZ ZEITRAUM;27153;FIS;17.01.05
	. NEW YKEY,YFELD
	. SET YKEY=YAUFTRAG_","_POS
	. SET YFELD=POS1
	. DO ^INAUFPVALDATE
	. SET POS1=YFELD
	QUIT
	
8 ;
	QUIT
	
9 ;BEREITSTELLUNG
	IF $PIECE(POS1,Y,87)="" SET $PIECE(POS1,Y,87)=+$HOROLOG               ;GEDRUCKT AM ;to the 
	IF YCOPY=1 SET YDATE=$PIECE(POS1,Y,87)                                ;WENN WIEDERHOLUNG ;when repetition 
	IF $PIECE(POS1,Y,88)="" SET $PIECE(POS1,Y,88)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,89)="" SET $PIECE(POS1,Y,89)=YBED                    ;GEDRUCKT VON
	QUIT
	
10 ;
	IF $PIECE(POS1,Y,83)="" SET $PIECE(POS1,Y,83)=+$HOROLOG               ;GEDRUCKT AM ;to the 
	IF $PIECE(POS1,Y,84)="" SET $PIECE(POS1,Y,84)=$PIECE($HOROLOG,",",2)  ;GEDRUCKT UM ;to 
	IF $PIECE(POS1,Y,85)="" SET $PIECE(POS1,Y,85)=YBED                    ;GEDRUCKT VON
	QUIT
	
11 ;
	QUIT
	
12 ;
	QUIT
	
13 ; 
	SET $PIECE(POS1,Y,9)=1
	IF $PIECE(POS1,Y,402)="" SET $PIECE(POS1,Y,402)=+$HOROLOG  ;GEDRUCKT AM ;to the  
	QUIT
	
14 ;
	QUIT
	
15 ;
	QUIT
	
16 ;
	QUIT
	
17 ;
	DO 7
	QUIT
	
18 ;
	QUIT             ; 04-Sep-2006
	
19 ;
	QUIT
	
	;-------------------------------------------------------------------------------
	
]]></Routine>
</Export>