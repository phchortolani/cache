<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="VARListaTrabalhoFarmacotecnica" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[VARListaTrabalhoFarmacotecnica
#include COMSYS
#include MEDConst
#include VARConst
#include INConst

#import VAR.infra.util

#define StatusAberta 0
#define StatusConfirmada 1
#define StatusManipulada 2
#define StatusCancelada 3
#define StatusDispensed 4

OnBeforeFormConstruction
	
	set objTemp = $get(^VARTempListaTrabFarTec(YM,YBED,1))
	
	set vData	  = $piece(objTemp,Y,4)
	set vOrderBy  = $piece(objTemp,Y,5)
	
	if (vData = "" && '$$isAfterSaveLogged^VARUtil(YBED,YFORM)){
		set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,4) = +$horolog
	}
	if (vOrderBy = ""){
		set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,5) = 1
	}
	
	$$$StartScript()
	&js<
		function maxlength(obj, val) {
			if ((obj.value.length &gt; 15) && (obj.rows == 1)) {
				obj.rows = 2;
			}
			else if ((obj.value.length &lt;= 15) && (obj.rows == 2)) {
				obj.rows = 1;
			}
			if (obj.value.length &gt; val) {
				obj.value = obj.value.substring(0, val);
			}
		}
	>
	$$$EndScript()
	
	quit

OnAfterSave
	
	kill ^VARTempListTrabFarmObs(YM,YBED)
	kill ^VARTempListTrabFarmF(YM,YBED)
	kill ^VARTempListTrabFarmCEF(YM,YBED)
	kill ^VARTempListTrabFarmLote(YM,YBED)
	kill ^VARTempListTrabFarmConfirm(YM,YBED)
	kill ^VARTempListTrabFarmQtyDose(YM,YBED)
	kill ^VARTempListTrabFarmUnitDose(YM,YBED)
	
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,1)  = $get(VORG(1))  ; Unidade de Atendimento
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,2)  = $get(VORG(2))  ; Produto
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,3)  = $get(VORG(3))  ; Paciente
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,4)  = $get(VORG(4))  ; Data
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,5)  = $get(VORG(5))  ; Ordenado Por
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,6)  = $get(VORG(6))  ; Exibir
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,7)  = $get(VORG(7))  ; Forma Farmacêutica
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,8)  = $get(VORG(8))  ; Status
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,9)  = $get(VORG(9))  ; Quartos
	set $piece(^VARTempListaTrabFarTec(YM,YBED,1),Y,10) = $get(VORG(10)) ; UO Conferida

	do VARLogAfterSave^VARUtil(YBED,YFORM)	
 	do GoToForm^COMUtilForm("VARListaTrabalhoFarmacotecnica",1,,,,,)
	
	quit

LastUDO(YM,pidDispense,pidLine)
	;-------------------------------------------------------------------------------
	; Determines the state of the UDO for the last dispense of the dispenses related to this presription
	;
	; Inputs: pidDispense - Dispense ID
	;
	; Returns:
	;
	; History:
	; 01-Feb-2013	shobby	HEVA-791.2:  Created
	;-------------------------------------------------------------------------------
	new objDispense,intMaxUDO,idPrescription,idxPrescription,idDispense,idDispenseLine,objDispenseLine
	
	set intMaxUDO=""
	if pidDispense'="" {
		set objDispense=$get(^MEDDispense(YM,pidDispense,1))
		set idPrescription=$$$MEDDispensePrescription(objDispense)
		if idPrescription'="" {
			set idxPrescription=$$$Index(idPrescription)
			set idDispense=$order(^MEDDispenses(YM,1,idxPrescription,""),-1)
			if idDispense'="" {
				set objDispenseLine=$get(^MEDDispenseLine(YM,idDispense,pidLine,1))
				set intMaxUDO=$$$MEDDispenseLineUDOInPreviousDispense(objDispenseLine)
			}	
		}
	}
	quit intMaxUDO
	
OnAfterDataFields
	; History:
	; 13-Aug-2014	SCR		HEAV-1585: Fixed Dispense Status
	; 13-Jun-2014	SCR		HEVA-1505: Added links to VARMEDDispenseMan
	; 13-Nov-2013	shobby	HEVA-1148: Show manipulated values in Item,Description and Lot.
	; 16-Oct-2013	shobby	HEVA-1148: Manipular column
	; 26-Sep-2013	shobby	HEVA-905: Some layout improvements.
	; 01-Feb-2013	shobby	HEVA-791.2:  Only report the UDO if the last dispense related to this item
	;									 is marked as UDO.
	//Só apresenta os resultados da consulta caso o usuário tenha clicado no botão 'Ok' do form.
	quit:('$$isAfterSaveLogged^VARUtil(YBED,YFORM))
	do ClearVARLogAterSave^VARUtil(YBED,YFORM)
	
	do PrintJS^VARListaTrabalhoFarmacotecnica()
	
	set objTemp = $get(^VARTempListaTrabFarTec(YM,YBED,1))
	
	set vUnidadeAtendimento = $piece(objTemp,Y,1)
	set vProduto 		  	= $piece(objTemp,Y,2)
	set vPaciente  	      	= $piece(objTemp,Y,3)
	set vData		  		= $piece(objTemp,Y,4)
	set vOrderBy 		  	= $piece(objTemp,Y,5)
	set vMedicamentos		= $piece(objTemp,Y,6)
	set vFFarmaceutica		= $piece(objTemp,Y,7)
	set vStatus				= $piece(objTemp,Y,8)
	set vQuartos			= $piece(objTemp,Y,9)
	set vUOConferida		= $piece(objTemp,Y,10)
	
	new item, descItem, dose, unidade, frequencia, via, validadoPor, paciente, nomePaciente, data, unidadeAtendimento, leito, dispensacao, lote, F, CEF, Obs, Line
 	set meuSQL = "SELECT "
  	set meuSQL = meuSQL_" MEDDispenseLine.ItemName as Item, "
  	set meuSQL = meuSQL_" $$SQLGetDescricaoProduto^VARSQL(Item) as DescItem, "
  	set meuSQL = meuSQL_" CASE WHEN $$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(Dispense,MEDDispenseLine.Line) = 1 THEN IssueQuantity ELSE DoseQuantity END as Dose,"
  	set meuSQL = meuSQL_" TRIM($$GetUnidadeMedida^VARListaTrabalhoFarmacotecnica(CASE WHEN $$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(Dispense,MEDDispenseLine.Line) = 1 THEN IssueUOM ELSE MEDDispenseLine.DoseUOM END)) as Unidade, "
  	//set meuSQL = meuSQL_" $$SQLGetSiglaUnit^VARSQL($$SQLGetUnitIdItem^VARSQL(Item)) as Unidade, "
  	set meuSQL = meuSQL_" $$GetFrequency^VARSQL(MEDDispenseLine.Frequency) as Frequencia, "
  	set meuSQL = meuSQL_" MEDDispenseLine.Route as Via, "
  	set meuSQL = meuSQL_" MEDDispenseLine.ValidatedBy as ValidadoPor, "
	
  	set meuSQL = meuSQL_" MEDPrescription.PatientID as Paciente, "
  	set meuSQL = meuSQL_" $$SQLGetPatientName^VARSQL(MEDPrescription.PatientID) as NomePaciente, " 
  	set meuSQL = meuSQL_" MEDDispenseLine.ValidatedOn as Data, "			
  	set meuSQL = meuSQL_" $$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID) as UnidadeAtendimento, "
  	set meuSQL = meuSQL_" $$SQLGetPatientBed^VARSQL(MEDPrescription.PatientID) as Leito, "
  	set meuSQL = meuSQL_" MEDDispense.Dispensation as Dispensacao, "
  	set meuSQL = meuSQL_" MEDDispenseLine.FREE1 as Lote, "
  	set meuSQL = meuSQL_" MEDDispenseLine.FREE2 as F, "
  	set meuSQL = meuSQL_" MEDDispenseLine.FREE3 as CEF, "
  	set meuSQL = meuSQL_" MEDDispenseLine.FREE4 as Obs, "
  	set meuSQL = meuSQL_" MEDDispenseLine.Line as Line, "
  	set meuSQL = meuSQL_" CASE WHEN $$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(Dispense,MEDDispenseLine.Line) = 1 THEN IssueUOM ELSE MEDDispenseLine.DoseUOM END as codUnidade, "
	set meuSQL = meuSQL_" MEDPrescriptionLine.Status as StatusProduto, "
  	set meuSQL = meuSQL_" MEDDispenseLine.FREE6 as Status "
	
  	set meuSQL = meuSQL_" FROM MEDDispense "
  	set meuSQL = meuSQL_" INNER JOIN MEDDispenseLine "
  	//set meuSQL = meuSQL_" ON MEDDispense.Company = MEDDispenseLine.Company AND MEDDispense.Dispensation = MEDDispenseLine.Dispense "
  	set meuSQL = meuSQL_" ON MEDDispense.Dispensation = MEDDispenseLine.Dispense "
  	set meuSQL = meuSQL_" LEFT JOIN MEDPrescription "
  	set meuSQL = meuSQL_" ON MEDPrescription.Company = MEDDispense.Company AND MEDPrescription.PrescriptionNumber = MEDDispense.Prescription "
  	set meuSQL = meuSQL_" LEFT JOIN INART "
  	set meuSQL = meuSQL_" ON MEDDispenseLine.Company = INART.Company AND MEDDispenseLine.ItemName = INART.ItemNumber "
	set meuSQL = meuSQL_" LEFT JOIN MEDPrescriptionLine ON INART.Company = MEDPrescriptionLine.Company "
	set meuSQL = meuSQL_" AND MEDDispense.Prescription = MEDPrescriptionLine.PrescriptionNumber "
	set meuSQL = meuSQL_" AND MEDDispenseLine.Line = MEDPrescriptionLine.Line "
	
  	set meuSQL = meuSQL_" WHERE "
  	set meuSQL = meuSQL_" MEDDispenseLine.Company = 0 "
  	set meuSQL = meuSQL_" AND %upper(MEDDispenseLine.UDO) = 1 "
  	set meuSQL = meuSQL_" AND MEDDispenseLine.ValidatedBy IS NOT NULL "
  	set meuSQL = meuSQL_" AND MEDPrescriptionLine.Status != 10 "
  	
  	if $$New^VARListaTrabalhoFarmacotecnicaSQL() set meuSQL=$$Get^VARListaTrabalhoFarmacotecnicaSQL()

  	if (vUnidadeAtendimento '= ""){
	  	set meuSQL = meuSQL_" AND $$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID) = '"_vUnidadeAtendimento_"' "
  	}
	
	if (vProduto '= ""){  	
		set meuSQL = meuSQL_" AND MEDDispenseLine.ItemName = '"_vProduto_"' "
	}
	
	if (vPaciente '= ""){
		set meuSQL = meuSQL_" AND MEDPrescription.PatientID = '"_vPaciente_"' "
	}
	
	if (vData '= ""){
		if $$New^VARListaTrabalhoFarmacotecnicaSQL() {
			set meuSQL = meuSQL_" AND ValidatedDate = '"_vData_"' "			
		} else {
			set meuSQL = meuSQL_" AND %upper(+ValidatedOn) = '"_vData_"' "
		}
	}
	
	if (vMedicamentos '= ""){
		if (vMedicamentos = 2){
			set meuSQL = meuSQL_" AND INART.FREE17 IS NOT NULL "
		}
		if (vMedicamentos = 3){
			set meuSQL = meuSQL_" AND INART.FREE17 IS NULL "
		}
	}
	
	if (vFFarmaceutica '= ""){
		if (vFFarmaceutica = 1){
			set meuSQL = meuSQL_" AND INART.FREE32 = '"_vFFarmaceutica_"' "
		}
		if (vFFarmaceutica = 2){
			set meuSQL = meuSQL_" AND INART.FREE32 IS NULL AND INART.FREE22 = 1 "
		}
	}
	
	if (vStatus '= ""){
		set meuSQL = meuSQL_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) = "_+vStatus
	}
	else {
		set meuSQL = meuSQL_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) <> '"_$$$StatusCancelada_"' "
	}
	
	if (vQuartos '= ""){
		if (vQuartos = 1){
			set meuSQL = meuSQL_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 2 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3) "
		}
		else {
			set meuSQL = meuSQL_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 1 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3)  "
		}
	}
	;HEVA-791.2 set meuSQL = meuSQL_" AND (MEDDispenseLine.UDOInPreviousDispense <> 1 or MEDDispenseLine.UDOInPreviousDispense is null) "
	set meuSQL = meuSQL_" AND $$LastUDO^VARListaTrabalhoFarmacotecnica(MEDDispenseLine.Company,MEDDispenseLine.Dispense,MEDDispenseLine.Line)=+UDOInPreviousDispense" ;HEVA-791.2
	
	if (vUOConferida '= ""){
		if (vUOConferida = "1"){
			set meuSQL = meuSQL_" AND MEDDispenseLine.FREE3 IS NOT NULL "	
		}
		else {
			set meuSQL = meuSQL_" AND MEDDispenseLine.FREE3 IS NULL "	
		}
	}
	
	
	if (vOrderBy = 2){
		set meuSQL = meuSQL_" ORDER BY CAST(MEDDispenseLine.ItemName AS INTEGER) "
	}
	elseif (vOrderBy = 3){
		set meuSQL = meuSQL_" ORDER BY $$SQLGetLocationName^VARSQL($$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID)) "
	}
	else {
		set meuSQL = meuSQL_" ORDER BY $$SQLGetDescricaoProduto^VARSQL(MEDDispenseLine.ItemName) "
	}
	
	set sqlCount = "SELECT COUNT(MEDDispense.ID) FROM "
	set sqlCount = sqlCount_" MEDDispense"
	set sqlCount = sqlCount_" INNER JOIN MEDDispenseLine "
	set sqlCount = sqlCount_" ON MEDDispense.Dispensation = MEDDispenseLine.Dispense "
	//set sqlCount = sqlCount_" ON MEDDispense.Company = MEDDispenseLine.Company AND MEDDispense.Dispensation = MEDDispenseLine.Dispense "
  	set sqlCount = sqlCount_" LEFT JOIN MEDPrescription "
  	set sqlCount = sqlCount_" ON MEDPrescription.PrescriptionNumber = MEDDispense.Prescription "
  	//set sqlCount = sqlCount_" ON MEDPrescription.Company = MEDDispense.Company AND MEDPrescription.PrescriptionNumber = MEDDispense.Prescription "
  	set sqlCount = sqlCount_" LEFT JOIN INART "
  	set sqlCount = sqlCount_" ON MEDDispenseLine.Company = INART.Company AND MEDDispenseLine.ItemName = INART.ItemNumber "
	set sqlCount = sqlCount_" LEFT JOIN MEDPrescriptionLine ON INART.Company = MEDPrescriptionLine.Company "
	set sqlCount = sqlCount_" AND MEDDispense.Prescription = MEDPrescriptionLine.PrescriptionNumber "
	set sqlCount = sqlCount_" AND MEDDispenseLine.Line = MEDPrescriptionLine.Line "
  	set sqlCount = sqlCount_" WHERE "
  	set sqlCount = sqlCount_" MEDDispenseLine.Company = 0 "
  	set sqlCount = sqlCount_" AND %upper(MEDDispenseLine.UDO) = 1 "
  	set sqlCount = sqlCount_" AND MEDDispenseLine.ValidatedBy IS NOT NULL "
  	set sqlCount = sqlCount_" AND MEDPrescriptionLine.Status != 10 "
   	if $$New^VARListaTrabalhoFarmacotecnicaSQL() set sqlCount=$$GetCount^VARListaTrabalhoFarmacotecnicaSQL()
 	
  	if (vUnidadeAtendimento '= ""){
	  	set sqlCount = sqlCount_" AND $$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID) = '"_vUnidadeAtendimento_"' "
  	}
	
	if (vProduto '= ""){  	
		set sqlCount = sqlCount_" AND MEDDispenseLine.ItemName = '"_vProduto_"' "
	}
	
	if (vPaciente '= ""){
		set sqlCount = sqlCount_" AND MEDPrescription.PatientID = '"_vPaciente_"' "
	}
	
	if (vData '= ""){
		if $$New^VARListaTrabalhoFarmacotecnicaSQL() {
			set sqlCount = sqlCount_" AND ValidatedDate = '"_vData_"' "			
		} else {
			set sqlCount = sqlCount_" AND %upper(+ValidatedOn) = '"_vData_"' "
		}
	}
	
	if (vMedicamentos '= ""){
		if (vMedicamentos = 2){
			set sqlCount = sqlCount_" AND INART.FREE17 IS NOT NULL "
		}
		if (vMedicamentos = 3){
			set sqlCount = sqlCount_" AND INART.FREE17 IS NULL "
		}
	}
	
	if (vFFarmaceutica '= ""){
		if (vFFarmaceutica = 1){
			set sqlCount = sqlCount_" AND INART.FREE32 = '"_vFFarmaceutica_"' "
		}
		if (vFFarmaceutica = 2){
			set sqlCount = sqlCount_" AND INART.FREE32 IS NULL AND INART.FREE22 = 1 "
		}
	}
	
	if (vStatus '= ""){
		set sqlCount = sqlCount_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) = "_+vStatus
	}
	else {
		set sqlCount = sqlCount_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) <> '"_$$$StatusCancelada_"' "
	}
	
	if (vQuartos '= ""){
		if (vQuartos = 1){
			set sqlCount = sqlCount_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 2 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3) "
		}
		else {
			set sqlCount = sqlCount_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 1 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3)  "
		}
	}
	;HEVA-791.2 set meuSQL = meuSQL_" AND (MEDDispenseLine.UDOInPreviousDispense <> 1 or MEDDispenseLine.UDOInPreviousDispense is null) "
	set sqlCount = sqlCount_" AND $$LastUDO^VARListaTrabalhoFarmacotecnica(MEDDispenseLine.Company,MEDDispenseLine.Dispense,MEDDispenseLine.Line)=+UDOInPreviousDispense" ;HEVA-791.2
	
	if (vUOConferida '= ""){
		if (vUOConferida = "1"){
			set sqlCount = sqlCount_" AND MEDDispenseLine.FREE3 IS NOT NULL "	
		}
		else {
			set sqlCount = sqlCount_" AND MEDDispenseLine.FREE3 IS NULL "	
		}
	}
	
	
	set qtdLinhas = +$$$VARParametroClienteQuantidadedelinhasnapagin(^VARParametroCliente(YM,YM,1))
	set pagination = ##Class(Pagination).%New(qtdLinhas)
	#Dim ListaTrabalho As PaginationResultSet
	
	set ListaTrabalho = pagination.ExecuteQuery(,sqlCount,meuSQL)
	//Tabela
   	new lstHeader
 	set lstHeader = $listbuild("Cód.","Produto","Paciente","Quarto","Leito","Dose","Freq/dia","Via","Lote","Obs.","F","CEF","Etiqueta","Cancelar","Confirmar","Manipular","Status","Val.","Dispensação","Data","Triagem","Unidade") ;HEVA-1148
 	
	do pagination.PrintNavigationBar(ListaTrabalho,"SAVE")
  	if $$Start^COMTable(lstHeader) {
		
		While (ListaTrabalho.Next()) {
			set item       			= ListaTrabalho.GetData(1)
			set descItem   			= ListaTrabalho.GetData(2)
			set dose       			= ListaTrabalho.GetData(3)
			set unidade    			= ListaTrabalho.GetData(4)
			set frequencia 			= ListaTrabalho.GetData(5)
			set via		   			= ListaTrabalho.GetData(6)
			set validadoPor			= ListaTrabalho.GetData(7)
			set paciente   			= ListaTrabalho.GetData(8)
			set nomePaciente 		= ListaTrabalho.GetData(9)
			set data				= ListaTrabalho.GetData(10)
			set unidadeAtendimento 	= ListaTrabalho.GetData(11)
			set leito				= ListaTrabalho.GetData(12)
			set dispensacao			= ListaTrabalho.GetData(13)
			set Lote				= ListaTrabalho.GetData(14)
			set F					= ListaTrabalho.GetData(15)
			set CEF					= ListaTrabalho.GetData(16)
			set Obs					= ListaTrabalho.GetData(17)
			set Line				= ListaTrabalho.GetData(18)
			set codUnidade			= ListaTrabalho.GetData(19)
			set statusProduto		= ListaTrabalho.GetData(20)
			set statusDispensacao	= +ListaTrabalho.GetData(21)
			
			set itemOriginal = item

			new strHintItem,strHintDesc
			
			set strHintItem=""
			set strHintDesc=""
			set idDispenseMan=""
			&sql(select Dispense into :idDispenseMan from SQLUser.MEDDispenseLine 
				where %upper(UDODispense) =:dispensacao and %upper(UDODispenseLine) =:Line)
	    	if (statusDispensacao=$$$StatusManipulada)||(+statusDispensacao = $$$StatusDispensed) ]]><![CDATA[{ ;HEVA-1148 vvvvvv
		    	new idMagistral,objMagistral
				if (dispensacao'="")&&(Line'="") {
					set idMagistral=$order(^VARManipulacaoMagistrals(YM,1,$$$Index(dispensacao),$$$Index(Line),""))
					if idMagistral'="" {
						set objMagistral=$get(^VARManipulacaoMagistral(YM,idMagistral,1))
						if objMagistral'="" {
							if $$$VARManipulacaoMagistralItem(objMagistral)'="" {
								set strHintItem="Manipulado de "_item
								set strHintDesc="Manipulado de "_descItem
								set item=$$$VARManipulacaoMagistralItem(objMagistral)
								set objItem = $get(^INART(0,item,1))
								set descItem=$$$INARTSearchName(objItem)
								set Lote=$$$VARManipulacaoMagistralLot(objMagistral)
							}
						}
					}
				}
	    	}  ;HEVA-1148 ^^^^^

			if (data = ""){
				set data = ""
			}
			else {
				set data = $$SQLGetFormatDate7^VARSQL(+data)
			}
			
			//Insere a coluna "Imprimir" com um link para o relatório de etiquetas
			
			set ImprimirEtq = "<a href=""javascript:CallBack('ImprimirEtq^VARListaTrabalhoFarmacotecnica','"_$$JSESC^WWWENCODE(dispensacao)_"','"_$$JSESC^WWWENCODE(itemOriginal)_"','"_$$JSESC^WWWENCODE(paciente)_"','"_$$JSESC^WWWENCODE(Line)_"');"">Imprimir</a>"
			
			do NewLine^COMTable()

			new prefixStyle, sufixStyle
			set prefixStyle = ""
			set sufixStyle 	= ""
			
			if (statusProduto = 6){
				set prefixStyle = "<font color=gray style=text-decoration:line-through><span title = 'Medicamento Suspenso'>"
				set sufixStyle = "</span></font>"	
			}

	    	if statusDispensacao=$$$StatusManipulada ||(+statusDispensacao = $$$StatusDispensed) {
		    	do InsertCell^COMTable("<font color='blue' title='"_strHintItem_"'>"_prefixStyle_item_sufixStyle_"</font>",,,,"CENTER",,,,,$$$NO)
	    	} else {
		    	do InsertCell^COMTable(prefixStyle_item_sufixStyle,,,,"CENTER",,,,,$$$NO)
	    	}
	    	if statusDispensacao=$$$StatusManipulada ||(+statusDispensacao = $$$StatusDispensed) {
		    	do InsertCell^COMTable("<font color='blue' title='"_strHintDesc_"'>"_$$SQLGetDescQuebraLinha^VARSQL(descItem,27)_"</font>",,,,,,,,,$$$NO)		    	
	    	} elseif (statusProduto = 6){    	
	    		do InsertCell^COMTable(prefixStyle_$$SQLGetDescQuebraLinha^VARSQL(descItem,27)_sufixStyle,,,,,,,,,$$$NO)
	    	} else {
		    	do InsertCell^COMTable("<font color='red'>"_$$SQLGetDescQuebraLinha^VARSQL(descItem,27)_"</font>",,,,,,,,,$$$NO)
	    	}
	    	do InsertCell^COMTable(prefixStyle_paciente_" - "_$$SQLGetDescQuebraLinha^VARSQL(nomePaciente,27)_sufixStyle,,,,,,,,,$$$NO)
			do InsertCell^COMTable(prefixStyle_$$SQLGetPatientRoom^VARSQL(paciente)_sufixStyle,,,,"CENTER")
	    	do InsertCell^COMTable(prefixStyle_leito_sufixStyle,,,,"CENTER")
	    	do InsertCell^COMTable($$GetQuantidadeDose(dispensacao,Line,statusProduto)_$$GetUnidadeDose(item,codUnidade,dispensacao,Line,statusProduto),,,,"CENTER")
	    	do InsertCell^COMTable(prefixStyle_frequencia_sufixStyle,,,,"CENTER")
	    	do InsertCell^COMTable(prefixStyle_via_sufixStyle,,,,"CENTER")
	    	if (statusDispensacao=$$$StatusManipulada)||(+statusDispensacao = $$$StatusDispensed) { ;HEVA-1148
		    	do InsertCell^COMTable("<font color='blue'>"_Lote_"</font>",,,,"CENTER")
	    	} else { 
	    		if ($get(Lote) '= "") {
		    		do InsertCell^COMTable("<font color='blue'>"_Lote_"</font>",,,,"CENTER")		
	    		} else {	
		    		do InsertCell^COMTable($$GetLote(dispensacao,Line,statusProduto),,,,"CENTER")
	    		}
	    	}
	    	do InsertCell^COMTable($$GetInfo(dispensacao,Line,statusProduto),,,,"CENTER")
	    	do InsertCell^COMTable($$GetF(dispensacao,Line,statusProduto,idDispenseMan),,,,"CENTER")
	    	do InsertCell^COMTable($$GetCEF(dispensacao,Line,statusProduto,idDispenseMan),,,,"CENTER")
			set strHintConf = ""
			set strHintCanc = ""
	    	if (statusProduto = 6) {
		    	do InsertCell^COMTable(prefixStyle_"Imprimir"_sufixStyle,,,,"CENTER")
				do InsertCell^COMTable(prefixStyle_"<img src="_YGIF_"small_x.gif border=0 style=""filter: Alpha(opacity=50) gray();""  />"_sufixStyle,,,,"CENTER")
				do InsertCell^COMTable(prefixStyle_"<img src="_YGIF_"small_check.gif border=0 style=""filter: Alpha(opacity=50) gray();""  />",,,,"CENTER")
				do InsertCell^COMTable("<center><a><img src="_YGIF_"thumbs_up.gif border=0 title="""_strHintConf_"""  style=""filter: Alpha(opacity=50) gray();"" /></a></center>") ;HEVA-1148.1
		    	
		    	do InsertCell^COMTable($$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_statusDispensacao),,,,"CENTER")
		    	do InsertCell^COMTable(prefixStyle_"48h"_sufixStyle,,,,"CENTER")
		    	do InsertCell^COMTable(prefixStyle_dispensacao_sufixStyle,,,,"CENTER")
		    	do InsertCell^COMTable(prefixStyle_data_sufixStyle,,,,"CENTER")
		    	do InsertCell^COMTable(prefixStyle_"DOSE SUSPENSA"_sufixStyle,,,,"CENTER")
		    	do InsertCell^COMTable(prefixStyle_unidadeAtendimento_" - "_$$SQLGetLocationName^VARSQL(unidadeAtendimento)_sufixStyle,,,,"CENTER")
	    	} else {
	    		do InsertCell^COMTable(ImprimirEtq,,,,"CENTER")
				if (+statusDispensacao = $$$StatusConfirmada) {
					set strHintConf = "Este medicamento já foi confirmado"
					set strHintCanc = "Este medicamento encontra-se confirmado e não pode mais ser cancelado"
				}
				elseif (+statusDispensacao = $$$StatusCancelada) {
					set strHintConf = "Este medicamento encontra-se cancelado e não pode mais ser confirmado"
					set strHintCanc = "Este medicamento já foi cancelado"
				}
				if (+statusDispensacao = $$$StatusAberta) {
					set pstrText = "<img onClick=""if (confirm('Você desejar cancelar esta Ordem de Unitarização?')) {CallBackNow('GravarStatusOnClick^VARListaTrabalhoFarmacotecnica','"_dispensacao_"','"_Line_"','"_$$$StatusCancelada_"')};"" src="_YGIF_"small_x.gif border=0 title=""Cancelar"" style=""cursor:pointer;"" />"
					do InsertCell^COMTable(pstrText,,,,"CENTER")

					set pstrText = "<img onClick=""CallBackNow('GravarStatusOnClick^VARListaTrabalhoFarmacotecnica','"_dispensacao_"','"_Line_"','"_$$$StatusConfirmada_"');"" src="_YGIF_"small_check.gif border=0 title=""Confirmar"" style=""cursor:pointer;"" />"
					do InsertCell^COMTable(pstrText,,,,"CENTER")
				}
				else {
					do InsertCell^COMTable("<center><img src="_YGIF_"small_x.gif border=0 title="""_strHintCanc_""" style=""filter: Alpha(opacity=50) gray();""  /></center>")
					do InsertCell^COMTable("<center><img src="_YGIF_"small_check.gif border=0 title="""_strHintConf_""" style=""filter: Alpha(opacity=50) gray();""  /></center>")

				}
				;do InsertCell^COMTable("<center><img src="_YGIF_"thumbs_up.gif border=0 title="""_strHintConf_""" style=""filter: Alpha(opacity=50) gray();""  /></center>") ;HEVA-1148
				if (+statusDispensacao = $$$StatusConfirmada)||(+statusDispensacao = $$$StatusManipulada)||(+statusDispensacao = $$$StatusDispensed) {																										;HEVA-905
					do InsertCell^COMTable("<center><a href=""javascript:CallBackNow('Load^VARManipulacaoMagistral','"_dispensacao_"','"_Line_"');""><img src="_YGIF_"thumbs_up.gif border=0 title="""_strHintConf_"""  /></a></center>") ;HEVA-1148
				} else {
					do InsertCell^COMTable("<center><a><img src="_YGIF_"thumbs_up.gif border=0 title="""_strHintConf_"""  style=""filter: Alpha(opacity=50) gray();"" /></a></center>") ;HEVA-1148
				}
				/*
				if (+statusDispensacao = $$$StatusConfirmada)||(+statusDispensacao = $$$StatusManipulada) {																										;HEVA-905
		    		do InsertCell^COMTable("<font color='blue'>"_$$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_statusDispensacao)_"<font>",,,,"CENTER") ;HEVA-905 
				} elseif (+statusDispensacao = $$$StatusCancelada) {																								;HEVA-905
		    		do InsertCell^COMTable("<font color='red'>"_$$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_statusDispensacao)_"<font>",,,,"CENTER") 	;HEVA-905 
				} else {																																			;HEVA-905
		    		do InsertCell^COMTable($$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_statusDispensacao),,,,"CENTER") 								;HEVA-905	
				}
				*/
				set strStatus	= $$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_statusDispensacao)
				if idDispenseMan'="" {
					set objDispenseMan	= $get(^MEDDispense(YM,idDispenseMan,1))
					if $$$MEDDispenseStatusManual(objDispenseMan) = 1 {
						set strStatus	= $$$Text("VAR8893")  ;Dispense Created
					} elseif $$$MEDDispenseStatusManual(objDispenseMan) = 2 {
						set strStatus	= $$$Text("VAR8894")  ;Dispense Ready
					} else {
						set strStatus	= $$$Text("VAR8895")  ;Dispense Processed
					}
				}
				if (+statusDispensacao = $$$StatusConfirmada)||(+statusDispensacao = $$$StatusManipulada)||(+statusDispensacao = $$$StatusDispensed) {																										;HEVA-905
		    		set strStatus	= "<font color='blue'>"_strStatus_"<font>"
				} elseif (+statusDispensacao = $$$StatusCancelada) {																								;HEVA-905
		    		set strStatus	= "<font color='red'>"_strStatus_"<font>"
				}
				if idDispenseMan'="" {
					set strStatus	= "<a href=""javascript:CallBackNow('Load^VARMEDDispenseMan','"_idDispenseMan_"');"">"_strStatus_"</a>"
				}
		    	do InsertCell^COMTable(strStatus,,,,"CENTER")

				do InsertCell^COMTable("48h",,,,"CENTER")
	    		do InsertCell^COMTable(dispensacao,"MEDDispense",dispensacao,,"CENTER")
	    		do InsertCell^COMTable(data,,,,"CENTER")
	    		do InsertCell^COMTable($$SQLGetUserNameOuCodigo^VARSQL(validadoPor),,,,"CENTER")
	    		do InsertCell^COMTable(unidadeAtendimento_" - "_$$SQLGetLocationName^VARSQL(unidadeAtendimento),,,,"LEFT") ;HEVA-905
	    	}	    	  		    
			
	     	do EndLine^COMTable()
		}
		
		if (ListaTrabalho.TotalRows = 0) {
			do NewLine^COMTable()
			do InsertCell^COMTable("Nenhum registro encontrado.",,,,,,19)
			do EndLine^COMTable()	

		}
		
		do Stop^COMTable()	
  	}
	do ListaTrabalho.Close()
	
	quit
	
Imprimir()

	set objTemp = $get(^VARTempListaTrabFarTec(YM,YBED,1))
	
	set vUnidadeAtendimento = $piece(objTemp,Y,1)
	set vProduto 		  	= $piece(objTemp,Y,2)
	set vPaciente  	      	= $piece(objTemp,Y,3)
	set vData		  		= $piece(objTemp,Y,4)
	set vOrderBy 		  	= $piece(objTemp,Y,5)
	set vMedicamentos		= $piece(objTemp,Y,6)
	set vFFarmaceutica		= $piece(objTemp,Y,7)
	set vStatus				= $piece(objTemp,Y,8)
	set vQuartos			= $piece(objTemp,Y,9)
	set vUOConferida		= $piece(objTemp,Y,10)
	
	new pFiltro, pOrderBy
	
	set pFiltro 	= ""
	set pOrderBy 	= ""
	
	set pUnidadeAtendimento = "Todas"
	set pProduto 			= "Todos"
	set pPaciente			= "Todos"
	set pData				= "Todas"
	set pMedicamentos		= ""
	set pFFarmaceutica 		= ""
	set pStatus				= "Todas"
	set pQuartos			= "Todos"
	set pUOConferida		= ""
	
  	if (vUnidadeAtendimento '= ""){
	  	set pFiltro = pFiltro_" AND $$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID) = '"_vUnidadeAtendimento_"' "
	  	set pUnidadeAtendimento = vUnidadeAtendimento_" - "_$$SQLGetLocationName^VARSQL(vUnidadeAtendimento)
  	}
  		set pFiltro = pFiltro_" AND MEDPrescriptionLine.Status != 10 " 
	
	if (vProduto '= ""){  	
		set pFiltro = pFiltro_" AND MEDDispenseLine.ItemName = '"_vProduto_"' "
		set pProduto = vProduto_" - "_$$SQLGetDescricaoProduto^VARSQL(vProduto)
	}
	
	if (vPaciente '= ""){
		set pFiltro = pFiltro_" AND MEDPrescription.PatientID = '"_vPaciente_"' "
		set pPaciente = vPaciente_" - "_$$SQLGetPatientName^VARSQL(vPaciente)
	}
	
	if (vData '= ""){
		set pFiltro = pFiltro_" AND %upper(+ValidatedOn) = '"_vData_"' "
		set pData = $$SQLGetFormatDate7^VARSQL(vData)
	}
	
	if (vMedicamentos '= ""){
		set pMedicamentos = $$SQLGetUserParamDescVAR^VARSQL("LISTAFARMMEDICAMENTOS~"_vMedicamentos)
		if (vMedicamentos = 2){
			set pFiltro = pFiltro_" AND INART.FREE17 IS NOT NULL "
		
		}
		if (vMedicamentos = 3){
			set pFiltro = pFiltro_" AND INART.FREE17 IS NULL "
		}
	}
	
	if (vFFarmaceutica '= ""){
		set pFFarmaceutica = $$SQLGetUserParamDescVAR^VARSQL("VARFORMAFARMACEUTICA~"_vFFarmaceutica)
		if (vFFarmaceutica = 1){
			set pFiltro = pFiltro_" AND INART.FREE32 = '"_vFFarmaceutica_"' "
		}
		if (vFFarmaceutica = 2){
			set pFiltro = pFiltro_" AND INART.FREE32 IS NULL AND INART.FREE22 = 1 "
		}
	}
	
	if (vStatus '= ""){
		set pFiltro = pFiltro_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) = "_+vStatus
		set pStatus = $$SQLGetUserParamDescVAR^VARSQL("MEDDISPENSELINESTATUS"_Y_vStatus)
	}
	else {
		set pFiltro = pFiltro_" AND $$SQLGetNumerico^VARSQL(MEDDispenseLine.FREE6) <> '"_$$$StatusCancelada_"' "
	}

	if (vQuartos '= ""){
		set pQuartos = $$SQLGetUserParamDescVAR^VARSQL("LISTAFARMLEITOS~"_vQuartos)
		if (vQuartos = 1){
			set pFiltro = pFiltro_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 2 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3) "
		}
		else {
			set pFiltro = pFiltro_" AND ($$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 1 OR $$SQLGetImparPar^VARSQL($$SQLGetPatientRoom^VARSQL(MEDPrescription.PatientID)) = 3)  "
		}
	}
	set pFiltro = pFiltro_" AND $$LastUDO^VARListaTrabalhoFarmacotecnica(MEDDispenseLine.Company,MEDDispenseLine.Dispense,MEDDispenseLine.Line)=+UDOInPreviousDispense"

	if (vUOConferida '= ""){
		if (vUOConferida = "1"){
			set pFiltro = pFiltro_" AND MEDDispenseLine.FREE3 IS NOT NULL "	
			set pUOConferida = "Sim"
		}
		else {
			set pFiltro = pFiltro_" AND MEDDispenseLine.FREE3 IS NULL "	
			set pUOConferida = "Não"			
		}
	}

	if (vOrderBy = 2){
		set pOrderBy = pOrderBy_" ORDER BY CAST(MEDDispenseLine.ItemName AS INTEGER) "	
	}
	elseif (vOrderBy = 3){
		set pOrderBy = pOrderBy_" ORDER BY $$SQLGetLocationName^VARSQL($$SQLGetPatientLocation^VARSQL(MEDPrescription.PatientID)) "
	}
	else {
		set pOrderBy = pOrderBy_" ORDER BY $$SQLGetDescricaoProduto^VARSQL(MEDDispenseLine.ItemName) "
	}
	
	do RunReportListaTrabalhoFarmacotecnica^VARJasperRunReportContinuacao(pFiltro,pOrderBy,pUnidadeAtendimento,pProduto,pPaciente,pData,pMedicamentos,pFFarmaceutica,pStatus,pQuartos,pUOConferida)
	
	quit
	
ImprimirEtq(dispensacao,item,paciente,Line)
	
	do RunReportEtqFarmacotecnica^VARJasperRunReportContinuacao(dispensacao,item,paciente,Line)
	
	quit

Salvar()
	set obj = $order(^VARTempListTrabFarm(YM,YBED))
	
	if ($data(obj)= 10 || $data(obj) = 1){
		do AtualizaObs()
		do AtualizaF()
		do AtualizaCEF()
		do AtualizaLote()
		do AtualizaQtyDose()
		do AtualizaUnitDose()
		kill ^VARTempListTrabFarmObs(YM,YBED)
		kill ^VARTempListTrabFarmF(YM,YBED)
		kill ^VARTempListTrabFarmCEF(YM,YBED)
		kill ^VARTempListTrabFarmLote(YM,YBED)
		kill ^VARTempListTrabFarmConfirm(YM,YBED)
		kill ^VARTempListTrabFarmQtyDose(YM,YBED)
		kill ^VARTempListTrabFarmUnitDose(YM,YBED)
	}
	
	do VARLogAfterSave^VARUtil(YBED,YFORM)	
	do GoToForm^COMUtilForm("VARListaTrabalhoFarmacotecnica",1,,,,,)
	
	quit

GetUnidadeMedida(unidade)
	new unidadeDesc, unidadeDescComp
	set unidadeDesc			= $Get(^WWW101(0,"EINHEIT","PT",unidade,1))
	set unidadeDescComp     = $piece(unidadeDesc,"-",1)
	
	quit unidadeDescComp
	
GetQuantidadeDose(pDispense,pLine,pStatus)
	
	new objMEDDispenseLine, str, key, doseQty
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine
	
	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)
	
	if ($$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(pDispense,pLine) = 1){
		set doseQty = $$$MEDDispenseLineIssueQuantity(objMEDDispenseLine)
	}
	else {
		set doseQty = $$$MEDDispenseLineDoseQuantity(objMEDDispenseLine)
	}
	
	set js = "onchange='EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"","""_"GravarQtyDoseOnChange^VARListaTrabalhoFarmacotecnica"_""","""_key_""",""6"",this.value);'"
	
	set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='6' maxlength = '6' style=""color: red;"" style=""text-align: right;"" value='"_$$^WWWTR(0,12,doseQty)_"'"_js_">"

	if ((pStatus = 6) || ($$GetStatus(pDispense,pLine) = $$$StatusCancelada)) { // Status Suspenso ou status da linha cancelada, desabilita o campo
		set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='6' maxlength = '6' disabled style=""color: red;"" style=""text-align: right;"" value='"_$$^WWWTR(0,12,doseQty)_"'"_js_">"
	}
	
	quit str

GetUnidadeDose(idItem, idUnitRef, pDispense, pLine, pStatus)

	new idUnitSel, idUnit, unidade, select, found, objMEDDispenseLine, str, key
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine	
	
	set idUnitSel = $$LoadUnitOfMeasureList^INARTUtilities(idItem)
]]><![CDATA[	
	set idUnit = ""
	set found = 0]]><![CDATA[
	
	set js = "onchange='EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"","""_"GravarUnitDoseOnChange^VARListaTrabalhoFarmacotecnica"_""","""_key_""",""6"",this.value);'"

	set select = "<select id=cb"_((glngRow*100)+glngColumn)_" "_js_" style=""width:80"" style=""color: red;"">"
	
	if ((pStatus = 6) || ($$GetStatus(pDispense,pLine) = $$$StatusCancelada)) {
		set select = "<select id=cb"_((glngRow*100)+glngColumn)_" "_js_" style=""width:80"" disabled style=""color: red;"">"	
	}
	
	for YI(1)=1:1 {
		set idUnit = $order(^COMTempList(0,idItem,"UOM",idUnit))
		quit:idUnit=""
		set unidade = $$GetUnidadeMedida(idUnit)

		if ((idUnitRef '= "") && (found = 0)){
			set select = select_"<option selected value="""_idUnitRef_""">"_$$GetUnidadeMedida(idUnitRef)_"</option>"
			set found = 1
		}
		continue:(idUnit = idUnitRef)
		set select = select_ "<option value="""_idUnit_""">"_unidade_"</option>"
	}
	
	set select = select_ "</select>"
	
	quit select

GetInfo(pDispense,pLine, pStatus)

	new objMEDDispenseLine, key

	if ((pDispense="")||(pLine="")) quit ""

	set key = pDispense_","_pLine

	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)	

	if ($length($$$MEDDispenseLineFREE4(objMEDDispenseLine))=0) quit "<img id='Obs"_pLine_"_"_pDispense_"' style=""cursor: pointer;"" onClick=""gravaObs('"_key_"');"" width='20' height='20' src='"_YGIF_"info_desabilitado.gif'>"
	
	set Valor = $$$MEDDispenseLineFREE4(objMEDDispenseLine)
	//set objTemp = $get(^VARTempListTrabFarmObs(YM,YBED,pDispense,pLine))
	//if ($$$MEDDispenseLineFREE4(objTemp) '= "") set Valor = $$$MEDDispenseLineFREE4(objTemp)
	
	quit "<img id='Obs"_pLine_"_"_pDispense_"' style=""cursor: pointer;"" onClick=""gravaObs('"_key_"');"" width='20' height='20' src='"_YGIF_"information.gif' title='"_Valor_"'>"
	//quit "<img style=""cursor: pointer;"" onClick=""gravaObs('"_key_"');"" width='20' height='20' src='"_YGIF_"information.gif' title='"_$$$MEDDispenseLineFREE4(objMEDDispenseLine)_"'>"

GetF(pDispense,pLine,pStatus,pidDispenseMan)
    ;-------------------------------------------------------------------------------------------------------
	;
	; History:
	; 19-Sep-2014	SCR		HEVA-1505: Open before checked and Locked after
	;-------------------------------------------------------------------------------------------------------

	new objMEDDispenseLine, str, key
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine
	
	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)
	
	set js = "onchange='EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"","""_"GravarFOnChange^VARListaTrabalhoFarmacotecnica"_""","""_key_""",""6"",this.value);'"
	
	set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='10' maxlength = '10' value='"_$$$MEDDispenseLineFREE2(objMEDDispenseLine)_"'"_js_">"
	if ((pStatus = 6) || (($$GetStatus(pDispense,pLine) '= $$$StatusAberta))) || (pidDispenseMan'="") {
		set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='10' disabled maxlength = '10' value='"_$$$MEDDispenseLineFREE2(objMEDDispenseLine)_"'>"
	}
	quit str

GetCEF(pDispense,pLine,pStatus,pidDispenseMan)
	;-------------------------------------------------------------------------------------------------------
	;
	; History:
	; 15-Aug-2014	SCR		HEVA-1505: keep open once the status is manipulada
	;-------------------------------------------------------------------------------------------------------

	
	new objMEDDispenseLine, str, key
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine
	
	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)
	
	set js = "onchange='EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"","""_"GravarCEFOnChange^VARListaTrabalhoFarmacotecnica"_""","""_key_""",""6"",this.value);'"
	
	set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='10' maxlength = '10' value='"_$$$MEDDispenseLineFREE3(objMEDDispenseLine)_"'"_js_">"
	
	if ((pStatus = 6) || (($$GetStatus(pDispense,pLine) '= $$$StatusConfirmada) && ($$GetStatus(pDispense,pLine) '= $$$StatusManipulada))) || (pidDispenseMan'="") {
		set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='10' disabled maxlength = '10' value='"_$$$MEDDispenseLineFREE3(objMEDDispenseLine)_"'>"
	}
	quit str

GetLote(pDispense,pLine, pStatus)
	
	new objMEDDispenseLine, str, key
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine
	
	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)
	
	set rows = 1
	if ($length($$$MEDDispenseLineFREE1(objMEDDispenseLine)) > 15) {
		set rows = 2
	}
	set disabled = ""
	if ((pStatus = 6) || ($$GetStatus(pDispense,pLine) = $$$StatusCancelada)){
		set disabled = "disabled"
	}
	
	set js = "onchange='EventValue("""_YUCI_""","""_YUSER_""","""_YFORM_""",""FIX"","""_"GravarLoteOnChange^VARListaTrabalhoFarmacotecnica"_""","""_key_""",""6"",this.value);'"
	
	set str = "<textarea "_js_" "_disabled_" id='cb"_((glngRow*100)+glngColumn)_"' onkeyup=""maxlength(this,30);"" cols='15' rows= '"_rows_"' style='overflow:hidden;' >"_$$$MEDDispenseLineFREE1(objMEDDispenseLine)_"</textarea>"
	
    if ((pStatus = 6) || (($$GetStatus(pDispense,pLine) = $$$StatusConfirmada))){
		set str = "<input type=text id=cb"_((glngRow*100)+glngColumn)_" size='10' disabled maxlength = '10' value='"_$$$MEDDispenseLineFREE1(objMEDDispenseLine)_"'>"
	}
	
	quit str
	
GetStatus(pDispense,pLine)
	
	new objMEDDispenseLine, key
	
	if ((pDispense="")||(pLine="")) quit ""
	
	set key = pDispense_","_pLine
	
	set objMEDDispenseLine = ^MEDDispenseLine(0,pDispense,pLine,1)
	
	quit $$$MEDDispenseLineFREE6(objMEDDispenseLine)
	
PrintJS()
	 
	write !, "<script language=""javascript"">"
	&js<
	
	function gravaObs(key) {		
	 	CallBackNow("GravarObsOnClickJS^VARListaTrabalhoFarmacotecnica", key);
	}
	 
	>
	write !, "</script>"
	quit
	
GravarObsOnClickJS(pKey)
	;-------------------------------------------------------------------------------------------------------
	;
	; History:
	; 26-Sep-2013	shobby	HEVA-905: Replaced modal screen with popup panel
	;-------------------------------------------------------------------------------------------------------

	new objMEDDispenseLine, pDispense, pLine
	
	set pDispense = $piece(pKey,",",1)
	set pLine	  = $piece(pKey,",",2)
 	
	if ($length($get(pDispense)) = 0 || $length($get(pLine)) = 0) {
		set objMEDDispenseLine = ""
	}
	else {
		set objMEDDispenseLine = $get(^MEDDispenseLine(0,pDispense,pLine,1))
	}
	
	new HTML,btnNo,btnYes
	set HTML=$$Popup(pKey,.btnNo,.btnYes)
	do Show^WWWPopupMessage(HTML,"Observaçoes",,,,$$$NO,.btnNo,.btnYes)
	;HEVA-905 &js<
	;HEVA-905     var value = confirmPrompt('#(pKey)#');
	;HEVA-905     var keyObs = '#(pKey)#'+","+value
	;HEVA-905   
	;HEVA-905 	if (value){
	;HEVA-905 		//alert(value);
	;HEVA-905 		CallBackNow("GravarObsOnClick^VARListaTrabalhoFarmacotecnica", keyObs, value);
	;HEVA-905 	}
	;HEVA-905 	
	;HEVA-905 > 
	;HEVA-905 
	;HEVA-905 &js<	
	;HEVA-905 function confirmPrompt(pKey){
	;HEVA-905 		var settings = "dialogWidth: 470px; dialogHeight: 255px; center: yes; " +
	;HEVA-905 			"edge: sunked; scroll: yes; status: no; ";
	;HEVA-905 		
	;HEVA-905 		eval('var url ="#(YAKTION)#EP=WWWFORM&YFORM=VARTempObsListFarmacotenica&YKEY='+pKey+'&YUSER=#(YUSER)#&YBED=#(YBED)#"');
	;HEVA-905 		if(window.showModalDialog){
	;HEVA-905 			return window.showModalDialog(url,"name",settings);
	;HEVA-905 		}
	;HEVA-905 	}
	;HEVA-905 > 
	quit
	
GravarObsOnClick(pKey,pValue)
	
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmObs(YM,YBED,pDispense,pLine) = $piece(pValue,"-",2)
	
	
	//***********************************	
	set Valor = $piece(pValue,"-",2)	
	&js<
		document.getElementById("Obs"+#(pLine)#+"_"+"#(pDispense)#").title = "#(Valor)#";
	>
	
	quit ""
	
GravarFOnChange(pKey,pValue)
	
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmF(YM,YBED,pDispense,pLine) = pValue
	
	quit ""
	
GravarCEFOnChange(pKey,pValue)
	
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmCEF(YM,YBED,pDispense,pLine) = pValue
	
	quit ""
	
GravarLoteOnChange(pKey,pValue)
	
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmLote(YM,YBED,pDispense,pLine) = pValue
	
	quit ""
	
GravarStatusOnClick(pDispense="",pLine="", status="")
	;-------------------------------------------------------------------------------
	; History:
	; 07-Jul-2014	SCR		HEVA-1506: Set Prescription status to Awaiting Validation when canceled
	;-------------------------------------------------------------------------------
	new objMEDDispenseLine, obj, strStatus,objDisp,idRx,objRxLine
	
	set strStatus = $$$OK
	
	set objMEDDispenseLine = $get(^MEDDispenseLine(YM,pDispense,pLine,1))
	if ($length(objMEDDispenseLine) > 0) {
		set $$$MEDDispenseLineFREE6(objMEDDispenseLine) = +status
		set strStatus = $$$Save("MEDDispenseLine",pDispense_$$$COMMA_pLine,objMEDDispenseLine,1)
	}
	if ($$$ISOK(strStatus)) && ( status=$$$StatusCancelada ){
		set objDisp		= $get(^MEDDispense(YM,pDispense,1))
		set idRx		= $$$MEDDispensePrescription(objDisp)
		if idRx'="" {
			set objRxLine	= $get(^MEDPrescriptionLine(YM,idRx,pLine,1))
			set $$$MEDPrescriptionLineStatus(objRxLine)	= 1
			set strStatus = $$$Save("MEDPrescriptionLine",idRx_$$$COMMA_pLine,objRxLine,1)
			if ($$$ISOK(strStatus)){
				set strStatus=$$UpdateRxStatus^MEDPrescriptionAutoClose(idRx) ; update Rx status
			}
		}
	}
	if ($$$ISOK(strStatus)) {
		set obj = $order(^VARTempListTrabFarm(YM,YBED))

		if ($data(obj) > 0){
			do AtualizaObs()
			do AtualizaF()
			do AtualizaCEF()
			do AtualizaLote()
			do AtualizaQtyDose()
			do AtualizaUnitDose()
			kill ^VARTempListTrabFarmObs(YM,YBED)
			kill ^VARTempListTrabFarmF(YM,YBED)
			kill ^VARTempListTrabFarmCEF(YM,YBED)
			kill ^VARTempListTrabFarmLote(YM,YBED)
			kill ^VARTempListTrabFarmConfirm(YM,YBED)
			kill ^VARTempListTrabFarmQtyDose(YM,YBED)
			kill ^VARTempListTrabFarmUnitDose(YM,YBED)
		}
	}

	if ($$$ISOK(strStatus)) {
		do VARLogAfterSave^VARUtil(YBED,YFORM)	
		do GoToForm^COMUtilForm("VARListaTrabalhoFarmacotecnica",1,,,,,)
	}
 
    quit

GravarQtyDoseOnChange(pKey,pValue)
	
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmQtyDose(YM,YBED,pDispense,pLine) = $$^WWWTR($$$YES,8,pValue)
	
	quit ""
	
GravarUnitDoseOnChange(pKey,pValue)
	new pDispense, pLine, pParam
	
	set pDispense = $piece(pKey,$$$COMMA,1)
	set pLine	  = $piece(pKey,$$$COMMA,2)
	
	set ^VARTempListTrabFarmUnitDose(YM,YBED,pDispense,pLine) = pValue
	
	quit ""

CheckMedAlternativo(pDispense,pLine)
	
	new objMEDDispense, objMEDDispenseLine, objMEDPrescriptionLine
	
	if ((pDispense="")||(pLine="")) quit $$$NO
	
	set objMEDDispense = $get(^MEDDispense(0,pDispense,1))
	set objMEDDispenseLine = $get(^MEDDispenseLine(0,pDispense,pLine,1))
	if $$$MEDDispensePrescription(objMEDDispense)="" quit $$$NO
	set objMEDPrescriptionLine = $get(^MEDPrescriptionLine(0,$$$MEDDispensePrescription(objMEDDispense),pLine,1))

	if ($$$MEDDispenseLineItemName(objMEDDispenseLine) '= $$$MEDPrescriptionLineItem(objMEDPrescriptionLine)){
		quit $$$YES
	}
	quit $$$NO	

	;HEVA-905 OnAfterButtonLine(pDispensacao)
	;HEVA-905 //utilizado no form modal VARTempObsListFarmacotenica
	;HEVA-905 ; History
	;HEVA-905 ;
	;HEVA-905 ; 26-Sep-2013	shobby	HEVA-905: Replaced by Popup
	;HEVA-905 
	;HEVA-905 new objMEDDispenseLine, pDispense, pLine, Obs, disabled
	;HEVA-905 set pDispense 	= $piece(pDispensacao,$$$COMMA,1)
	;HEVA-905 set pLine	  	= $piece(pDispensacao,$$$COMMA,2)
	;HEVA-905 set pPrescricao = $$$MEDDispensePrescription($get(^MEDDispense(YM,pDispense,1)))
	;HEVA-905 set disabled 	= ""
	;HEVA-905 
	;HEVA-905 set status = $$$MEDPrescriptionLineStatus($get(^MEDPrescriptionLine(YM,pPrescricao,pLine,1)))
	;HEVA-905 set objMEDDispenseLine = $get(^MEDDispenseLine(0,pDispense,pLine,1))
	;HEVA-905 
	;HEVA-905 set Obs  = $$TrimSpaces^COMUtilStr($piece($$$MEDDispenseLineFREE4(objMEDDispenseLine),"|",2))
	;HEVA-905 set cObs = $piece($$$MEDDispenseLineFREE4(objMEDDispenseLine),"|",1)
	;HEVA-905 
	;HEVA-905 if (status = 6){
	;HEVA-905 	set disabled = "disabled"
	;HEVA-905 }
	;HEVA-905 
	;HEVA-905 new combo, comboHeader, comboDetail, comboFooter, comboObs
	;HEVA-905 
	;HEVA-905 set comboObs    = ""
	;HEVA-905 set comboHeader = "<select id='pObs' style='width: 424px;'>"
	;HEVA-905 set comboDetail = "<option value=''></option>"
	;HEVA-905 set comboFooter = "</select>"
	;HEVA-905 
	;HEVA-905 &SQL(DECLARE c1 CURSOR FOR 
	;HEVA-905   SELECT Text 
	;HEVA-905   INTO :comboObs
  	;HEVA-905   FROM SQLUser.VARPARA
  	;HEVA-905   WHERE Language1 = "PT"
  	;HEVA-905   AND ParameterName = "LISTAFARMOBS"
 	;HEVA-905 )
	
	;HEVA-905 &sql(OPEN c1)
	;HEVA-905 &sql(FETCH c1)
 	;HEVA-905 while (SQLCODE = 0){
	;HEVA-905 	if ($$Trim^COMUtilStr(cObs) = $$Trim^COMUtilStr(comboObs)){
	;HEVA-905 		set comboDetail = comboDetail_"<option value='"_comboObs_"' selected>"_comboObs_"</option>"
	;HEVA-905 	}
	;HEVA-905 	else {
	;HEVA-905 		set comboDetail = comboDetail_"<option value='"_comboObs_"'>"_comboObs_"</option>"
	;HEVA-905 	}
	;HEVA-905 	&sql(FETCH c1)
	;HEVA-905 } 	
	;HEVA-905 &sql(CLOSE c1)	
	;HEVA-905 
	;HEVA-905 set combo = comboHeader_comboDetail_comboFooter
	;HEVA-905 
	;HEVA-905 &html<
	;HEVA-905 	<script type='text/javascript'>
	;HEVA-905 		function yesConfirm(){
	;HEVA-905 			if (document.getElementById("promptText").value != ""){
	;HEVA-905 				window.returnValue = 1+"-"+document.getElementById("pObs").value+" | "+document.getElementById("promptText").value;
	;HEVA-905 			}
	;HEVA-905 			else {
	;HEVA-905 				window.returnValue = 1+"-"+document.getElementById("pObs").value
	;HEVA-905 			}
	;HEVA-905 			
	;HEVA-905 			window.close();
	;HEVA-905 			return false;
	;HEVA-905 		}
	;HEVA-905 		function noConfirm() {
	;HEVA-905 			window.returnValue = 0;
	;HEVA-905 			window.close();
	;HEVA-905 			return false
	;HEVA-905 		}
	;HEVA-905 	</script>
	;HEVA-905 	<body>
	;HEVA-905 		<label style="font-size:12px;font-weight:bold;margin-top:10px;">Obs.&nbsp;&nbsp;</label>
	;HEVA-905 		#(combo)#
	;HEVA-905 		<textarea name="promptText" id="promptText" rows="7" cols="55" wrap="physical" #(disabled)# />#(Obs)#</textarea>
	;HEVA-905 		<blockquote style="font-size:12px;font-weight:bold;margin-top:10px;text-align:center;">Editar observação?</blockquote>
	;HEVA-905 		<div style="width:460px;text-align:center;">
	;HEVA-905 			<input type="button" value="    SIM    " onclick="yesConfirm();"  style="font-weight:bold;margin-right:20px;cursor:pointer;">
	;HEVA-905 			<input type="button" value="    NÃO    " style="font-weight:bold;margin-left:10px;cursor:pointer;" onclick="noConfirm();">
	;HEVA-905 		</div>
	;HEVA-905 	</body>
	;HEVA-905 >
	quit

Popup(pDispensacao,&pbtnNo="",&pbtnYes="")
	; History
	;
	; 26-Sep-2013	shobby	HEVA-905:	Use @netManager popup panel rather than modal window.
	
	new HTML
	new objMEDDispenseLine, pDispense, pLine, Obs, disabled
	set pDispense 	= $piece(pDispensacao,$$$COMMA,1)
	set pLine	  	= $piece(pDispensacao,$$$COMMA,2)
	set pPrescricao = $$$MEDDispensePrescription($get(^MEDDispense(YM,pDispense,1)))
	set disabled 	= ""
	
	set status = $$$MEDPrescriptionLineStatus($get(^MEDPrescriptionLine(YM,pPrescricao,pLine,1)))
	set objMEDDispenseLine = $get(^MEDDispenseLine(0,pDispense,pLine,1))
	
	set Obs  = $$TrimSpaces^COMUtilStr($piece($$$MEDDispenseLineFREE4(objMEDDispenseLine),"|",2))
	set cObs = $piece($$$MEDDispenseLineFREE4(objMEDDispenseLine),"|",1)
	
	
	//set c = $piece($piece(objMEDDispenseLine,"~",44),"|",1)
		
	//Para aparecer o campo observação alterado anteriormente ao fechamento do popup
	set ValorAlterado = $get(^VARTempListTrabFarmObs(YM,YBED,pDispense,pLine))
	if (ValorAlterado '= "") Do
	. set Obs = $$TrimSpaces^COMUtilStr($piece(ValorAlterado,"|",2))
	. set cObs = $piece(ValorAlterado,"|",1)
	//********************
	
	//set aaa = $get(^ValorTittleObs(0,pDispense,pLine,1))
	
	if (status = 6){
		set disabled = "disabled"
	}
	
	new combo, comboHeader, comboDetail, comboFooter, comb]]><![CDATA[oObs
	
	set comboObs    = ""
	set comboHeader = "<select id='pObs' style='width: 429px;'>"
	set comboDetail = "<option value=''></option>"
	set comboFooter = "</select>"

	&SQL(DECLARE c11 CURSOR FOR 
	  SELECT Text 
	  INTO :comboObs
  	  FROM SQLUser.VARPARA
  	  WHERE Language1 = "PT"
  	  AND ParameterName = "LISTAFARMOBS"
 	)
	
	&sql(OPEN c11)
	&sql(FETCH c11)
 	while (SQLCODE = 0){
		if ($$Trim^COMUtilStr(cObs) = $$Trim^COMUtilStr(comboObs)){
			set comboDetail = comboDetail_"<option value='"_comboObs_"' selected>"_comboObs_"</option>"
		}
		else {
			set comboDetail = comboDetail_"<option value='"_comboObs_"'>"_comboObs_"</option>"
		}
		&sql(FETCH c11)
	} 	
	&sql(CLOSE c11)	
	
	set combo = comboHeader_comboDetail_comboFooter
	
	set HTML=""
	set HTML=HTML_"		<label style='font-size:12px;font-weight:bold;margin-top:10px;'>Obs.&nbsp;&nbsp;</label>"
	set HTML=HTML_combo
	set HTML=HTML_"		<textarea name='promptText' id='promptText' rows='7' cols='55' wrap='physical' "_disabled_" />"_Obs_"</textarea>"
	set HTML=HTML_"		<blockquote style='font-size:12px;font-weight:bold;margin-top:10px;text-align:center;'>Editar observação?</blockquote>"
	set HTML=HTML_"		<div style='width:460px;text-align:center;'>"
	set HTML=HTML_"			<input type='button' id='btnYesConfirm' value='    SIM    ' style='font-weight:bold;margin-right:20px;cursor:pointer;'>"
	set HTML=HTML_"			<input type='button' id='btnNoConfirm'  value='    NÃO    ' style='font-weight:bold;margin-left:10px;cursor:pointer;'>"
	set HTML=HTML_"		</div>"
	
	new strYes
	set strYes=""
	set strYes=strYes_"if (document.getElementById('promptText').value != ''){"
	set strYes=strYes_"	var value = 1+'-'+document.getElementById('pObs').value+' | '+document.getElementById('promptText').value;"
	set strYes=strYes_"} else {"
	set strYes=strYes_"	var value = 1+'-'+document.getElementById('pObs').value;"
	set strYes=strYes_"}"
	set strYes=strYes_"dscPMClose();"
	set strYes=strYes_"var keyObs = '"_pDispensacao_"'+','+value;"
	set strYes=strYes_"if (value){"
	set strYes=strYes_"		CallBackNow('GravarObsOnClick^VARListaTrabalhoFarmacotecnica', keyObs, value);"
	set strYes=strYes_"	}"

	set pbtnYes("Code")=strYes
	set pbtnYes("Id")="btnYesConfirm"

	set pbtnNo("Id")="btnNoConfirm"
	set pbtnNo("Code")="dscPMClose();"
	quit HTML
	
AtualizaObs()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmObs(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmObs(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmObs(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	
						
			if ($$$MEDDispenseLineFREE4(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
				set $$$MEDDispenseLineFREE4(objMEDDispenseLine) = $piece(objTemp,Y,1)
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit
	
AtualizaF()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmF(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmF(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmF(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	
						
			if ($$$MEDDispenseLineFREE2(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
				set $$$MEDDispenseLineFREE2(objMEDDispenseLine) = $piece(objTemp,Y,1)
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit
	
AtualizaCEF()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmCEF(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmCEF(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmCEF(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	
						
			if ($$$MEDDispenseLineFREE3(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
				set $$$MEDDispenseLineFREE3(objMEDDispenseLine) = $piece(objTemp,Y,1)
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit

AtualizaLote()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmLote(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmLote(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmLote(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	
						
			if ($$$MEDDispenseLineFREE1(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
				set $$$MEDDispenseLineFREE1(objMEDDispenseLine) = $piece(objTemp,Y,1)
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit
	
AtualizaQtyDose()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmQtyDose(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmQtyDose(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmQtyDose(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	

			if ($$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(Dispensasao,Linha) = 1){
				if ($$$MEDDispenseLineIssueQuantity(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
					set $$$MEDDispenseLineIssueQuantity(objMEDDispenseLine) = $piece(objTemp,Y,1)
				}
			}
			else {
				if ($$$MEDDispenseLineDoseQuantity(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
					set $$$MEDDispenseLineDoseQuantity(objMEDDispenseLine) = $piece(objTemp,Y,1)
			}
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit
	
AtualizaUnitDose()
	
	new Dispensasao, Linha, Obs, objTemp
	
	set Dispensasao = ""

	for {
		set Dispensasao = $order(^VARTempListTrabFarmUnitDose(YM,YBED,Dispensasao))
		
		quit:(Dispensasao = "")
		
		set Linha = ""
		for {
			set Linha = $order(^VARTempListTrabFarmUnitDose(YM,YBED,Dispensasao,Linha))
			quit:(Linha = "")
			
			set objTemp = $get(^VARTempListTrabFarmUnitDose(YM,YBED,Dispensasao,Linha))	
			set objMEDDispenseLine = $get(^MEDDispenseLine(YM,Dispensasao,Linha,1))	
						
			if ($$CheckMedAlternativo^VARListaTrabalhoFarmacotecnica(Dispensasao,Linha) = 1){
				if ($$$MEDDispenseLineIssueUOM(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
					set $$$MEDDispenseLineIssueUOM(objMEDDispenseLine) = $piece(objTemp,Y,1)
				}
			}
			else {
				if ($$$MEDDispenseLineDoseUOM(objMEDDispenseLine) '= $piece(objTemp,Y,1)){
					set $$$MEDDispenseLineDoseUOM(objMEDDispenseLine) = $piece(objTemp,Y,1)
				}
			}
						
			set strStatus = $$$Save("MEDDispenseLine",Dispensasao_$$$COMMA_Linha,objMEDDispenseLine,1)
			
			if $$$ISERR(strStatus) {
				$$$Alert("Erro ao atualizar dispensações: "_$$DecodeError^COMUtilError(strStatus))
			}
		}
	}
	
	quit

GetPrescriptionStatus(pidDispense="",pidDispenseLine="",YM=0) ;HEVA-1238
	new objDispense,idPrescription,idPrescriptionLine,objPrescriptionLine,strStatusProduto
	
	set strStatusProduto=""
	if (pidDispense'="")&&(pidDispenseLine'="") {
		set objDispense=$get(^MEDDispense(YM,pidDispense,1))
		set idPrescription=$$$MEDDispensePrescription(objDispense)
		set idPrescriptionLine=pidDispenseLine
		if (idPrescription'="")&&(idPrescriptionLine'="") {
			set objPrescriptionLine=$get(^MEDPrescriptionLine(YM,idPrescription,idPrescriptionLine,1))
			set strStatusProduto=$$$MEDPrescriptionLineStatus(objPrescriptionLine)
		}
	}
	quit strStatusProduto
	
CorrigirMedDispenseLine
	//Rafael - 04/04/2014
	//Corrigir o campo Observação de todos os registros da MedDispenseLine(FREE4)
	
	kill rs,^ComboVARPARA,sql
	set sql = "SELECT Text FROM SQLUser.VARPARA WHERE Language1 = 'PT' AND ParameterName = 'LISTAFARMOBS'"
	set rs = ##class(%Library.ResultSet).%New()
	Do rs.Prepare(sql)
	Do rs.Execute()
	
	kill ^ComboVARPARA
	set ^ComboVARPARA = ""
	set linha = 0
	while rs.Next(){
		set linha = linha + 1
		set p1 = rs.GetData(1)
		set ^ComboVARPARA(p1) = p1		
	}
	kill rs
	
	
	Set paramDispense = ""
    ;For i = 1:1:550 
    For{
	    Set paramLine = ""
    	Set paramDispense = $Order(^MEDDispenseLine(0,paramDispense))
    	
    	if (paramDispense = "") Quit    	
    	Set paramLine = ""
    	For{
    		set paramLine = $Order(^MEDDispenseLine(0,paramDispense,paramLine))
    		if (paramLine = "") Quit
    		
    		;set ID = ^MEDDispenseLine(0,paramDispense,paramLine,1)
    		set ID = "0||"_paramDispense_"||"_paramLine
    		;write !,ID
    		kill objMED,objMEDSave
    		set objMED = ##class(User.MEDDispenseLine).%OpenId(ID,0)
	    	set Observacao = objMED.FREE4	    	
	    	if (Observacao = "") Quit
	    	
	    	set ComboObs = $Piece(Observacao,"|",1)
	    	set DescObs = $Piece(Observacao,"|",2)
			
			;write !,"ID: "_ID_" -> ComboObs: "_ComboObs_" | DescObs: "_DescObs
	    	if (ComboObs '= "") && (DescObs '= "") Quit
	    	  	
	    	if (ComboObs '= "") && (DescObs = "") {
		    	set AlteraObs = 0
		    	set ComboVARPARADesc = ""
	    		For {
		    		set ComboVARPARADesc = $Order(^ComboVARPARA(ComboVARPARADesc))		    		
		    		if (ComboVARPARADesc = "") Quit
		    		;
		    		if (ComboObs = ComboVARPARADesc) set AlteraObs = 1
	    		}
	    		;
	    		//Se AlteraObs for 0 colocará o pipe antes da descrição. Senão, colocará depois.
	    		if (AlteraObs = 0){
		    		set Observacao = "|"_ComboObs
	    		}else{
		    		set Observacao = ComboObs_"|"
	    		}
    		}
    		;write !, "ID = "_ID_" -> Observacao = "_Observacao
    		
    		;write !, objMED
    		
    		set objMED.FREE4 = Observacao
    		
    		if ($get(objMED) '= "") {
	    		set objMEDSave = objMED.%Save()
    			If $$$ISERR(objMEDSave) {
     				Do $System.Status.DisplayError(objMEDSave)
 				}
    		}
    		
    		kill objMED,objMEDSave
	    	;write !, "Obs1: "_ComboObs_" --- Obs2: "_DescObs
    	}
    }
  	;
  	kill ^ComboVARPARA
	Quit
	
VerificarObs(Observacao)
	;
	//Rafael - 07/04/2014
	//Corrige e devolve o campo Observação (FREE4) caso o mesmo esteja com a sequencia de pipes incorreto
	if (Observacao = "") Quit Observacao
	;
	set ComboObs = $Piece(Observacao,"|",1)
	set DescObs = $Piece(Observacao,"|",2)
	;
	if (ComboObs '= "") && (DescObs '= "") Quit Observacao
	;	
	if (ComboObs '= "") && (DescObs = "") {
		kill rs,^ComboVARPARA,sql
		set sql = "SELECT Text FROM SQLUser.VARPARA WHERE Language1 = 'PT' AND ParameterName = 'LISTAFARMOBS'"
		set rs = ##class(%Library.ResultSet).%New()
		Do rs.Prepare(sql)
		Do rs.Execute()
		
		set ^ComboVARPARA = ""
		set linha = 0
		while rs.Next(){
			set linha = linha + 1
			set p1 = rs.GetData(1)
			set ^ComboVARPARA(p1) = p1		
		}
		kill rs
		;
	   	set AlteraObs = 0
	   	set ComboVARPARADesc = ""
		For {
	   		set ComboVARPARADesc = $Order(^ComboVARPARA(ComboVARPARADesc))		    		
	   		if (ComboVARPARADesc = "") Quit
	   		;
	   		if (ComboObs = ComboVARPARADesc) set AlteraObs = 1
		}
		;
		//Se AlteraObs for 0 colocará o pipe antes da descrição. Senão, colocará depois.
		if (AlteraObs = 0){
	   		set Observacao = "|"_ComboObs
		}else{
	   		set Observacao = ComboObs_"|"
		}
	}
	
	
	Quit Observacao]]></Routine>
</Export>