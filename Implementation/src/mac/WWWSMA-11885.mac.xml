<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWSMA" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWSMA
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		SUCHEN DATEN MASKE SUCHFUNKTION
	;
	;	VORG(X)=SUCHFUNKTION DER SORTKEY'S ;the 
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 06-Jan-2011	GRF		SR17579: Use explicit tag
	; 28-Sep-2007	GRF		Naked References
	; 08-Jun-2007	GRF		Doco; expand commands; quits
	; 19.08.1999	DT
	;-------------------------------------------------------------------------------
	
	;WRITE YCR,YCR,"<!-- ************************* SUCHFUNKTION (WWWSMA)************************* -->",YCR,YCR
	SET %("VAR","YBACK")=""
	SET %("VAR","YFORM")=YFORM
	KILL ^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM)  ;TYBD;FEHLER IN ANZEIGE;10,3,2005
	;AUSWAHL EINGEBEN ;Selection key in 
	DO GETVAR  ;VORGABEWERTE HOLEN ;send for 
	
	;IF +$PIECE(YVOR,Y,13)=1 WRITE YCR,"<FIELDSET>"
	SET YBBN=""
	FOR  SET YBBN=$ORDER(^WWW002(0,YDATEI,YBBN)) QUIT:YBBN=""  DO  ;AUSWAHL DER AUZEIGEFELDER ;Selection the 
	. QUIT:YBBN>1  ;NUR 1.KEY ;only 
	. NEW YKEY,YFKEY
	. SET YKEY="",YFKEY=""
	. SET YSATZ=YBBN
	. SET YLFN=YBBN
	. SET YSSOR=0
	. SET YSSOR(1)=+$PIECE(YSSOR,".",1)
	. SET YSSOR(2)=+$PIECE(YSSOR,".",2)
	. IF YSSOR(2)=0 SET YSSOR(2)=1
	. IF $DATA(^WWW0021(0,YDATEI,YBBN,SPRACHE,1)) SET $PIECE(YSATZ,Y,12)=$PIECE(^WWW0021(0,YDATEI,YBBN,SPRACHE,1),Y,1)   ; Naked Ref
	. SET YOLDVAL=$GET(YSKEY0(YSSOR(1),YSSOR(2)))  ;SUCHVORGABE ORIGINAL
	. ;
	. SET YFELD=""  ;VORGABE LÖSCHEN ;default Delete 
	. SET YART="P"  ;P=PRIMÄR,D=DATENFELD,M=MANUELLE,L=LISTGENERATOR
	. DO ^WWWFORM9
	
	SET YBBN=""
	FOR  SET YBBN=$ORDER(^WWW003(0,YDATEI,YBBN)) QUIT:YBBN=""  DO  ;AUSWAHL DER AUZEIGEFELDER ;Selection the 
	. SET YSATZ=YBBN
	. SET YLFN=YBBN
	. SET YSSOR=$PIECE($PIECE($GET(^WWW003(0,YDATEI,YBBN,1)),Y,6),",",1)  ;SORTKEY
	. QUIT:YSSOR=""
	. SET YSSOR(1)=+$PIECE(YSSOR,".",1)
	. SET YSSOR(2)=+$PIECE(YSSOR,".",2)
	. IF YSSOR(2)=0 SET YSSOR(2)=1
	. QUIT:YSSOR(2)>1
	. IF $DATA(^WWW0031(0,YDATEI,YBBN,SPRACHE,1)) SET $PIECE(YSATZ,Y,12)=$PIECE(^WWW0031(0,YDATEI,YBBN,SPRACHE,1),Y,1)   ; Naked Ref
	. SET YOLDVAL=$GET(YSKEY0(YSSOR(1),YSSOR(2)))  ;SUCHVORGABE ORIGINAL
	. IF $PIECE($GET(^WWW003(0,YDATEI,YBBN,1)),Y,3)=1 SET YOLDVAL=$$^WWWDATE(YOLDVAL)  ;DATUMSFORMAT
	. IF $PIECE($GET(^WWW003(0,YDATEI,YBBN,1)),Y,3)=7 SET YOLDVAL=$$^WWWTIME(YOLDVAL)  ;TIMEFORMAT
	. SET YFELD=""  ;VORGABE LÖSCHEN ;default Delete 
	. SET YART="D"  ;P=PRIMÄR,D=DATENFELD,M=MANUELLE,L=LISTGENERATOR
	. IF $EXTRACT($PIECE($GET(^WWW003(0,YDATEI,YBBN,1)),Y,1),1,5)="_FREE" QUIT  ;KEINE _FREE ANZEIGEN;TYBD:27,07,2003;
	. DO ^WWWFORM9
	
	WRITE YCR,"</TR>",YCR  ;ABSCHLUSS FELD ;field 
	IF $PIECE(YVOR,Y,44)'=1 WRITE YCR,"</TABLE>",YCR  ;ABSCHLUSS FORMAT
	
	;IF +$PIECE(YVOR,Y,13)=1 WRITE YCR,"</FIELDSET>"
	QUIT
	
SUCH ;EINSPRUNG FÜR SUCHE ;to search 
	SET YANZFORM=$PIECE($GET(^WWW120(0,YFORM,1)),Y,79)
	DO SEARCH   ;SUCHEN DER FELDER  ;seek the 
	DO DISPLY   ;ANZEIGE DER FELDER ;Show the 
	QUIT
	
GETVAR ;VORGABEN SUCHEN  ;seek 
	SET YTEST=""
	
	DO  ;PRIMÄRSCHLÜSSEL
	. SET YI=1,SKEY=0,YSKEY=0   ;ERSTER PRIMÄRSCHLÜSSEL SORTKEY=0 ;premier 
	. SET YA=$GET(%(YQUERY,"Y"_YFORM_"P"_YI)) IF YA'="" DO
	. . SET YTYP=$PIECE($GET(^WWW002(0,YDATEI,YI,1)),Y,3)
	. . SET YA=$TRANSLATE(YA,"+"_"""")
	. . SET YA=$$GetInternal^WWWTR(YTYP,YA)
	. . IF $EXTRACT(YA)'="*" SET YA=$TRANSLATE(YA,"*")
	. . IF $EXTRACT(YA)="."  SET YA=$EXTRACT(YA,2,999)
	. . QUIT:YA=""
	. . FOR YLFSK=1:1 SET YSSOR=$PIECE(YSKEY,",",YLFSK) QUIT:YSSOR=""  DO
	. . . IF $PIECE(YSSOR,".",2)="" SET $PIECE(YSSOR,".",2)=1
	. . . SET YSSOR(1)=+$PIECE(YSSOR,".",1)
	. . . SET YSSOR(2)=+$PIECE(YSSOR,".",2)
	. . . SET YSKEY(YSSOR(1),YSSOR(2))=$$^WWWUMLAU(YA,1)  ;SUCHVORGABE FÜR SORTSCHLÜSSEL ;to 
	. . . SET YSKEY(YSSOR(1),YSSOR(2))=YA  ;SUCHVORGABE FÜR SORTSCHLÜSSEL ;to 
	. . . ;SET $PIECE(YTEST,Y,999)=YSKEY(YSSOR(1),YSSOR(2)) 
	. . . SET YSKEY0(YSSOR(1),YSSOR(2))=$TRANSLATE(YA,",")  ;SUCHVORGABE ORIGINAL
	. . . SET YSKEY1(YSSOR(1),YSSOR(2))=YI  ;WELCHES DATENFELD ;who data item 
	. . . IF YTYP=3 IF $ORDER(^WWW002(0,YDATEI,YI))="" SET YSKEY0(YSSOR(1),YSSOR(2))="*"_YA  ;TEXT
	. . . IF $FIND(YA,"C:") SET YSKEY(YSSOR(1),YSSOR(2))=$TRANSLATE(YA,$CHAR(214)_"'","/"_"""")  ;DATEI ;data file 
	
	;DATENFELDER
	SET YI=""
	FOR  SET YI=$ORDER(^WWW003(0,YDATEI,YI)) QUIT:YI=""  DO  ;DATENFELDER
	. SET YSKEY=$PIECE($GET(^WWW003(0,YDATEI,YI,1)),Y,6)
	. QUIT:YSKEY=""
	. SET YA=$GET(%(YQUERY,"Y"_YFORM_"D"_YI)) DO MULTD IF YA'="" DO
	. . SET YTYP=$PIECE($GET(^WWW003(0,YDATEI,YI,1)),Y,3)
	. . SET YA=$$GetInternal^WWWTR(YTYP,YA)
	. . IF $EXTRACT(YA)'="*" SET YA=$TRANSLATE(YA,"*")
	. . IF $EXTRACT(YA)="." SET YA=$EXTRACT(YA,2,999)
	. . QUIT:YA=""
	. . FOR YLFSK=1:1 SET YSSOR=$PIECE(YSKEY,",",YLFSK) QUIT:YSSOR=""  DO
	. . . IF $PIECE(YSSOR,".",2)="" SET $PIECE(YSSOR,".",2)=1
	. . . SET YSSOR(1)=$PIECE(YSSOR,".",1)
	. . . SET YSSOR(2)=$PIECE(YSSOR,".",2)
	. . . SET YSKEY(YSSOR(1),YSSOR(2))=$$^WWWUMLAU(YA,1)  ;SUCHVORGABE FÜR SORTSCHLÜSSEL ;to 
	. . . SET $PIECE(YTEST,Y,YI)=YSKEY(YSSOR(1),YSSOR(2)) 
	. . . SET YSKEY0(YSSOR(1),YSSOR(2))=$TRANSLATE(YA,",")  ;SUCHVORGABE ORIGINAL
	. . . SET YSKEY1(YSSOR(1),YSSOR(2))=YI  ;WELCHES DATENFELD ;who data item 
	. . . IF YTYP=3 IF $ORDER(^WWW003(0,YDATEI,YI))="" SET YSKEY0(YSSOR(1),YSSOR(2))="*"_YA  ;TEXT
	. . . IF $FIND(YA,"C:") SET YSKEY(YSSOR(1),YSSOR(2))=$TRANSLATE(YA,$CHAR(214)_"'","/"_"""")  ;DATEI ;data file 
	
	QUIT
	
MULTD ;MULTIEINGABE DATENFELDER
	NEW YII
	
	SET YII=""
	FOR  SET YII=$ORDER(%(YQUERY,"YD"_YI,YII)) QUIT:YII=""  DO
	. IF $GET(%(YQUERY,"YD"_YI,YII))'="" SET:YA'="" YA=YA_";" SET YA=YA_$GET(%(YQUERY,"YD"_YI,YII))
	
	QUIT
	
SEARCH ;SUCHEN DER DATEN ;seek the 
	SET YSUCH1=""
	IF YFORM'="" SET YSUCH1=$GET(^WWW123(0,YFORM,1,1))
	
	;SUCHEN BESTE AUSWAHL 1.LAENGE AUSWERTEN NUR  ;seek best Selection only 
	SET YFIND=""
	SET YSORT1=""
	FOR  SET YSORT1=$ORDER(YSKEY0(YSORT1)) QUIT:YSORT1=""  DO
	. SET YFIND(YSORT1)=""
	. QUIT:$GET(YSKEY0(YSORT1,1))=""
	. QUIT:$EXTRACT($GET(YSKEY0(YSORT1,1)))="*"  ;kein * volltext ;not 
	. SET YSORT2="" FOR  SET YSORT2=$ORDER(YSKEY0(YSORT1,YSORT2)) QUIT:YSORT2=""  DO
	. . SET YFIND(YSORT1)=YFIND(YSORT1)_$GET(YSKEY0(YSORT1,YSORT2))_","
	. . ;I $E(YFIND(YSORT1))="." S YFIND(YSORT1)=$E(YFIND(YSORT1),2,999)    ;TYBD;30,10,2003
	
	SET YSORT=""
	FOR  SET YSORT=$ORDER(YFIND(YSORT)) QUIT:YSORT=""  DO
	. IF $LENGTH(YFIND(YSORT))>$LENGTH(YFIND) SET YFIND=YFIND(YSORT) SET YSORT1=YSORT
	
	;suche nach VOLLTEXT SUCHE ;within full text search 
	IF YFIND="" DO 
	. SET YSORT1=""
	. FOR  SET YSORT1=$ORDER(YSKEY0(YSORT1)) QUIT:YSORT1=""  DO
	. . SET YFIND(YSORT1)=""
	. . QUIT:$GET(YSKEY0(YSORT1,1))=""
	. . QUIT:$EXTRACT($GET(YSKEY0(YSORT1,1)))'="*"
	. . SET YSORT2=""
	. . FOR  SET YSORT2=$ORDER(YSKEY0(YSORT1,YSORT2)) QUIT:YSORT2=""  DO
	. . . SET YFIND(YSORT1)=YFIND(YSORT1)_$GET(YSKEY0(YSORT1,YSORT2))_","
	. ;
	. SET YSORT=""
	. FOR  SET YSORT=$ORDER(YFIND(YSORT)) QUIT:YSORT=""  DO
	. . IF $LENGTH(YFIND(YSORT))>$LENGTH(YFIND) SET YFIND=YFIND(YSORT) SET YSORT1=YSORT
	
	;3.suche nach key ;within 
	IF $GET(YSKEY0(0,1))'="" SET YSORT=0,YSORT1=0 SET YFIND=YFIND(YSORT) ;NACH PRIMÄRSCHLÜSSEL ;within 
	
	FOR  QUIT:$EXTRACT(YFIND,$LENGTH(YFIND))'=","  DO
	. SET YFIND=$EXTRACT(YFIND,1,$LENGTH(YFIND)-1)
	. ;I $E(YFIND)="." S YFIND=$E(YFIND,2,999)    ;TYBD;30,10,2003
	
	DO
	. WRITE "<B>"
	. WRITE "&nbsp;",$$^WWWTEXT(148)_": "   ;SUCHE:
	. DO
	. . IF $LENGTH(YFIND)=5 IF YFIND<63000 IF YFIND>59000 WRITE $$^WWWDATE(YFIND) QUIT
	. . WRITE YFIND   ;ANZEIGE NACH WASGESUCHT WIRD ;Show within 
	. ;
	. WRITE "</B>"
	
	QUIT:YFIND=""    
	
	;S YSUCH1="FORMULAR;DATEI;SORTKEY;VORGABEKEY|VORGABEDATEN;ANZEIGE KEY;ANZEIGEFELD;STD SORT;ANZEIGE ERGEBNIS;ORIENTIERUNG;ANZAHL ANZEIGEN;FIXKEY;FELDER MIT SUMMENBILDUNG;WELCHEN KEY UEBERGEBEN;
	IF YFORM'="" SET YSUCH1=$GET(^WWW123(0,YFORM,1,1))
	IF YSUCH1="" SET YSUCH1=YFORM_Y_YDATEI_Y_YSORT1_Y_YFIND
	
	IF $PIECE(YSUCH1,Y,1)="" SET $PIECE(YSUCH1,Y,1)=YFORM
	IF $PIECE(YSUCH1,Y,2)="" SET $PIECE(YSUCH1,Y,2)=YDATEI
	IF $PIECE(YSUCH1,Y,3)="" SET $PIECE(YSUCH1,Y,3)=YSORT1
	IF $PIECE(YSUCH1,Y,4)="" SET $PIECE(YSUCH1,Y,4)=YFIND
	
	NEW YDATEI,YAUSW,YRICHT,YSORT,YANZ,YKOMP,YFIND,YFORM,YFOART,YFKEY
	
	SET YFOART=1
	SET YDATEI=$PIECE(YSUCH1,Y,2)
	SET YSORT=$PIECE(YSUCH1,Y,3)
	SET YRICHT=+$PIECE(YSUCH1,Y,9)
	SET YAUSW=$PIECE($PIECE(YSUCH1,Y,4),"|",1)
	SET YANZ=$PIECE(YSUCH1,Y,10)
	SET YFKEY=$PIECE(YSUCH1,Y,11)
	IF +YANZ=0 SET YANZ=1000
	
	KILL ^WWWSOR(YUSER,"SEL")
	KILL ^WWWSOR(YUSER,"KEY")
	
	IF $FIND(YAUSW,";") DO  ;WENN ;
	. NEW YAUSW1
	. SET YAUSW1=YAUSW
	. FOR YAUSW1(1)=1:1 QUIT:$PIECE(YAUSW1,";",YAUSW1(1),99)=""  SET YAUSW=$PIECE(YAUSW1,";",YAUSW1(1)) DO
	. . IF YAUSW'="" DO ^WWWSMA1
	
	IF '$FIND(YAUSW,";") DO ^WWWSMA1
	
	IF +$GET(YMAL)'=0 WRITE $$^WWWTEXT(31625)_":"_$GET(YMAL)    ; Anzahl Einträge:  ;Number 
	WRITE YCR
	
	QUIT
	
DISPLY ;ANZEIGEN SUCHERGEBNISE ;display 
	;-------------------------------------------------------------------------------
	; Display
	;
	; Returns:
	;
	; History:
	; 18-Mar-2008	GM		BR014910: Make appear the table
	;-------------------------------------------------------------------------------
 
	NEW YFORM,YI,YQ
	
	IF $PIECE(YVOR,Y,44)>0 WRITE YCR,"<TR><TD>"
	SET YQ=0
	SET YFORM=$GET(YANZFORM)
	IF YFORM'="" SET YQ=1				
	IF YFORM=""  SET YFORM=YDATEI
	
	; FIXME : <GRF> YI will be undefined if YANZFORM is null
	; FIXED : <GM>
	;IF YQ=0 SET YI=""	;BR014910
	SET YI=""			;BR014910
	FOR  SET YI=$ORDER(^WWW120s(0,1,YDATEI,YI)) QUIT:YI=""  DO  QUIT:YQ=1
	. IF $PIECE($GET(^WWW120(0,YI,1)),Y,2)'=1 IF $PIECE($GET(^WWW120(0,YI,1)),Y,2)'=3 QUIT
	. SET YFORM=YI
	. SET YQ=1
	
	DO ^WWWFRAME(0)
	
	NEW YBACK 
	SET YBACK=$GET(%(YQUERY,"YFORM"))_","
		;S YBACK=$G(%("VAR","YFORM"))_","
	SET YNOSORT=1  ;KEIN UNTERSORT ;no 
	DO ^WWWSEAR3
	
	IF $PIECE(YVOR,Y,44)>0 WRITE YCR,"</TD></TR>"
	DO ^WWWFRAME(1)
	QUIT
	
]]></Routine>
</Export>