<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWPRIMCHANGE" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWPRIMCHANGE(YFILE,YOLDVAL,YNEWVAL)	;WWWPRIMCHAGE;DT;AUSTAUSCHEN PRIMÄRSCHLÜSSEL;24.8.2003
	;------------------------------------------------------------------\
	; Description of Function :
	;		AUSTAUSCHEN PRIMÄRSCHLÜSSEL
	; Inputs : 
	;
	; ByRef :
	;
	; Returns :
	;
	; History :
	;
	; DT	24.8.2003
	;------------------------------------------------------------------/
	;YFILE=DATEI
	;YOLDVAL=ALTER WERT ;worthy 
	;YNEWVAL=NEUER WERT ;worthy 
	;S YOK=$$^WWWPRIMCHAGE("INART",123,321)  ;BEISPIEL
	;YOK=1 = DATEN UMGESTZT
	;YOK=0 = DATEN NICHT UMGESETZT ;Not 
	NEW RETURN,YFORM,YVOR,YDATEI
	SET RETURN=0
	IF $GET(YFILE)="" QUIT RETURN
	IF $GET(YOLDVAL)="" QUIT RETURN
	IF $GET(YNEWVAL)="" QUIT RETURN
	IF '$DATA(^WWW001(0,YFILE)) QUIT RETURN
	IF $ORDER(^WWW002(0,YFILE,""),-1)'=1 QUIT RETRURN  ;MEHR ALS EIN KEY ODER KEIN KEY ;more when uni- KEY Or no KEY 
	SET YDATEI=YFILE
	SET YA="^"_YDATEI_"("_$$^WWWYM(YDATEI)_","_""""_YNEWVAL_""""_",1)"
	QUIT:$GET(@YA)'="" RETURN  ;DATENSATZ VORHANDEN ;data record on hand 
	SET YA="^"_YDATEI_"("_$$^WWWYM(YDATEI)_","_""""_YOLDVAL_""""_",1)"
	QUIT:$GET(@YA)="" RETURN  ;KEIN DATENSAZ VORHANDEN ;no on hand 
	SET YFELD=@YA
	QUIT:$GET(YFELD)="" RETURN  ;KEIN DATENSATZ ;no data record 
	DO ^WWWKILL(YDATEI,YKEY)     ;LÖSCHEN ALTE WERTE ;Delete 
	SET YOK=$$^WWWSPEI(YDATEI,YNEWVAL,YFELD,1)  ;SPEICHERN NEUE WERTE ;Save 
	SET YDATEI="" FOR  SET YDATEI=$ORDER(^WWW001(0,YDATEI)) QUIT:YDATEI=""  DO
	. SET YLFN="" FOR  SET YLFN=$ORDER(^WWW002(0,YDATEI,YLFN)) QUIT:YLFN=""  DO
	. . SET YFELD=$GET(^WWW002(0,YDATEI,YLFN,1))
	. . QUIT:$PIECE(YFELD,Y,8)'=YFILE  ;
	. . DO KEY
	. . QUIT
	. SET YLFN="" FOR  SET YLFN=$ORDER(^WWW003(0,YDATEI,YLFN)) QUIT:YLFN=""  DO
	. . SET YFELD=$GET(^WWW003(0,YDATEI,YLFN,1))
	. . QUIT:$PIECE(YFELD,Y,8)'=YFILE
	. . DO FIELD
	. . QUIT
	. QUIT
	SET RETURN=1
	QUIT RETURN
	
KEY	;UMSETZTEN KEY
	SET UMS=1
	DO SEARCH
	QUIT
	
FIELD ;UMSETZEN FELD ;transact money field 
	SET UMS=2
	DO SEARCH
	QUIT
	
SEARCH ;	
	SET MAXKEY=+$ORDER(^WWW002(0,YDATEI,""),-1)
	IF MAXKEY=0 SET MAXKEY=1
	SET YA="^"_YDATEI_"("_$$^WWWYM(YDATEI,1)
	SET YA(1)=YA
	SET YA=YA_"-1)"
	FOR  DO NEXT QUIT:YA=""  DO SATZ
	QUIT
	
NEXT ;NACHSTER DATENSATZ ;data record 
	SET YA=$QUERY(@YA)
	IF '$FIND($TRANSLATE(YA,""""),$TRANSLATE(YA(1),"""")) SET YA=""
	QUIT
	
SATZ ;EINZELSAETZE
	NEW YSA,YFORM,YVOR
	SET YSA=YA
	SET YFELD=$GET(@YSA)
	SET YKEY=$PIECE($PIECE(YA,YA(1),2),",1)",1)
	IF '$FIND(YKEY,"(") SET YKEY=$PIECE(YKEY,")",1)
	SET YKEY=$TRANSLATE(YKEY,"""")
	IF UMS=1 DO  QUIT  ;KEY
	. QUIT:$PIECE(YKEY,",",YLFN)'=YOLDVAL
	. DO ^WWWKILL(YDATEI,YKEY)  ;LÖSCHEN ALTEN VALUE ;Delete VALUE 
	. SET $PIECE(YKEY,",",YLFN)=YNEWVAL
	. SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD)  ;SPEICHERN NEUES VALUE ;Save something new VALUE 
	. QUIT
	IF UMS=2 DO  QUIT  ;KEY
	. QUIT:$PIECE(YFELD,Y,YLFN)'=YOLDVAL
	. DO ^WWWKILL(YDATEI,YKEY)  ;LÖSCHEN ALTES ;Delete 
	. SET $PIECE(YFELD,Y,YLFN)=YNEWVAL
	. SET YOK=$$^WWWSPEI(YDATEI,YKEY,YFELD)  ;SPEICHERN NEUES VALUE ;Save something new VALUE 
	. QUIT
	QUIT
	
SELECT ;SELECT FILES
	;SELEKTIEREN DER WWWPRIMCHANGE ;the 
	NEW YDATEI,YFELD,YNAME
	KILL ^WWWPRIMCHANGE(0)
	SET YDATEI="" FOR  SET YDATEI=$ORDER(^WWW001(0,YDATEI)) QUIT:YDATEI=""  DO
	. IF $ORDER(^WWW002(0,YDATEI,""),-1)'=1 QUIT  ;MEHR ALS EIN KEY ODER ;more when uni- KEY Or 
	. SET YNAME=$PIECE($GET(^WWW001(0,YDATEI,1)),Y,1)
	. IF $PIECE($GET(^WWW0011(0,YDATEI,SPRACHE,1)),Y,1)'="" SET YNAME=$PIECE(^(1),Y,1)
	. SET ^WWWPRIMCHANGE(0,YDATEI,1)=YNAME
	. QUIT
	QUIT
	
CHECKFILE ;PRÜFEN DER DATEI ;sift the data file 
	Q:YINHALT=""
	IF YINHALT="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	IF '$DATA(^WWWPRIMCHANGE(0,YINHALT,1)) SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	QUIT
	
CHECKOLDVAL ;PRUEFEN DER ALTEN WERTE ;the 
	NEW YDATEI,YA
	Q:YINHALT=""
	IF YINHALT="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	SET YDATEI=$PIECE(YMFELD,Y,1)
	IF YDATEI="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	SET YA="^"_YDATEI_"("_$$^WWWYM(YDATEI)_","_""""_YINHALT_""""_",1)"
	IF $GET(@YA)="" SET %TXT(1)="!"_$$^WWWTEXT(86,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	QUIT
	
CHECKNEWVAL ;PRÜFEN DER NEUEN WERTE ;sift the 
	NEW YDATEI,YA
	Q:YINHALT=""
	IF YINHALT="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	SET YDATEI=$PIECE(YMFELD,Y,1)
	IF YDATEI="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	SET YA="^"_YDATEI_"("_$$^WWWYM(YDATEI)_","_""""_YINHALT_""""_",1)"
	IF $GET(@YA)'="" SET %TXT(1)="!"_$$^WWWTEXT(144,,1) QUIT  ;NICHT MÖGLICH ;Not potential 
	QUIT
	
START ;STARTEN UMSETZUNG (START AUS FORMULAR ) ;launching transferral out of form 
	;------------------------------------------------------------------
	; History:
	; 30-Mar-2006 SC SR13942: Use JobWrapper^COMUtilJob
	;------------------------------------------------------------------
	;YM=MANDANTENNUMMER
	;VORG(1)=DATEI
	;VORG(2)=ALTER WERT ;worthy 
	;VORG(3)=NEUER WERT ;worthy 
	;D START^WWWPRIMCHANGE
	NEW VORG1,VORG2,VORG3,YYQ
	SET VORG1=$GET(VORG(1))
	SET VORG2=$GET(VORG(2))
	SET VORG3=$GET(VORG(3))
	SET YYQ=0
	;do JobWrapper^COMUtilJob("START1^WWWPRIMCHANGE("_YM_","_VORG1_","_VORG2_","_VORG3_")",YUSER,2) SET:'$TEST YYQ=1  ;JOB STARTEN ;launching ;SR13942
	JOB START1^WWWPRIMCHANGE(YM,VORG1,VORG2,VORG3)::2 SET:'$TEST YYQ=1  ;JOB STARTEN ;launching ;SR13942
	;JOB START1^WWWPRIMCHANGE(0,VORG1,VORG2,VORG3)::2 SET:'$TEST YYQ=1  ;07.06.04;FAN;25866;ZENTRALE DATEI ;FIS: NEIN ! IST HIER KEINE GLOBAL-REFERENZ ! YM MUSS BLEIBEN !!!
	IF YYQ=0 DO ^WWWINFO($$^WWWTEXT(383))  ;GESTARTET ;Program Has Started In Background
	IF YYQ=1 DO ^WWWINFO($$^WWWTEXT(32017)) QUIT  ;NICHT STARTEN ;Not launching 
	QUIT
	
START1(YYM,VORG1,VORG2,VORG3)  ;STARTEN PROZESS ;launching 
	;------------------------------------------------------------------
	; History:
	; 30-Mar-2006 	SC		SR13942: No longer set environment within routine. 
	; 						Maintained by calling function.	
	;------------------------------------------------------------------
	DO ^WWWVAR ;SR13942 reversed
	SET YM=YYM
	SET YOK=$$^WWWPRIMCHANGE(VORG1,VORG2,VORG3)
	QUIT
]]></Routine>
</Export>