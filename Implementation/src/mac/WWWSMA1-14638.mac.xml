<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWSMA1" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWSMA1 ;WWWSMA1;DT;SUCHFOLGE AUS WWWSMA;19.08.1999
	;
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		SUCHFOLGE AUS WWWSMA
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;| 30-May-2005		RobertW		SR12056: Attempt at Performance Increase
	;| DT	19.08.1999
	;|
	;\------------------------------------------------------------------/
	;
	;(C) DITMAR TYBUSSEK
	;YDATEI = DATEINAME ;file name 
	;YFKEY  = FESTE PRIMÄRSCHLÜSSEL
	;YAUSW  = VARIABLE PRIMÄRSCHLÜSSEL SORT AB ;Confirm. 
	;YRICHT = 0 UP ; 1 DOWN
	;YSORT  = SORTIERSCHLÜSSEL UND SORTVORGABEN ;And 
	;YANZ   = ANZAHL DER GESUCHTEN WERTE ;Number the 
	;YTEST  = TESTDATENSATZ AUS SORTEINGABEN ;out of 
	;YSKEY(YSSOR(1),YSSOR(2))=$$^WWWUMLAU(YA,1)  ;SUCHVORGABE FÜR SORTSCHLÜSSEL
	;S YSKEY0(YSSOR(1),YSSOR(2))=$TR(YA,",")  ;SUCHVORGABE ORIGINAL
	;ERGEBNIS STEHT IN WWWSOR(YUSER,"SEL",LFN,KEY)=DATENSATZ
	;ALLE KEY' STEHEN IN WWWSOR(YUSER,"KEY",KEY)=GESAMTER SCHLUESSEL
	NEW YLFN,YA,YI,YSRI,YMAXKEY,YMAL,YWILD,YTKEY,YZWV,YKEY,Q,YFILE,YFILES,YSA,YDATA
	;ZWISCHENDATEI
	;KILL ^WWWSOR(YUSER,"SEL")
	;KILL ^WWWSOR(YUSER,"KEY")
	SET YSRI=1 IF YRICHT=1 SET YSRI=-1  ;SORTIERRICHTUNG
	QUIT:YDATEI=""
	SET YDATA=$GET(^WWW001(0,YDATEI,1))
	SET YMAXKEY=+$ORDER(^WWW002(0,YDATEI,""),-1)
	IF YMAXKEY=0 SET YMAXKEY=1
	SET YMAXSOR="" FOR  QUIT:$ORDER(YSKEY(YSORT,YMAXSOR))=""  SET YMAXSOR=$ORDER(YSKEY(YSORT,YMAXSOR))  ;ANZAHL DER GESCHACHTELTEN SORTKEYS ;Number the 
	SET YA(2)="" ;LESE VARIABLE ;harvest 
	SET YMAL=0  ;GEFUNDENE SÄTZE
	SET YA(9)=0  ;AKTUELLE SATZNUMMER
	IF +YANZ=0 SET YANZ=999999999  ;MAX ANZAHL ;Number 
	;QUIT:+YSORT=0
	SET YWILD=""  ;WILD-KEY
	IF YAUSW'="" FOR YI=1:1:YMAXSOR IF $PIECE(YAUSW,",",YI)'="" DO
	. ;I $E($P(YAUSW,",",YI))="." S $P(YAUSW,",",YI)=$E($P(YAUSW,",",YI),2,999)  ;
	. SET YWILD(YI)=""
	. QUIT:$EXTRACT($PIECE(YAUSW,",",YI))'="*"
	. SET YWILD(YI)=$$^WWWUMLAU($EXTRACT($PIECE(YAUSW,",",YI),2,99),1) SET $PIECE(YAUSW,",",YI)=""
	. SET YWILD=1
	. QUIT
	IF YAUSW="" IF YSRI=-1 SET YAUSW=$CHAR(255)
	SET YFILE=YDATEI
	IF $PIECE(YDATA,Y,22)'="" SET YFILE=$PIECE(YDATA,Y,22)  ;ANDERE DATEI ;data file 
	SET YFILES=YDATEI_"s"
	IF $PIECE(YDATA,Y,23)'="" SET YFILES=$PIECE(YDATA,Y,23)  ;ANDERE SORTDATEI
	SET YSORTNAME=""
	IF +YSORT>0 D
	. SET YSORTNAME=$PIECE($GET(^WWW0013(0,YDATEI,+YSORT,1)),Y,1)
	. IF YSORTNAME="" DO
	. . IF $PIECE(YDATA,Y,8)=4 SET YSORTNAME="Index"_+YSORT
	. . IF $PIECE(YDATA,Y,8)'=4 SET YSORTNAME=+YSORT
	. . QUIT
	. QUIT
	SET YA="^"_YFILE_"("_$$^WWWYM(YDATEI,0)
	SET YA(3)=YA
	SET YA(2)="^"_YFILES_"("_$$^WWWYM(YDATEI,1)
	SET YA(2)=YA(2)_""""_YSORTNAME_""""
	IF YSORT=0 SET YA(2)="^"_YFILE_"("_$$^WWWYM(YDATEI,0)
	;FIXKEY VORGABE  ;default 
	;S YI=2
	;F YI=1:1 Q:$P(YFKEY,",",YI)=""  I $P(YFKEY,",",YI)=$P(YAUSW,",",YI) S $P(YAUSW,",",YI)=""
	FOR YI=1:1:YMAXSOR IF $EXTRACT(YAUSW,1)="," SET YAUSW=$EXTRACT(YAUSW,2,999)
	;VORGABEN VERTEILEN ;distribute 
	SET YQ=0
	IF YAUSW'="" FOR YI=0:1:YMAXSOR SET YAUSW(YI)="" IF $PIECE(YAUSW,",",YI)'="" DO 
	. IF YI'=1 IF $FIND($PIECE(YAUSW,",",YI),"*") SET YQ=1
	. SET YAUSW(YI)=$$^WWWUMLAU($TRANSLATE($PIECE(YAUSW,",",YI),"*"),1)
	. QUIT:YQ=1
	. IF YSORT'=0 SET YA(2)=YA(2)_","_""""_$$^WWWUMLAU($TRANSLATE($PIECE(YAUSW,",",YI),"*"_""""),1)_""""
	. IF YSORT=0 SET YA(2)=YA(2)_","_""""_$TRANSLATE($PIECE(YAUSW,",",YI),"*"_"""")_""""
	. QUIT
	SET YQ=0
	IF +YAUSW'=0 IF YSRI=-1 SET YA(2)=YA(2)_","_""""_$CHAR(255)_""""
	;STOPVORGABEN
	SET YA(1)="^"_YFILE_"("_$$^WWWYM(YDATEI,1)
	SET YA(11)="^"_YFILES_"("_$$^WWWYM(YDATEI,1)
	SET YA(11)=YA(11)_""""_YSORTNAME_""""
	IF +YSORT=0 SET YA(11)="^"_YFILE_"("_$$^WWWYM(YDATEI,1)
	SET YA(2)=YA(2)_")"
	IF $FIND(YA(2),"(,") SET YA(2)=$PIECE(YA(2),"(,",1)_"("_$PIECE(YA(2),"(,",2,99)
	IF $FIND(YA(2),",)") SET YA(2)=$PIECE(YA(2),",)",1)_")"
	IF $FIND(YA(11),"(,") SET YA(11)=$PIECE(YA(11),"(,",1)_"("_$PIECE(YA(11),"(,",2,99)
	IF $FIND(YA(11),",)") SET YA(11)=$PIECE(YA(11),",)",1)_")"
	IF $PIECE(YDATA,Y,12)'="" IF $PIECE(YDATA,Y,13)'="" DO  ;UCI UND VOL ;UCI And 
	. SET YA(11)="^["_""""_$PIECE(YDATA,Y,12)_""""_","_""""_$PIECE(YDATA,Y,13)_""""_"]"_$PIECE(YA(11),"^",2,999)
	. SET YA(2)="^["_""""_$PIECE(YDATA,Y,12)_""""_","_""""_$PIECE(YDATA,Y,13)_""""_"]"_$PIECE(YA(2),"^",2,999)
	. QUIT
	IF YAUSW=$CHAR(255) SET YAUSW=""
	IF +YSORT=0 IF $PIECE(YDATA,Y,8)=4 IF $DATA(@(YA(2)))#10=1 SET YA=YA(2) DO SATZ1   ;DATENSATZ VORHANDEN ;data record on hand 
	FOR  DO SATZ QUIT:YA=""  QUIT:YA(2)=""  QUIT:YANZ<YMAL  QUIT:YANZ=YMAL
	QUIT
	
SATZ ;ZWISCHENSATZ SPEICHERN ;Save 
	DO NEXTS 
	DO SATZ1
	QUIT
	
SATZ1 ;
	QUIT:YA=""
	QUIT:YA(2)=""
	IF '$FIND(YA,"^[") IF YFILE=YDATEI QUIT:YDATEI'=$PIECE($PIECE(YA,"^",2),"(",1)
	SET YKEY=$TRANSLATE($PIECE($PIECE($PIECE(YA,"(",2),",",2,99),",1)",1),"""")
	IF YKEY="" SET YKEY=$TRANSLATE($PIECE($PIECE(YA,"(",2),")",1),"""")
	IF $FIND(YKEY,")") SET YKEY=$PIECE(YKEY,")",1)
	QUIT:YKEY=""
	QUIT:$FIND(YKEY,")")
	SET YTKEY=YKEY
	SET YAUSWAHL=YAUSW
	QUIT:$DATA(^WWWSOR(YUSER,"SEL",YTKEY))
	SET ^WWWSOR(YUSER,"SEL",YTKEY)=""
	SET YMAL=YMAL+1
	SET YSA=YA
	IF $PIECE(YDATA,Y,22)'="" SET YSA="^"_YDATEI_"("_$PIECE(YSA,"(",2,99)   ;DT
	SET ^WWWSOR(YUSER,"KEY",YMAL,YKEY)=YSA
	QUIT
	
NEXTS ;NACHSTER DATENSATZ IN SORTFOLGE ;data record within 
	NEW YQ
	FOR  DO  QUIT:YA=""  QUIT:YQ=1  QUIT:Q=1
	. SET YQ=1
	. IF YA(2)="" SET YA="" QUIT
	. SET YA(9)=YA(9)+1
	. SET YA(2)=$QUERY(@YA(2),YSRI)
	. ;
	. ;
	. ;
	. ;PRUEFEN SORTENDE ODER WEITER ;Or ulterior 
	. ;
	. ;PRUFEN VORGABEN AUSSORTKEY
	. SET Q=0
	. SET YI="" FOR  SET YI=$ORDER(YAUSW(YI)) QUIT:YI=""  DO  QUIT:Q=1
	. . QUIT:$GET(YAUSW(YI))=""
	. . IF YSORT'=0 DO 
	. . . IF $PIECE(YDATA,Y,8)'=4  IF $EXTRACT($TRANSLATE($PIECE(YA(2),",",YI+2),""""),1,$LENGTH(YAUSW(YI)))'=YAUSW(YI) SET Q=1  ;NICHT ENTHALTEN ;Not include 
	. . . IF $PIECE(YDATA,Y,8)=4  IF $EXTRACT($TRANSLATE($PIECE(YA(2),",",YI+1),""""),1,$LENGTH(YAUSW(YI)))'=YAUSW(YI) SET Q=1  ;NICHT ENTHALTEN ;Not include 
	. . . QUIT
	. . IF YSORT=0 IF $EXTRACT($$^WWWUMLAU($TRANSLATE($PIECE(YA(2),",",YI+1),""""),1),1,$LENGTH(YAUSW(YI)))'=YAUSW(YI) SET Q=1  ;NICHT ENTHALTEN ;Not include 
	. . QUIT
	. IF Q=1 SET Q=0 SET YA="" QUIT
	. ;
	. ;PRUFEN WILD KEY AUS SORTKEY ;wild KEY out of 
	. IF YWILD'="" SET YI="" FOR  SET YI=$ORDER(YWILD(YI)) QUIT:YI=""  DO  QUIT:Q=1
	. . QUIT:$GET(YWILD(YI))=""
	. . IF '$FIND(YA(2),YWILD(YI)) SET Q=1
	. . QUIT
	. IF Q=1 SET Q=0 SET YQ=0  ; GOTO NEXTS
	. ;
	. IF YFKEY'="" IF YA(2)'="" IF '$FIND($TRANSLATE(YA(2),""""),$TRANSLATE(","_YFKEY,"""")) SET YQ=0  ;GOTO NEXTS  ;NICHT IM NEXTKEY ;Not 
	. ;ENDE ERREICHT ;termination 
	. ;
	. IF '$FIND($TRANSLATE(YA(2),""""),$TRANSLATE(YA(11),"""")) SET YA="" QUIT  ;ENDE DES MANDANTEN ;termination 
	. ;
	. ;SUCHEN DATENSATZ ;seek data record 
	. IF +YSORT'=0 DO  QUIT:YA=""   ;SORTKEY
	. . IF YA(2)="" SET YA="" QUIT
	. . SET YMAXSKEY=$LENGTH(YA(2),",")
	. . SET YPR=$PIECE(YA(2),")",1)
	. . SET YA=YA(3)
	. . FOR YI=(YMAXSKEY-YMAXKEY+1):1:YMAXSKEY SET:$EXTRACT(YA,$LENGTH(YA))'="," YA=YA_"," SET YA=YA_$PIECE(YPR,",",YI)
	. . SET YA=YA_")"
	. . IF $FIND(YA,"(,") SET YA=$PIECE(YA,"(,",1)_"("_$PIECE(YA,"(,",2,99)
	. . IF $FIND(YA,",)") SET YA=$PIECE(YA,",)",1)_")"
	. . IF $PIECE(YDATA,Y,8)'=4 SET YA=$QUERY(@YA)  ;LESEN DATENSATZ ;read data record 
	. . QUIT
	. ;
	. IF +YSORT=0 DO  QUIT:YA=""   ;PRIMÄRSCHL.
	. . IF YA(2)="" SET YA="" QUIT
	. . SET YA=YA(2)
	. . QUIT
	. ;
	. ;FINDEN SONDERAUSWAHLEN ;find 
	. ;SET YQ1=$PIECE(YTEST,Y,999) IF '$FIND($$^WWWUMLAU($PIECE(YA,",",2),1),YQ1) SET Q=1  ;PRUEFEN KEY
	. ;SET YAS=@YA   ;LESEN SATZ ;table-mat read typesetting 
	. SET YSA=YA
	. IF $PIECE(YDATA,Y,22)'="" SET YSA="^"_YDATEI_"("_$PIECE(YSA,"(",2,99)   ;DT
	. ;
	. SET YAS=$$^WWWSETL(YSA)
	. SET Q=0
	. ;
	. ;
	. ;
	. SET YQ1="" FOR YI=1:1 SET YQ1=$ORDER(YSKEY(YQ1)) QUIT:YQ1=""  DO  QUIT:Q=1 
	. . SET YDAF=$GET(YSKEY1(YQ1,1))  ;DATENFELDNUMMER
	. . SET YDAS=$GET(YSKEY0(YQ1,1))   ;ORIGINALFELD
	. . SET YDAA=$$^WWWUMLAU($PIECE(YAS,Y,+YDAF),1)  ;DATENFELD, DAS GEPRUEFT WIRD 
	. . ;IF +YSORT=0 SET YDAA=$$^WWWUMLAU($PIECE(YA,",",+YDAF+1),1)  ;KEYFELD, DAS GEPRUEFT WIRD 
	. . IF +YSORT=0 SET YDAA=$TRANSLATE($PIECE(YA,",",+YDAF+1),"""")   ;KEYFELD, DAS GEPRUEFT WIRD 
	. . IF $EXTRACT(YDAS)="*" DO  QUIT  ;WENN VOLLTEXT ;when full text 
	. . . IF YDAA="" SET Q=1 QUIT
	. . . ;IF '$FIND($$^WWWUPER(YDAA),$$^WWWUPER($EXTRACT($GET(YSKEY(YQ1,1)),2,99)),";") SET Q=1 QUIT
	. . . IF '$FIND($zconvert(YDAA,"U"),$zconvert($EXTRACT($GET(YSKEY(YQ1,1)),2,99),"U"),";") SET Q=1 QUIT
	. . . QUIT
	. . ;IF '$FIND($GET(YSKEY(YQ1,1)),";")=";" IF $EXTRACT($$^WWWUPER(YDAA),1,$PIECE($LENGTH($GET(YSKEY(YQ1,1))),";",1))'=$PIECE($$^WWWUPER($GET(YSKEY(YQ1,1))),";",1) SET Q=1  ; NICHT $E DES FELDES
	. . IF '$FIND($GET(YSKEY(YQ1,1)),";")=";" IF $EXTRACT($zconvert(YDAA,"U"),1,$PIECE($LENGTH($GET(YSKEY(YQ1,1))),";",1))'=$PIECE($zconvert($GET(YSKEY(YQ1,1)),"U"),";",1) SET Q=1  ; NICHT $E DES FELDES
	. . IF $FIND($GET(YSKEY(YQ1,1)),";")=";" DO  ;WENN MIT ;TYBD;18,10,2004;26525
	. . .NEW YI
	. . .SET Q=1
	. . .;FOR YI=1:1 QUIT:$PIECE($GET(YSKEY(YQ1,1)),";",YI)=""  IF $EXTRACT($$^WWWUPER(YDAA),1,$PIECE($LENGTH($GET(YSKEY(YQ1,1))),";",YI))=$PIECE($$^WWWUPER($GET(YSKEY(YQ1,1))),";",YI) SET Q=0  ; $E DES FELDES
	. . .FOR YI=1:1 QUIT:$PIECE($GET(YSKEY(YQ1,1)),";",YI)=""  IF $EXTRACT($zconvert(YDAA,"U"),1,$PIECE($LENGTH($GET(YSKEY(YQ1,1))),";",YI))=$PIECE($zconvert($GET(YSKEY(YQ1,1)),"U"),";",YI) SET Q=0  ; $E DES FELDES
	. . QUIT
	. ;
	. ;
	. ;FOR YI=1:1 SET YQ1=$PIECE(YTEST,Y,YI) QUIT:$PIECE(YTEST,Y,YI,99)=""  IF YQ1'="" DO  QUIT:Q=1
	. ;.IF '$FIND($$^WWWUMLAU($PIECE(YAS,Y,YI),1),YQ1) SET Q=1  ;NICHT ERHALTEN
	. ;.QUIT
	. ;
	. IF Q=1 SET Q=0 SET YQ=0 QUIT  ;GOTO NEXTS
	. ;
	. IF YWILD="" IF '$FIND($TRANSLATE(YA,""""),$TRANSLATE(YA(1),"""")) SET YA=""
	. QUIT
	QUIT
]]></Routine>
</Export>