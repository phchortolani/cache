<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INARTPREISBEPROM2" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INARTPREISBEPROM2 ;INARTPREISBE2;BEC;RECHNEN PREIS PROMOTION;02.02.2003
	;
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		RECHNEN PREIS PROMOTION
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;|
	;| BEC	02.02.2003
	;|
	;\------------------------------------------------------------------/
	;
	NEW BASIS,BASISPR,PREIS,PREIS1,YPREIS,WARENGRUPPE,FORMEL,SPERRE,COLOR,ERROR
	SET ERROR=""
	SET ERROR(1)=""
	;KILL WWWSOR(YUSER)
	KILL ^WWWSOR(YUSER) ;SR13246
	QUIT:$GET(YKEY)=""
	SET VORG(3)=$GET(VORG(3))  ;AUF/ABSCHLAG
	DO BERECHNEN  ;PREIS BERECHNEN ;prize calculate 
	QUIT
	
BERECHNEN ;PREIS BERECHNEN ;prize calculate 
	NEW ART,ART1,BETRIEB,AKTION,WARENGRUPPE,FORMEL,YFELD,KEY1,OK
	SET BETRIEB=$PIECE(YKEY,",",1)
	SET PROM=$PIECE(YKEY,",",2)
	QUIT:BETRIEB=""
	QUIT:PROM=""
	IF $PIECE($GET(^INARTPREISBEPROM(YM,BETRIEB,PROM,1)),Y,26)'=1 QUIT    ;=1 NEU RECHEN ;recent 
	SET ART="" FOR  SET ART=$ORDER(^INARTPREISBEPROM2(YM,BETRIEB,PROM,ART)) QUIT:ART=""  DO
	. SET ART1=$GET(^INART(YM,ART,1))
	. SET WARENGRUPPE=$PIECE(ART1,Y,30)
	. IF WARENGRUPPE="" SET WARENGRUPPE=$PIECE($GET(^INVORG(YM,YM,1)),Y,13)
	. IF WARENGRUPPE="" SET WARENGRUPPE=1
	. ;
	. ;IF '$DATA(^INKALKPREIS(YM,WARENGRUPPE)) SET WARENGRUPPE=$PIECE($GET(^INVORG(YM,YM,1)),Y,13)    ;BEC;24667;STANDARTWARENGRUPPE AUS ABLAUFVORGABEN
	. ;IF WARENGRUPPE="" IF ERROR(1)="" DO
	. ;.WRITE "<FONT COLOR="_YRED_">"
	. ;.WRITE "&nbsp;"
	. ;.WRITE $$^WWWTEXT(33672)  ;BEC;24667;Keine Preisbeziehugen für die Warengruppe oder Standartwarengruppe definiert definiert
	. ;.SET ERROR(1)=1
	. ;.WRITE "</FONT><BR>"
	. ;.QUIT
	. ;IF $GET(WARENGRUPPE)'="" DO
	. DO
	. . ;DO BASIS ;BASISPREIS FESTLEGEN              ;BEC;25799;28.05.04
	. . SET BASISPR=$$^INSALESPRICE(ART,1,BETRIEB,,,,,,,,1)   
	. . QUIT:BASISPR=""
	. . SET FORMEL=VORG(3)
	. . SET YPREIS=BASISPR
	. . DO RECHFORMEL
	. . SET YFELD=$GET(^INARTPREISBEPROM2(YM,BETRIEB,PROM,ART,1))
	. . SET $PIECE(YFELD,Y,2)=YPREIS
	. . SET $PIECE(YFELD,Y,5)=BASISPR
	. . IF BASISPR=0 SET $PIECE(YFELD,Y,5)=""                                  ;BEC;23.06.03;DAMIT NICHT 0 IM DATENFELD STEHT ;therewith Not data item 
	. . IF YPREIS=0 SET $PIECE(YFELD,Y,2)=""                                   ;BEC;23.06.03;DAMIT NICHT 0 IM DATENFELD STEHT ;therewith Not data item 
	. . SET $PIECE(YFELD,Y,6)=WARENGRUPPE
	. . SET FORMEL=$PIECE(YFELD,Y,3)
	. . IF FORMEL'="" DO
	. . . DO RECHFORMEL  ;KORRIGIERTEN PREIS BERECHNEN ;prize calculate 
	. . . SET $PIECE(YFELD,Y,4)=YPREIS
	. . . QUIT
	. . SET KEY1=BETRIEB_","_PROM_","_ART
	. . SET OK=$$^WWWSPEI("INARTPREISBEPROM2",KEY1,YFELD,1)
	. . QUIT
	. SET $PIECE(^INARTPREISBEPROM(YM,BETRIEB,PROM,1),Y,26)=0     ;=0 NICHT MEHR NEU RECHNEN ;Not more recent have faith in 
	. QUIT
	QUIT
	
RECHFORMEL ;FORMEL AUSRECHNEN ;formula 
	NEW WERT,AKTION,YI,FORMEL1,WERT1
	SET WERT=""  
	QUIT:FORMEL=""
	IF $FIND(FORMEL,"%") DO
	. FOR YI=1:1:2 DO  QUIT:$PIECE(FORMEL,"%",YI,99)=""
	. . IF YI=1 SET AKTION="%"
	. . IF YI=2 SET AKTION=""
	. . SET FORMEL1=$PIECE(FORMEL,"%",YI)
	. . SET VZ="+" 
	. . SET WERT1=FORMEL1
	. . IF $EXTRACT(FORMEL1,1)="-" SET VZ="-" SET WERT1=$EXTRACT(FORMEL1,2,999)
	. . IF $EXTRACT(FORMEL1,1)="+" SET VZ="+" SET WERT1=$EXTRACT(FORMEL1,2,999)
	. . IF AKTION="" SET WERT1=$$^WWWTR(1,8,FORMEL1)
	. . IF AKTION'="" DO
	. . . IF AKTION="%" SET WERT1=($TRANSLATE(WERT1,",",".")/100)*YPREIS
	. . . IF VZ="+" SET WERT1=YPREIS+WERT1
	. . . IF VZ="-" SET WERT1=YPREIS-WERT1
	. . . QUIT
	. . SET WERT=WERT+WERT1
	. . QUIT
	. QUIT
	IF '$FIND(FORMEL,"%") IF FORMEL'="" SET WERT=$$^WWWTR(1,8,FORMEL)
	IF '$FIND(FORMEL,"%") IF FORMEL'="" IF $FIND(FORMEL,"+") SET WERT=YPREIS+$$^WWWTR(1,8,FORMEL)  ;YPREIS DATEI ;data file 
	IF '$FIND(FORMEL,"%") IF FORMEL'="" IF $FIND(FORMEL,"-") SET WERT=YPREIS+$$^WWWTR(1,8,FORMEL)  ;YPREIS AUS DATEI ;out of data file 
	SET YPREIS=WERT
	QUIT
	
BASIS ;BASISPREIS FESTLEGEN
	NEW VZ,WERT,AKTION
	SET BASISPR=""  ;BASISPREIS
	SET BASIS=""    ;KENZEICHEN FÜR BASISPREIS ;to 
	SET AKTION=""
	SET PREIS="" FOR  SET PREIS=$ORDER(^INKALKPREIS(YM,WARENGRUPPE,PREIS)) QUIT:PREIS=""  DO
	. SET PREIS1=$GET(^INKALKPREIS(YM,WARENGRUPPE,PREIS,1))
	. QUIT:$PIECE(PREIS1,Y,2)'=""
	. SET BASIS=PREIS
	. SET FORMEL=$PIECE(PREIS1,Y,3)
	. SET BASISPR=""
	. SET BASISPR=$PIECE(ART1,Y,47)
	. SET YPREIS=BASISPR
	. DO RECHFORMEL
	. SET BASISPR=YPREIS
	. QUIT
	IF ERROR="" IF +BASISPR=0 DO
	. WRITE "<FONT COLOR="_YRED_">"
	. WRITE "&nbsp;"
	. IF $PIECE($GET(^INART(YM,$PIECE(YKEY,",",1),1)),Y,47)'="" WRITE "<BR>",$$^WWWTEXT(33326)  ;KEIN BASISPREIS VORHANDEN ;no on hand 
	. IF $PIECE($GET(^INART(YM,$PIECE(YKEY,",",1),1)),Y,47)="" WRITE "<BR>",$$^WWWTEXT(33673)    ;KEINE HERTELLKOSTEN VORHANDEN oder Lieferantenkonditionen vorhanden ;no on hand or on hand 
	. IF $GET(WARENGRUPPE)'="" IF '$DATA(^INKALKPREIS(YM,WARENGRUPPE)) WRITE "<BR>",$$^WWWTEXT(33672)   ;Keine Preisbeziehugen für die Warengruppe oder Standartwarengruppe definiert definiert ;BEC;24667;STANDARTWARENGRUPPE AUS ABLAUFVORGABEN
	. SET ERROR=1
	. WRITE "</FONT><BR>"
	. QUIT
	QUIT
]]></Routine>
</Export>