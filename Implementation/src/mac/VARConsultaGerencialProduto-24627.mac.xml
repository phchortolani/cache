<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="VARConsultaGerencialProduto" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
VARConsultaGerencialProduto
#include COMSYS
#include INConst
 
ExecutarConsulta() 
	new Item, Local, Key
	set Item = $get(VORG(1))
	set Local = $get(VORG(2))  
	set Key=Item_","_Local  	
 	do GoToForm^COMUtilForm("VARConsultaGerencialProduto",Key,,,,,)
 	
 	quit
 
ConsultaGerencial()
 	new idItem,idLocal
 
	set idItem = $get(VORG(1))	
	set idLocal = $get(VORG(2))
	quit:(idItem = "")
	
	do PrintConsulta(idItem,idLocal)
	
	quit
 
 
PrintConsulta(pidItem,pidLocal="") 	
	do WidgetDadosDoProduto(pidItem)
	do WidgetPosicaoDoProduto(pidItem,pidLocal)
	do WidgetIndicadoresDeReposicao(pidItem,pidLocal)
	do WidgetIndicadoresDeCompras(pidItem)
	do WidgetIndicadoresDeConsumo(pidItem)
	do WidgetIndicadoresDeMovimentacao(pidItem)
	do WidgetHistoricoMOVCMM(pidItem,pidLocal)
	//do PrintGrafico(pidItem,pidLocal)	
	quit
 
 
WidgetDadosDoProduto(pidItem)
 	new objItem, descItem, UOM, descUOM, grupo, descGrupo, custoMedio, curvaABC, isPadrao,
 		nivelAtencao, indiceXYZ
 	 	
	set objItem = $get(^INART(YM,pidItem,1))
 	
 	set descItem   	 = $$SQLGetDescricaoProduto^VARSQL(pidItem)
	set UOM		   	 = $piece(objItem,Y,40)
	set descUOM    	 = $piece($get(^WWW101(YM,"EINHEIT","PT",UOM,1)),Y,1)
	set grupo      	 = $$SQLGetGrupoItem^VARSQL(pidItem)
	set descGrupo  	 = $piece($get(^INItemGroup(YM,grupo,1)),Y,2)	
	set custoMedio   = $piece(objItem,Y,140)
	set curvaABC     = $$GetCurvaABC^VARAlertaLinha(pidItem)
	set isPadrao   	 = $$GetDescricaoPadrao^VARAlertaLinha(pidItem)
 	set nivelAtencao = $$SQLGetNivelAtencaoDesc^VARSQL(pidItem)
	set indiceXYZ    = $$GetIndiceCriticidade^VARAlertaLinha(pidItem)
	
 	if curvaABC  = "" set curvaABC  = "-"
 	if indiceXYZ = "" set indiceXYZ = "-"
		 
	write "<hr>&nbsp;<font size=3><strong>Produto: "_pidItem_" - "_descItem_"</strong></font><hr>"
	
	write "<div style=margin-left:5px>"
	write "	<table style=font-size:12px>"
	write "		<tr>"
	write "			<td>Unidade de Estoque:&nbsp;</td><td style=padding-right:50px>"_descUOM_"</td>"
	write "			<td>Grupo do Produto:</td><td colspan=2>"_descGrupo_"</td>"
	write "		</tr>"
	write "		<tr>"
	write "			<td>Padronizado?</td><td style=padding-right:50px>"_isPadrao_"</td>"
	write "			<td>Nível de Atenção:</td><td colspan=2>"_nivelAtencao_"</td>"
	write "		</tr>"	
	write "		<tr>"
	write "			<td>Classificação ABC:</td><td style=padding-right:50px>"_curvaABC_"</td>"
	write "			<td>Classificação XYZ:&nbsp;</td><td>"_indiceXYZ_"</td>"
	write "			<td align=right>Custo Médio:</td><td>R$ "_$$^WWWTR(0,12,custoMedio,4)_"</td>"
	write "		</tr>"
	write "	</table>"
	write "</div><br />"
	
	quit
 
WidgetPosicaoDoProduto(pidItem,pidLocal="")
	new fltEstoqueRede, CMMRede, CMMLocal,fltEstoqueLocal, MOVRede, MOVLocal
	if $get(pidLocal)="" set pidLocal=""
	
	set fltEstoqueRede = $$GetEstoqueDisponivel^VARReposicao(pidItem)
	set CMMRede	       = $$GetCMM^VARReposicao(pidItem)
	set fltEstoqueLocal = $$GetEstoqueDisponivel^VARReposicao(pidItem,pidLocal)
	set CMMLocal	       = $$GetCMM^VARReposicao(pidItem,pidLocal)
	set MOVRede			= $$GetMOV^VARReposicao(pidItem)
	set MOVLocal		= $$GetMOV^VARReposicao(pidItem,pidLocal)
 
	write "<hr>&nbsp;<font size=3><strong>Posição do Produto</strong></font><hr>"
 
	write "<div style=margin-left:5px>"
	write "	<table style=font-size:12px>"
	write "		<tr>"
	write "			<td>"
	write "				<strong>Estoque no Hospital: </strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARStock&amp;YBACK="_YBACK_"&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY=External,"_pidItem_">"_$$^WWWTR(0,12,fltEstoqueRede,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "			<td>"
	write "				<strong>Consumo Médio Mensal:</strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARAnaliseConsumo&amp;YBACK="_YBACK_"&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL=D"_""_","_pidItem_">"_$$^WWWTR(0,12,CMMRede,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "			<td>"
	write "				<strong>Movimentação Média Mensal:</strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARAnaliseMOV&amp;YBACK="_YBACK_"&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL=D"_""_","_pidItem_">"_$$^WWWTR(0,12,MOVRede,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "		</tr>"
	write "		<tr>"
	write "			<td>"
	write "				<strong>Estoque Local: </strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARStock&amp;YBACK="_YBACK_"&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY=External,"_pidItem_">"_$$^WWWTR(0,12,fltEstoqueLocal,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "			<td>"
	write "				<strong>Consumo Médio Mensal Local:</strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARAnaliseConsumo&amp;YBACK="_YBACK_"&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL=D"_""_","_pidItem_",,"_pidLocal_">"_$$^WWWTR(0,12,CMMLocal,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "			<td>"
	write "				<strong>Movimentação Média Mensal Local:</strong>"
	write "			</td>"
	write "			<td>"
	write "				<a href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARAnaliseMOV&amp;YBACK="_YBACK_"&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL=D"_""_","_pidItem_",,"_pidLocal_">"_$$^WWWTR(0,12,MOVLocal,0)_"</a>"
	write "			</td>"
	write "			<td width=50px>&nbsp;</td>"
	write "		</tr>"
	
	write "	</table>"
	write "</div>"
 
	do TableDisponibilidadeEstoque(pidItem)
	do TableEstoqueLocaisCentrais(pidItem)
	
	quit
 
 
WidgetIndicadoresDeReposicao(pidItem,pidLocal="")
	
	new strIndicador, sitColor, sitDesc, fltCoberturaEstoque, fltES, fltPR, fltEM, fltEV, fltEP, fltSG	
	if $get(pidLocal)="" set pidLocal=""
	set strIndicador = $$GetColorAndSituation(pidItem,pidLocal)
	
	set sitColor = $piece(strIndicador,",",1)
	set sitDesc  = $piece(strIndicador,",",2)
	
	set fltCoberturaEstoque = $$GetCoberturaEstoque^VARReposicao(pidItem,pidLocal)
	set dteCoberturaEstoque = $h + fltCoberturaEstoque
	
	set fltES = $$GetEstoqueSeguranca^VARReposicao(pidItem,pidLocal)
	set fltPR = $$GetPontoRessuprimento^VARReposicao(pidItem,pidLocal)
	set fltEM = $$GetEstoqueMaximo^VARReposicao(pidItem,pidLocal)
	set fltEV = $$GetEstoqueVirtual^VARReposicao(pidItem,pidLocal)
	set fltEP = $$GetQuantidadePendenteReq^VARReposicao(pidItem,pidLocal)
	set fltEP = fltEP+ $$GetQuantidadePendenteCompra^VARReposicao(pidItem,pidLocal)
	set fltSG = $$GetSugestao^VARReposicao(pidItem,pidLocal)
	
	
	
	write "	<hr>&nbsp;<font size=3><strong>Indicadores de Reposição</strong></font><hr>"
	
	//write "&nbsp;Nota: <em>os indicadores de reposição ainda não estão disponíveis.</em><br />"
	
	
	write "	<div style=margin-left:5px>"
	write "		<table style=font-size:12px>"
	write "			<tr height=30px>"
	write "				<td><strong>Situação:&nbsp;</strong></td>"
	write "				<td style=padding-left:10px;padding-right:10px;border-style:solid;border-width:2px;border-color:white; bgcolor="_sitColor_"><strong>"_sitDesc_"</strong></td>"
	write "					<td style=padding-left:50px><strong>Cobertura de Estoque:</strong> "_$$^WWWTR(0,12,fltCoberturaEstoque,0)_" dias (Até "_$zdate(dteCoberturaEstoque,4)_")</td>"
	write "				</tr>"
	write "		</table>"
		
	write "		<table style=font-size:12px;margin-top:6px>"
	write "			<tr height=20px>"
	write "				<td><strong>Estoque de Segurança:</strong></td><td align=right style=padding-right:50px;>"_$$^WWWTR(0,12,fltES,0)_"</td>"
	write "				<td><strong>Ponto de Ressuprimento:</strong></td><td align=right style=padding-right:50px;>"_$$^WWWTR(0,12,fltPR,0)_"</td>"
	write "				<td><strong>Estoque Máximo:</strong></td><td align=right>"_$$^WWWTR(0,12,fltEM,0)_"</td>"
	write "			</tr>"
	write "			<tr height=20px>"
	write "				<td><strong>Estoque Virtual:</strong></td><td align=right style=padding-right:50px;>"_$$^WWWTR(0,12,fltEV,0)_"</td>"
	write "				<td><strong>Encomendas Pendentes:</strong></td><td align=right style=padding-right:50px;>"_$$^WWWTR(0,12,fltEP,0)_"</td>"
	write "				<td><strong>Sugestão de Reposição:</strong></td><td align=right>"_$$^WWWTR(0,12,fltSG,0)_"</td>"
	write "			</tr>"	
	write "		</table>"
	write "	</div>"
	
	
	quit
 
 
WidgetIndicadoresDeCompras(pidItem)
 
	write "<br /><hr>&nbsp;<font size=3><strong>Indicadores de Compras</strong></font><hr>"
	do TableUltimosPrecos(pidItem)
	;do TableAtasVigentes(pidItem)
	do TableComprasAguardRecebimento(pidItem)
	do TablePedidosAguardCompra(pidItem)
 
	quit
 
 
WidgetIndicadoresDeConsumo(pidItem)
 
	write "<br /><hr>&nbsp;<font size=3><strong>Indicadores de Consumo</strong></font><hr>"
	//write "&nbsp;Nota: <em>os indicadores de consumo ainda não estão disponíveis.</em><br /><br />"
	
	do TableLocaisMaiorConsumo(pidItem)
	do TableTratamentosEmAberto(pidItem)
 
	quit
	
WidgetIndicadoresDeMovimentacao(pidItem)
 
	write "<br /><hr>&nbsp;<font size=3><strong>Indicadores de Movimentação</strong></font><hr>"
	//write "&nbsp;Nota: <em>os indicadores de consumo ainda não estão disponíveis.</em><br /><br />"
	
	do TableLocaisMaiorMovimentacao(pidItem)
 
	quit
	
WidgetHistoricoMOVCMM(pidItem,pidLocal)
 
	write "<br /><hr>&nbsp;<font size=3><strong>Histórico CMM/MOV</strong></font><hr>"
	//write "&nbsp;Nota: <em>os indicadores de consumo/movimentação ainda não estão disponíveis.</em><br /><br />"
	do TableHistoricoMOVCMM(pidItem,pidLocal)
	
	quit
 
TableDisponibilidadeEstoque(pidItem)
	new formulaData, meuSQL, codLocal, qtdeEstoque, count, descLocal
 
	write "<div style=margin-top:10px;margin-left:8px;float:left;margin-right:50px;margin-bottom:6px;font-size:12px>"
	write "<strong>Locais com Maior Disponibilidade de Estoque</strong>&nbsp;&nbsp; " ;[ Ver todos ]"
	write "<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px;>" //Detalhes do Item
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;padding-right:4px;><em>Código</em></td>"
	write "			<td style=padding-left:6px;padding-right:4px;><em>Local</em></td>"
	write "			<td style=padding-left:6px;padding-right:4px;><em>Qtde. Estoque</em></td>"
	write "		</tr>"
	
	set formulaData = ##class(%ResultSet).%New()  ;Create Result Set Object
		
		set meuSQL = "SELECT TOP 5 "
		set meuSQL = meuSQL_" Location, "
		set meuSQL = meuSQL_" $$GetEstoqueDisponivel^VARReposicao("_pidItem_",Location) as Estoque"
		set meuSQL = meuSQL_" FROM WWW0121"
		set meuSQL = meuSQL_" WHERE $UPPER(StorageLocn) = 1"
		set meuSQL = meuSQL_" ORDER BY Estoque Desc"
	
	do formulaData.Prepare(meuSQL)  ;Prepare Query
	do formulaData.Execute()  ;Execute Query
 
		set count = 0
		
		while (formulaData.Next()) {		
			set codLocal 	= formulaData.GetData(1)
			set qtdeEstoque = formulaData.GetData(2)
			
			continue:(qtdeEstoque <= 0)
			
			set count = $i(count)
			
			set descLocal = $piece($get(^WWW0121(YM,YM,codLocal,1)),Y,1)
			set keyLink   = "External"_$$$COMMA_pidItem_$$$COMMA_codLocal
			
			write "<tr>"
			write "		<td height=18px style=padding-left:6px;padding-right:4px>"
			write "			"_codLocal
			write "		</td>"
			write "		<td style=padding-left:6px;padding-right:4px>"
			write "			<a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARStock&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY="_keyLink_">"_descLocal_"</a>"
			write "		</td>"			
			write "		<td align=right style=padding-right:4px;>"
			write "			<a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARStock&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY="_keyLink_">"_$$^WWWTR(0,12,qtdeEstoque,0)_"</a>"
			write "		</td>"
			write " </tr>"
		}
	
	do formulaData.Close()
	
	if count = 0 write "<tr><td colspan=3 height=18px style=padding-left:6px;padding-right:4px> Nenhum saldo em estoque disponível.</td></tr>"
 
	write "</table></div>"
	
	quit
	
TableEstoqueLocaisCentrais(pidItem)
 	
	write "<div style=margin-top:10px;margin-bottom:6px;font-size:12px><strong>Estoque nos Locais Centrais</strong>"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px;>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;padding-right:4px;><em>Código</em></td>"
	write "			<td style=padding-left:6px;padding-right:4px;><em>Local</em></td>"
	write "			<td style=padding-left:6px;padding-right:4px;><em>Qtde. Estoque</em></td>"
	write "		</tr>"
	
	new cnt, strLocaisCentrais, Local, fltEstoqueLocal, fltEstoqueCentral, descLocal
		
	set strLocaisCentrais = $$getLocaisCentraisEstoque^VARParametroCliente(YM)
	quit:(strLocaisCentrais = "") ""
	set fltEstoqueCentral=0
	for cnt = 1:1:$length(strLocaisCentrais,";") {
	   	set idLocal = $piece(strLocaisCentrais,";",cnt)
	   	
	   	set fltEstoqueLocal = $$GetEstoqueDisponivel^VARReposicao(pidItem,idLocal)
	   	set fltEstoqueCentral = fltEstoqueCentral+fltEstoqueLocal
	   	if fltEstoqueLocal = "" { set fltEstoqueLocal = 0 }
	   	elseif fltEstoqueLocal '= "" { set fltEstoqueLocal = $$^WWWTR(0,12,fltEstoqueLocal,0) }
	   	
	   	set descLocal = $$SQLGetLocationName^VARSQL(idLocal)

		write "	<tr>"
		write "		<td height=18px style=padding-left:6px;>"_idLocal_"</td><td style=padding-left:6px;padding-right:6px;>"_descLocal_"</td><td align=right style=padding-right:4px;>"_fltEstoqueLocal_"</td>"
		write " </tr>"
	}
	
	//set fltEstoqueCentral = $$GetEstoqueCentral^VARAlertaLinha(pidItem)
	
	if fltEstoqueCentral = "" { set fltEstoqueCentral = 0 }
	elseif fltEstoqueCentral '= "" { set fltEstoqueCentral = $$^WWWTR(0,12,fltEstoqueCentral,0) }
	
	write "	<tr>"
	write "		<td height=20px colspan=2 align=right style=padding-left:6px;padding-right:6px;border-top-width:1px;border-top-color:999999;border-top-style:solid><em>Total nos Locais Centrais</em>&nbsp;</td><td align=right style=padding-right:4px;border-top-width:1px;border-top-color:999999;border-top-style:solid>"_fltEstoqueCentral_"</td>"
	write "	</tr>"
	
	write "	</table>"
	write "</div><br clear=all /><br />" 
 
	quit	
	
 
GetColorAndSituation(pidItem,pidLocal="")
	new strColor, sitDescription
	if $get(pidLocal)="" set pidLocal=""
 
 	set FilterEstoqueAcimaPR       = $$FilterEstoqueAcimaPR^VARReposicao(pidItem,pidLocal)
	set FilterEstoqueProximoPR     = $$FilterEstoqueProximoPR^VARReposicao(pidItem,pidLocal)
	set FilterEstoqueAbaixoPRcomEP = $$FilterEstoqueAbaixoPRcomEPAcimaPR^VARReposicao(pidItem,pidLocal)
	set FilterEstoqueAbaixoPR = $$FilterEstoqueAbaixoPR^VARReposicao(pidItem,pidLocal)
	set FilterEstoqueAcimaEM       = $$FilterEstoqueAcimaEM^VARReposicao(pidItem,pidLocal)
	
	if FilterEstoqueAcimaPR = 1 {
		set strColor = "#92d39e"
		set sitDescription = "Estoque Acima do Ponto de Ressuprimento"
	
	} elseif FilterEstoqueProximoPR = 1 {
		set strColor = "#f3f2b5"
		set sitDescription = "Estoque Próximo do Ponto de Ressuprimento"
	
	} elseif FilterEstoqueAbaixoPRcomEP = 1 {
		set strColor = "#f8d08b"
		set sitDescription = "Estoque Abaixo do Ponto de Ressuprimento com Pedido Suficiente"
	
	} elseif FilterEstoqueAbaixoPR = 1 {
		set strColor = "#e94848"
		set sitDescription = "Estoque Abaixo do Ponto de Ressuprimento"
	
	} elseif FilterEstoqueAcimaEM = 1 {
		 set strColor = "#b5c1d7"
		 set sitDescription = "Estoque Acima de 6 Meses"
	}
 
	quit strColor_","_sitDescription
 
TableUltimosPrecos(pidItem)
	new formulaData, fltQty, fltPrice, fltTotal, fabricante, descSupplier, dteOrder, idCompra, empenho,
		idSupplier, key
 	
 	set key = "External"_$$$COMMA_pidItem
 	
	write "<div style=margin-left:8px;font-size:12px>"
	write "	<strong><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARBancoPreco&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY="_key_">Histórico de Preços</a></strong><br />"

	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:8px;padding-right:4px;><em>#</em></td>"
	write "			<td height=20px style=padding-left:8px;><em>Data</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Preço Unitário</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Quantidade</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Valor Total</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Ordem de Compra</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Fornecedor</em></td>"
	;write "         <td height=20px style=padding-left:8px;padding-right:8px><em>Empenho</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Fabricante</em></td>"
	write "		</tr>"
	
	set formulaData = ##class(%ResultSet).%New()  ;Create Result Set Object
		
	set meuSQL = "SELECT TOP 10 *"
	set meuSQL = meuSQL_"FROM Report.VARHistoricoPrecoCompra"
	set meuSQL = meuSQL_" WHERE Produto = "_pidItem
	set meuSQL = meuSQL_" ORDER BY TO_CHAR(Ordenamento,'YYYY/MM/DD HH:MM:SS') DESC"
		
	do formulaData.Prepare(meuSQL) ;Prepare Query
	do formulaData.Execute()  	   ;Execute Query
		
	set count = 0
		
	while (formulaData.Next()) {		
		set fltQty       = formulaData.GetData(1)
		set fltPrice     = formulaData.GetData(2)
		;set item        = formulaData.GetData(3)
		set fltTotal     = formulaData.GetData(4)
		set fabricante   = formulaData.GetData(5)
		set descSupplier = formulaData.GetData(6)
		set dteOrder     = formulaData.GetData(7)
		set idCompra     = formulaData.GetData(8)
		set empenho	     = formulaData.GetData(9)
		
		set idSupplier = $$getFornecedorCompra^VARCompra(idCompra)
		
		set count = $i(count)
		
		write "	<tr>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;>"_count_"</td>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;>"_$extract(dteOrder,1,10)_"</td>"
		write "		<td align=right height=18px style=padding-left:8px;padding-right:8px;><strong>"_$$FormatCurrency^COMTable(fltPrice)_"</strong></td>"
		write "     <td align=right height=18px style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,fltQty,0)_"</td>"
		write "		<td align=right height=18px style=padding-left:8px;padding-right:8px;>"_$$FormatCurrency^COMTable(fltTotal)_"</td>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARCompra&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YKEY="_idCompra_">"_idCompra_"</a></td>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=INLIEF&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY="_idSupplier_">"_$extract(descSupplier,1,30)_"</a></td>"			
		;write "     <td height=18px style=padding-left:8px;padding-right:8px;>"_empenho_"</td>"
		write "	</tr>"
	}
	
	do formulaData.Close()
 	
 	if count = 0 write " <tr><td colspan=8 height=18px style=padding-left:6px;>Nenhuma compra histórica disponível para o produto.</td></tr>"
 	
	write "	</table>"
	write "</div>"	
	write "<br />"
	
	quit
	
TableAtasVigentes(pidItem)
	new formulaData, meuSQL, count, idAta, idAtaLinha, idProduto, idUnidade, fltQuantidade, fltPrice, idFornecedor,
		dteAta, fltSaldoItem
 	
	write "<div style=margin-left:8px;font-size:12px>"
	write "	<strong>Atas de Registro de Preço vigentes</strong><br />"

	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:8px;padding-right:4px;><em>#</em></td>"
	write "			<td height=20px style=padding-left:8px;><em>Ata</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Item</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Fornecedor</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Quantidade</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Saldo</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px><em>Preço Unitário</em></td>"
	write "		</tr>"
	
	set formulaData = ##class(%ResultSet).%New()  ;Create Result Set Object
		
	set meuSQL = "SELECT AtaLinha.CodAta,"
	set meuSQL = meuSQL_" AtaLinha.LinhadaAta,"
	set meuSQL = meuSQL_" AtaLinha.Produto,"
	set meuSQL = meuSQL_" AtaLinha.Unidade,"
	set meuSQL = meuSQL_" AtaLinha.Quantidade,"
	set meuSQL = meuSQL_" AtaLinha.ValorUnitario,"
	set meuSQL = meuSQL_" AtaLinha.Fornecedor,"
	set meuSQL = meuSQL_" Ata.DataHomologacao"
	set meuSQL = meuSQL_" FROM VARAta Ata"
	set meuSQL = meuSQL_" LEFT JOIN VARAtaLinha AtaLinha on (Ata.CodAta = AtaLinha.CodAta)"
	set meuSQL = meuSQL_" WHERE UPPER(AtaLinha.Produto) = "_pidItem
	set meuSQL = meuSQL_" ORDER BY Ata.DataHomologacao DESC"
		
	do formulaData.Prepare(meuSQL) ;Prepare Query
	do formulaData.Execute()  	   ;Execute Query
		
	set count = 0
		
	while (formulaData.Next()) {		
 		set idAta		  = formulaData.GetData(1)
 		set idAtaLinha 	  = formulaData.GetData(2)
 		set idProduto	  = formulaData.GetData(3)
 		set idUnidade	  = formulaData.GetData(4)
 		set fltQuantidade = formulaData.GetData(5)
 		set fltPrice 	  = formulaData.GetData(6)
 		set idFornecedor  = formulaData.GetData(7)
 		set dteAta		  = formulaData.GetData(8)

 		//Somente mostrar atas que ainda têm saldo
 		set fltSaldoItem = $$SQLGetSaldoItemQuant^VARAtaLinha(idAta,idAtaLinha)		
		continue:(fltSaldoItem = 0)
		
		//Somente mostrar atas que ainda estão em vigência
 		set dteValidade  = $$GetValidadeAta^VARAta(idAta) //Substituir posteriormente por método que retorna vigência
		continue:(dteValidade < $horolog)
		
		set count = $i(count)
		
		write "	<tr>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;>"_count_"</td>"		
		write "		<td height=18px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARAta&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YKEY="_idAta_">"_idAta_"</a></td>"
		write "     <td height=18px style=padding-left:8px;padding-right:8px;>"_idAtaLinha_"</td>"
		write "		<td height=18px style=padding-left:8px;padding-right:8px;>"_$extract($$SQLGetDescFornecedor^VARSQL(idFornecedor),1,30)_"</td>"
		write "     <td align=right height=18px style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,fltQuantidade,0)_"</td>"
		write "     <td align=right height=18px style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,fltSaldoItem,0)_"</td>"
		write "		<td align=right height=18px style=padding-left:8px;padding-right:8px;>"_$$FormatCurrency^COMTable(fltPrice)_"</td>"
		write "	</tr>"
	}
	
	do formulaData.Close()

 	if count = 0 write " <tr><td colspan=7 height=18px style=padding-left:6px;>Nenhuma ata em vigência cadastrada para o produto.</td></tr>"
 	
	write "	</table>"
	write "</div>"	
	write "<br />"
	
	quit	

QuantidadePendenteRecebimento(pidItem)
	set qtyPendente =0
	set strCompras = $$getComprasPendentesPorProduto^VARCompra(pidItem)
	if (strCompras '= "") {
	
		for i = 1:1:$Length(strCompras,";") {		
	
			set idCompra = $piece(strCompras,";",i)
		
			set objCompra = $get(^INAUF(YM,idCompra,1))
			continue:(objCompra = "")
			
			set qtyCompra   = 0
			set qtyRecebida = 0
			
			$$$Order5(^INAUFPs,YM,8,pidItem,idCompra,idCompraLinha)
				
				set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
				set qtyCompraLinha = $piece(objCompra,Y,5)
				set qtyCompra = qtyCompra + qtyCompraLinha
								
				set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
				set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
			$$$End
			set qtyPendenteLinha = qtyCompra - qtyRecebida
			set qtyPendente=qtyPendente+qtyPendenteLinha
		}
	}
	q qtyPendente
	
 
TableComprasAguardRecebimento(pidItem)
	
	new strCompras, i, idCompra, objCompra, empenho, idSupplier, idPedidoCompra, noProcesso, idCompraLinha,
		qtyCompra, qtyCompraLinha, qtyRecebida, qtyRecebidaLinha, qtyPendente
	
	set strCompras = $$getComprasPendentesPorProduto^VARCompra(pidItem)
	
	write "<div style=margin-left:8px;font-size:12px>"
	write "	<strong>Ordens de Compras Aguardando Recebimento</strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>" //Detalhes do Item
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Ordem de Compra</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Fornecedor</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Empenho</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Pedido</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Processo</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Detentor Atual</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Comprada</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. a Receber</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Já Recebida</em></td>"
	write "     </tr>"
	
	if (strCompras '= "") {
	
		for i = 1:1:$Length(strCompras,";") {		
	
			set idCompra = $piece(strCompras,";",i)
		
			set objCompra = $get(^INAUF(YM,idCompra,1))
			continue:(objCompra = "")
		
			set empenho        = $$$INAUFApproval1(objCompra)
			set idSupplier     = $$$INAUFSupplierNumber(objCompra)
			set idPedidoCompra = $$$INAUFFREE20(objCompra)
			set noProcesso	   = $$getNoProcesso^VARPedidoCompra(idPedidoCompra)
		
			if (noProcesso = "") {
				set noProcesso = "Sem Nº Processo"
			}
			
			set qtyCompra   = 0
			set qtyRecebida = 0
			
			$$$Order5(^INAUFPs,YM,8,pidItem,idCompra,idCompraLinha)
				
				set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
				set qtyCompraLinha = $piece(objCompra,Y,5)
				set qtyCompra = qtyCompra + qtyCompraLinha
								
				set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
				set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
			$$$End
			
			set qtyPendente = qtyCompra - qtyRecebida
			if qtyPendente>0 {
				set detentorAtual = ""  //** AGUARDANDO INTEGRAÇÃO **
		
				write "	<tr>"
				write " 	<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARCompra&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YKEY="_idCompra_">"_idCompra_"</a></td>"
				write "		<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=INLIEF&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YTRAKT="_YTRAKT_"&amp;YKEY="_idSupplier_">"_$extract($$SQLGetDescFornecedor^VARSQL(idSupplier),1,30)_"</a></td>"
				;write " 	<td height=20px style=padding-left:8px;padding-right:8px;>"_empenho_"</td>"
				write " 	<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARPedidoCompra&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YKEY="_idPedidoCompra_">"_idPedidoCompra_"</a></td>"
				;write " 	<td height=20px style=padding-left:8px;padding-right:8px;>"_noProcesso_"</td>"
				;write " 	<td height=20px style=padding-left:8px;padding-right:8px;>"_detentorAtual_"</td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,qtyCompra,0)_"</td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;><strong>"_$$^WWWTR(0,12,qtyPendente,0)_"</strong></td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,qtyRecebida,0)_"</td>"
				write "	</tr>"
			}
		}
		
	} else {
			write "	<tr>"
			write " 	<td height=20px colspan=8 style=padding-left:8px;padding-right:8px;>Nenhum saldo em OF aguardando recebimento para o produto."
			write "	</tr>"
	}

	write "	</table>"
	write "</div>"
	write "<br />"

	quit


TablePedidosAguardCompra(pidItem)
	quit:(pidItem = "") ""
	
	new strPedidosCompra, i, idPedidoCompra, noProcesso, count, qtyAtendida, qtyPendente, qtyArquivada, qtyTotal
	
	set count = 0

	write "<div style=margin-left:8px;font-size:12px>"
	write "	<strong>Pedidos Aguardando Ordem de Compra</strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>" //Detalhes do Item
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Pedido</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Processo</em></td>"
	;write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Detentor Atual</em></td>"	
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Total</em></td>"	
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Atendida</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Pendente</em></td>"
	write "			<td height=20px style=padding-left:8px;padding-right:8px;><em>Quant. Arquivada</em></td>"
	write "     </tr>"
	
	$$$Order4(^VARPedidoCompraLinhas,YM,1,pidItem,idPedidoCompra)

		set statusPedidoCompra = $$getStatusPedidoCompra^VARPedidoCompra(idPedidoCompra)

		// Desconsiderar pedidos com status 0-Aberto ou 3-Arquivado
		continue:( (statusPedidoCompra = 0) || (statusPedidoCompra = 3) )
		
		$$$Order5(^VARPedidoCompraLinhas,YM,1,pidItem,idPedidoCompra,idPedidoCompraLinha)

			set qtyPendente = $$GetQuantidadeAAtender^VARPedidoCompraLinha(idPedidoCompra, idPedidoCompraLinha)

			if (qtyPendente > 0) {
				
				set count = $i(count)
				
				set noProcesso = $$getNoProcesso^VARPedidoCompra(idPedidoCompra)
			
				if (noProcesso = "") {
					set noProcesso = "Sem Nº Processo"
				}
				
				set qtyAtendida  = $$GetQuantidadeAtendida^VARPedidoCompraLinha(idPedidoCompra, idPedidoCompraLinha)
				set qtyArquivada = $piece($get(^VARPedidoCompraLinha(YM,idPedidoCompra,idPedidoCompraLinha,1)),Y,12)
				
				if qtyArquivada = "" set qtyArquivada = 0
				
				set qtyTotal = qtyPendente + qtyAtendida + qtyArquivada
				
				set detentorAtual = ""  //** AGUARDANDO INTEGRAÇÃO **
				
				write "	<tr>"
				write " 	<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARPedidoCompra&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YKEY="_idPedidoCompra_">"_idPedidoCompra_"</a></td>"
				;write " 	<td height=20px style=padding-left:8px;padding-right:8px;>"_noProcesso_"</td>"
				;write " 	<td height=20px style=padding-left:8px;padding-right:8px;>"_detentorAtual_"</td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,qtyTotal,0)_"</td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,qtyAtendida,0)_"</td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;><strong>"_$$^WWWTR(0,12,qtyPendente,0)_"</strong></td>"
				write " 	<td height=20px align=right style=padding-left:8px;padding-right:8px;>"_$$^WWWTR(0,12,qtyArquivada,0)_"</td>"
				write "	</tr>"			
				
			}

		$$$End
	$$$End

	if (count = 0) {
		write "	<tr>"
		write " 	<td height=20px colspan=7 style=padding-left:6px;padding-right:24px;>Nenhum saldo em pedido de compra aguardando OF."
		write "	</tr>"			
	}
	
	write "	</table>"	
	write "</div>"
	
	quit	
	
	
TableLocaisMaiorConsumo(pidItem)
	
	
	
	new formulaData, meuSQL, codLocal, CMML, count
 	
	write "<div style=margin-left:5px;font-size:12px>"
	write "	<strong>Locais de Maior Consumo</strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;><em>Código</em></td><td height=20px style=padding-left:6px;><em>Local</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>Consumo Médio Local</em></td>"
	write "		</tr>"
	
	set formulaData = ##class(%ResultSet).%New()  ;Create Result Set Object
		
		set meuSQL = "SELECT TOP 10 "
		set meuSQL = meuSQL_" Location, "
		set meuSQL = meuSQL_" $$]]><![CDATA[GetCMM^VARReposicao('"_pidItem_"',Location)"
		set meuSQL = meuSQL_" FROM SQLUser.WWW0121"
		set meuSQL = meuSQL_" WHERE $$GetCMM^VARReposicao('"_pidItem_"',Location) > 0"
		set meuSQL = meuSQL_" ORDER BY TO_NUMBER($$GetCMM^VARReposicao('"_pidItem_"',Location)) Desc"
		
	do formulaData.Prepare(meuSQL) ;Prepare Query
	do formulaData.Execute()  	   ;Execute Query
		
		set count = 0
		
		while (formulaData.Next()) {		
			set codLocal = formulaData.GetData(1)
			set CMML     = formulaData.GetData(2)
			
			set count = count + 1
			
			write "	<tr>"
			write "		<td height=18px style=padding-left:6px;>"_codLocal_"</td><td style=padding-left:6px;>"_$piece($get(^WWW0121(YM,YM,codLocal,1)),Y,1)_"</td><td align=right style=padding-right:4px>"_$$^WWWTR(0,12,CMML,0)_"</td>"
			write "	</tr>"
		}
	
	do formulaData.Close()
 	
 	if count = 0 write " <tr><td colspan=3 height=18px style=padding-left:6px;>Nenhum consumo médio disponível para o produto.</td></tr>"
 	
	write "	</table>"
	write "<br />"
	
	
	quit
	
TableLocaisMaiorMovimentacao(pidItem)
	
	
	
	new formulaData, meuSQL, codLocal, MOVL, count
 	
	write "<div style=margin-left:5px;font-size:12px>"
	write "	<strong>Locais de Maior Movimentação</strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;><em>Código</em></td><td height=20px style=padding-left:6px;><em>Local</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>Movimentação Média Local</em></td>"
	write "		</tr>"
	
	set formulaData = ##class(%ResultSet).%New()  ;Create Result Set Object
		
		set meuSQL = "SELECT TOP 10 "
		set meuSQL = meuSQL_" Location, "
		set meuSQL = meuSQL_" $$GetMOV^VARReposicao('"_pidItem_"',Location)"
		set meuSQL = meuSQL_" FROM SQLUser.WWW0121"
		set meuSQL = meuSQL_" WHERE $$GetMOV^VARReposicao('"_pidItem_"',Location) > 0"
		set meuSQL = meuSQL_" ORDER BY TO_NUMBER($$GetMOV^VARReposicao('"_pidItem_"',Location)) Desc"
		
	do formulaData.Prepare(meuSQL) ;Prepare Query
	do formulaData.Execute()  	   ;Execute Query
		
		set count = 0
		
		while (formulaData.Next()) {		
			set codLocal = formulaData.GetData(1)
			set MOVL     = formulaData.GetData(2)
			
			set count = count + 1
			
			write "	<tr>"
			write "		<td height=18px style=padding-left:6px;>"_codLocal_"</td><td style=padding-left:6px;>"_$piece($get(^WWW0121(YM,YM,codLocal,1)),Y,1)_"</td><td align=right style=padding-right:4px>"_$$^WWWTR(0,12,MOVL,0)_"</td>"
			write "	</tr>"
		}
	
	do formulaData.Close()
 	
 	if count = 0 write " <tr><td colspan=3 height=18px style=padding-left:6px;>Nenhuma movimentação média disponível para o produto.</td></tr>"
 	
	write "	</table>"
	write "<br />"
	
	
	quit
	
TableTratamentosEmAberto(pidItem)
	
	/*
	new lstTMC, intList, idTreatment, idSeq, idPatient, fltQtyTotal, fltQtyResidual, intDistributionType,
		strReturnDate, strDistType, strPaciente, idLocation, strDocName
	
	write "<div style=margin-left:5px;font-size:12px>"
	write "	<strong>Tratamentos Especializados em Aberto</strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;><em>Local</em></td><td height=20px style=padding-left:6px;><em>Paciente</em></td><td height=20px style=padding-left:6px;><em>Prescritor</em></td><td height=20px style=padding-left:6px;><em>Qtde. Tratamento</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>Qtde. Pendente</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>Tipo</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>Próxima Retirada</em></td>"
	write "		</tr>"
 	
 	; idTreatment~idSeq~idPatient~fltQtyTotal~fltQtyResidual~intDistributionType~ReturnDate~idLocation~strDocName
	set lstTMC = $$GetTMCByItem^VARSESTreatmentMC(pidItem)
	set intList = $listlength(lstTMC)
	if (intList > 0) {
		for loop=1:1:intList {
	    	set strTMC 				= $list(lstTMC,loop)
	    	set idTreatment 		= $piece(strTMC ,Y,1)
	    	set idSeq 				= $piece(strTMC ,Y,2)
	    	set idPatient 			= $piece(strTMC ,Y,3)
	    	set fltQtyTotal 		= $piece(strTMC ,Y,4)
	    	set fltQtyResidual 		= $piece(strTMC ,Y,5)
	    	set intDistributionType = $piece(strTMC ,Y,6)
	    	set strReturnDate 		= $piece(strTMC ,Y,7)
	    	set idLocation 			= $piece(strTMC ,Y,8)
	    	set strDocName 			= $piece(strTMC ,Y,9)
	    	
	    	set strPaciente = $piece($get(^VARSESPACIENTE(YM,idPatient,1)),Y,1)
	    	
	    	set strDistType = ""
	    	if intDistributionType '= "" set strDistType = $piece($get(^INPARA(YM,"VARSESTIPODISPENSACAO",SPRACHE,intDistributionType,1)),Y,1)	    		    
	    	
	    	/* 
	    	Local
			Paciente
 			Prescritor
 			Tipo
 			Qtd. Tratamento
 			Qtd. Pendente
 			Data de retorno
 			*/
 	/*
	    	if (strReturnDate) '= "" set strReturnDate = $zdate(strReturnDate,4)	    	
	    	
	    	; tratamento das informações
			write "	<tr>"
			write "		<td height=18px style=padding-left:6px;>"_idLocation_"</td><td height=18px style=padding-left:6px;>"_strPaciente_"</td><td height=18px style=padding-left:6px;>"_strDocName_"</td><td align=right style=padding-left:6px;>"_$$^WWWTR(0,12,fltQtyTotal)_"</td><td align=right style=padding-right:4px>"_$$^WWWTR(0,12,fltQtyResidual)_"</td><td align=right style=padding-right:4px>"_strDistType_"</td><td align=right style=padding-right:4px>"_strReturnDate_"</td>"
			write "	</tr>"
		}	   
	}	
	
	if intList = 0 {
		write "	<tr>"
		write "		<td height=18px style=padding-left:6px;>Nenhum registro disponível.</td>"
		write "	</tr>"		
	}
	
	write "	</table>"
	write "<br />"
	*/
	
	quit

TableHistoricoMOVCMM(pidItem,pidLocal="")
	
	new formulaData, meuSQL, MOVL, count
 	
	write "<div style=margin-left:5px;font-size:12px>"
	write "	<strong>Histórico MOV e CMM - 6 meses </strong><br />"
	write "	<table bgcolor=E0E0E0 style=font-size:12px;border-color:666666;border-style:solid;border-width:1px;margin-top:3px>"
	write "		<tr bgcolor=C0C0C0>"
	write "			<td height=20px style=padding-left:6px;><em>Mês/Ano</em></td><td height=20px style=padding-left:6px;><em>MOV</em></td><td height=20px style=padding-left:6px;padding-right:4px><em>CMM</em></td>"
	write "		</tr>"
	
	set querylist=""
	set currentmonth=$extract($ZD($H,1),1,2)
	set currentyear=$extract($ZD($H,1),7,10)
	for x=1:1:6 {
		set currentmonth=currentmonth-1
		if currentmonth<1 {
			set currentyear=currentyear-1
			set currentmonth=12
		}
		set query=currentyear_"/"_currentmonth
		set qtyMOVLocation = 0
		set qtyCMMLocation = 0
		if pidLocal'="" {
			if $order(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
					
				$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyMOVLocation = qtyMOVLocation + qty
		
				$$$End
			}
		
			if $order(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
					
				$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyCMMLocation = qtyCMMLocation + qty
		
				$$$End
			}
		}else {
			$$$Order5(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
					
				$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyMOVLocation = qtyMOVLocation + qty
		
				$$$End
				
			$$$End
		
			$$$Order5(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
					
				$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyCMMLocation = qtyCMMLocation + qty
					
		
				$$$End
			$$$End
		}
		if qtyCMMLocation<0 set qtyCMMLocation=qtyCMMLocation*(-1)		
		write "	<tr>"
		write "		<td height=18px style=padding-left:6px;>"_query_"</td><td style=padding-left:6px;>"_$$^WWWTR(0,12,qtyMOVLocation)_"</td><td align=right style=padding-right:4px>"_$$^WWWTR(0,12,qtyCMMLocation,0)_"</td>"
		write "	</tr>"
	}
	

 	
 	//if count = 0 write " <tr><td colspan=3 height=18px style=padding-left:6px;>Nenhum movimentação média disponível para o produto.</td></tr>"
 	
	write "	</table>"
	write "<br />"
	
	
	quit
	
PrintGrafico(pidItem,pidLocal="")
	
	
	kill ^CacheTempScriptTag(%session.SessionId,$job)

	set ^CacheTempInHyperEvent(%session.SessionId,$job) = 0 // 0 = *NOT* in hyperevent
	

	set codProduto    = pidItem	
	set codLocal       = pidLocal
	if pidLocal'="" {
		set descLocal        = $$SQLGetLocationName^VARSQL(pidLocal)
	}
	else {
		set descLocal="Rede"
		}

	set EixoEstoque1 = ""
	set EixoEstoque2 = ""
	set EixoDias = ""
	set sepEixo1 = ""
	set sepEixo2 = ""
	set sepDias = ""
	set DescProduto1 = ""
	set DescProduto2 = ""

	
	//Query last 6 months
	set querylist=""
	set currentmonth=$extract($ZD($H,1),1,2)
	set currentyear=$extract($ZD($H,1),7,10)
	for x=1:1:6 {
		set currentmonth=currentmonth-1
		if currentmonth<1 {
			set currentyear=currentyear-1
			set currentmonth=12
		}
		set query=currentyear_"/"_currentmonth
		set qtyMOVLocation = 0
		set qtyCMMLocation = 0
		if pidLocal'="" {
			if $order(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
					
				$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyMOVLocation = qtyMOVLocation + qty
		
				$$$End
			}
		
			if $order(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
					
				$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyCMMLocation = qtyCMMLocation + qty
		
				$$$End
			}
		}else {
			$$$Order5(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
					
				$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyMOVLocation = qtyMOVLocation + qty
		
				$$$End
				
			$$$End
		
			$$$Order5(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
					
				$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
						
					set qty = 0
					set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
					set qtyCMMLocation = qtyCMMLocation + qty
		
				$$$End
			$$$End
		}
	
		set vProduto         = pidItem
		set vDescProduto     = $$SQLGetDescricaoProduto^VARSQL(pidItem)
		set vCMM 			 =qtyCMMLocation
		if vCMM<0 set vCMM=vCMM*(-1)
		set vMOV  			 = qtyMOVLocation
		
		set EixoDias = query_sepDias_EixoDias
		set sepDias = ", "

		set EixoEstoque1 = vCMM_sepEixo1_EixoEstoque1
		set sepEixo1 = ", "
		set DescProduto1 = "CMM"

		set EixoEstoque2 = vMOV_sepEixo2_EixoEstoque2
		set sepEixo2 = ", "
		set DescProduto2 = "MOV"

	}
	
	set EixoEstoque1 = "["_EixoEstoque1_"]"
	set EixoEstoque2 = "["_EixoEstoque2_"]"
	set EixoDias = "["_EixoDias_"]"

	w "	",!
	w "	",!
	w "		<!-- 1. Add these JavaScript inclusions in the head of your page -->",!
	w "		<script type="_$C(34)_"text/javascript"_$C(34)_" src="_$C(34)_"/SESPE/highcharts/js/jquery.min.js"_$C(34)_"></script>",!
	w "		<script type="_$C(34)_"text/javascript"_$C(34)_" src="_$C(34)_"/SESPE/highcharts/js/highcharts.js"_$C(34)_"></script>",!
	w "",!
	w "	",!
	w "		<!-- 1a) Optional: add a theme file -->",!
	w "		<!--",!
	w "			<script type="_$C(34)_"text/javascript"_$C(34)_" src="_$C(34)_"/SESPE/highcharts/js/themes/gray.js"_$C(34)_"></script>",!
	w "		-->",!
	w "	",!
	w "		<!-- 1b) Optional: the exporting module -->",!
	w "		<script type="_$C(34)_"text/javascript"_$C(34)_" src="_$C(34)_"/SESPE/highcharts/js/modules/exporting.js"_$C(34)_"></script>",!
	w "	",!
	w "	",!
	w "		<!-- 2. Add the JavaScript to initialize the chart on document ready -->",!
	w "		<script type="_$C(34)_"text/javascript"_$C(34)_">",!
	w "	",!
	w "			var chart;",!
	w "			$(document).ready(function() {",!
	w "				chart = new Highcharts.Chart({",!
	w "					chart: {",!
	w "						renderTo: 'container',",!
	w "						defaultSeriesType: 'line',",!
	w "						marginRight: 150,",!
	w "						marginBottom: 25",!
	w "					},",!
	w "					title: {",!
	w "						text: 'Histórico MOV/CMM 6 meses',",!
	w "						x: -20 //center",!
	w "					},",!
	w "					subtitle: {",!
	w "						text: '"_descLocal_"',",!
	w "						x: -20",!
	w "					},",!
	w "					xAxis: {",!
	w "						Sequence: "_EixoDias_"",!
	w "					},",!
	w "					yAxis: {",!
	w "						title: {",!
	w "							text: 'Quantidade'",!
	w "						},",!
	w "						plotLines: [{",!
	w "							value: 0,",!
	w "							width: 1,",!
	w "							color: '#808080'",!
	w "						}]",!
	w "					},",!
	w "					tooltip: {",!
	w "						formatter: function() {",!
	w "				                return '<b>'+ this.series.name + '</b><br/>'+",!
	w "								this.y;",!
	w "						}",!
	w "					},",!
	w "					legend: {",!
	w "						layout: 'vertical',",!
	w "						align: 'right',",!
	w "						verticalAlign: 'top',",!
	w "						x: 0,",!
	w "						y: 100,",!
	w "						borderWidth: 0",!
	w "					},",!
	w "					series: [{ ",!
	w "						name: '"_DescProduto1_"', ",!
	w "						data: "_EixoEstoque1_"",!
	w "						}, {",!
	w "						name: '"_DescProduto2_"', ",!
	w "						data: "_EixoEstoque2_"",!						
	w "					}]",!
	w "	",!
	w "				});",!
	w "			",!
	w "			",!
	w "			});",!
	w "			",!
	w "		</script>",!
	/*
	w "	",!
	w "	</head>",!
	w "	<body>",!
	w "	",!
	w "		<br /><br /><br />",!
	w "	",!
	w "		<!-- 3. Add the container -->",!
	*/
	w "		<div id="_$C(34)_"container"_$C(34)_" style="_$C(34)_"width: 800px; height: 400px; margin: 0 auto"_$C(34)_"></div>",!
	/*
	w "			",!
	w "			",!
	w "	</body>",!
	w "</html>",!
	*/
	q
]]></Routine>
</Export>