<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INARTUPC" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INARTUPC(UPC,QTY,ITEM,PGRAM,CONVERT)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		INARTUPC
	;	SET YOK=$$^INARTUPC(99999999,50)
	;
	; Inputs : 
	;	CONVERT:
	;		0 IN (FORM UPC TO ITEM QTY
	;		1 OUT (FROM ITEM QTY TO UPC)
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;	$P(YOK,Y,1)  QTY
	;	$P(YOK,Y,2)  ITEM
	;	$P(YOK,Y,3)  UNIT   (EINHEIT)
	;	$P(YOK,Y,4)  UPC (BARCODE)
	;
	; History :
	; 01-Feb-2007	GRF		SR15411: Doco; dot levels
	; 06.12.2004	BEC		CALULATE UPC QTY: SERVICE;26789
	;-------------------------------------------------------------------------------
	SET ITEM    = $GET(ITEM)
	SET PGRAM   = $GET(PGRAM)
	SET QTY     = $GET(QTY)
	SET UPC     = $GET(UPC)
	SET CONVERT = $GET(CONVERT)
	
	IF $GET(Y)="" DO ^WWWVAR
	
	NEW DATEI,RETURN
	
	IF +QTY=0 SET QTY=1
	
	SET $PIECE(RETURN,Y,1)=QTY
	
	NEW PGRAM1,PGRAMSET,PITEM,YFELD1,YOK,YI,UPCCONVERTED
	
	SET UPCCONVERTED=""
	
	IF PGRAM'="" IF ITEM'="" IF +CONVERT=0  DO
	. SET YOK=""
	. SET PGRAM1=""
	. FOR  SET PGRAM1=$ORDER(^INPLANAGRAMSETITMs(YM,2,$$^WWWUMLAU(PGRAM,1),$$^WWWUMLAU(ITEM,1),PGRAM1)) QUIT:PGRAM1=""  QUIT:YOK=1  DO
	. . SET PGRAMSET=""
	. . FOR  SET PGRAMSET=$ORDER(^INPLANAGRAMSETITMs(YM,2,$$^WWWUMLAU(PGRAM,1),$$^WWWUMLAU(ITEM,1),PGRAM1,PGRAMSET)) QUIT:PGRAMSET=""  QUIT:YOK=1  DO
	. . . SET PITEM=""
	. . . FOR  SET PITEM=$ORDER(^INPLANAGRAMSETITMs(YM,2,$$^WWWUMLAU(PGRAM,1),$$^WWWUMLAU(ITEM,1),PGRAM1,PGRAMSET,PITEM)) QUIT:PITEM=""  QUIT:YOK=1  DO
	. . . . SET UPC=$PIECE($GET(^INPLANAGRAMSETITM(YM,PGRAM1,PGRAMSET,PITEM,1)),Y,7)
	. . . . SET YOK=1
	
	SET $PIECE(RETURN,Y,4)=UPC                     ;UPC CODE
	
	;ITEM
	IF UPC'="" IF +CONVERT=0 IF $DATA(^INARTUPC1s(YM,1,$$^WWWUMLAU(UPC,1))) DO
	. NEW YOK
	. SET YOK=""
	. DO:ITEM'=""  IF ITEM="" SET ITEM="" FOR  SET ITEM=$ORDER(^INARTUPC1s(YM,1,$$^WWWUMLAU(UPC,1),ITEM)) QUIT:ITEM=""  QUIT:YOK=1  DO
	. . DO
	. . . SET UPCS=""
	. . . FOR  SET UPCS=$ORDER(^INARTUPC1s(YM,1,$$^WWWUMLAU(UPC,1),$$^WWWUMLAU(ITEM,1),UPCS)) QUIT:UPCS=""  QUIT:YOK=1  DO
	. . . . NEW UPC1,UPCCHECK
	. . . . FOR YI=1:1:5 QUIT:YOK=1  DO          ;MAX. 5 RUNS
	. . . . . QUIT:UPCS=""
	. . . . . QUIT:'$DATA(^INARTUPC1(YM,ITEM,UPCS,1))
	. . . . . SET UPCCHECK(UPCS)=""
	. . . . . SET UPC1=$GET(^INARTUPC1(YM,ITEM,UPCS,1))
	. . . . . IF UPCS=$PIECE(UPC1,Y,3) SET YOK=1 QUIT         ;EQUAL UPC
	. . . . . SET UPCS=$PIECE(UPC1,Y,3)
	. . . . . IF UPCS'="" IF $DATA(UPCCHECK(UPCS)) QUIT       ;REKURSIV EQUAL UPC
	. . . . . IF UPCS="" SET YOK=1
	. . . . . IF +CONVERT=0 IF +$PIECE(UPC1,Y,1)'=0 SET $PIECE(RETURN,Y,1)=$PIECE(RETURN,Y,1)*+$PIECE(UPC1,Y,1)
	. . . . .;IF +CONVERT=1 IF +$PIECE(UPC1,Y,1)'=0 SET $PIECE(RETURN,Y,1)=$PIECE(RETURN,Y,1)/+$PIECE(UPC1,Y,1)
	. . . . . SET $PIECE(RETURN,Y,2)=ITEM
	. . . . . SET $PIECE(RETURN,Y,3)=$PIECE(UPC1,Y,2)          ;U/M  ;EINHEIT
	. . . . . SET UPCCONVERTED=1   ;BEC;16.02.05
	
	;ITEM/SUPPLIER
	IF UPC'="" IF +CONVERT=0 IF $DATA(^INARTUPCs(YM,1,$$^WWWUMLAU(UPC,1))) DO
	. IF UPCCONVERTED=1 QUIT   ;BEC;16.02.05
	. NEW LIEF,YOK
	. SET YOK=""
	. DO:ITEM'=""  IF ITEM="" SET ITEM="" FOR  SET ITEM=$ORDER(^INARTUPCs(YM,1,$$^WWWUMLAU(UPC,1),ITEM)) QUIT:ITEM=""  QUIT:YOK=1  DO
	. . SET LIEF=""
	. . FOR  SET LIEF=$ORDER(^INARTUPCs(YM,1,$$^WWWUMLAU(UPC,1),$$^WWWUMLAU(ITEM,1),LIEF)) QUIT:LIEF=""  QUIT:YOK=1  DO
	. . . SET UPCS=""
	. . . FOR  SET UPCS=$ORDER(^INARTUPCs(YM,1,$$^WWWUMLAU(UPC,1),$$^WWWUMLAU(ITEM,1),LIEF,UPCS)) QUIT:UPCS=""  QUIT:YOK=1  DO
	. . . . NEW UPC1,UPCCHECK
	. . . . FOR YI=1:1:5 QUIT:YOK=1  DO          ;MAX. 5 RUNS
	. . . . . QUIT:UPCS=""
	. . . . . QUIT:'$DATA(^INARTUPC(YM,ITEM,LIEF,UPCS,1))
	. . . . . SET UPCCHECK(UPCS)=""
	. . . . . SET UPC1=$GET(^INARTUPC(YM,ITEM,LIEF,UPCS,1))
	. . . . . IF UPCS=$PIECE(UPC1,Y,3) SET YOK=1   QUIT         ;EQUAL UPC
	. . . . . SET UPCS=$PIECE(UPC1,Y,3)
	. . . . . IF UPCS'="" IF $DATA(UPCCHECK(UPCS)) QUIT         ;REKURSIV EQUAL UPC
	. . . . . IF UPCS="" SET YOK=1
	. . . . . IF +CONVERT=0 IF +$PIECE(UPC1,Y,1)'=0 SET $PIECE(RETURN,Y,1)=$PIECE(RETURN,Y,1)*+$PIECE(UPC1,Y,1)
	. . . . .;IF +CONVERT=1 IF +$PIECE(UPC1,Y,1)'=0 SET $PIECE(RETURN,Y,1)=$PIECE(RETURN,Y,1)/+$PIECE(UPC1,Y,1)
	. . . . . SET $PIECE(RETURN,Y,2)=ITEM
	. . . . . SET $PIECE(RETURN,Y,3)=$PIECE(UPC1,Y,2)           ;U/M  ;EINHEIT
	
	IF CONVERT=1 IF $FIND($PIECE(RETURN,Y,1),".") DO            ;FULL QTY
	. SET $PIECE(RETURN,Y,1)=+$PIECE($PIECE(RETURN,Y,1),".",1)+1
	
	IF CONVERT=1 IF $PIECE(RETURN,Y,3)="" IF ITEM'="" DO
	. SET $PIECE(RETURN,Y,3)=$PIECE($GET(^INART(YM,ITEM,1)),Y,40)
	
	KILL UPCCHECK
	
	QUIT RETURN
	
]]></Routine>
</Export>