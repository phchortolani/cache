<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWXMLIN" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWXMLIN(XML,CLASS,DTDFILE)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		INPUT XML ZUR WWWSOR
	;	SET YOK=$$^WWWXMLIN(,"DATEI","C:/DTD/BMECAT12.DTD")
	;
	; Inputs : 
	;	XML			TEXT  ;UNTERSUCHT DIE VARIABLE XML ODER WWWSOR(YUSER,0 NACH XML NACHRICHTEN WENN XML=""
	;	CLASS		KLASSENNAME (FÜR 5.0)
	;	DTDFILE		DTD FILE FOR CONVERT TO GLOBAL
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 29-Jan-2007	GRF		SR15411: naked reference - using strGlobalName; doco
	; 08.07.2001	FAN/DT
	;-------------------------------------------------------------------------------
	NEW KOPF,KNOTENZAHL,DATA,IND,YI,YII,YIII,YIIII,K,INK,TEXT,DZAHL,X,ID,DTD,YOK,KNAME
	
	SET CLASS=$GET(CLASS)
	IF CLASS="" SET CLASS="WWWXML"
	SET YOK=0  ;KEINE DATEN ;no DATA
	IF $GET(DTDFILE)'="" DO V40  ;CONVERT USING DTD
	IF $FIND($ZVERSION,"4.2")!($FIND($ZVERSION,"5."))!($FIND($ZVERSION,"6.")) DO V50
	IF '$FIND($ZVERSION,"4.2") IF '$FIND($ZVERSION,"5.") DO V40
	QUIT YOK
	
V50 ;VERSION 5.0
	NEW DATEI,READER,reader,strGlobalName,YFILENAME
	
	SET YFILENAME=$PIECE($GET(^WWW012(0,YM,1)),Y,98)_"XMLIMPORT"_$JOB_".XML"  ;ZWISCHENSPEICHERN
	IF $FIND($ZVERSION,"Linux")   SET YFILENAME=$TRANSLATE($GET(YFILENAME),"\","/")
	IF $FIND($ZVERSION,"Windows") SET YFILENAME=$TRANSLATE($GET(YFILENAME),"/","\")
	IF $$^WWWFILECHECK(YFILENAME)'=1 QUIT
	DO ^WWWXMLIMPORT(YFILENAME,CLASS)
	;ON SIMPLE FILES
	SET DATEI=CLASS
	;vvv 29-Jan-2007
	;	D22		$$$WWW001SaveDataInFile()
	;IF $PIECE($GET(^WWW001(0,CLASS,1)),Y,22)'="" SET DATEI=$PIECE(^(1),Y,22)
	set strGlobalName = $PIECE($GET(^WWW001(0,CLASS,1)),Y,22)
	if strGlobalName'="" set DATEI = strGlobalName
	; ^^^ 29-Jan-2007
	MERGE ^WWWSOR(YUSER,1,CLASS)=@("^"_DATEI)
	IF $DATA(^WWWSOR(YUSER,1)) SET YOK=1
	QUIT
	
V40 ;VERSION 4.0-4.1/OR USEING DTD
	NEW LINE
	
	SET YFILENAME=$PIECE($GET(^WWW012(0,YM,1)),Y,98)_"XMLIMPORT"_$JOB_".XML"  ;ZWISCHENSPEICHERN
	IF $GET(YFILENEM)'="" DO  ;IMPORT DTD
	. NEW YBSZ,SAT
	. SET YBSZ=$$READ^WWWDEV(YFILENAME)
	. IF YBSZ="" QUIT
	. SET XML=""
	. FOR LINE=1:1 USE YBSZ READ SAT#5000:0 QUIT:$ZEOF=-1  QUIT:'$TEST  QUIT:SAT="EOF"  DO
	. . SET ^WWWSOR(YUSER,0,LINE)=SAT
	
	;+++++++++++++++++++++++++++++++++++++++
	; XML ZB <!ELEMENT PERSON     (  NAME,ID,FIRMA,ADRESS     )>
	;+++++++++++++++++++++++++++++++++++++++
	IF $GET(DTDFILE)'="" DO  ;IMPORT DTD
	. NEW YBSZ,SAT
	. SET YBSZ=$$READ^WWWDEV(DTDFILE)
	. IF YBSZ="" QUIT
	. SET XML=""
	. FOR LINE=1:1 USE YBSZ READ SAT#5000:0 QUIT:$ZEOF=-1  QUIT:'$TEST  QUIT:SAT="EOF"  DO
	. . IF $LENGTH(XML)+SAT<30000 SET XML=XML_SAT
	
	KILL ^WWWSOR(YUSER,1)  ;RÜCKGABE WERTE
	SET XML=$GET(XML)
	IF $GET(DTDFILE)="" IF ($GET(XML)="")!($DATA(^WWWSOR(YUSER,0))) DO
	. SET XML=""
	. SET YI=""
	. FOR  SET YI=$ORDER(^WWWSOR(YUSER,0,YI)) QUIT:YI=""  DO
	. . IF $LENGTH(XML)+$LENGTH($GET(^WWWSOR(YUSER,0,YI)))<30000 SET XML=XML_$GET(^WWWSOR(YUSER,0,YI))
	
	SET XML="<"_$PIECE(XML,"<",2,99999)
	SET KOPF=$PIECE(XML,"(#PCDATA)>",1)
	SET KNOTENZAHL=$LENGTH(KOPF,"<!ELEMENT")-2      ;WIEVIEL KNOTEN ? ;how much knot 
	IF '$FIND(XML,"(#PCDATA)") DO
	. SET DTD=$PIECE(XML,"<!DOCTYPE",2)
	. SET DTD=$PIECE(DTD,">",1)
	. SET DTD=$PIECE(DTD,"""",2)
	. SET DTD=$TRANSLATE(DTD,""""_" ")
	. SET DTD=$$^WWWXMLDTD(DTD)
	. SET KOPF=$PIECE(DTD,"(#PCDATA)>",1)
	. SET KNOTENZAHL=$LENGTH(KOPF,"<!ELEMENT")-2 
	
	FOR YI=1:1:KNOTENZAHL DO
	. SET KNAME(YI)=$TRANSLATE($PIECE($PIECE(XML,"ELEMENT ",YI+1)," ",1)," "_"""")
	. IF KNAME(YI)="" SET KNAME(YI)=YI
	
	FOR YI=1:1:KNOTENZAHL DO
	. SET K(YI)=$PIECE(KOPF,"!ELEMENT",YI+1) ;LFN ELEMENTENBESCHREIBUNG
	. SET K(YI)=$PIECE(K(YI)," ",2)          ;ALLES HINTER DEN ERSTEN BLANK = BESCHR. OHNE !ELEMENT ;whatsoever posterior shiny without 
	. SET K(YI)=$PIECE(K(YI),")",1)          ;ALLES VOR DEM ")" = ALLE BEZEICHNUNGEN
	. SET K(YI)=$TRANSLATE(K(YI),"*?() ")    ;=ELEMENTE OHNE SONDERZEICHEN ;without special character 
	. SET INK(YI)=$PIECE(KOPF,"!ELEMENT "_K(YI),2)      ;SUCHEN UNTERELEMENT ;seek 
	. SET INK(YI)=$PIECE($PIECE(INK(YI),"(",2),")",1)   ;DATENFELDER ODER FELD ;Or field 
	. SET INK(YI)=$TRANSLATE(INK(YI),"*?() ")           ;DATENFELDER ODER FELD OHNE SONDERZEICHEN ;Or field without special character 
	. FOR YII=1:1 QUIT:$PIECE(INK(YI),",",YII)=""  QUIT:$FIND($PIECE(INK(YI),",",YII),"!ELEMENT")  DO
	. . QUIT:$PIECE(INK(YI),",",YII)=""
	. . SET DATA(YI,YII)=$PIECE(INK(YI),",",YII)
	. . SET TEXT($PIECE(INK(YI),",",YII))=YI_Y_YII  ;EBENE UND FELDNUMMER ;plain And 
	
	DO
	. NEW ID1
	. SET ID=""
	. FOR YIII=1:1 QUIT:$PIECE(XML,"<",YIII,9999)=""  SET YFELD=$PIECE($PIECE(XML,"<",YIII),">",1) IF YFELD'="" DO
	. . QUIT:$FIND(YFELD,"/")            ;KEIN ENDEFELD AUSWERTEN ;no 
	. . SET ID1=""                       ;PRÜFFELD DER ID ;the ID 
	. . IF $FIND(YFELD," ") DO           ;KÖNNTE ID ENTHALTEN ;ID include 
	. . . SET ID1=$TRANSLATE($PIECE(YFELD," ",2),"id"_"""","ID")  ;ALLES HINTER EINEM " " (BLANK)
	. . . SET YFELD=$PIECE(YFELD," ",1)  ;NUR ERSTER TEIL = NAME ;only premier part Name 
	. . ;
	. . QUIT:YFELD=""                    ;KEIN NAME VORHANDEN ;Name on hand 
	. . QUIT:'$DATA(TEXT(YFELD))         ;NAME IN DEFINITION NICHT VORHANDEN ;Name within Not on hand 
	. . SET YI=$PIECE(TEXT(YFELD),Y,1)   ;EBENE FÜR POSITION DES KEY ;plain to KEY 
	. . IF $PIECE(ID1,"ID=",2)'="" SET ID(YI)=$PIECE(ID1,"ID=",2)  ;ID DER EBENE ;ID the plain 
	. . SET YII=$PIECE(TEXT(YFELD),Y,2)                            ;FELDNUMMER FÜR $P DES INHALTES ;to 
	. . SET YINHALT=$PIECE($PIECE(XML,">",YIII),"</"_YFELD,1)      ;SUCHEN DES INHALTES ;seek 
	. . QUIT:YINHALT=""                  ;KEIN INHALT VORHANDEN ;no purport on hand 
	. . QUIT:$FIND(YINHALT,"<")          ;FALSCHER INHALT ;purport 
	. . IF YI'="" IF YII'="" DO          ;WENN EBENE UND $P DANN  ;when plain And 
	. . . SET ID=""
	. . . FOR YIIII=1:1:YI IF $GET(ID(YIIII))'="" SET:ID'="" ID=ID_"/" SET ID=ID_$GET(ID(YIIII))   ;ZUSAMENBAU DES KEYS
	. . . IF ID'="" SET $PIECE(^WWWSOR(YUSER,1,KNAME(YI),ID,1),Y,YII)=YINHALT   ;SPEICHERN ;Save 
	
	IF $DATA(^WWWSOR(YUSER,1)) SET YOK=1
	QUIT
	
]]></Routine>
</Export>