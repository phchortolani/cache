<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="VARCompraEntregaPrevisaoCal" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[VARCompraEntregaPrevisaoCal
	#import VAR.infra.util
	#include COMSYS
	#include VARConst
	#include INConst
	#include VARCompra
 
OnAfterDataFields
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Campo OnAfterDataFields do form VARCompraEntregaPrevisaoCal
    ; 
    ; Histórico:
	;	01-Mai-2012		Gustavo		Incluído VARLogAfterSave
    ; 	28-Jul-2010					Criado
    ;-------------------------------------------------------------------------------
	
	set YAUSWAHL = $get(YAUSWAHL)
	
	//Só apresenta os resultados da consulta caso o usuário tenha clicado no botão 'Ok' do form.
	//A verificação do YAUSWAHL é para que o form funcione caso o usuário clique nos botões 
	//'Semana Anterior' e 'Próxima Semana'
	if '(YAUSWAHL) {	
		quit:('$$isAfterSaveLogged^VARUtil(YBED,YFORM))
		do ClearVARLogAterSave^VARUtil(YBED,YFORM)
	}
	
	do MontaGrid
	
 	quit


GetLocalFormulario()
	
	if ($data(VORG(2)) = 0){
		set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3) = YLOCATION
	}
	else {
		set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3) = VORG(2)
	}
	set local = $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3)
	
	quit local

MontaGrid
	quit:($get(VORG(2)) = "")
	
	new referenceDay, dteInicioSemana, day0, day1, day2, day3, day4, day5, day6,
		lstHeader, tmeAgend, strAgends, spacer, EntregasDia0, EntregasDia1,
		EntregasDia2, EntregasDia3, EntregasDia4, EntregasDia5, EntregasDia6
 	
	set YAUSWAHL = $get(YAUSWAHL)
	
	if (YAUSWAHL '= "") {
		set referenceDay = YAUSWAHL
	} else {
		set referenceDay = ""
		if ($length($get(YBED)) '= 0) {
			set referenceDay = $piece($get(^VARTempCompraPrevisaoEntregaCal(YBED)),
				Y, 1)
		}

		if ($length(referenceDay) = 0) {
			set referenceDay = $piece($h,",",1)
		}
	}

	if ($length($get(YBED)) '= 0) {
		set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 1) = referenceDay
	}

	set dteInicioSemana = $$GetInicioSemana(referenceDay)			
	
	set day0 = dteInicioSemana
	set day1 = dteInicioSemana+1
	set day2 = dteInicioSemana+2
	set day3 = dteInicioSemana+3
	set day4 = dteInicioSemana+4
	set day5 = dteInicioSemana+5
	set day6 = dteInicioSemana+6
	
	// Botões em formato botão para navegar no calendário
	set spacer = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
	write "&nbsp;<br/><button type=button onclick=window.location='"_YAKTION_"EP=WWWFORM&amp;YFORM=VARCompraEntregaPrevisaoCal&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL="_$$GetPreviousWeek(referenceDay)_"'>&laquo; Semana Anterior</button>"
	write spacer
	write "<button type=button onclick=window.location='"_YAKTION_"EP=WWWFORM&amp;YFORM=VARCompraEntregaPrevisaoCal&amp;YUSER="_YUSER_"&amp;YBED="_YBED_"&amp;YAUSWAHL="_$$GetNextWeek(referenceDay)_"'>Próxima Semana &raquo;</button>"
	
	set ^VARCompraEntregaPrevisaoCalTEMP(0,YBED,1) = YAUSWAHL

	set lstHeader = $listbuild("&nbsp;Horário&nbsp;",
		"&nbsp;&nbsp;"_$$GetDescricaoDia(day0),
		"&nbsp;&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day1)_"&nbsp;&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day2)_"&nbsp;&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day3)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day4)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day5)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day6)_"&nbsp;&nbsp;")

	;write !, "<br>&nbsp;<br><b>Entregas agendadas</b>"
	
	if ($$Start^COMTable(lstHeader, , , , , $$$NO)) {

		do NewLine^COMTable("#eee8aa")
		do InsertCell^COMTable("<div style='padding:4px'><strong>Entregas agendadas</strong></div>",,,,,,8)
		do EndLine^COMTable()
		
		do NewLine^COMTable("lightsteelblue")
		do InsertCell^COMTable("")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day0)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day1)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day2)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day3)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day4)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day5)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day6)_"</strong>",,,,"CENTER")
		do EndLine^COMTable()

		set blnTemLinha = 0
		set idLocal = $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3)
		
		for i = 0:1:23 {
			set tmeAgend = $ztimeh(##class(Strings).FormatNumber(i, 2)_":00:00", 1)
			set strAgends = $$GetAgendamentoEntregas^VARCompraEntregaAgendamento(day0,
				day6, tmeAgend)

			if ($length(strAgends) = 0) continue
			
			do NewLine^COMTable("white")
			do InsertCell^COMTable(##class(Strings).FormatNumber(i, 2)_":00",,,,"CENTER",,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day0, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day1, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day2, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day3, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day4, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day5, tmeAgend),,,,,,,1)
			do InsertCell^COMTable($$GetAgendamentosDoDiaHoraNova(day6, tmeAgend),,,,,,,1)
			do EndLine^COMTable()
			set blnTemLinha = 1
		}

		if ('blnTemLinha) {
			do NewLine^COMTable("white")
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do InsertCell^COMTable("",,,,,,,1)
			do EndLine^COMTable()
		}

		;do Stop^COMTable()
	;}

	set EntregasDia0 = $$GetEntregasDoDiaNova(day0)
	set EntregasDia1 = $$GetEntregasDoDiaNova(day1)
	set EntregasDia2 = $$GetEntregasDoDiaNova(day2)
	set EntregasDia3 = $$GetEntregasDoDiaNova(day3)
	set EntregasDia4 = $$GetEntregasDoDiaNova(day4)
	set EntregasDia5 = $$GetEntregasDoDiaNova(day5)
	set EntregasDia6 = $$GetEntregasDoDiaNova(day6)

	set lstHeader = $listbuild("&nbsp;&nbsp;"_$$GetDescricaoDia(day0),
		"&nbsp;&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day1)_"&nbsp;&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day2)_"&nbsp;&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day3)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day4)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day5)_"&nbsp;&nbsp;",
		"&nbsp;&nbsp;&nbsp;"_$$GetDescricaoDia(day6)_"&nbsp;&nbsp;")

	;write !, "<br><b>Entregas previstas</b>"
	;if $$Start^COMTable(lstHeader, , , , , $$$NO) {
		
		do NewLine^COMTable("E0E0E0")
		do InsertCell^COMTable("<div style='padding:4px'>&nbsp;</div>",,,,,,8)
		do EndLine^COMTable()

		do NewLine^COMTable("#eee8aa")
		do InsertCell^COMTable("<div style='padding:4px'><strong>Entregas previstas (aguardando agendamento)</strong></div>",,,,,,8)
		do EndLine^COMTable()
		
		do NewLine^COMTable("lightsteelblue")
		do InsertCell^COMTable("") ;equivalente ao horário da tabela anterior
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day0)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day1)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day2)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day3)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day4)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day5)_"</strong>",,,,"CENTER")
		do InsertCell^COMTable("<strong>"_$$FormatDiaPT(day6)_"</strong>",,,,"CENTER")
		do EndLine^COMTable()
		
		do NewLine^COMTable("white")
		do InsertCell^COMTable("") ;equivalente ao horário da tabela anterior
		do InsertCell^COMTable(EntregasDia0,,,,,,,1)
		do InsertCell^COMTable(EntregasDia1,,,,,,,1)
		do InsertCell^COMTable(EntregasDia2,,,,,,,1)
		do InsertCell^COMTable(EntregasDia3,,,,,,,1)
		do InsertCell^COMTable(EntregasDia4,,,,,,,1)
		do InsertCell^COMTable(EntregasDia5,,,,,,,1)
		do InsertCell^COMTable(EntregasDia6,,,,,,,1)
		do EndLine^COMTable()
		
		do Stop^COMTable()
	}

	do ObservacoesEntregas^VARCompraEntregaPrevisao
	
 	quit

OnAfterSave()
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterSave^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	08-Sep-2011		Criado
    ;-------------------------------------------------------------------------------
	
	new Local
	set Local = $get(VORG(2))
	set Programa = $get(VORG(4))
	
	set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 2) = VORG(1)
	if (VORG(2) = ""){
		set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3) = YLOCATION
	}
	else {
		set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3) = VORG(2)
	}

	set $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 4) = VORG(4)

	do VARLogAfterSave^VARUtil(YBED,YFORM)
	do GoToForm^COMUtilForm("VARCompraEntregaPrevisaoCal",Local,,,,,) 
    ;do RedirectForm^COMUtils(YFORM)
	quit
 
GetInicioSemana(pDate)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	new idDiaDaSemana, inicioSemana 
 
	set idDiaDaSemana = $zdate(pDate,10)
	set inicioSemana = pDate - idDiaDaSemana
	
	quit inicioSemana	
	
GetDescricaoDia(pDay)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	new idDiaDaSemana, diaDaSemana	
	
	set idDiaDaSemana = $zdate(pDay,10)
	set diaDaSemana = $case(idDiaDaSemana,0:"Domingo",      1:"Segunda-feira",
										  2:"Terça-feira",  3:"Quarta-feira",
										  4:"Quinta-feira", 5:"Sexta-feira",
										  6:"Sábado")
 
	quit diaDaSemana

GetVisualizarProdutos()
	quit +$piece($get(^VARTempCompraPrevisaoEntregaCal(YBED)), Y, 2)
	
GetLocalEntrega()
	
	quit +$piece($get(^VARTempCompraPrevisaoEntregaCal(YBED)), Y, 3)


FormatDiaPT(pDay)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	set dte = $zdate(pDay,4)
	set month = $extract(dte,4,5)
	
	set descMesPT = $case(month,"01":"Janeiro", "02":"Fevereiro", "03":"Março",
								"04":"Abril",   "05":"Maio",      "06":"Junho",
								"07":"Julho",   "08":"Agosto",    "09":"Setembro",
								"10":"Outubro",  "11":"Novembro", "12":"Dezembro")
 
	;set diaPT  = $$Replace^COMUtilStr($extract(dte,4,5),month,descMesPT)	
	// Para ganhar mais espaço na tela
	set diaPT  = $$Replace^COMUtilStr($extract(dte,4,5),month,$extract(descMesPT,1,3))
	
	set diaPT2 = $$Replace^COMUtilStr($extract(dte,1,2)_"&nbsp;"_diaPT_$extract(dte,6,10),"/","&nbsp;")	
 
	quit diaPT2
 
	
GetPreviousWeek(pDay)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	quit pDay - 7
 
	
GetNextWeek(pDay)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	quit pDay + 7
 
	/******* Substituida pela GetEntregasDoDiaNova ********* 
GetEntregasDoDia(pDay)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	28-Jul-2010		Criado
    ;-------------------------------------------------------------------------------
	new listEntregasDoDia, EntregasDoDia, cnt, Entrega, idCompra, idEntrega, idAgend,
		Fornecedor, strForm, strBack, strWindow, strURL, strToolTip, objEntregaLinha,
		idItem, qtdeEntrega, QuantRecebida, NoEntrega1, quantidadeEntrega, Programa, idCompraLinha
		
	set listEntregasDoDia = ""
	set Programa = $get(VORG(4))
	
	set pLocal = +$$GetLocalEntrega()
	
	set EntregasDoDia = $$GetPrevisaoEntregas^VARCompraEntregaPrevisao(""_Y_""_Y_""_Y_pDay_Y_pDay_Y_pLocal)
	
	if EntregasDoDia = "" {
		quit listEntregasDoDia
	}
	
	for cnt = 1:1:$length(EntregasDoDia,";") {
   		
   		set Entrega = $piece(EntregasDoDia,";",cnt)
   		set idCompra   = $piece(Entrega,",",1)
   		set idEntrega  = $piece(Entrega,",",2)
   		set pidEntrega = idEntrega
   		   		  		
		set idAgend    = $$$ChaveUnicaAgendamento
		set Fornecedor = $extract($$SQLGetDescFornecedor^VARSQL($$getFornecedorCompra^VARCompra(idCompra)),1,29)
		
		if (Programa '= ""){
			set objINAUFP = $get(^INAUFP(YM,idCompra,idEntrega,1))
			continue:($$$INAUFPFREE29(objINAUFP) '= Programa)
		}
		
		set strForm = "VARCompraEntregaAgendamento"
		set strBack = $get(YBACK)
		; only add YFORM to the stack if not last element
		if (($piece(strBack, ",", $length(strBack, ",") - 1) '= YFORM) &&
			(YFORM '= strForm)) {
			set strBack = strBack_YFORM_","
		}
		set strWindow = ""

		set strURL = $$MontaLink(idCompra_YKOMMA_idEntrega_YKOMMA_idAgend, strForm,
			strBack, strWindow)

		set strToolTip = ""
		;if ('+$$GetVisualizarProdutos()) {
			$$$Order4(^VARCompraEntregaLinha,YM,idCompra,idEntrega,idEntregaLinha)
			
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM,idCompra,idEntrega,idEntregaLinha,1))
				set idItem 		= $piece(objEntregaLinha,Y,7)
				set qtdeEntrega = $piece(objEntregaLinha,Y,2) 
				set idCompraLinha   = $$$VARCompraEntregaLinhaLinhadaOrdemdeCompra(objEntregaLinha)

				if ($$isItemEncerrado^VARCompra(idCompra,idItem) = 1) { // Linhas da ordem de compra encerradas
					set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra,
	   				idEntrega, idEntregaLinha))
					continue				
				}

				set strToolTip = strToolTip_"Produto: "_idItem_" - "_
					$extract($$SQLGetDescricaoProduto^VARSQL(idItem),1,40)_
					"   Qtde: "_$$^WWWTR(0,12,qtdeEntrega)_" "
			
			$$$End
			set strToolTip = "title = '"_$zconvert(strToolTip, "o", "HTML")_"'"
		;}

		if (strWindow '= "") {
			set listEntregasDoDia = listEntregasDoDia_"<a href='' onclick=""subWindow('"_strURL_"','"_strWindow_"'); return false;"" "_strToolTip_">"
		} else {
			set listEntregasDoDia = listEntregasDoDia_"<a href='"_strURL_"' "_strToolTip_">"
		}
		
		set stCompra = $$GetStatusCompra^VARCompraEntregaAgendamento(idCompra)
		set dtEntregaPrevista = $$GetDataPrevista^VARCompraEntregaLinha(idCompra, pidEntrega)
		set dtAtual = $piece($horolog,",",1)
		
		;set QuantRecebida = $$getQuantidadeRecebida^VARCompra(idCompra,idEntrega)
		set Item = $$SQLGetItemEntrega^VARSQL(idCompra,idEntrega)
		set QuantRecebida   =  $$SQLGetQuantidadeRecebidaEntrega^VARSQL(idCompra,idCompraLinha,idEntrega,pidEntrega)
		
		if ('QuantRecebida){
			set QuantRecebida = 0
		}
	
		set quantidadeEntrega = $$SQLGetQuantidadeEntrega^VARSQL(idCompra,pidEntrega,Item)
		set dtPrevista 			= $$SQLGetDataEntregaNoOrdemCompra^VARSQL(idCompra,pidEntrega)
		set dtRecebimento 		= $$SQLGetDtRecebimento^VARSQL(idCompra,Item)
		set idSituacaoPrazo		= $$SQLGetSituacaoPrazoEntrega^VARSQL(dtPrevista,"",dtRecebimento,QuantRecebida,quantidadeEntrega)
		
		if (stCompra = 3){
			set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_2)
		}
		else {
			if (stCompra = 2){
				set strStEntrega = "Parcialmente recebida"
			}
			else {
				set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_1)
			}
		}
			
		set strStPrazo = $$SQLGetUserParamDescVAR^VARSQL("VARPRAZOENTREGA~"_idSituacaoPrazo)
		
   		if (QuantRecebida = quantidadeEntrega){
			set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
	   			"<br />&nbsp;<strong><font color=''>"_idCompra_]]><![CDATA[" - "_Fornecedor_
	   			"</font></strong>&nbsp;(Entrega "_pidEntrega_" de "_
	   			$$getNoEntregasCompra^VARCompraEntrega(idCompra)_")&nbsp;</font>"_
	   			"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
		}
		else { 
			if (dtEntregaPrevista < dtAtual) {
				set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
	   				"<br />&nbsp;<strong><font color=''>"_idCompra_" - "_Fornecedor_
	   				"</font></strong>&nbsp;(Entrega "_pidEntrega_" de "_
	   				$$getNoEntregasCompra^VARCompraEntrega(idCompra)_")&nbsp;</font>"_
	   				"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
			}
			else {	
				set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
   					"<br />&nbsp;<strong><font color=''>"_idCompra_" - "_Fornecedor_
   					"</font></strong>&nbsp;(Entrega "_pidEntrega_" de "_
   					$$getNoEntregasCompra^VARCompraEntrega(idCompra)_")&nbsp;</font>"_
   					"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
			}
		}

		if (+$$GetVisualizarProdutos()) {
			$$$Order4(^VARCompraEntregaLinha,YM,idCompra,idEntrega,idEntregaLinha)
			
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM,idCompra,idEntrega,idEntregaLinha,1))
				set idItem 		= $piece(objEntregaLinha,Y,7)
				set qtdeEntrega = $piece(objEntregaLinha,Y,2) 
				
				set listEntregasDoDia = listEntregasDoDia_"&nbsp;&nbsp;&nbsp;&nbsp;"_idItem_"&nbsp;-&nbsp;"_$extract($$SQLGetDescricaoProduto^VARSQL(idItem),1,40)_"&nbsp;&nbsp;&nbsp;Qtde: "_$$^WWWTR(0,12,qtdeEntrega)_"&nbsp;&nbsp;<br />"
			
			$$$End
		}
		
		set listEntregasDoDia = listEntregasDoDia_"</a><br /><hr>"
   	}
   	
   	quit listEntregasDoDia
*/	
ImprimirRelatorio()
	set YAUSWAHL = $piece($get(^VARTempCompraPrevisaoEntregaCal(YBED)), Y, 1)
	
	if (YAUSWAHL '= "") {
		set dtAtual = YAUSWAHL
	} else {
		set dtAtual = $piece($h,",",1)
	}
	set DtInicial = $$GetInicioSemana(dtAtual)
	
	set DtFinal = DtInicial + 6
	
	quit $$RunReportEntregaCal^VARJasperRunReport(DtInicial,DtFinal)

	/******* Substituida pela GetAgendamentosDoDiaHoraNova *********
GetAgendamentosDoDiaHora(pDay, pTime)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Função OnAfterDataFields^VARCompraEntregaPrevisaoCal.mac
    ; 
    ; Histórico:
    ; 	08-Sep-2010		Criado
    ;-------------------------------------------------------------------------------
	new strAgendsDoDia, strAgendDoDia, intCnt, strAgend, idCompra, idEntrega,
		idAgend, strFornecedor, strForm, strBack, strWindow, strURL, strToolTip,
		objAgend, tmeHorarioTermino, blnDestacado, strHorario, objEntregaLinha,
		idItem, intQtdeEntrega, idLocal, QuantRecebida, NoEntrega1, quantidadeEntrega, idCompraLinha

	set strAgendsDoDia = ""
	set Programa = $get(VORG(4))
	
	set idLocal = $piece(^VARTempCompraPrevisaoEntregaCal(YBED), Y, 3)
	
	set strAgendDoDia =
		$$GetAgendamentoEntregas^VARCompraEntregaAgendamento(pDay, pDay, pTime)
	if ($length(strAgendDoDia) = 0) quit strAgendsDoDia

	for intCnt = 1:1:$length(strAgendDoDia, ";") {
   		set strAgend = $piece(strAgendDoDia, ";", intCnt)

   		set idCompra      = $piece(strAgend, ",", 1)
   		set idEntrega     = $piece(strAgend, ",", 2)
		set idAgend       = $piece(strAgend, ",", 3)
		
		set pidEntrega = idEntrega
		
		set strFornecedor = $extract($$SQLGetDescFornecedor^VARSQL(
			$$getFornecedorCompra^VARCompra(idCompra)), 1, 29)
		
		if (Programa '= ""){
			set objINAUFP = $get(^INAUFP(YM,idCompra,idEntrega,1))
			continue:($$$INAUFPFREE29(objINAUFP) '= Programa)
		}
		
		set strForm = "VARCompraEntregaAgendamento"
		set strBack = $get(YBACK)
		; only add YFORM to the stack if not last element
		if (($length($get(YFORM)) > 0) &&
			($piece(strBack, ",", $length(strBack, ",") - 1) '= YFORM) &&
			(YFORM '= strForm)) {
			set strBack = strBack_YFORM_","
		}
		set strWindow = ""

		set strURL = $$MontaLink(idCompra_YKOMMA_idEntrega_YKOMMA_idAgend, strForm,
			strBack, strWindow)

		set strToolTip = ""
		;if ('+$$GetVisualizarProdutos()) {
	   		set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra, idEntrega, ""))
	   		while ($length(idEntregaLinha) > 0) {
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM, idCompra,
					idEntrega, idEntregaLinha, 1))
				set idItem 		    = $$$VARCompraEntregaLinhaProduto(objEntregaLinha)
				set intQtdeEntrega  = $$$VARCompraEntregaLinhaQuantidade(objEntregaLinha)
				set idCompraLinha   = $$$VARCompraEntregaLinhaLinhadaOrdemdeCompra(objEntregaLinha)

				if ($$isItemEncerrado^VARCompra(idCompra,idItem) = 1) { // Linhas da ordem de compra encerradas
					set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra,
	   				idEntrega, idEntregaLinha))
					continue				
				}
				
				set strToolTip = strToolTip_"Produto: "_idItem_" - "_
					$extract($$SQLGetDescricaoProduto^VARSQL(idItem), 1, 40)_
					"   Qtde: "_$$^WWWTR(0, 12, intQtdeEntrega)_" "

	   			set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra,
	   				idEntrega, idEntregaLinha))
	   		}
			//set strToolTip = "title="""_$zconvert(strToolTip, "o", "HTML")_""""
			set strToolTip = "title="""_strToolTip_""""
		;}

		if (strWindow '= "") {
			set strAgendsDoDia = strAgendsDoDia_"<a href='' onclick=""subWindow('"_strURL_"','"_strWindow_"'); return false;"" "_strToolTip_">"
		} else {
			set strAgendsDoDia = strAgendsDoDia_"<a href='"_strURL_"' "_strToolTip_">"
		}

		set objAgend = ^VARCompraEntregaAgendamento(YM, idCompra, idEntrega, idAgend, 1)
		set tmeHorarioTermino = $$$VARCompraEntregaAgendamentoHorarioTermino(objAgend)
		if ($length(tmeHorarioTermino) > 0) {
			set blnDestacado = ((+tmeHorarioTermino -
				+$$$VARCompraEntregaAgendamentoHorarioInicio(objAgend)) > (60 * 60))
			set strHorario = " - Horário Término: "
			if (blnDestacado) {
				set strHorario = strHorario_"<strong><font color=''>"
			}
			set strHorario = strHorario_$$^WWWTIME(tmeHorarioTermino)
			if (blnDestacado) {
				set strHorario = strHorario_"</font></strong>"
			}
		}

		set stCompra = $$GetStatusCompra^VARCompraEntregaAgendamento(idCompra)
		set dtEntregaAgendada = $$$VARCompraEntregaAgendamentoData(objAgend)
		set hrAtual = $piece($horolog,",",2)
		set dtAtual = $piece($horolog,",",1)
		
		;set NoEntrega1 = ""
		;set NoEntrega1 = $order(^INAUFP(YM, idCompra, NoEntrega1))
		
		set Item = $$SQLGetItemEntrega^VARSQL(idCompra,pidEntrega)
		set QuantRecebida   =  $$SQLGetQuantidadeRecebidaEntrega^VARSQL(idCompra,idCompraLinha,idEntrega,pidEntrega)
						
		if ('QuantRecebida){
			set QuantRecebida = 0
		}
		
		set quantidadeEntrega 	= $$SQLGetQuantidadeEntrega^VARSQL(idCompra,pidEntrega,Item)
		set dtPrevista 			= $$SQLGetDataEntregaNoOrdemCompra^VARSQL(idCompra,pidEntrega)
		set dtRecebimento 		= $$SQLGetDtRecebimento^VARSQL(idCompra,Item)
		set idSituacaoPrazo		= $$SQLGetSituacaoPrazoEntrega^VARSQL(dtPrevista,dtEntregaAgendada,dtRecebimento,QuantRecebida,quantidadeEntrega)
		
		if (stCompra = 3){
			set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_2)
		}
		else {
			if (stCompra = 2){
				set strStEntrega = "Parcialmente recebida"
			}
			else {
				set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_1)
			}
		}
			
		set strStPrazo = $$SQLGetUserParamDescVAR^VARSQL("VARPRAZOENTREGA~"_idSituacaoPrazo)
				
		if (QuantRecebida = quantidadeEntrega){
			set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
	   			;"<strong><font color='#00cc99'>"_idCompra_" - "_strFornecedor_"</font></strong>&nbsp;"_
	   			"<strong>"_idCompra_" - "_strFornecedor_"</strong>&nbsp;"_
	   			"(Entrega "_pidEntrega_" de "_
	   			$$getNoEntregasCompra^VARCompraEntrega(idCompra)_" "_
	   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
	   			idCompra, pidEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
		}
		else { 
			if (dtEntregaAgendada >= dtAtual){	
	   			set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
		   			;"<strong><font color='#cccc00'>"_idCompra_" - "_strFornecedor_"</font></strong>&nbsp;"_
		   			"<strong>"_idCompra_" - "_strFornecedor_"</strong>&nbsp;"_
		   			"(Entrega "_pidEntrega_" de "_
		   			$$getNoEntregasCompra^VARCompraEntrega(idCompra)_" "_
		   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
		   			idCompra, pidEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
			}
			elseif (dtEntregaAgendada < dtAtual) {
				set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
		   			;"<strong><font color='#cc0000'>"_idCompra_" - "_strFornecedor_"</font></strong>&nbsp;"_
		   			"<strong>"_idCompra_" - "_strFornecedor_"</strong>&nbsp;"_
		   			"(Entrega "_pidEntrega_" de "_
		   			$$getNoEntregasCompra^VARCompraEntrega(idCompra)_" "_
		   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
		   			idCompra, pidEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
			}
		}
		
		if (+$$GetVisualizarProdutos()) {
	   		set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra, idEntrega, ""))
	   		while ($length(idEntregaLinha) > 0) {
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM, idCompra,
					idEntrega, idEntregaLinha, 1))
				set idItem 		    = $$$VARCompraEntregaLinhaProduto(objEntregaLinha)
				set intQtdeEntrega  = $$$VARCompraEntregaLinhaQuantidade(objEntregaLinha)

				set strAgendsDoDia = strAgendsDoDia_"&nbsp;&nbsp;&nbsp;&nbsp;"_idItem_
					"&nbsp;-&nbsp;"_$extract($$SQLGetDescricaoProduto^VARSQL(idItem), 1, 40)_
					"&nbsp;&nbsp;&nbsp;Qtde: "_$$^WWWTR(0, 12, intQtdeEntrega)_
					"&nbsp;&nbsp;<br />"

	   			set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra,
	   				idEntrega, idEntregaLinha))
	   		}
		}

		set strAgendsDoDia = strAgendsDoDia_"</a><br /><hr>"
   	}
   	
   	quit strAgendsDoDia
*/
MontaLink(pid, pstrForm, pstrBack, pstrWindow)
	new YFORM, YKEY, YBACK, YPARA

	set strURL = YAKTION_"EP=WWWFORM&amp;YFORM="_pstrForm_"&amp;YKEY="_pid_"&amp;YBACK="_pstrBack

	$$$Append(strURL, $$WWWCGI2^WWWCGI(pstrWindow '= ""))

	quit strURL

GetEntregasDoDiaNova(pDay)
	;***************************************************************************************************
	; LUCAS - Refactoring da coleta dos dados para calendário de entregas (SESPE-473)
	;***************************************************************************************************
	new listEntregasDoDia, EntregasDoDia, cnt, Entrega, idCompra, idEntrega, idAgend,
		Fornecedor, strForm, strBack, strWindow, strURL, strToolTip, objEntregaLinha,
		idItem, qtdeEntrega, QuantRecebida, NoEntrega1, qtdeEntrega, Programa, idCompraLinha
		
	set listEntregasDoDia = ""
	set Programa = $get(VORG(4))
	
	set pLocal = +$$GetLocalEntrega()
	
	set meuSQL = " SELECT DISTINCT "
 	set meuSQL = meuSQL_" NoOrdemCompra, "
    set meuSQL = meuSQL_" NoEntrega1, "
    set meuSQL = meuSQL_" DescFornecedor, "
    set meuSQL = meuSQL_" CodItem, "
    set meuSQL = meuSQL_" DescItem, "
    set meuSQL = meuSQL_" Quantidade, "
    set meuSQL = meuSQL_" LinhaOrdemCompra, "
    set meuSQL = meuSQL_" StatusCompra, "
    set meuSQL = meuSQL_" DtPrevHorolog, "
    set meuSQL = meuSQL_" QuantRecebida, "
    set meuSQL = meuSQL_" DtRecebidaHorolog, "
    set meuSQL = meuSQL_" SituacaoPrazo, "
    set meuSQL = meuSQL_" QuantEntrega "
 	set meuSQL = meuSQL_" FROM Report.VARConsultaPrevisaoEntregas "
 	set meuSQL = meuSQL_" WHERE Company = 0 "
 	set meuSQL = meuSQL_" AND DtAgendHorolog IS NULL "
 	set meuSQL = meuSQL_" AND ((nvl(Length(LocaldeEntrega),0) > 0 AND LocaldeEntrega = '"_pLocal_"')"_
 						" OR (LocaldeEntrega IS NULL AND Location = '"_pLocal_"'))"
 	set meuSQL = meuSQL_" AND DtPrevHorolog  = "_pDay_""
 	
 	if (Programa '= ""){
	 	set meuSQL = meuSQL_" AND idPrograma = '"_Programa_"'"	
 	}
 	
 	new rsPrevista
	
	set rsPrevista = ##class(%ResultSet).%New()  ;Create Result Set Object		

	do rsPrevista.Prepare(meuSQL)  ;Prepare Query
	do rsPrevista.Execute()  	   ;Execute Query
	
	set idCompraAnterior  = ""
	set idEntregaAnterior = ""

	While (rsPrevista.Next()) {		
		set idCompra          = rsPrevista.Data("NoOrdemCompra")	
		set idEntrega         = rsPrevista.Data("NoEntrega1")
		set Fornecedor		  = rsPrevista.Data("DescFornecedor")
		set idItem 		      = rsPrevista.Data("CodItem")
		set DescItem		  = rsPrevista.Data("DescItem")
		set qtdeEntrega 	  = rsPrevista.Data("Quantidade")
		set idCompraLinha     = rsPrevista.Data("LinhaOrdemCompra")
		set stCompra          = rsPrevista.Data("StatusCompra")
		set dtEntregaPrevista = rsPrevista.Data("DtPrevHorolog")
		set QuantRecebida     = rsPrevista.Data("QuantRecebida")
		set DtRecebidaHorolog = rsPrevista.Data("DtRecebidaHorolog")
		set SituacaoPrazo     = rsPrevista.Data("SituacaoPrazo")
		set QuantEntrega	  = rsPrevista.Data("QuantEntrega")
		
		continue:((idCompraAnterior = idCompra) && (idEntregaAnterior = idEntrega))
		
		set idCompraAnterior  = idCompra
		set idEntregaAnterior = idEntrega
		
		set idAgend    = $$$ChaveUnicaAgendamento
		
		set strForm = "VARCompraEntregaAgendamento"
		set strBack = $get(YBACK)
		
		; only add YFORM to the stack if not last element
		if (($piece(strBack, ",", $length(strBack, ",") - 1) '= YFORM) &&
			(YFORM '= strForm)) {
			set strBack = strBack_YFORM_","
		}
		set strWindow = ""

		set strURL = $$MontaLink(idCompra_YKOMMA_idEntrega_YKOMMA_idAgend, strForm,
			strBack, strWindow)

		set strToolTip = ""
		set strToolTip = strToolTip_"Produto: "_idItem_" - "_DescItem_"   Qtde: "_$$^WWWTR(0,12,qtdeEntrega)_" "
		set strToolTip = "title = '"_$zconvert(strToolTip, "o", "HTML")_"'"

		if (strWindow '= "") {
			set listEntregasDoDia = listEntregasDoDia_"<a href='' onclick=""subWindow('"_strURL_"','"_strWindow_"'); return false;"" "_strToolTip_">"
		} else {
			set listEntregasDoDia = listEntregasDoDia_"<a href='"_strURL_"' "_strToolTip_">]]><![CDATA["
		}		

		set dtAtual = +$horolo]]><![CDATA[g
		
		if ('QuantRecebida){
			set QuantRecebida = 0
		}

		if (stCompra = 3){
			set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_2)
		}
		else {
			if (stCompra = 2){
				set strStEntrega = "Parcialmente recebida"
			}
			else {
				set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_1)
			}
		}
			
		set strStPrazo = $$SQLGetUserParamDescVAR^VARSQL("VARPRAZOENTREGA~"_SituacaoPrazo)

   		if (QuantRecebida = qtdeEntrega){
			set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
	   			"<br />&nbsp;<strong><font color=''>"_idCompra_" - "_Fornecedor_
	   			"</font></strong>&nbsp;(Entrega "_idEntrega_" de "_
	   			QuantEntrega_")&nbsp;</font>"_
	   			"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
		}
		else { 
			if (dtEntregaPrevista < dtAtual) {
				set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
	   				"<br />&nbsp;<strong><font color=''>"_idCompra_" - "_Fornecedor_
	   				"</font></strong>&nbsp;(Entrega "_idEntrega_" de "_
	   				QuantEntrega_")&nbsp;</font>"_
	   				"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
			}
			else {	
				set listEntregasDoDia = listEntregasDoDia_"<font style=font-size:12px;>"_
   					"<br />&nbsp;<strong><font color=''>"_idCompra_" - "_Fornecedor_
   					"</font></strong>&nbsp;(Entrega "_idEntrega_" de "_
   					QuantEntrega_")&nbsp;</font>"_
   					"<br />"
		   		set listEntregasDoDia = listEntregasDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> <br/>"
			}
		}

		if (+$$GetVisualizarProdutos()) {
			$$$Order4(^VARCompraEntregaLinha,YM,idCompra,idEntrega,idEntregaLinha)	
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM,idCompra,idEntrega,idEntregaLinha,1))
				set idItem 		    = $piece(objEntregaLinha,Y,7)
				set qtdeEntrega     = $piece(objEntregaLinha,Y,2) 
				
				set listEntregasDoDia = listEntregasDoDia_"&nbsp;&nbsp;&nbsp;&nbsp;"_idItem
									  _"&nbsp;-&nbsp;"_$extract($$SQLGetDescricaoProduto^VARSQL(idItem),1,40)
									  _"&nbsp;&nbsp;&nbsp;Qtde: "_$$^WWWTR(0,12,qtdeEntrega)_"&nbsp;&nbsp;<br />"		
			$$$End
		}
		
		set listEntregasDoDia = listEntregasDoDia_"</a><br /><hr>"

	}
	
	do rsPrevista.Close()
   	
   	quit listEntregasDoDia
   	
GetAgendamentosDoDiaHoraNova(pDay, pTime)
	;***************************************************************************************************
	; LUCAS - Refactoring da coleta dos dados para calendário de entregas (SESPE-473)
	;***************************************************************************************************
	new strAgendsDoDia, strAgendDoDia, intCnt, strAgend, idCompra, idEntrega,
		idAgend, Fornecedor, strForm, strBack, strWindow, strURL, strToolTip,
		objAgend, tmeHorarioTermino, blnDestacado, strHorario, objEntregaLinha,
		idItem, intQtdeEntrega, idLocal, QuantRecebida, NoEntrega1, qtdeEntrega, idCompraLinha
		
	set strAgendsDoDia = ""
	set Programa = $get(VORG(4))
	
	set pLocal = +$$GetLocalEntrega()
	
	set meuSQL = " SELECT DISTINCT "
 	set meuSQL = meuSQL_" NoOrdemCompra, "
    set meuSQL = meuSQL_" NoEntrega1, "
    set meuSQL = meuSQL_" DescFornecedor, "
    set meuSQL = meuSQL_" CodItem, "
    set meuSQL = meuSQL_" DescItem, "
    set meuSQL = meuSQL_" Quantidade, "
    set meuSQL = meuSQL_" LinhaOrdemCompra, "
    set meuSQL = meuSQL_" StatusCompra, "
    set meuSQL = meuSQL_" DtPrevHorolog, "
    set meuSQL = meuSQL_" DtAgendHorolog, "
    set meuSQL = meuSQL_" QuantRecebida, "
    set meuSQL = meuSQL_" DtRecebidaHorolog, "
    set meuSQL = meuSQL_" SituacaoPrazo, "
    set meuSQL = meuSQL_" QuantEntrega "
 	set meuSQL = meuSQL_" FROM Report.VARConsultaPrevisaoEntregas "
 	set meuSQL = meuSQL_" WHERE Company = 0 "
 	set meuSQL = meuSQL_ " AND ((nvl(Length(LocaldeEntrega),0) > 0 AND LocaldeEntrega = '"_pLocal_"')"_
 						 " OR (LocaldeEntrega IS NULL AND Location = '"_pLocal_"'))"
 	set meuSQL = meuSQL_" AND DtAgendHorolog  = "_pDay_""
 	
 	if (Programa '= ""){
	 	set meuSQL = meuSQL_" AND idPrograma = '"_Programa_"'"	
 	}
 	
 	new rsAgendada
	
	set rsAgendada = ##class(%ResultSet).%New()  ;Create Result Set Object		

	do rsAgendada.Prepare(meuSQL)  ;Prepare Query
	do rsAgendada.Execute()  	   ;Execute Query
	
	set idCompraAnterior  = ""
	set idEntregaAnterior = ""

	While (rsAgendada.Next()) {		
		set idCompra          = rsAgendada.Data("NoOrdemCompra")	
		set idEntrega         = rsAgendada.Data("NoEntrega1")
		set Fornecedor		  = rsAgendada.Data("DescFornecedor")
		set idItem 		      = rsAgendada.Data("CodItem")
		set DescItem		  = rsAgendada.Data("DescItem")
		set qtdeEntrega 	  = rsAgendada.Data("Quantidade")
		set idCompraLinha     = rsAgendada.Data("LinhaOrdemCompra")
		set stCompra          = rsAgendada.Data("StatusCompra")
		set dtEntregaPrevista = rsAgendada.Data("DtPrevHorolog")
		set dtAgendada        = rsAgendada.Data("DtAgendHorolog")
		set QuantRecebida     = rsAgendada.Data("QuantRecebida")
		set DtRecebidaHorolog = rsAgendada.Data("DtRecebidaHorolog")
		set SituacaoPrazo     = rsAgendada.Data("SituacaoPrazo")
		set QuantEntrega	  = rsAgendada.Data("QuantEntrega")
		
		continue:((idCompraAnterior = idCompra) && (idEntregaAnterior = idEntrega))
		
		set idCompraAnterior  = idCompra
		set idEntregaAnterior = idEntrega
		
		set idAgend    = $$$ChaveUnicaAgendamento
		
		set strForm = "VARCompraEntregaAgendamento"
		set strBack = $get(YBACK)
		
		; only add YFORM to the stack if not last element
		if (($piece(strBack, ",", $length(strBack, ",") - 1) '= YFORM) &&
			(YFORM '= strForm)) {
			set strBack = strBack_YFORM_","
		}
		set strWindow = ""

		set strURL = $$MontaLink(idCompra_YKOMMA_idEntrega_YKOMMA_idAgend, strForm,
			strBack, strWindow)

		set strToolTip = ""
		set strToolTip = strToolTip_"Produto: "_idItem_" - "_DescItem_"   Qtde: "_$$^WWWTR(0,12,qtdeEntrega)_" "
		set strToolTip = "title = '"_$zconvert(strToolTip, "o", "HTML")_"'"

		if (strWindow '= "") {
			set strAgendsDoDia = strAgendsDoDia_"<a href='' onclick=""subWindow('"_strURL_"','"_strWindow_"'); return false;"" "_strToolTip_">"
		} else {
			set strAgendsDoDia = strAgendsDoDia_"<a href='"_strURL_"' "_strToolTip_">"
		}		

		set objAgend = $get(^VARCompraEntregaAgendamento(YM, idCompra, idEntrega, idAgend, 1))
		set tmeHorarioTermino = $$$VARCompraEntregaAgendamentoHorarioTermino(objAgend)
		if ($length(tmeHorarioTermino) > 0) {
			set blnDestacado = ((+tmeHorarioTermino -
				+$$$VARCompraEntregaAgendamentoHorarioInicio(objAgend)) > (60 * 60))
			set strHorario = " - Horário Término: "
			if (blnDestacado) {
				set strHorario = strHorario_"<strong><font color=''>"
			}
			set strHorario = strHorario_$$^WWWTIME(tmeHorarioTermino)
			if (blnDestacado) {
				set strHorario = strHorario_"</font></strong>"
			}
		}

		set dtAtual = +$horolog
		
		if ('QuantRecebida){
			set QuantRecebida = 0
		}

		if (stCompra = 3){
			set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_2)
		}
		else {
			if (stCompra = 2){
				set strStEntrega = "Parcialmente recebida"
			}
			else {
				set strStEntrega = $$SQLGetUserParamDescVAR^VARSQL("VARSTATUSENTREGA~"_1)
			}
		}
			
		set strStPrazo = $$SQLGetUserParamDescVAR^VARSQL("VARPRAZOENTREGA~"_SituacaoPrazo)

		if (QuantRecebida = qtdeEntrega){
			set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
	   			;"<strong><font color='#00cc99'>"_idCompra_" - "_Fornecedor_"</font></strong>&nbsp;"_
	   			"<strong>"_idCompra_" - "_Fornecedor_"</strong>&nbsp;"_
	   			"(Entrega "_idEntrega_" de "_QuantEntrega_" "_
	   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
	   			idCompra, idEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
		}
		else { 
			if (dtAgendada >= dtAtual){	
	   			set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
		   			;"<strong><font color='#cccc00'>"_idCompra_" - "_Fornecedor_"</font></strong>&nbsp;"_
		   			"<strong>"_idCompra_" - "_Fornecedor_"</strong>&nbsp;"_
		   			"(Entrega "_idEntrega_" de "_QuantEntrega_" "_
		   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
		   			idCompra, idEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
			}
			elseif (dtAgendada < dtAtual) {
				set strAgendsDoDia = strAgendsDoDia_"<font style=font-size:12px;><br />&nbsp;"_
		   			;"<strong><font color='#cc0000'>"_idCompra_" - "_Fornecedor_"</font></strong>&nbsp;"_
		   			"<strong>"_idCompra_" - "_Fornecedor_"</strong>&nbsp;"_
		   			"(Entrega "_idEntrega_" de "_QuantEntrega_" "_
		   			" para "_$$^WWWDATE($$GetDataPrevista^VARCompraEntregaLinha(
		   			idCompra, idEntrega))_strHorario_")&nbsp;</font><br />"
		   		set strAgendsDoDia = strAgendsDoDia
		   							_"<strong>Status da Entrega:</strong> "_strStEntrega
		   							_"<strong>&nbsp;&nbsp;Situação do Prazo:</strong> "_strStPrazo
		   							_"<strong>&nbsp;&nbsp;Data Prevista:</strong> "_$$SQLGetFormatDate7^VARSQL(dtEntregaPrevista)
		   							_"<strong>&nbsp;&nbsp;Data Agendada:</strong> "_$$SQLGetFormatDate7^VARSQL(dtAgendada)
		   							_"<strong>&nbsp;&nbsp;Doca:</strong> "_$$$VARCompraEntregaAgendamentoDoca(objAgend)_" <br/>"
			}
		}

		if (+$$GetVisualizarProdutos()) {
	   		set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra, idEntrega, ""))
	   		while ($length(idEntregaLinha) > 0) {
				set objEntregaLinha = $get(^VARCompraEntregaLinha(YM, idCompra,
					idEntrega, idEntregaLinha, 1))
				set idItem 		    = $$$VARCompraEntregaLinhaProduto(objEntregaLinha)
				set intQtdeEntrega  = $$$VARCompraEntregaLinhaQuantidade(objEntregaLinha)

				set strAgendsDoDia = strAgendsDoDia_"&nbsp;&nbsp;&nbsp;&nbsp;"_idItem_
					"&nbsp;-&nbsp;"_$extract($$SQLGetDescricaoProduto^VARSQL(idItem), 1, 40)_
					"&nbsp;&nbsp;&nbsp;Qtde: "_$$^WWWTR(0, 12, intQtdeEntrega)_
					"&nbsp;&nbsp;<br />"

	   			set idEntregaLinha = $order(^VARCompraEntregaLinha(YM, idCompra,
	   				idEntrega, idEntregaLinha))
	   		}
		}
		
		set strAgendsDoDia = strAgendsDoDia_"</a><br /><hr>"

	}
	
	do rsAgendada.Close()
	
   	quit strAgendsDoDia]]></Routine>
</Export>