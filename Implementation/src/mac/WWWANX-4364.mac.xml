<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWANX" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWANX ;WWWANX;DT;MAILINGS VERSENDEN;15.09.1999
	;
	;/------------------------------------------------------------------\
	;| Description of Function :
	;|		MAILINGS VERSENDEN ; Mailing Dispatch.
	;|
	;| Inputs : 
	;|
	;|
	;| ByRef :
	;|
	;|
	;| Returns :
	;|
	;|
	;| History :
	;| 30-May-2005		RobertW		SR12056: Attempt at Performance Increase
	;| DT	15.09.1999
	;|
	;\------------------------------------------------------------------/
	;
	SET YFORM="WWWANN"
	SET %(YQUERY,"YFORM")=YFORM
	SET %("VAR","YFORM")=YFORM
	DO ^WWWFORM
	JOB START^WWWANX::1
	QUIT
	
START ;
	LOCK +^WWWANA(0):1 QUIT:'$TEST
	DO ^WWWVORG
	SET YUSER="" FOR  SET YUSER=$ORDER(^WWWUSER(0,YUSER)) QUIT:YUSER=""  DO
	. IF +$HOROLOG=$PIECE($GET(^WWWUSER(0,YUSER,1)),Y,3) DO
	. . SET YBED=$PIECE($GET(^WWWUSER(0,YUSER,1)),Y,2)
	. . SET YBEX(YBED)=YUSER
	. . QUIT
	. QUIT
	SET YBED="" FOR  SET YBED=$ORDER(YBEX(YBED)) QUIT:YBED=""  SET YUSER=YBEX(YBED) DO MAIL
	LOCK -^WWWANA(0)
	QUIT
	
MAIL ;STARTEN MAIL FÃœR USER ;launching to 
	;  LESEN DES POSTEINGANGES ;read 
	IF YBED'="" DO
	. DO READ  ;LESEN EMAILS
	. DO SAVE  ;SPEICHERN EMAILS
	. QUIT
	;  SENDEN DES POSTAUSGANGES ;transmit 
	SET YAN="SEND" FOR  SET YAN=$ORDER(^WWWANA(0,YAN)) QUIT:YAN=""  QUIT:$EXTRACT(YAN,1,5)'="SEND "  DO
	. SET DATE="" FOR  SET DATE=$ORDER(^WWWANA(0,YAN,DATE)) QUIT:DATE=""  DO
	. . SET SUBJ="" FOR  SET SUBJ=$ORDER(^WWWANA(0,YAN,DATE,SUBJ)) QUIT:SUBJ=""  DO
	. . . SET TO="" FOR  SET TO=$ORDER(^WWWANA(0,YAN,DATE,SUBJ,TO)) QUIT:TO=""  DO
	. . . . NEW TEXT,TXT,txt
	. . . . MERGE TEXT=^WWWANA(0,YAN,DATE,SUBJ,TO)
	. . . . SET TCP=$PIECE($GET(^WWW012(0,YM,1)),Y,40)
	. . . . IF TCP="" SET TCP="127.0.0.1"
	. . . . SET UUSER=$PIECE(YAN," ",2)
	. . . . IF UUSER="" KILL ^WWWANA(0,YAN,DATE,SUBJ,TO) QUIT
	. . . . SET TXT="TEXT"
	. . . . SET OKSEND=$$^WWWMAILS(TCP,UUSER,TO,SUBJ,TXT)
	. . . . IF OKSEND'=0 QUIT
	. . . . MERGE ^WWWANA(0,"OUT "_UUSER,DATE,SUBJ,TO)=^WWWANA(0,YAN,DATE,SUBJ,TO)
	. . . . KILL ^WWWANA(0,YAN,DATE,SUBJ,TO)
	. . . . QUIT
	. . . QUIT
	. . QUIT
	. QUIT
	QUIT
	
READ ;SUCHEN FORGABEN ,LESEN EMAIL
	SET TCP=$PIECE($GET(^WWW012(0,YM,1)),Y,39)
	IF TCP="" SET TCP=$PIECE($GET(^WWW012(0,YM,1)),Y,40)
	IF TCP="" SET TCP="127.0.0.1"
	KILL ^WWWSOR(YUSER)
	SET GLOB="^WWWSOR("_""""_YUSER_""""
	SET YMIT=$GET(^WWW013(0,YBED,1))
	SET UUSER=$PIECE(YMIT,Y,9)
	SET KONTO=$PIECE(YMIT,Y,17)
	QUIT:KONTO=""
	IF UUSER="" SET UUSER=KONTO
	SET PASSWD=$PIECE(YMIT,Y,18)
	QUIT:PASSWD=""
	SET DELETE=1
	SET EMPFOK=$$^WWWMAILR(TCP,KONTO,PASSWD,DELETE,GLOB)  ;LESEN DATEN ;read 
	QUIT
	
SAVE ;SPEICHERN DATEN
	SET NR=""
	FOR  SET NR=$ORDER(^WWWSOR(YUSER,NR)) QUIT:NR=""  DO
	. SET CC=""
	. SET FROM=""
	. SET SUBJECT=""
	. FOR ITEM="CC","FROM","SUBJECT","DATE" DO
	. . ;FOR I=1:1 QUIT:'$DATA(^WWWSOR(YUSER,NR,I,1))  IF $$^WWWUPER($PIECE(^(1),": "))=ITEM DO  QUIT
	. . FOR I=1:1 QUIT:'$DATA(^WWWSOR(YUSER,NR,I,1))  IF $zconvert($PIECE(^(1),": "),"U")=ITEM DO  QUIT
	. . . SET FELD=$TRANSLATE($PIECE(^(1),": ",2,255),"<>,+"_"""","()")
	. . . IF ITEM="FROM" IF $PIECE($PIECE(FELD,"(",2),")",1)'="" SET FELD=$PIECE($PIECE(FELD,"(",2),")",1)
	. . . IF ITEM="CC" IF $PIECE($PIECE(FELD,"(",2),")",1)'="" SET FELD=$PIECE($PIECE(FELD,"(",2),")",1)
	. . . SET @ITEM=FELD
	. . . QUIT
	. . QUIT
	. SET BOUNDARY=""
	. SET PRINTABLE=""
	. FOR ITEM="BOUNDARY=","CONTENT-TRANSFER-ENCODING: QUOTED-PRINTABLE" DO
	. . ;FOR I=1:1 QUIT:'$DATA(^WWWSOR(YUSER,NR,I,1))  IF $FIND($$^WWWUPER(^(1)),ITEM) DO  QUIT
	. . FOR I=1:1 QUIT:'$DATA(^WWWSOR(YUSER,NR,I,1))  IF $FIND($zconvert(^(1),"U"),ITEM) DO  QUIT
	. . . IF ITEM="BOUNDARY=" SET BOUNDARY=$TRANSLATE($PIECE(^(1),"boundary=",2),"""")
	. . . IF ITEM="CONTENT-TRANSFER-ENCODING: QUOTED-PRINTABLE" SET PRINTABLE=I QUIT
	. . . QUIT
	. . QUIT
	. IF DATE="" SET DATE=" "
	. IF FROM="" SET FROM=" "
	. IF CC="" SET CC=" "
	. IF PRINTABLE="" DO
	. . FOR PRINTABLE=1:1 QUIT:'$DATA(^WWWSOR(YUSER,NR,I,1))  QUIT:^(1)=""
	. . QUIT
	. SET PRINTABLE=PRINTABLE+1
	. MERGE ^WWWANA(0,UUSER,DATE,SUBJECT,FROM)=^WWWSOR(YUSER,NR)
	. KILL ^WWWSOR(YUSER,NR)
	. QUIT
	KILL ^WWWSOR(YUSER)
	QUIT
]]></Routine>
</Export>