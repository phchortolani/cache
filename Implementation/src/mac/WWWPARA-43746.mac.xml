<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="WWWPARA" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
WWWPARA
#include COMSYS
#include COMConst
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		SUCHFUNKTION RELATIONSDATEIEN
	; AUSWAHL IN NEUEM FENSTER ;Selection within window 
	;
	; Called by : Form WWWPARA
	; 		called in turn by routines COMGridEdit31J3, COMViewCustom, COMViewFilter,
	; 		                           COMViewFilterCombo, INDRPBESTVOR1, INTRANSFER6,
	; 		                           WWWFORM, WWWFORM75
	; 
	; Inputs : 
	;
	; ByRef :
	;
	; Returns :
	;
	; History :
    ; 06-Jun-2014	shobby	CORE-385.13: Assume that we will always be using COMView
	; 22-May-2013	shobby	CORE-107.1: Additional parameter so that Menu is not shown on a search function within a popup.
	; 29-Nov-2007	GRF		Doco
    ; 31-Aug-2006	HeberB	SRBR14211: add relational keys to search button
	; 22-Dec-2005	RPW		SR13899: New schluessel
	; 30-May-2005	RPW		SR12056: Attempt at Performance Increase
	; 13-Apr-2005	PaulK	set ^CacheTempFixedField(YUSER,"ReturnValue") to
	; 							indicate value to be returned.
	; 22-Mar-2005	PaulK	SR11912: Changed to check for existance of COMViewSetup
	; 							routine before calling COMView
	; 10.04.2001	FIS
	;-------------------------------------------------------------------------------
	NEW YFORM,SUCH,FORMDATEN,YINHALT,YSSORT,COLOR,YSORTKEY,SCHLUESSEL

	WRITE "<NOBR>"
	
	SET YKEY=""	//,YFKEY=""	; SRBR14211
	SET YLFDAT=$GET(%(YQUERY,"YLFDAT"))  ;LAUFENDE NR DATENSATZ ;data record 
	
	SET YLFFORM=$GET(%(YQUERY,"YLFFORM"))  ;LAUFENDE NR FORMULAR ;form 
	IF $GET(%(YQUERY,"YHTMFORM1"))'="" SET YHTMFORM=$GET(%(YQUERY,"YHTMFORM1"))  ;LAUFENDE NR
	SET YLFDATX=YLFDAT
	SET YLFDAT=$REVERSE($EXTRACT(YLFDAT,2,99))
	FOR YI=1:1  QUIT:$EXTRACT(YLFDAT,YI,99)=""  QUIT:$EXTRACT(YLFDAT,YI)?1N=0  SET YLFN=$EXTRACT(YLFDAT,1,YI)
	SET YLFN=$REVERSE($GET(YLFN))
	IF YLFFORM="" SET YLFFORM=YLFN
	SET YART=$EXTRACT(YLFDAT,YI)
	IF YART'="M" IF YART'="P" IF YART'="D" QUIT
	
	SET YFORM=$REVERSE($EXTRACT(YLFDAT,YI+1,99))
	IF YFORM'="" IF $PIECE($GET(^WWW120(0,YFORM,1)),Y,123)=1 SET YHTMFORM="WWW2"

	;IF ($$EXIST^%R("COMViewSetup.OBJ",$GET(YUCI)))&&($PIECE($GET(^COMViewConfig(0,YM,1)),Y,9)=1) {
	IF 1 { ;CORE-385.13 ($$$COMViewConfigSearchType($GET(^COMViewConfig(0,YM,1)))=1) {
	; PO - 11-Apr-2005
	; The variable YINHALT is not populated with input typed into calling search field
	; I have not managed to track down YINHALT is not being populated, implemented a work around in COMView
		
		; FIXME : <GRF> already have this in YLFDATX - replace in next 2 lines
		if $extract($get(%(YQUERY,"YLFDAT")))'="J" set ^CacheTempFixedField(YUSER,"ReturnValue")=1  ;only set return value if not jumping
		set YPARA=$zconvert($listbuild(YFORM,$get(%(YQUERY,"YLFDAT")),$get(YFKEY),$get(YINHALT),$get(YPARA)),"o","URL") ; SR11661
	;	do RedirectForm^COMUtilForm("COMViewSearch","",YFORM_",",YPARA,YSEITE)
		do RedirectForm^COMUtilForm("COMViewSearch","",YFORM_$$$COMMA,YPARA,YSEITE,,$$$YES) ;CORE-107.1
		// This runs "do AfterDataFields^COMViewFilter(YPARA)"   Why not COMViewSearch to match the form name?
		
		quit                                     ; *** EARLY EXIT ***
	}
	
	;CORE-385.13 *********  All the Code below can be removed as we will always be using COMView
	SET FORMDATEN = $GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,YART,1))
	SET YINHALT   = $PIECE(FORMDATEN,Y,YLFN)
	IF YART="P" SET YINHALT=$PIECE(FORMDATEN,",",YLFN)
	SET YSORTKEY=""  ;PRÜFEN OB EINSCHRÄNKUNG DURCH SORTKEY, DA NOCH NICHT IN WWWPARASEAR UMGESETZT;26612;20.10.04
	
	;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF YFORM'="" IF YLFN'="" IF $PIECE($GET(^WWW120(0,YFORM,1)),Y,11)'="" SET YDATEI=$PIECE($GET(^WWW120(0,YFORM,1)),Y,11) DO  ;MIT KLASSE
	. IF YART="P" SET YSORTKEY=$PIECE($GET(^WWW002(0,YDATEI,YLFN,1)),Y,21)
	. IF YART="P" IF YSORTKEY="" IF YLFFORM'="" SET YSORTKEY=$PIECE($GET(^WWW121(0,YFORM,YLFFORM,1)),Y,31)
	. IF YART="D" SET YSORTKEY=$PIECE($GET(^WWW003(0,YDATEI,YLFN,1)),Y,21)
	. IF YART="D" IF YSORTKEY="" IF YLFFORM'="" SET YSORTKEY=$PIECE($GET(^WWW122(0,YFORM,YLFFORM,1)),Y,31)
	. IF YART="M" IF YLFFORM'="" SET YSORTKEY=$PIECE($GET(^WWW122(0,YFORM,YLFFORM,1)),Y,31)
	
	;IF YFORM'="" IF YLFN'="" IF $PIECE($GET(^WWW122(0,YFORM,YLFFORM,1)),Y,121)=1 DO ^WWWPARASEAR QUIT  ;FIS;ANZEIGE MIT SUCHOPTION;02.09.04;26164
	;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK END
	
	
	; *** EARLY EXIT ***
	;	D121		$$$WWW121SearchAsFullTextSearch / $$$WWW122SearchAsFullTextSearch
	IF YSORTKEY="" IF YART'="P" IF YFORM'="" IF YLFN'="" IF YLFFORM'="" IF $PIECE($GET(^WWW122(0,YFORM,YLFFORM,1)),Y,121)=$$$YES DO ^WWWPARASEAR(YINHALT) QUIT
	IF YSORTKEY="" IF YART="P"  IF YFORM'="" IF YLFN'=""                IF $PIECE($GET(^WWW121(0,YFORM,YLFN,1)),Y,121)=$$$YES    DO ^WWWPARASEAR(YINHALT) QUIT
	; ******************
	
	
	KILL ^WWWSOR(YUSER,2)
	SET YPARA(1)  = ""   ;RELATIONEN
	SET YPARA(2)  = ""   ;PARAMETER
	SET YPARA(3)  = ""   ;DATENFELD ;data item 
	SET YPARA(12) = 0    ;SORTIEREN JA/NEIN ;assortment 
	SET YPARA(20) = 0    ;ALLE ANZEIGEN ;display 
	SET YPARA(33) = ""   ;ZUGRIFF AUF SORTKEY ;upon 
	SET YPARA(67) = ""   ;EVENTBR
	SET YPARA(79) = ""   ;RELATIONSFELD FÜR MARKIERUNG ;to 
	SET YPARA(29) = 1    ;SOTIERUNG
	
	; *** EARLY EXIT ***
	;	D26		$$$WWW001NumberExpectedDataset  (Estimate of dataset size - affects search logic)
	IF YINHALT="" IF YPARA(1)'="" IF $PIECE($GET(^WWW001(0,YPARA(1),1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	IF YINHALT="" IF YPARA(1)'="" IF $$^WWWBITCOUNT(YPARA(1))>10                   WRITE $$^WWWTEXT(406) QUIT
	
	; PRIMAERSCHLUESSEL 
	;---------------------------------------
	IF YART="P" DO
	. SET YDATEI = $PIECE($GET(^WWW120(0,YFORM,1)),Y,11)   QUIT:YDATEI=""     ; $$$WWW120ClassUsedInForm   ;RELATIONSDATEI
	. SET YDVOR  = $GET(^WWW002(0,YDATEI,YLFN,1))          QUIT:YDVOR=""      ;VORGABEN AUS DATEIDEV ;out of 
	. SET YSATZ  = $GET(^WWW121(0,YFORM,YLFFORM,1))        QUIT:YSATZ=""      ;VORGABEN AUS FORMULAR ;out of form 
	. ;
	. SET YSSORT = $PIECE($PIECE(YSATZ,Y,31),",",1)                           ; $$$WWW121DisplayIfSORTKeys
	. SET YTYPE  = $PIECE(YDVOR,Y,3)  ; $$$WWW002InputType  ; TYPE AUS DATEI DEV
	. SET YXTYP  = 0                  ;ERFASSUNGSART AUS FORMULARFELD ;out of 
	. ;
	. SET YPARA(1)  = $PIECE(YDVOR,Y,8)    ;RELATIONEN
	. SET YPARA(2)  = $PIECE(YDVOR,Y,9)    ;PARAMETER
	. SET YPARA(3)  = $PIECE(YDVOR,Y,10)   ;DATENFELD ;data item 
	. SET YPARA(12) = $PIECE(YDVOR,Y,7)    ;SORTIEREN JA/NEIN ;assortment 
	. SET YPARA(20) = 0                    ;ALLE ANZEIGEN ;display 
	. SET YPARA(33) = $PIECE(YDVOR,Y,21)   ;ZUGRIFF AUF SORTKEY ;upon 
	. SET YPARA(67) = $PIECE(YSATZ,Y,67)   ;EVENTBR
	. SET YPARA(79) = $PIECE(YSATZ,Y,79)   ;RELATIONSFELD FÜR MARKIERUNG ;to 
	. ;
	. IF $PIECE(YSATZ,Y,32)'="" DO    ;TYBD;26216;24,8,2004;UNTERKEYS
	. . SET YPARA(1)  = $PIECE(YSATZ,Y,32)
	. . SET YPARA(2)  = $PIECE(YSATZ,Y,33)  ;KEY F. RELATION
	. . SET YPARA(3)  = $PIECE(YSATZ,Y,34)  ;FELDER
	. . SET YPARA(33) = $PIECE(YSATZ,Y,31)  ;ZUGRIFF AUF SORTKEY ;upon 
	. . IF YLFN'=1 IF YPARA(2)="" IF YPARA(1)=$PIECE($GET(^WWW120(0,YFORM,1)),Y,11) DO
	. . . NEW YLFN1
	. . . FOR YLFN1=1:1:YLFN-1 DO
	. . . . QUIT:$PIECE(FORMDATEN,",",YLFN1)=""
	. . . . IF YPARA(2)'="" SET YPARA(2)=YPARA(2)_","
	. . . . SET YPARA(2)=YPARA(2)_""""_$PIECE(FORMDATEN,",",YLFN1)_""""
	. ;
	. IF +YSSORT'=0 IF YINHALT="" SET YSSORT=""
	. IF +YSSORT'=0 DO  QUIT   ;WWWSOR;DT;AUSWAHL AUS DATEI;03.02.1999
	. . NEW YA,YKEYY
	. . SET YDATEI=YPARA(1)    ;DATEI ;data file 
	. . ;S YFKEY=FESTE PRIMÄRSCHLÜSSEL
	. . SET YAUSW  = ""        ;"*"_YINHALT  ; (AB KEY) ODER SORT AB ODER *=WILDCARD
	. . SET YRICHT = 0         ;UP ; 1 DOWN
	. . SET YSORT  = YSSORT    ;  = SORTIERSCHLÜSSEL
	. . IF YSORT>0 SET YINHALT=$$^WWWUMLAU(YINHALT,1)
	. . SET YANZ   = 200       ; ANZAHL DER GESUCHTEN WERTE ;Number the 
	. . SET YKOMP  = 1         ;= KOMPLETTER KEY; 2 LETZTER KEY FEHLT(GRID-SUCHE)
	. . SET YFIND  = ""        ;YINHALT  ;  = SATZ IN FORM YFELD, WENN $F DER SAETZE->DANN STOP
	. . SET YFFKY  = ""        ;  = SATZ IN FORM YKEY, WENN $F DER SAETZE->DANN STOP
	. . SET YSAUSW = YINHALT   ; FIX VORGABEN FÜR SORTKEY ;skillful to 
	. . ;IF YLFN'=1 IF YPARA(1)=$PIECE($GET(^WWW120(0,YFORM,1)),Y,11) SET YFKEY=$PIECE(FORMDATEN,",",1,LFN-1)
	. . IF YINHALT="" IF YDATEI'="" IF $PIECE($GET(^WWW001(0,YDATEI,1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. . IF YINHALT="" IF YPARA(2)="" IF YDATEI'="" IF $$^WWWBITCOUNT(YDATEI)>1000  WRITE $$^WWWTEXT(406) QUIT
	. . DO ^WWWSOR(YDATEI,YFKEY,YAUSW,YRICHT,YSORT,YANZ,YKOMP,YFIND,YFFKY,YSAUSW)
	. . SET YA(2) = ""
	. . FOR  SET YA(2) = $ORDER(^WWWSOR(YUSER,"KEY",YA(2))) QUIT:YA(2)=""  DO
	. . . SET YKEYY = ""
	. . . FOR  SET YKEYY = $ORDER(^WWWSOR(YUSER,"KEY",YA(2),YKEYY)) QUIT:YKEYY=""  DO 
	. . . . SET YFELD=""
	. . . . IF YDATEI'="" DO
	. . . . . SET YDATA   = $GET(^WWW001(0,YDATEI,1))
	. . . . . SET MAXYKEY = +$ORDER(^WWW002(0,YDATEI,""),-1)
	. . . . . IF MAXYKEY=0 SET MAXYKEY=1
	. . . . . SET ERSTFELD = $ORDER(^WWW003(0,YDATEI,""))
	. . . . . SET FELDKEY  = ""
	. . . . . IF ERSTFELD'="" SET FELDKEY = $PIECE(^WWW003(0,YDATEI,ERSTFELD,1),Y,11)  ;FUER MIT ODER OHNE ,1) ZUM SCHLUESSEL
	. . . . . IF MAXYKEY'=0 DO
	. . . . . . SET Q=0
	. . . . . . IF $GET(YTIMEFORM)'=1 SET SCHLUESSEL="^"_YDATEI_"("_$$^WWWYM(YDATEI,1)
	. . . . . . IF $GET(YTIMEFORM)=1  SET SCHLUESSEL="^"_YDATEI_"t("_$$^WWWYM(YDATEI,1) SET MAXYKEY=MAXYKEY+1
	. . . . . . FOR I=1:1:MAXYKEY SET XYKEY=$TRANSLATE($PIECE(YKEYY,",",I),"""") SET SCHLUESSEL=SCHLUESSEL_""""_XYKEY_"""" SET:I<MAXYKEY SCHLUESSEL=SCHLUESSEL_"," IF XYKEY="" SET Q=1
	. . . . . . IF $PIECE(YDATA,Y,8)=4  SET SCHLUESSEL=SCHLUESSEL_$SELECT(FELDKEY'="":","_FELDKEY,1:"")_")"
	. . . . . . IF $PIECE(YDATA,Y,8)'=4 SET SCHLUESSEL=SCHLUESSEL_",1)"
	. . . . . . IF Q=0 DO
	. . . . . . . SET YFELD=$$^WWWSETL(SCHLUESSEL)
	. . . . . . . SET YNR=$GET(YNR)+1
	. . . . . . . SET ^WWWSOR(YUSER,2,YNR,YKEYY)=$$^WWWUML($PIECE(YFELD,Y,+YPARA(3))_" "_$PIECE(YFELD,Y,$PIECE(YPARA(3),";",2))_"- "_YKEYY)
	. . ;
	. . KILL ^WWWSOR(YUSER,"SEL")
	. . KILL ^WWWSOR(YUSER,"KEY")
	. ;
	. IF YPARA(1)="" WRITE $$^WWWTEXT(63) QUIT     ; "No Class Default"
	. IF YINHALT="" IF YPARA(1)'="" IF $PIECE($GET(^WWW001(0,YPARA(1),1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. IF YINHALT="" IF YPARA(2)="" IF YPARA(1)'="" IF $$^WWWBITCOUNT(YPARA(1))>1000  WRITE $$^WWWTEXT(406) QUIT
	. DO ^WWWFOR71
	
	
	
	; DATENFELDER
	;---------------------------------------
	IF YART="D" DO
	. ;
	. SET YDATEI=$PIECE($GET(^WWW120(0,YFORM,1)),Y,11)    QUIT:YDATEI=""
	. SET YDVOR=$GET(^WWW003(0,YDATEI,YLFN,1))            QUIT:YDVOR=""   ;DATEN AUS FELDDEV ;out of 
	. SET YSATZ=$GET(^WWW122(0,YFORM,YLFFORM,1))          QUIT:YSATZ=""   ;DATEN AUS FORMULAR ;out of form 
	. ;
	. SET YSSORT = $PIECE($PIECE(YSATZ,Y,31),",",1)
	. SET YTYPE  = $PIECE(YDVOR,Y,3)        ;TYPE AUS DATEI DEV ;letter out of data file 
	. SET YXTYP  = +$PIECE(YSATZ,Y,2)       ;ERFASSUNGSART AUS FORMULARFELD ;out of 
	. ;
	. SET YPARA(1)  = $PIECE(YDVOR,Y,8)     ;RELATIONSDATEI AUS DATEIDEV ;out of 
	. SET YPARA(2)  = $PIECE(YDVOR,Y,9)     ;REL KEY
	. SET YPARA(3)  = $PIECE(YDVOR,Y,10)    ;REL FELD ;field 
	. SET YPARA(12) = $PIECE(YDVOR,Y,7)     ;RELATION SORTIEREN ;assortment 
	. IF $PIECE(YDVOR,Y,29)=1 SET YPARA(29)=-1   ;RELATION ABSTEIGEND WENN =1  ;when 
	. SET YPARA(20) = 0                     ;ALLE ANZEIGEN ;display 
	. SET YPARA(33) = $PIECE(YDVOR,Y,21)    ;ZUGRIFF AUF SORTKEY ;upon 
	. IF $PIECE(YSATZ,Y,63)'="" SET YPARA(3)=$PIECE(YSATZ,Y,63)
	. IF $PIECE(YSATZ,Y,32)'="" DO
	. . SET YPARA(1)  = $PIECE(YSATZ,Y,32)  ;RELDATEI AUS FORMULAR DEV ;out of form 
	. . SET YPARA(2)  = $PIECE(YSATZ,Y,33)  ;KEY F. RELATION
	. . SET YPARA(3)  = $PIECE(YSATZ,Y,34)  ;FELDER
	. . SET YPARA(12) = $PIECE(YSATZ,Y,62)  ;REL SORTIEREN  ;assortment 
	. . SET YPARA(33) = $PIECE(YSATZ,Y,31)  ;ZUGRIFF AUF SORTKEY ;upon 
	. . IF $PIECE(YSATZ,Y,29)=1 SET YPARA(29) = -1   ;RELATION ABSTEIGEND WENN =1 ;TYBD;26,09,2003
	. ;
	. SET YPARA(67) = $PIECE(YSATZ,Y,67)    ;NEUES FELD AUS EVENT BROKER ;something new field out of 
	. SET YPARA(79) = $PIECE(YSATZ,Y,79)    ;RELATIONSFELD FÜR MARKIERUNG ;to 
	. ;
	. IF $DATA(^WWW1251(0,YFORM,YLFFORM)) DO   ;SELEKTIONEN SONDER
	. . SET YXTYP     = +$PIECE($GET(^WWW1251(0,YFORM,YLFFORM,1,1)),Y,2)
	. . SET YPARA(12) = 0  ;SORTIERUNG PARA ;sorting 
	. . SET YPARA(1)  = "WWW1251"
	. . SET YPARA(2)  = """"_YFORM_""""_","_""""_YLFFORM_""""
	. . SET YPARA(3)  = 1
	. ;
	. IF +YSSORT'=0 IF YINHALT="" SET YSSORT=""
	. IF +YSSORT'=0 DO  QUIT   ;WWWSOR;DT;AUSWAHL AUS DATEI;03.02.1999
	. . NEW YA,YKEYY
	. . SET YDATEI = YPARA(1)  ;DATEI ;data file 
	. . SET YAUSW  = ""        ;"*"_YINHALT  ; (AB KEY) ODER SORT AB ODER *=WILDCARD
	. . SET YRICHT = 0         ;UP ; 1 DOWN
	. . SET YSORT  = YSSORT    ;  = SORTIERSCHLÜSSEL
	. . IF YSORT>0 SET YINHALT = $$^WWWUMLAU(YINHALT,1)
	. . SET YANZ   = 200       ; ANZAHL DER GESUCHTEN WERTE ;Number the 
	. . SET YKOMP  = 1         ;= KOMPLETTER KEY; 2 LETZTER KEY FEHLT(GRID-SUCHE)
	. . SET YFIND  = ""        ;YINHALT  ;  = SATZ IN FORM YFELD, WENN $F DER SAETZE->DANN STOP
	. . SET YFFKY  = ""        ; = SATZ IN FORM YKEY, WENN $F DER SAETZE->DANN STOP
	. . SET YSAUSW = YINHALT   ; FIX VORGABEN FÜR SORTKEY ;skillful to 
	. . ;
	. . IF YINHALT="" IF YDATEI'="" IF $PIECE($GET(^WWW001(0,YDATEI,1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. . IF YINHALT="" IF YDATEI'="" IF $$^WWWBITCOUNT(YDATEI)>1000                 WRITE $$^WWWTEXT(406) QUIT
	. . DO ^WWWSOR(YDATEI,YFKEY,YAUSW,YRICHT,YSORT,YANZ,YKOMP,YFIND,YFFKY,YSAUSW)
	. . SET YA(2)=""
	. . FOR  SET YA(2)=$ORDER(^WWWSOR(YUSER,"KEY",YA(2))) QUIT:YA(2)=""  DO
	. . . SET YKEYY=""
	. . . FOR  SET YKEYY=$ORDER(^WWWSOR(YUSER,"KEY",YA(2),YKEYY)) QUIT:YKEYY=""  DO 
	. . . . SET YFELD=""
	. . . . IF YDATEI'="" DO
	. . . . . SET YDATA=$GET(^WWW001(0,YDATEI,1))
	. . . . . SET MAXYKEY=+$ORDER(^WWW002(0,YDATEI,""),-1)
	. . . . . IF MAXYKEY=0 SET MAXYKEY=1
	. . . . . SET ERSTFELD=$ORDER(^WWW003(0,YDATEI,""))
	. . . . . SET FELDKEY=""
	. . . . . IF ERSTFELD'="" SET FELDKEY=$PIECE(^WWW003(0,YDATEI,ERSTFELD,1),Y,11) ;FUER MIT ODER OHNE ,1) ZUM SCHLUESSEL
	. . . . . IF MAXYKEY'=0 DO
	. . . . . . SET Q=0
	. . . . . . IF $GET(YTIMEFORM)'=1 SET SCHLUESSEL="^"_YDATEI_"("_$$^WWWYM(YDATEI,1)
	. . . . . . IF $GET(YTIMEFORM)=1  SET SCHLUESSEL="^"_YDATEI_"t("_$$^WWWYM(YDATEI,1) SET MAXYKEY=MAXYKEY+1
	. . . . . . FOR I=1:1:MAXYKEY SET XYKEY=$TRANSLATE($PIECE(YKEYY,",",I),"""") SET SCHLUESSEL=SCHLUESSEL_""""_XYKEY_"""" SET:I<MAXYKEY SCHLUESSEL=SCHLUESSEL_"," IF XYKEY="" SET Q=1
	. . . . . . IF $PIECE(YDATA,Y,8)=4  SET SCHLUESSEL=SCHLUESSEL_$SELECT(FELDKEY'="":","_FELDKEY,1:"")_")"
	. . . . . . IF $PIECE(YDATA,Y,8)'=4 SET SCHLUESSEL=SCHLUESSEL_",1)"
	. . . . . . IF Q=0 DO
	. . . . . . . SET YFELD=$$^WWWSETL(SCHLUESSEL)
	. . . . . . . SET YNR=$GET(YNR)+1
	. . . . . . . SET ^WWWSOR(YUSER,2,YNR,YKEYY)=$$^WWWUML($PIECE(YFELD,Y,+YPARA(3))_" "_$PIECE(YFELD,Y,$PIECE(YPARA(3),";",2))_"- "_YKEYY)
	. . ;
	. . KILL ^WWWSOR(YUSER,"SEL")
	. . KILL ^WWWSOR(YUSER,"KEY")
	. ;
	. IF YPARA(1)="" WRITE $$^WWWTEXT(63) QUIT     ; "No Class Default"
	. IF YINHALT="" IF YPARA(1)'="" IF $PIECE($GET(^WWW001(0,YPARA(1),1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. IF YINHALT="" IF YPARA(1)'="" IF $$^WWWBITCOUNT(YPARA(1))>1000                 WRITE $$^WWWTEXT(406) QUIT
	. DO ^WWWFOR71
	
	
	
	;MANUELLE FELDER
	;---------------------------------------
	IF YART="M" DO
	. SET YSATZ=$GET(^WWW122(0,YFORM,YLFN,1))  ;DATEN AUS FORMULAR ;out of form 
	. QUIT:YSATZ=""
	. SET YSSORT    = $PIECE($PIECE(YSATZ,Y,31),",",1)
	. SET YTYPE     = ""                       ;TYPE AUS DATEI DEV ;letter out of data file 
	. SET YXTYP     = +$PIECE(YSATZ,Y,2)       ;ERFASSUNGSART AUS FORMULARFELD ;out of 
	. ;
	. SET YPARA(1)  = $PIECE(YSATZ,Y,32)       ;RELATIONSDATEI
	. SET YPARA(2)  = $PIECE(YSATZ,Y,33)       ;REL.KEY
	. SET YPARA(3)  = $PIECE(YSATZ,Y,34)       ;FELD ;field 
	. SET YPARA(12) = $PIECE(YSATZ,Y,62)       ;REL. SORTIEREN ;assortment 
	. SET YPARA(33) = $PIECE(YSATZ,Y,31)       ;ZUGRIFF AUF SORTKEY ;upon 
	. IF $PIECE(YSATZ,Y,29)=1   SET YPARA(29) = -1 ;RELATION ABSTEIGEND WENN =1  ;when 
	. IF $PIECE(YSATZ,Y,63)'="" SET YPARA(3)  = $PIECE(YSATZ,Y,63)
	. SET YPARA(20) = 0                        ;ALLE ANZEIGEN ;display 
	. SET YPARA(79) = $PIECE(YSATZ,Y,79)       ;RELATIONSFELD FÜR MARKIERUNG ;to 
	. IF $DATA(^WWW1251(0,YFORM,YLFN)) DO      ;SELEKTIONEN
	. . SET YXTYP = +$PIECE($GET(^WWW1251(0,YFORM,YLFN,1,1)),Y,2)
	. . ;SET YPARA(12)=0  ;SORTIERUNG PARA ;table-mat sorting 
	. . SET YPARA(1) = "WWW1251"
	. . SET YPARA(2) = """"_YFORM_""""_","_""""_YLFN_""""
	. . SET YPARA(3) = 1
	. ;
	. IF +YSSORT'=0 IF YINHALT="" SET YSSORT=""
	. IF +YSSORT'=0 DO  QUIT   ;WWWSOR;DT;AUSWAHL AUS DATEI;03.02.1999
	. . NEW YA,YKEYY
	. . SET YDATEI = YPARA(1)  ;DATEI ;data file 
	. .;SET YFKEY  = FESTE PRIMÄRSCHLÜSSEL
	. . SET YAUSW  = ""      ;"*"_YINHALT  ; (AB KEY) ODER SORT AB ODER *=WILDCARD
	. . SET YRICHT = 0       ;UP ; 1 DOWN
	. . SET YSORT  = YSSORT  ;  = SORTIERSCHLÜSSEL
	. . SET YANZ   = 200     ; ANZAHL DER GESUCHTEN WERTE ;Number the 
	. . SET YKOMP  = 1       ;= KOMPLETTER KEY; 2 LETZTER KEY FEHLT(GRID-SUCHE)
	. . SET YFIND  = ""      ;YINHALT  ;  = SATZ IN FORM YFELD, WENN $F DER SAETZE->DANN STOP
	. . SET YFFKY  = ""      ;  = SATZ IN FORM YKEY, WENN $F DER SAETZE->DANN STOP
	. .;SET YSAUSW = $$^WWWUPER(YINHALT)     ; FIX VORGABEN FÜR SORTKEY ;skillful to 
	. . SET YSAUSW = $zconvert(YINHALT,"U")  ; FIX VORGABEN FÜR SORTKEY ;skillful to 
	. . IF YSORT>0 SET YSAUSW=$$^WWWUMLAU(YINHALT,1)
	. . IF YINHALT="" IF YDATEI'="" IF $PIECE($GET(^WWW001(0,YDATEI,1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. . IF YINHALT="" IF YDATEI'="" IF $$^WWWBITCOUNT(YDATEI)>1000                 WRITE $$^WWWTEXT(406) QUIT
	. . DO ^WWWSOR(YDATEI,YFKEY,YAUSW,YRICHT,YSORT,YANZ,YKOMP,YFIND,YFFKY,YSAUSW)
	. . SET YA(2)=""
	. . FOR  SET YA(2)=$ORDER(^WWWSOR(YUSER,"KEY",YA(2))) QUIT:YA(2)=""  DO
	. . . SET YKEYY=""
	. . . FOR  SET YKEYY=$ORDER(^WWWSOR(YUSER,"KEY",YA(2),YKEYY)) QUIT:YKEYY=""  DO 
	. . . . SET YFELD=""
	. . . . IF YDATEI'="" DO
	. . . . . SET YDATA=$GET(^WWW001(0,YDATEI,1))
	. . . . . SET MAXYKEY=+$ORDER(^WWW002(0,YDATEI,""),-1)
	. . . . . IF MAXYKEY=0 SET MAXYKEY=1
	. . . . . SET ERSTFELD=$ORDER(^WWW003(0,YDATEI,""))
	. . . . . SET FELDKEY=""
	. . . . . IF ERSTFELD'="" SET FELDKEY=$PIECE(^WWW003(0,YDATEI,ERSTFELD,1),Y,11) ;FUER MIT ODER OHNE ,1) ZUM SCHLUESSEL
	. . . . . IF MAXYKEY'=0 DO
	. . . . . . SET Q=0
	. . . . . . IF $GET(YTIMEFORM)'=1 SET SCHLUESSEL="^"_YDATEI_"("_$$^WWWYM(YDATEI,1)  ;TYBD:01.11.01
	. . . . . . IF $GET(YTIMEFORM)=1  SET SCHLUESSEL="^"_YDATEI_"t("_$$^WWWYM(YDATEI,1) SET MAXYKEY=MAXYKEY+1  ;TYBD:01.11.01
	. . . . . . FOR I=1:1:MAXYKEY SET XYKEY=$TRANSLATE($PIECE(YKEYY,",",I),"""") SET SCHLUESSEL=SCHLUESSEL_""""_XYKEY_"""" SET:I<MAXYKEY SCHLUESSEL=SCHLUESSEL_"," IF XYKEY="" SET Q=1
	. . . . . . IF $PIECE(YDATA,Y,8)=4  SET SCHLUESSEL=SCHLUESSEL_$SELECT(FELDKEY'="":","_FELDKEY,1:"")_")"
	. . . . . . IF $PIECE(YDATA,Y,8)'=4 SET SCHLUESSEL=SCHLUESSEL_",1)"
	. . . . . . IF Q=0 DO
	. . . . . . . SET YFELD=$$^WWWSETL(SCHLUESSEL)
	. . . . . . . SET YNR=$GET(YNR)+1
	. . . . . . . SET ^WWWSOR(YUSER,2,YNR,YKEYY)=$$^WWWUML($PIECE(YFELD,Y,+YPARA(3))_" "_$PIECE(YFELD,Y,$PIECE(YPARA(3),";",2))_"- "_YKEYY)
	. . ;
	. . KILL ^WWWSOR(YUSER,"SEL")
	. . KILL ^WWWSOR(YUSER,"KEY")
	. ;
	. IF YPARA(1)="" WRITE $$^WWWTEXT(63) QUIT      ; "No Class Default"
	. IF YINHALT="" IF YPARA(1)'="" IF $PIECE($GET(^WWW001(0,YPARA(1),1)),Y,26)>1000 WRITE $$^WWWTEXT(406) QUIT    ; "Too Many Records! Please Edit Search Text."
	. IF YINHALT="" IF YPARA(1)'="" IF $$^WWWBITCOUNT(YPARA(1))>1000                 WRITE $$^WWWTEXT(406) QUIT
	. DO ^WWWFOR71
	
	
	
	WRITE YCR,"<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 VALIGN=TOP ALIGN=LEFT>"
	NEW LFN
	SET LFN=0     ;BEC;23737;19.11.03;DAMIT ANZEIGE KOMMT KEINE DATEN GEFUNDEN
	SET YNR=""
	FOR  SET YNR=$ORDER(^WWWSOR(YUSER,2,YNR),$GET(YPARA(29))) QUIT:YNR=""  DO
	. SET LFN=+$GET(LFN)+1
	. SET YPARAM=""
	. FOR  SET YPARAM=$ORDER(^WWWSOR(YUSER,2,YNR,YPARAM),$GET(YPARA(29))) QUIT:YPARAM=""  DO
	. . SET COLOR=""
	. . IF $GET(YPARA(1))'="" IF $GET(YPARA(2))'="" IF $FIND(YPARA(1),"WWW101")!($FIND(YPARA(1),"INPARA")) DO  ;RELATIONSDATEI AUS DATEIDEV ;out of 
	. . . NEW DATEI
	. . . SET DATEI="^"_YPARA(1)_"("_""""_YM_""""_","_YPARA(2)_","_""""_YNR_""""_",1)"
	. . . IF $DATA(@DATEI) SET EXEC="SET COLOR=$P($G(^"_YPARA(1)_"("_""""_YM_""""_","_YPARA(2)_","_""""_YNR_""""_",1)),Y,2)" XECUTE EXEC
	. . . IF COLOR'="" SET COLOR=$PIECE($GET(^WWW100(0,"FARBE",SPRACHE,COLOR,1)),Y,1)
	. . ;
	. . WRITE YCR,"<TR>"
	. . WRITE YCR,"<TD NOWRAP ALIGN=LEFT"
	. . IF COLOR'="" WRITE " BGCOLOR="_""""_COLOR_""""
	. . WRITE ">"
	. . WRITE YCR,"<FONT SIZE=2>"
	. . WRITE "<A HREF="_""""_"#"_""""
	. . ;W "JavaScript:void(0);"_""""
	. . WRITE " onClick="_""""_"window.returnValue='"_YPARAM_"'; window.close();"_""""
	. . ;WRITE "opener.document."_YHTMFORM_"."_YLFDATX_".value='"_YPARAM_"';opener.document."_YHTMFORM_"."_YLFDATX_".focus();document.close();close();"_""""
	. . WRITE ">"
	. . ;WRITE $GET(^WWWSOR(YUSER,2,YNR,YPARAM))
	. . IF $GET(YPARA(80))'="" IF $FIND(","_YPARA(80)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,1,1)),Y,1)_">"
	. . IF $GET(YPARA(81))'="" IF $FIND(","_YPARA(81)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,2,1)),Y,1)_">"
	. . IF $GET(YPARA(82))'="" IF $FIND(","_YPARA(82)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,3,1)),Y,1)_">"
	. . DO  ;I $PIECE($G(YSATZ),Y,120)'=1   ;NUR WENN NICHT KEYANZEIGE
	. . . WRITE $GET(^WWWSOR(YUSER,2,YNR,YPARAM))
	. . ;
	. . IF $GET(YPARA(80))'="" IF $FIND(","_YPARA(80)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . IF $GET(YPARA(81))'="" IF $FIND(","_YPARA(81)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . IF $GET(YPARA(82))'="" IF $FIND(","_YPARA(82)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . ;
	. . IF YART="M" DO
	. . . IF YPARA(1)="INPARTN" QUIT  ;FALSCH FÜR ANSPRECHPARTNER;FAN;14.07.2003;23797;GGF IMMER Q WENN FEHLER;TYBD;23,07,2003
	. . . ;SET SUCH="^"_YPARA(1)_"("_""""_YM_""""_","_""""_YPARAM_""""_")"
	. . . SET SUCH="^"_YPARA(1)_"("_""""_$$^WWWYM(YPARA(1))_""""_","_""""_YPARAM_""""_")"  ;FIS;03.09.04
	. . . SET SUCH=$QUERY(@SUCH)
	. . . QUIT:SUCH=""
	. . . IF '$FIND($GET(^WWWSOR(YUSER,2,YNR,YPARAM)),$EXTRACT($PIECE($GET(@SUCH),Y,+YPARA(3)),1,10)) DO
	. . . . ;
	. . . . IF $GET(YPARA(80))'="" IF $FIND(","_YPARA(80)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,1,1)),Y,1)_">"
	. . . . IF $GET(YPARA(81))'="" IF $FIND(","_YPARA(81)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,2,1)),Y,1)_">"
	. . . . IF $GET(YPARA(82))'="" IF $FIND(","_YPARA(82)_",",","_YPARAM_",") WRITE "<FONT COLOR="_$PIECE($GET(^WWW100(0,"FARBMARKIERUNG",SPRACHE,3,1)),Y,1)_">"
	. . . . WRITE $PIECE($GET(@SUCH),Y,+YPARA(3))     ;AUSGESCHALTET ;FAN;14.07.2003;23797;BEI ANSPRACHPARTNER AUSWAHL;??????????
	. . . . IF $GET(YPARA(80))'="" IF $FIND(","_YPARA(80)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . . . IF $GET(YPARA(81))'="" IF $FIND(","_YPARA(81)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . . . IF $GET(YPARA(82))'="" IF $FIND(","_YPARA(82)_",",","_YPARAM_",") WRITE "</FONT COLOR>"
	. . ;
	. . WRITE "</A>"
	. . WRITE YCR,"</TD>"
	. . WRITE YCR,"</TR>"
	. . ;WRITE "<BR>"
	. . WRITE YCR
	
	IF YINHALT'="" IF LFN=0 WRITE $$^WWWTEXT(119)  ; "No Data Record Found"
	;DO ^WWWFRAME(1)
	KILL ^WWWSOR(YUSER,2)
	
	QUIT
	
]]></Routine>
</Export>