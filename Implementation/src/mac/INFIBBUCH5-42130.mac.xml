<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INFIBBUCH5" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INFIBBUCH5(BUCHUNG,YFPARA,BUCHART,KEY)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		BUCHEN IN SIMBA FIBU
	;	VORGABE=BUCHUNG
	;	S BUCHUNG=^INFIBBUCH(YM,BTR,DAT,VOR,1)
	;	S BUCHUNG=";DATUM $H;BETRAG;SOLL;HABEN;STEUER;BELEGNR.;TEXT"   ;Kostenstelle-12;skontotage-13;skonto%-14;netto-15;betrieb-16;warengruppe-17;steuerid-18;;;;;text2-22;rechnungsnummerdeslieferanten-23;zahlungsweg-24 "
	;
	; Inputs : 
	;	BUCHART=DATENSATZEBENE
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 05-Feb-2007	GRF		SR15424: Naked References; doco
	; 08.12.2001	DT
	;-------------------------------------------------------------------------------
	NEW YRETURN,MAN,UCI,DATUM,BUCH,IDNR,LIEF,KUND,KOND,BTR,ZAEHL,SAT2,NUM,DAT
	
	SET BUCHART=$GET(BUCHART)
	SET KEY=$GET(KEY)
	SET YRETURN=""
	SET MAN=0 
	IF $PIECE(YFPARA,Y,2)'="" SET MAN=$PIECE(YFPARA,Y,2)  ;MANDANT IN FIBU ;Company within 
	QUIT:MAN="" YRETURN
	
	IF $PIECE(YFPARA,Y,3)'="" SET BTR=$PIECE(YFPARA,Y,3)  ;BETRIEB IN FIBU ;location within 
	IF $GET(BTR)="" SET BTR=1
	SET UCI=YUCI
	IF $PIECE(YFPARA,Y,1)'="" SET UCI=$PIECE(YFPARA,Y,1)  ;NAMESPACE IN FIBU ;within 
	SET YH=";"
	SET BUCHUNG=$TRANSLATE(BUCHUNG,YH,",")  
	IF $PIECE(BUCHUNG,Y,2)="" SET $PIECE(BUCHUNG,Y,2)=+$HOROLOG
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("MND"_YH_MAN)   ;MANDANTENKENNUNG
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET DATUM=$$^WWWDATE($PIECE(BUCHUNG,Y,2))
	SET BUCH=$EXTRACT(DATUM,4,5)_$EXTRACT(DATUM,7,10)   ;BUCHUNGSZEITRAUM MMJJJJ
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("BZR"_YH_$EXTRACT(100+$$^WWWMONTH(),2,3)_$$^WWWYEAR())  ;MANDANTENKENNUNG
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF("WHG"_YH_YWHR)  ;MANDANTENWAEHRUNG
	SET DATUM=$EXTRACT(DATUM,1,2)_BUCH                  ;BUCHUNGSDATUM
	QUIT:BUCH="" YRETURN                                ;KEIN BUCHUNGSZEITRAUM ;no 
	
	;SOLL BUCHUNG
	SET KONTOS=$PIECE(BUCHUNG,Y,4)       ;KONTO SOLL ;acct. 
	QUIT:KONTOS="" YRETURN               ;KEIN SOLL ;no 
	QUIT:$PIECE(BUCHUNG,Y,5)="" YRETURN  ;KEIN HABEN ;no have got 
	
	IF +$PIECE(BUCHUNG,Y,3)=0 QUIT YRETURN  ;BETRAG=NULL
	SET $PIECE(BUCHUNG,Y,3)=$TRANSLATE($$^WWWZAHL($PIECE(BUCHUNG,Y,3),0,2)," .")  ;BETRAG ;Sum 
	SET LIEF=$PIECE(BUCHUNG,Y,4)
	SET KUND=$PIECE(BUCHUNG,Y,4)
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)   ;STEUERID   ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID   ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO %
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" DO
	. . SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. ;
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))   ; SR15424
	. . IF $PIECE(KOND,Y,7)="" QUIT  ;FIS;24.01.05;27192;KEINE SKONTO INFORMATIONEN IN INLIEFK
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE  ;FIS;24.01.05;27192;SKONTO INFORMATIONEN AUS INKOND
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))          ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))    ; SR15424
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOS,1),""))'=""  SET KONTOA=7
	SET SACH=""
	IF $LENGTH($PIECE(BUCHUNG,Y,4))>5 SET SACH="S"
	;HABEN BUCHUNG ;have got 
	SET KONTOH=$PIECE(BUCHUNG,Y,5)  ;KONTO HABEN ;acct. have got 
	SET LIEF=$PIECE(BUCHUNG,Y,5)
	SET KUND=$PIECE(BUCHUNG,Y,5)
	SET IDNR=""
	IF $DATA(^INLIEF(YM,LIEF,1))  SET IDNR=$PIECE(^INLIEF(YM,LIEF,1),Y,50)   ;STEUERID   ; SR15424
	IF $DATA(^INKUNDE(YM,KUND,1)) SET IDNR=$PIECE(^INKUNDE(YM,KUND,1),Y,50)  ;STEUERID   ; SR15424
	DO   ;ZAHLUNGSKONDITIONEN?
	. QUIT:$PIECE(BUCHUNG,Y,13)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,14)'=""  ;SKONTO TAGE
	. QUIT:$PIECE(BUCHUNG,Y,15)'=""  ;SKONTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR="" DO
	. . SET WAGR=$ORDER(^INLIEFK(YM,LIEF,""))
	. . QUIT
	. ;
	. IF WAGR'="" IF $DATA(^INLIEFK(YM,LIEF,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INLIEFK(YM,LIEF,WAGR,1))                          ; SR15424
	. . IF $PIECE(KOND,Y,7)="" QUIT  ;FIS;24.01.05;27192;KEINE SKONTO INFORMATIONEN IN INLIEFK
	. . IF $PIECE(KOND,Y,7)'="" DO
	. . . SET $PIECE(KOND,Y,13)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,2)  ;SKONTO TAGE
	. . . SET $PIECE(KOND,Y,12)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,3)  ;SKONTO%
	. . . SET $PIECE(KOND,Y,14)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,7),1)),Y,4)  ;NETTO TAGE
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,13)  ;SKONTO TAGE  ;FIS;24.01.05;27192;SKONTO INFORMATIONEN AUS INKOND
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,12)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,14)  ;NETTO TAGE
	. ;
	. IF KUND'="" IF $DATA(^INKUNDE(YM,KUND,1)) DO 
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDE(YM,KUND,1))          ; SR15424
	. . IF $PIECE(KOND,Y,56)'="" DO
	. . . SET $PIECE(KOND,Y,75)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,2)
	. . . SET $PIECE(KOND,Y,74)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,3)
	. . . SET $PIECE(KOND,Y,76)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,56),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,75)  ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,74)  ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,76)  ;NETTO TAGE
	. ;
	. SET WAGR=$PIECE(BUCHUNG,Y,17)
	. IF WAGR'="" IF $DATA(^INKUNDEK(YM,KUND,WAGR,1)) DO
	. . NEW KOND
	. . SET KOND=$GET(^INKUNDEK(YM,KUND,WAGR,1))   ; SR15424
	. . IF $PIECE(KOND,Y,1)="" QUIT  ;FIS;24.01.05;27192;KEINE SKONTO INFORMATIONEN IN INKUNDEK
	. . IF $PIECE(KOND,Y,1)'="" DO
	. . . SET $PIECE(KOND,Y,9) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,2)
	. . . SET $PIECE(KOND,Y,7) =$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,3)
	. . . SET $PIECE(KOND,Y,10)=$PIECE($GET(^INKOND(YM,$PIECE(KOND,Y,1),1)),Y,4)
	. . ;
	. . SET $PIECE(BUCHUNG,Y,13)=$PIECE(KOND,Y,9)   ;SKONTO TAGE
	. . SET $PIECE(BUCHUNG,Y,14)=$PIECE(KOND,Y,7)   ;SKONTO%
	. . SET $PIECE(BUCHUNG,Y,15)=$PIECE(KOND,Y,10)  ;NETTO TAGE
	
	SET KONTOA=1  ;KONTOART
	IF $ORDER(^INKUNDEs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'="" SET KONTOA=6
	IF $ORDER(^INLIEFs(YM,4,$$^WWWUMLAU(KONTOH,1),""))'=""  SET KONTOA=7
	;SET SACH=""
	IF $LENGTH($PIECE(BUCHUNG,Y,5))>5 SET SACH="H"
	SET SAT2=""
	SET $PIECE(SAT2,Y,21)=""
	SET $PIECE(SAT2,Y,1)="BCH"
	SET $PIECE(SAT2,Y,2)=$PIECE(BUCHUNG,Y,3)
	;IF +$PIECE(BUCHUNG,Y,13)'=0 SET $PIECE(SAT2,Y,13)=$JUSTIFY($PIECE(SAT2,Y,2)/100*$PIECE(BUCHUNG,Y,13),0,2)  ;SKONTOBETRAG:TYBD
	IF +$PIECE(BUCHUNG,Y,14)'=0 SET $PIECE(SAT2,Y,13)=$JUSTIFY($PIECE(SAT2,Y,2)/100*$PIECE(BUCHUNG,Y,14),0,2)  ;SKONTOBETRAG:TYBD  ;FIS;% STATT TAGE ;24.01.05;27192
	SET $PIECE(SAT2,Y,5) =$PIECE(BUCHUNG,Y,5)
	SET $PIECE(SAT2,Y,10)=$PIECE(BUCHUNG,Y,4)
	IF $PIECE($GET(YFPARA),Y,42)'=1 DO  ;NICHT WENN AUTOMATIK KONTEN (ZUORDNUNG DES STEUERSATZES IN DER FIBU);FIS;26705;20.12.04 
	. SET $PIECE(SAT2,Y,4)=$PIECE(BUCHUNG,Y,6)
	;. IF $PIECE(BUCHUNG,Y,6)=1  SET $PIECE(SAT2,Y,4)=19  ;16% UST  ;MAPPING STEUERKENNZEICHEN
	;. IF $PIECE(BUCHUNG,Y,6)=2  SET $PIECE(SAT2,Y,4)=12  ;7% UST
	;. IF $PIECE(BUCHUNG,Y,6)=11 SET $PIECE(SAT2,Y,4)=3  ;16% VST
	;. IF $PIECE(BUCHUNG,Y,6)=12 SET $PIECE(SAT2,Y,4)=8  ;7% VST
	
	;SET $PIECE(SAT2,Y,6)=$TRANSLATE($PIECE(BUCHUNG,Y,23),"abcdefghijklmnopqrstuvwxyzüäöABCDEFGIJKLMNOPQRSTUVWXYZßÜÄÖ!§$%&/()=@\´`+#*'~,.-;:_<>^°")  ;TYBD
	;IF $PIECE(SAT2,Y,6)="" SET $PIECE(SAT2,Y,6)=$TRANSLATE($PIECE(BUCHUNG,Y,7),"abcdefghijklmnopqrstuvwxyzüäöABCDEFGIJKLMNOPQRSTUVWXYZßÜÄÖ!§$%&/()=@\´`+#*'~,.-;:_<>^°")  ;TYBD
	SET $PIECE(SAT2,Y,6)=$TRANSLATE($PIECE(BUCHUNG,Y,7),"!§$%&/()=@\´`+#*'~,.-;:_<>^°")  ;original belegnummer  ;FIS;24.01.05;27214
	;set $piece(SAT2,Y,6)=$EXTRACT($PIECE(SAT2,Y,6),1,8)  ;NUR 8 STELLEN
	SET $PIECE(SAT2,Y,7)=$PIECE(BUCHUNG,Y,13)  ;skonto tage
	;IF +$PIECE(YFPARA,Y,2)=1 IF $PIECE(BUCHUNG,Y,34)'="" SET $PIECE(SAT2,Y,7)=$PIECE(BUCHUNG,Y,34)  ;kennzeichen zahlungskonditionen  ;FIS;25.01.2005
	IF +$PIECE(YFPARA,Y,2)=1 SET $PIECE(SAT2,Y,7)=$PIECE(BUCHUNG,Y,34)  ;kennzeichen zahlungskonditionen  ;FIS;25.01.2005
	IF $PIECE(BUCHUNG,Y,55)="" SET $PIECE(BUCHUNG,Y,55)=$PIECE(BUCHUNG,Y,2)  ;TYBD;16.1.2005
	SET $PIECE(SAT2,Y,9)=$TRANSLATE($$^WWWDATE($PIECE(BUCHUNG,Y,55)),".,/-")  ;VALUTADATUM;TYBD;16.1.2005
	SET $PIECE(SAT2,Y,11)=$PIECE(BUCHUNG,Y,12)
	SET $PIECE(SAT2,Y,14)=$PIECE(BUCHUNG,Y,8)
	IF $FIND($PIECE(SAT2,Y,14),"ER ")!($FIND($PIECE(SAT2,Y,14),"GU ")) DO  ;FIS;24.01.05;27214
	. IF $PIECE(BUCHUNG,Y,23)="" SET $PIECE(BUCHUNG,Y,23)=$PIECE(BUCHUNG,Y,7)
	. IF $FIND($PIECE(SAT2,Y,14),"ER ") SET $PIECE(SAT2,Y,14)="RG "_$TRANSLATE($PIECE(BUCHUNG,Y,23),"!§$%&/()=@\´`+#*'~,.-;:_<>^°")  ;RG NUMMER KREDITOR
	. IF $FIND($PIECE(SAT2,Y,14),"GU ") SET $PIECE(SAT2,Y,14)="GU "_$TRANSLATE($PIECE(BUCHUNG,Y,23),"!§$%&/()=@\´`+#*'~,.-;:_<>^°")  ;GU NUMMER KREDITOR
	
	IF $PIECE(BUCHUNG,Y,7)'="" IF $PIECE(BUCHUNG,Y,23)'="" SET $PIECE(SAT2,Y,14)=$EXTRACT($PIECE(SAT2,Y,14)_" "_$PIECE(BUCHUNG,Y,7),1,45)  ;TYBD
	SET $PIECE(SAT2,Y,15)=YWHR
	SET $PIECE(SAT2,Y,15)="EUR"   ;TYBD;15.1.2005
	;SET $PIECE(SAT2,Y,19)=IDNR
	SET $PIECE(SAT2,Y,19)=$TRANSLATE(IDNR," ")  ;FIS;27471;14.03.05
	SET $PIECE(SAT2,Y,8)=$TRANSLATE($$^WWWDATE($PIECE(BUCHUNG,Y,2)),".,/-") ;,Y,2) WAR ,Y,1);TYBD
	SET NUM=$$^WWWNEXT("INFIBEXPO")
	SET ^INFIBEXPO(YM,NUM,1)=$$^INFIBGF($TRANSLATE(SAT2,Y,YH))  ;MANDANTENKENNUNG
	
	IF $PIECE(YFPARA,Y,46)=1 IF $PIECE(BUCHUNG,Y,48)'="" DO
	. DO ^WWWSKILL("INFIBBUCHPROT",$PIECE(BUCHUNG,Y,48),1)
	. SET $PIECE(^INFIBBUCHPROT(YM,$PIECE(BUCHUNG,Y,48),1),Y,5)=NUM  ;EXPORTNUMMER SPEICHERN;FIS;27471;14.03.05
	. DO ^WWWSSORT("INFIBBUCHPROT",$PIECE(BUCHUNG,Y,48))
	
	QUIT 1
]]></Routine>
</Export>