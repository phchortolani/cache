<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="Cache" ts="2001-01-01 00:00:00">
<Class name="VAR.CSP.PreparacaoTISS">
<ClassType/>
<IncludeCode>MEDConst,VARConst,INConst,WWWConst,FATConst</IncludeCode>
<ProcedureBlock>0</ProcedureBlock>
<Super>%CSP.Page</Super>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	$$$VAR
	Set method = $get(%request.Data("method",1))
	Xecute "do .."_method_"()"
	Return $$$OK]]></Implementation>
</Method>

<Method name="Preparacao">
<ClassMethod>1</ClassMethod>
<FormalSpec>pCodAgendamento="",pNumAdmissaoControle="",pCodPlanodeSaude="",pYBED=""</FormalSpec>
<Implementation><![CDATA[	#Dim objRegraComerCompont As VAR.util.FATRegrasComerciais;

	$$$VAR
	Set YM = 0 
	Set Y  = "~"
	
	If (pCodAgendamento = "") {
		Set YBED					= $Get(%request.Data("YBED",1))
		Set pCodAgendamento			= $Get(%request.Data("pCodAgendamento",1))
		Set pNumAdmissaoControle	= $Get(%request.Data("pNumAdmissaoControle",1))
		Set pCodPlanodeSaude			= $Get(%request.Data("pCodPlanodeSaude",1))
	}Else{
		Set YBED = pYBED
	}

	Kill tempPreparacaoSPSADT
	Kill tempPreparacaoAneOutDesp
		
	Set objVARAgendamentoAdmissao = $Get(^VARAgendamentoAdmissao(YM, pNumAdmissaoControle, 1))

	If (pCodAgendamento = "") {
		Set pCodAgendamento = $$$VARAgendamentoAdmissaoNumerodoAgendamento(objVARAgendamentoAdmissao)
	}	

	Set objVARAgendamento 	= $Get(^VARAgendamento(YM, pCodAgendamento, 1))
	Set codPaciente					= $$$VARAgendamentoCodigodoPaciente(objVARAgendamento) 
	Set ageCodPlanodeSaude	= $$$VARAgendamentoPlanodeSaude(objVARAgendamento) 
	Set ageCarteirinha			=	$$$VARAgendamentoCarteirinha(objVARAgendamento)
	Set ageDtVencCarte			= $$$VARAgendamentoVencimentodaCarteirinha(objVARAgendamento)
	Set dtCriadoEm					= +$$$VARAgendamentoCriadoEm(objVARAgendamento)
	
	Kill ^VARGuiaConsulta(YM, YBED)
	Kill ^VARGuiaSPSADT(YM, YBED)
	Kill ^VARGuiaAnexoOutrasDespesas(YM, YBED)
	Kill ^VARGuiaAnexoOutrasDespesasChec(YM, YBED)
	
	Set meuSQL 	= "Select * From SQLUser.VARAgendamentoProcedimentos "
	Set meuSQL 	= meuSQL _ "Where Company = 0 And CodigodoAgendamento = '"_pCodAgendamento_"' "
	Set meuSQL 	= meuSQL _ "And ControleAdmissao = '"_pNumAdmissaoControle_"' "
	Set rSet 		= ##Class(%SQL.Statement).%ExecDirect("",meuSQL)
	While rSet.%Next() {
		
		Set procCodigo					= rSet.%Get("Procedimento")
		Set procCodPlanodeSaude = rSet.%Get("PlanodeSaude")
		Set procCarteirinha			=	rSet.%Get("NumdaCarteirinha")
		Set procDtVencCarte			= rSet.%Get("VencimentodaCarteirinha")
		Set procNumGuia 				= rSet.%Get("Guia")
		Set codProfissional			= rSet.%Get("Profissional")
		Set codProfSolicitante	= rSet.%Get("Solicitante")
		Set dtHrAdmisao					= rSet.%Get("DataHoraAdmissao")
		Set qtdeSolicitada			= +rSet.%Get("QtdeProcedimento")
		Set codSala							= rSet.%Get("CodigodaSala")	
		Set horadeAtendimento		= rSet.%Get("HoraAtendimento")
		Set datadeAtendimento		= rSet.%Get("DataAtendimento")
		Set seqProcedimento			= rSet.%Get("Sequencia")
		Set contAdmissao				= rSet.%Get("ControleAdmissao")
		
		;
		If ($$$VARAgendamentoAdmissaoCriadoData(objVARAgendamentoAdmissao) '= "") {
			Set dtHrAdmisao		= $$$VARAgendamentoAdmissaoCriadoData(objVARAgendamentoAdmissao)_","_$$$VARAgendamentoAdmissaoCriadoHora(objVARAgendamentoAdmissao)
		}
		;
		
		If (procCodPlanodeSaude = "") Set procCodPlanodeSaude = ageCodPlanodeSaude
		If (procCarteirinha = "") 		Set procDtVencCarte			= ageCarteirinha
		If (procDtVencCarte = "") 		Set procDtVencCarte 		= ageDtVencCarte
		
		If (qtdeSolicitada = 0) Set qtdeSolicitada = 1
				
		If (pCodPlanodeSaude '= "" && (pCodPlanodeSaude '= procCodPlanodeSaude)) Continue 
	
		Set ^VARGuiaAnexoOutrasDespesasChec(YM, YBED) = pCodAgendamento_"|"_pNumAdmissaoControle_"|"_procCodPlanodeSaude
		
		Set objRegraComercial = ##Class(VAR.util.FATRegrasComerciais).%New(procCodigo, procCodPlanodeSaude, pCodAgendamento, seqProcedimento)
		If ('$IsObject(objRegraComercial)) Continue
		
		Set qtdeSolicitada = qtdeSolicitada * objRegraComercial.Quantidade
		
		If (objRegraComercial.VersaoDaTISS = "" || (objRegraComercial.CategoriaTISS = "")) Continue

		Set codUnidade = ""
		If (codProfissional '= "") {
			Set objMEDProviderAgendaHorario = ""
			If (codProfissional '= "" && (horadeAtendimento '= "") && (datadeAtendimento '= "")) {
				Set objMEDProviderAgendaHorario = $Get(^MEDProviderAgendaHorario(YM, codProfissional, datadeAtendimento, horadeAtendimento, 1))
			}
			Set referenciaPai = $$$MEDProviderAgendaHorarioReferenciaPai(objMEDProviderAgendaHorario)
			Set objMEDProviderAgenda = ""
			If (referenciaPai '= "") {
				Set objMEDProviderAgenda = $Get(^MEDProviderAgenda(YM, codProfissional, referenciaPai, 1))
			}
			Set codUnidade	= $$$MEDProviderAgendaUnidade(objMEDProviderAgenda)
		}ElseIf (codSala '= ""){
			Set objVARSalasAtendimentos = $Get(^VARSalasAtendimentos(0, codSala, 1))
			Set codUnidade	= $$$VARSalasAtendimentosUnidade(objVARSalasAtendimentos)
		}Else{
			Set codUnidade = 1
		}
		Set objWWW0121 = $Get(^WWW0121(0,0,codUnidade,1))
		Set codOrganizacao = $$$WWW0121Organizacao(objWWW0121)

		If (codOrganizacao = "") continue

		Do objRegraComercial.recDadosExecutante(codOrganizacao)
		
		Set (dtAutorizacao, senha, dtValidadeSenha, numGuiaOperadora) = ""
		If (procNumGuia = "") {
			Set procNumGuia = "null"
		}Else{
			Set objVARAgendamentoGuia = $Get(^VARAgendamentoGuia(YM, pCodAgendamento, procNumGuia, 1))
			Set dtAutorizacao 		= $$$VARAgendamentoGuiaDataAutorizacao(objVARAgendamentoGuia)
			Set senha 						= $$$VARAgendamentoGuiaSenha(objVARAgendamentoGuia)
			Set dtValidadeSenha 	= $$$VARAgendamentoGuiaDatadeValidadeSenha(objVARAgendamentoGuia)
			Set numGuiaOperadora 	= $$$VARAgendamentoGuiaNumerodaGuiaAtribuidapela(objVARAgendamentoGuia)
		}
		
		If (objRegraComercial.CategoriaTISS '= "CONSULTA" && (objRegraComercial.CategoriaTISS '= "PROCEDIMENTOS") && (objRegraComercial.CategoriaTISS '= "MEDICAMENTOS") ) Continue
		
		If (objRegraComercial.CategoriaTISS = "MEDICAMENTOS"){
			If ($Data(tempPreparacaoAneOutDesp("PROCEDIMENTOS", objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComercial.Procedimento))) {
				Set objeto = tempPreparacaoAneOutDesp("PROCEDIMENTOS", objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComercial.Procedimento)
				Set $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) + objRegraComercial.Quantidade ;* qtdeSolicitada)
				Set $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) + (objRegraComercial.ValorUnitario * objRegraComercial.Quantidade) ;* qtdeSolicitada))
				If (objRegraComercial.CategoriaTISS = "MEDICAMENTOS") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) +(objRegraComercial.Valor) ;*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				Continue
			}
			Set objVARGuiaAnexoOutrasDespesas = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CodigoANS
			Set $$$VARGuiaAnexoOutrasDespesasCampo2(objVARGuiaAnexoOutrasDespesas) = pNumAdmissaoControle
			Set $$$VARGuiaAnexoOutrasDespesasCampo3(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CodigoExecutante
			Set $$$VARGuiaAnexoOutrasDespesasCampo4(objVARGuiaAnexoOutrasDespesas) = $ZConvert(objRegraComercial.NomeExecutante,"U")
			Set $$$VARGuiaAnexoOutrasDespesasCampo5(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CNESExecutante
			Set $$$VARGuiaAnexoOutrasDespesasCampo6Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo7Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo8Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo9Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo10Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.FamiliaTISS
			Set $$$VARGuiaAnexoOutrasDespesasCampo11Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CodigodoItem
			Set $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.Quantidade ;* qtdeSolicitada)
			Set $$$VARGuiaAnexoOutrasDespesasCampo13Linha1(objVARGuiaAnexoOutrasDespesas) = $ZConvert($$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSUNIDADEMEDICA~"_$Replace(objRegraComercial.UnidadeMedida," ","")),"U")
			Set $$$VARGuiaAnexoOutrasDespesasCampo14Linha1(objVARGuiaAnexoOutrasDespesas) = "1"
			Set $$$VARGuiaAnexoOutrasDespesasCampo15Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.ValorUnitario
			Set $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.ValorUnitario * objRegraComercial.Quantidade ;* qtdeSolicitada)
			Set $$$VARGuiaAnexoOutrasDespesasCampo17Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo18Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo19Linha1(objVARGuiaAnexoOutrasDespesas) = ""
			Set $$$VARGuiaAnexoOutrasDespesasCampo20Linha1(objVARGuiaAnexoOutrasDespesas) = $ZConvert(objRegraComercial.DescricaoDoItem,"U")
			If (objRegraComercial.CategoriaTISS = "MEDICAMENTOS") {
				Set $$$VARGuiaAnexoOutrasDespesasCampo22(objVARGuiaAnexoOutrasDespesas) = (objRegraComercial.Valor) ;*(qtdeSolicitada*objRegraComercial.Quantidade))
			}
			Set tempPreparacaoAneOutDesp("PROCEDIMENTOS", objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComercial.Procedimento) = objVARGuiaAnexoOutrasDespesas
			Continue
		}
		If (objRegraComercial.CategoriaTISS = "PROCEDIMENTOS"){
			;Soma a qtde de Atendimento
			If (objRegraComercial.CodigodoItem '= "") Set procCodigo = objRegraComercial.CodigodoItem 
			Set procDescricao = objRegraComercial.DescricaoDoItem
			If ($Data(tempPreparacaoSPSADT(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, procCodigo_"||"_procDescricao))) {
				Set objVARGuiaSPSADT = tempPreparacaoSPSADT(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, procCodigo_"||"_procDescricao)
				Set $$$VARGuiaSPSADTCampo27Linha1(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo27Linha1(objVARGuiaSPSADT) + qtdeSolicitada
				Set $$$VARGuiaSPSADTCampo42Linha1(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo42Linha1(objVARGuiaSPSADT) + qtdeSolicitada
				Set $$$VARGuiaSPSADTCampo47Linha1(objVARGuiaSPSADT) = ($$$VARGuiaSPSADTCampo46Linha1(objVARGuiaSPSADT)*$$$VARGuiaSPSADTCampo42Linha1(objVARGuiaSPSADT))
				Set $$$VARGuiaSPSADTCampo59(objVARGuiaSPSADT) 			= ($$$VARGuiaSPSADTCampo46Linha1(objVARGuiaSPSADT)*$$$VARGuiaSPSADTCampo42Linha1(objVARGuiaSPSADT))
				For count = 1 : 1 : objRegraComercial.Componentes.Count() {
					Set objRegraComerCompont = objRegraComercial.Componentes.GetAt(count)
					
					If ($Data(^VARAgendamentoItensDesc(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento))) Continue 
					
					;If (objRegraComerCompont.CategoriaTISS = "PROCEDIMENTOS") {
					
					
					If ($Data(^VARAgendamentoItensQtdeAlterada(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento))){
						Set qtdeAlterada = $Piece(^VARAgendamentoItensQtdeAlterada(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento,1),"~",1)
						Set qtdeSolicitada = qtdeSolicitada * qtdeAlterada	
					} 
				
					If (+objRegraComerCompont.Valor <= 0 || (+objRegraComerCompont.Quantidade = 0)) Continue
				
					If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
						Set $$$VARGuiaSPSADTCampo60(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo60(objVARGuiaSPSADT) + (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
						Set $$$VARGuiaSPSADTCampo61(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo61(objVARGuiaSPSADT) + (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "OPME") {
						Set $$$VARGuiaSPSADTCampo62(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo62(objVARGuiaSPSADT) + (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
						Set $$$VARGuiaSPSADTCampo63(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo63(objVARGuiaSPSADT) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComercial.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "GASES") {
						Set $$$VARGuiaSPSADTCampo64(objVARGuiaSPSADT) = $$$VARGuiaSPSADTCampo64(objVARGuiaSPSADT) + (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
					}
					If ($Data(tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento))) {
						Set objeto = tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento)
						Set $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) + objRegraComerCompont.Quantidade ;* qtdeSolicitada)
						Set $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) + (objRegraComerCompont.ValorUnitario * objRegraComerCompont.Quantidade) ;* qtdeSolicitada))
						If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						If (objRegraComerCompont.CategoriaTISS = "OPME") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						If (objRegraComerCompont.CategoriaTISS = "GASES") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						If (objRegraComerCompont.CategoriaTISS = "DIARIAS") {
							Set $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) + (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComerCompont.Quantidade))
						}
						Set tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento) = objeto
						Continue
					}
				}
				Set tempPreparacaoSPSADT(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, procCodigo_"||"_procDescricao) = objVARGuiaSPSADT
				Continue
			}
			;		
			Set objProfSolicitante = $Get(^MEDProvider(YM, codProfSolicitante, 1)) 
			;
			Set objVARGuiaSPSADT = ""
			Set $$$VARGuiaSPSADTCampo1(objVARGuiaSPSADT) = objRegraComercial.CodigoANS
			Set $$$VARGuiaSPSADTCampo2(objVARGuiaSPSADT) = pNumAdmissaoControle
			Set $$$VARGuiaSPSADTCampo3(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo4(objVARGuiaSPSADT) = $Select(dtAutorizacao="":"",1:$ZDate(dtAutorizacao,4))
			Set $$$VARGuiaSPSADTCampo5(objVARGuiaSPSADT) = senha
			Set $$$VARGuiaSPSADTCampo6(objVARGuiaSPSADT) = $Select(dtValidadeSenha="":"",1:$ZDate(dtValidadeSenha,4))
			Set $$$VARGuiaSPSADTCampo7(objVARGuiaSPSADT) = numGuiaOperadora
			Set $$$VARGuiaSPSADTCampo8(objVARGuiaSPSADT) = procCarteirinha
			Set $$$VARGuiaSPSADTCampo9(objVARGuiaSPSADT) = $Select(procDtVencCarte="":"",1:$ZDate(procDtVencCarte,4,,,,,,,""))
			Set $$$VARGuiaSPSADTCampo10(objVARGuiaSPSADT) = $ZConvert($$SQLGetPatientName^VARSQL(codPaciente),"U")
			Set $$$VARGuiaSPSADTCampo11(objVARGuiaSPSADT) = $ZConvert($$SQLGetPatientCNS^VARSQL(codPaciente),"U")
			Set $$$VARGuiaSPSADTCampo12(objVARGuiaSPSADT) = "Não"
			Set $$$VARGuiaSPSADTCampo13(objVARGuiaSPSADT) = objRegraComercial.CodigoExecutante
			Set $$$VARGuiaSPSADTCampo14(objVARGuiaSPSADT) = $ZConvert(objRegraComercial.NomeExecutante,"U")
			Set $$$VARGuiaSPSADTCampo15(objVARGuiaSPSADT) = $ZConvert($$$MEDProviderName(objProfSolicitante),"U")
			Set $$$VARGuiaSPSADTCampo16(objVARGuiaSPSADT) = $ZConvert($$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$]]><![CDATA[$$MEDProviderFREE2(objProfSolicitante)),"U")
			Set $$$VARGuiaSPSADTCampo17(objVARGuiaSPSADT) = $$$MEDProviderLicenseNumber(objProfSolicitante)
			Set $$$VARGuiaSPSADTCampo18(objVARGuiaSPSADT) = $ZConvert($$$MEDProviderFREE3(objProfSolicitante),"U")
			Set $$$VARGuiaSPSADTCampo19(objVARGuiaSPSADT) = $Select($$$MEDProviderCBO(objProfSolicitante)="":225185,1:$$$MEDProviderCBO(objProfSolicitante))
			Set $$$VARGuiaSPSADTCampo20(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo21(objVARGuiaSPSADT) = "E"
			Set $$$VARGuiaSPSADTCampo22(objVARGuiaSPSADT) = $ZDate(dtCriadoEm,4)
			Set $$$VARGuiaSPSADTCampo23(objVARGuiaSPSADT) = ""
			;
			Set $$$VARGuiaSPSADTCampo24Linha1(objVARGuiaSPSADT) = objRegraComercial.FamiliaTISS
			Set $$$VARGuiaSPSADTCampo25Linha1(objVARGuiaSPSADT) = objRegraComercial.CodigodoItem
			Set $$$VARGuiaSPSADTCampo26Linha1(objVARGuiaSPSADT) = objRegraComercial.DescricaoDoItem
			Set $$$VARGuiaSPSADTCampo27Linha1(objVARGuiaSPSADT) = qtdeSolicitada
			Set $$$VARGuiaSPSADTCampo28Linha1(objVARGuiaSPSADT) = ""
			;
			Set $$$VARGuiaSPSADTCampo29(objVARGuiaSPSADT) = objRegraComercial.CodigoExecutante
			Set $$$VARGuiaSPSADTCampo30(objVARGuiaSPSADT) = $ZConvert(objRegraComercial.NomeExecutante,"U")
			Set $$$VARGuiaSPSADTCampo31(objVARGuiaSPSADT) = objRegraComercial.CNESExecutante
			Set $$$VARGuiaSPSADTCampo32(objVARGuiaSPSADT) = objRegraComercial.TipoDeAtendimento
			Set $$$VARGuiaSPSADTCampo33(objVARGuiaSPSADT) = "9"
			Set $$$VARGuiaSPSADTCampo34(objVARGuiaSPSADT) = "1"
			Set $$$VARGuiaSPSADTCampo35(objVARGuiaSPSADT) = ""
			;
			Set $$$VARGuiaSPSADTCampo36Linha1(objVARGuiaSPSADT) = $ZDate(+dtHrAdmisao,4)
			Set $$$VARGuiaSPSADTCampo37Linha1(objVARGuiaSPSADT) = $ZTime($Piece(dtHrAdmisao,",",2),1)
			Set $$$VARGuiaSPSADTCampo38Linha1(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo39Linha1(objVARGuiaSPSADT) = objRegraComercial.FamiliaTISS
			Set $$$VARGuiaSPSADTCampo40Linha1(objVARGuiaSPSADT) = objRegraComercial.CodigodoItem
			Set $$$VARGuiaSPSADTCampo41Linha1(objVARGuiaSPSADT) = $ZConvert(objRegraComercial.DescricaoDoItem,"U")
			Set $$$VARGuiaSPSADTCampo42Linha1(objVARGuiaSPSADT) = qtdeSolicitada
			Set $$$VARGuiaSPSADTCampo43Linha1(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo44Linha1(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo45Linha1(objVARGuiaSPSADT) = "1"
			Set $$$VARGuiaSPSADTCampo46Linha1(objVARGuiaSPSADT) = objRegraComercial.ValorUnitario
			Set $$$VARGuiaSPSADTCampo47Linha1(objVARGuiaSPSADT) = (objRegraComercial.ValorUnitario*qtdeSolicitada)
			;
			Set objProfissional = ""
			Set:codProfissional'="" objProfissional = $Get(^MEDProvider(YM, codProfissional, 1)) 
						
			Set $$$VARGuiaSPSADTCampo48Linha1(objVARGuiaSPSADT) = ""
			Set $$$VARGuiaSPSADTCampo49Linha1(objVARGuiaSPSADT) = 12
			Set $$$VARGuiaSPSADTCampo50Linha1(objVARGuiaSPSADT) = $$$MEDProviderProviderNo(objProfissional)
			Set $$$VARGuiaSPSADTCampo51Linha1(objVARGuiaSPSADT) = $ZConvert($$$MEDProviderName(objProfissional),"U")
			Set $$$VARGuiaSPSADTCampo52Linha1(objVARGuiaSPSADT) = $ZConvert($$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfissional)),"U")
			Set $$$VARGuiaSPSADTCampo53Linha1(objVARGuiaSPSADT) = $$$MEDProviderLicenseNumber(objProfissional)
			Set $$$VARGuiaSPSADTCampo54Linha1(objVARGuiaSPSADT) = $ZConvert($$$MEDProviderFREE3(objProfissional),"U")
			Set $$$VARGuiaSPSADTCampo55Linha1(objVARGuiaSPSADT) = $Select($$$MEDProviderCBO(objProfissional)="":225185,1:$$$MEDProviderCBO(objProfissional))
			;
			Set $$$VARGuiaSPSADTCampo56Linha1(objVARGuiaSPSADT) = $ZDate(+dtHrAdmisao,4)
			;
			Set $$$VARGuiaSPSADTCampo59(objVARGuiaSPSADT) 			= (objRegraComercial.ValorUnitario*qtdeSolicitada)
			Set $$$VARGuiaSPSADTCampo60(objVARGuiaSPSADT) 			= 0
			Set $$$VARGuiaSPSADTCampo61(objVARGuiaSPSADT) 			= 0
			Set $$$VARGuiaSPSADTCampo62(objVARGuiaSPSADT) 			= 0
			Set $$$VARGuiaSPSADTCampo63(objVARGuiaSPSADT) 			= 0
			Set $$$VARGuiaSPSADTCampo64(objVARGuiaSPSADT) 			= 0
			;
			For count = 1 : 1 : objRegraComercial.Componentes.Count() {
				Set objRegraComerCompont = objRegraComercial.Componentes.GetAt(count)
				If (objRegraComerCompont.isInelegivel = 1) Continue
				Set objVARGuiaAnexoOutrasDespesas = ""
				
				
				If ($Data(^VARAgendamentoItensDesc(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento))) Continue 
				If ($Data(^VARAgendamentoItensQtdeAlterada(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento))){
					Set qtdeAlterada = $Piece(^VARAgendamentoItensQtdeAlterada(YM,pCodAgendamento,seqProcedimento,objRegraComerCompont.Procedimento,1),"~",1)
					Set qtdeSolicitada = qtdeSolicitada * qtdeAlterada	
				} 
				
				If (+objRegraComerCompont.Valor <= 0 || (+objRegraComerCompont.Quantidade = 0)) Continue
	
				If (objRegraComerCompont.CategoriaTISS = "PROCEDIMENTOS") {
					Set xObjVARGuiaSPSADT = ""
					Set $$$VARGuiaSPSADTCampo1(xObjVARGuiaSPSADT) = objRegraComerCompont.CodigoANS
					Set $$$VARGuiaSPSADTCampo2(xObjVARGuiaSPSADT) = pNumAdmissaoControle
					Set $$$VARGuiaSPSADTCampo3(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo4(xObjVARGuiaSPSADT) = $Select(dtAutorizacao="":"",1:$ZDate(dtAutorizacao,4))
					Set $$$VARGuiaSPSADTCampo5(xObjVARGuiaSPSADT) = senha
					Set $$$VARGuiaSPSADTCampo6(xObjVARGuiaSPSADT) = $Select(dtValidadeSenha="":"",1:$ZDate(dtValidadeSenha,4))
					Set $$$VARGuiaSPSADTCampo7(xObjVARGuiaSPSADT) = numGuiaOperadora
					Set $$$VARGuiaSPSADTCampo8(xObjVARGuiaSPSADT) = procCarteirinha
					Set $$$VARGuiaSPSADTCampo9(xObjVARGuiaSPSADT) = $Select(procDtVencCarte="":"",1:$ZDate(procDtVencCarte,4,,,,,,,""))
					Set $$$VARGuiaSPSADTCampo10(xObjVARGuiaSPSADT) = $ZConvert($$SQLGetPatientName^VARSQL(codPaciente),"U")
					Set $$$VARGuiaSPSADTCampo11(xObjVARGuiaSPSADT) = $ZConvert($$SQLGetPatientCNS^VARSQL(codPaciente),"U")
					Set $$$VARGuiaSPSADTCampo12(xObjVARGuiaSPSADT) = "Não"
					Set $$$VARGuiaSPSADTCampo13(xObjVARGuiaSPSADT) = objRegraComercial.CodigoExecutante
					Set $$$VARGuiaSPSADTCampo14(xObjVARGuiaSPSADT) = $ZConvert(objRegraComercial.NomeExecutante,"U")
					Set $$$VARGuiaSPSADTCampo15(xObjVARGuiaSPSADT) = $ZConvert($$$MEDProviderName(objProfSolicitante),"U")
					Set $$$VARGuiaSPSADTCampo16(xObjVARGuiaSPSADT) = $ZConvert($$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfSolicitante)),"U")
					Set $$$VARGuiaSPSADTCampo17(xObjVARGuiaSPSADT) = $$$MEDProviderLicenseNumber(objProfSolicitante)
					Set $$$VARGuiaSPSADTCampo18(xObjVARGuiaSPSADT) = $ZConvert($$$MEDProviderFREE3(objProfSolicitante),"U")
					Set $$$VARGuiaSPSADTCampo19(xObjVARGuiaSPSADT) = $Select($$$MEDProviderCBO(objProfSolicitante)="":225185,1:$$$MEDProviderCBO(objProfSolicitante))
					Set $$$VARGuiaSPSADTCampo20(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo21(xObjVARGuiaSPSADT) = "E"
					Set $$$VARGuiaSPSADTCampo22(xObjVARGuiaSPSADT) = $ZDate(dtCriadoEm,4)
					Set $$$VARGuiaSPSADTCampo23(xObjVARGuiaSPSADT) = ""
					;
					Set $$$VARGuiaSPSADTCampo24Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.FamiliaTISS
					Set $$$VARGuiaSPSADTCampo25Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.CodigodoItem
					Set $$$VARGuiaSPSADTCampo26Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.DescricaoDoItem
					Set $$$VARGuiaSPSADTCampo27Linha1(xObjVARGuiaSPSADT) = qtdeSolicitada
					Set $$$VARGuiaSPSADTCampo28Linha1(xObjVARGuiaSPSADT) = ""
					;
					Set $$$VARGuiaSPSADTCampo29(xObjVARGuiaSPSADT) = objRegraComercial.CodigoExecutante
					Set $$$VARGuiaSPSADTCampo30(xObjVARGuiaSPSADT) = $ZConvert(objRegraComercial.NomeExecutante,"U")
					Set $$$VARGuiaSPSADTCampo31(xObjVARGuiaSPSADT) = objRegraComercial.CNESExecutante
					Set $$$VARGuiaSPSADTCampo32(xObjVARGuiaSPSADT) = objRegraComercial.TipoDeAtendimento
					Set $$$VARGuiaSPSADTCampo33(xObjVARGuiaSPSADT) = "9"
					Set $$$VARGuiaSPSADTCampo34(xObjVARGuiaSPSADT) = "1"
					Set $$$VARGuiaSPSADTCampo35(xObjVARGuiaSPSADT) = ""
					;
					Set $$$VARGuiaSPSADTCampo36Linha1(xObjVARGuiaSPSADT) = $ZDate(+dtHrAdmisao,4)
					Set $$$VARGuiaSPSADTCampo37Linha1(xObjVARGuiaSPSADT) = $ZTime($Piece(dtHrAdmisao,",",2),1)
					Set $$$VARGuiaSPSADTCampo38Linha1(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo39Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.FamiliaTISS
					Set $$$VARGuiaSPSADTCampo40Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.CodigodoItem
					Set $$$VARGuiaSPSADTCampo41Linha1(xObjVARGuiaSPSADT) = $ZConvert(objRegraComerCompont.DescricaoDoItem,"U")
					Set $$$VARGuiaSPSADTCampo42Linha1(xObjVARGuiaSPSADT) = qtdeSolicitada
					Set $$$VARGuiaSPSADTCampo43Linha1(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo44Linha1(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo45Linha1(xObjVARGuiaSPSADT) = "1"
					Set $$$VARGuiaSPSADTCampo46Linha1(xObjVARGuiaSPSADT) = objRegraComerCompont.ValorUnitario
					Set $$$VARGuiaSPSADTCampo47Linha1(xObjVARGuiaSPSADT) = (objRegraComerCompont.ValorUnitario*qtdeSolicitada)
					;
					Set objProfissional = ""
					Set:codProfissional'="" objProfissional = $Get(^MEDProvider(YM, codProfissional, 1)) 
								
					Set $$$VARGuiaSPSADTCampo48Linha1(xObjVARGuiaSPSADT) = ""
					Set $$$VARGuiaSPSADTCampo49Linha1(xObjVARGuiaSPSADT) = 12
					Set $$$VARGuiaSPSADTCampo50Linha1(xObjVARGuiaSPSADT) = $$$MEDProviderProviderNo(objProfissional)
					Set $$$VARGuiaSPSADTCampo51Linha1(xObjVARGuiaSPSADT) = $ZConvert($$$MEDProviderName(objProfissional),"U")
					Set $$$VARGuiaSPSADTCampo52Linha1(xObjVARGuiaSPSADT) = $ZConvert($$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfissional)),"U")
					Set $$$VARGuiaSPSADTCampo53Linha1(xObjVARGuiaSPSADT) = $$$MEDProviderLicenseNumber(objProfissional)
					Set $$$VARGuiaSPSADTCampo54Linha1(xObjVARGuiaSPSADT) = $ZConvert($$$MEDProviderFREE3(objProfissional),"U")
					Set $$$VARGuiaSPSADTCampo55Linha1(xObjVARGuiaSPSADT) = $Select($$$MEDProviderCBO(objProfissional)="":225185,1:$$$MEDProviderCBO(objProfissional))
					;
					Set $$$VARGuiaSPSADTCampo56Linha1(xObjVARGuiaSPSADT) = $ZDate(+dtHrAdmisao,4)
					;
					Set $$$VARGuiaSPSADTCampo59(xObjVARGuiaSPSADT) 			= (objRegraComerCompont.ValorUnitario*qtdeSolicitada)
					Set $$$VARGuiaSPSADTCampo60(xObjVARGuiaSPSADT) 			= 0
					Set $$$VARGuiaSPSADTCampo61(xObjVARGuiaSPSADT) 			= 0
					Set $$$VARGuiaSPSADTCampo62(xObjVARGuiaSPSADT) 			= 0
					Set $$$VARGuiaSPSADTCampo63(xObjVARGuiaSPSADT) 			= 0
					Set $$$VARGuiaSPSADTCampo64(xObjVARGuiaSPSADT) 			= 0
					Set tempPreparacaoSPSADT(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento) = xObjVARGuiaSPSADT
					Continue
				}
				
				If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
					Set $$$VARGuiaSPSADTCampo60(objVARGuiaSPSADT) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
					Set $$$VARGuiaSPSADTCampo61(objVARGuiaSPSADT) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "OPME") {
					Set $$$VARGuiaSPSADTCampo62(objVARGuiaSPSADT) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
					Set $$$VARGuiaSPSADTCampo63(objVARGuiaSPSADT) = (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "GASES") {
					Set $$$VARGuiaSPSADTCampo64(objVARGuiaSPSADT) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				;
				If ($Data(tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento))) {
					Set objeto = tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento)
					Set $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto) + objRegraComerCompont.Quantidade ;* qtdeSolicitada)
					Set $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto) + (objRegraComerCompont.ValorUnitario * objRegraComerCompont.Quantidade) ;* qtdeSolicitada))
					If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "OPME") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "GASES") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					If (objRegraComerCompont.CategoriaTISS = "DIARIAS") {
						Set $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) = $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) + (objRegraComerCompont.Valor) ;*(qtdeSolicitada*objRegraComerCompont.Quantidade))
					}
					Set tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento) = objeto
					Continue
				}
				Set objVARGuiaAnexoOutrasDespesas = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.CodigoANS
				Set $$$VARGuiaAnexoOutrasDespesasCampo2(objVARGuiaAnexoOutrasDespesas) = pNumAdmissaoControle
				Set $$$VARGuiaAnexoOutrasDespesasCampo3(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CodigoExecutante
				Set $$$VARGuiaAnexoOutrasDespesasCampo4(objVARGuiaAnexoOutrasDespesas) = $ZConvert(objRegraComercial.NomeExecutante,"U")
				Set $$$VARGuiaAnexoOutrasDespesasCampo5(objVARGuiaAnexoOutrasDespesas) = objRegraComercial.CNESExecutante
				Set $$$VARGuiaAnexoOutrasDespesasCampo6Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo7Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo8Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo9Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo10Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.FamiliaTISS
				Set $$$VARGuiaAnexoOutrasDespesasCampo11Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.CodigodoItem
				Set $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.Quantidade ;* qtdeSolicitada)
				Set $$$VARGuiaAnexoOutrasDespesasCampo13Linha1(objVARGuiaAnexoOutrasDespesas) = $$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSUNIDADEMEDICA~"_$Replace(objRegraComerCompont.UnidadeMedida," ",""))
				Set $$$VARGuiaAnexoOutrasDespesasCampo14Linha1(objVARGuiaAnexoOutrasDespesas) = "1"
				Set $$$VARGuiaAnexoOutrasDespesasCampo15Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.ValorUnitario
				Set $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objVARGuiaAnexoOutrasDespesas) = objRegraComerCompont.ValorUnitario * objRegraComerCompont.Quantidade ;* qtdeSolicitada)
				Set $$$VARGuiaAnexoOutrasDespesasCampo17Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo18Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo19Linha1(objVARGuiaAnexoOutrasDespesas) = ""
				Set $$$VARGuiaAnexoOutrasDespesasCampo20Linha1]]><![CDATA[(objVARGuiaAnexoOutrasDespesas) =]]><![CDATA[ $ZConvert(objRegraComerCompont.DescricaoDoItem,"U")
				If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo25(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo23(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "OPME") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo24(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;.ValorUnitario*(objRegraComerCompont.Quantidade * qtdeSolicitada))
				}
				If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo22(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;Unitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "GASES") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo21(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				If (objRegraComerCompont.CategoriaTISS = "DIARIAS") {
					Set $$$VARGuiaAnexoOutrasDespesasCampo26(objVARGuiaAnexoOutrasDespesas) = (objRegraComerCompont.Valor) ;.ValorUnitario*(qtdeSolicitada*objRegraComercial.Quantidade))
				}
				Set tempPreparacaoAneOutDesp(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, objRegraComerCompont.Procedimento) = objVARGuiaAnexoOutrasDespesas
			}
			;
			Set tempPreparacaoSPSADT(objRegraComercial.CategoriaTISS, objRegraComercial.VersaoDaTISS , procCodPlanodeSaude, procNumGuia, procCodigo_"||"_procDescricao) = objVARGuiaSPSADT
			;
			Continue
		}		
		If (objRegraComercial.CategoriaTISS = "CONSULTA" && (objRegraComercial.Valor > 0)) {
			Set objProfissional = $Get(^MEDProvider(YM, codProfissional, 1)) 
			Set objVARGuiaConsulta = ""
			Set $$$VARGuiaConsultaCampo1(objVARGuiaConsulta) = objRegraComercial.CodigoANS
			Set $$$VARGuiaConsultaCampo2(objVARGuiaConsulta) = pNumAdmissaoControle
			Set $$$VARGuiaConsultaCampo3(objVARGuiaConsulta) = numGuiaOperadora
			Set $$$VARGuiaConsultaCampo4(objVARGuiaConsulta) = procCarteirinha
			Set $$$VARGuiaConsultaCampo5(objVARGuiaConsulta) = $Select(procDtVencCarte="":"",1:$ZDate(procDtVencCarte,4,,,,,,,""))
			Set $$$VARGuiaConsultaCampo6(objVARGuiaConsulta) = "Não"
			Set $$$VARGuiaConsultaCampo7(objVARGuiaConsulta) = $ZConvert($$SQLGetPatientName^VARSQL(codPaciente),"U")
			Set $$$VARGuiaConsultaCampo8(objVARGuiaConsulta) = $ZConvert($$SQLGetPatientCNS^VARSQL(codPaciente),"U")
			Set $$$VARGuiaConsultaCampo9(objVARGuiaConsulta) = objRegraComercial.CodigoExecutante
			Set $$$VARGuiaConsultaCampo10(objVARGuiaConsulta) = $ZConvert(objRegraComercial.NomeExecutante,"U")
			Set $$$VARGuiaConsultaCampo11(objVARGuiaConsulta) = objRegraComercial.CNESExecutante
			Set $$$VARGuiaConsultaCampo12(objVARGuiaConsulta) = $ZConvert($$$MEDProviderName(objProfissional),"U")
			Set $$$VARGuiaConsultaCampo13(objVARGuiaConsulta) = $ZConvert($$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfissional)),"U")
			Set $$$VARGuiaConsultaCampo14(objVARGuiaConsulta) = $$$MEDProviderSSN(objProfissional)
			Set $$$VARGuiaConsultaCampo15(objVARGuiaConsulta) = $ZConvert($$$MEDProviderFREE3(objProfissional),"U")
			Set $$$VARGuiaConsultaCampo16(objVARGuiaConsulta) = $Select($$$MEDProviderCBO(objProfissional)="":225185,1:$$$MEDProviderCBO(objProfissional))
			Set $$$VARGuiaConsultaCampo17(objVARGuiaConsulta) = 9
			Set $$$VARGuiaConsultaCampo18(objVARGuiaConsulta) = $ZDate(+dtHrAdmisao,4)
			Set $$$VARGuiaConsultaCampo19(objVARGuiaConsulta) = 1
			Set $$$VARGuiaConsultaCampo20(objVARGuiaConsulta) = objRegraComercial.FamiliaTISS
			Set $$$VARGuiaConsultaCampo21(objVARGuiaConsulta) = objRegraComercial.CodigodoItem
			Set $$$VARGuiaConsultaCampo22(objVARGuiaConsulta) = objRegraComercial.Valor
			Set numPagina = $Order(^VARGuiaConsulta(YM, YBED, ""),-1) + 1
			Set ^VARGuiaConsulta(YM, YBED, numPagina, 1) = objVARGuiaConsulta
			Continue
		}
	}
	;
	;PROCEDIMENTOS
	;k ^zzJULIO
	;M ^zzJULIO = tempPreparacaoSPSADT
	;Quit
	If ($Data(tempPreparacaoSPSADT)) {
		Set categoriaTISS = ""
		For {
			Set categoriaTISS = $Order(tempPreparacaoSPSADT(categoriaTISS))
			Quit:categoriaTISS=""
			Set versaoDaTISS = ""
			For {
				Set versaoDaTISS = $Order(tempPreparacaoSPSADT(categoriaTISS, versaoDaTISS))
				Quit:versaoDaTISS=""
				Set procCodPlanodeSaude = ""
				For {
					Set procCodPlanodeSaude = $Order(tempPreparacaoSPSADT(categoriaTISS, versaoDaTISS, procCodPlanodeSaude))
					Quit:procCodPlanodeSaude=""
					Set procNumGuia = ""
					For {
						Set procNumGuia = $Order(tempPreparacaoSPSADT(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia))
						Quit:procNumGuia=""
						Set qtdeItem = 0, qtdeTotalItem = 5
						Set procCodigo = ""
						For {
							Set procCodigo = $Order(tempPreparacaoSPSADT(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia, procCodigo))
							If (procCodigo = "") {
								Set numPagina = $Order(^VARGuiaSPSADT(YM, YBED, ""),-1) + 1
								Set ^VARGuiaSPSADT(YM, YBED, numPagina, 1) = xObjeto
								Quit	
							}
							Set objeto = tempPreparacaoSPSADT(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia, procCodigo)						
							Set qtdeItem = qtdeItem + 1 
							If (qtdeItem > qtdeTotalItem) {
								Set qtdeItem = 1	
								Set numPagina = $Order(^VARGuiaSPSADT(YM, YBED, ""),-1) + 1
								Set ^VARGuiaSPSADT(YM, YBED, numPagina, 1) = xObjeto
							}
							If (qtdeItem = 1) {
								Set xObjeto = objeto	
								Set $$$VARGuiaSPSADTCampo65(xObjeto) = $$$VARGuiaSPSADTCampo59(objeto) + $$$VARGuiaSPSADTCampo60(objeto) 
																										 + $$$VARGuiaSPSADTCampo61(objeto) + $$$VARGuiaSPSADTCampo62(objeto) 
																										 + $$$VARGuiaSPSADTCampo63(objeto) + $$$VARGuiaSPSADTCampo64(objeto) 
							}Else{
								Set piece = $Select(qtdeItem=2:29,qtdeItem=3:34,qtdeItem=4:39,1:44)
								Set $Piece(xObjeto,Y,(piece+0)) = $$$VARGuiaSPSADTCampo24Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+1)) = $$$VARGuiaSPSADTCampo25Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+2)) = $$$VARGuiaSPSADTCampo26Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+3)) = $$$VARGuiaSPSADTCampo27Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+4)) = $$$VARGuiaSPSADTCampo28Linha1(objeto)									
								Set piece = $Select(qtdeItem=2:68,qtdeItem=3:80,qtdeItem=4:92,1:104)
								Set $Piece(xObjeto,Y,(piece+0)) = $$$VARGuiaSPSADTCampo36Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+1)) = $$$VARGuiaSPSADTCampo37Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+2)) = $$$VARGuiaSPSADTCampo38Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+3)) = $$$VARGuiaSPSADTCampo39Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+4)) = $$$VARGuiaSPSADTCampo40Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+5)) = $$$VARGuiaSPSADTCampo41Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+6)) = $$$VARGuiaSPSADTCampo42Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+7)) = $$$VARGuiaSPSADTCampo43Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+8)) = $$$VARGuiaSPSADTCampo44Linha1(objeto)									
								Set $Piece(xObjeto,Y,(piece+9)) = $$$VARGuiaSPSADTCampo45Linha1(objeto)									
								Set $Piece(xObjeto,Y,(piece+10)) = $$$VARGuiaSPSADTCampo46Linha1(objeto)									
								Set $Piece(xObjeto,Y,(piece+11)) = $$$VARGuiaSPSADTCampo47Linha1(objeto)									
								;
								if ($$$VARGuiaSPSADTCampo51Linha1(objeto) '= "") {
									For lProf = 1 : 1 : 4 {
										Set piece = $Select(lProf=1:119,lProf=2:127,lProf=3:135,1:143)
										If ($$$VARGuiaSPSADTCampo51Linha1(objeto)=$Piece(xObjeto,Y,piece)) Quit
										If ($Piece(xObjeto,Y,piece) = "") {
											Set $Piece(xObjeto,Y,(piece-3)) = $$$VARGuiaSPSADTCampo48Linha1(objeto)
											Set $Piece(xObjeto,Y,(piece-2)) = $$$VARGuiaSPSADTCampo49Linha1(objeto)
											Set $Piece(xObjeto,Y,(piece-1)) = $$$VARGuiaSPSADTCampo50Linha1(objeto)
											Set $Piece(xObjeto,Y,(piece+0)) = $$$VARGuiaSPSADTCampo51Linha1(objeto)									
											Set $Piece(xObjeto,Y,(piece+1)) = $$$VARGuiaSPSADTCampo52Linha1(objeto)									
											Set $Piece(xObjeto,Y,(piece+2)) = $$$VARGuiaSPSADTCampo53Linha1(objeto)									
											Set $Piece(xObjeto,Y,(piece+3)) = $$$VARGuiaSPSADTCampo54Linha1(objeto)									
											Set $Piece(xObjeto,Y,(piece+4)) = $$$VARGuiaSPSADTCampo55Linha1(objeto)									
											Quit
										}
									}
								}
								;
								Set piece = $Select(qtdeItem=2:158,qtdeItem=3:160,qtdeItem=4:162,1:164)
								Set $Piece(xObjeto,Y,(piece+0)) = $$$VARGuiaSPSADTCampo56Linha1(objeto)
								Set $$$VARGuiaSPSADTCampo59(xObjeto) = $$$VARGuiaSPSADTCampo59(xObjeto) + $$$VARGuiaSPSADTCampo59(objeto)
								Set $$$VARGuiaSPSADTCampo60(xObjeto) = $$$VARGuiaSPSADTCampo60(xObjeto) + $$$VARGuiaSPSADTCampo60(objeto)
								Set $$$VARGuiaSPSADTCampo61(xObjeto) = $$$VARGuiaSPSADTCampo61(xObjeto) + $$$VARGuiaSPSADTCampo61(objeto)
								Set $$$VARGuiaSPSADTCampo62(xObjeto) = $$$VARGuiaSPSADTCampo62(xObjeto) + $$$VARGuiaSPSADTCampo62(objeto)
								Set $$$VARGuiaSPSADTCampo63(xObjeto) = $$$VARGuiaSPSADTCampo63(xObjeto) + $$$VARGuiaSPSADTCampo63(objeto)
								Set $$$VARGuiaSPSADTCampo64(xObjeto) = $$$VARGuiaSPSADTCampo64(xObjeto) + $$$VARGuiaSPSADTCampo64(objeto)
								Set $$$VARGuiaSPSADTCampo65(xObjeto) = $$$VARGuiaSPSADTCampo65(xObjeto) + $$$VARGuiaSPSADTCampo59(objeto) 
																										 + $$$VARGuiaSPSADTCampo60(objeto) 	+ $$$VARGuiaSPSADTCampo61(objeto) 
																										 + $$$VARGuiaSPSADTCampo62(objeto) 	+ $$$VARGuiaSPSADTCampo63(objeto) 
																										 + $$$VARGuiaSPSADTCampo64(objeto) 
							}
						}
					}
				}
			}
		}
	} 
	;
	;Anexo de Outras Despesas
	;zw tempPreparacaoAneOutDesp
	Merge ^VARGuiaAnexoOutrasDespesasChec(0,YBED) = tempPreparacaoAneOutDesp
	If ($Data(tempPreparacaoAneOutDesp)) {
		Set categoriaTISS = ""
		For {
			Set categoriaTISS = $Order(tempPreparacaoAneOutDesp(categoriaTISS))
			Quit:categoriaTISS=""
			Set versaoDaTISS = ""
			For {
				Set versaoDaTISS = $Order(tempPreparacaoAneOutDesp(categoriaTISS, versaoDaTISS))
				Quit:versaoDaTISS=""
				Set procCodPlanodeSaude = ""
				For {
					Set procCodPlanodeSaude = $Order(tempPreparacaoAneOutDesp(categoriaTISS, versaoDaTISS, procCodPlanodeSaude))
					Quit:procCodPlanodeSaude=""
					Set procNumGuia = ""
					For {
						Set procNumGuia = $Order(tempPreparacaoAneOutDesp(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia))
						Quit:procNumGuia=""
						Set qtdeItem = 0, qtdeTotalItem = 11
						Set procCodigo = ""
						For {
							Set procCodigo = $Order(tempPreparacaoAneOutDesp(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia, procCodigo))
							If (procCodigo = "") {
								Set numPagina = $Order(^VARGuiaAnexoOutrasDespesas(YM, YBED, ""),-1) + 1
								Set ^VARGuiaAnexoOutrasDespesas(YM, YBED, numPagina, 1) = xObjeto
								Quit	
							}
							Set objeto = tempPreparacaoAneOutDesp(categoriaTISS, versaoDaTISS, procCodPlanodeSaude, procNumGuia, procCodigo)						
							Set qtdeItem = qtdeItem + 1 
							If (qtdeItem > qtdeTotalItem) {
								Set qtdeItem = 1	
								Set numPagina = $Order(^VARGuiaAnexoOutrasDespesas(YM, YBED, ""),-1) + 1
								Set ^VARGuiaAnexoOutrasDespesas(YM, YBED, numPagina, 1) = xObjeto
							}
							If (qtdeItem = 1) {
								Set xObjeto = objeto	
								Set $$$VARGuiaAnexoOutrasDespesasCampo27(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) 
																																	+ $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo27(objeto) 
							}Else{
								Set piece = $Select(
															qtdeItem=2:21,
															qtdeItem=3:36,
															qtdeItem=4:51,
															qtdeItem=5:66,
															qtdeItem=6:81,
															qtdeItem=7:96,
															qtdeItem=8:111,
															qtdeItem=9:126,
															qtdeItem=10:141,
															1:156)
								Set $Piece(xObjeto,Y,(piece+0)) = $$$VARGuiaAnexoOutrasDespesasCampo6Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+1)) = $$$VARGuiaAnexoOutrasDespesasCampo7Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+2)) = $$$VARGuiaAnexoOutrasDespesasCampo8Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+3)) = $$$VARGuiaAnexoOutrasDespesasCampo9Linha1(objeto)
								Set $Piece(xObjeto,Y,(piece+4)) = $$$VARGuiaAnexoOutrasDespesasCampo10Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+5)) = $$$VARGuiaAnexoOutrasDespesasCampo11Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+6)) = $$$VARGuiaAnexoOutrasDespesasCampo12Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+7)) = $$$VARGuiaAnexoOutrasDespesasCampo13Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+8)) = $$$VARGuiaAnexoOutrasDespesasCampo14Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+9)) = $$$VARGuiaAnexoOutrasDespesasCampo15Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+10)) = $$$VARGuiaAnexoOutrasDespesasCampo16Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+11)) = $$$VARGuiaAnexoOutrasDespesasCampo17Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+12)) = $$$VARGuiaAnexoOutrasDespesasCampo18Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+13)) = $$$VARGuiaAnexoOutrasDespesasCampo19Linha1(objeto)		
								Set $Piece(xObjeto,Y,(piece+14)) = $$$VARGuiaAnexoOutrasDespesasCampo20Linha1(objeto)		
								Set $$$VARGuiaAnexoOutrasDespesasCampo21(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo21(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo21(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo22(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo22(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo22(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo23(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo23(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo23(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo24(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo24(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo24(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo25(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo25(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo25(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo26(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo26(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo26(objeto)
								Set $$$VARGuiaAnexoOutrasDespesasCampo27(xObjeto) = $$$VARGuiaAnexoOutrasDespesasCampo27(xObjeto) + $$$VARGuiaAnexoOutrasDespesasCampo21(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo22(objeto) 	+ $$$VARGuiaAnexoOutrasDespesasCampo23(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo24(objeto) 	+ $$$VARGuiaAnexoOutrasDespesasCampo25(objeto) 
																										 							+ $$$VARGuiaAnexoOutrasDespesasCampo26(objeto) 
							}
						}
					}
				}
			}
		}
	} 
	Return $$$OK]]></Implementation>
</Method>

<Method name="GerarXML">
<ClassMethod>1</ClassMethod>
<FormalSpec>pNumeroLote="",pYBED="",pGerarZIP=0,pGlosa="",pTipoGlosa=""</FormalSpec>
<Implementation><![CDATA[	$$$VAR
	Set YM 					= 0 
	Set Y  					= "~"
	Set modulo			= 99
	If (pNumeroLote = "") {
		Set YBED				= $Get(%request.Data("YBED",1))
		Set pNumeroLote	= $Get(%request.Data("pNumeroLote",1))
		Set pGerarZIP		= +$Get(%request.Data("pGerarZIP",1))
		Set pTestar			= +$Get(%request.Data("pTestar",1))
		Set pGlosa 			= $Get(%request.Data("pGlosa",1))
		Set pTipoGlosa	= $Get(%request.Data("pTipoGlosa",1))
		If (YBED="JULIO1") Set pTestar = 1
	}Else{
		Set YBED 		= pYBED
		Set pTestar	= 0
		;If (YBED="JULIO") Set pTestar = 1
	}
	;;
	Set objZIP = ##class(User.zip).%New()
	Set countFile = 0
	;;
	;Kill ^FATLoteFaturas
	;Kill ^FATLoteFaturass
	;Set ^FATLoteFaturas(0, pNumeroLote, "21/0000000401", 1, 1) = "1~2~6~123456~APN02~125.20~65899,53005~3.03.01~0~~21/0000000007~PROCEDIMENTOS~2~1~"_($H+100)_"~~"_($Horolog-10)_",25425"
	;Set ^FATLoteFaturas(0, pNumeroLote, "21/0000000401", 2, 1) = "1~2~6~123456~APN02~125.20~65899,53005~3.03.01~0~~21/0000000007~PROCEDIMENTOS~2~1~"_($H+100)_"~~"_($Horolog-10)_",25425"
	;Set ^FATLoteFaturas(0, pNumeroLote, "21/0000000401", 3, 1) = "1~2~6~123456~CNP1~142.25~65899,53005~3.03.01~0~~21/0000000008~PROCEDIMENTOS~3~1~"_($H+100)_"~~"_($Horolog-10)_",25425"
	;Set ^FATLoteFaturas(0, pNumeroLote, "21/0000000401", 4, 1) = "1~2~6~123456~CNP1~142.25~65899,53005~3.03.01~0~~21/0000000008~CONSULTA~3~1~"_($H+100)_"~~"_($Horolog-10)_",25425"
	;Set ^FATLoteFaturas(0, pNumeroLote, "21/0000000401", 6, 1) = "1~2~6~123456~HEM~11.67~65899,53005~3.04.01~0~~21/0000000008~PROCEDIMENTOS~3~1~"_($H+100)_"~~"_($Horolog-10)_",25425"
	;Do RebuildIndexes^COMUtils("FATLoteFaturas")
	;;
	Try{
		;Cria diretorio para armazenamento dos XML
		If ('$Data(^VARBRDiretorios(YM,modulo))) {
			Set ^VARBRDiretorios(YM,modulo,1)="TISS~Arquivos de Lotes TISS~TISS~0"
			Do RebuildIndexes^COMUtils("VARBRDiretorios")
		}
		;
		Set dname = $$GetDiretorioFisico^VARBRDiretorios(0,modulo)
		If ($Extract(dname, $Length(dname)) '= "\")  Set dname = dname _ "\"
		If (pGlosa '= "") {
			Set dname = dname _ pGlosa _ "\" 
		}Else{
			Set dname = dname _ pNumeroLote _ "\" 
		}
		If ($$$isWINDOWS) Set dname = $Replace(dname,"/","\")
		Else  Set dname = $Replace(dname,"\","/")
		If ('##class(%File).DirectoryExists(dname)) Do ##class(%File).CreateDirectoryChain(dname)
		Do ##class(%File).Delete(dname_"*")
		Set qtdeArquivo = 0
		;
		Set objZIP.SourceDirectory = dname
		;
		If (pGlosa '= "") {
			Set meuSQLArquivo = "Select Adm.*, LotFat.VersaodaTISS, LotFat.CategoriaTISS, Glosa.CriadoEm As CriadoEm "
			Set meuSQLArquivo = meuSQLArquivo _ "From SQLUser.FATGlosaAdmissao As Adm, "
			Set meuSQLArquivo = meuSQLArquivo _ "SQLUser.FATGlosa As Glosa, SQLUser.FATLoteFaturas As LotFat "
			Set meuSQLArquivo = meuSQLArquivo _ "Where Adm.Company = 0 And Glosa.Company = 0 And LotFat.Company = 0 "
			Set meuSQLArquivo = meuSQLArquivo _ "And Glosa.CodigoGlosa = Adm.CodigodaGlosa "
			Set meuSQLArquivo = meuSQLArquivo _ "And LotFat.CodigodoLote = Glosa.CodigoLote "
			Set meuSQLArquivo = meuSQLArquivo _ "And LotFat.SequenciadeAtendimento = Adm.SequenciaProcedimento "
			Set meuSQLArquivo = meuSQLArquivo _ "And LotFat.NumerodaFatura = Adm.CodigodaAdmissao "
			Set meuSQLArquivo = meuSQLArquivo _ "And Adm.CodigodaGlosa = '"_pGlosa_"' "
			If (pTipoGlosa = 2) {
				Set meuSQLArquivo = meuSQLArquivo _ "And Adm.Status > 3 "
			}
			Set meuSQLArquivo = meuSQLArquivo _ "Group By LotFat.VersaodaTISS, lotFat.CategoriaTISS "
		}Else{
			Set meuSQLArquivo = "Select * From ( "
			Set meuSQLArquivo = meuSQLArquivo _ "Select $$GetRegistroANS^VARSQL(Procedimento,Convenio,CodigodoAtendimento,"
			Set meuSQLArquivo = meuSQLArquivo _ "SequenciadeAtendimento) As CodExecutante, "
			Set meuSQLArquivo = meuSQLArquivo _ "Case CategoriaTISS When 'CONSULTA' Then 'CONSULTA' Else 'PROCEDIMENTOS' End As CategoriaTISSGrupo, "
			Set meuSQLArquivo = meuSQLArquivo _ "* From SQLUser.FATLoteFaturas Where Company = 0 "
			Set meuSQLArquivo = meuSQLArquivo _ "And CodigodoLote = '"_pNumeroLote_"' "
			;Set meuSQLArquivo = meuSQLArquivo _ "And NumerodaFatura = 'SVLCHSPHOM0000010' "
			Set meuSQLArquivo = meuSQLArquivo _ ") "
			;Set meuSQLArquivo = meuSQLArquivo _ "Where CodExecutante = 390038 "
			Set meuSQLArquivo = meuSQLArquivo _ "Group By VersaodaTISS, CategoriaTISSGrupo, CodExecutante "
		}
		Write:pTestar "<br>"_meuSQLArquivo_"<br>"
		Set rSetArquivo 	= ##Class(%SQL.Statement).%ExecDirect("",meuSQLArquivo)
		While rSetArquivo.%Next() {
			;			
			Set versaoTISS 		= rSetArquivo.%Get("VersaodaTISS")
			Set criadoEm 			= rSetArquivo.%Get("CriadoEm")
			Set codExecutante = rSetArquivo.%Get("CodExecutante")
			;
			Set qtdeArquivo 			= qtdeArquivo + 1
			If (pGlosa '= "") {
				Set numLoteFormatado	= pGlosa_($Extract("00",1,2-$Length(qtdeArquivo))_qtdeArquivo)
			}Else{
				Set numLoteFormatado	= pNumeroLote_($Extract("00",1,2-$Length(qtdeArquivo))_qtdeArquivo)
			}
			Set nomeArquivo 			= $Extract("00000000000000000000",1,(20-$Length(numLoteFormatado)))_numLoteFormatado
			;
			Set objXML = ##class(%XML.Writer).%New()
			Set objXMLHash = ##class(%XML.Writer).%New()
		 	;
		 	Set objXML.Charset			= "ISO-8859-1"
		 	Set objXMLHash.Charset	= "ISO-8859-1"
		 	;
		 	Set Sc = objXML.OutputToString()
		 	Set Sc = objXMLHash.OutputToString()
		 	;
		 	Set objXML.Indent			= 1
		 	Set objXMLHash.Indent	= 1
		 	;
		 	Set objXML.SuppressXmlns			= 0
		 	Set objXMLHash.SuppressXmlns	= 0
			;
			Do objXML.DefaultXmlnsSet("http://www.w3.org/2001/XMLSchemas")
			Do objXMLHash.DefaultXmlnsSet("http://www.w3.org/2001/XMLSchemas")
			;
		 	;Adiciona no XML a linha: xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 	Do objXML.AddInstanceNamespace("xsi")
		 	Do objXMLHash.AddInstanceNamespace("xsi")
			;Adiciona no XML a linha: xsi:schemaLocation="http://www.ans.gov.br/padroes/tiss/schemas http://www.ans.gov.br/padroes/tiss/schemas/tissV3_04_01.xsd"
		 	Do objXML.AddNamespace("http://www.ans.gov.br/padroes/tiss/schemas http://www.ans.gov.br/padroes/tiss/schemas/tissV"_$Replace(versaoTISS,".","_")_".xsd","schemaLocation","xsi")
		 	Do objXMLHash.AddNamespace("http://www.ans.gov.br/padroes/tiss/schemas http://www.ans.gov.br/padroes/tiss/schemas/tissV"_$Replace(versaoTISS,".","_")_".xsd","schemaLocation","xsi")
			;
			;Tag Cabecalho | Inicio
			Set objCabecalho = ##Class(VAR.TISS.cabecalho).%New()
			Set pCampoDest = 0
			Set pCampoOrig = 0
			;
			Set objIdentTransacao = ##Class(VAR.TISS.cabecalhoIdentificacaoTransacao).%New()
			;Tipo de Transação Aceitas
			;ENVIO_LOTE_GUIAS, SOLIC_DEMONSTRATIVO_RETORNO, SOLIC_STATUS_PROTOCOLO, SOLICITACAO_PROCEDIMENTOS, 
			;PROTOCOLO_RECEBIMENTO, SITUACAO_PROTOCOLO, RESPOSTA_SOLICITACAO, DEMONSTRATIVO_PAGAMENTO, 
			;DEMONSTRATIVO_ANALISE_CONTA, DEMONSTRATIVO_ODONTOLOGIA, CANCELAMENTO_GUIA_RECIBO, RE_APRESENTACAO_GUIA, 
			;CANCELA_GUIA, VERIFICA_ELEGIBILIDADE, SITUACAO_ELEGIBILIDADE, AUTORIZACAO_ODONTOLOGIA, SOLICITA_STATUS_AUTORIZACAO, 
			Set objIdentTransacao.tipoTransacao 				= ..imprimirConteudo("ENVIO_LOTE_GUIAS") ;"Duvida com a Patricia Glosa
			Set objIdentTransacao.sequencialTransacao 	= ..imprimirConteudo(numLoteFormatado)
			Set objIdentTransacao.dataRegistroTransacao = ..imprimirConteudo(+criadoEm, "D")							
			Set objIdentTransacao.horaRegistroTransacao = ..imprimirConteudo($Piece(criadoEm,",",2), "H")	
			Set objCabecalho.identificacaoTransacao = objIdentTransacao
			;
		 	;Tag Prestador Para Operadora
		 	Set objPrestParaOperadoraLoteGuias = ##Class(VAR.TISS.prestadorParaOperadoraLoteGuias).%New()
			Set objPrestParaOperadoraLoteGuias.numeroLote = ..imprimirConteudo(numLoteFormatado)
			;
			Set numRegANSDestino = ""
			Set sequenciaItem		 = 0
			;
			If (pGlosa '= "") {
				Set meuSQLGuia = "Select Adm.*, LotFat.VersaodaTISS, LotFat.CategoriaTISS, LotFat.Convenio "
				Set meuSQLGuia = meuSQLGuia _ "From SQLUser.FATGlosaAdmissao As Adm, "
				Set meuSQLGuia = meuSQLGuia _ "SQLUser.FATGlosa As Glosa, SQLUser.FATLoteFaturas As LotFat "
				Set meuSQLGuia = meuSQLGuia _ "Where Adm.Company = 0 And Glosa.Company = 0 And LotFat.Company = 0 "
				Set meuSQLGuia = meuSQLGuia _ "And Glosa.CodigoGlosa = Adm.CodigodaGlosa "
				Set meuSQLGuia = meuSQLGuia _ "And LotFat.CodigodoLote = Glosa.CodigoLote "
				Set meuSQLGuia = meuSQLGuia _ "And LotFat.NumerodaFatura = Adm.CodigodaAdmissao "
				Set meuSQLGuia = meuSQLGuia _ "And LotFat.SequenciadeAtendimento = Adm.SequenciaProcedimento "
				Set meuSQLGuia = meuSQLGuia _ "And Adm.CodigodaGlosa = '"_pGlosa_"' "
				If (pTipoGlosa = 2) {
					Set meuSQLGuia = meuSQLGuia _ "And Adm.Status > 3 "
				}
				Set meuSQLGuia = meuSQLGuia _ "And LotFat.VersaodaTISS = '"_versaoTISS_"' "
				Set meuSQLGuia = meuSQLGuia _ "And LotFat.CategoriaTISS = '"_rSetArquivo.%Get("CategoriaTISS")_"' "
				Set meuSQLGuia = meuSQLGuia _ "Group By Adm.CodigodoAgendamento,  Adm.Guia, Adm.CodigodaAdmissao, Adm.VencimentodaCarteirinha"
			}Else{
				Set meuSQLGuia 	= "Select * From SQLUser.FATLoteFaturas Where Company = 0 "
				Set meuSQLGuia 	= meuSQLGuia _ "And CodigodoLote = '"_pNumeroLote_"' "
				Set meuSQLGuia 	= meuSQLGuia _ "And VersaodaTISS = '"_versaoTISS_"' "
				If (rSetArquivo.%Get("CategoriaTISSGrupo")="PROCEDIMENTOS") {
					Set meuSQLGuia 	= meuSQLGuia _ "And CategoriaTISS In ('"_rSetArquivo.%Get("CategoriaTISS")_"','MEDICAMENTOS') "
				}Else{
					Set meuSQLGuia 	= meuSQLGuia _ "And CategoriaTISS = '"_rSetArquivo.%Get("CategoriaTISS")_"' "
				}
				Set meuSQLGuia 	= meuSQLGuia _ "And $$GetRegistroANS^VARSQL(Procedimento,Convenio,CodigodoAtendimento,SequenciadeAtendimento) = '"_codExecutante_"'"
				;Set meuSQLGuia = meuSQLGuia _ "And NumerodaFatura = 'SVLCHSPHOM0000010' "
				Set meuSQLGuia 	= meuSQLGuia _ "Group By CodigodoAtendimento, GuiaConvenio, NumerodaFatura, ValidadeCarteirinha"
			}
			;w "<br>"_meuSQLGuia
			Set rSetGuia		= ##Class(%SQL.Statement).%ExecDirect("",meuSQLGuia)
			While rSetGuia.%Next() {
				If (pGlosa '= "") {
					Set codProcedimento = rSetGuia.%Get("Procedimento")			
					Set codConvenio 		= rSetGuia.%Get("Convenio")
					Set codAgendamento 	= rSetGuia.%Get("CodigodoAgendamento")			
					Set seqAgendamento 	= rSetGuia.%Get("SequenciaProcedimento")	
				}Else{
					Set codProcedimento = rSetGuia.%Get("Procedimento")			
					Set codConvenio 		= rSetGuia.%Get("Convenio")
					Set codAgendamento 	= rSetGuia.%Get("CodigodoAtendimento")			
					Set seqAgendamento 	= rSetGuia.%Get("SequenciadeAtendimento")	
				}
				;13/01/2022 
				;If (codAgendamento '= "22/0000000038") Continue
				Set objVARAgendamentoProcedimentos = $Get(^VARAgendamentoProcedimentos(YM, codAgendamento, seqAgendamento, 1))
				Set codProfissional			= $$$VARAgendamentoProcedimentosProfissional(objVARAgendamentoProcedimentos)
				Set codProfSolicitante	= $$$VARAgendamentoProcedimentosSolicitante(objVARAgendamentoProcedimentos)
				Set dtHrAdmisao					= $$$VARAgendamentoProcedimentosDataHoraAdmissao(objVARAgendamentoProcedimentos)
				Set codSala							= $$$VARAgendamentoProcedimentosCodigodaSala(objVARAgendamentoProcedimentos)
				Set horadeAtendimento		= $$$VARAgendamentoProcedimentosHoraAtendimento(objVARAgendamentoProcedimentos)
				Set datadeAtendimento		= $$$VARAgendamentoProcedimentosDataAtendimento(objVARAgendamentoProcedimentos)
				Set xGuiaCad						= $$$VARAgendamentoProcedimentosGuia(objVARAgendamentoProcedimentos)
				Set xControleAdm				= $$$VARAgendamentoProcedimentosControleAdmissao(objVARAgendamentoProcedimentos)
				
				If (xControleAdm '= "" && ($$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1))) '= "")) {
					Set dtHrAdmisao		= $$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))_","_$$$VARAgendamentoAdmissaoCriadoHora($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))
				}

				
				;If (xGuiaCad '= "") {
				;	Set objVARAgendamentoGuia = $Get(^VARAgendamentoGuia(YM, codAgendamento, xGuiaCad, 1))
				;}Else{
				;	Continue	
				;}
				;Set dtAutorizacao = $$$VARAgendamentoGuiaDataAutorizacao(objVARAgendamentoGuia)
				;W "<br>"_codAgendamento_"|"_xGuiaCad_"|"_dtAutorizacao
				;Continue
				If (pTestar=1) {
					w "<br>"_	codProcedimento_"|"_codConvenio
				}
				Set objRegraComercial = ##Class(VAR.util.FATRegrasComerciais).%New(codProcedimento, codConvenio, codAgendamento, seqAgendamento)
				If ('$IsObject(objRegraComercial)) Continue
				Set codUnidade = ""
				If (codProfissional '= "") {
					Set objMEDProviderAgendaHorario = ""
					If (codProfissional '= "" && (horadeAtendimento '= "") && (datadeAtendimento '= "")) {
						Set objMEDProviderAgendaHorario = $Get(^MEDProviderAgendaHorario(YM, codProfissional, datadeAtendimento, horadeAtendimento, 1))
					}
					Set referenciaPai = $$$MEDProviderAgendaHorarioReferenciaPai(objMEDProviderAgendaHorario)
					Set objMEDProviderAgenda = ""
					If (referenciaPai '= "") {
						Set objMEDProviderAgenda = $Get(^MEDProviderAgenda(YM, codProfissional, referenciaPai, 1))
					}
					Set codUnidade	= $$$MEDProviderAgendaUnidade(objMEDProviderAgenda)
				}ElseIf (codSala '= ""){
					Set objVARSalasAtendimentos = $Get(^VARSalasAtendimentos(0, codSala, 1))
					Set codUnidade	= $$$VARSalasAtendimentosUnidade(objVARSalasAtendimentos)
				}Else{
					Set codUnidade = 1
				}
				Set objWWW0121 = $Get(^WWW0121(0,0,codUnidade,1))
				Set codOrganizacao = $$$WWW0121Organizacao(objWWW0121)

				If (codOrganizacao = "") continue

				Do objRegraComercial.recDadosExecutante(codOrganizacao)

				;If (pCampoOrig = 0) {
				;If (objCabecalho.origem = "") {
				If (objCabecalho.origem.%IsNull()) {
					;Atenção: Estrutura definida para informar a origem da mensagem eletrônica. No caso da
					;					origem ser uma Operadora deverá ser preenchido apenas o Registro ANS, e para o
					;					caso da origem ser um Prestador, deve ser informado a identificação do mesmo.
					;					Nunca as duas opções estarão preenchidas na mesma mensagem.
					Set objOrigem = ##Class(VAR.TISS.cabecalhoOrigem).%New()
					If (objRegraComercial.ANSExecutante '= "") {
						Set objOrigem.registroANS = ..imprimirConteudo(objRegraComercial.ANSExecutante)
					}Else{
						Set objOrigemIndPrest = ##Class(VAR.TISS.cabecalhoOrigemIdentificacaoPrestador).%New()
						If ($Length(objRegraComercial.CodigoExecutante) = 14) {
							Set objOrigemIndPrest.CNPJ = ..imprimirConteudo(objRegraComercial.CodigoExecutante)
						}Else{
							Set objOrigemIndPrest.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComercial.CodigoExecutante)
						}	
						Set objOrigem.identificacaoPrestador = objOrigemIndPrest
						Set objCabecalho.origem = objOrigem
					}
					Set pCampoOrig = 1
				}
				if (pTestar=1) {
					;w "<br>"_objRegraComercial.CodigoANS_"|"_objCabecalho.destino
				}
				;If (pCampoDest = 0) {
				;If (objCabecalho.destino = "") {
				If (objCabecalho.destino.%IsNull()) {
					Set objDestino = ##Class(VAR.TISS.cabecalhoDestino).%New()
					Set numRegANSDestino = objRegraComercial.CodigoANS
					Set objDestino.registroANS = ..imprimirConteudo(objRegraComercial.CodigoANS)
					Set objCabecalho.destino = objDestino
					Set objCabecalho.padrao = ..imprimirConteudo(versaoTISS)
					Set pCampoDest = 1
				}
				;Tag Cabecalho | Fim
				If (pGlosa '= "") {
					Set meuSQL 	= "Select Adm.*, LotFat.VersaodaTISS, LotFat.CategoriaTISS, LotFat.Convenio, "
					Set meuSQL = meuSQL _ "Sum(Adm.QtdeProcedimento) As TotalProcedimento "
					Set meuSQL = meuSQL _ "From SQLUser.FATGlosaAdmissao As Adm, "
					Set meuSQL = meuSQL _ "SQLUser.FATGlosa As Glosa, SQLUser.FATLoteFaturas As LotFat "
					Set meuSQL = meuSQL _ "Where Adm.Company = 0 And Glosa.Company = 0 And LotFat.Company = 0 "
					Set meuSQL = meuSQL _ "And Glosa.CodigoGlosa = Adm.CodigodaGlosa "
					Set meuSQL = meuSQL _ "And LotFat.CodigodoLote = Glosa.CodigoLote "
					Set meuSQL = meuSQL _ "And LotFat.NumerodaFatura = Adm.CodigodaAdmissao "
					Set meuSQL = meuSQL _ "And LotFat.SequenciadeAtendimento = Adm.SequenciaProcedimento "
					Set meuSQL = meuSQL _ "And Adm.CodigodaGlosa = '"_pGlosa_"' "
					If (pTipoGlosa = 2) {
						Set meuSQL = meuSQL _ "And Adm.Status > 3 "
					}
					Set meuSQL = meuSQL _ "And LotFat.VersaodaTISS = '"_versaoTISS_"' "
					Set meuSQL = meuSQL _ "And LotFat.CategoriaTISS = '"_rSetArquivo.%Get("CategoriaTISS")_"' "
					Set meuSQL = meuSQL _ "And Adm.CodigodoAgendamento = '"_rSetGuia.]]><![CDATA[%Get("CodigodoAgendamento")_"' "
					If (rSetGuia.%Get("Guia") = "") {
						Set meuSQL 	= meuSQL _ "And Adm.Guia Is Null "
					}else{
						Set meuSQL 	= meuSQL _ "And Adm.Guia = '"_rSetGuia.%Get("Guia")_"' "
					}
					Set meuSQL 	= meuSQL _ "And Adm.CodigodaAdmissao = '"_rSetGuia.%Get("CodigodaAdmissao")_"' "
					If (rSetGuia.%Get("NodaCarteirinha") = "") {
						Set meuSQL 	= meuSQL _ "And Adm.NodaCarteirinha Is Null "
					}Else{
						Set meuSQL 	= meuSQL _ "And Adm.NodaCarteirinha = '"_rSetGuia.%Get("NodaCarteirinha")_"' "
					}
					If (rSetGuia.%Get("VencimentodaCarteirinha") = "") {
						Set meuSQL 	= meuSQL _ "And Adm.VencimentodaCarteirinha Is Null "
					}else{
						Set meuSQL 	= meuSQL _ "And Adm.VencimentodaCarteirinha = '"_rSetGuia.%Get("VencimentodaCarteirinha")_"' "
					}
					If (rSetArquivo.%Get("CategoriaTISS") = "PROCEDIMENTOS") {
						Set meuSQL 	= meuSQL _ "Group By Adm.Procedimento"
					}
				}Else{
					Set meuSQL 	= "Select *, Sum(QtdedeProcedimento) As TotalProcedimento "
					Set meuSQL	= meuSQL _ "From SQLUser.FATLoteFaturas Where Company = 0 "
					Set meuSQL	= meuSQL _ "And CodigodoLote = '"_pNumeroLote_"' "
					Set meuSQL 	= meuSQL _ "And VersaodaTISS = '"_versaoTISS_"' "
					If (rSetArquivo.%Get("CategoriaTISSGrupo")="PROCEDIMENTOS") {
						Set meuSQL 	= meuSQL _ "And CategoriaTISS In ('"_rSetArquivo.%Get("CategoriaTISS")_"','MEDICAMENTOS') "
					}Else{
						Set meuSQL 	= meuSQL _ "And CategoriaTISS = '"_rSetArquivo.%Get("CategoriaTISS")_"' "
					}
					;Set meuSQL 	= meuSQL _ "And CategoriaTISS = '"_rSetArquivo.%Get("CategoriaTISS")_"' "
					Set meuSQL 	= meuSQL _ "And CodigodoAtendimento = '"_rSetGuia.%Get("CodigodoAtendimento")_"' "
					If (rSetGuia.%Get("GuiaConvenio") = "") {
						Set meuSQL 	= meuSQL _ "And GuiaConvenio Is Null "
					}else{
						Set meuSQL 	= meuSQL _ "And GuiaConvenio = '"_rSetGuia.%Get("GuiaConvenio")_"' "
					}
					Set meuSQL 	= meuSQL _ "And NumerodaFatura = '"_rSetGuia.%Get("NumerodaFatura")_"' "
					If (rSetGuia.%Get("NumerodaCarteirinha") = "") {
						Set meuSQL 	= meuSQL _ "And NumerodaCarteirinha Is Null "
					}Else{
						Set meuSQL 	= meuSQL _ "And NumerodaCarteirinha = '"_rSetGuia.%Get("NumerodaCarteirinha")_"' "
					}
					If (rSetGuia.%Get("ValidadeCarteirinha") = "") {
						Set meuSQL 	= meuSQL _ "And ValidadeCarteirinha Is Null "
					}else{
						Set meuSQL 	= meuSQL _ "And ValidadeCarteirinha = '"_rSetGuia.%Get("ValidadeCarteirinha")_"' "
					}
					If (rSetArquivo.%Get("CategoriaTISS") = "PROCEDIMENTOS") {
						Set meuSQL 	= meuSQL _ "Group By Procedimento"
					}
				}
				If (rSetArquivo.%Get("CategoriaTISS") = "PROCEDIMENTOS" || (rSetArquivo.%Get("CategoriaTISS") = "MEDICAMENTOS")) {
					Write:pTestar "<br>"_meuSQL_"<br>"
					Set (rObjGuiaSPSADT, rSequenciaItem) = ""
					If (pGlosa '= "") {
						Do ..guiaSPSADT(numRegANSDestino, pNumeroLote, rSetGuia.%Get("CodigodoAgendamento"), rSetGuia.%Get("SequenciaProcedimento"), rSetGuia.%Get("CodigodaAdmissao"), rSetGuia.%Get("Guia"), meuSQL, sequenciaItem, versaoTISS, xGuiaCad, .rObjGuiaSPSADT, .rSequenciaItem, pGlosa)
					}Else{
						Do ..guiaSPSADT(numRegANSDestino, pNumeroLote, rSetGuia.%Get("CodigodoAtendimento"), rSetGuia.%Get("SequenciadeAtendimento"), rSetGuia.%Get("NumerodaFatura"), rSetGuia.%Get("GuiaConvenio"), meuSQL, sequenciaItem, versaoTISS, xGuiaCad, .rObjGuiaSPSADT, .rSequenciaItem, "")
					}
			 		Set sequenciaItem = rSequenciaItem
			 		Do objPrestParaOperadoraLoteGuias.guiaSPSADT.SetAt(rObjGuiaSPSADT, objPrestParaOperadoraLoteGuias.guiaSPSADT.Count()+1)
				}ElseIf(rSetArquivo.%Get("CategoriaTISS") = "CONSULTA") {
					Set rSet = ##Class(%SQL.Statement).%ExecDirect("",meuSQL)
					While rSet.%Next() {
						Set (rObjGuiaConsulta, rSequenciaItem) = ""  
						If (pGlosa '= "") {
							Set retorno = ..guiaConsulta(numRegANSDestino, pNumeroLote, rSetGuia.%Get("CodigodoAgendamento"), rSetGuia.%Get("SequenciaProcedimento"), rSetGuia.%Get("CodigodaAdmissao"), rSetGuia.%Get("Guia"), sequenciaItem, rSet, versaoTISS, xGuiaCad, .rObjGuiaConsulta, .rSequenciaItem, pGlosa)
						}Else{
							Set retorno = ..guiaConsulta(numRegANSDestino, pNumeroLote, rSetGuia.%Get("CodigodoAtendimento"), rSetGuia.%Get("SequenciadeAtendimento"), rSetGuia.%Get("NumerodaFatura"), rSetGuia.%Get("GuiaConvenio"), sequenciaItem, rSet, versaoTISS, xGuiaCad, .rObjGuiaConsulta, .rSequenciaItem, "")
						}
			 			If (retorno '= $$$OK) Continue
			 			Set sequenciaItem = rSequenciaItem
			 			Do objPrestParaOperadoraLoteGuias.guiaConsulta.SetAt(rObjGuiaConsulta, objPrestParaOperadoraLoteGuias.guiaConsulta.Count()+1)
					}
				}
			}
			;
		 	Set objPrestParaOperadora = ##Class(VAR.TISS.prestadorParaOperadora).%New()
			Set objPrestParaOperadora.loteGuias = objPrestParaOperadoraLoteGuias
		 	;
		 	;Tag Prestador Para Operadora | Fim
		 	;
		 	;Conteudo XML
			Set objInicializacao = ##Class(VAR.TISS.mensagemTISS).%New()
		 	Set objInicializacao.cabecalho 							=  objCabecalho
		 	Set objInicializacao.prestadorParaOperadora =  objPrestParaOperadora
		 	;
		 	Set tStatus = objXML.RootObject(objInicializacao)
			;
			Kill conteudoTotalXML, conteudoHash 
			Set conteudoHash = ""
			Set conteudoTotalXML = objXML.GetXMLString()
			For linha = 1 : 1 : $Length(conteudoTotalXML,$Char(13,10)) {
				Set conteudo = $Piece($Piece($Piece(conteudoTotalXML,$Char(13,10),linha),">",2),"<",1)				
				If (conteudo = "") Continue
				Set conteudoHash = conteudoHash _ conteudo
			}
			;
			;
		 	Set objEpilogo = ##Class(VAR.TISS.epilogo).%New()
		 	Set hash = ..gerarHash(conteudoHash)
			Set objEpilogo.hash = hash
		 	Set objInicializacao.epilogo = objEpilogo
			;
		 	Set tStatus = objXMLHash.RootObject(objInicializacao)
			;
			If (pTestar = 1) {
				Write objXMLHash.GetXMLString()
			}Else{
				;Set file = ##class(%File).%New(dname_nomeArquivo_"_"_hash_".xml")
				Set file = ##class(%File).%New(dname_nomeArquivo_".xml")
				Do file.Open("WSN")
				Do file.Write(objXMLHash.GetXMLString())
				Do file.Close()
				;
				Set objZIP.files($Increment(countFile)) = nomeArquivo_".xml"
			}
		}
		;
		If (pGerarZIP = 1) {
			If (pGlosa '= "") {
				Set objZIP.packfile = dname_"Glosa_"_pGlosa_"_"_countFile_"_Arquivos.zip"
			}Else{
				Set objZIP.packfile = dname_"Lote_"_pNumeroLote_"_"_countFile_"_Arquivos.zip"
			}
			Do objZIP.pack()
			;
			Do ##class(%File).Delete(dname_"*.xml")
		}
	}Catch {
		Write "Erro: "_$ZERROR ,!
	}
	Return $$$OK]]></Implementation>
</Method>

<Method name="guiaConsulta">
<ClassMethod>1</ClassMethod>
<FormalSpec>pNumRegANSDestino,pNumeroLote,pCodAtendimento,pSeqAtendimento,pNumeroFatura,pGuiaConvenio,sequenciaItem,pRSet,pVersaoTISS,pXGuiaCad,&amp;rObjGuiaConsulta:VAR.TISS.guiaConsulta,&amp;rSequenciaItem,pGlosa</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	Set YM 	= 0
	Set Y 	= "~"
	;
	If (pGlosa '= "") {
		Set objVARAgendamento 	= $Get(^VARAgendamento(YM, pCodAtendimento, 1))
		Set objFATGlosaAdmissao = $Get(^FATGlosaAdmissao(YM, pGlosa, pNumeroFatura, pSeqAtendimento, 1))
		Set xCodLote 						= $$$FATGlosaCodigoLote(^FATGlosa(YM,pGlosa,1))
		Set objFATLoteFaturas 	= $Get(^FATLoteFaturas(YM, xCodLote, pCodAtendimento, pSeqAtendimento, 1))
	}Else{
		Set objFATLoteFaturas = $Get(^FATLoteFaturas(YM, pNumeroLote, pCodAtendimento, pSeqAtendimento, 1))
	}
	;					
	Set rObjGuiaConsulta = ##Class(VAR.TISS.guiaConsulta).%New()
	Set rSequenciaItem = sequenciaItem
	;
	Set objVARAgendamentoGuia = ""
	If (pGuiaConvenio '= "") {
		Set objVARAgendamentoGuia = $Get(^VARAgendamentoGuia(YM, pCodAtendimento, pGuiaConvenio, 1))
	}
	Set numGuiaAtrOpe	= $$$VARAgendamentoGuiaNumerodaGuiaAtribuidapela(objVARAgendamentoGuia)
	;Set rObjGuiaSPSADT.numeroGuiaPrincipal = "012345678901234567890"
	;
	Set objCabecalho = ##Class(VAR.TISS.guiaConsultaCabecalhoConsulta).%New()
	Set objCabecalho.registroANS 					= pNumRegANSDestino
	Set objCabecalho.numeroGuiaPrestador	= pNumeroFatura
	;Set objCabecalho.dataEmissaoGuia 		= +$Horolog
	Set objCabecalho.numeroGuiaOperadora 	= numGuiaAtrOpe
	Set rObjGuiaConsulta.cabecalhoGuia = objCabecalho
	;
	Set codPaciente	= $$$FATLoteFaturasCodigodoPaciente(objFATLoteFaturas)
	Set codConvenio	= $$$FATLoteFaturasConvenio(objFATLoteFaturas)
	Set codPlanoSaude	= $$$FATLoteFaturasPlanodeSaude(objFATLoteFaturas)
	If (pGlosa '= "") {
		Set numCarteirinha = $$$FATGlosaAdmissaoNodaCarteirinha(objFATGlosaAdmissao)
		Set dtValCart = $$$FATGlosaAdmissaoVencimentodaCarteirinha(objFATGlosaAdmissao)
	}Else{
		Set numCarteirinha = $$$FATLoteFaturasNumerodaCarteirinha(objFATLoteFaturas)
		Set dtValCart = $$$FATLoteFaturasValidadeCarteirinha(objFATLoteFaturas)
	}	
	Set numCNS = $$SQLGetPatientCNS^VARSQL(codPaciente)
	Set objDadosBeneficiario = ##Class(VAR.TISS.guiaConsultaDadosBeneficiario).%New()
	Set:numCarteirinha'="" objDadosBeneficiario.numeroCarteira = ..imprimirConteudo(numCarteirinha)
	Set objDadosBeneficiario.atendimentoRN = ..imprimirConteudo("N")
	Set objDadosBeneficiario.nomeBeneficiario = ..imprimirConteudo($$SQLGetPatientName^VARSQL(codPaciente))
	;Set objDadosBeneficiario.nomePlano = $$GetOrganizacaoNome^VARSQL(codPlanoSaude)
	;Set:dtValCart'="" objDadosBeneficiario.validadeCarteira = dtValCart
	;Set:numCNS'="" objDadosBeneficiario.numeroCNS = ..imprimirConteudo(numCNS)
	;Set objDadosBeneficiario.identificaoBeneficiario = ""	
	Set rObjGuiaConsulta.dadosBeneficiario = objDadosBeneficiario
	;
	Set codProcedimento 	= pRSet.%Get("Procedimento")
	Set totalProcedimento = pRSet.%Get("TotalProcedimento")
	If (pGlosa '= "") {
		Set seqAtendimento		= pRSet.%Get("SequenciaProcedimento")
	}else{
		Set seqAtendimento		= pRSet.%Get("SequenciadeAtendimento")
	}
	;
	Set objVARAgendamentoProcedimentos = $Get(^VARAgendamentoProcedimentos(YM, pCodAtendimento, seqAtendimento, 1))
	Set codProfissional			= $$$VARAgendamentoProcedimentosProfissional(objVARAgendamentoProcedimentos)
	Set codProfSolicitante	= $$$VARAgendamentoProcedimentosSolicitante(objVARAgendamentoProcedimentos)
	Set dtHrAdmisao					= $$$VARAgendamentoProcedimentosDataHoraAdmissao(objVARAgendamentoProcedimentos)
	Set codSala							= $$$VARAgendamentoProcedimentosCodigodaSala(objVARAgendamentoProcedimentos)
	Set horadeAtendimento		= $$$VARAgendamentoProcedimentosHoraAtendimento(objVARAgendamentoProcedimentos)
	Set datadeAtendimento		= $$$VARAgendamentoProcedimentosDataAtendimento(objVARAgendamentoProcedimentos)
	;
	Set xControleAdm				= $$$VARAgendamentoProcedimentosControleAdmissao(objVARAgendamentoProcedimentos)
	If (xControleAdm '= "" && ($$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1))) '= "")) {
		Set dtHrAdmisao		= $$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))_","_$$$VARAgendamentoAdmissaoCriadoHora($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))
	}
	;
	Set objRegraComercial = ##Class(VAR.util.FATRegrasComerciais).%New(codProcedimento, codPlanoSaude, pCodAtendimento, pSeqAtendimento)
	If ('$IsObject(objRegraComercial)) Return '$$$OK
	;
	Set codUnidade = ""
	If (codProfissional '= "") {
		Set objMEDProviderAgendaHorario = ""
		If (codProfissional '= "" && (horadeAtendimento '= "") && (datadeAtendimento '= "")) {
			Set objMEDProviderAgendaHorario = $Get(^MEDProviderAgendaHorario(YM, codProfissional, datadeAtendimento, horadeAtendimento, 1))
		}
		Set referenciaPai = $$$MEDProviderAgendaHorarioReferenciaPai(objMEDProviderAgendaHorario)
		Set objMEDProviderAgenda = ""
		If (referenciaPai '= "") {
			Set objMEDProviderAgenda = $Get(^MEDProviderAgenda(YM, codProfissional, referenciaPai, 1))
		}
		Set codUnidade	= $$$MEDProviderAgendaUnidade(objMEDProviderAgenda)
	}ElseIf (codSala '= ""){
		Set objVARSalasAtendimentos = $Get(^VARSalasAtendimentos(0, codSala, 1))
		Set codUnidade	= $$$VARSalasAtendimentosUnidade(objVARSalasAtendimentos)
	}Else{
		Set codUnidade = 1
	}
	Set objWWW0121 = $Get(^WWW0121(0,0,codUnidade,1))
	Set codOrganizacao = $$$WWW0121Organizacao(objWWW0121)
	Do objRegraComercial.recDadosExecutante(codOrganizacao)
	;
	;If (rObjGuiaConsulta.contratadoExecutante = "") {
	If (rObjGuiaConsulta.contratadoExecutante.%IsNull()) {
		Set objContrExecutante = ##Class(VAR.TISS.guiaConsultaContratadoExecutante).%New()
		;Set objContrExecutante.cnpjContratado = ..imprimirConteudo(objRegraComercial.CodigoExecutante)
		If ($Length(objRegraComercial.CodigoExecutante)=14) {
			Set objContrExecutante.cnpjContratado	= ..imprimirConteudo(objRegraComercial.CodigoExecutante)
		}else{
			Set objContrExecutante.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComercial.CodigoExecutante)
		}
		Set objContrExecutante.nomeContratado = ..imprimirConteudo(objRegraComercial.NomeExecutante)
		Set objContrExecutante.numeroCNES = ..imprimirConteudo(objRegraComercial.CNESExecutante)
		Set rObjGuiaConsulta.contratadoExecutante = objContrExecutante
	}
	;
	;If (codProfissional '= "" && (rObjGuiaConsulta.profissionalExecutante = "")) {
	If (codProfissional '= "" && (rObjGuiaConsulta.profissionalExecutante.%IsNull())) {
		Set objProfExecutante = ##Class(VAR.TISS.guiaConsultaProfissionalExecutante).%New()
		Set objProfissional = $Get(^MEDProvider(YM, codProfissional, 1)) 
		Set numConselho = $$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfissional))
		Set numConselho = $$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSCONSELHO~"_numConselho)
		If (numConselho = "") Set numConselho = "10"
		Set objProfExecutante.nomeProfissional = ..imprimirConteudo($$$MEDProviderName(objProfissional))
		Set objProfExecutante.conselhoProfissional = ..imprimirConteudo(numConselho)
		Set objProfExecutante.numeroConselhoProfissional = ..imprimirConteudo($$$MEDProviderLicenseNumber(objProfissional))
		Set objProfExecutante.uf = ..imprimirConteudo($$SQLGetUserParamDesc^VARSQL("TERMINOLOGIAUF~"_$$$MEDProviderFREE3(objProfissional)))
		Set objProfExecutante.cbos = ..imprimirConteudo($Select($$$MEDProviderCBO(objProfissional)="":225185,1:$$$MEDProviderCBO(objProfissional)))
		Set rObjGuiaConsulta.profissionalExecutante = objProfExecutante
	}
	;
	Set rObjGuiaConsulta.indicacaoAcidente = ..imprimirConteudo(9)
	;
	;If (rObjGuiaConsulta.dadosAtendimento = "") {
	If (rObjGuiaConsulta.dadosAtendimento.%IsNull()) {
		Set objDadosAtendimento = ##Class(VAR.TISS.guiaConsultaDadosAtendimento).%New()
		Set objDadosAtendimento.dataAtendimento = ..imprimirConteudo(+dtHrAdmisao)
		Set objDadosAtendimento.tipoConsulta = ..imprimirConteudo(1) ;Orientação Patricia
		Set objProcedimento	= ##Class(VAR.TISS.guiaConsultaDadosAtendimentoProcedimento).%New()
		Set objProcedimento.codigoTabela = ..imprimirConteudo(objRegraComercial.FamiliaTISS)
		Set objProcedimento.codigoProcedimento = ..imprimirConteudo(objRegraComercial.CodigodoItem)
		If (pGlosa'="") {
			Set objProcedimento.valorProcedimento = ..imprimirConteudo($FNumber($$$FATGlosaAdmissaoValor(objFATGlosaAdmissao),"",2))
		}Else{
			Set objProcedimento.valorProcedimento = ..imprimirConteudo($FNumber(objRegraComercial.Valor,"",2))
		}
		Set objDadosAtendimento.procedimento 	= objProcedimento
		Set rObjGuiaConsulta.dadosAtendimento = objDadosAtendimento
	}
	;
	Return $$$OK]]></Implementation>
</Method>

<Method name="guiaSPSADT">
<ClassMethod>1</ClassMethod>
<FormalSpec>pNumRegANSDestino,pNumeroLote,pCodAtendimento,pSeqAtendimento,pNumeroFatura,pGuiaConvenio,pSQL,sequenciaItem,pVersaoTISS,pXGuiaCad,&amp;rObjGuiaSPSADT:VAR.TISS.guiaSPSADT,&amp;rSequenciaItem,pGlosa=""</FormalSpec>
<ProcedureBlock>1</ProcedureBlock>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	#Dim objRegraComerCompont As VAR.util.FATRegrasComerciais;
	
	Kill tempContProduto
	
	
	Set YM 	= 0
	Set Y 	= "~"
	;
	If (pGlosa '= "") {
		Set objVARAgendamento 	= $Get(^VARAgendamento(YM, pCodAtendimento, 1))
		Set objFATGlosaAdmissao = $Get(^FATGlosaAdmissao(YM, pGlosa, pNumeroFatura, pSeqAtendimento, 1))
		Set xCodLote 						= $$$FATGlosaCodigoLote(^FATGlosa(YM,pGlosa,1))
		Set objFATLoteFaturas 	= $Get(^FATLoteFaturas(YM, xCodLote, pCodAtendimento, pSeqAtendimento, 1))
	}Else{
		Set objFATLoteFaturas 	= $Get(^FATLoteFaturas(YM, pNumeroLote, pCodAtendimento, pSeqAtendimento, 1))
		Set objFATGlosaAdmissao = ""
	}
	;					
	Set rObjGuiaSPSADT = ##Class(VAR.TISS.guiaSPSADT).%New()
	Set rSequenciaItem = sequenciaItem
	;
	;Set rObjGuiaSPSADT.numeroGuiaPrincipal = "012345678901234567890"
	;
	Set objCabecalho = ##Class(VAR.TISS.guiaSPSADTCabecalho).%New()
	Set objCabecalho.registroANS 					= pNumRegANSDestino
	Set objCabecalho.numeroGuiaPrestador	= pNumeroFatura
	;Set objCabecalho.dataEmissaoGuia 		= +$Horolog
	;Set objCabecalho.numeroGuiaOperadora = "123456"
	Set rObjGuiaSPSADT.cabecalhoGuia = objCabecalho
	;
	Set objVARAgendamentoGuia = ""
	If (pXGuiaCad '= "") {
		Set objVARAgendamentoGuia = $Get(^VARAgendamentoGuia(YM, pCodAtendimento, pXGuiaCad, 1))
	}
	Set dtAutorizacao = $$$VARAgendamentoGuiaDataAutorizacao(objVARAgendamentoGuia)
	Set senha 				= $$$VARAgendamentoGuiaSenha(objVARAgendamentoGuia)
	Set dtValSenha 		= $$$VARAgendamentoGuiaDatadeValidadeSenha(objVARAgendamentoGuia)
	Set numGuiaAtrOpe	= $$$VARAgendamentoGuiaNumerodaGuiaAtribuidapela(objVARAgendamentoGuia)
	Set objDadosAutorizacao = ##Class(VAR.TISS.guiaSPSADTDadosAutorizacao).%New()
	Set:numGuiaAtrOpe'="" objDadosAutorizacao.numeroGuiaOperadora = ..imprimirConteudo(numGuiaAtrOpe)
	Set:dtAutorizacao'="" objDadosAutorizacao.dataAutorizacao = ..imprimirConteudo(dtAutorizacao)
	Set:senha'="" objDadosAutorizacao.senhaAutorizacao = senha
	Set:dtValSenha'="" objDadosAutorizacao.validadeSenha = dtValSenha
	Set rObjGuiaSPSADT.dadosAutorizacao = objDadosAutorizacao
	;
	If (pGlosa '= "") {
		Set codPaciente		= $$$FATLoteFaturasCodigodoPaciente(objFATLoteFaturas)
		Set codConvenio		= $$$FATLoteFaturasConvenio(objFATLoteFaturas)
		Set codPlanoSaude	= $$$FATLoteFaturasPlanodeSaude(objFATLoteFaturas)
		Set numCarteirinha = $$$FATGlosaAdmissaoNodaCarteirinha(objFATGlosaAdmissao)
		Set dtValCart = $$$FATGlosaAdmissaoVencimentodaCarteirinha(objFATGlosaAdmissao)
	}Else{
		Set codPaciente	= $$$FATLoteFaturasCodigodoPaciente(objFATLoteFaturas)
		Set codConvenio	= $$$FATLoteFaturasConvenio(objFATLoteFaturas)
		Set codPlanoSaude	= $$$FATLoteFaturasPlanodeSaude(objFATLoteFaturas)
		Set numCarteirinha = $$$FATLoteFaturasNumerodaCarteirinha(objFATLoteFaturas)
		Set dtValCart = $$$FATLoteFaturasValidadeCarteirinha(objFATLoteFaturas)
	}
	Set numCNS = $$SQLGetPatientCNS^VARSQL(codPaciente)
	Set objDadosBeneficiario = ##Class(VAR.TISS.guiaConsultaDadosBeneficiario).%New()
	Set:numCarteirinha'="" objDadosBeneficiario.numeroCarteira = ..imprimirConteudo(numCarteirinha)
	Set objDadosBeneficiario.atendimentoRN = ..imprimirConteudo("N")
	Set objDadosBeneficiario.nomeBeneficiario = ..imprimirConteudo($$SQLGetPatientName^VARSQL(codPaciente))
	;Set objDadosBeneficiario.nomePlano = $$GetOrganizacaoNome^VARSQL(codPlanoSaude)
	;Set:dtValCart'="" objDadosBeneficiario.validadeCarteira = dtValCart
	Set:numCNS'="" objDadosBeneficiario.numeroCNS = ..imprimirConteudo(numCNS)
	;Set objDadosBeneficiario.identificaoBeneficiario = ""	
	Set rObjGuiaSPSADT.dadosBeneficiario = objDadosBeneficiario
	;
	Kill tempOutrasDespesas
	Set (valorProcedimentos, valorTaxasAlugueis, valorMateriais, valorOPME) = 0
	Set (valorMedicamentos, valorGasesMedicinais, valorDiarias, valorTotalGeral) = 0	
	;
	;if (pNumeroFatura = "22/0000000021") {
	;	W "<br>aqui"i"
	;	W "<br>"_pSQL	}	
	Set rSet = ##Class(%SQL.Statement).%ExecDirect("",pSQL)
	While rSet.%Next() {
		Set codProcedimento 	= rSet.%Get("Procedimento")

		Set totalProcedimento = $Select(+rSet.%Get("TotalProcedimento")<=0:1,1:+rSet.%Get("TotalProcedimento"))
		If (pGlosa '= "") {
			Set seqAtendimento		= rSet.%Get("SequenciaProcedimento")
		}Else{
			Set seqAtendimento		= rSet.%Get("SequenciadeAtendimento")
		}
		;
		Set objVARAgendamentoProcedimentos = $Get(^VARAgendamentoProcedimentos(YM, pCodAtendimento, seqAtendimento, 1))
		Set codProfissional			= $$$VARAgendamentoProcedimentosProfissional(objVARAgendamentoProcedimentos)
		Set codProfSolicitante	= $$$VARAgendamentoProcedimentosSolicitante(objVARAgendamentoProcedimentos)
		Set dtHrAdmisao					= $$$VARAgendamentoProcedimentosDataHoraAdmissao(objVARAgendamentoProcedimentos)
		Set codSala							= $$$VARAgendamentoProcedimentosCodigodaSala(objVARAgendamentoProcedimentos)
		Set horadeAtendimento		= $$$VARAgendamentoProcedimentosHoraAtendimento(objVARAgendamentoProcedimentos)
		Set datadeAtendimento		= $$$VARAgendamentoProcedimentosDataAtendimento(objVARAgendamentoProcedimentos)
		;
		Set xControleAdm				= $$$VARAgendamentoProcedimentosControleAdmissao(objVARAgendamentoProcedimentos)
		If (xControleAdm '= "" && ($$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1))) '= "")) {
			Set dtHrAdmisao		= $$$VARAgendamentoAdmissaoCriadoData($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))_","_$$$VARAgendamentoAdmissaoCriadoHora($Get(^VARAgendamentoAdmissao(YM, xControleAdm, 1)))
		}
		;
		S ^zzJULION($now()) = codProcedimento_"|"_codPlanoSaude_"|"_pCodAtendimento_"|"_pSeqAtendimento
		Set objRegraComercial = ##Class(VAR.util.FATRegrasComerciais).%New(codProcedimento, codPlanoSaude, pCodAtendimento, pSeqAtendimento)
		If ('$IsObject(objRegraComercial)) Continue
		;
		;If (rObjGuiaSPSADT.dadosSolicitante = "") {
		If (rObjGuiaSPSADT.dadosSolicitante.%IsNull()) {
			Set codUnidade = ""
			If (codProfissional '= "") {
				Set objMEDProviderAgendaHorario = ""
				If (codProfissional '= "" && (horadeAtendimento '= "") && (datadeAtendimento '= "")) {
					Set objMEDProviderAgendaHorario = $Get(^MEDProviderAgendaHorario(YM, codProfissional, datadeAtendimento, horadeAtendimento, 1))
				}
				Set referenciaPai = $$$MEDProviderAgendaHorarioReferenciaPai(objMEDProviderAgendaHorario)
				Set objMEDProviderAgenda = ""
				If (referenciaPai '= "") {
					Set objMEDProviderAgenda = $Get(^MEDProviderAgenda(YM, codProfissional, referenciaPai, 1))
				}
				Set codUnidade	= $$$MEDProviderAgendaUnidade(objMEDProviderAgenda)
			}ElseIf (codSala '= ""){
				Set objVARSalasAtendimentos = $Get(^VARSalasAtendimentos(0, codSala, 1))
				Set codUnidade	= $$$VARSalasAtendimentosUnidade(objVARSalasAtendimentos)
			}Else{
				Set codUnidade = 1
			}
			Set objWWW0121 = $Get(^WWW0121(0,0,codUnidade,1))
			Set codOrganizacao = $$$WWW0121Organizacao(objWWW0121)
			Do objRegraComercial.recDadosExecutante(codOrganizacao)
			;
			Set objDadosSolicitante = ##Class(VAR.TISS.guiaSPSADTDadosSolicitante).%New()
			Set objContratado = ##Class(VAR.TISS.guiaSPSADTDadosSolicitanteContratado).%New()
			
			;W "|"_..imprimirConteudo(objRegraComercial.CodigoExecutante)_"|"
			If ($Length(objRegraComercial.CodigoExecutante)=14) {
				Set objContratado.cnpjContratado	= ..imprimirConteudo(objRegraComercial.CodigoExecutante)
			}else{
				Set objContratado.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComercial.CodigoExecutante)
			}
			Set objContratado.nomeContratado	= ..imprimirConteudo(objRegraComercial.NomeExecutante)
			If (codProfSolicitante '= "") {
				Set objProfSolicitante = $Get(^MEDProvider(YM, codProfSolicitante, 1)) 
				Set numConselho = $$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfSolicitante))
				Set numConselho = $$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSCONSELHO~"_numConselho)
				If (numConselho = "") Set numConselho = "10"
				Set objProfissionalSolicitante = ##Class(VAR.TISS.guiaConsultaProfissionalExecutante).%New()
				Set objProfissionalSolicitante.nomeProfissional = ..imprimirConteudo($$$MEDProviderName(objProfSolicitante))
				Set objProfissionalSolicitante.conselhoProfissional = ..imprimirConteudo(numConselho)
				Set objProfissionalSolicitante.numeroConselhoProfissional = ..imprimirConteudo($$$MEDProviderLicenseNumber(objProfSolicitante))
				Set objProfissionalSolicitante.uf = ..imprimirConteudo($$SQLGetUserParamDesc^VARSQL("TERMINOLOGIAUF~"_$$$MEDProviderFREE3(objProfSolicitante)))
				Set objProfissionalSolicitante.cbos = ..imprimirConteudo($Select($$$MEDProviderCBO(objProfSolicitante)="":225185,1:$$$MEDProviderCBO(objProfSolicitante)))
				Set objDadosSolicitante.profissional 	= objProfissionalSolicitante
			}
			Set objDadosSolicitante.contratado 	= objContratado
			Set rObjGuiaSPSADT.dadosSolicitante = objDadosSolicitante
		}
		;
		;If (rObjGuiaSPSADT.dadosSolicitacao = "") {
		If (rObjGuiaSPSADT.dadosSolicitacao.%IsNull()) {
			Set objDadosSolicitacao = ##Class(VAR.TISS.guiaSPSADTDadosSolicitacao).%New()
			Set objDadosSolicitacao.caraterAtendimento = ..imprimirConteudo(1)
			Set rObjGuiaSPSADT.dadosSolicitacao = objDadosSolicitacao
		}
		;
		;If (rObjGuiaSPSADT.dadosExecutante = "") {
		If (rObjGuiaSPSADT.dadosExecutante.%IsNull()) {
			Set objDadosExecutante = ##Class(VAR.TISS.guiaSPSADTDadosExecutante).%New()
			Set objDadosExecutanteIdent = ##Class(VAR.TISS.guiaSPSADTDadosExecutanteIdentificacao).%New()
			;Set objDadosExecutanteIdent.cnpjContratado = ..imprimirConteudo(objRegraComercial.CodigoExecutante)
			If ($Length(objRegraComercial.CodigoExecutante)=14) {
				Set objDadosExecutanteIdent.cnpjContratado	= ..imprimirConteudo(objRegraComercial.CodigoExecutante)
			}else{
				Set objDadosExecutanteIdent.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComercial.CodigoExecutante)
			}
			Set objDadosExecutanteIdent.nomeContratado = ..imprimirConteudo(objRegraComercial.NomeExecutante)
			Set objDadosExecutante.identificacao = objDadosExecutanteIdent
			Set objDadosExecutante.CNES = ..imprimirConteudo(objRegraComercial.CNESExecutante)
			Set rObjGuiaSPSADT.dadosExecutante = objDadosExecutante
		}
		;
		;If (rObjGuiaSPSADT.dadosAtendimento = "") {
		If (rObjGuiaSPSADT.dadosAtendimento.%IsNull()) {
			Set objDadosAtendimento = ##Class(VAR.TISS.guiaSPSADTDadosAtendimento).%New()
			Set objDadosAtendimento.tipoAtendimento = ..imprimirConteudo(objRegraComercial.TipoDeAtendimento)
			Set objDadosAtendimento.indicacaoAcidente = ..imprimirConteudo(9)
			Set rObjGuiaSPSADT.dadosAtendimento = objDadosAtendimento
		}
		;
		Set objItem = ##Class(VAR.TISS.procedimentoExecutado).%New()
		
		If ($Data(tempContProduto(objRegraComercial.CodigodoItem_"|"_objRegraComercial.DescricaoDoItem))) {
			Set objItem = rObjGuiaSPSADT.procedimentosRealizados.GetAt(tempContProduto(objRegraComercial.CodigodoItem_"|"_objRegraComercial.DescricaoDoItem))
			;w "<br>"_objItem
		}else{
			Set sequenciaItem = sequenciaItem + 1
			Set rSequenciaItem = sequenciaItem
		}		
		
		Set objProcedimento	= ##Class(VAR.TISS.procedimento).%New()
		Set objProcedimento.codigoTabela 					= ..imprimirConteudo(objRegraComercial.FamiliaTISS)
		Set objProcedimento.codigoProcedimento 		= ..imprimirConteudo(objRegraComercial.CodigodoItem)
		Set objProcedimento.descricaoProcedimento = ..imprimirConteudo(objRegraComercial.DescricaoDoItem)
		Set objItem.procedimento 				= objProcedimento
		If ($Replace(pVersaoTISS,".","") > 30301) {
			If ('$Data(tempContProduto(objRegraComercial.CodigodoItem_"|"_objRegraComercial.DescricaoDoItem))) {
				Set objItem.sequenciaItem				= ..imprimirConteudo($Extract("000",1,(3-$Length(sequenciaItem)))_sequenciaItem)
			}
		}
		Set objItem.data 								= ..imprimirConteudo(+dtHrAdmisao)
		Set objItem.horaInicial 				= ..imprimirConteudo($Piece(dtHrAdmisao,",",2))
		;w "<br>"_objRegraComercial.CodigodoItem_"|"_objItem.quantidadeExecutada_"|"_totalProcedimento
		Set objItem.quantidadeExecutada = ..imprimirConteudo(objItem.quantidadeExecutada + totalProcedimento)
		Set objItem.reducaoAcrescimo		= ..imprimirConteudo($FNumber(1.00,"",2))
		If (pGlosa '= "") {
			Set objItem.valor								= ..imprimirConteudo($FNumber($$$FATGlosaAdmissaoValor(objFATGlosaAdmissao),"",2))
			Set objItem.valorTotal					= ..imprimirConteudo($FNumber($$$FATGlosaAdmissaoValor(objFATGlosaAdmissao) * totalProcedimento,"",2))
			Set valorProcedimentos = valorProcedimentos + ($$$FATGlosaAdmissaoValor(objFATGlosaAdmissao) * totalProcedimento)
		}Else{
			Set objItem.valor								= ..imprimirConteudo($FNumber(objRegraComercial.Valor,"",2))
			Set objItem.valorTotal					= ..imprimirConteudo($FNumber(objItem.valorTotal + (objRegraComercial.Valor * totalProcedimento),"",2))
			Set valorProcedimentos = valorProcedimentos + (objRegraComercial.Valor * totalProcedimento)
		}
		;
		If (codProfissional '= "") {
			Set objEquipeSADT = ##Class(VAR.TISS.guiaConsultaProfissionalExecutante).%New()
			Set objProfissional = $Get(^MEDProvider(YM, codProfissional, 1)) 
			Set numConselho = $$SQLGetUserParamDesc^VARSQL("VARMEDCONSELHO~"_$$$MEDProviderFREE2(objProfissional))
			Set numConselho = $$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSCONSELHO~"_numConselho)
			If (numConselho = "") Set numConselho = "10"
			Set objEquipeSADT.grauPart = ..imprimirConteudo(12)
			Set objProfNaOperadora = ##Class(VAR.TISS.guiaConsultaProfissionalExecutanteCodOperadora).%New()
			If (objRegraComercial.IdentificacaoRecebedorNaFontePagadora '= "") {
				Set objProfNaOperadora.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComercial.IdentificacaoRecebedorNaFontePagadora) 
				Set objEquipeSADT.codProfissional = objProfNaOperadora
			}Else{
				Set objEquipeSADT.cpfContratado = ..imprimirConteudo($$$MEDProviderProviderNo(objProfissional))
			}
			Set objEquipeSADT.nomeProf = ..imprimirConteudo($$$MEDProviderName(objProfSolicitante))
			Set objEquipeSADT.conselho = ..imprimirConteudo(numConselho)
			Set objEquipeSADT.numeroConselhoProfissional = ..imprimirConteudo($$$MEDProviderLicenseNumber(objProfSolicitante))
			Set objEquipeSADT.uf = ..imprimirConteudo($$SQLGetUserParamDesc^VARSQL("TERMINOLOGIAUF~"_$$$MEDProviderFREE3(objProfSolicitante)))
			Set objEquipeSADT.cbos = ..imprimirConteudo($Select($$$MEDProviderCBO(objProfSolicitante)="":225185,1:$$$MEDProviderCBO(objProfSolicitante)))
			Set objItem.equipeSadt = objEquipeSADT
		}
		;
		;Tratamento de Outras Despesas
		For count = 1 : 1 : objRegraComercial.Componentes.Count() {
			Set objRegraComerCompont = objRegraComercial.Componentes.GetAt(count)
			If (objRegraComerCompont.isInelegivel = 1) Continue
			
			If (pGlosa '= "") {
				Set objFATGlosaAdmissaoComp = $Get(^FATGlosaAdmissaoComp(YM, pGlosa, pNumeroFatura, seqAtendimento, objRegraComerCompont.Procedimento, 1))	
				If ($$$FATGlosaAdmissaoCompDesconsiderar(objFATGlosaAdmissaoComp)) {
					Continue	
				}
				Set qtdeSolicitada = $$$FATGlosaAdmissaoCompQtdedoProcedimento(objFATGlosaAdmissaoComp)	
				Set valorProc = $$$FATGlosaAdmissaoCompValordoProcedimento(objFATGlosaAdmissaoComp)	
			}Else{
				If ($Data(^VARAgendamentoItensDesc(1,pCodAtendimento, seqAtendimento,objRegraComerCompont.Procedimento))) Continue 
				Set qtdeSolicitada = objRegraComerCompont.Quantidade
				If ($Data(^VARAgendamentoItensQtdeAlterada(1,pCodAtendimento,seqAtendimento,objRegraComerCompont.Procedimento))){
					Set qtdeAlterada = $Piece(^VARAgendamentoItensQtdeAlterada(1,pCodAtendimento,seqAtendimento,objRegraComerCompont.Procedimento,1),"~",1)
					Set qtdeSolicitada = qtdeAlterada	
				} 
			}
	
			Set codigoDespesa = ""
			;13/01/2022 
			;if (objRegraComerCompont.CategoriaTISS'="PROCEDIMENTOS") Continue
			;W "<br>"_count_"|"_objProcedimento.codigoProcedimento_"|"_objRegraComerCompont.Procedimento_"|"_objRegraComerCompont.CodigodoItem_"|"_objRegraComerCompont.CategoriaTISS
			If (objRegraComerCompont.CategoriaTISS = "TAXAS") {
				Set codigoDespesa = "07"
				Set valorTaxasAlugueis = valorTaxasAlugueis + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			If (objRegraComerCompont.CategoriaTISS = "MATERIAIS") {
				Set codigoDespesa = "03"
				Set valorMateriais = valorMateriais + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			If (objRegraComerCompont.CategoriaTISS = "OPME") {
				Set codigoDespesa = "08"
				Set valorOPME = valorOPME + ((qtdeSolicitada ]]><![CDATA[* totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			If (objRegraComerCompont.CategoriaTISS = "MEDICAMENTOS") {
				Set codigoDespesa = "02"
				Set valorMedicamentos = valorMedicamentos + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			If (objRegraComerCompont.CategoriaTISS = "GASES") {
				Set codigoDespesa = "01"
				Set valorGasesMedicinais = valorGasesMedicinais + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			If (objRegraComerCompont.CategoriaTISS = "DIARIAS") {
				Set codigoDespesa = "05"
				Set valorDiarias = valorDiarias + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))
			}
			;13/01/2022
			If (objRegraComerCompont.CategoriaTISS = "PROCEDIMENTOS") {
				;W "<br>****Aqui****<br>"
				Set sequenciaItem = sequenciaItem + 1
				Set rSequenciaItem = sequenciaItem
				Set xObjItem = ##Class(VAR.TISS.procedimentoExecutado).%New()
				Set xObjProcedimento	= ##Class(VAR.TISS.procedimento).%New()
				Set xObjProcedimento.codigoTabela 					= ..imprimirConteudo(objRegraComerCompont.FamiliaTISS)
				Set xObjProcedimento.codigoProcedimento 		= ..imprimirConteudo(objRegraComerCompont.CodigodoItem)
				Set xObjProcedimento.descricaoProcedimento 	= ..imprimirConteudo(objRegraComerCompont.DescricaoDoItem)
				Set xObjItem.procedimento 									= xObjProcedimento
				If ($Replace(pVersaoTISS,".","") > 30301) {
					Set xObjItem.sequenciaItem			= ..imprimirConteudo($Extract("000",1,(3-$Length(sequenciaItem)))_sequenciaItem)
				}
				Set xObjItem.data 								= ..imprimirConteudo(+dtHrAdmisao)
				Set xObjItem.horaInicial 					= ..imprimirConteudo($Piece(dtHrAdmisao,",",2))
				Set xObjItem.quantidadeExecutada 	= ..imprimirConteudo(totalProcedimento)
				Set xObjItem.reducaoAcrescimo			= ..imprimirConteudo($FNumber(1.00,"",2))
				Set xObjItem.valor								= ..imprimirConteudo($FNumber(objRegraComerCompont.Valor,"",2))
				Set xObjItem.valorTotal						= ..imprimirConteudo($FNumber(objRegraComerCompont.Valor * totalProcedimento,"",2))
				Set valorProcedimentos = valorProcedimentos + (objRegraComerCompont.Valor * totalProcedimento)
				;
				If (codProfissional '= "") {
					Set xObjEquipeSADT = ##Class(VAR.TISS.guiaConsultaProfissionalExecutante).%New()
					Set xObjEquipeSADT.grauPart = ..imprimirConteudo(12)
					Set xObjProfNaOperadora = ##Class(VAR.TISS.guiaConsultaProfissionalExecutanteCodOperadora).%New()
					If (objRegraComerCompont.IdentificacaoRecebedorNaFontePagadora '= "") {
						Set xObjProfNaOperadora.codigoPrestadorNaOperadora = ""_..imprimirConteudo(objRegraComerCompont.IdentificacaoRecebedorNaFontePagadora) 
						Set xObjEquipeSADT.codProfissional = xObjProfNaOperadora
					}Else{
						Set xObjEquipeSADT.cpfContratado = ..imprimirConteudo($$$MEDProviderProviderNo(objProfissional))
					}
					Set xObjEquipeSADT.nomeProf = ..imprimirConteudo($$$MEDProviderName(objProfSolicitante))
					Set xObjEquipeSADT.conselho = ..imprimirConteudo(numConselho)
					Set xObjEquipeSADT.numeroConselhoProfissional = ..imprimirConteudo($$$MEDProviderLicenseNumber(objProfSolicitante))
					Set xObjEquipeSADT.uf = ..imprimirConteudo($$SQLGetUserParamDesc^VARSQL("TERMINOLOGIAUF~"_$$$MEDProviderFREE3(objProfSolicitante)))
					Set xObjEquipeSADT.cbos = ..imprimirConteudo($Select($$$MEDProviderCBO(objProfSolicitante)="":225185,1:$$$MEDProviderCBO(objProfSolicitante)))
					Set xObjItem.equipeSadt = objEquipeSADT
				}
				;W "<br>****"_xObjItem_"<br>"
				Do rObjGuiaSPSADT.procedimentosRealizados.SetAt(xObjItem, rObjGuiaSPSADT.procedimentosRealizados.Count()+1)
				Continue
				;Set codigoDespesa = "9999"
				;Set valorDiarias = valorDiarias + ((qtdeSolicitada * totalProcedimento) * $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor))

			}
			If ($Data(tempOutrasDespesas(objRegraComerCompont.Procedimento))) {
				Set objeto = tempOutrasDespesas(objRegraComerCompont.Procedimento)
				Set $Piece(objeto,Y,5) = $Piece(objeto,Y,5) + (qtdeSolicitada * totalProcedimento)
				Continue	
			}
			Set objeto = ""
			Set $Piece(objeto,Y,1) = codigoDespesa
			Set $Piece(objeto,Y,2) = +dtHrAdmisao
			Set $Piece(objeto,Y,3) = objRegraComerCompont.FamiliaTISS
			Set $Piece(objeto,Y,4) = objRegraComerCompont.CodigodoItem
			Set $Piece(objeto,Y,5) = (objRegraComerCompont.Quantidade * totalProcedimento)
			Set $Piece(objeto,Y,6) = $$SQLGetUserParamDesc^VARSQL("TABELADOMINIOANSUNIDADEMEDICA~"_$Replace(objRegraComerCompont.UnidadeMedida," ",""))
			Set $Piece(objeto,Y,7) = 1.00
			Set $Piece(objeto,Y,8) = $Select(pGlosa'= "":valorProc,1:objRegraComerCompont.Valor)
			Set $Piece(objeto,Y,9) = objRegraComerCompont.DescricaoDoItem
			Set tempOutrasDespesas(objRegraComerCompont.Procedimento) = objeto
		}
		;
		If (+objItem.valor>0) {
			If ($Data(tempContProduto(objRegraComercial.CodigodoItem_"|"_objRegraComercial.DescricaoDoItem))) {
				Do rObjGuiaSPSADT.procedimentosRealizados.SetAt(objItem, tempContProduto(objRegraComercial.CodigodoItem_"|"_objRegraComercial.DescricaoDoItem))
			}Else{
				Set tempContProduto(objItem.procedimento.codigoProcedimento_"|"_objRegraComercial.DescricaoDoItem) = (rObjGuiaSPSADT.procedimentosRealizados.Count()+1)
				Do rObjGuiaSPSADT.procedimentosRealizados.SetAt(objItem, rObjGuiaSPSADT.procedimentosRealizados.Count()+1)
			}
		}
		Continue	
	}
	;
	If ($Data(tempOutrasDespesas)) {
		Set objOutrasDespesas = ##Class(VAR.TISS.guiaSPSADTDespesas).%New()
		Set codProcedimento = ""
		For {
			Set codProcedimento = $Order(tempOutrasDespesas(codProcedimento))	
			Quit:codProcedimento=""
		
			Set sequenciaItem = sequenciaItem + 1
			Set rSequenciaItem = sequenciaItem
			
			Set objDespesas = ##Class(VAR.TISS.despesa).%New()
			If ($Replace(pVersaoTISS,".","") > 30301) {
				Set objDespesas.sequencialItem = ..imprimirConteudo($Extract("000",1,(3-$Length(sequenciaItem)))_sequenciaItem)
			}
			Set objDespesas.codigoDespesa = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,1))
			Set objServicoExecutado = ##CLass(VAR.TISS.despesaServicoExecutado).%New()
			Set objServicoExecutado.dataExecucao = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,2))
			Set objServicoExecutado.codigoTabela = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,3))
			Set objServicoExecutado.codigoProcedimento = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,4))
			Set objServicoExecutado.quantidadeExecutada = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,5))
			Set objServicoExecutado.unidadeMedida = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,6))
			Set objServicoExecutado.reducaoAcrescimo = ..imprimirConteudo($FNumber($Piece(tempOutrasDespesas(codProcedimento),Y,7),"",2))
			Set objServicoExecutado.valorUnitario = ..imprimirConteudo($FNumber($Piece(tempOutrasDespesas(codProcedimento),Y,8),"",2))
			Set objServicoExecutado.valorTotal = ..imprimirConteudo($FNumber($Piece(tempOutrasDespesas(codProcedimento),Y,5)*$Piece(tempOutrasDespesas(codProcedimento),Y,8),"",2))
			Set objServicoExecutado.descricaoProcedimento = ..imprimirConteudo($Piece(tempOutrasDespesas(codProcedimento),Y,9))
			Set objDespesas.servicosExecutados = objServicoExecutado
			Do rObjGuiaSPSADT.outrasDespesas.SetAt(objDespesas, rObjGuiaSPSADT.outrasDespesas.Count()+1)
		}
	}
	;
	Set objValores = ##Class(VAR.TISS.guiaSPSADTValorTotal).%New()
	Set objValores.valorProcedimentos = ..imprimirConteudo($FNumber(valorProcedimentos,"",2))
	Set:valorTaxasAlugueis>0 objValores.valorTaxasAlugueis = ..imprimirConteudo($FNumber(valorTaxasAlugueis,"",2))
	Set:valorMateriais>0 objValores.valorMateriais = ..imprimirConteudo($FNumber(valorMateriais,"",2))
	Set:valorOPME>0 objValores.valorOPME = ..imprimirConteudo($FNumber(valorOPME,"",2))
	Set:valorMedicamentos>0 objValores.valorMedicamentos = ..imprimirConteudo($FNumber(valorMedicamentos,"",2))
	Set:valorGasesMedicinais>0 objValores.valorGasesMedicinais= ..imprimirConteudo($FNumber(valorGasesMedicinais,"",2))
	Set:valorDiarias>0 objValores.valorDiarias= ..imprimirConteudo($FNumber(valorDiarias,"",2))
	Set objValores.valorTotalGeral = ..imprimirConteudo($FNumber(valorProcedimentos + valorTaxasAlugueis + valorMateriais + valorOPME + valorMedicamentos + valorGasesMedicinais + valorDiarias,"",2))
	Set rObjGuiaSPSADT.valorTotal = objValores
	;
	Return $$$OK]]></Implementation>
</Method>

<Method name="gerarHash">
<ClassMethod>1</ClassMethod>
<FormalSpec>pConteudo</FormalSpec>
<Implementation><![CDATA[	Set md5hash 		= $system.Encryption.MD5Hash(pConteudo)
 	Set md5HashHex 	= ""
	For count = 1 : 1 : $Length(md5hash) { 
		Set result = $Zhex($Ascii($Extract(md5hash,count)))
		If ($Length(result)=1) Set result = "0"_result
		Set md5HashHex = md5HashHex _ result
	}
	Return $ZConvert(md5HashHex,"L")]]></Implementation>
</Method>

<Method name="imprimirConteudo">
<ClassMethod>1</ClassMethod>
<FormalSpec>pConteudo,pTipo=""</FormalSpec>
<Implementation><![CDATA[	Return $Translate($ZConvert(pConteudo,"U"),"ÁÉÍÓÚÀÈÌÒÙÃÕÂÊÎÔÛÄËÏÖÜÇ","AEIOUAEIOUAOAEIOUAEIOUC")]]></Implementation>
</Method>
</Class>
</Export>