<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="Cache" ts="2001-01-01 00:00:00">
<Class name="VAR.CSP.VARContrAtendAplicMedicamento">
<ClassType/>
<IncludeCode>MEDConst,VARConst</IncludeCode>
<ProcedureBlock>1</ProcedureBlock>
<Super>%CSP.Page</Super>

<Method name="OnPage">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[	do ^WWWVAR
	;	
	set method = $get(%request.Data("method",1))
	xecute "do .."_method_"()"
	quit $$$OK]]></Implementation>
</Method>

<Method name="GetProntuario">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 	= 0
	set Y 	= "~"

	set listRetorno = {}
	
	set pCodProntuario 	= $get(%request.Data("pCodProntuario",1))
	set objProntuario 	= $get(^VARProntuarioEletronico(YM, pCodProntuario, 1))	
	if (objProntuario '= "") {
		set codPaciente 		= $$$VARProntuarioEletronicoPaciente(objProntuario)
		set criadoEm				= $$$VARProntuarioEletronicoCriadoEm(objProntuario)
		set numAdmissao			= $$$VARProntuarioEletronicoNumeroAdmisao(objProntuario)
		;
		set objMEDAdmission	= $get(^MEDAdmission(YM, numAdmissao, 1))
		;
		If ($$$MEDAdmissionPatient(objMEDAdmission) '= codPaciente) {
			set codPaciente		= $$$MEDAdmissionPatient(objMEDAdmission)
		}
		;
		Set numProntuario 	= $$SQLGetPatientProntuario^VARSQL(codPaciente)
		;
		Set objMEDPatient = $Get(^MEDPatient(0, codPaciente, 1))
		;
		set nomePaciente		= $$SQLGetPatientName^VARSQL(codPaciente)
		set dataNascimento	= $$SQLGetPatientDataNascimento^VARSQL(codPaciente)
		set qtdeAnos				= $$SQLGetPatientAge^VARSQL(dataNascimento)
		set qtdeMeses				= $$SQLGetPatientMonth^VARSQL(dataNascimento)
		set sexo						= $$SQLGetSexoPaciente^VARSQL(codPaciente)
		;
		set codSala					= $$$MEDAdmissionRoom(objMEDAdmission)			
		set codLeito				= $$$MEDAdmissionBed(objMEDAdmission)
		;
		set (descSala, dataSourceLeito) = ""
		If (codSala '= "") {
			set objSala					= $get(^VARSalasAtendimentos(YM,codSala,1))
			set descSala 				= $$$VARSalasAtendimentosNome(objSala)
			;
			set dataSourceLeito = ##Class(VAR.CSP.VARContrAtendQuimioterapico).GetLeitos(codSala, codLeito)
		}
		;
		set objPEPAplic 								= $get(^VARPEPAplicacaoMedicamento(YM, pCodProntuario, 1))
		set diagnostico 								= $$$VARPEPAplicacaoMedicamentoDiagnostico(objPEPAplic)
		set aplicMedicamentosPerdSa 		= $$$VARPEPAplicacaoMedicamentoAplicMedicamentosPerdSa(objPEPAplic)
		set aplicMedicamentosBariatr 		= $$$VARPEPAplicacaoMedicamentoAplicMedicamentosBariatr(objPEPAplic)
		set aplicMedicamentosOutrosD509 = $$$VARPEPAplicacaoMedicamentoAplicMedicamentosOutrosD(objPEPAplic)
		set aplicMedicamentosOutros 		= $$$VARPEPAplicacaoMedicamentoAplicMedicamentosOutros(objPEPAplic)
		set aplicMedicamentosAlerta			= $$$VARPEPAplicacaoMedicamentoAplicMedicamentosAlerta(objPEPAplic)
		set diagnosticoSecundario				= $$$VARPEPAplicacaoMedicamentoDiagnosticoSecundario(objPEPAplic)
		set medicoExterno								= $$$VARPEPAplicacaoMedicamentoMedicoExterno(objPEPAplic)
		;
		set nomeMedicamento = $$$VARPEPAplicacaoMedicamentoReacaoMedicamento(objPEPAplic)
		set nomeFabriacente = $$$VARPEPAplicacaoMedicamentoReacaoFabricante(objPEPAplic)
		set dataInicio = $$$VARPEPAplicacaoMedicamentoReacaoDataInicio(objPEPAplic)
		set dataAparecimento = $$$VARPEPAplicacaoMedicamentoReacaoDataAparecimento(objPEPAplic)
		set reacaoMedLote = $$$VARPEPAplicacaoMedicamentoReacaoLote(objPEPAplic)
		set reacaoMedValidad = $$$VARPEPAplicacaoMedicamentoReacaoValidade(objPEPAplic)
		set reacaoMedPeso = $$$VARPEPAplicacaoMedicamentoReacaoPeso(objPEPAplic)
		set reacaoMedAlt = $$$VARPEPAplicacaoMedicamentoReacaoAlt(objPEPAplic)
		set medicacoesAntes = $$$VARPEPAplicacaoMedicamentoReacaoJaRecebeuMedicament(objPEPAplic)
		set medicacoesAntesFreq = $$$VARPEPAplicacaoMedicamentoReacaoFrequenciaMedicamen(objPEPAplic)
		set medicacosAntesFreqEsp = $$$VARPEPAplicacaoMedicamentoReacaoFrequenciaEspecificacao(objPEPAplic)
		set gotejamento = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusao(objPEPAplic)
		set diluicao1 = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoDil1(objPEPAplic)
		set diluicao2 = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoDil2(objPEPAplic)
		set gotejamentoSF = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoSF(objPEPAplic)
		set bolus = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInjecao(objPEPAplic)
		set bolusDuracao = $$$VARPEPAplicacaoMedicamentoReacaoModAplicInjecaoD(objPEPAplic)
		set intramoscular = $$$VARPEPAplicacaoMedicamentoReacaoModAplicIntra(objPEPAplic)
		set intramoscularDuracao = $$$VARPEPAplicacaoMedicamentoReacaoModAplicIntraD(objPEPAplic)
		set oral = $$$VARPEPAplicacaoMedicamentoReacaoModAplicOral(objPEPAplic)
		set oralPosologia = $$$VARPEPAplicacaoMedicamentoReacaoModAplicOralPosologia(objPEPAplic)
		set ingestao = $$$VARPEPAplicacaoMedicamentoReacaoIngestao(objPEPAplic)
		set sinaisSintomas = $$$VARPEPAplicacaoMedicamentoReacaoSinaiseSintomas(objPEPAplic)
		set irritante = $$$VARPEPAplicacaoMedicamentoReacaoIncidenteIrritante(objPEPAplic)
		set vesicante = $$$VARPEPAplicacaoMedicamentoReacaoIncidenteVesicante(objPEPAplic)
		set incidenteLocalNao = $$$VARPEPAplicacaoMedicamentoReacaoIncidenteExtravasam(objPEPAplic)
		set incidenteLocal = $$$VARPEPAplicacaoMedicamentoReacaoIncidenteDescricao(objPEPAplic)
		set compressaQuente = $$$VARPEPAplicacaoMedicamentoReacaoCompressaQuente(objPEPAplic)
		set compressaFria = $$$VARPEPAplicacaoMedicamentoReacaoCompressaFria(objPEPAplic)
		set compressaNao = $$$VARPEPAplicacaoMedicamentoReacaoCompressaNaoUtiliza(objPEPAplic)
		set alergia = $$$VARPEPAplicacaoMedicamentoAlergia(objPEPAplic)
		set condutaAcompanhamento = $$$VARPEPAplicacaoMedicamentoReacaoCondutaeAcompanham(objPEPAplic)
		set conclusao = $$$VARPEPAplicacaoMedicamentoReacaoConclusao(objPEPAplic)
		set historico = $$$VARPEPAplicacaoMedicamentoReacaoHistorico(objPEPAplic)
		set medico = $$$VARPEPAplicacaoMedicamentoReacaoMedico(objPEPAplic)
		set termoResp = $$$VARPEPAplicacaoMedicamentoTermoResp(objPEPAplic)
		set termoRespQuem = $$$VARPEPAplicacaoMedicamentoTermoRespQuem(objPEPAplic)
		set termoRespQuando = $$$VARPEPAplicacaoMedicamentoTermoRespQuando(objPEPAplic)
		;
		set arrayDiagnostico = []
		for i=1:1:$length(diagnostico,";") {
			if ($piece(diagnostico,";",i)="") continue
			do arrayDiagnostico.%Push($piece(diagnostico,";",i))
		}
		;
		set arrayDiagnosticoSecundario = []
		for i=1:1:$length(diagnosticoSecundario,";") {
			if ($piece(diagnosticoSecundario,";",i)="") continue
			do arrayDiagnosticoSecundario.%Push($piece(diagnosticoSecundario,";",i))
		}
		;
		set listRetorno.dataHora 					= $zdatetime(criadoEm,4,2)
		set listRetorno.codPaciente 			= numProntuario
		set listRetorno.paciente 					= nomePaciente
		set listRetorno.dataNascimento 		= $zdate(dataNascimento,4,,4)
		set listRetorno.idade							= qtdeAnos
		set listRetorno.sexo							= sexo
		set listRetorno.codSala						= descSala
		set listRetorno.dSLeito						= dataSourceLeito
		set listRetorno.codLeito					= codLeito
		set listRetorno.diagnostico				= arrayDiagnostico
		set listRetorno.diagnosticoSecundario	= arrayDiagnosticoSecundario
		Set listRetorno.medicoExterno			= medicoExterno
		;
		do listRetorno.%Set("aplicMedicamentosPerdSa", aplicMedicamentosPerdSa, "number")
		do listRetorno.%Set("aplicMedicamentosBariatr", aplicMedicamentosBariatr, "number")
		do listRetorno.%Set("aplicMedicamentosOutrosD509", aplicMedicamentosOutrosD509, "number")
		set listRetorno.aplicMedicamentosOutros			= aplicMedicamentosOutros
		set listRetorno.aplicMedicamentosAlerta			= aplicMedicamentosAlerta
		//
		set listRetorno.nomeMedicamento = nomeMedicamento
		set listRetorno.nomeFabriacente = nomeFabriacente
		set listRetorno.dataInicio = $Select(dataInicio="":"",1:$Zdate(dataInicio,3))
		set listRetorno.dataAparecimento = $Select(dataAparecimento="":"",1:$Zdate(dataAparecimento,3))
		set listRetorno.reacaoMedLote = reacaoMedLote
		set listRetorno.reacaoMedValidad = $Select(reacaoMedValidad="":"",1:$Zdate(reacaoMedValidad,3))
		set listRetorno.reacaoMedPeso = reacaoMedPeso
		set listRetorno.reacaoMedAlt = reacaoMedAlt
		set listRetorno.medicacoesAntes = medicacoesAntes
		set listRetorno.medicacoesAntesFreq = medicacoesAntesFreq
		set listRetorno.medicacosAntesFreqEsp = medicacosAntesFreqEsp
		set listRetorno.gotejamento = gotejamento
		set listRetorno.diluicao1 = diluicao1
		set listRetorno.diluicao2 = diluicao2
		set listRetorno.gotejamentoSF = gotejamentoSF
		set listRetorno.bolus = bolus
		set listRetorno.bolusDuracao = bolusDuracao
		set listRetorno.intramoscular = intramoscular
		set listRetorno.intramoscularDuracao = intramoscularDuracao
		set listRetorno.oral = oral
		set listRetorno.oralPosologia = oralPosologia
		set listRetorno.ingestao = ingestao
		set listRetorno.sinaisSintomas = sinaisSintomas
		set listRetorno.irritante = irritante
		set listRetorno.vesicante = vesicante
		set listRetorno.incidenteLocalNao = incidenteLocalNao
		set listRetorno.incidenteLocal = incidenteLocal
		set listRetorno.compressaQuente = compressaQuente
		set listRetorno.compressaFria = compressaFria
		set listRetorno.compressaNao = compressaNao
		;
		If ($$$MEDPatientAlergia(objMEDPatient) '= "") {
			Set listRetorno.alergia			= $$$MEDPatientAlergia(objMEDPatient)
			Set listRetorno.alergiaAQue	= $$$MEDPatientAllergies(objMEDPatient)
		}Else{
			If ($$$MEDPatientAllergies(objMEDPatient) = "") Set listRetorno.alergia = 0
			Else  Set listRetorno.alergia = "1"
			Set listRetorno.alergiaAQue	= $$$MEDPatientAllergies(objMEDPatient)
		}
		;set listRetorno.alergia = alergia
		;
		set listRetorno.condutaAcompanhamento = condutaAcompanhamento
		set listRetorno.conclusao = conclusao
		set listRetorno.historico = historico
		set listRetorno.medico = medico
		set listRetorno.termoResp = termoResp
		set listRetorno.termoRespQuem = termoRespQuem
		set listRetorno.termoRespQuando = $S(termoRespQuando'="":$zd(termoRespQuando,3),1:"")
		//
		;
	}
	do listRetorno.%ToJSON()
	
	quit $$$OK]]></Implementation>
</Method>

<Method name="AlteraLeito">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 		= 0
	set Y 		= "~"
	set erro 	= ""
	try{
		set pCodProntuario 	= $get(%request.Data("pCodProntuario",1))
		set pAdmissao				= $get(%request.Data("pAdmissao",1))
		set pCodLeito				= $get(%request.Data("pCodLeito",1))
	
		&sql( Select Sala, Leito Into :CodSala, :CodLeito From SQLUser.VARPEPLeitoAtendimento
			 		Where Company = :YM And Prontuario = :pCodProntuario)
	
		if (SQLCODE '= 0) {
			set erro = "Erro ao checar a Sala Atual."
			quit
		}

		if (CodLeito = pCodLeito) quit
		
		set prontuarioLeito = ""
		&sql(Select Prontuario Into :prontuarioLeito From SQLUser.VARPEPLeitoAtendimento
				 Where Company = :YM And Sala = :CodSala And Leito = :pCodLeito)
	
		if (prontuarioLeito '= "") {
			set erro = "Leito já ocupado "_prontuarioLeito_"."
			quit
		}
		
		set objMEDAdmission	= $get(^MEDAdmission(YM, pAdmissao, 1))
		set $$$MEDAdmissionBed(objMEDAdmission) = pCodLeito
		set strStatus = $$$Save("MEDAdmission", pAdmissao, objMEDAdmission, $$$YES)
		
		if (strStatus = $$$OK) {
			set objLeitoAtendimento = $get(^VARPEPLeitoAtendimento(YM,CodSala,CodLeito,1))
			set strStatus = $$$Kill("VARPEPLeitoAtendimento", CodSala_$$$COMMA_CodLeito)
			set strStatus = $$$Save("VARPEPLeitoAtendimento", CodSala_$$$COMMA_pCodLeito, objLeitoAtendimento, $$$YES)
		}
	
	}
	catch(err){
		#dim err as %Exception.SystemException
		set strStatus = err.DisplayString()
		set erro			=	err
	}	
	set objRetorno = {}
	if erro=""{
		set objRetorno.status = $$$OK
	}else{
		set objRetorno.status = erro
	}
		
	do objRetorno.%ToJSON()
	
	quit $$$OK]]></Implementation>
</Method>

<Method name="ArmProntuario">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 	= 0
	set Y 	= "~"

	tstart
	set strStatus	=	""
	set erro			=	0
	try{

		set YBED = $get(%request.Data("YBED",1))
		set pCodProntuario = $get(%request.Data("pCodProntuario",1))
		set pAdmissao = $get(%request.Data("pAdmissao",1))
		;
		set objMEDAdmission	= $get(^MEDAdmission(YM, pAdmissao, 1))
		set codPaciente		= $$$MEDAdmissionPatient(objMEDAdmission)
		if $$$MEDAdmissionDateDischarged(objMEDAdmission) 	'= ""{
			set erro = 1
			set strStatus = "Passagem já finalizada!"
			quit
		}

		set objPEPAplic = $get(^VARPEPAplicacaoMedicamento(YM, pCodProntuario, 1))
		set pDiagnostico = $get(%request.Data("pDiagnostico",1))
		set pAlergia 		= $get(%request.Data("pAlergia",1))
		set pSelAlergia	= $get(%request.Data("pSelAlergia",1))
		if (pDiagnostico '= "") set pDiagnostico = $replace(pDiagnostico,",",";")
		set $$$VARPEPAplicacaoMedicamentoDiagnostico(objPEPAplic)	= pDiagnostico
		set pDiagnosticoSecundario = $get(%request.Data("pDiagnosticoSecundario",1))
		if (pDiagnosticoSecundario '= "") set pDiagnosticoSecundario = $replace(pDiagnosticoSecundario,",",";")
		;
		set pAplicMedicamentosPerdSa 			= $get(%request.Data("pAplicMedicamentosPerdSa",1))
		set pAplicMedicamentosBariatr 		= $get(%request.Data("pAplicMedicamentosBariatr",1))
		set pAplicMedicamentosOutrosD509 	= $get(%request.Data("pAplicMedicamentosOutrosD509",1)) 
		if (pAplicMedicamentosPerdSa '= "") set pAplicMedicamentosPerdSa = $select(pAplicMedicamentosPerdSa="true"||(pAplicMedicamentosPerdSa=1):1,1:0)
		if (pAplicMedicamentosBariatr '= "") set pAplicMedicamentosBariatr = $select(pAplicMedicamentosBariatr="true"||(pAplicMedicamentosBariatr=1):1,1:0)
		if (pAplicMedicamentosOutrosD509 '= "") set pAplicMedicamentosOutrosD509 = $select(pAplicMedicamentosOutrosD509="true"||(pAplicMedicamentosOutrosD509=1):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoAplicMedicamentosPerdSa(objPEPAplic)			= pAplicMedicamentosPerdSa
		set $$$VARPEPAplicacaoMedicamentoAplicMedicamentosBariatr(objPEPAplic)		= pAplicMedicamentosBariatr
		set $$$VARPEPAplicacaoMedicamentoAplicMedicamentosOutrosD(objPEPAplic)	= pAplicMedicamentosOutrosD509
		set $$$VARPEPAplicacaoMedicamentoAplicMedicamentosOutros(objPEPAplic)			= $get(%request.Data("pAplicMedicamentosOutros",1))
		set $$$VARPEPAplicacaoMedicamentoAplicMedicamentosAlerta(objPEPAplic)			= $get(%request.Data("pAplicMedicamentosAlerta",1))
		set $$$VARPEPAplicacaoMedicamentoDiagnosticoSecundario(objPEPAplic)	= pDiagnosticoSecundario
		set $$$VARPEPAplicacaoMedicamentoAlergia(objPEPAplic)	= pAlergia
		set $$$VARPEPAplicacaoMedicamentoMedicoExterno(objPEPAplic)	= $get(%request.Data("pMedicoExterno",1))
		;
		set $$$VARPEPAplicacaoMedicamentoReacaoMedicamento(objPEPAplic)	= $Get(%request.Data("pNomeMedicamento",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoFabricante(objPEPAplic)	= $Get(%request.Data("pNomeFabriacente",1))
		Set pDataInicio = $Get(%request.Data("pDataInicio",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoDataInicio(objPEPAplic)	= $Select(pDataInicio'="":$ZDATEH(pDataInicio,4),1:"")
		Set pDataAparecimento = $Get(%request.Data("pDataAparecimento",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoDataAparecimento(objPEPAplic) = $Select(pDataAparecimento'="":$ZDATEH(pDataAparecimento,4),1:"")
		set $$$VARPEPAplicacaoMedicamentoReacaoLote(objPEPAplic)	= $Get(%request.Data("pReacaoMedLote",1))
		Set pReacaoMedValidad = $Get(%request.Data("pReacaoMedValidad",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoValidade(objPEPAplic)	= $Select(pReacaoMedValidad'="":$ZDATEH(pReacaoMedValidad,4),1:"")
		set $$$VARPEPAplicacaoMedicamentoReacaoPeso(objPEPAplic)	= $Get(%request.Data("pReacaoMedPeso",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoAlt(objPEPAplic)	= $Get(%request.Data("pReacaoMedAlt",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoJaRecebeuMedicament(objPEPAplic)	= $Get(%request.Data("pMedicacoesAntes",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoFrequenciaMedicamen(objPEPAplic)	= $Get(%request.Data("pMedicacoesAntesFreq",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoFrequenciaEspecificacao(objPEPAplic)	= $Get(%request.Data("pMedicacosAntesFreqEsp",1))
		Set pGotejamento = $Get(%request.Data("pGotejamento",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusao(objPEPAplic)	= $Select(pGotejamento="":"",(pGotejamento="true"||(pGotejamento=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoDil1(objPEPAplic)	= $Get(%request.Data("pDiluicao1",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoDil2(objPEPAplic)	= $Get(%request.Data("pDiluicao2",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInfusaoSF(objPEPAplic)	= $Get(%request.Data("pGotejamentoSF",1))
		Set pBolus = $Get(%request.Data("pBolus",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInjecao(objPEPAplic)	= $Select(pBolus="":"",(pBolus="true"||(pBolus=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicInjecaoD(objPEPAplic) = $Get(%request.Data("pBolusDuracao",1))
		Set pIntramoscular = $Get(%request.Data("pIntramoscular",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicIntra(objPEPAplic)	= $Select(pIntramoscular="":"",(pIntramoscular="true"||(pIntramoscular=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicIntraD(objPEPAplic)	= $Get(%request.Data("pIntramoscularDuracao",1))
		Set pOral = $Get(%request.Data("pOral",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicOral(objPEPAplic)	= $Select(pOral="":"",(pOral="true"||(pOral=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoModAplicOralPosologia(objPEPAplic)	= $Get(%request.Data("pOralPosologia",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoIngestao(objPEPAplic)	= $Get(%request.Data("pIngestao",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoSinaiseSintomas(objPEPAplic)	= $Get(%request.Data("pSinaisSintomas",1))
		Set pIrritante = $Get(%request.Data("pIrritante",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoIncidenteIrritante(objPEPAplic)	= $Select(pIrritante="":"",(pIrritante="true"||(pIrritante=1)):1,1:0)
		Set pVesicante = $Get(%request.Data("pVesicante",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoIncidenteVesicante(objPEPAplic)	= $Select(pVesicante="":"",(pVesicante="true"||(pVesicante=1)):1,1:0)
		Set pIncidenteLocalNao = $Get(%request.Data("pIncidenteLocalNao",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoIncidenteExtravasam(objPEPAplic)	= $Select(pIncidenteLocalNao="":"",(pIncidenteLocalNao="true"||(pIncidenteLocalNao=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoIncidenteDescricao(objPEPAplic)	= $Get(%request.Data("pIncidenteLocal",1))
		Set pCompressaQuente = $Get(%request.Data("pCompressaQuente",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoCompressaQuente(objPEPAplic)	= $Select(pCompressaQuente="":"",(pCompressaQuente="true"||(pCompressaQuente=1)):1,1:0)
		Set pCompressaFria = $Get(%request.Data("pCompressaFria",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoCompressaFria(objPEPAplic)	= $Select(pCompressaFria="":"",(pCompressaFria="true"||(pCompressaFria=1)):1,1:0)
		Set pCompressaNao = $Get(%request.Data("pCompressaNao",1))
		set $$$VARPEPAplicacaoMedicamentoReacaoCompressaNaoUtiliza(objPEPAplic)	= $Select(pCompressaNao="":"",(pCompressaNao="true"||(pCompressaNao=1)):1,1:0)
		set $$$VARPEPAplicacaoMedicamentoReacaoCondutaeAcompanham(objPEPAplic)	= $replace($Get(%request.Data("pCondutaAcompanhamento",1)),"~"," ")
		set $$$VARPEPAplicacaoMedicamentoReacaoConclusao(objPEPAplic)			= $replace($Get(%request.Data("pConclusao",1)),"~"," ")
		set $$$VARPEPAplicacaoMedicamentoReacaoHistorico(objPEPAplic)			= $replace($Get(%request.Data("pHistorico",1)),"~"," ")
		set $$$VARPEPAplicacaoMedicamentoReacaoMedico(objPEPAplic)			= $Get(%request.Data("pMedico",1))
		set $$$VARPEPAplicacaoMedicamentoTermoRespQuem(objPEPAplic) = $Get(%request.Data("pTermoRespQuem",1))
		set pTermoRespQuando = $Get(%request.Data("pTermoRespQuando",1))
		set $$$VARPEPAplicacaoMedicamentoTermoRespQuando(objPEPAplic) = $S(pTermoRespQuando'="":$zdh(pTermoRespQuando,4),1:"")
		;
		set strStatus	=	$$$Save("VARPEPAplicacaoMedicamento", pCodProntuario, objPEPAplic, $$$YES)
		;
		Set objMEDPatient = $Get(^MEDPatient(0, codPaciente, 1))
		If (pSelAlergia '= $$$MEDPatientAlergia(objMEDPatient) || (pAlergia '= $$$MEDPatientAllergies(objMEDPatient))) {
			set $$$MEDPatientAlergia(objMEDPatient) 	= pSelAlergia
			set $$$MEDPatientAllergies(objMEDPatient) = pAlergia
			set strStatus	=	$$$Save("MEDPatient", codPaciente, objMEDPatient, $$$YES)
		}
	}
	catch(err){
		#dim err as %Exception.SystemException
		set strStatus = err.DisplayString()
		set erro	=	err
	}
	set retorno = {}
	if 'erro{
		tcommit
		set retorno.status = strStatus
	}else{
		trollback
		set retorno.status = strStatus
	}
	do retorno.%ToJSON()
	quit $$$OK]]></Implementation>
</Method>

<Method name="GetAplicMedicamento">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 	= 0
	set Y 	= "~"

	set pCodProntuario = $get(%request.Data("pCodProntuario",1))
	set pItem = $get(%request.Data("pItem",1))
	
	Set objProntuario = $get(^VARProntuarioEletronico(YM, pCodProntuario, 1))	
	Set codPaciente 	= $$$VARProntuarioEletronicoPaciente(objProntuario)
	
	set contador = 0
	set meuSQL($increment(contador))	= "Select Dados.Item, Dados.Sequencia, Dados.Data, Dados.Hora, "
	set meuSQL($increment(contador))	= "Dados.PressaoArterial, Dados.Pulso, Dados.Temperatura,"
	set meuSQL($increment(contador))	= "Dados.Reacao, Dados.Alergia, Dados.TipodeAlergia, Dados.Funcionario, "
	set meuSQL($increment(contador))	= "$$SQLGetProviderName^VARSQL(Dados.Funcionario) As FuncionarioNome,"
	set meuSQL($increment(contador))	= "Item.Medicamento, "
	set meuSQL($increment(contador))	= "$$SQLGetDescricaoProduto^VARSQL(Item.Medicamento) As MedicacaoDesc,"
	set meuSQL($increment(contador))	= "Item.Quantidade, Item.SF, Item.TempodeInfusao, Item.ViadeInfusao,"
	set meuSQL($increment(contador))	= "Item.Lote, Item.Validade, Dados.SequenciaLivre, Adm.Status"
	set meuSQL($increment(contador))	= "FROM SQLUser.MEDAdmission As Adm"
	set meuSQL($increment(contador))	= "INNER JOIN SQLUser.VARProntuarioEletronico AS PEP ON PEP.NumeroAdmisao = Adm.AdmissionID"
	set meuSQL($increment(contador))	= "INNER JOIN SQLUser.VARPEPAplicacaoMedicamentoDados AS Dados ON PEP.Codigo = Dados.CodigoProntuarioEletronic"
	set meuSQL($increment(contador))	= "INNER JOIN SQLUser.VARPEPAplicacaoMedicamentoItem AS Item ON PEP.Codigo = Item.CodigoProntuarioEletronic AND Dados.Item = Item.Item"
	set meuSQL($increment(contador))	= "WHERE Adm.Company = 0"
	set meuSQL($increment(contador))	= "AND PEP.Codigo = '"_pCodProntuario_"'"
	set:pItem'="" meuSQL($increment(contador))	= "AND Dados.Item = '"_pItem_"'"
	set meuSQL($increment(contador))	= "UNION"
	set meuSQL($increment(contador))	= "SELECT NULL,NULL, DataAgendamento, HoraAgendamento,NULL,NULL,NULL,NULL,NULL,NULL,"
	set meuSQL($increment(contador))	= "NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,AdmissionID,Status"
	set meuSQL($increment(contador))	= "FROM SQLUser.MEDAdmission"
	set meuSQL($increment(contador))	= "WHERE Company = 0 AND Patient = '"_codPaciente_"'"
	set meuSQL($increment(contador))	= "AND DataAgendamento = CURRENT_DATE-1"
	set meuSQL($increment(contador))	= "AND Status = 4 AND DateAdmitted IS NULL"
	set meuSQL 			= $order(meuSQL(""),-1)
	set rSet 			 	= ##class(%SQL.Statement).%ExecDirect("",.meuSQL)
	set objRetorno 	= []
	
	while(rSet.%Next()){
		set list = {}
		
		if rSet.%Get("Item")'="" {
			set list.item	= rSet.%Get("Item")_" | Medicamento: "_rSet.%Get("MedicacaoDesc") _ 
										  " | Lote: "_rSet.%Get("Lote")_" | Validade: "_rSet.%Get("Validade") _
										  " | Quantidade: "_rSet.%Get("Quantidade")_" | Solução: "_rSet.%Get("SF") _
										  " | Via de Infusao: "_rSet.%Get("ViadeInfusao") _ 
										  " | Tempo de Infusao: "_rSet.%Get("TempodeInfusao")
		} else {
			set list.item	= "NC" ; NC (Não Compareceu)
		}
		
		set list.sequencia					= rSet.%Get("Sequencia")
		set list.sequenciaLivre			= rSet.%Get("SequenciaLivre")
		set list.data 							= $select(rSet.%Get("Data")'="":$zdate(rSet.%Get("Data"),2),1:"")
		set list.hora 							= $select(rSet.%Get("Hora")'="":$ztime(rSet.%Get("Hora"),2),1:"")
		set list.pressaoArterial 		= rSet.%Get("PressaoArterial")
		set list.pulso 							= rSet.%Get("Pulso")
		set list.temperatura 				= rSet.%Get("Temperatura")
		//set list.medicacao 					= rSet.%Get("Medicacao")
		//set list.medicacaoDesc 			= rSet.%Get("MedicacaoDesc")
		//set list.qtde 							= rSet.%Get("Qtde")
		//set list.solucaoFisiologica = rSet.%Get("SolucaoFisiologica")
		set list.reacao 						= rSet.%Get("Reacao")
		set list.alergia 						= rSet.%Get("Alergia")
		set list.tipoAlergia 				= rSet.%Get("TipodeAlergia")
		set list.funcionario 				= rSet.%Get("Funcionario")
		set list.funcionarioNome 		= $S(rSet.%Get("Funcionario")'="":"("_rSet.%Get("Funcionario")_") "_rSet.%Get("FuncionarioNome"),1:"")
		set list.status							= rSet.%Get("Status")
		
		do objRetorno.%Push(list)
	
	}
	
	do objRetorno.%ToJSON()
	
	quit $$$OK]]></Implementation>
</Method>

<Method name="ArmAplicMedicamento">
<ClassMethod>1</ClassMethod>
<FormalSpec>pCodProntuario,pItem,pSequencia,pDados,YBED</FormalSpec>
<Implementation><![CDATA[	$$$VAR
	set YM = 0
	set Y	 = "~"
	
	if (pSequencia = "") {
		set pSequencia = $order(^VARPEPAplicacaoMedicamentoDados(YM, pCodProntuario, pItem, ""),-1) + 1
	}
	
	set objAplicMedic = $get(^VARPEPAplicacaoMedicamentoDados(YM, pCodProntuario, pItem, pSequencia, 1))

	set index = "" 
	for {
		set index = $order(pDados(index)) 
		quit:index=""
		
		set coluna	= $piece(pDados(index),"~",1)
		set valor		= $piece(pDados(index),"~",2)

		if (coluna = "data") {
			If (valor = "") {
				set $$$VARPEPAplicacaoMedicamentoDadosData(objAplicMedic) = $zdateh($piece(valor," ",2,4),7,,,,,,,+$h)
			}else{
				set $$$VARPEPAplicacaoMedicamentoDadosData(objAplicMedic) = +$H
			}
		}
		if (coluna = "hora") set $$$VARPEPAplicacaoMedicamentoDadosHora(objAplicMedic) = $ztimeh(valor,4,$piece($horolog,",",2))
		if (coluna = "pressaoArterial") {
			set valor = $Replace(valor,"_","") 
			set $$$VARPEPAplicacaoMedicamentoDadosPressaoArterial(objAplicMedic) = valor
		}
		if (coluna = "pulso") set $$$VARPEPAplicacaoMedicamentoDadosPulso(objAplicMedic) = valor
		if (coluna = "temperatura") set $$$VARPEPAplicacaoMedicamentoDadosTemperatura(objAplicMedic) = valor
		if (coluna = "medicacao") set $$$VARPEPAplicacaoMedicamentoDadosMedicacao(objAplicMedic) = valor
		if (coluna = "qtde") set $$$VARPEPAplicacaoMedicamentoDadosQtde(objAplicMedic) = valor
		if (coluna = "solucaoFisiologica") set $$$VARPEPAplicacaoMedicamentoDadosSolucaoFisiologica(objAplicMedic) = valor
		if (coluna = "reacao") set $$$VARPEPAplicacaoMedicamentoDadosReacao(objAplicMedic) = valor
		if (coluna = "alergia") set $$$VARPEPAplicacaoMedicamentoDadosAlergia(objAplicMedic) = valor
		if (coluna = "tipoAlergia") set $$$VARPEPAplicacaoMedicamentoDadosTipodeAlergia(objAplicMedic) = valor
		if (coluna = "funcionario") set $$$VARPEPAplicacaoMedicamentoDadosFuncionario(objAplicMedic) = valor
		if (coluna = "sequenciaLivre") set $$$VARPEPAplicacaoMedicamentoDadosSequenciaLivre(objAplicMedic) = valor
	}
	If ($$$VARPEPAplicacaoMedicamentoDadosData(objAplicMedic) = "") {
		set $$$VARPEPAplicacaoMedicamentoDadosData(objAplicMedic) = +$H	
	}
	If ($$$VARPEPAplicacaoMedicamentoDadosAlergia(objAplicMedic) = 0) {
		set $$$VARPEPAplicacaoMedicamentoDadosTipodeAlergia(objAplicMedic) = ""	
	}

	quit $$$Save("VARPEPAplicacaoMedicamentoDados",pCodProntuario_$$$COMMA_pItem_$$$COMMA_pSequencia,objAplicMedic,$$$YES)]]></Implementation>
</Method>

<Method name="ExcluirAplicMedicamento">
<ClassMethod>1</ClassMethod>
<FormalSpec>pCodProntuario,pItem,pSequencia,pDados,YBED</FormalSpec>
<Implementation><![CDATA[	$$$VAR
	set YM = 0
	set Y	 = "~"

	quit $$$Kill("VARPEPAplicacaoMedicamentoDados",pCodProntuario_$$$COMMA_pItem_$$$COMMA_pSequencia)]]></Implementation>
</Method>

<Method name="GetItem">
<Description><![CDATA[///////////////////////////]]></Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 	= 0
	set Y 	= "~"

	set pCodProntuario = $get(%request.Data("pCodProntuario",1))
	
	set contador = 0
	set meuSQL($increment(contador))	= "Select Item From sqlUSER.VARPEPAplicacaoMedicamentoItem "
	set meuSQL($increment(contador))	= "Where Company = 0 And CodigoProntuarioEletronic = '"_pCodProntuario_"'"	
	
	set meuSQL 			= $order(meuSQL(""),-1)
	set rSet 			 	= ##class(%SQL.Statement).%ExecDirect("",.meuSQL)
	set objRetorno 	= []
	
	while(rSet.%Next()){
		
		set list = {}
		set list.item	= rSet.%Get("Item")
		
		do objRetorno.%Push(list)
	
	}
	
	do objRetorno.%ToJSON()
	
	quit $$$OK]]></Implementation>
</Method>

<Method name="ArmItem">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	set YM 	= 0
	set Y 	= "~"

	tstart
	set strStatus	=	""
	set erro			=	0
	try{
		set pCodProntuario = $get(%request.Data("pCodProntuario",1))
		set pItem = $get(%request.Data("pItem",1))
		set pMedicamento = $get(%request.Data("pMedicamento",1))
		set pQtde = $get(%request.Data("pQtde",1))
		set pSF = $get(%request.Data("pSF",1))
		set pViaInfusao = $get(%request.Data("pViaInfusao",1))
		set pTempoInfusao = $get(%request.Data("pTempoInfusao",1))
		set pDataInicio = $get(%request.Data("pDataInicio",1))
		set pHoraInício = $get(%request.Data("pHoraInício",1))
		set pLote = $get(%request.Data("pLote",1))
		set pValidade = $get(%request.Data("pValidade",1))
		;	
		If (pItem = "") {
			Set pItem = $Order(^VARPEPAplicacaoMedicamentoItem(YM, pCodProntuario, ""),-1) + 1	
		}
		If (pDataInicio="") {
			Set pDataInicio = +$horolog
		}Else{
			Set pDataInicio = $zdateh(pDataInicio,4,,,,,,,+$horolog)
		}
		If (pHoraInício="") {
			Set pHoraInício = $Piece($Horolog,",",2)
		}else{
			Set pHoraInício = $ztimeh(pHoraInício,2,$Piece($Horolog,",",2))
		}
		;
		set objPEPItem = $get(^VARPEPAplicacaoMedicamentoItem(YM, pCodProntuario, pItem, 1))
		set $$$VARPEPAplicacaoMedicamentoItemMedicamento(objPEPItem) = pMedicamento
		set $$$VARPEPAplicacaoMedicamentoItemQuantidade(objPEPItem) = pQtde
		set $$$VARPEPAplicacaoMedicamentoItemSF(objPEPItem) = pSF
		set $$$VARPEPAplicacaoMedicamentoItemViadeInfusao(objPEPItem) = pViaInfusao
		set $$$VARPEPAplicacaoMedicamentoItemTempodeInfusao(objPEPItem) = pTempoInfusao
		set $$$VARPEPAplicacaoMedicamentoItemDatadeInicio(objPEPItem) = pDataInicio
		set $$$VARPEPAplicacaoMedicamentoItemHoradeInicio(objPEPItem) = pHoraInício
		set $$$VARPEPAplicacaoMedicamentoItemLote(objPEPItem) = pLote
		set $$$VARPEPAplicacaoMedicamentoItemValidade(objPEPItem) = $Select(pValidade="":"",1:$zdateh(pValidade,4,,,,,,,+$horolog))
		;
		set strStatus	=	$$$Save("VARPEPAplicacaoMedicamentoItem", pCodProntuario_$$$COMMA_pItem, objPEPItem, $$$YES)
	}
	catch(err){
		#dim err as %Exception.SystemException
		set strStatus = err.DisplayString()
		set erro	=	err
	}
	set retorno = {}
	if 'erro{
		tcommit
		set retorno.status = strStatus
	}else{
		trollback
		set retorno.status = strStatus
	}
	do retorno.%ToJSON()
	quit $$$OK]]></Implementation>
</Method>

<Method name="GetDadosItem">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	set pCodProntuario	= $get(%request.Data("pCodProntuario",1))
	set pItem 				= $get(%request.Data("pItem",1))
		
	set objPEPItem = ""
	if (pItem '= "") {
		set objPEPItem = $get(^VARPEPAplicacaoMedicamentoItem(0, pCodProntuario, pItem, 1))
	}
	Set codMedicamento = $$$VARPEPAplicacaoMedicamentoItemMedicamento(objPEPItem)
	Set descMedicamento = $$SQLGetDescricaoProduto^VARSQL(codMedicamento)
	set listRetorno = {}
	set listRetorno.medicamento = $$$VARPEPAplicacaoMedicamentoItemMedicamento(objPEPItem)
	set listRetorno.descMedicamento = descMedicamento
	set listRetorno.qtde = $$$VARPEPAplicacaoMedicamentoItemQuantidade(objPEPItem)
	set listRetorno.sf = $$$VARPEPAplicacaoMedicamentoItemSF(objPEPItem)
	set listRetorno.viadeInfusao = $$$VARPEPAplicacaoMedicamentoItemViadeInfusao(objPEPItem)
	set listRetorno.tempodeInfusao = $$$VARPEPAplicacaoMedicamentoItemTempodeInfusao(objPEPItem)
	set listRetorno.dataInicio = $Select($$$VARPEPAplicacaoMedicamentoItemDatadeInicio(objPEPItem)="":"",1:$ZD($$$VARPEPAplicacaoMedicamentoItemDatadeInicio(objPEPItem),4))
	set listRetorno.horaInicio = $Select($$$VARPEPAplicacaoMedicamentoItemHoradeInicio(objPEPItem)="":"",1:$ZT($$$VARPEPAplicacaoMedicamentoItemHoradeInicio(objPEPItem),2))
	set listRetorno.dataTermino = $Select($$$VARPEPAplicacaoMedicamentoItemDatadeTermino(objPEPItem)="":"",1:$ZD($$$VARPEPAplicacaoMedicamentoItemDatadeTermino(objPEPItem),4))
	set listRetorno.horaTermino = $Select($$$VARPEPAplicacaoMedicamentoItemHoradeTermino(objPEPItem)="":"",1:$ZT($$$VARPEPAplicacaoMedicamentoItemHoradeTermino(objPEPItem),2))
	set listRetorno.status = $Select($$$VARPEPAplicacaoMedicamentoItemDatadeTermino(objPEPItem)="":0,1:1)
	set listRetorno.lote = $$$VARPEPAplicacaoMedicamentoItemLote(objPEPItem)
	set listRetorno.validade = $Select($$$VARPEPAplicacaoMedicamentoItemValidade(objPEPItem)="":"",1:$ZD($$$VARPEPAplicacaoMedicamentoItemValidade(objPEPItem),4))
	do listRetorno.%ToJSON()

	quit $$$OK]]></Implementation>
</Method>

<Method name="ArmFinalizarItem">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	
	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))
	Set pItem 				= $Get(%request.Data("pItem",1))
	
	set objPEPItem = $get(^VARPEPAplicacaoMedicamentoItem(0, pCodProntuario, pItem, 1))
	set $$$VARPEPAplicacaoMedicamentoItemDatadeTermino(objPEPItem) = +$Horolog
	set $$$VARPEPAplicacaoMedicamentoItemHoradeTermino(objPEPItem) = $Piece($Horolog,",",2)
	;
	set strStatus	=	$$$Save("VARPEPAplicacaoMedicamentoItem", pCodProntuario_$$$COMMA_pItem, objPEPItem, $$$YES)
	
	Write strStatus
	
	Quit strStatus]]></Implementation>
</Method>

<Method name="ApagarItem">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	
	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))
	Set pItem 				= $Get(%request.Data("pItem",1))

	set strStatus	=	$$$Kill("VARPEPAplicacaoMedicamentoItem", pCodProntuario_$$$COMMA_pItem)
	
	Kill ^VARPEPAplicacaoMedicamentoDados(0, pCodProntuario, pItem)
	
	Write strStatus
	
	Quit strStatus]]></Implementation>
</Method>

<Method name="MedicamentoDados">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))

	Set meuSQL = "Select Item, Medicamento, $$SQLGetDescricaoProduto^VARSQL(Medicamento) As Descricao, Lote, "
	Set meuSQL = meuSQL _ "Validade from VARPEPAplicacaoMedicamentoItem "
	Set meuSQL = meuSQL _ "Where Company = 0 And CodigoProntuarioEletronic = '"_pCodProntuario_"' "
	Set meuSQL = meuSQL _ "Group By Medicamento, Lote, Validade"
	set rSet 			 	= ##class(%SQL.Statement).%ExecDirect("",meuSQL)
	set objRetorno 	= []
	
	while(rSet.%Next()){
		set list = {}
		set list.medicamento = rSet.%Get("Item")_"|"_rSet.%Get("Medicamento")
		set list.descricao = rSet.%Get("Descricao")
	
		Do objRetorno.%Push(list)
	
	}

	Do objRetorno.%ToJSON()

	Return $$$OK]]></Implementation>
</Method>

<Method name="RecuperaMedicamento">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))
	Set pItem 					= $Get(%request.Data("pItem",1))
	Set pCodProduto 		= $Piece(pItem,"|",2)
	Set item				 		= $Piece(pItem,"|",1)

	Set objVARPEPAplicacaoMedicamentoItem = $Get(^VARPEPAplicacaoMedicamentoItem(0, pCodProntuario, item, 1))

	Set validade = $$$VARPEPAplicacaoMedicamentoItemValidade(objVARPEPAplicacaoMedicamentoItem)
	
	Set listRetorno = {}
	Set listRetorno.lote = $$$VARPEPAplicacaoMedicamentoItemLote(objVARPEPAplicacaoMedicamentoItem)
	Set listRetorno.validade = $Select(validade'="":$Zdate(validade,3),1:"")

	Do listRetorno.%ToJSON()

	Return $$$OK]]></Implementation>
</Method>

<Method name="historicoReacao">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	Set YM 	= 0
	Set Y 	= "~"

	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))
	Set objProntuario 	= $get(^VARProntuarioEletronico(YM, pCodProntuario, 1))	
	Set codPaciente 		= $$$VARProntuarioEletronicoPaciente(objProntuario)

	Set arrayRetorno 	= []

	Set meuSQL = "Select Pront.*, Aplic.* From SQLUser.VARProntuarioEletronico As Pront, "
	Set meuSQL = meuSQL _ "SQLUser.VARPEPAplicacaoMedicamento As Aplic "
	Set meuSQL = meuSQL _ "Where Pront.Company = 0 And Aplic.Company = 0 "
	Set meuSQL = meuSQL _ "And Pront.Paciente = '"_codPaciente_"' "
	Set meuSQL = meuSQL _ "And Aplic.CodigoProntuarioEletronic = Pront.Codigo "
	Set meuSQL = meuSQL _ "Order By Pront.CriadoEm Desc "
	Set rSet 	 = ##class(%SQL.Statement).%ExecDirect("",meuSQL)
	
	While(rSet.%Next()){
		Set list = {}
		Set list.admissao = rSet.%Get("Codigo")
		Set list.dataHora = $ZDateTime(rSet.%Get("CriadoEm"),4,2)
		Set list.diagHist = rSet.%Get("ReacaoHistorico")
		Set list.diagNomeMed = $$SQLGetDescricaoProduto^VARSQL($Piece(rSet.%Get("ReacaoMedicamento"),"|",2))
		Set list.diagNomeFab = rSet.%Get("ReacaoFabricante")
		Set list.diagDtIniMed = $Select(rSet.%Get("ReacaoDataInicio")="":"",1:$ZDate(rSet.%Get("ReacaoDataInicio"),4))
		Set list.diagDtApSint = $Select(rSet.%Get("ReacaoDataAparecimento")="":"",1:$ZDate(rSet.%Get("ReacaoDataAparecimento"),4))
		Set list.diagLote = rSet.%Get("ReacaoLote")
		Set list.diagValidade = $Select(rSet.%Get("ReacaoValidade")="":"",1:$ZDate(rSet.%Get("ReacaoValidade"),4))
		Set list.diagPeso = rSet.%Get("ReacaoPeso")
		Set list.diagAlt = rSet.%Get("ReacaoAlt")
		Set list.diagJaRecMedic = $Select(rSet.%Get("ReacaoJaRecebeuMedicament")=1:"Sim",rSet.%Get("ReacaoJaRecebeuMedicament")="0":"Não",1:"")
		Set list.diagQualFreq = $Select(rSet.%Get("ReacaoFrequenciaMedicamen")="D":"Diária",rSet.%Get("ReacaoFrequenciaMedicamen")="S":"Semanal",rSet.%Get("ReacaoFrequenciaMedicamen")="M":"Mensal",rSet.%Get("ReacaoFrequenciaMedicamen")="O":"Outros",1:"")
		Set list.diagEspecfica = rSet.%Get("ReacaoFrequenciaEspecificacao")
		Set list.modApliIVInfusGotej = $Select(rSet.%Get("ReacaoModAplicInfusao")=1:"Sim",rSet.%Get("ReacaoModAplicInfusao")="0":"Não",1:"")
		Set list.modApliIVInfusGotejDiluicao = $Select(+rSet.%Get("ReacaoModAplicInfusao")=0:"",1:rSet.%Get("ReacaoModAplicInfusaoDil1")_" mL em "_rSet.%Get("ReacaoModAplicInfusaoDil2")_" mL de"_$Select(rSet.%Get("ReacaoModAplicInfusaoSF")=1:"SF 0,9%",rSet.%Get("ReacaoModAplicInfusaoSF")=2:"SG 5%",rSet.%Get("ReacaoModAplicInfusaoSF")=3:"Água destilada",1:""))
		Set list.modApliIVInfusBolus = $Select(rSet.%Get("ReacaoModAplicInjecao")=1:"Sim",rSet.%Get("ReacaoModAplicInjecao")="0":"Não",1:"")
		Set list.modApliIVInfusBolusDuracao = rSet.%Get("ReacaoModAplicInjecaoD")
		Set list.modApliIntramuscular = $Select(rSet.%Get("ReacaoModAplicIntra")=1:"Sim",rSet.%Get("ReacaoModAplicIntra")="0":"Não",1:"")
		Set list.modAplOral = $Select(rSet.%Get("ReacaoModAplicOral")=1:"Sim",rSet.%Get("ReacaoModAplicOral")="0":"Não",1:"")
		Set list.modAplOralPosilogia = rSet.%Get("ReacaoModAplicOralPosologia")
		Set list.ingestaoInfusao = rSet.%Get("ReacaoIngestao")
		Set list.sinaisSintomas = rSet.%Get("ReacaoSinaiseSintomas")
		Set list.incLocalIrritante = $Select(rSet.%Get("ReacaoIncidenteIrritante")=1:"Sim",rSet.%Get("ReacaoIncidenteIrritante")="0":"Não",1:"")
		Set list.incLocalVesicamente = $Select(rSet.%Get("ReacaoIncidenteVesicante")=1:"Sim",rSet.%Get("ReacaoIncidenteVesicante")="0":"Não",1:"")
		Set list.incLocalExtravasamento = $Select(rSet.%Get("ReacaoIncidenteExtravasam")=1:"Sim",rSet.%Get("ReacaoIncidenteExtravasam")="0":"Não",1:"")
		Set list.descricao = rSet.%Get("ReacaoIncidenteDescricao")
		Set list.usoCompQuente = $Select(rSet.%Get("ReacaoCompressaQuente")=1:"Sim",rSet.%Get("ReacaoCompressaQuente")="0":"Não",1:"")
		Set list.usoCompFria = $Select(rSet.%Get("ReacaoCompressaFria")=1:"Sim",rSet.%Get("ReacaoCompressaFria")="0":"Não",1:"")
		Set list.usoCompNaoUtil = $Select(rSet.%Get("ReacaoCompressaNaoUtiliza")=1:"Sim",rSet.%Get("ReacaoCompressaNaoUtiliza")="0":"Não",1:"")
		Set list.condAcompa = rSet.%Get("ReacaoCondutaeAcompanham")
		Set list.conclusao = rSet.%Get("ReacaoConclusao")
		Do arrayRetorno.%Push(list)
	}
	Do arrayRetorno.%ToJSON()
	Return $$$OK]]></Implementation>
</Method>

<Method name="historicoDadosVitais">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	Set YM 	= 0
	Set Y 	= "~"

	Set pCodProntuario 	= $Get(%request.Data("pCodProntuario",1))
	Set objProntuario 	= $get(^VARProntuarioEletronico(YM, pCodProntuario, 1))	
	Set codPaciente 		= $$$VARProntuarioEletronicoPaciente(objProntuario)

	Set arrayRetorno 	= []

	Set sql = "SELECT P.NumeroAdmisao,P.CriadoEm,"
					_ "A.Alergia,A.AplicMedicamentosAlerta,A.Diagnostico,A.DiagnosticoSecundario,"
					_ "I.* "
					_ "FROM SQLUser.VARProntuarioEletronico As P "
					_ "INNER JOIN SQLUser.VARPEPAplicacaoMedicamento AS A ON A.CodigoProntuarioEletronic = P.Codigo "
					_ "INNER JOIN SQLUser.VARPEPAplicacaoMedicamentoItem AS I ON I.CodigoProntuarioEletronic = P.Codigo "
					_ "WHERE A.Company = 0 AND P.Company = 0 And P.Paciente = '"_codPaciente_"' "
					_ "ORDER BY P.CriadoEm DESC"
	
	Set rSet 	 = ##class(%SQL.Statement).%ExecDirect("",sql)
	
	While(rSet.%Next()){
		Set list = {}
		Set list.admissao = rSet.%Get("NumeroAdmisao")
		Set list.dataHora = $ZDateTime(rSet.%Get("CriadoEm"),4,2)
		
		Set list.alergia = rSet.%Get("Alergia")
		Set list.alerta = rSet.%Get("AplicMedicamentosAlerta")
		Set list.diagnostico = rSet.%Get("Diagnostico")
		Set list.diagnosticoSecundario = rSet.%Get("DiagnosticoSecundario")
		
		Set list.medicamento = $S(rSet.%Get("Medicamento")'="":$$SQLGetDescricaoProduto^VARSQL(rSet.%Get("Medicamento")),1:"")
		Set list.quantidade = rSet.%Get("Quantidade")
		Set list.lote = rSet.%Get("Lote")
		Set list.validade = $S(rSet.%Get("Validade")'="":$ZD(rSet.%Get("Validade"),4),1:"")
		
		Set list.solucao = rSet.%Get("SF")
		Set list.viadeInfusao = rSet.%Get("ViadeInfusao")
		Set list.tempoInfusao = rSet.%Get("TempodeInfusao")
		
		Set dataInicio = rSet.%Get("DatadeInicio")
		Set horaInicio = rSet.%Get("HoradeInicio")
		
		if dataInicio'="", horaInicio'="" {
			Set list.datadeInicio = $ZD(dataInicio,4)_" "_$ZT(horaInicio,2)
		} elseif dataInicio'="" {
			Set list.datadeInicio = $ZD(dataInicio,4)
		} else {
			Set list.datadeInicio = ""
		}
		
		Set dataTermino = rSet.%Get("DatadeTermino")
		Set horaTermino = rSet.%Get("HoradeTermino")
		
		if dataTermino'="", horaTermino'="" {
			Set list.datadeTermino = $ZD(dataTermino,4)_" "_$ZT(horaTermino,2)
		} elseif dataTermino'="" {
			Set list.datadeTermino = $ZD(dataTermino,4)
		} else {
			Set list.datadeTermino = ""
		}
		
		Do arrayRetorno.%Push(list)
	}
	
	Do arrayRetorno.%ToJSON()
	Return $$$OK]]></Implementation>
</Method>

<Method name="recebeFileTermoResp">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[	$$$VAR
	Set YM 	= 0
	Set Y 	= "~"
	
	Set data = {}
	Set data.status = 0
	
	Set prontuario = $Get(%request.Data("pCodProntuario",1))
	Set file = $Get(%request.MimeData("fileTermoResp",1))
	
	if file {
		
		set dname = $$GetDiretorioFisico^VARBRDiretorios(0,16)
			
		if $$$isWINDOWS
		{
			if ($extract(dname, $length(dname)) '= "\") set dname = dname _ "\"
		}
		else
		{
			if ($extract(dname, $length(dname)) '= "/") set dname = dname _ "/"
		}
			
		// checa e cria se não houver, o diretorio
		if ('##class(%File).DirectoryExists(dname)) {
			do ##class(%File).CreateDirectoryChain(dname)
		}
		
		//nome do arquivo
		set fname = file.FileName
		set fname = $piece(fname, "\", $length(fname, "\"))
		;Troca os espaços por underline
		set fname = $translate(fname, " ", "_")
		
		// alterado nome do arquivo 
		set $p(fname,".",1) = "TermoResp_" _ prontuario
		
		set caminhoFile = dname _ fname
		if $$$isWINDOWS set caminhoFile = $replace(caminhoFile,"/","\")
		else  set caminhoFile = $replace(caminhoFile,"\","/")

		// remove arquivo existente com mesmo nome
		set strStatus = ##class(%Library.File).Delete(caminhoFile)

		Set stream = ##class(%FileBinaryStream).%New()
		Set stream.Filename = caminhoFile

		do stream.CopyFrom(file)
		do stream.Flush()
		do stream.SaveStream()
		
		set dirVirtual = $$GetDiretorioVirtual^VARBRDiretorios(0,16)_"/"
		
		set objPEP = $get(^VARPEPAplicacaoMedicamento(0, prontuario, 1))
		set $$$VARPEPAplicacaoMedicamentoTermoResp(objPEP) = dirVirtual _ fname
		set strStatus	=	$$$Save("VARPEPAplicacaoMedicamento", prontuario, objPEP, $$$YES)
		
		Set data.fileName = dirVirtual _ fname
		Set data.status = strStatus
	}
	
	do data.%ToJSON()
	Return $$$OK]]></Implementation>
</Method>
</Class>
</Export>