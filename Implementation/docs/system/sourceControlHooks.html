<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />

<title>Alphalinc Software Development Environment - implementation - Export Hooks</title><style>
	.code
	{
	font-weight: normal;
	font-size: 10pt;
	font-family: Courier, Monospaced;
	}
</style></head>
<body style="font-family: Arial,Helvetica,sans-serif; font-size: 11pt;">

<p><font size="2"><a href="../index.html">[Documentation Home]</a>
	<a href="index.html">[ASDE implementation home]</a></font></p>
<h2>Alphalinc Software Development Environment - Export Hooks</h2>

<p>This is the list of all Export Hooks that have been placed on Alphalinc to automatically
	export all code and metadata (@NM forms, help, language, etc) as regular file system objects.
</p>

<p>If you want to take a look at the old list of hooks that were used before a major mechanism rewrite,
please look <a href="oldSourceControlHooks.html">here</a>.
</p>

<p>In order to prevent&nbsp;overwriting&nbsp;those files accidentally, a backup copy
is kept at the configuration/hooks folder. To migrate an existing
namespace to a new source control repository, read the <a href="../overview/namespace-migration.html">namespace migration document</a>.
</p>

<h3>Studio Hooks</h3>
<p>Studio Hooks are responsible for exporting to the file system the current artifact in Studio, whenever it is saved by the
user. The final destination and the external file name are generated by the system.

</p><ol>
	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.AlphalincBase">
		SourceControl.AlphalincBase.cls</a> - this is the base class for all SourceControl classes (common stuff, utilities).</li>

	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.Exporter">
SourceControl.Exporter.cls</a>
- this class exports all Alphalinc artifacts. Calls to its Methods are
deployed everywhere in the system, including to @NM forms and some
routines called by forms. For @NM forms, the export methods also call
WWWCOFAExportAndImport.MAC.</li>

	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.Importer">
		SourceControl.Importer.cls</a> - this class handles the transferring from the external files into Caché. Most of its Methods are 
		autonomous. Expect for a call to ImportMetadata^WWWCOFAExportAndImport.</li>

	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.StudioHook">
	SourceControl.StudioHook.cls</a> - this class is called whenever the user saves or deletes a file within Studio.</li>

	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.StudioHook">
	SourceControl.Hashtable.cls</a> - this is a helper class. Object Oriented Cache does not allow direct access to globals
	inside methods.</li>

	<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.XMLReader">
	SourceControl.XMLReader.cls</a> - the internal XMLReader that comes with InterSystems' Cachè has a very critical bug:
	it strips leading and trailing whitespaces (blanks, tabs, line feeds) from every block of class code. This leads to
	many syntax errors. The SourceControl.XMLReader.cls is almost a copy of Caché's implementation, except that it
	initializes the parser telling it to <b>preserve</b> whitespaces.</li>

<li><a href="http://localhost:1972/apps/documatic/%CSP.Documatic.cls?APP=1&amp;CLASSNAME=SourceControl.XMLFileFilter.cls">
	SourceControl.XMLFileFilter.cls</a>
- this class reads a XML file and strips all timestamps and
checksums that are generated automatically by the Cache API. The
timestamps are regenerated by Cache at every Save operation and the
checksums are changed because of that. Those changes are incompatible
with source control because they always appear as "conflicts". The
Cache API saves the file as build/XXX.tmp, then
SourceControl.XMLFileFilter.cls filters&nbsp;and saves it to
src/cls/xxxx.cls.xml. </li>

</ol>

<h3>@Net Manager Hooks</h3>

<p> The most important hook for @NM is installed in the routine <b>WWWSPEI.mac</b>. This hook replaces all the
<a href="oldSourceControlHooks.html">hooks that used to be placed on every form</a>. The object that is being saved is just
 tagged at this point. That method searches for and places the parent artifact into the export queue
 ^SourceControl("pendingExport"). Later, at the end of the onPage() method, the queue is flushed (everything exported).

The following code was placed at the end of the WWSPEI.mac:
</p>


<pre>//Exports the current @NM artifact, if necessary (YDATEI=global name)<br />do ##class(SourceControl.Exporter).TagNMArtifactByNameKey(YDATEI,$piece(YKEY,",",1))<br /></pre>


<p>&nbsp;</p><p>The following code was placed at the end of the OnPage() method of the <b>User.www.cls</b> class:
</p>


<pre>//Finish any pending exporting operations, if any<br />do ##class(SourceControl.Exporter).FlushExports()<br /> <br /></pre>


<p>The other hook is installed in <b>WWWKILL.mac</b>. When anything is
deleted, the system checks to see if
it is related to a @NM artifact. If positive, the parent artifact is
tagged and then exported. If the artifact&nbsp;being deleted is the
parent,&nbsp;the external file is then deleted. The following code was
placed near the
end of the routine (if the WWWKILL operation is successful):
</p>//Either deletes the object or exports its parent<br /><pre>do ##class(SourceControl.Exporter).DeleteArtifactByNameKey(YDATEI,$piece(YKEY,",",1))<br /></pre>





<p><b>&nbsp;</b></p><p><b>@NM Forms</b></p>
<p>No further modifications were needed.
</p>
<!--
<table border="1">
	<tr>
		<th>Type</th>
		<th>Item</th>
		<th>Location</th>
		<th>Code</th>
	</tr>

</table>
-->

<p><b>@NM Classes</b></p>
<table border="1">
	<tbody><tr>
		<th>Type</th>
		<th>Item</th>
		<th>Location</th>
		<th>Code</th>
	</tr>


	<tr>
		<td>Routine:</td>
		<td>WWW001OO.MAC</td>

		<td>NM
Class creation and compilation - Refactored the "COMPILE" routine to
call "CompileNMClass", which is also called from
##class(SourceControl.Import).CompileAllImportedFiles(). It is only
used&nbsp;when a user wants to. There are no calls to that method
anymore, since NM Classes are not compiled anymore during an import. </td>

	<td>
		CompileNMClass <br />
		also called from ##class(SourceControl.Import).CompileAllImportedFiles()
	</td>

	</tr>
	
	<tr>
		<td>Routine:</td>
		<td>WWW001OO.MAC</td>
		
		<td> The following code was added to the end of routine CREATE^WWW001OO.MAC. It is meant to be called
			whenever a user clicks on compile button or calls CREATE or CREATEALL.
		</td>
		<td>
			<p class="code">
			//Export the related Cache class to the file system if the creation was successful<br />
			if (SUCCESS) {<br />
			do ##class(SourceControl.Exporter).ExportClassByNMClass(iCLASS)<br />
			}<br />
			</p>

		</td>
	</tr>

</tbody></table>

<p><b>@NM Menus</b></p>
<p>No further modifications were needed.
</p>

<p><b>@NM Language text and language related artifacts</b>. This includes
all screens where the user might customize or change anything related to the text of forms. The
usual behavior is to call the export method for the form name whenever some attribute is added, changed or deleted.</p>
<table border="1">
	<tbody><tr>
		<th>Type</th>
		<th>Item</th>
		<th>Location</th>
		<th>Code</th>
	</tr>

<tr>
		<td>Form
		</td>
		<td>WWWLNG - translation screen
		</td>

		<td><p>This
is a rather tricky screen, because not only does it change the @NM
dictionary (^WWWDIC), but it also changes any&nbsp;of a number of @NM
artifacts, depending on what the user has clicked on in WWW120. </p>
		<p>We let the WWWSPEI hook save the general @NM artifact and place a new hook in the mac file WWWLNG1:
			</p><ol>
				<li>Default WWWLNG1.MAC routine (the one that begins)
				</li> <br />

			</ol>
		
		</td>
		<td>	<ol>
				<li> WWWLNG1.MAC - standard call to 
					"do ##class(SourceControl.Exporter).ExportNMDictionary(VON,NACH)" after we are sure
					the "to" (NACH) and "from" (VON) languages are not empty.
				</li> <br />
			</ol>

		</td>
</tr>

</tbody></table>




<p><b>Notice:</b> The metadata resulting from <i>INDRPPARA</i> is not versioned, for
	each client has its own definitions (print characteristics for reports).

	<!-- Start footer for all pages (just change the file to make it easier to have modifications) -->
	<br /><br /><br /><br />
	</p><hr />
	<span style="font-size: 9pt;">
		<p>This document is the file projectDirectory/Implementation/<b>docs/system/sourceControlHooks.html</b><br />
			Please feel free to make corrections and commit it to the repository.
		</p>
	</span>
	<!-- End footer -->
	
</body></html>