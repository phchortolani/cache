<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUFGRT" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUFGRT
#include INConst
	/*------------------------------------------------------------------------------
	; Description of Function :
	;		REKLAMATION/GARANTIE AUFG AUS AUFTRAG ANLEGEN ODER ERWEITERN
	;	UEBERTRAGEN REKLAMATION,GARANTIE AUFTRAG AUS AUFTRAG
	;	
	;	Complaint/Guarantee Order FROM ORDER CREATION OR EXTENDING TRANSFERRING COMPLAINT, WARRANTY ORDER FROM ORDER
	; 
	; Inputs : 
	;	VORG(1) POSITON
	;	VORG(4) AUFTRAG ;order 
	;	VORG(5)=0  ALS REKLAMATIONSAUFTRAG     VERKAUFSPREIS '=0  ;when 
	;	VORG(5)=1  ALS GARANTIEAUFTRAG         VERKAUFSPREIS =0   ;when 
	;	VORG(6) STORNO POSITION ANLAGEN JA/NEIN (WENN JA, ZUSÄTZLICHE ANLAGE EINER POS. MIT MINUSMENGE)
	;
	; ByRef :
	;
	;
	; Returns :
	;
	; History :
	; 06-Mar-2007	GRF		SR15461: expand commands; naked reference
	; 05-Mar-2007	RPW		SR15461: Maybe this should always be manual
	; 12-Feb-2007	JW		SR15430: Reset batch print flag.
	; 06-Feb-2007	RPW		SR15425: Always reget the sourcing methods. 
	; 30-Oct-2006	PO		SR15155: If no sourcing method detailed on original order then use manual
	; 12-Jul-2006	FIS		SR14834: do not source to stock if positive qty
	; 07-Mar-2006	GRF		Doco
	; 02-Sep-2005	JW		SR12966: INANGZW is not shared
	; 16-Jun-2005	GRF		Replace *-1 with unary minus
	; 25.02.2002	FAN
	;-----------------------------------------------------------------------------*/
	NEW AUF,POSITION,AUFG,YI,KDNR,YLINK,POS1,AUFG1,NEG
 
	SET VORG(1) = $GET(VORG(1))
	SET VORG(5) = $GET(VORG(5))
	SET VORG(6) = $GET(VORG(6))
	SET AUF     = $GET(VORG(4))    ;$PIECE(YFKEY,",",1)
	
	; vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv DISABLED BLOCK START
	;IF VORG(1)="" DO   ;WENN KEINE POS=ALLE POS  ;FIS;WENN KEINE, DANN KEINE;14.07.03;23944
	. NEW POS
	. IF AUF'="" DO
	. . SET POS=""
	. . FOR  SET POS=$ORDER(^INANGZW(YM,YUSER,POS)) QUIT:POS=""  SET VORG(1)=VORG(1)_POS_","
	; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ DISABLED BLOCK START
	
	;QUIT:VORG(1)=""  ;POSITIONEN;FIS;AUFTRAG OHNE POSITION;14.07.03;23944
	SET VORG(1)=$TRANSLATE(VORG(1),";",",")  ;POSITIONEN
	SET AUF1=$GET(^INAUF(YM,AUF,1))
	
	;SPERRE ;suspension 
	IF $PIECE(AUF1,Y,38)=1 DO  QUIT
	. DO ^WWWINFO($$^WWWTEXT(32178)_" "_AUF_" "_$$^WWWTEXT(10004))  ;GESPERRT ;DISABLED 
	
	SET AUFG=$$^WWWNEXT("INAUF")     ;NEU GARANTIE AUFTRAG ;recent guaranty order 
	
	DO
	. DO  ;25931;TYBD;18,6,2004;BITMAP FÜR INAUF1
	. . NEW YFORM,YVOR
	. . SET YA=$$^WWWSPEI("INAUF1",AUFG,$PIECE(AUF1,Y,13)_Y_$PIECE(AUF1,Y,2)_Y_Y_+$HOROLOG,1)
	. . ;SET ^INAUF1(YM,AUFG,1)=$PIECE(AUF1,Y,13)_Y_$PIECE(AUF1,Y,2)_Y_""_Y_+$H  ;TEXT~AUFTRAGSART~~AUFTRAG VOM
	. ;
	. ;MERGE ^INAUF(YM,AUFG)     = ^INAUF(YM,AUF)  ;HAUPTDATEI
	. ;DO  ;USE WWWSPEI TO SAVE;FIS;SR14834;12-Jul-2006			//SR15430 - removed unnecessary save
	. ;. NEW SATZ
	. ;. SET SATZ=$GET(^INAUF(YM,AUF,1))
	. ;. DO SAVE^WWWSPEI("INAUF",AUFG,SATZ,1)
	. 
	. SET AUFG1=$GET(^INAUF(YM,AUF,1))	//SR15430 - moved up
	. 
	. MERGE ^INAUFA(YM,AUFG)    = ^INAUFA(YM,AUF)  ;ANSCHRIFTEN
	. MERGE ^INAUFPARA(YM,AUFG) = ^INAUFPARA(YM,AUF)  ;POSITIONSGRUPPEN
	. ;IF VORG(5)=1 MERGE ^INAUFPZ(YM,AUFG)=^INAUFPZ(YM,AUF)  ;ZAHLUNSVEREINBAR
	. SET $PIECE(^INAUF(YM,AUF,1),Y,160)=AUFG_";"_$PIECE(AUFG1,Y,160)   ;VERWEIS KANN MEHRE AUFTAGE SEIN
	. //SET AUFG1=$GET(^INAUF(YM,AUFG,1))	//SR15430 - moved up
	. SET $PIECE(AUFG1,Y,300) = ""    ;26873;FAN;04-Nov-2004;PO;SR10777;Do not assign a  Virtual Order No. for RA orders.
	. SET $PIECE(AUFG1,Y,168) = AUF   ;VERWEIS ;reprimand 
	. SET $PIECE(AUFG1,Y,169) = 1     ;REKLAMMENTION
	. SET $PIECE(AUFG1,Y,60)  = ""    ;ABGESCHLOSSEN
	. SET $PIECE(AUFG1,Y,19)  = ""    ;VEREINBART LIEFERTERMIN ;time of delivery 
	. SET $PIECE(AUFG1,Y,5)   = $PIECE($HOROLOG,",",2)  ;UHRZEIT
	. SET $PIECE(AUFG1,Y,4)   = +$HOROLOG               ;DATUM ;Date
	. SET $PIECE(AUFG1,Y,41)  = +$HOROLOG   ;ERFASSUNGSDATUM
	. SET $PIECE(AUFG1,Y,14)  = YBED  ;ZUSTANDIGSMITARBEITER
	. SET $PIECE(AUFG1,Y,42)  = YBED  ;ERFASSUNGSMITARBEITER
	. SET $PIECE(AUFG1,Y,43)  = ""    ;ÃNDERUNGSDATUM
	. SET $PIECE(AUFG1,Y,44)  = ""    ;ÃNDERUNGSMITARBEITER
	. //FOR YI=38,39,40,17,78:1:102 SET $PIECE(AUFG1,Y,YI)=""  	//SR15430
	. FOR YI=38,39,40,17,78:1:102,$$$FldINAUFBatchPrint SET $PIECE(AUFG1,Y,YI)=""  ;LÖSCHEN AUFSDATEN AUS AUFG; ;Delete out of 
	. 
	. // SR15425: Always re-get the sourcing methods.
	. ;set $$$INAUFSourcingMethod(AUFG1) = $$^INAUFD342() // $$$EnumINAUFSOURCINGManual // SR15155: This is to ensure orders created prior to 1.26 have their credits sourcing method set. (Could be a data fix but all this code will be rewritten)
	. set $$$INAUFSourcingMethod(AUFG1) = $$$EnumINAUFSOURCINGManual // SR15461: Maybe this should always be manual
	. 
	. DO
	. . NEW YFORM,YVOR,OK
	. . SET OK=$$^WWWSPEI("INAUF",AUFG,AUFG1,1)
	. ;
	. ;DO ^WWWSSORT("INAUF",AUFG)      ;SORTKEY ;not needed after WWWSPEI;FIS;SR14834;12-Jul-2006
	. ;DO ^WWWSSORT("INAUF1",AUFG)    ;SORTKEY
	. DO ^WWWSSORT("INAUFA",AUFG)     ;SORTKEY
	. DO ^WWWSSORT("INAUFPARA",AUFG)  ;SORTKEY
	
	FOR YI=1:1 QUIT:$PIECE(VORG(1),",",YI)=""  DO
	. SET YI(2)=$PIECE(VORG(1),",",YI)
	. ;
	. FOR STORNO=0,1 DO  ;2 MAL (NACHLIEFERUNG UND RÜCKNAHME) ;sometimes And 
	. . IF VORG(6)'=1 QUIT:STORNO=1  ;KEINE STORNO POSITION ANLEGEN ;no put onto 
	. . FOR YI(1)=1:1 QUIT:'$DATA(^INAUFP(YM,AUFG,YI(1)))  ;NEUE POSITION
	. . ;MERGE ^INAUFP(YM,AUFG,YI(1))=^INAUFP(YM,AUF,YI(2))
	. . DO  ;USE WWWSPEI TO SAVE;FIS;SR14834;12-Jul-2006
	. . . NEW SATZ
	. . . SET SATZ=$GET(^INAUFP(YM,AUF,YI(2),1))
	. . . DO SAVE^WWWSPEI("INAUFP",AUFG_","_YI(1),SATZ,1)
	. . SET POS1=$GET(^INAUFP(YM,AUFG,YI(1),1))
	. . ;FIS;19.05.03;23532;MENGE AUS REKLAMATION (RMA)
	. . IF +$PIECE($GET(^INANGZW(YM,YUSER,YI(2),1)),Y,2)'=0 SET $PIECE(POS1,Y,5)=$PIECE(^INANGZW(YM,YUSER,YI(2),1),Y,2) ; Naked Ref SR15461
	. . FOR YI(3)=78:1:109 SET $PIECE(POS1,Y,YI(3))=""  ;LÖSCHEN AUFSDATEN AUS AUFG; ;Delete out of 
	. . FOR YI(3)=6,19,24,25,39,51,52,53,56,60,61,161,163,165,166,204,207,206,205,223,224,226,228,230,232,264,265,266,276:1:320 SET $PIECE(POS1,Y,YI(3))=""  ;LÖSCHEN AUFSDATEN AUS AUFG;  FAN;24.02.04;25127;56 "SN" EINGETRAGEN
	. . IF $PIECE(^INAUF(YM,AUFG,1),Y,2)'=2 DO           ;WENN AUFTRAGEART NICHT 2=LIEFERANTAUFTRAG ;when Not 
	. . . SET $PIECE(POS1,Y,7)=""     ;NEU FEST LEGEN WARENHERKUNFT   ;recent unyielding put down source of goods
	. . . SET $PIECE(POS1,Y,12)=""    ;NEU FEST LEGEN LIEFERANT       ;recent unyielding put down supplier 
	. . ;
	. . SET $PIECE(POS1,Y,193)=+$HOROLOG               ;AUFGSDATUM
	. . SET $PIECE(POS1,Y,169)=1                       ;REKLAMATION ;reclamation 
	. . IF $GET(VORG(5))=1 SET $PIECE(POS1,Y,169)=3    ;GARANTIE ;guaranty 
	. . SET $PIECE(POS1,Y,22)=+$HOROLOG                ;ERFASSUNGSDATUM
	. . SET $PIECE(POS1,Y,23)=YBED                     ;ERFASSUNGSMITARBEITER
	. . SET $PIECE(POS1,Y,237)=AUF                     ;GARANTIE ZU AUFTRAG  ;guarantee within order 
	. . SET $PIECE(POS1,Y,238)=YI(2)                   ;GARANTIE ZU POSITION ;guarantee within line
	. . ;GUARANTY-LINE ITEM
	. . IF STORNO=0 DO  ;FIS;SR14834;12-Jul-2006;SOURCE=STOCK IF NEGATIVE QT
	. . . IF $PIECE(POS1,Y,5)'>0 SET $PIECE(POS1,Y,7)  = 2
	. . ;RETURN-LINE ITEM
	. . IF STORNO=1 DO
	. . . SET $PIECE(POS1,Y,5)   = -$PIECE(POS1,Y,5)    ;RÜCKNAHME
	. . .;SET $PIECE(SATZ,Y,118) = -$PIECE(SATZ,Y,118)  ;STORNO
	. . . SET $PIECE(POS1,Y,119) = -$PIECE(POS1,Y,119)  ;RÜCKNAHME
	. . . SET $PIECE(POS1,Y,123) = -$PIECE(POS1,Y,123)  ;RÜCKNAHME
	. . . SET $PIECE(POS1,Y,47)  = -$PIECE(POS1,Y,47)   ;RÜCKNAHME
	. . . ;SET $PIECE(POS1,Y,7)   = 2  ;WH LAGERBESTAND
	. . . IF $PIECE(POS1,Y,5)'>0 SET $PIECE(POS1,Y,7)  = 2  ;SOURCE=STOCK IF NEGATIVE QTY;FIS;SR14834;12-Jul-2006
	. . . IF $PIECE(POS1,Y,26)=2 SET $PIECE(POS1,Y,26) = 4  ;DIENSTLEISTUNG
	. . . ;
	. . . IF $PIECE(POS1,Y,5)<0 DO  ;REKLA VORGABEN
	. . . . ;BEC;23117;15.05.03;LAGERPLATZ BETRIBSABHÄNGIG
	. . . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)=0 IF $GET(YLOCATION)'="" SET $PIECE(POS1,Y,223)=$PIECE($GET(^INVORGB(YM,YM,YLOCATION,1)),Y,2)  ;vorgabe lagerplatz AUS BETRIBSPARAMETERN ;out of 
	. . . . ;
	. . . . IF $PIECE(POS1,Y,223)="" SET $PIECE(POS1,Y,223)=$PIECE($GET(^INVORG(YM,YM,1)),Y,115)  ;vorgabe lagerplatz,ALTE WERTE WEGEN SERVICEFALL 23117   ;WEM;24673;27.11.2003;YM HINZUGEFÜGT
	. . . . ;SET $PIECE(POS1,Y,223)=$PIECE($GET(^INVORG(YM,YM,1)),Y,115)  ;vorgabe lagerplatz
	. . . . SET $PIECE(POS1,Y,224)=0
	. . . . IF +$PIECE($GET(^INAUF(YM,AUF,1)),Y,2)=0 SET $PIECE(POS1,Y,224)=1    ;WEM;24673;27.11.2003;WENN KUNDENAUFTRAG UND STORNO; RÜCKGABE AN KUNDEN AUF JA SETZEN
	. . . . ;IF $PIECE(POS1,Y,223)'="" SET $PIECE(POS1,Y,224)=1  ;zurueck
	. . . . SET $PIECE(POS1,Y,226)=0
	. . . . SET $PIECE(POS1,Y,228)=0
	. . . . SET $PIECE(POS1,Y,230)=0
	. . . . SET $PIECE(POS1,Y,232)=0
	. . . ;
	. . . IF $DATA(^INWEAUFALTS(YM,AUF,YI(2))) DO  ;ZURÜCKHOLEN SERIENNUMMER
	. . . . NEW BET,LAP,WED,SN
	. . . . SET BET=""
	. . . . FOR  SET BET=$ORDER(^INWEAUFALTS(YM,AUF,YI(2),BET)) QUIT:BET=""  DO
	. . . . . SET LAP=""
	. . . . . FOR  SET LAP=$ORDER(^INWEAUFALTS(YM,AUF,YI(2),BET,LAP)) QUIT:LAPX=""  DO
	. . . . . . SET WED=""
	. . . . . . FOR  SET WED=$ORDER(^INWEAUFALTS(YM,AUF,YI(2),BET,LAP,WED)) QUIT:WED=""  DO
	. . . . . . . SET SN=""
	. . . . . . . FOR  SET SN=$ORDER(^INWEAUFALTS(YM,AUF,YI(2),BET,LAP,WED,SN)) QUIT:SN=""  DO
	. . . . . . . . IF $PIECE(POS1,Y,56)="" SET $PIECE(POS1,Y,56)=SN QUIT
	. . . . . . . . IF '$FIND(";"_$PIECE(POS1,Y,56)_";",";"_SN_";") SET $PIECE(POS1,Y,56)=$PIECE(POS1,Y,56)_";"_SN
	. . ;
	. . IF VORG(5)=1 DO   ;VK=0
	. . . FOR YI(3)=118,119,123                                 SET $PIECE(POS1,Y,YI(3))=0  ;VK=0
	. . . ; FIXME : Was the second line supposed to have been commented out or was it expanded?
	. . . FOR YI(3)=116,120,121,122,124,125,128,129,136,140,141 SET $PIECE(POS1,Y,YI(3))=""  ;LÖSCHEN AUFSDATEN AUS AUFG;;TYBD;12.06.2003;23194;RABATTE NICHT LÖSCHEN
	. . . FOR YI(3)=116,120,124,136,140,141                     SET $PIECE(POS1,Y,YI(3))=""  ;LÖSCHEN AUFSDATEN AUS AUFG;;TYBD;12.06.2003;23194;RABATTE NICHT LÖSCHEN
	. . ;
	. . DO  ;SPEICHERN ;Save changes
	. . . NEW YFORM,YVOR,OK
	. . . SET OK=$$^WWWSPEI("INAUFP",AUFG_","_YI(1),POS1,1)
	. . ;
	. . ;DO ^WWWSSORT("INAUFP",AUFG_","_YI(1))  ;SORTKEY;not needed after WWWSPEI;FIS;SR14834;12-Jul-2006
	. . MERGE ^INAUFPK(YM,AUFG,YI(1))  = ^INAUFPK(YM,AUF,YI(2))   ;KONDITIONEN ;terms of payment 
	. . MERGE ^INAUFPSP(YM,AUFG,YI(1)) = ^INAUFPSP(YM,AUF,YI(2))  ;SPRACHE ;Language 
	. . MERGE ^INAUFPXL(YM,AUFG,YI(1)) = ^INAUFPXL(YM,AUF,YI(2))  ;STUKTUR
	. . MERGE ^INAUFPT(YM,AUFG,YI(1))  = ^INAUFPT(YM,AUF,YI(2))   ;TEILE
	. . ;
	. . DO    ;ARTIKEL HISTORY    ;13.01.04;FAN;24868
	. . . NEW BETRIEB,TEXT
	. . . SET BETRIEB=$PIECE($GET(^INAUF(YM,AUF,1)),Y,6)
	. . . IF BETRIEB="" SET BETRIEB=$GET(YLOCATION)
	. . . ; "New Order ***-* From Line Items ***-*"    ;Neue AUFTRAGSPISITION XXX-X AUS AUFTRAGSPOSITION XXXXX-X
	. . . SET TEXT=$$^WWWTEXT(32507)_" "_AUFG_"-"_YI(1)_" "_$$^WWWTEXT(32515)_" "_$$^WWWTEXT(33487)_" "_AUF_"-"_YI(2)
	. . . IF $GET(VORG(5))=0 SET TEXT=TEXT_" ("_$$^WWWTEXT(32484)_")"    ;REKLAMATIONSAUFTRAG    ; "Complaint-order"
	. . . IF $GET(VORG(5))=1 SET TEXT=TEXT_" ("_$$^WWWTEXT(32947)_")"    ;GARANTIEAUFTRAG        ; "Guarantee Order"
	. . . DO ^INARTHIST($PIECE($GET(^INAUFP(YM,AUF,YI(2),1)),Y,4),TEXT,BETRIEB)     
	
	SET YFORM="INAUF",YKEY=AUF
	SET YLINK=""
	DO  ;LINK
	. NEW YKEY,YI
	. SET YI=YAKTION_"EP=WWWFORM&YFORM=INAUF&YKEY="_AUFG
	. DO VAR^WWWCGI
	. SET YLINK=YI
	
	IF $GET(VORG(5))=0 DO ^WWWINFO($$^WWWTEXT(32484)_" ("_AUFG_")",0,YLINK)  ;REKLAMATIONSAUFTRAG    ; "Complaint-order"
	IF $GET(VORG(5))=1 DO ^WWWINFO($$^WWWTEXT(32947)_" ("_AUFG_")",0,YLINK)  ;GARANTIEAUFTRAG        ; "Guarantee Order"
	KILL ^INANGZW(YM,YUSER)
	QUIT
	
SELECT ;AUFBAU DER ANZEIGEDATEI ZUR AUSWAHL DER POSITIONEN ;the Selection the 
	NEW AUF,POS,MNG
	
	KILL ^INANGZW(YM,YUSER)
	SET YFKEY=$GET(%("%KEY","YKEY"))			QUIT:$GET(YFKEY)=""
	SET AUF=$PIECE(YFKEY,",",1)					QUIT:AUF=""
	SET POS=$PIECE(YFKEY,",",2)
	
	SET MNG=$GET(%("%KEY","YMNG"))  ;FIS;19.05.03;23532;MENGE (WENN NICHT GANZE POSITION)
	IF $PIECE($GET(^INAUF(YM,AUF,1)),Y,38)=1 DO  QUIT   ;AUF GESPERRT ;upon DISABLED 
	. WRITE YCR
	. WRITE "<FONT COLOR="_YRED_">"
	. WRITE $$^WWWTEXT(32047)_" "_AUF_" "_$$^WWWTEXT(10004)  ;GESPERRT ; "Order *** Item Closed"
	. WRITE "</FONT>"
	
	IF $PIECE($GET(^INAUF(YM,AUF,1)),Y,12)="" IF $PIECE($GET(^INAUF(YM,AUF,1)),Y,1)'="" IF '$DATA(^INKUNDE(YM,$PIECE($GET(^INAUF(YM,AUF,1)),Y,1))) DO
	. WRITE YCR
	. DO
	. . NEW YKEY,YFORM
	. . WRITE "<A HREF="_""""_YAKTION_"EP=WWWFORM&YFORM=INWERBADR&YKEY="_$PIECE($GET(^INAUF(YM,AUF,1)),Y,1)
	. . DO ^WWWCGI
	. . WRITE """"
	. . WRITE "TITLE="_""""_$$^WWWTEXT(374)_""""          ; "Select Data Record"
	. . WRITE ">"
	. ;
	. WRITE "<FONT COLOR="_YRED_">"
	. WRITE $$^WWWTEXT(32495)  ;BITTE ERST KUNDEN ANLEGEN ANGELEGT ; "Transfer The Advertising-Address Into The Customer-Master First Please" 
	. WRITE "</FONT>"
	. WRITE "</A>"
	
	DO:POS'=""  IF POS=""  FOR  SET POS=$ORDER(^INAUFP(YM,AUF,POS)) QUIT:POS=""  DO
	. SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	. IF +$GET(MNG)>0 SET $PIECE(POS1,Y,5)=MNG  ;FIS;19.05.03;23532;MENGE (WENN NICHT GANZE POSITION)
	. SET ^INANGZW(YM,YUSER,POS,1)=$PIECE(POS1,Y,1)_Y_$PIECE(POS1,Y,5)_Y_$PIECE(POS1,Y,40)_Y_$PIECE(POS1,Y,11)_Y_AUF   ;ANZEIGEFELDER
	
	QUIT
]]></Routine>
</Export>