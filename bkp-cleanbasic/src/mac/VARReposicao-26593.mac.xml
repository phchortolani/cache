<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="VARReposicao" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
VARReposicao
#include COMSYS
#include INConst
#include VARConst
#define SituacaoDisponivel 1
#define SituacaoVencida 2
#define SituacaoEnderecoBloqueado 3

	//^VARTempAlertaLocalBuffer(YBED)
	//	Piece 1 - EstoqueAcimaPR
	//	Piece 2 - EstoqueProximoPR
	//	Piece 3 - EstoqueAbaixoPRcomEP
	//	Piece 4 - 

FilterEstoqueAcimaPR(pidItem,pidLocation="",pProprietario=0)
	;Atenção: essa função não pega tudo o que está acima do PR. Ela pega apenas aqueles que estão acima do PR,
	;		  com uma determinada margem e abaixo do estoque máximo.
	
	new strStatus, fltEstoqueLocal, fltPRLocal, fltEMLocal, fltProximidade
	
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,1)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
	
	
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
	set fltEMLocal = $$GetEstoqueMaximo(pidItem,pidLocation)
	
	//set fltProximidade = (fltPRLocal * 1.2) ;(20 acima do ponto de ressuprimento)
 	set fltProximidade = (fltPRLocal) ;(20 acima do ponto de ressuprimento)
	;Se o estoque local é maior que o ponto de ressuprimento e menor ou igual que o estoque máximo
	if ((fltEstoqueLocal > fltPRLocal) && (fltEstoqueLocal <= fltEMLocal)) {
		
		;Se ele não está próximo do PR
		if (fltEstoqueLocal > fltProximidade) {
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,1)=strStatus
	}
	
	quit strStatus
	
FilterEstoqueProximoPR(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltPRLocal, fltProximidade
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,2)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
	 
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
		
	set fltProximidade = (fltPRLocal * 1.2) ;(20 acima do ponto de ressuprimento)
 	//set fltProximidade = (fltPRLocal) ;(20 acima do ponto de ressuprimento)
	;Se o Estoque Central é maior que o ponto de ressuprimento
	if (fltEstoqueLocal >= fltPRLocal) {
		
		;Se ele está próximo do PR
		if (fltEstoqueLocal <= fltProximidade) {			
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,2)=strStatus
	}
	
	quit strStatus
	
FilterEstoqueAbaixoPRcomEP(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltPRLocal, fltEP
 	
 	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,3)
		IF strStatus'="" Q strStatus
	}
 	
 	set strStatus = $$$NO
 	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
 
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
	
	;Se o estoque local é menor que o ponto de ressuprimento
	if (fltEstoqueLocal < fltPRLocal) {
		if pProprietario=1 {
			set fltEP=$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}else {
			set fltEP=$$GetQuantidadePendenteReq(pidItem,pidLocation)
			set fltEP=fltEP+$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}
		
		;Se existe alguma quantidade em encomenda pendente
		if (fltEP > 0) {
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,3)=strStatus
	}
	
	quit strStatus
	
	
FilterEstoqueAbaixoPRsemEP(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltPRLocal, fltEP
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,4)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
	
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
	
	;Se o estoque local é menor que o ponto de ressuprimento
	if (fltEstoqueLocal < fltPRLocal) {
		if pProprietario=1 {
			set fltEP=$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}else {
			set fltEP=$$GetQuantidadePendenteReq(pidItem,pidLocation)
			set fltEP=fltEP+$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}
		
		;Se não existe nenhuma quantidade em encomenda pendente
		if fltEP <= 0 {
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,4)=strStatus
	}
	
	quit strStatus

FilterEstoqueAbaixoPRcomEPAcimaPR(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltPRLocal, fltEP
 	
 	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,5)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
 	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
 
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
	
	;Se o estoque local é menor que o ponto de ressuprimento
	if (fltEstoqueLocal < fltPRLocal) {
		if pProprietario=1 {
			set fltEP=$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}else {
			set fltEP=$$GetQuantidadePendenteReq(pidItem,pidLocation)
			set fltEP=fltEP+$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}
		set fltEstoqueLocal=fltEstoqueLocal+fltEP
		;Se existe alguma quantidade em encomenda pendente
		if (fltEstoqueLocal >= fltPRLocal) {
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,5)=strStatus
	}
	
	quit strStatus
	
FilterEstoqueAbaixoPR(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltPRLocal, fltEP
 	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,6)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
	
	set fltPRLocal = $$GetPontoRessuprimento(pidItem,pidLocation)
	
	;Se o estoque local é menor que o ponto de ressuprimento
	if (fltEstoqueLocal < fltPRLocal) {
		if pProprietario=1 {
			set fltEP=$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}else {
			set fltEP=$$GetQuantidadePendenteReq(pidItem,pidLocation)
			set fltEP=fltEP+$$GetQuantidadePendenteCompra(pidItem,pidLocation)
		}
		set fltEstoqueLocal=fltEstoqueLocal+fltEP
		;Se não existe nenhuma quantidade em encomenda pendente
		if (fltEstoqueLocal < fltPRLocal) {
			set strStatus = $$$YES
		}
	}
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,6)=strStatus
	}
	
	quit strStatus
	
	
FilterEstoqueAcimaEM(pidItem,pidLocation="",pProprietario=0)
	new strStatus, fltEstoqueLocal, fltEMLocal
 	
 	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set strStatus=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,7)
		IF strStatus'="" Q strStatus
	}
	
	set strStatus = $$$NO
 	
	if pProprietario=1 {
		set fltEstoqueLocal = $$GetEstoqueDisponivelProprietario(pidItem,pidLocation)
	}else {
		set fltEstoqueLocal = $$GetEstoqueDisponivel(pidItem,pidLocation)
	}
			
	set fltEMLocal = $$GetEstoqueMaximo(pidItem,pidLocation)
	
	;Se o estoque local é maior que o estoque máximo
	if (fltEstoqueLocal > fltEMLocal) {
		set strStatus = $$$YES
	}
 
 	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocation
		if pidLocation="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,7)=strStatus
	}
 
	quit strStatus

GetSugestao(pidItem,pidLocal="",pManual="",pAgregada=0)
	quit:($get(pidItem) = "") 0
	new fltSugestaoLocal
	set fltSugestaoLocal=0
	set fltSugestaoLocal = $$GetEstoqueMaximo(pidItem,pidLocal,pManual) - $$GetEstoqueVirtual(pidItem,pidLocal) + $$GetEstoqueSeguranca(pidItem,pidLocal)
	if pAgregada=1 set fltSugestaoLocal = fltSugestaoLocal+$$GetDemandaAgregada(pidItem,pidLocal)
	if (fltSugestaoLocal < 0) {
		set fltSugestaoLocal = 0
	}
	
	quit fltSugestaoLocal
	
GetSugestaoProprietario(pidItem,pidLocal,pManual="",pAgregada=0)
	quit:($get(pidItem) = "") 0
	quit:($get(pidLocal) = "") 0
	new fltSugestaoLocal
	set fltSugestaoLocal = $$GetEstoqueMaximo(pidItem,pidLocal,pManual) - $$GetEstoqueVirtualProprietario(pidItem,pidLocal) + $$GetEstoqueSeguranca(pidItem,pidLocal)
	if pAgregada=1 set fltSugestaoLocal = fltSugestaoLocal+$$GetDemandaAgregada(pidItem,pidLocal)
	if (fltSugestaoLocal < 0) {
		set fltSugestaoLocal = 0
	}
	
	quit fltSugestaoLocal
	
GetCoberturaEstoque(pidItem,pidLocal="")
	quit:(pidItem = "") 0	

	new fltEstoque, fltCMM, fltCoberturaEstoque
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set responseValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,8)
		IF responseValue'="" Q responseValue
	}
	set fltCoberturaEstoque=0
	set fltEstoque = $$GetEstoqueDisponivel(pidItem,pidLocal)
	set fltTotal	  		= $$GetDM(pidItem,pidLocal)
	if fltTotal <= 0 set fltCoberturaEstoque=0
	if fltEstoque <= 0 set fltCoberturaEstoque=0
	
	//Não arredondar para cima, mesmo que seja 1,9 por exemplo.
	if ((fltTotal>0) && (fltEstoque>0)) set fltCoberturaEstoque = $$Floor^COMUtilNum((fltEstoque / fltTotal) * 30)
 	
 	if fltCoberturaEstoque="" set fltCoberturaEstoque=0
 	
 	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,8)=fltCoberturaEstoque
	}
 	
	quit fltCoberturaEstoque
	
GetCoberturaEstoqueProprietario(pidItem,pidLocal)
	quit:(pidItem = "") 0	
	quit:(pidLocal = "") 0	
	new fltEstoque, fltCMM, fltCoberturaEstoque
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set responseValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,9)
		IF responseValue'="" Q responseValue
	}
	set fltCoberturaEstoque=0
	set fltEstoque = $$GetEstoqueDisponivelProprietario^VARReposicao(pidItem,pidLocal)
	set fltTotal	  		= $$GetDM(pidItem,pidLocal)
	if fltTotal <= 0 set fltCoberturaEstoque=0
	if fltEstoque <= 0 set fltCoberturaEstoque=0
	
	//Não arredondar para cima, mesmo que seja 1,9 por exemplo.
	if ((fltTotal>0) && (fltEstoque>0)) set fltCoberturaEstoque = $$Floor^COMUtilNum((fltEstoque / fltTotal) * 30)
 	if fltCoberturaEstoque="" set fltCoberturaEstoque=0
 	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,9)=fltCoberturaEstoque
	}
 
	quit fltCoberturaEstoque

GetEstoqueMaximo(pidItem,pidLocal="",pManual="")
	new strValue,multiplier,objReposicao,ID
	set strValue=0
	if pidItem="" q strValue
	set strValue=($$GetDM(pidItem,pidLocal))
	//If there's a manual multiplier, calculate and leave
	if pManual'="" {
		if ((strValue'=0) && (pManual'=0)) {
			set strValue=strValue*pManual
		}else {
			set strValue=0 
		}
		quit strValue
	}
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set responseValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,10)
		IF responseValue'="" Q responseValue
	}
	
	set multiplier=""
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Rede" {
				set objReposicao=$get(^VARReposicao(YM,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoEstoqueMaximo(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
					set multiplier=multiplier*3
				}
			}
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Local" {
				set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoLocalEstoqueMaximo(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoLocalTempodeAbastecimento(objReposicao)
					set multiplier=multiplier*3
				}
			}
		}
	}
	
	//Check locationXproduct
	if ((pidLocal'="") && (multiplier="")) {
		if $order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,pidLocal,pidItem,""))
			set objReposicao=$get(^VARReposicaoLocalProduto(YM,pidLocal,pidItem,ID,1))
			set multiplier=$$$VARReposicaoLocalProdutoEstoqueMaximo(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalProdutoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*3
			}
		}
	}
	if multiplier="" {
	//Check Location
		if $order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,""))'="" {
			set ID=$order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,pidLocal,""))
			set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,ID,1))
			set multiplier=$$$VARReposicaoLocalEstoqueMaximo(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*3
			}
		}
		
	}
	if multiplier="" {
	//Check Product
		if $order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,pidItem,""))
			set objReposicao=$get(^VARReposicaoProduto(YM,pidItem,ID,1))
			set multiplier=$$$VARReposicaoProdutoEstoqueMaximo(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoProdutoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*3
			}
		}
		
		
	}
	if multiplier="" {
	//Check Network
		set ID=$order(^VARReposicaos(YM,1,1,""))
		if ID'="" {
			set objReposicao=$get(^VARReposicao(YM,ID,1))
			set multiplier=$$$VARReposicaoEstoqueMaximo(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*3
			}
		}
		
	}
	//No configuration, set as default
	
	if multiplier="" set multiplier=6
	if ((strValue'=0) && (multiplier'=0)) {
		set strValue=strValue*multiplier
	}else {
		set strValue=0 
	}
	if strValue="" set strValue=0 
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,10)=strValue
	}
	
	q strValue
	
GetEstoqueSeguranca(pidItem,pidLocal="",pManual="")
	new strValue,multiplier,objReposicao,ID
	set strValue=0
	if pidItem="" q strValue
	/*
	if pidLocal'="" set strValue=$piece($get(^INDRPITEM(YM,pidLocal,pidItem,1)),Y,23)
	if pidLocal="" set strValue=($$GetDM(pidItem,pidLocal) )
	*/
	set strValue=($$GetDM(pidItem,pidLocal))
	//If there's a manual multiplier, calculate and leave
	if pManual'="" {
		if ((strValue'=0) && (pManual'=0)) {
			set strValue=strValue*pManual
		}else {
			set strValue=0 
		}
		quit strValue
	}
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set responseValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,11)
		IF responseValue'="" Q responseValue
	}
	
	set multiplier=""
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Rede" {
				set objReposicao=$get(^VARReposicao(YM,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoEstoquedeSeguranca(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
				}
			}
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Local" {
				set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoLocalEstoquedeSeguranca(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoLocalTempodeAbastecimento(objReposicao)
				}
			}
		}
	}
	
	//Check locationXproduct
	if ((pidLocal'="") && (multiplier="")) {
		if $order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,pidLocal,pidItem,""))
			set objReposicao=$get(^VARReposicaoLocalProduto(YM,pidLocal,pidItem,ID,1))
			set multiplier=$$$VARReposicaoLocalProdutoEstoquedeSeguranca(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalProdutoTempodeAbastecimento(objReposicao)
			}
		}
	}
	if multiplier="" {
	//Check Location
		if $order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,""))'="" {
			set ID=$order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,pidLocal,""))
			set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,ID,1))
			set multiplier=$$$VARReposicaoLocalEstoquedeSeguranca(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalTempodeAbastecimento(objReposicao)
			}
		}
		
	}
	if multiplier="" {
	//Check Product
		if $order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,pidItem,""))
			set objReposicao=$get(^VARReposicaoProduto(YM,pidItem,ID,1))
			set multiplier=$$$VARReposicaoProdutoEstoquedeSeguranca(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoProdutoTempodeAbastecimento(objReposicao)
			}
		}
		
		
	}
	if multiplier="" {
	//Check Network
		set ID=$order(^VARReposicaos(YM,1,1,""))
		if ID'="" {
			set objReposicao=$get(^VARReposicao(YM,ID,1))
			set multiplier=$$$VARReposicaoEstoquedeSeguranca(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
			}
		}
		
	}
	//No configuration, set as default
	
	if multiplier="" set multiplier=1
	if ((strValue'=0) && (multiplier'=0)) {
		set strValue=strValue*multiplier
	}else {
		set strValue=0 
	}
	if strValue="" set strValue=0 
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,11)=strValue
	}
	
	q strValue

GetDM(pidItem,pidLocal="") //Demanda Mensal
	if pidItem="" q 0
	set strValue=""
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,12)
		IF strValue'="" Q strValue
	}
	
	set strValueI=""
	set strValueI=$$GetDMMI(pidItem,pidLocal)
	if ((strValueI'="") && ($extract(strValueI)'="%")) { //Se a demanda for informada e não for um perceuntual
		set strValue=strValueI
	}else {
		if pidLocal="" {
			//Para a rede pega apenas o CMM
			set strValue=$$GetCMM(pidItem,pidLocal)	
		}else {// Para local pega consumo + movimentacoes
			set strValue=$$GetCMM(pidItem,pidLocal)
			set strValue=strValue+$$GetMOV(pidItem,pidLocal)
		}
		if strValue="" { //Se não tiver demanda
			set strValue=0
		}else {
			set strValueI=$piece(strValueI,"%",2)
			set strValueI=strValueI/100
			set strValueI=strValueI*strValue
			set strValue=strValue+strValueI
		}
	}
	
	if strValue="" set strValue=0
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,12)=strValue
	}
	
	q strValue

GetDMMI(pidItem="",pidLocal="")
	if pidItem="" q ""
	set strValue=""
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,13)
		IF strValue'="" Q strValue
	}
	
	set currentMonth=$extract($ZD($H,1),0,2) 
	//Check locationXproduct
	if ((pidLocal'="") && (pidItem'="")) {
		if $order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,pidLocal,pidItem,""))
			set objReposicao=$get(^VARReposicaoLocalProduto(YM,pidLocal,pidItem,ID,1))
			set piece=currentMonth+9
			set strValue=$piece(objReposicao,Y,piece) //get DMMI seasonal
			set piece=currentMonth+21
			if strValue="" {
				if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
			}
			if strValue="" set strValue=$$$VARReposicaoLocalProdutoDMMI(objReposicao)
		}
	}
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION -> LOCAL
	if ((($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) && (strValue="")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Local" {
				set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				//set multiplier=$$$VARReposicaoLocalDMMI(objReposicao)
				set piece=currentMonth+8
				if strValue="" {
					if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
				}
			}
		}
	}
	
	if ((strValue="") && (pidLocal'="")) {
	//Check Location
		if $order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,""))'="" {
			set ID=$order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,pidLocal,""))
			set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,ID,1))
			//set multiplier=$$$VARReposicaoLocalDMMI(objReposicao)
			set piece=currentMonth+8
			if strValue="" {
				if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
			}
		}
		
	}
	if ((strValue="") && (pidItem'="")) {
	//Check Product
		if $order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,pidItem,""))
			set objReposicao=$get(^VARReposicaoProduto(YM,pidItem,ID,1))
			set piece=currentMonth+9
			set strValue=$piece(objReposicao,Y,piece) //get DMMI seasonal
			set piece=currentMonth+21
			if strValue="" {
				if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
			}
			if strValue="" set strValue=$$$VARReposicaoProdutoDMMI(objReposicao)
		}
		
		
	}
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION -> NETWORK
	if ((($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) && (strValue="")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Rede" {
				set objReposicao=$get(^VARReposicao(YM,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				//set multiplier=$$$VARReposicaoLocalDMMI(objReposicao)
				set piece=currentMonth+8
				if strValue="" {
					if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
				}
			}
		}
	}
	
	if strValue="" {
		//Check Network
		set ID=$order(^VARReposicaos(YM,1,1,""))
		if ID'="" {
			set objReposicao=$get(^VARReposicao(YM,ID,1))
			//set strValue=$$$VARReposicaoEstoquedeSeguranca(objReposicao)
			set piece=currentMonth+8
			if strValue="" {
				if $piece(objReposicao,Y,piece)'="" set strValue="%"_$piece(objReposicao,Y,piece) //Get % Seasonal
			}
		}
		
	}
	//No configuration, set as default
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,13)=strValue
	}
	
	q strValue
	
GetPontoRessuprimento(pidItem,pidLocal="",pManual="")
	new strValue,multiplier,objReposicao,ID
	set strValue=0
	if pidItem="" q strValue
	set strValue=($$GetDM(pidItem,pidLocal))
	//If there's a manual multiplier, calculate and leave
	if pManual'="" {
		if ((strValue'=0) && (pManual'=0)) {
			set strValue=strValue*pManual
		}else {
			set strValue=0 
		}
		quit strValue
	}
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		
		set responseValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,14)
		IF responseValue'="" Q responseValue
	}
	
	set multiplier=""
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Rede" {
				set objReposicao=$get(^VARReposicao(YM,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoPontodeRessuprimento(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
					set multiplier=multiplier*2
				}
			}
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Local" {
				set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set multiplier=$$$VARReposicaoLocalPontodeRessuprimento(objReposicao)
				if multiplier=""{ //Calculate it by frequency
					set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
					set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
					set multiplier=multiplier*$$$VARReposicaoLocalTempodeAbastecimento(objReposicao)
					set multiplier=multiplier*2
				}
			}
		}
	}
	
	//Check locationXproduct
	if ((pidLocal'="") && (multiplier="")) {
		if $order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,pidLocal,pidItem,""))
			set objReposicao=$get(^VARReposicaoLocalProduto(YM,pidLocal,pidItem,ID,1))
			set multiplier=$$$VARReposicaoLocalProdutoPontodeRessuprimento(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalProdutoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*2
			}
		}
	}
	if multiplier="" {
	//Check Location
		if $order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,""))'="" {
			set ID=$order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,pidLocal,""))
			set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,ID,1))
			set multiplier=$$$VARReposicaoLocalPontodeRessuprimento(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoLocalTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLocalLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoLocalTempode]]><![CDATA[Abastecimento(objReposicao)
				set multiplier=multiplier*2
			}
		}
		
	}
	if multiplier="" {
	//Check Product
		if $order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,pidItem,""))
			set objReposicao=$get(^VARReposicaoProduto(YM,pidItem,ID,1))
			set multiplier=$$$VARReposicaoProdutoPontodeRessuprimento(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoProdutoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoProdutoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoProdutoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*2
			}
		}
		
		
	}
	if multiplier="" {
	//Check Network
		set ID=$order(^VARReposicaos(YM,1,1,""))
		if ID'="" {
			set objReposicao=$get(^VARReposicao(YM,ID,1))
			set multiplier=$$$VARReposicaoPontodeRessuprimento(objReposicao)
			if multiplier=""{ //Calculate it by frequency
				set multiplier=$$$VARReposicaoTempodeCompra(objReposicao)
				set multiplier=multiplier+$$$VARReposicaoLeadTime(objReposicao)
				set multiplier=multiplier*$$$VARReposicaoTempodeAbastecimento(objReposicao)
				set multiplier=multiplier*2
			}
		}
		
	}
	//No configuration, set as default
	
	if multiplier="" set multiplier=3
	if ((strValue'=0) && (multiplier'=0)) {
		set strValue=strValue*multiplier
	}else {
		set strValue=0 
	}
	if strValue="" set strValue=0 
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,14)=strValue
	}
	
	q strValue

GetEstoqueTotal(pidItem,pidLocal="")
	set strValue=0
	q strValue

GetEstoqueOnHand(pidItem,pidLocal="")
	if pidItem="" q 0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,15)
		IF strValue'="" Q strValue
	}
	if ($GET(YFORM)="VAREstoqueSemMovto") {
		set strValue=##class(alSOH.iSOH).GetQtyOnHand(pidItem,pidLocal,"",0)
	} else {
		set strValue=##class(alSOH.iSOH).GetQtyOnHand(pidItem,pidLocal)
	}
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,15)=strValue
	}
	q strValue
	
GetEstoqueOnHandAtDate(pidItem, pidLocation= "",pidStorage="",pidProgram="",pDate= "",pidModule="",pidFromModule="",pidToModule="",pidFromStreet="",pidToStreet="" ,pstrTrnType = "")
	
	;-------------------------------------------------------------------------------
	; Gets the Transaction Qty based on Transactions for a given Start and End Dates
	; for an Item & Location
	; 
	; pstrTrnType - comma seperated list of Transaction Types
	; 
	; 
	; ByRef :
	; 	
	; Returns: Qty - %Float
	;
	; History:
	; 27-Apr-2012	RGB		Changes to get stock on period by Program
	; 05-Apr-2011	shobby	SR17698: Don't include NonStock Transactions.
	; 16-Apr-2009	PPP		SR16441: Created
	;-------------------------------------------------------------------------------
 	if pDate="" set pDate = +$horolog
 
	set fltQty     = 0
	set returnQty=0	
	set strTrnType = (","_pstrTrnType_",")
	set pdteStart=""
    set pdteStart=+pdteStart  ;SR17698
 
 	if pstrTrnType = "" {
		&SQL(
			SELECT SUM(QtyMoved) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				DateConfirmed <= :pDate
				AND (NonStock is null or NonStock=0)
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}

	} else {
		&SQL(
			SELECT SUM(QtyMoved) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				DateConfirmed <= :pDate                         AND
				(NonStock is null or NonStock=0) AND
				:strTrnType [ ("," || TxType || ",")
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}
	}
	quit returnQty
	
GetValorEstoqueOnHandAtDate(pidItem, pidLocation= "",pidStorage="",pidProgram="",pDate= "",pidModule="",pidFromModule="",pidToModule="",pidFromStreet="",pidToStreet="" ,pstrTrnType = "")
	
	;-------------------------------------------------------------------------------
	; Gets the Transaction Qty based on Transactions for a given Start and End Dates
	; for an Item & Location
	; 
	; pstrTrnType - comma seperated list of Transaction Types
	; 
	; 
	; ByRef :
	; 	
	; Returns: Qty - %Float
	;
	; History:
	; 27-Apr-2012	RGB		Changes to get stock on period by Program
	; 05-Apr-2011	shobby	SR17698: Don't include NonStock Transactions.
	; 16-Apr-2009	PPP		SR16441: Created
	;-------------------------------------------------------------------------------
 	if pDate="" set pDate = +$horolog
 
	set fltQty     = 0
	set returnQty=0	
	set strTrnType = (","_pstrTrnType_",")
	set pdteStart=""
    set pdteStart=+pdteStart  ;SR17698
 
 	if pstrTrnType = "" {
		&SQL(
			SELECT SUM(QtyMoved * StdPrice) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				(DateConfirmed <= :pDate)
				AND (NonStock is null or NonStock=0)
				AND (Storage->Code <> "EmTransito")
				
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}

	} else {
		&SQL(
			SELECT SUM(QtyMoved * StdPrice) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				DateConfirmed <= :pDate                         AND
				(NonStock is null or NonStock=0) AND
				:strTrnType [ ("," || TxType || ",")
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}
	}
	quit returnQty

GetEstoqueAvailableAtDate(pidItem, pidLocation= "",pidStorage="",pidProgram="",pDate= "",pExpirationDate="",pidModule="",pidFromModule="",pidToModule="",pidFromStreet="",pidToStreet="" ,pstrTrnType = "")
	
	;-------------------------------------------------------------------------------
	; Gets the Transaction Qty based on Transactions for a given Start and End Dates
	; for an Item & Location
	; 
	; pstrTrnType - comma seperated list of Transaction Types
	; 
	; 
	; ByRef :
	; 	
	; Returns: Qty - %Float
	;
	; History:
	; 27-Apr-2012	RGB		Changes to get stock on period by Program
	; 05-Apr-2011	shobby	SR17698: Don't include NonStock Transactions.
	; 16-Apr-2009	PPP		SR16441: Created
	;-------------------------------------------------------------------------------
 	if pDate="" set pDate = +$horolog
 
	set fltQty     = 0	
	set strTrnType = (","_pstrTrnType_",")
	set pdteStart=""
    set pdteStart=+pdteStart  ;SR17698
 
 	if pstrTrnType = "" {
		&SQL(
			SELECT SUM(QtyMoved) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Bundle->UseByDate>= :pExpirationDate OR :pExpirationDate is NULL or Bundle->UseByDate is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				DateConfirmed <= :pDate
				AND (NonStock is null or NonStock=0)  
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}

	} else {
		&SQL(
			SELECT SUM(QtyMoved) 
			INTO :fltQty
			FROM alSOH.dStockHistory
			WHERE 
				Item = :pidItem                                   AND
				(Bundle->Program= :pidProgram OR :pidProgram is NULL) AND
				(Location = :pidLocation  OR :pidLocation is NULL) AND
				((Storage->Code=:pidStorage OR :pidStorage is NULL) or (PhysicalStorage->Code=:pidStorage OR :pidStorage is NULL)) AND
				((:DesdeModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) >= :DesdeModulo)) AND
				((:AteModulo IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) <= :AteModulo)) AND
				((:pidModule IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),1) = :RefModulo)) AND
				((:DesdeRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) >= :DesdeRua)) AND
				((:AteRua IS NULL) OR ($$GetEnderecoConsulta^VARVolumeEstoqueLocal($$SQLGetEnderecoFisico^VARSQL(Storage->Code,PhysicalStorage->Code),2) <= :AteRua)) AND
				DateConfirmed >= :pdteStart                       AND
				DateConfirmed <= :pDate                         AND
				(NonStock is null or NonStock=0) AND
				:strTrnType [ ("," || TxType || ",")
		)
		if SQLCODE=0 {
			set returnQty=fltQty
		}
	}
	quit returnQty

GetEstoqueDisponivel(pidItem,pidLocal="",pidProgram="")
	if pidItem="" q 0
	set strValue=0
	
	/* Em análise - incluído bloqueado (param 4 = 0)
		É preciso ter um método que retorne endereço bloqueado MAS não retorne os vencidos,
		hoje ele está retornando tudo. 	
	*/

	set strValue=##class(alSOH.iSOH).GetQtyAvailable(pidItem,pidLocal,,0,pidProgram)

	if strValue="" set strValue=0
	
	q strValue

GetEstoqueFisico(pidItem,pidLocal="")
	; 08-Dec-2014	shobby		ALPHAUP-423 : Copied in SESDF-V3 version
	if (pidItem = "") quit 0
	set strValue = 0

	if (pidLocal = "") {
		set strValue = $$^INARTMENGE(pidItem,,,1,1,,0)
	} else {
		set strValue = $$^INARTMENGE(pidItem,,pidLocal,,1,,0)
	}
	
	if (strValue = "") set strValue = 0
	
	quit strValue
	
GetEstoqueDisponivelLote(pidItem,pidLocal,pLote,pValidade)
	new qtdDisponivel
	do GetSituacaoLote(pidItem,pidLocal,pLote,pValidade,.qtdDisponivel)
	quit qtdDisponivel
	
GetSituacaoLote(pidItem,pidLocal,pLote,pValidade,&qtdDisponivel)
	new Local, Storage, Quantidade, Lote, Validade,
		objStorage, blnDUC, physicalStorage

	$$$VAR
	
	&sql(DECLARE CurStock CURSOR FOR
		 SELECT alSOH.dBundleStock.Storage->Location,
		 		alSOH.dBundleStock.Storage->Code,
		 		+alSOH.dBundleStock.QtyOnHand,
		 		alSOH.dBundleStock.Bundle->LotNumber,
		 		alSOH.dBundleStock.Bundle->UseByDate
		   INTO :Local, :Storage, :Quantidade, :Lote, :Validade
		   FROM alSOH.dBundleStock
		  WHERE alSOH.dBundleStock.Item = :pidItem
		   AND  alSOH.dBundleStock.Storage->Location = :pidLocal
	)
	
	set qtdDisponivel = 0

	&sql(open CurStock)
	if (SQLCODE) quit qtdDisponivel
	for {
		&sql(fetch CurStock)
		if (SQLCODE) quit
		if ((pLote = Lote) && (pValidade = Validade)) {
			set objStorage = $get(^INLP(YM,Local,Storage,1))
			set blnDUC     = $piece(objStorage,Y,21)
			set pSituacaoLote = $$$SituacaoDisponivel
		
			if (blnDUC = $$$YES) { //Se o endereco é um DUC
				set physicalStorage = $piece(objStorage,Y,22)					
				if ($$checkIfBlockedStorage^VARStock(Local,physicalStorage)) {
					set pSituacaoLote = $$$SituacaoEnderecoBloqueado
					continue // se o endereço estiver bloqueado
				}
			}
			if ($$checkIfBlockedStorage^VARStock(Local,Storage)) {
				set pSituacaoLote = $$$SituacaoEnderecoBloqueado
				continue // se o endereço estiver bloqueado
			} elseif ( (Validade < $horolog) && (Validade '= "") ) {
				set pSituacaoLote = $$$SituacaoVencida
				continue // se o produto estiver vencido

			}
			set qtdDisponivel = qtdDisponivel + Quantidade
		}
	}
	&sql(close CurStock)
	
	quit pSituacaoLote
	
GetEstoqueIndisponivel(pidItem,pidLocal="")
	set strValue=0
	q strValue
	
GetEstoqueEmTransito(pidItem,pidLocal="")
	set strValue=0
	q strValue

GetEstoqueVencido(pidItem,pidLocal="")
	set strValue=0
	q strValue
	
GetEstoqueDisponivelProprietario(pidItem,pidLocal)
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,16)
		IF strValue'="" Q strValue
	}
	set strValue=0
	set strValue=$$GetEstoqueDisponivelProgramaPrincipal(pidItem,pidLocal,1) //Fix me, hardcoded central location
	set strValue=strValue+$$GetEstoqueDisponivel(pidItem,pidLocal)
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,16)=strValue
	}
	
	quit strValue

GetEstoqueDisponivelProgramaPrincipal(pidItem,pidLocal,pidOnLocation="")
	quit:(pidItem = "") 0
	if pidLocal="" q 0
	new strLocationDesc,strLocationObj,idProgram,strValue
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,17)
		IF strValue'="" Q strValue
	}
	set strValue=0
	
	set strLocationObj=$get(^WWW0121(YM,YM,pidLocal,1))
	if strLocationObj="" q strValue
	
	set strLocationDesc=$$$WWW0121LocationName(strLocationObj)
	if strLocationDesc="" q strValue
	
	set strLocationDesc=$$$Index(strLocationDesc)
	set idProgram=$order(^INPROJECTs(YM,200,strLocationDesc,""))
	
	if idProgram="" q strValue
	
	set strValue=$$GetEstoqueDisponivel^VARReposicao(pidItem,pidOnLocation,idProgram)
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,17)=strValue
	}
	
	q strValue

GetDemandaAgregada(pidItem,pidLocal="")
	if pidLocal="" q 0 //Makes no sense to get requisition quantity for the network at this point
	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,18)
		IF strValue'="" Q strValue
	}
	
	set strValue=$$GetTotalReqPendingQty^INReqUtils(pidItem,pidLocal)
	if strValue="" set strValue=0
	if strValue<0 set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,18)=strValue
	}
	
	q strValue


GetEstoqueVirtual(pidItem,pidLocal="")
	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,19)
		IF strValue'="" Q strValue
	}
	
	set strValue=$$GetEstoqueDisponivel(pidItem,pidLocal)
	set strValue=strValue+$$GetQuantidadePendenteReq(pidItem,pidLocal)
	set strValue=strValue+$$GetQuantidadePendenteCompra(pidItem,pidLocal)
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,19)=strValue
	}
	
	q strValue	

GetEstoqueVirtualProprietario(pidItem,pidLocal)
	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,20)
		IF strValue'="" Q strValue
	}
	
	set strValue=$$GetEstoqueDisponivelProprietario^VARReposicao(pidItem,pidLocal)
	//set strValue=strValue+$$GetQuantidadePendenteReq(pidItem,pidLocal)
	set strValue=strValue+$$GetQuantidadePendenteCompra(pidItem,pidLocal)
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,20)=strValue
	}
	
	q strValue

GetQuantidadePendenteReq(pidItem,pidLocal="")
	if pidLocal="" q 0 //Makes no sense to get requisition quantity for the network at this point
	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,21)
		IF strValue'="" Q strValue
	}
	
	set strValue=$$GetTotalRequisitionedQty^INReqUtils(pidItem,pidLocal)
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,21)=strValue
	}
	
	q strValue
	
GetQuantidadePendenteCompra(pidItem,pidLocal="")

	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,22)
		IF strValue'="" Q strValue
	}
	
	if pidLocal="" {
		$$$Order3(^WWW0121,YM,YM,idLocation)
			set strValue=strValue+$$GetQuantidadePendenteRecebimentoLocal(pidItem,idLocation)
		$$$End
		set strValue=strValue+$$GetQuantidadePendenteRecebimentoLocal(pidItem,"")
	}else {
		set strValue=$$GetQuantidadePendenteRecebimentoLocal(pidItem,pidLocal)
	}
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,22)=strValue
	}
	
	q strValue	

GetQuantidadePendenteRecebimentoLocal(pidItem,pidLocal="")
	//if pidLocal="" q 0
	if pidItem="" q 0
	set strValue=0
	set qtyPendente=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,23)
		IF strValue'="" Q strValue
	}
	
	set strCompras = $$getComprasPendentesPorProduto(pidItem,pidLocal)
	if (strCompras '= "") {
	
		for i = 1:1:$Length(strCompras,";") {		
	
			set idCompra = $piece(strCompras,";",i)
		
			set objCompra = $get(^INAUF(YM,idCompra,1))
			continue:(objCompra = "")
			
			set qtyCompra   = 0
			set qtyRecebida = 0
			
			$$$Order5(^INAUFPs,YM,8,pidItem,idCompra,idCompraLinha)
				
				set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
				IF ($$$INAUFPLineItemManualyClosed(objCompra) '= 1) {
					set qtyCompraLinha = $$$INAUFPQuantity(objCompra)
					set qtyCompra = qtyCompra + qtyCompraLinha
								
					set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
					set qtyRecebida = qtyRecebida + qtyRecebidaLinha
				}
			
			$$$End
			set qtyPendenteLinha = qtyCompra - qtyRecebida
			if qtyPendenteLinha<0 set qtyPendenteLinha=0
			set qtyPendente=qtyPendente+qtyPendenteLinha
		}
	}
	set strValue=qtyPendente
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,23)=strValue
	}
	
	q strValue	

getComprasPendentesPorProduto(pidItem,pidLocation="", &parrOpenCompras)
	;-------------------------------------------------------------------------------
    ; Chamado por:
    ;	Retorna os documentos de compras pendentes para um produto
    ; 
    ; Histórico:
    ;	04-Abr-2013		RGB - Alterações para realizar o calculo da quantidade pendente antes de incluir no array
    ; 	22-Sep-2010		Criado
    ;-------------------------------------------------------------------------------	
	quit:(pidItem = "") 0
	if pidLocation="" set pidLocation=" "
 	new idCompra
 	
 	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,24)
		IF strValue'="" Q strValue
	}
	
	// Para o status = " " - Aberta;

	$$$Order6(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation," ",idCompra)
		set qtyPendente=0
		set qtyCompra=0
		set qtyRecebida=0
		$$$Order7(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation," ",idCompra,idCompraLinha)
			set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
			set qtyCompraLinha = $piece(objCompra,Y,5)
			set qtyCompra = qtyCompra + qtyCompraLinha
								
			set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
			set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
		$$$End
			
		set qtyPendente = qtyCompra - qtyRecebida
		if qtyPendente>0 set parrOpenCompras(idCompra) = "" 			
	$$$End
	
 	
	// Para o status = 0 - Aberta;

	$$$Order6(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation,0,idCompra)
		set qtyPendente=0
		set qtyCompra=0
		set qtyRecebida=0
		$$$Order7(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation," ",idCompra,idCompraLinha)
			set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
			set qtyCompraLinha = $piece(objCompra,Y,5)
			set qtyCompra = qtyCompra + qtyCompraLinha
								
			set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
			set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
		$$$End
			
		set qtyPendente = qtyCompra - qtyRecebida
		if qtyPendente>0 set parrOpenCompras(idCompra) = "" 		
	$$$End

 	
	// Para o status = 1 - Processada - Aguardando Recebimento.

	$$$Order6(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation,1,idCompra)
		set qtyPendente=0
		set qtyCompra=0
		set qtyRecebida=0
		$$$Order7(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation," ",idCompra,idCompraLinha)
			set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
			set qtyCompraLinha = $piece(objCompra,Y,5)
			set qtyCompra = qtyCompra + qtyCompraLinha
								
			set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
			set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
		$$$End
			
		set qtyPendente = qtyCompra - qtyRecebida
		if qtyPendente>0 set parrOpenCompras(idCompra) = "" 
	$$$End	
 
	// Para o status = 2 - Parcialmente recebida.
	
	$$$Order6(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation,2,idCompra)
		set qtyPendente=0
		set qtyCompra=0
		set qtyRecebida=0
		$$$Order7(^INAUFPs,YM,102,$$$Index(pidItem),pidLocation," ",idCompra,idCompraLinha)
			set objCompra = $get(^INAUFP(YM,idCompra,idCompraLinha,1))
				
			set qtyCompraLinha = $piece(objCompra,Y,5)
			set qtyCompra = qtyCompra + qtyCompraLinha
								
			set qtyRecebidaLinha = $$getQuantidadeRecebida^VARCompra(idCompra,idCompraLinha)
			set qtyRecebida = qtyRecebida + qtyRecebidaLinha
			
		$$$End
			
		set qtyPendente = qtyCompra - qtyRecebida
		if qtyPendente>0 set parrOpenCompras(idCompra) = "" 
	$$$End
  	
  	// Montar a String de retorno
 	set strCompras = ""
 	$$$Order1(parrOpenCompras,idCompra)
 	
 		if strCompras = "" {
	 		set strCompras = idCompra
 		} else {
	 		set strCompras = strCompras_";"_idCompra
 		}
 	
 	$$$End
 	
 	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,24)=strCompras
	}
 	
	quit strCompras

GetCMM(pidItem,pidLocal="")

	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,25)
		IF strValue'="" Q strValue
	}
	
	if pidLocal="" {
		set objItem = $get(^INART(YM,pidItem,1))
	
		quit:(objItem = "") 0
		set objParamCliente = ^VARParametroCliente(YM,YM,1)
		set strCMM = $$$VARParametroClienteReposicaoRedeBaseadaEm(objParamCliente)
	
		if ((strCMM=1) || (strCMM="")) {//CMM
			//set strValue= $$$INARTFREE26(objItem)
			set strValue=$$GetCMMCalculated(pidItem,pidLocal)
			//
		}
		//CMMi
		if (strCMM=2) set strValue= $$$INARTFREE27(objItem)
		
		
	}else {
		set objItem = $get(^INDRPITEM(YM,pidLocal,pidItem,1))
		set objParamCliente = ^VARParametroCliente(YM,YM,1)
		set strCMML = $$$VARParametroClienteReposicaoLocalBaseadaEm(objParamCliente)
	
		if ((strCMML=1) || (strCMML="")) {//CMML
			//set strValue=$$$INDRPITEMFREE12(objItem)
			set strValue=$$GetCMMCalculated(pidItem,pidLocal)
		}
		//CMMLi
		
		quit:(objItem = "") 0
		if (strCMML=2) set strValue=$$$INDRPITEMFREE20(objItem)
		
	}
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,25)=strValue
	}
	
	q strValue
	
GetMOV(pidItem,pidLocal="")
	if pidItem="" q 0
	set strValue=0
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,26)
		IF strValue'="" Q strValue
	}
	
	if pidLocal="" {
		set objItem = $get(^INART(YM,pidItem,1))
	
		quit:(objItem = "") 0
		set objParamCliente = ^VARParametroCliente(YM,YM,1)
		set strMOV = $$$VARParametroClienteReposicaoRedeBaseadaEm(objParamCliente)
	
		if ((strMOV=1) || (strMOV="")) {//MOV
			//set strValue= $$$INARTFREE28(objItem)
			set strValue=$$GetMOVCalculated(pidItem,pidLocal)
		}
		//MOVi
		if (strMOV=2) set strValue= $$$INARTFREE28(objItem) //No MOVi
		
		
	}else {
	
		set objParamCliente = ^VARParametroCliente(YM,YM,1)
		set strMOVL = $$$VARParametroClienteReposicaoLocalBaseadaEm(objParamCliente)
	
		if ((strMOVL=1) || (strMOVL="")) {//MOVL
			//set strValue=$$$INDRPITEMFREE3(objItem)
			set strValue=$$GetMOVCalculated(pidItem,pidLocal)
		}
		//MOVLi
		set objItem = $get(^INDRPITEM(YM,pidLocal,pidItem,1))
		quit:(objItem = "") 0
		if (strMOVL=2) set strValue=$$$INDRPITEMFREE3(objItem) //No MOVLi
		
	}
	if strValue="" set strValue=0
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCa]]><![CDATA[che(YBED,cacheLocation,pidItem),Y,26)=strValue
	}
	
	q strValue

GetPedidoCompra(pidItem,pidLocal="",&parrPAMs)
	; History
	; 08-Dec-2014	shobby		ALPHAUP-423 : Copied in SESDF-V3 version
	
	set returnString=""
	if pidItem="" quit returnString
	
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,27)
		IF strValue'="" QUIT strValue
	}
	
	$$$Order4(^VARPedidoCompraLinhas,YM,1,pidItem,idPedidoCompra)
		set foundItem=0
		set statusPedidoCompra = $$getStatusPedidoCompra^VARPedidoCompra(idPedidoCompra)
		
		// Desconsiderar pedidos com status 0-Aberto ou 3-Arquivado
		continue:( (statusPedidoCompra = 0) || (statusPedidoCompra = 3) )
		
		$$$Order5(^VARPedidoCompraLinhas,YM,1,pidItem,idPedidoCompra,idPedidoCompraLinha)
			
			set linhaRecebida = ""
			
			set temAFM = $order(^INAUFPs(0,200,$$$Index(idPedidoCompra),$$$Index(idPedidoCompraLinha),""))
			if (temAFM '= ""){
				set linhaRecebida = $$GetAFMCountNotReceived^VARPedidoCompraLinha(idPedidoCompra, pidItem)
			}
			set objPAMLinha = ^VARPedidoCompraLinha(YM,idPedidoCompra,idPedidoCompraLinha,1)
			
			if (((linhaRecebida > 0) || (temAFM = "")) && ($$$VARPedidoCompraLinhaQuantidade(objPAMLinha) > ($$GetQuantidadeRecebida^VARPedidoCompraLinha(idPedidoCompra, pidItem) + $$$VARPedidoCompraLinhaQuantidadeArquivada(objPAMLinha)))) {
				if (idPedidoCompra '= "") set parrPAMs(idPedidoCompra) = ""
				if foundItem=0 {
					set stringPedido="<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARPedidoCompra&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YKEY="_idPedidoCompra_">"_idPedidoCompra_"</a></td>"
					set foundItem=1
					if returnString="" {
						set returnString=stringPedido
					}else {
						set returnString=returnString_"<br>"_stringPedido
					}
				}
				
			}
 
		$$$End
	$$$End
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,27)=strValue
	}
	
	quit returnString
	
GetOrdemCompra(pidItem,pidLocal="")
	set returnString=""
	if pidItem="" q returnString
	new parrOpenCompras
	if pidLocal="Rede" set pidLocal=""
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,28)
		IF strValue'="" Q strValue
	}
	if pidLocal'="" {
		set strCompras = $$getComprasPendentesPorProduto(pidItem,pidLocal)
		if (strCompras '= "") {
	
			for i = 1:1:$Length(strCompras,";") {		
	
				set idCompra = $piece(strCompras,";",i)
				set parrOpenCompras(idCompra) = ""
			}
		}
	}else {
		$$$Order3(^WWW0121,YM,YM,idLocation)
			set strCompras = $$getComprasPendentesPorProduto(pidItem,idLocation)
			if (strCompras '= "") {
	
				for i = 1:1:$Length(strCompras,";") {		
	
					set idCompra = $piece(strCompras,";",i)
					set parrOpenCompras(idCompra) = ""
				}
			}
		$$$End
	}
	
				
	$$$Order1(parrOpenCompras,idCompra) 
		set stringPedido="<td height=20px style=padding-left:8px;padding-right:8px;><a target=_BLANK href="_YAKTION_"EP=WWWFORM&amp;YFORM=VARCompra&amp;YUCI="_YUCI_"&amp;YBED="_YBED_"&amp;YM="_YM_"&amp;YUSER="_YUSER_"&amp;YKEY="_idCompra_">"_idCompra_"</a></td>"
		if returnString="" {
			set returnString=stringPedido
		}else {
			set returnString=returnString_"<br>"_stringPedido
		}
	$$$End
			
	
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,28)=returnString
	}
	
	q returnString

GetMonthsForAverage(pidItem,pidLocal="")
	set months=""
	//
	//Check locationXproduct
	if ((pidLocal'="") && (pidItem'="")) {
		if $order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoLocalProdutos(YM,1,$$$Index(pidLocal),$$$Index(pidItem),1,pidLocal,pidItem,""))
			set objReposicao=$get(^VARReposicaoLocalProduto(YM,pidLocal,pidItem,ID,1))
			set months=$$$VARReposicaoLocalProdutoMesesparaMedia(objReposicao)
		}
	}
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION -> LOCAL
	if ((($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) && (months="")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Local" {
				set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set months=$$$VARReposicaoLocalMesesparaMedia(objReposicao)
			}
		}
	}
	
	if ((months="") && (pidLocal'="")) {
	//Check Location
		if $order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,""))'="" {
			set ID=$order(^VARReposicaoLocals(YM,1,$$$Index(pidLocal),1,pidLocal,""))
			set objReposicao=$get(^VARReposicaoLocal(YM,pidLocal,ID,1))
			set months=$$$VARReposicaoLocalMesesparaMedia(objReposicao)
		}	
	}
	if ((months="") && (pidItem'="")) {
	//Check Product
		if $order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,""))'="" {
			set ID=$order(^VARReposicaoProdutos(YM,1,$$$Index(pidItem),1,pidItem,""))
			set objReposicao=$get(^VARReposicaoProduto(YM,pidItem,ID,1))
			set months=$$$VARReposicaoProdutoMesesparaMedia(objReposicao)
		}
	}
	
	//RETRIEVE PARAMETER FROM SCENARIO OPTION -> NETWORK
	if ((($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) && (months="")) {
		if $get(^VARTempAlertaLocal(YBED,"Scenario"))'="" {
			if $get(^VARTempAlertaLocal(YBED,"Scenario-Type")) = "Rede" {
				set objReposicao=$get(^VARReposicao(YM,$get(^VARTempAlertaLocal(YBED,"Scenario")),1))
				set months=$$$VARReposicaoMesesparaMedia(objReposicao)
			}
		}
	}
	
	if months="" {
		//Check Network
		set ID=$order(^VARReposicaos(YM,1,1,""))
		if ID'="" {
			set objReposicao=$get(^VARReposicao(YM,ID,1))
			set months=$$$VARReposicaoMesesparaMedia(objReposicao)
		}	
	}
	//
	
	if months<0 set months=""
	q months

GetCMMCalculated(pidItem,pidLocal="")
	set calculatedCMM=0
	set months=0
	set currentmonth=$extract($ZD($H,1),1,2)
	set currentyear=$extract($ZD($H,1),7,10)
	set months=$$GetMonthsForAverage(pidItem,pidLocal="")
	if months="" set months=12
	for x=1:1:months {
		set GetCMMYearMonth=0
		set currentmonth=currentmonth-1
		if currentmonth<1 {
			set currentyear=currentyear-1
			set currentmonth=12
		}
		set GetCMMYearMonth=$$GetCMMYearMonth(pidItem,pidLocal,currentyear,currentmonth)
		if GetCMMYearMonth=0 set months=months-1 //Ignore months with no movement
		set calculatedCMM=calculatedCMM+GetCMMYearMonth
	}
	if ((calculatedCMM>0) && (calculatedCMM'="") && (months>0)) set calculatedCMM=calculatedCMM\months
	q calculatedCMM

GetMOVCalculated(pidItem,pidLocal="")
	set calculatedMOV=0
	set months=0
	set currentmonth=$extract($ZD($H,1),1,2)
	set currentyear=$extract($ZD($H,1),7,10)
	set months=$$GetMonthsForAverage(pidItem,pidLocal="")
	if months="" set months=12
	for x=1:1:months {
		set GetMOVYearMonth=0
		set currentmonth=currentmonth-1
		if currentmonth<1 {
			set currentyear=currentyear-1
			set currentmonth=12
		}
		set GetMOVYearMonth=$$GetMOVYearMonth(pidItem,pidLocal,currentyear,currentmonth)
		if GetMOVYearMonth=0 set months=months-1 //Ignore months with no movement
		set calculatedMOV=calculatedMOV+GetMOVYearMonth
	}
	if ((calculatedMOV>0) && (calculatedMOV'="") && (months>0)) set calculatedMOV=calculatedMOV\months
	q calculatedMOV

GetCMMYearMonth(pidItem,pidLocal="",currentyear,currentmonth)
	$$$VAR
	if pidItem="" q 0
	set qtyCMMLocation = 0
	if pidLocal'="" {

		if $order(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
				
			$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
				set qty = 0
				set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
				set qtyCMMLocation = qtyCMMLocation + qty
	
			$$$End
		}
	}else {
	
		$$$Order5(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
				
			$$$Order6(^VARCMMLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
				set qty = 0
				set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
				set qtyCMMLocation = qtyCMMLocation + qty
				
	
			$$$End
		$$$End
	}
	if qtyCMMLocation<0 set qtyCMMLocation=qtyCMMLocation*(-1)
	q qtyCMMLocation
	
GetMOVYearMonth(pidItem,pidLocal="",currentyear,currentmonth)
	if pidItem="" q 0
	set qtyMOVLocation = 0
	if pidLocal'="" {
		if $order(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,""))'="" {
				
			$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
				set qty = 0
				set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
				set qtyMOVLocation = qtyMOVLocation + qty
	
			$$$End
		}
	
	}else {
		$$$Order5(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal)
				
			$$$Order6(^VARMOVLinha,YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
				set qty = 0
				set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
				set qtyMOVLocation = qtyMOVLocation + qty
	
			$$$End
			
		$$$End
	}
	//if qtyCMMLocation<0 set qtyCMMLocation=qtyCMMLocation*(-1)
	q qtyMOVLocation

getCMMLi(pidLocal,pidItem)
	quit:(pidLocal = "") ""
	quit:pidItem="" ""
	set CMMLi = ""
	set Local = pidLocal
	set Item  = pidItem
 
	set objItem = $get(^INART(YM,Item,1))
	
	if (Local = "") quit $$getCMMi(Item)	
	
	set idRepLocalProduto = ""
	
	for {
		set idRepLocalProduto = $order(^VARReposicaoLocalProduto(YM,Local,Item,idRepLocalProduto))	
		quit:(idRepLocalProduto = "")
		
		set objRepLocalProduto = $get(^VARReposicaoLocalProduto(YM,Local,Item,idRepLocalProduto,1))
		continue:($$$VARReposicaoLocalProdutoAtivo(objRepLocalProduto) '= 1)
		
		set CMMLi = $$$VARReposicaoLocalProdutoCMMLi(objRepLocalProduto)
	}
	
	quit CMMLi
	
getCMMi(pidItem)
	new CMMi	
	set CMMi = $piece($$GetCMMiRede^VARCMMIConsolidadoGrupoNivel(pidItem,0),",",1)
	quit CMMi

getDemandaAnual(pidItem)
	
	set CMMi = ""
	set Item  = pidItem
 
	set objItem = $get(^INART(YM,Item,1))
			
	set idRepProduto = ""
	
	for {
		set idRepProduto = $order(^VARReposicaoProduto(YM,Item,idRepProduto))	
		quit:(idRepProduto = "")
		
		set objRepProduto = $get(^VARReposicaoProduto(YM,Item,idRepProduto,1))
		continue:($$$VARReposicaoProdutoAtivo(objRepProduto) '= 1)
		
		set CMMi = $$$VARReposicaoProdutoDemandaAnual(objRepProduto)
	}
	
	quit CMMi

GetEstoqueFisicoCentral(pidItem)
 
	if $$IsFormInBuffer^VARAlertaLocalLinha($get(YFORM)) = $$$YES {
		set EstoqueCentral = $piece($get(^VARTempAlertaLocalBuffer(YBED,pidItem)),Y,68)
		if (EstoqueCentral '= "") quit $$Floor^COMUtilNum(EstoqueCentral)
	}
 
	new objProduto, estoquePrincipal, EstoqueCentral
	set objProduto 		 = $get(^INART(0,pidItem,1))	
	set estoquePrincipal = $$$INARTFREE35(objProduto)
	 	
	if (estoquePrincipal = "FARMACIA") {
		set EstoqueCentral = $$GetEstoqueCentralFarmacia^VARConsultaGerencialProduto(pidItem)
		
	} elseif (estoquePrincipal = "ALMOXARIFADO") {
		set EstoqueCentral = $$GetEstoqueCentralAlmoxarifado^VARConsultaGerencialProduto(pidItem)
	
	} else {
		set EstoqueCentral = ""
	}
 
	if $$IsFormInBuffer^VARAlertaLocalLinha($get(YFORM)) = $$$YES {
		set $piece(^VARTempAlertaLocalBuffer(YBED,pidItem),Y,68) = EstoqueCentral
	}
	
	quit $$Floor^COMUtilNum(EstoqueCentral)
	
Get30DaysEvolution(pidItem,pidLocal="",Debug=0)
	new currentDM,qty30DaysEvo,qtyCMMLocation,qtyMOVLocation
	if pidLocal="Rede" set pidLocal=""
	
	if pidItem="" q "0%"
	set qty30DaysEvo = 0
	
	set currentDM=0
	set qtyCMMLocation=0
	set qtyMOVLocation=0
	set currentDate=$piece($H,",",1)
	
	
	for x=currentDate-1:-1:currentDate-30 { //Last 30 days of movement
		
		//GetCMM
		
		if pidLocal'="" {
			if $order(^VARCMMLinhas(YM,2,x,pidItem,""))'="" {
				$$$Order5(^VARCMMLinhas,YM,2,x,pidItem,currentyear)
					$$$Order6(^VARCMMLinhas,YM,2,x,pidItem,currentyear,currentmonth)
						$$$Order8(^VARCMMLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
							set qty = 0
							set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
							set qtyCMMLocation = qtyCMMLocation + qty
	
						$$$End
					$$$End
				$$$End
			}
		}else {
			if $order(^VARCMMLinhas(YM,2,x,pidItem,""))'="" {
				$$$Order5(^VARCMMLinhas,YM,2,x,pidItem,currentyear)
					$$$Order6(^VARCMMLinhas,YM,2,x,pidItem,currentyear,currentmonth)
						$$$Order7(^VARCMMLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal)
							$$$Order8(^VARCMMLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
								set qty = 0
								set qty = $piece($get(^VARCMMLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
								set qtyCMMLocation = qtyCMMLocation + qty
	
							$$$End
						$$$End
					$$$End
				$$$End
			}
		}
		
		//GetMOV
		
		if pidLocal'="" {
			if $order(^VARMOVLinhas(YM,2,x,pidItem,""))'="" {
				$$$Order5(^VARMOVLinhas,YM,2,x,pidItem,currentyear)
					$$$Order6(^VARMOVLinhas,YM,2,x,pidItem,currentyear,currentmonth)
						$$$Order8(^VARMOVLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
							set qty = 0
							set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
							set qtyMOVLocation = qtyMOVLocation + qty
	
						$$$End
					$$$End
				$$$End
			}
		}else {
			if $order(^VARMOVLinhas(YM,2,x,pidItem,""))'="" {
				$$$Order5(^VARMOVLinhas,YM,2,x,pidItem,currentyear)
					$$$Order6(^VARMOVLinhas,YM,2,x,pidItem,currentyear,currentmonth)
						$$$Order7(^VARMOVLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal)
							$$$Order8(^VARMOVLinhas,YM,2,x,pidItem,currentyear,currentmonth,pidLocal,idTransaction)
					
								set qty = 0
								set qty = $piece($get(^VARMOVLinha(YM,pidItem,currentyear,currentmonth,pidLocal,idTransaction,1)),Y,1)
								set qtyMOVLocation = qtyMOVLocation + qty
	
							$$$End
						$$$End
					$$$End
				$$$End
			}
		}
	}
	
	if Debug=1 w "qtyCMMLocation="_qtyCMMLocation,!
	if Debug=1 w "qtyMOVLocation="_qtyMOVLocation,!
	if pidLocal'="" {
		set qty30DaysEvo=qtyCMMLocation+qtyMOVLocation
	}else {
		set qty30DaysEvo=qtyCMMLocation
	}
	if Debug=1 w "qty30DaysEvo="_qty30DaysEvo,!
	if qty30DaysEvo<0 set qty30DaysEvo=qty30DaysEvo*(-1)
	
	if ((qty30DaysEvo>0) && (qty30DaysEvo'="")) {
	}else {
		set qty30DaysEvo=0
	}
	
	set currentDM=$$GetDM(pidItem,pidLocal)
	if Debug=1 w "CurrentDM="_currentDM,!
	if ((currentDM=0) || (currentDM="")) {
		if qty30DaysEvo q "0%"
		q ""
	}
	
	if qty30DaysEvo=0 q "-100%"
	
	set qty30DaysEvo=qty30DaysEvo/currentDM
	set qty30DaysEvo=(qty30DaysEvo*100)-100
	if Debug=1 w "qty30DaysEvo="_qty30DaysEvo,!
	set qty30DaysEvo=$piece(qty30DaysEvo,".",1) //only integer result
	if qty30DaysEvo="" set qty30DaysEvo=0
	if qty30DaysEvo>0 {
		set qty30DaysEvo="+"_qty30DaysEvo_"%"
	}else {
		set qty30DaysEvo=qty30DaysEvo_"%"
	}
	
	
	//if qtyCMMLocation<0 set qtyCMMLocation=qtyCMMLocation*(-1)
	q qty30DaysEvo

GetAtas(pidItem,pidLocal="")
	; History
	; 26-Nov-2014	shobby	ALPHAUP-389: Copied from SESPE version
	
	
	new returnString,object,stringPedido,CodAta,mySQL
	set returnString=""
	if pidItem="" q returnString
	/*
	//RETRIEVING FROM VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set strValue=$piece($get(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem)),Y,27)
		IF strValue'="" Q strValue
	}
	*/
	
	set object = ##class(%ResultSet).%New()  ;Create Result Set Object
	
	set mySQL = "SELECT Ata.CodATA,"
	set mySQL = mySQL_" Ata.NumeroProcesso,"
	set mySQL = mySQL_" Ata.Status,"
	set mySQL = mySQL_" $$GetValidadeAta^VARAta(Ata.CodAta,Linha.LinhadaAta) as DataValidade,"
	set mySQL = mySQL_" Linha.LinhadaAta,"
	set mySQL = mySQL_" Linha.Produto,"
	set mySQL = mySQL_" Linha.Fornecedor,"
	set mySQL = mySQL_" Linha.Quantidade,"
	set mySQL = mySQL_" Linha.QuantidadeAditivada,"
	set mySQL = mySQL_" Linha.Unidade,"
	set mySQL = mySQL_" Linha.ValorUnitario,"
	set mySQL = mySQL_" $$SQLGetSaldoItemQuant^VARAtaLinha(Ata.CodAta,Linha.LinhadaAta) as Saldo"
	set mySQL = mySQL_" FROM VARAta Ata"
	set mySQL = mySQL_" LEFT JOIN VARAtaLinha Linha"		
	set mySQL = mySQL_" ON Linha.CodAta = Ata.CodAta"
	set mySQL = mySQL_" WHERE UPPER(Ata.Status) = 1"
	set mySQL = mySQL_"  AND $$GetSituacaoItem^VARAtaLinha(Ata.CodAta,Linha.LinhadaAta,2) >= 5"
	set mySQL = mySQL_" AND UPPER(Linha.Produto) = "_pidItem
	set mySQL = mySQL_" ORDER BY Ata.CodATA"

	do object.Prepare(mySQL) ;Prepare Query
	do object.Execute()  	 ;Execute Query 
	while (object.Next()) {
		set CodAta 	        = object.GetData(1)
		set stringPedido= ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(CodAta, CodAta, "_self", "VARAta", CodAta, "", "", "", "1", "").getHref()
        set stringPedido= "<a href='"_stringPedido_"'>"_CodAta_"</a>"
		if returnString="" {
			set returnString=stringPedido
		}else {
			set returnString=returnString_"<br>"_stringPedido
		}
	}
	/*
	//SAVING IN VARALERTA CACHE
	if (($GET(YFORM)="VARAlertaLocal") || ($GET(YFORM)="VARAlertaLocalLinha")) {//Get By Buffer
		set cacheLocation=pidLocal
		if pidLocal="" set cacheLocation="Rede"
		set $piece(^VARTempAlertaLocalCache(YBED,cacheLocation,pidItem),Y,27)=strValue
	}
	*/
	q returnString

 
 
GetPrecoUltimaCompra(pidItem,pidLocal="")
	new returnString,idAFM,idAFMLinha,statusAFM,objAFM,objAFMLinha
	set returnString=""
	if pidLocal="Rede" set pidLocal=""
 
	set idAFM = ""
	set idAFMLinha = ""
	set returnString = 0
	
	for {
    	set idAFM = $order(^INAUFPs(YM,8,pidItem,idAFM),-1)	
    	quit:(idAFM = "")
		
		set objAFM = $get(^INAUF(YM,idAFM,1))		
		
		set statusAFM = $$$INAUFFREE14(objAFM)
		continue:((statusAFM = 0) || (statusAFM = 4)) ;Ignorando AFM's ainda não processadas ou canceladas
		if (pidLocal '= "") {
			continue:($$$INAUFLocation(objAFM) '= pidLocal)
		}
 
		for {
    		set idAFMLinha = $order(^INAUFPs(YM,8,pidItem,idAFM,idAFMLinha))
    		quit:(idAFMLinha = "")
    		
    		set objAFMLinha   = $get(^INAUFP(YM,idAFM,idAFMLinha,1))
    		
    		set fltPrice  = $$$INAUFPFREE7(objAFMLinha)
			set idItem 	  = pidItem
			set UoM 	  = $$$INAUFPQuantityUnit(objAFMLinha)
			set fltQty 	  = $$$INAUFPQuantity(objAFMLinha)
			
			// Caso a unidade de medida não seja a unidade mínima do produto, fazer a proporção com a unidade básica.
			set baseUOM = $$GetExternalUOM^INUOMConversion(idItem)	
			set qtyUnidadeMinima = ( fltQty * $$ConvertUOMConversionToSmallest^INUOMConversion(pidItem,UoM) )
			set fltUnitPrice = ( fltPrice / $$ConvertUOMConversionToSmallest^INUOMConversion(pidItem,UoM) )
		
			set returnString=$$FormatCurrency^COMTable(fltPrice)
			
			}	
		
		quit
	}
	
	quit returnString

GetReqEmAberto(pidItem,pidLocation="")
	new idReq, returnValue, strLink
	quit:(pidItem = "") ""
	if pidLocation="Rede" set pidLocation=""
 
	set returnValue = ""
	
	// Solicitações com Status = 2	
	set idReq = ""
	for {
		set idReq = $order(^INReqLines(0,4,2,pidItem,idReq))
		quit:(idReq = "")
 
		if (pidLocation '= ""){
			set objINReq = $get(^INReq(0,idReq,1))
			continue:($$$INReqToLocn(objINReq) '= pidLocation)
		}
			
		set strLink = ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(idReq, idReq, "", "INReq", idReq, "", "", "", "1", "").getHref()
        set strLink = "<a target='_blank' href='"_strLink_"'>"_idReq_"</a>" 		
		set returnValue = $select(returnValue = "": strLink,$$$YES:returnValue_"<BR>"_strLink)
		
	}
	
	// Solicitações com Status = 3
	set idReq = ""
	for {
		set idReq = $order(^INReqLines(0,4,3,pidItem,idReq))
		quit:(idReq = "")
 
		if (pidLocation '= ""){
			set objINReq = $get(^INReq(0,idReq,1))
			continue:($$$INReqToLocn(objINReq) '= pidLocation)
		}
		
		set strLink = ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(idReq, idReq, "", "INReq", idReq, "", "", "", "1", "").getHref()
        set strLink = "<a target='_blank' href='"_strLink_"'>"_idReq_"</a>" 		
		set returnValue = $select(returnValue = "": strLink,$$$YES:returnValue_"<BR>"_strLink)
		
	}
 
	quit returnValue

GetSaldoAta(pidItem)
	new returnString,stringPedido,CodAta,linha,objAta,objAtaLinha,saldoAta
	set returnString=""
	if pidItem="" quit returnString
	
	set CodAta = ""
	for {
		set CodAta = $order(^VARAtaLinhas(0,2,pidItem,CodAta),-1)
		quit:(CodAta = "")
 
		set objAta = $get(^VARAta(0,CodAta,1))
		continue:($$$VARAtaStatus(objAta) '= 1)
		
		set linha = ""
		for {
			set linha = $order(^VARAtaLinhas(0,2,pidItem,CodAta,linha))	
			quit:(linha = "")
			continue:($$GetSituacaoItem^VARAtaLinha(CodAta,linha,2) < 5)	
			
			set saldoAta = $$SQLGetSaldoItemQuant^VARAtaLinha(CodAta,linha)		
			
			set stringPedido= ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(CodAta, CodAta, "", "VARAta", CodAta, "", "", "", "1", "").getHref()
	        set stringPedido= "<a target='_blank' href='"_stringPedido_"'>"_saldoAta_"</a>"
			if returnString="" {
				set returnString=stringPedido
			}else {
				set returnString=returnString_"<BR>"_stringPedido
			}
		}
	}
 
	quit returnString

GetVigenciaAtas(pidItem)
	new returnString,stringPedido,CodAta,linha,objAta,objAtaLinha,validadeAta
	set returnString=""
	if pidItem="" quit returnString
	
	set CodAta = ""
	for {
		set CodAta = $order(^VARAtaLinhas(0,2,pidItem,CodAta),-1)
		quit:(CodAta = "")
 
		set objAta = $get(^VARAta(0,CodAta,1))
		continue:($$$VARAtaStatus(objAta) '= 1)
		
		set linha = ""
		for {
			set linha = $order(^VARAtaLinhas(0,2,pidItem,CodAta,linha))	
			quit:(linha = "")
			continue:($$GetSituacaoItem^VARAtaLinha(CodAta,linha,2) < 5)	
			
			set validadeAta = $$GetValidadeAta^VARAta(CodAta,linha)		
			
	 		if (returnString = ""){
				set returnString = $zdate(validadeAta,4)
	 		} else {
		 		set returnString=returnString_"<BR>"_$zdate(validadeAta,4)
	 		}
		}
	}
 
	quit returnString

GetReqSemTransf(pidItem,pidLocation="")
	new idReq, returnValue, strLink
	quit:(pidItem = "") ""
	if pidLocation="Rede" set pidLocation=""
 
	set returnValue = ""
	
	// Solicitações com Status = 1
	set idReq = ""
	for {
		set idReq = $order(^INReqLines(0,4,1,pidItem,idReq))
		quit:(idReq = "")
 
		if (pidLocation '= ""){
			set objINReq = $get(^INReq(0,idReq,1))
			continue:($$$INReqFromLocn(objINReq) '= pidLocation)
		}
			
		set strLink = ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(idReq, idReq, "", "INReq", idReq, "", "", "", "1", "").getHref()
        set strLink = "<a target='_blank' href='"_strLink_"'>"_idReq_"</a>" 		
		set returnValue = $select(returnValue = "": strLink,$$$YES:returnValue_"<BR>"_strLink)
		
	}
	/* Na SESDF-V1 pegava apenas Status = 1
	// Solicitações com Status = 2
	set idReq = ""
	for {
		set idReq = $order(^INReqLines(0,4,2,pidItem,idReq))
		quit:(idReq = "")
 
		if (pidLocation '= ""){
			set objINReq = $get(^INReq(0,idReq,1))
			continue:($$$INReqFromLocn(objINReq) '= pidLocation)
		}
			
		set strLink = ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(idReq, idReq, "", "INReq", idReq, "", "", "", "1", "").getHref()
        set strLink = "<a target='_blank' href='"_strLink_"'>"_idReq_"</a>" 		
		set returnValue = $select(returnValue = "": strLink,$$$YES:returnValue_"<BR>"_strLink)
		
	}
 	*/
	quit returnValue

GetTransfAgAceite(pidItem,pidLocation="")
	new idTransf, returnValue, strLink
	quit:(pidItem = "") ""
	if pidLocation="Rede" set pidLocation=""
	
	set returnValue=""
		
	set idTransf = ""
	for {
		set idTransf = $order(^INTFRLines(0,10,pidItem,idTransf))
		quit:(idTransf = "")
		
		set objTransf = $get(^INTFR(0,idTransf,1))
		
		if (pidLocation '= ""){
			continue:($$$INTFRReceivingLocation(objTransf) '= pidLocation)
			continue:(($$$INTFRStatus(objTransf) '= 2)&&($$$INTFRStatus(objTransf) '= 3))
			continue:($$isTotalmenteAceita^VARINTFR(idTransf) '= 0)
		}
 
		set strLink = ##class(COM.fwk.ui.html.LinkBuilder).buildFormLink(idTransf, idTransf, "", "INTFR", idTransf, "", "", "", "1", "").getHref()
    	set strLink = "<a target='_blank' href='"_strLink_"'>"_idTransf_"</a>" 		
		set returnValue = $select(returnValue = "": strLink,$$$YES:returnValue_"<BR>"_strLink)
		
	}	
	
	quit returnValue



]]></Routine>
</Export>