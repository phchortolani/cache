<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INARTUMS" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INARTUMS(YART,MONAT,STATART,VKEK)
	
#include COMSYS
#include INConst
#include WWWConst
	
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		ARTIKELUMSATZ
	;
	; Inputs : 
	;	YART		Item Number
	;	MONAT		Month			1 : DANN 13 MONATE  when 13 months
	;	STARTART					0 : AMOUNT AS PER ORDER ENTRY
	;								1 : AMOUNT AS PER INVOICE
	;								2 : QTY AS PER ORDER ENTRY
	;								3 : QTY AS PER INVOICE
	;	VKEK						0 : SALES
	;								1 : ((COSTS - PRICE / SALES) -1 )*100
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 04-Jun-2010	GRF		SR17146: call "DD.MM.YYYY" wrapper for WWWDATE1
	; 31-May-2006	GRF		Doco
	; 14-Sep-2005	GRF		SR13443 : corrected SR for 13-Sep-2005 change
	; 13-Sep-2005	BEC		SR12119/SR13443;ADDED ADDITIONAL STATISTICS FOR 1,3 FOR DISPLAYING
	; 02-Sep-2005	FIS		SR13264: SELECT SALES TYPE
	; 01-Aug-2005	RPW		SR13078: Fixed duplicating the YLOC duplication issue caused by 12119.
	; 08-Apr-2005	MS		Uncommented the looping through locations SR12119 (see SR ref below)
	; 11-Feb-2003	DT		Created
	;-------------------------------------------------------------------------------
	DO ^WWWBACK
	QUIT:$GET(YART)=""
	
	SET MONAT   = $GET(MONAT)
	SET STATART = $GET(STATART)
	IF STATART="" SET STATART = 0
	SET VKEK    = $GET(VKEK)
	IF VKEK=""    SET VKEK = 0
	
	;KILL WWWSOR(YUSER)
	KILL ^WWWSOR(YUSER) ;SR13246
	NEW YLOC
	NEW SORTX,YVON,YBIS,ABGE,YVAR,NAME,UMSATZ,UMSATZ1,LFN,ZAHL,ZAHL1,YAUSW1,YAUSW2,JAHR,VMON,BMON,UMSATZA
	NEW UES,YI,YZ,SUMME,YFELD,YMONATE,YSUM,YSUM1,SUM,UMS,VKUMSATZ,EKUMSATZ
	
	SET JAHR = $$^WWWYEAR($HOROLOG)            ;DIESES JAHR ;this year
	SET YVON = $$DMY^WWWDATE1("01.01."_JAHR)   ; SR17146
	SET YBIS = $$DMY^WWWDATE1("31.12."_JAHR)   ; SR17146
	SET VMON = 1                               ;VON MONAT ;from month 
	SET BMON = 12                              ;BIS MONAT ;until month 
	
	IF MONAT=1 DO                 ;13 MONATE
	. SET YVON1 = $$DMY^WWWDATE1("01.01."_(JAHR-1)) ; Prior Year      ; SR17146
	. SET YBIS1 = $$DMY^WWWDATE1("31.12."_(JAHR-1))                   ; SR17146 
	. SET VMON  = $$^WWWMONTH(+$HOROLOG)        ;VOM AKTUELLEN MONAT ;month 
	. SET BMON  = VMON+12                       ;BIS 12 MONATE ZURÜCK (13 MONATE) ;until back 
	
	; 18-Apr-2005 MS: removed the semicolon (uncommented) the $o on YLOC in line below SR12119
	;FOR YLOC=YLOCATION DO  SET YLOC="" FOR  SET YLOC=$ORDER(^WWW0121(0,YM,YLOC))  QUIT:YLOC=""  DO
	; 01-Aug-2005 RPW: Fixed duplicating the YLOC duplication issue caused by 12119.
	SET YLOC = ""
	FOR  SET YLOC = $ORDER(^WWW0121(0,YM,YLOC)) QUIT:YLOC=""  DO
	. SET YVAR = YLOC
	. SET NAME = $$$WWW0121LocationName($GET(^WWW0121(0,YM,YLOC,1)))
	. IF NAME="" SET NAME = " "
	. IF VKEK'=1 DO
	. . SET UMSATZ=$$^INUMS(YVON,YBIS,2,YART,STATART,1,YLOC,,0)  ;VOR EINEM JAHR ;pre- year 
	. . IF $PIECE(UMSATZ,",",12)="" SET $PIECE(UMSATZ,",",12)=""  ;, SETZTEN
	. . IF MONAT=1 DO
	. . . SET UMSATZA=$$^INUMS(YVON1,YBIS1,2,YART,STATART,1,YLOC,,0)  ;SUCHEN UMSATZ DER LOCATION AKTUELLES JAHR ;seek volume of trade the LOCATION year 
	. . . IF $PIECE(UMSATZA,",",12)="" SET $PIECE(UMSATZA,",",12)=""  ;, SETZTEN
	. . . SET UMSATZ=UMSATZA_","_UMSATZ
	. ;
	. IF VKEK=1 DO  ;WENN EKUMSATZ DANN DIFFERENZ ZWISCHEN VK UND EK AUSRECHNEN !!! ;when inter- Sale And Planned Cost 
	. . SET UMSATZ("EK1")=$$^INUMS(YVON,YBIS,2,YART,STATART,1,YLOC,,1)  ;EK LETZTEN 12 MONATE
	. . SET UMSATZ("VK1")=$$^INUMS(YVON,YBIS,2,YART,STATART,1,YLOC,,0)  ;VK LETZTEN 12 MONATE
	. . IF $PIECE(UMSATZ("EK1"),",",12)="" SET $PIECE(UMSATZ("EK1"),",",12)=""  ;, SETZTEN
	. . IF $PIECE(UMSATZ("VK1"),",",12)="" SET $PIECE(UMSATZ("VK1"),",",12)=""  ;, SETZTEN
	. . SET EKUMSATZ=UMSATZ("EK1")
	. . SET VKUMSATZ=UMSATZ("VK1")
	. . IF MONAT=1 DO
	. . . SET UMSATZ("EK2")=$$^INUMS(YVON1,YBIS1,2,YART,STATART,1,YLOC,,1)  ;EK 12 MONATE DAVOR
	. . . SET UMSATZ("VK2")=$$^INUMS(YVON1,YBIS1,2,YART,STATART,1,YLOC,,0)  ;VK 12 MONATE DAVOR
	. . . IF $PIECE(UMSATZ("EK2"),",",12)="" SET $PIECE(UMSATZ("EK2"),",",12)=""  ;, SETZTEN
	. . . IF $PIECE(UMSATZ("VK2"),",",12)="" SET $PIECE(UMSATZ("VK2"),",",12)=""  ;, SETZTEN
	. . . SET EKUMSATZ=UMSATZ("EK2")_","_UMSATZ("EK1")
	. . . SET VKUMSATZ=UMSATZ("VK2")_","_UMSATZ("VK1")
	. . ;
	. . SET UMSATZ=VKUMSATZ
	. . FOR YI=1:1:24 QUIT:$PIECE(UMSATZ,",",YI,99)=""  DO
	. . . ;SET $PIECE(UMSATZ,",",YI)=""
	. . . IF +$PIECE(EKUMSATZ,",",YI)'=0  SET $PIECE(UMSATZ,",",YI)=(($PIECE(VKUMSATZ,",",YI)/$PIECE(EKUMSATZ,",",YI))-1)*100
	. ;
	. QUIT:$TRANSLATE(UMSATZ,",;.0 "_"""")=""  ;KEINE WERTE
	. SET UMSATZ=$TRANSLATE(UMSATZ,",",Y)       ;BEC EINGEFÜGT12.02.03, DA SONST NUR EIN DATENSATZ
	. SET UMSATZ1=$GET(^WWWSOR(YUSER,NAME,YVAR))
	. FOR YI=1:1:24 QUIT:$PIECE(UMSATZ,Y,YI,99)=""  SET $PIECE(UMSATZ1,Y,YI)=$PIECE(UMSATZ1,Y,YI)+$PIECE(UMSATZ,Y,YI)
	. SET ^WWWSOR(YUSER,NAME,YVAR)=UMSATZ1
	
	;ÜBERSCHRIFT BEARBEITEN ;superscription 
	SET UES(1)  = $$^WWWTEXT(388)_Y_$$^WWWTEXT(32026)    ; "Location"  "Description"
	SET YMONATE = $$^WWWTEXT(30024,,1)                   ; "Jan,Feb,Mar,..."
	SET YMONATE = YMONATE_","_YMONATE
	FOR YI=VMON:1:BMON SET UES(1) = UES(1)_Y_$PIECE(YMONATE,",",YI)   ;MONATE
	SET UES(1)  = UES(1)_Y_$$^WWWTEXT(32059)             ; "Total Value"
	
	DO UPUEB   ;DRUCKEN ÜBERSCHRIFT ;print superscription 
	DO DRUCK   ;WERTE DRUCKEN ;print 
	DO GESAMT  ;SUMMENZEILE
	
	DO STOP^WWWTAB  ;ENDE TABELLE ;termination tabulation 
	WRITE "<BR>"
	KILL ^WWWSOR(YUSER)
	QUIT
	
DRUCK
	;AUSWERTUNG DRUCKEN ;print 
	SET YDDSATZ=0
	
	;DRUCKEN TABELLE ;print tabulation 
	SET NAME=""
	FOR  SET NAME=$ORDER(^WWWSOR(YUSER,NAME)) QUIT:NAME=""  DO
	. SET YVAR=""
	. FOR  SET YVAR=$ORDER(^WWWSOR(YUSER,NAME,YVAR)) QUIT:YVAR=""  DO
	. . SET SUM    = 0
	. . SET UMSATZ = $GET(^WWWSOR(YUSER,NAME,YVAR))
	. . ;
	. . DO
	. . . WRITE !
	. . . WRITE YCR
	. . . DO NL^WWWTAB
	. . . DO NFRX1^WWWTAB(50)
	. . . WRITE YVAR
	. . . WRITE YCR
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . DO NFRX1^WWWTAB(50)
	. . . WRITE NAME
	. . . WRITE YCR
	. . . WRITE "&nbsp;"
	. . . ;
	. . . ;SCHREIBEN MONATLICHER UMSATZ UND GESAMTSUMME DES MONATS ;write volume of trade And total amount monthly 
	. . . FOR YI=VMON:1:BMON DO
	. . . . DO EF^WWWTAB
	. . . . DO NFRX1^WWWTAB(80)
	. . . . SET ZAHL    = $PIECE(UMSATZ,Y,YI)   ;MONATZUMSATZ
	. . . . SET UMS(YI) = $GET(UMS(YI))+ZAHL    ;SUMME ;sum 
	. . . . SET SUM     = $GET(SUM)+ZAHL
	. . . . ;BEC/INTRAPREND;SR12119/SR13443;ADDED ADDITIONAL STATISTICS FOR 1,3 FOR DISPLAYING;
	. . . . IF +ZAHL'=0 DO
	. . . . . ;IF STATART=0 IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . . . ;IF STATART=0 IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"   ;ZAHL % vk/ek GERECHNET ;numeral 
	. . . . . ;IF STATART=2 WRITE $$^WWWZAHL(ZAHL,10,2)  ;ZAHL IN ANZAHL GERECHNET ;numeral within Number 
	. . . . . IF (STATART=0) || (STATART=1) IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . . . IF (STATART=0) || (STATART=1) IF VKEK=1  WRITE $$^WWWZAHL(ZAHL,10,2)_" %"  ;ZAHL % vk/ek GERECHNET ;numeral 
	. . . . . IF (STATART=2) || (STATART=3)            WRITE $$^WWWZAHL(ZAHL,10,2)       ;ZAHL IN ANZAHL GERECHNET ;numeral within Number 
	. . . . ; ^^^ SR12119/SR13443
	. . . . ;
	. . . . WRITE "&nbsp;"
	. . . ;
	. . . ;SCHREIBEN GESAMTSUMME DES JAHRES ;write total amount 
	. . . DO EF^WWWTAB
	. . . DO NFRX1^WWWTAB(80)
	. . . SET ZAHL=SUM
	. . . ;BEC/INTRAPREND;SR12119/SR13443;ADDED ADDITIONAL STATISTICS FOR 1,3 FOR DISPLAYING
	. . . ;IF +ZAHL'=0 IF STATART=0 IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)             ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . ;IF +ZAHL'=0 IF STATART=0 IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"              ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . ;IF +ZAHL'=0 IF STATART=2 WRITE $$^WWWZAHL(ZAHL,10,2)                             ;ZAHL IN ANZAHL GERECHNET ;numeral within Number 
	. . . IF +ZAHL'=0 IF (STATART=0) || (STATART=1) IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . IF +ZAHL'=0 IF (STATART=0) || (STATART=1) IF VKEK=1  WRITE $$^WWWZAHL(ZAHL,10,2)_" %"  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. . . IF +ZAHL'=0 IF (STATART=2) || (STATART=3)            WRITE $$^WWWZAHL(ZAHL,10,2)       ;ZAHL IN ANZAHL GERECHNET ;numeral within Number 
	. . . ; ^^^ SR12119/SR13443
	. . . ;
	. . . WRITE "&nbsp;"
	. . . DO EF^WWWTAB
	. . . DO EL^WWWTAB
	
	QUIT
	
GESAMT ;GESAMT ;total  ;total whole 
	SET SUM=0
	WRITE !
	WRITE YCR
	DO NL^WWWTAB
	DO NF^WWWTAB
	WRITE $$^WWWTEXT(350)
	WRITE "&nbsp;"
	DO ZW^WWWTAB
	WRITE "&nbsp;"
	
	FOR YI=VMON:1:BMON DO
	. DO ZWR^WWWTAB
	. SET ZAHL=$GET(UMS(YI))   ;MONATZUMSATZ
	. SET SUM=SUM+ZAHL
	. ;BEC/INTRAPREND;SR12119/SR13443;ADDED ADDITIONAL STATISTICS FOR 1,3 FOR DISPLAYING;
	. ;IF +ZAHL'=0 IF STATART=0 IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. ;IF +ZAHL'=0 IF STATART=0 IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"  ;ZAHL IN % VK/EK GERECHNET ;numeral within 
	. ;IF +ZAHL'=0 IF STATART=2 WRITE $$^WWWZAHL(ZAHL,10,2)  ;ZAHL ANZAHL ;numeral Number 
	. IF +ZAHL'=0 IF STATART=0!(STATART=1) IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	. IF +ZAHL'=0 IF STATART=0!(STATART=1) IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"  ;ZAHL IN % VK/EK GERECHNET ;numeral within 
	. IF +ZAHL'=0 IF STATART=2!(STATART=3) WRITE $$^WWWZAHL(ZAHL,10,2)  ;ZAHL ANZAHL ;numeral Number 
	. ; ^^^ SR12119/SR13443
	. WRITE "&nbsp;"
	
	DO ZWR^WWWTAB
	SET ZAHL=SUM
	;BEC/INTRAPREND;SR12119/SR13443;ADDED ADDITIONAL STATISTICS FOR 1,3 FOR DISPLAYING;
	;IF +ZAHL'=0 IF STATART=0 IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	;IF +ZAHL'=0 IF STATART=0 IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"    ;ZAHL IN % VK/EK GERECHNET ;numeral within 
	;IF +ZAHL'=0 IF STATART=2 WRITE $$^WWWZAHL(ZAHL,10,2)        ;ZAHL ANZAHL GERECHNET ;numeral Number 
	IF +ZAHL'=0 IF STATART=0!(STATART=1) IF VKEK'=1 WRITE $$^WWWZAHL(ZAHL,10,2,YWHR)  ;ZAHL IN WÄHRUNG GERECHNET ;numeral within money standard 
	IF +ZAHL'=0 IF STATART=0!(STATART=1) IF VKEK=1 WRITE $$^WWWZAHL(ZAHL,10,2)_" %"    ;ZAHL IN % VK/EK GERECHNET ;numeral within 
	IF +ZAHL'=0 IF STATART=2!(STATART=3) WRITE $$^WWWZAHL(ZAHL,10,2)        ;ZAHL ANZAHL GERECHNET ;numeral Number 
	; ^^^ SR12119/SR13443
	
	WRITE "&nbsp;"
	DO EF^WWWTAB
	DO EL^WWWTAB
	QUIT
	
UPUEB ;ÜBERSCHRIFT ;superscription 
	NEW EINHEIT
	
	IF STATART=0!(STATART=1) DO
	. IF VKEK'=1 WRITE "<BR><BR>",$$^WWWTEXT(32228)  ;Verkaufs Umsatz ;Turnover 
	. IF VKEK=1 WRITE $$^WWWTEXT(32717)  ;GEWINNAUFSCHLAG Umsatz ;Turnover
	. WRITE " ("_$PIECE($GET(^WWW101(0,"UMSATZART",SPRACHE,STATART,1)),Y,1)_")"  ;FIS;2.9.05;SR13264;SHOW SELECTED SALES TYPE
	
	IF STATART=2!(STATART=3) DO
	. WRITE $$^WWWTEXT(31407)_" "  ;GESAMTANZAHL
	. IF $GET(YART)'="" SET EINHEIT=$PIECE($GET(^INART(YM,YART,1)),Y,40)             ;EINHEIT ;unit
	. IF $GET(EINHEIT)'=""  WRITE "("_$PIECE($GET(^WWW101(0,"EINHEIT",SPRACHE,EINHEIT,1)),Y,1)_")"
	. WRITE " ("_$PIECE($GET(^WWW101(0,"UMSATZART",SPRACHE,(STATART-2),1)),Y,1)_")"  ;FIS;2.9.05;SR13264;SHOW SELECTED SALES TYPE
	
	IF MONAT=1 WRITE " ",($$^WWWYEAR(+$HOROLOG)-1)," - ",$$^WWWYEAR(+$HOROLOG)
	
	DO START100^WWWTAB  ;STARTEN DER ÜBERSCHRIFT ;launching the superscription 
	WRITE "<THEAD>" 
	DO NL^WWWTAB
	FOR I=1:1 QUIT:$PIECE(UES(1),Y,I,99)=""  DO NHW^WWWTAB WRITE $PIECE(UES(1),Y,I),"&nbsp;" DO EH^WWWTAB
	DO EL^WWWTAB
	WRITE "</THEAD>"
	QUIT
	
]]></Routine>
</Export>