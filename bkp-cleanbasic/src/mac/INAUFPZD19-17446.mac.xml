<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUFPZD19" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUFPZD19(CHECK)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		SETZTEN VORGABE ERLÖSKONTO UND STEUERKENNZEICHEN
	;
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 29-Dec-2006	GRF		SR15333: Naked Reference; quits
	; 06.05.2004	FAN		;25457
	;-------------------------------------------------------------------------------
	NEW AUF,AUF1,POS,POS1,ADR,ADR1,STEUERKZ,STEUER,ERLOESE
	
	SET CHECK=$GET(CHECK)              QUIT:CHECK=""
	
	IF CHECK=0 DO  QUIT
	. SET %TXT(1)="#Y"_YFORM_"D20~"_""
	. SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"D21~"_""
	
	SET AUF=$PIECE($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)),",",1)
	QUIT:AUF=""   ;AUFTRAGENUMMER
	SET POS=$ORDER(^INAUFP(YM,AUF,""))
	QUIT:POS=""
	
	SET AUF1=$GET(^INAUF(YM,AUF,1))
	SET POS1=$GET(^INAUFP(YM,AUF,POS,1))
	SET ADR=$PIECE(AUF1,Y,1)
	SET ADR1=""
	IF ADR'="" SET ADR1=$GET(^INKUNDE(YM,ADR,1))
	SET STEUERKZ=+$PIECE(ADR1,Y,54)  ;0,INLAND,EG,3.LAND  -> FELD 54 WIRD OBEN NEU GESETZT !!!
	;I STEUER=1 I +STEUERKZ=0 S STEUERKZ=1  ;FEHLER?? = STEUER ABER AUSLAND??? ;tax yet 
	SET STEUER=1  ;INLAND
	IF $PIECE(ADR1,Y,17)'="" IF $PIECE(ADR1,Y,17)'=$GET(YCOUNTRY) SET STEUER=0  ;KEIN DEUTSCHLAND ;no Germany 
	IF $PIECE(ADR1,Y,50)'="" IF '$FIND($PIECE(ADR1,Y,50),"DE")    SET STEUER=0  ;STEUERID AUSLAND ;foreign country 
	IF $PIECE(ADR1,Y,54)'="" IF $PIECE(ADR1,Y,54)'=1              SET STEUER=0  ;KEINE STEUER  -> FELD 54 WIRD OBEN NEU GESETZT !!! ;no tax field upstairs recent staid 
	IF STEUERKZ=2            IF $PIECE(ADR1,Y,50)=""              SET STEUER=1  ;EG OHNE UST-ID = STEUER BERECHNEN ! (PRIVATPERSON)  -> FELD 50 WIRD OBEN NEU GESETZT !!! ;without tax calculate field upstairs recent staid 
	SET MWST=""
	SET ERLOESE=""
	IF $GET(YBETRIEB)="" SET YBETRIEB=YLOCATION  ;FIS;25.05.04  ;?? WARUM YBETRIEB ? ;why 
	IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,28)=0 SET ERLOESE=$PIECE(AUF1,Y,213)  ;KONTO ERLÖS INLAND AUS AUFTRAG ;acct. net profits out of order 
	IF ERLOESE="" SET ERLOESE=$PIECE(POS1,Y,31)
	;IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,28)=1 SET ERLOESE=$PIECE(POS1,Y,31)  ;KONTO ERLÖS INLAND AUS POS
	. IF STEUER=0 DO
	. . IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,28)=0 SET ERLOESE=$PIECE(AUF1,Y,214)  ;KONTO ERLÖSE AUSLAND AUFTRAG ;acct. foreign country order 
	. . IF ERLOESE="" SET ERLOESE=$PIECE(POS1,Y,32)
	. . ;IF +$PIECE($GET(^INFIBPAR(0,YM,YBETRIEB,1)),Y,28)=1 SET ERLOESE=$PIECE(POS1,Y,32)  ;KONTO ERLÖS AUSLAND POS
	
	IF ERLOESE="" DO
	. ;-------------------------------------------------VORBEREITEN
	. SET MWPOX=$PIECE(POS1,Y,36)  ;POSTIONS MWST ;Tax 
	. IF MWPOX="" SET MWPOX=1
	. SET SORTI=$PIECE(POS1,Y,38)
	. IF SORTI="" SET SORTI=" "
	. SET WAGR=$PIECE(POS1,Y,30)
	. IF WAGR="" SET WAGR=$PIECE($GET(^INVORG(YM,YM,1)),Y,13)
	. IF WAGR="" SET WAGR=0
	. SET YBETRIEB=YLOCATION
	. ;
	. ;vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv SR15333 Naked Ref
	. ;SET KONTEN=$GET(^INKSTL(YM,YBETRIEB,WAGR,STEUERKZ,1,1))  ;AUS PARAMETER ;out of parameter 
	. ;IF $GET(^INKSTLUST(YM,YBETRIEB,WAGR,STEUERKZ,1,+MWPOX,1))'="" SET KONTEN=^ (1)  ;KONTEN JE STEUERSATZ;FIS;17.03.04;25372
	. ;
	. set KONTEN = $get(^INKSTLUST(YM,YBETRIEB,WAGR,STEUERKZ,1,+MWPOX,1))
	. if KONTEN="" set KONTEN=$get(^INKSTL(YM,YBETRIEB,WAGR,STEUERKZ,1,1))
	. ;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ SR15333 Naked Ref
	. ;
	. IF KONTEN="" SET KONTEN=$GET(^INKSTL1(YM,YBETRIEB,SORTI,STEUERKZ,1,1))  ;AUS VORGABE SORTIMENT ;out of default 
	. IF KONTEN="" IF $PIECE($GET(^INVORG(YM,YM,1)),Y,13)'="" DO
	. . SET KONTEN=$GET(^INKSTL(YM,YBETRIEB,$PIECE($GET(^INVORG(YM,YM,1)),Y,13),STEUERKZ,1,1))  ;AUS VORGABE SONSTIGES ;out of default 
	. . IF $GET(^INKSTLUST(YM,YBETRIEB,$PIECE($GET(^INVORG(YM,YM,1)),Y,13),STEUERKZ,1,+MWPOX,1))'="" SET KONTEN=$GET(^INKSTLUST(YM,YBETRIEB,$PIECE($GET(^INVORG(YM,YM,1)),Y,13),STEUERKZ,1,+MWPOX,1))  ;KONTEN JE STEUERSATZ;FIS;17.03.04;25372
	. ;
	. IF KONTEN="" SET KONTEN=$GET(^INKSTL(YM,YBETRIEB,0,STEUERKZ,1,1))  ;AUS VORGABE SONSTIGES ;out of default 
	. SET ERLOESE=$PIECE(KONTEN,Y,3)
	
	;IF ERLOESE="" SET ERLOESE=$P($G(^INFIBPAR(YM,YM,YBETRIEB,1)),Y,27)   ;Finanzbuchhaltungs-Parameter kONTO ANZAHLUNG
	IF ERLOESE="" SET ERLOESE=$P($G(^INFIBPAR(0,YM,YBETRIEB,1)),Y,27)    ;BEC;25866;07.06.04;DA ZENTRALE DATEI
	IF ERLOESE="" SET ERLOESE=""
	IF ERLOESE'="" IF $DATA(^INFIBSA(YM,ERLOESE)) DO
	. SET MWST=$PIECE($GET(^INFIBSA(YM,ERLOESE,1)),Y,3)
	
	SET %TXT(1)="#Y"_YFORM_"D20~"_ERLOESE
	SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"D21~"_MWST
	QUIT
]]></Routine>
</Export>