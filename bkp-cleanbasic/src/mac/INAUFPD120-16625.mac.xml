<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="22" zv="CACHE" ts="2001-01-01 00:00:00">
<Routine name="INAUFPD120" type="MAC" languagemode="0" timestamp="58440,0"><![CDATA[
INAUFPD120(FELD)
	;-------------------------------------------------------------------------------
	; Description of Function :
	;		NEUER PREIS AUS PREISKZ
	; 
	; Inputs : 
	;
	;
	; ByRef :
	;
	;
	; Returns :
	;
	;
	; History :
	; 09-May-2007	GRF		SRBR014310: FIXME; naked references; some braces
	; 17-May-2006	GRF		Doco; mark disabled block; dot level
	; 07.Jun.2001	DT		Created  
	;-------------------------------------------------------------------------------
	NEW ARTIKEL,RETURN,ARTIKEL1,PRKZ,PREIS,ARTIKEL2,BETRIEB,AUF,KUNDE,DATUM,POS,PREIS
	
	; DOCO : <GRF>  "if FELD *NOT* null, replace YINHALT from YFELD" seems odd.
	; Are we simply saying - if this is not a new record get D120?
	
	SET FELD=$GET(FELD)  ;BEC;26184;20.09.04
	
	;AUFRUF VON INANGP UND INAUFP ;And 
	SET %TXT(1)=""
	SET YFELD=$GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"D",1))
	IF FELD'="" SET YINHALT=$PIECE(YFELD,Y,120)   ;BEC;26184;20.09.04
	IF YINHALT="" QUIT 
	SET ARTIKEL=$PIECE(YFELD,Y,4)  ;ARTIKELNUMMER
	IF ARTIKEL="" QUIT
	
	;---------------------------------------
	
	SET ARTIKEL1=$GET(^INART(YM,ARTIKEL,1))
	SET BETRIEB=""
	SET KUNDE=""
	SET AUF=$PIECE($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)),",",1)
	SET POS=$PIECE($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)),",",2)
	
	//FIXME: After the build change to Macros and only get each object once.
	
	IF (AUF'="") {    ; SRBR014310  braces
		IF $DATA(^INAUF(YM,AUF)) {
			SET BETRIEB = $PIECE($GET(^INAUF(YM,AUF,1)),Y,6)
			SET KUNDE   = $PIECE($GET(^INAUF(YM,AUF,1)),Y,1)
			SET DATUM   =+$PIECE($GET(^INAUF(YM,AUF,1)),Y,4)
			IF POS'="" IF $PIECE($GET(^INAUFP(YM,AUF,POS,1)),Y,22)'="" SET DATUM=+$PIECE(^INAUFP(YM,AUF,POS,1),Y,22)    ; SRBR014310 naked ref
		} elseif  $DATA(^INANG(YM,AUF)) {
			SET BETRIEB = $PIECE($GET(^INANG(YM,AUF,1)),Y,6)
			SET KUNDE   = $PIECE($GET(^INANG(YM,AUF,1)),Y,1)
			SET AUF     = $PIECE($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"P",1)),",",1)
			SET DATUM   =+$PIECE($GET(^INANG(YM,AUF,1)),Y,4)
			IF POS'="" IF $PIECE($GET(^INANGP(YM,AUF,POS,1)),Y,22)'="" SET DATUM=+$PIECE(^INANGP(YM,AUF,POS,1),Y,22)    ; SRBR014310 naked ref
		}
	}
	
	IF BETRIEB="" SET BETRIEB=YLOCATION
	IF ARTIKEL1="" QUIT                           ; FIXME? : Why not immediately after set? <GRF>
	
	;---------------------------------------
	
	;IF $DATA(^INARTPREIS(YM,ARTIKEL,BETRIEB,1)) SET ARTIKEL2=^INARTPREIS(YM,ARTIKEL,BETRIEB,1) DO  ;PREIS BETRIEBSABHÄNGIG
	;. FOR YI(1)=0,10,20,30 DO
	;. . SET $PIECE(ARTIKEL1,Y,88+YI(1))=$PIECE(ARTIKEL2,Y,1+YI(1))  ;UMSETZEN PREISE
	;. . SET:$PIECE(ARTIKEL2,Y,2+YI(1))'="" $PIECE(ARTIKEL1,Y,90+YI(1))=$PIECE(ARTIKEL2,Y,2+YI(1))  ;UMSETZTEN PREISARTEN
	
	;SET PREIS=$$^INSALESPRICE(ARTIKEL,,BETRIEB,YINHALT,KUNDE,$GET(DATUM))  ;FIS;03.06.03;23477;PREISE AUS INSALESPRICE
	SET PREIS=$$^INSALESPRICE(ARTIKEL,$PIECE(YFELD,Y,5),BETRIEB,YINHALT,KUNDE,$GET(DATUM))  ;FIS;09.02.05;27283;MENGE BEACHTEN
	SET $PIECE(ARTIKEL1,Y,118)=PREIS
	IF +$PIECE(YFELD,Y,199)=1 QUIT  ;FIS;27.07.04;26172 -> ACHTUNG: IM AUFTRAG NUR GESETZT, WENN AUS ANGEBOT ANGELEGT
	IF $PIECE(YFELD,Y,120)=$PIECE($GET(^WWWDATEN(YM,+$HOROLOG,YUSER,YFORM,"D",2)),Y,120) QUIT  ;KEINE ÄNDERUNG;FIS;27283;09.02.05
	
	;FOR PRKZ=90,100,110,120 IF YINHALT=$PIECE(ARTIKEL1,Y,PRKZ) DO
	;. QUIT:+$PIECE(ARTIKEL1,Y,PRKZ-2)=0
	;. SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"D118~"_$$^WWWZAHL($PIECE(ARTIKEL1,Y,PRKZ-2),0,2)_"#Y"_YFORM_"D119~"_$$^WWWZAHL($PIECE(ARTIKEL1,Y,PRKZ-2)*$PIECE(YFELD,Y,5),0,2)_"#Y"_YFORM_"D116~"_$$^WWWZAHL($PIECE(ARTIKEL1,Y,PRKZ-4),0,2)_"#Y"_YFORM_"D123~"_$$^WWWZAHL($PIECE(ARTIKEL1,Y,PRKZ-2)*$PIECE(YFELD,Y,5)+$PIECE(YFELD,Y,211),0,2)
	
	;IF YFORM'="INANGP" IF $PIECE(ARTIKEL1,Y,118)'=0 DO
	;. SET $PIECE(YFELD,Y,118)=$PIECE(ARTIKEL1,Y,118)
	;. DO EH^INBRUTTONETTO    ; Updates YFELD ByRef
	;. SET %TXT(1)=%TXT(1)_"#Y"_YFORM_"D118~"_$$^WWWZAHL($PIECE(YFELD,Y,118),0,$$^WWWDECIMALLEN("INAUFP",118))_"#Y"_YFORM_"D119~"_$$^WWWZAHL($PIECE(YFELD,Y,119),0,$$^WWWDECIMALLEN("INAUFP",119))_"#Y"_YFORM_"D116~"_$$^WWWZAHL($PIECE(YFELD,Y,116),0,$$^WWWDECIMALLEN("INAUFP",116))_"#Y"_YFORM_"D123~"_$$^WWWZAHL($PIECE(YFELD,Y,123),0,$$^WWWDECIMALLEN("INAUFP",123))
	
	;IF YFORM="INANGP" IF $PIECE(ARTIKEL1,Y,118)'=0 DO
	IF $PIECE(ARTIKEL1,Y,118)'=0 DO
	. NEW SELBSTKOST,AUFTRAG,POSITION,MENGE
	. SET $PIECE(YFELD,Y,118)=$PIECE(ARTIKEL1,Y,118)
	. SET SELBSTKOST=$PIECE(YFELD,Y,47)
	. SET AUFTRAG  = AUF
	. SET POSITION = POS
	. SET MENGE    = +$PIECE(YFELD,Y,5)  ;MENGE WEGEN RÜSTZEIT ;quantity 
	. IF MENGE=0 SET MENGE=1
	. IF YFORM="INANGP" DO KALK^INANGKOST
	. IF YFORM="INAUFP" DO KALK^INAUFKOST
	. set %TXT(1)=%TXT(1)_"#Y"_YFORM_"D118~"_$$^WWWZAHL($PIECE(YFELD,Y,118),0,$$^WWWDECIMALLEN("INAUFP",118))
	. set %TXT(1)=%TXT(1)_"#Y"_YFORM_"D119~"_$$^WWWZAHL($PIECE(YFELD,Y,119),0,$$^WWWDECIMALLEN("INAUFP",119))
	. set %TXT(1)=%TXT(1)_"#Y"_YFORM_"D116~"_$$^WWWZAHL($PIECE(YFELD,Y,116),0,$$^WWWDECIMALLEN("INAUFP",116))
	. set %TXT(1)=%TXT(1)_"#Y"_YFORM_"D123~"_$$^WWWZAHL($PIECE(YFELD,Y,123),0,$$^WWWDECIMALLEN("INAUFP",123))
	. IF YFORM="INAUFP" SET %TXT(1)=%TXT(1)_"#@"  ;AUTOM. SPEICHERN
	
	QUIT 
	
EH ;EINSPRUNG VON AUSSEN
	NEW ARTIKEL,BETRIEB,KUNDE,DATUM,AUF1,PREIS
	
	SET AUF     = $GET(AUF)
	SET POS     = $GET(POS)
	SET YFELD   = $GET(YFELD)
	SET ARTIKEL = $PIECE(YFELD,Y,4)  ;ARTIKELNUMMER
	IF ARTIKEL="" QUIT
	
	SET BETRIEB = ""
	SET KUNDE   = ""
	SET DATUM   = ""
	
	//FIXME: after the build changes these to macros
	
	IF (AUF'="") && $DATA(^INAUF(YM,AUF,1)) {
		SET AUF1 = ^INAUF(YM,AUF,1)                 ; SRBR014310 naked ref, braces
		SET BETRIEB = $PIECE(AUF1,Y,6)
		SET KUNDE   = $PIECE(AUF1,Y,1)
		SET DATUM   =+$PIECE(AUF1,Y,4)
		IF POS'="" IF $PIECE($GET(^INAUFP(YM,AUF,POS,1)),Y,22)'="" SET DATUM=+$PIECE(^INAUFP(YM,AUF,POS,1),Y,22)    ; SRBR014310 naked ref
	}
	
	IF BETRIEB="" SET BETRIEB=YLOCATION
	SET PREIS=$$^INSALESPRICE(ARTIKEL,$PIECE(YFELD,Y,5),BETRIEB,$PIECE(YFELD,Y,120),KUNDE,DATUM)  ;FIS;09.02.05;27283;MENGE BEACHTEN
	SET $PIECE(YFELD,Y,118)=PREIS
	DO EH^INBRUTTONETTO              ; Updates YFELD ByRef
	QUIT
	
]]></Routine>
</Export>